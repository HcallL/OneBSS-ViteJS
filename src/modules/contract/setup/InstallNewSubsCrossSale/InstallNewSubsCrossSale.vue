/* eslint-disable space-before-function-paren */
<template src="./InstallNewSubsCrossSale.html"></template>
<style scoped src="./InstallNewSubsCrossSale.scss"></style>
<script>
// import commondata from './mixins/commondata.js'
// import watchdata from './mixins/watchdata.js'
import breadcrumb from '@/components/breadcrumb'
import gridview from '@/components/Shared/gridview'
import '@/assets/vendor/jquery/split'
import API from './InstallNewSubsCrossSaleAPI'
import ModalChonDiaChi from './Popups/popupChonDiaChi'
import ModalChonDiaChiThueBao from './Popups/popupChonDiaChiTabThueBao'
import BssErrorMarker from '@/components/BssErrorMarker'
import BssRequiredMarker from '@/components/BssRequiredMarker'
import { required, minValue, maxValue } from '@vuelidate/validators'
import { useVuelidate } from '@vuelidate/core'
// import TimNhanVienThuCuoc from '@/modules/QLTN/GachNo/components/TimNhanVienThuCuoc'
// import PopupTimKiemNhanVienThuCuoc from '../InstallNewSubs/Popups/PopupTimKiemNhanVienThuCuoc'
const PopupTimKiemNhanVienThuCuoc = () => import('@/modules/EXTS/HOPDONG/ThayDoiThongTinKhuyenMai/TimNhanVienThuCuoc')
import moment from 'moment'
import DatePicker from 'vue2-datepicker'
import 'vue2-datepicker/locale/vi.js'
import 'vue2-datepicker/index.css'
import DataGrid2 from '@/components/Controls/DataGrid2'
import ComboboxGrid2 from '@/components/Controls/ComboboxGrid2'
import SearchContractModal from "@/modules/contract/setup/HandoverTicket/components/SearchContractModal.vue";
import tcbancheo from '@/modules/contract/setup/InstallNewSubsCrossSale/tcbancheo'
import bancheo from '@/modules/contract/setup/InstallNewSubsCrossSale/bancheo'
import DialogChonTinh from '@/modules/contract/setup/SubscriptionLiquidationCrossSell/components/PopupChonTinh.vue'
import ThongSoCoDinhModal from '@/modules/contract/setup/ChangeSubsTypeCrossSale/popups/ThongSoCoDinhModal.vue'
// import ThongSoWanModal from '@/modules/contract/setup/ChangeSubsTypeCrossSale/popups/ThongSoWanModal.vue'
import TocDoMucCuocADSLModal from '@/modules/contract/setup/ChangeSubsTypeCrossSale/popups/TocDoMucCuocADSLModal.vue'
import frmThongSoWan from '@/modules/contract/setup/ChangeMegaWanConfigCrossSell/popups/frmThongSoWan.vue'
import frmThongSoTSL from '@/modules/contract/setup/SetupChangeTSLSpeedCrossSale/Popups/frmThongSoTSL/frmThongSoTSL.vue'
import frmDangKyGoiDaDVLM from '@/modules/admin/category/NiceNumberStyle/popups/frmDangKyGoiDaDVLM.vue'
import { newThongSoThueBao } from '../ChangeSubsTypeCrossSale/Utils'
const ThongTinEmail = () => import('@/modules/contract/setup/ChangeContractOwner/popup/ThongTinEmail.vue')
const ThongTinHenKhachHangModal = () => import('@/modules/contract/setup/SurveyRequest/popups/ThongTinHenKhachHang/ThongTinHenKhachHangModal.vue')
const PopupThongTinUser = () => import('@/modules/contract/setup/ChangeContractOwner/popup/ThongTinUser/PopupThongTinUser')
const Thuebao_ToaNha = () => import('@/modules/search/subscriber/SearchInstallDetail/popup/ThueBao_ToaNha.vue')
// import Select2Ext from '@/components/Controls/Select2Ext'
// import  ThongTinLienHe from "@/modules/contract/setup/ChangeContractOwner/popup/ThongTinLienHe.vue"
const waitUntil = (condition, checkInterval=100) => {
    return new Promise(resolve => {
        let interval = setInterval(() => {
            if (!condition()) return;
            clearInterval(interval);
            resolve();
        }, checkInterval)
    })
}
const delay = ms => new Promise(res => setTimeout(res, ms));
import {
  DichVuVienThong,
  TRANGBI,
  DUNG_THU,
  LoaiHopDong,
  TrangThaiHD,
  LoaiHinhTB,
  ThoiHan,
  KHOANMUC_TT,
  KieuCaiDatDVGT,
  THUESO,
  TRANGTHAI_DONGBO,
  KieuLapDat,
  LOAI_DV,
  Loai_KH,
  HINHTHUC_TC,
  KIEU_HD,
  KIEU_KH,
  PHANLOAI_KH,
  Loai_NV,
  LOAISO,
  LOAI_KV,
  Loai_KM,
  LOAINODE_MGWAN,
  KIEULAP,
  FSECURE_KM_12_MONTHS,
  MUCCUOC,
  LOAITBI_ADSL,
  ChiTietDV_IMS,
  GOICUOC_DD,
  CAConstanst,
  DatabaseConstants,
  LoaiGiayTo,
  LOAISO_ISDN
} from '../InstallNewSubs/Enums'
import EventBus from '@/utils/eventBus'
import InHopDong from '@/modules/print/InHopDong/InHopDong.vue'
export default {
  components: {
    breadcrumb,
    gridview,
    BssErrorMarker,
    BssRequiredMarker,
    ModalChonDiaChi,
    ModalChonDiaChiThueBao,
    //ThongTinLienHe,
    DialogChonTinh,
    //appTimNhanVienThuCuoc: TimNhanVienThuCuoc,
    PopupTimKiemNhanVienThuCuoc,
    DatePicker,
    DataGrid2,
    ComboboxGrid2,
    SearchContractModal,
    InHopDong,
    ThongSoCoDinhModal,
    TocDoMucCuocADSLModal,
    frmThongSoWan,
    frmThongSoTSL,
    frmDangKyGoiDaDVLM,
    ThongTinEmail,
    ThongTinHenKhachHangModal,
    PopupThongTinUser,
    Thuebao_ToaNha
    // Select2Ext
  },
  //directives: { mask:VueMaskDirective },
  mixins: [
    // commondata,
    // watchdata,
  ],
  name: 'InstallNewSubsCrossSale',
  created() {
    EventBus.$on('getTTTB', this.getTTTBHandler)

    this.$root.$on('bv::modal::shown', (bvEvent, modalId) => {
      if (this.popupQueueWhiteList.indexOf(modalId) >= 0) this.popupShowing = true
      document.getElementsByClassName('modal-content').forEach(function(v) {
        v.removeAttribute('tabindex')
      })
    })
    this.$root.$on('bv::modal::hidden', (bvEvent, modalId) => {
      if (this.popupQueueWhiteList.indexOf(modalId) >= 0) {
        this.popupShowing = false
        this.ShowPopupQueue()
      }
      this.ValidateModal(bvEvent, modalId)
    })
    $('button, a').click(function() {
      let ctl = $(this)
      ctl.addClass('disabled')
      setTimeout(function() {
        ctl.removeClass('disabled')
      }, 3000)
    })

    //THANGDM1 them 2022-12-07 them de xu ly loading
    let numberOfAjaxCAllPending = 0

    // Add a request interceptor
    this.axios.interceptors.request.use(
      (config) => {
        numberOfAjaxCAllPending++
        // show loader
        this.loading(true)
        return config
      },
      (error) => {
        return Promise.reject(error)
      }
    )

    // Add a response interceptor
    this.axios.interceptors.response.use(
      (response) => {
        numberOfAjaxCAllPending--

        this.loading(true)
        if (numberOfAjaxCAllPending == 0) {
          //hide loader
          this.loading(false)
        }
        return response
      },
      (error) => {
        numberOfAjaxCAllPending--
        if (numberOfAjaxCAllPending == 0) {
          //hide loader
          this.loading(false)
        }
        return Promise.reject(error)
      }
    )
  },
  destroyed() {
    EventBus.$off('getTTTB', this.getTTTBHandler)
  },
  props: ['PHIEUHS_ID', 'frmDatmoi_Shown', 'OnDatMoi', 'itag', 'ihc_hdtb_id', 'ihc_tdtt_hdtb_id'],
  async mounted() {
    // let bugpilotscript = document.createElement('script');
    // bugpilotscript.setAttribute('src', 'https://script.bugpilot.io/485d681a-6299-4b92-b2f2-a09b74410d80/adopto.js');
    // bugpilotscript.setAttribute("async","");
    // document.head.appendChild(bugpilotscript);
    // window.Bugpilot.saveReport({
    //   source: "InstallNewSubs", // Optional
    //   userProvidedDescription: "Lap Dat Moi Ban Cheo", // Optional
    // });
    //this.FormLoad();
    if (this.frmDatmoi_Shown) this.frmDatmoi_Shown()
    if (this.$route.query.tag && this.$route.query.tag.trim() != '') this.Tag = this.$route.query.tag
    else if (this.itag && this.itag.trim() != '') this.Tag = this.itag
    if (this.$route.query.hc_hdtb_id) this.hc_hdtb_id = this.$route.query.hc_hdtb_id
    else if (this.ihc_hdtb_id) this.hc_hdtb_id = this.ihc_hdtb_id
    if (this.$route.query.hc_tdtt_hdtb_id) this.hc_tdtt_hdtb_id = this.$route.query.hc_tdtt_hdtb_id
    else if (this.ihc_tdtt_hdtb_id) this.hc_tdtt_hdtb_id = this.ihc_tdtt_hdtb_id

    //kieu=${kieuId}&phieucskh_id=${phieucskh_id}&phieucskhdv_id=${phieucskhdv_id}&hdkh_cha_id=${hdkh_cha_id}
    if (this.$route.query.kieu && this.$route.query.kieu.trim() != '') this.iKieu = this.$route.query.kieu
    if (this.$route.query.phieucskh_id && this.$route.query.phieucskh_id.trim() != '') this.VPHIEUCSKH_ID = this.$route.query.phieucskh_id
    if (this.$route.query.phieucskhdv_id && this.$route.query.phieucskhdv_id.trim() != '') this.phieucskhdv_id = this.$route.query.phieucskhdv_id
    if (this.$route.query.hdkh_cha_id && this.$route.query.hdkh_cha_id.trim() != '') this.hdkh_cha_id = this.$route.query.hdkh_cha_id
    if (this.iKieu > 1)
      if (this.iKieu == 5) this.LoadTuHopDongB2A()
      else this.LoadTuHopDongTuVan()
    await API.post_get_app_config(this.axios, { keyname: 'DONGBO_TEST' }).then((response) => {
      if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
        this.DONGBO_TEST.TEST = !(response.data.data.dongbo + '' == '1' && (response.data.data.keyvalue + '').toLowerCase() == 'false')
      }
    })
    this.watcherActive = true
    this.buttonSet = 1
  },
  validations: {
    diachiKH: {
      DIACHI: {
        required
      }
    },
    diachiHK: {
      DIACHI: {
        required
      }
    },
    diachiNDD: {
      DIACHI: {
        required
      }
    },
    diachiTT: {
      DIACHI: {
        required
      }
    },
    diachiCT: {
      DIACHI: {
        required
      }
    },
    diachiBC: {
      DIACHI: {
        required
      }
    },
    diachiTB: {
      DIACHI: {
        required
      }
    },
    diachiLD: {
      DIACHI: {
        required
      }
    },
    diachiKN: {
      DIACHI: {
        required
      }
    },
    diachiDau: {
      DIACHI: {
        required
      }
    },
    diachiCuoi: {
      DIACHI: {
        required
      }
    }
  },
  computed: {
    kiemtra_nhanvien_vti() {
      return this.$root.token.getPhanVungID()==98?1:0
    },
    isEditKH() {
      return (this.thamsomacdinh && this.thamsomacdinh['GUI_YEUCAU_PHEDUYET_TTTT_KH']==1) && this.khachhang.khachhang_id;//(this.khachhang.hdkh_id || this.isLoadKH); // bo theo yeu cau cua QC
    },
    async cloaihinh_tb() {
      if (!this.listbox.loaihinh_tb.list || this.listbox.loaihinh_tb.list.length <= 0) return []
      var list = this.listbox.loaihinh_tb.list.filter((lh) => lh.dichvuvt_id == this.listbox.dichvu_vt.value).map((lh) => ({ id: lh.loaitb_id, text: lh.loaihinh_tb }))
      if (!list || list.length <= 0) {
        this.listbox.loaihinh_tb.value = 0
        return []
      }
      if ((this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) && (this.listbox.loaihinh_tb.value == LoaiHinhTB.MGW_INTERNET_TRUCTIEP || this.listbox.loaihinh_tb.value == LoaiHinhTB.NB_INTERNETTT))
        this.listbox.phanloai_dv.list = await this.HT_PhanLoaiMGWAN() //(await this.HT_PhanLoaiMGWAN()).map((lh) => ({ id: lh.loaitb_id, text: lh.loaihinh_tb }))
      var i = 0
      for (; i < list.length; i++) {
        if (list[i].id == this.listbox.loaihinh_tb.value) {
          return list
        }
      }
      if (i >= list.length) this.listbox.loaihinh_tb.value = list[0].id

      return list
    },
    ckieu_ld() {
      var loaihinh = this.listbox.loaihinh_tb.value
      if (!this.listbox.kieu_ld.list || this.listbox.kieu_ld.list.length <= 0) return []
      var list = this.listbox.kieu_ld.list.filter((ld) => ld.loaitb_id == loaihinh && ld.tinhkhac == 2).map((ld) => ({ id: ld.kieuld_id, text: ld.ten_kieuld }))
      if (!list || list.length <= 0) {
        this.listbox.kieu_ld.value = 0
        return []
      }
      var i = 0
      for (; i < list.length; i++) if (list[i].id == this.listbox.kieu_ld.value) return list
      if (i >= list.length) this.listbox.kieu_ld.value = list[0].id
      return list
    },
    ccongnghe() {
      if (!this.listbox.congnghe.list || this.listbox.congnghe.list.length <= 0) return []
      var list = this.listbox.congnghe.list.filter((cn) => cn.kieuld_id == this.listbox.kieu_ld.value).map((cn) => ({ id: cn.congnghe_id, text: cn.congnghe }))
      if (!list || list.length <= 0) {
        this.listbox.congnghe.value = 0
        return []
      }
      var i = 0
      for (; i < list.length; i++) if (list[i].id == this.listbox.congnghe.value) return list
      if (i >= list.length) this.listbox.congnghe.value = list[0].id
      return list
    },
    DiaChiLDCLONE() {
      return JSON.parse(JSON.stringify(this.diachiLD))
    },
    DiaChiTTCLONE() {
      return JSON.parse(JSON.stringify(this.diachiTT))
    },
    ma_lhtb_vdc() {
      try {
        return this.listbox.loaihinh_tb.list.filter((x) => x.loaitb_id == this.listbox.loaihinh_tb.value)[0]['ma_lhtb_vdc'] * 1
      } catch (ex) {
        return 0
      }
    },
    kieu_ld_kieu() {
      try {
        return this.listbox.kieu_ld.list.filter((x) => x.kieuld_id == this.listbox.kieu_ld.value)[0]['kieu'] * 1
      } catch (ex) {
        return 0
      }
    },
    DT_DV() {
      this.DT_CONTROLS.key

      return (idx) => {
        let list = this.DT_CONTROLS.data[idx].map((c) => ({ id: c.DONVI_ID, text: c.TEN_DV }))
        if (list && list.length > 0) {
          if (!this.DT_CONTROLS.value[idx] || this.DT_CONTROLS.value[idx] <= 0) this.DT_CONTROLS.value[idx] = list[0].id && list[0].id > 0 ? list[0].id : list[1] && list[1].id ? list[1].id : 0
          return list
        } else return []
      }
    },
    loai_kh_tree: {
      get() {
        var listkieukh = [...new Set(this.listbox.loai_kh.list.map((x) => x.kieu_kh))].map((x) => ({ label: x, id: x }))
        for (var kieukh of listkieukh) {
          kieukh.children = [...new Set(this.listbox.loai_kh.list.filter((x) => x.kieu_kh == kieukh.label).map((x) => x.ten_nhom))].map((x) => ({ label: x, id: x }))
          for (var nhomkh of kieukh.children) {
            nhomkh.children = this.listbox.loai_kh.list.filter((x) => x.kieu_kh == kieukh.label && x.ten_nhom == nhomkh.label).map((x) => ({ id: x.loaikh_id, label: x.ten_loaikh, cate: kieukh.label, subcate: nhomkh.label }))
          }
        }
        return listkieukh
      }
    },
    TinhKhac: {
      get() {
        var tk = this.listbox.loaihinh_tb.list.filter((lh) => lh.dichvuvt_id == this.listbox.dichvu_vt.value && lh.loaitb_id == this.listbox.loaihinh_tb.value)
        if (tk && tk.length > 0 && tk[0] && tk[0]['tinhkhac']) return tk[0]['tinhkhac']
        else return 0 // Mac dinh bien nay la bien global 0
      }
    },
    TinhKhacLD: {
      get() {
        var tk = this.listbox.kieu_ld.list.filter((x) => x.kieuld_id == this.listbox.kieu_ld.value)
        if (tk && tk.length > 0 && tk[0] && tk[0]['tinhkhac']) return tk[0]['tinhkhac']
        else return 0
      }
    }
    // cant_delete:{
    //   get() {
    //     var dsfile = this.gridbox.filehoso.list.filter(x=>x.ischecked);
    //     return (!dsfile || dsfile.length<=0)
    //   },

    // }
  },
  watch: {
    popupQueue: {
      handler: function() {
        this.ShowPopupQueue()
      },
      deep: true
    },
    DiaChiLDCLONE: {
      handler: async function(newval, oldval) {
        if (!this.watcherActive) return
        if ((!oldval && newval) || newval.QUAN_ID != oldval.QUAN_ID || newval.PHUONG_ID != oldval.PHUONG_ID || newval.PHO_ID != oldval.PHO_ID || newval.AP_ID != oldval.AP_ID || newval.KHU_ID != oldval.KHU_ID || newval.DACDIEM_ID != oldval.DACDIEM_ID) {
          if (this.TinhKhac == 0 && this.TinhKhacLD == 0) {
            var pdata1 = {
              DT_CONTROLS: this.DT_CONTROLS.list,
              PHIEUHS_ID: this.PHIEUHS_ID ? this.PHIEUHS_ID : 0,
              PHUONG_ID: newval.PHUONG_ID ? newval.PHUONG_ID : 0,
              PHO_ID: newval.PHO_ID ? newval.PHO_ID : 0,
              AP_ID: newval.AP_ID ? newval.AP_ID : 0,
              KHU_ID: newval.KHU_ID ? newval.KHU_ID : 0,
              DACDIEM_ID: newval.DACDIEM_ID ? newval.DACDIEM_ID : 0,
              TTND_DV_ID: this.$root.token.getNguoiDungID(),
              HDKH_ID: this.khachhang.hdkh_id,
              CTV_ID: this.filterbox.ctv.value,
              NGUOIGT_ID: this.filterbox.nguoigt.value,
              BANCHEO: 1
            }
            await API.post_fn_lay_donvi_theo_loaidv_diachi_ld_v2(this.axios, { ds_para: JSON.stringify(pdata1) }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                var dulieuapi = JSON.parse(response.data.data)
                if (dulieuapi['RESULT']['DS_GT_DVI'] && dulieuapi['RESULT']['DS_GT_DVI'].length > 0 && this.DT_CONTROLS.data.length == dulieuapi['RESULT']['DS_GT_DVI'].length) {
                  this.DT_CONTROLS.value = dulieuapi['RESULT']['DS_GT_DVI']
                  for (var i = 0; i < this.DT_CONTROLS.data.length; i++) {
                    if (this.DT_CONTROLS.data[i] && this.DT_CONTROLS.data[i].length > 0 && !this.DT_CONTROLS.value[i]) {
                      this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0].DONVI_ID
                      this.DT_CONTROLS.tagvalue[i] = this.DT_CONTROLS.data[i][0].LOAIDV_ID
                    }
                  }
                  this.DT_CONTROLS.dichvu_vt = this.listbox.dichvu_vt.value
                  this.DT_CONTROLS.key += 1
                }
              }
            })
            if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) this.buttons.btnChonSM = true
          }
          var pdata = { KETCUOI_ID: this.KetCuoi_ID, TINHKHAC: this.thuebao.tinhkhac, KIEULD_ID: this.listbox.kieu_ld.value, PHUONG_ID: newval.PHUONG_ID, PHO_ID: newval.PHO_ID, AP_ID: newval.AP_ID, KHU_ID: newval.KHU_ID, DACDIEM_ID: newval.DACDIEM_ID, KHUVUC_THEO_KETCUOI: this.KHUVUC_THEO_KETCUOI }
          if(this.$root.token.getPhanVungID()!=97)
          await API.post_fn_lay_tt_th_diachi_ld(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              var apidata = JSON.parse(response.data.data)
              if (apidata['RESULT']) apidata = apidata['RESULT']
              if (apidata['DS_DVI']) this.XuLyDonViLD(apidata['DS_DVI'])
              if (apidata['DS_KV'] && apidata['DS_KV'].length > 0) {
                this.thuebao.khuvuc = apidata['DS_KV'][0]['TEN_KV']
                this.thuebao.khuvuc_id = apidata['DS_KV'][0]['KHUVUC_ID']
                if (this.thuebao.khuvuc_id)
                  this.dsHDTB_KV = [
                    {
                      HDTB_ID: this.hdtb_id ? this.hdtb_id : 0,
                      KHUVUC_ID: this.thuebao.khuvuc_id,
                      LOAIKV_ID: LOAI_KV.KHUVUC_DIABAN,
                      NGAY_CN: new Date().toLocaleDateString('en-GB'),
                      MAY_CN: this.tt_nd.may_cn,
                      NGUOI_CN: this.$root.token.getNguoiDungID(),
                      IP_CN: 'y.y.y.y',
                      KIEUKV_ID: null
                    }
                  ]
              } else {
                // FIXME THANGDM1 them case else nay de load thong tin khu vuc tu diachiLD neu khong load duoc o buoc tren!
                var rs = await this.$root.context.post('/web-hopdong/thaydoiloaihinhtbcodinhims/sp_lay_khuvuc_theo_diadanh', {
                  //web-bancheo/danhmuc/sp_lay_khuvuc_theo_diadanh
                  loaikv_id: 4,
                  quan_id: newval.QUAN_ID,
                  phuong_id: newval.PHUONG_ID,
                  pho_id: newval.PHO_ID ? newval.PHO_ID : 0,
                  ap_id: newval.AP_ID ? newval.AP_ID : 0,
                  khu_id: newval.KHU_ID ? newval.KHU_ID : 0,
                  dacdiem_id: newval.DACDIEM_ID ? newval.DACDIEM_ID : 0,
                  tramtc_id: 0
                  //tinhthicong_id: this.tinh.tinhthicong_id,
                })
                if (rs.data.length > 0) {
                  this.thuebao.khuvuc = rs.data[0].ten_kv
                  this.thuebao.khuvuc_id = rs.data[0].khuvuc_id
                  if (this.thuebao.khuvuc_id)
                    this.dsHDTB_KV = [
                      {
                        HDTB_ID: this.hdtb_id ? this.hdtb_id : 0,
                        KHUVUC_ID: this.thuebao.khuvuc_id,
                        LOAIKV_ID: LOAI_KV.KHUVUC_DIABAN,
                        NGAY_CN: new Date().toLocaleDateString('en-GB'),
                        MAY_CN: this.tt_nd.may_cn,
                        NGUOI_CN: this.$root.token.getNguoiDungID(),
                        IP_CN: 'y.y.y.y',
                        KIEUKV_ID: null
                      }
                    ]
                }
              }
            }
          })
          await this.HT_DS_KhuyenMai_Combobox()
          await this.LoadMucCuocTB()
          await API.post_sp_layds_tb_trung_dcld(this.axios, { diachi_ld: this.diachiLD.DIACHI }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              var dlist = response.data.data
              if (dlist && dlist.length > (this.buttonSet == 1 ? 0 : 1)) {
                this.$bvModal
                  .msgBoxConfirm(`Tìm thấy ${dlist.length} thuê bao trong danh bạ trùng địa chỉ lắp đặt. Bạn có muốn xem thông tin các thuê bao này?`, {
                    title: 'Xác nhận hành động',
                    size: 'sm',
                    okTitle: 'Đồng ý',
                    cancelTitle: 'Không đồng ý'
                  })
                  .then(async (v) => {
                    if (v) {
                      this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonGrid')
                      this.popupComponentName = 'popupTrungDC'
                      this.popupComponentData = {
                        ds: dlist,
                        cols: [
                          { fieldName: 'ma_tb', headerText: 'Số máy/Account', allowFiltering: false, allowSorting: false },
                          { fieldName: 'ten_tb', headerText: 'Tên thuê bao', allowFiltering: false, allowSorting: false },
                          { fieldName: 'loaihinh_tb', headerText: 'Loại hình', allowFiltering: false, allowSorting: false },
                          { fieldName: 'trangthai_tb', headerText: 'Trạng thái', allowFiltering: false, allowSorting: false },
                          { fieldName: 'diachi_ld', headerText: 'Địa chỉ LĐ', allowFiltering: false, allowSorting: false }
                        ],
                        keycol: 'DONVIQL_ID',
                        allowExit: false,
                        tieude: 'Các thuê bao tại địa chỉ ' + this.diachiLD.DIACHI,
                        tieudebang: 'Địa chỉ: ' + this.diachiLD.DIACHI
                      }
                      this.Popup('popupComponents')
                    }
                  })
              }
            }
          })
        }
      },
      deep: true
    },
    'listbox.cboTinh.value': async function(val) {
      if(val) {
        this.tinh = await bancheo.tinh_thicong(this.listbox.cboTinh.value)
        if (!this.tinh.tinhthicong_id) this.$toast.error('Không lấy được thông tin tỉnh thi công! Vui lòng chọn lại tỉnh thi công.')
      }
    },
    'listbox.doituong.value': function(val, oldval) {
      if (!(val != oldval && val > 0)) return
      if (!this.watcherActive || !val || val <= 0) return
      this.LoadMucCuocTB()
      this.HT_DS_KhuyenMai_Combobox()
    },
    'listbox.loaihinh_tb.value': async function(val, oldval) {
      if (!(val != oldval && val > 0)) return
      this.ResetThueBao()
      //Reset thong tin form
      this.kt_thuenganhan = false
      //END Reset thong tin form
      if (!this.watcherActive || !val || val <= 0) return
      this.LoadMucCuocTB()
      this.chkLuongGiuKenh = false

      if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES || this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC) {
        this.loading(true)
        try {
          await API.post_sp_lay_ds_thietbi_dc_lhtb(this.axios, { kieu: 1, loaitb_id: val }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              this.listbox.cboLoaiTB.list = response.data.data
              if (this.listbox.cboLoaiTB.list && this.listbox.cboLoaiTB.list.length > 0 && this.listbox.cboLoaiTB.list.filter((x) => x.thietbidc_id > 0).length > 0) this.listbox.cboLoaiTB.value = this.listbox.cboLoaiTB.list.filter((x) => x.thietbidc_id > 0)[0].thietbidc_id
            }
          })
        } catch (ex) {
          this.$toast.error('' + ex)
          if (this.debug) console.error(ex)
        } finally {
          this.loading(false)
        }
      }
      await this.GiaoDien_DichVuVT(this.listbox.dichvu_vt.value * 1)
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.CAPQUANG_TRANG_TSL) this.thuebao.tsl.txtSoSoiQuang_Enabled = true
      else this.thuebao.tsl.txtSoSoiQuang_Enabled = false
      if (this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG) {
        await API.post_sp_ht_goicuoc_dd(this.axios, { loaitb_id: val }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            this.thuebao.didong.cboGoiCuocDD.list = response.data.data
            if (this.thuebao.didong.cboGoiCuocDD.list && this.thuebao.didong.cboGoiCuocDD.list.length > 0) this.thuebao.didong.cboGoiCuocDD.value = this.thuebao.didong.cboGoiCuocDD.list[0].goicuoc_id
          }
        })
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRATRUOC) {
          // vuth update fix 1509
          //cboGoiCuocDD.Enabled = false;
        } else {
          this.thuebao.didong.cboGoiCuocDD.value = GOICUOC_DD.POSTPAID
        }
      }

      // TODO tam bo qua doan 23132 - 23198, chi bat tat giao dien -> chua xu ly
      if (
        val == LoaiHinhTB.KTR_DOICAP_DONG ||
        val == LoaiHinhTB.KTR_DOICAP_QUANG ||
        val == LoaiHinhTB.KTR_Leasedline_E1 ||
        val == LoaiHinhTB.KTR_Leasedline_FE ||
        val == LoaiHinhTB.KTR_Leasedline_GE ||
        val == LoaiHinhTB.KTR_Leasedline_nx64k ||
        val == LoaiHinhTB.KTR_Leasedline_STM1 ||
        val == LoaiHinhTB.KTR_Nail_up ||
        val == LoaiHinhTB.KTR_TRUCTHONG_DONG ||
        val == LoaiHinhTB.KTR_TRUCTHONG_QUANG
      ) {
        this.chkLuongGiuKenh = true
      }

      if (
        [DichVuVienThong.ADSL, DichVuVienThong.BRCD_DOITAC, DichVuVienThong.DICHVU_CNTT, DichVuVienThong.TRUNGTAM_DULIEU, DichVuVienThong.HOINGHI_TRUYENHINH, DichVuVienThong.ANTOAN_BAOMAT_TT, DichVuVienThong.HATANG_VIENTHONG, DichVuVienThong.MEGA_EYES].indexOf(this.listbox.dichvu_vt.value * 1) >= 0
      ) {
        var dk = 'sudung = 1'
        // this.cboGoiCuocAdsl.EditValueChanged -= new System.EventHandler(this.cboGoiCuocAdsl_EditValueChanged);
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.FSECURE) {
          // bangts.HT_Tocdo_Fsecure_GRID(cboGoiCuocAdsl, this.listbox.loaihinh_tb.value, dk);
          this.loading(true)
          try {
            await API.post_sp_ht_tocdo_fsecure(this.axios, { loaitb_id: val }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.listbox.cboGoiCuocAdsl.list = response.data.data
                if (this.listbox.cboGoiCuocAdsl.list && this.listbox.cboGoiCuocAdsl.list.length > 0) {
                  this.listbox.cboGoiCuocAdsl.value = this.listbox.cboGoiCuocAdsl.list.filter((x) => x.tocdo_id > 0)[0].tocdo_id
                  await this.cboGoiCuocAdsl_SelectedValueChanged(this.listbox.cboGoiCuocAdsl.value)
                }
              }
            })
          } catch (ex) {
            this.$toast.error('' + ex)
            if (this.debug) console.error(ex)
          } finally {
            this.loading(false)
          }
        } //nhapt sua theo y/c C.Phuong 04012017
        else {
          this.loading(true)
          try {
            await API.post_sp_ht_tocdo_adsl_theo_loaitb(this.axios, { congnghe_id: this.listbox.congnghe.value ? this.listbox.congnghe.value : 0, kieuld_id: this.listbox.kieu_ld.value, loaitb_id: val }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.listbox.cboGoiCuocAdsl.list = response.data.data
                if (this.listbox.cboGoiCuocAdsl.list && this.listbox.cboGoiCuocAdsl.list.length > 0) this.listbox.cboGoiCuocAdsl.value = this.listbox.cboGoiCuocAdsl.list.filter((x) => x.tocdo_id > 0)[0].tocdo_id
                await this.cboGoiCuocAdsl_SelectedValueChanged(this.listbox.cboGoiCuocAdsl.value)
                // this.listbox.cboGoiCuocAdsl.values = [this.listbox.cboGoiCuocAdsl.value];
              }
            })
          } catch (ex) {
            this.$toast.error('' + ex)
            if (this.debug) console.error(ex)
          } finally {
            this.loading(false)
          }
        }
        // this.cboGoiCuocAdsl.EditValueChanged += new System.EventHandler(this.cboGoiCuocAdsl_EditValueChanged);
        // cboGoiCuocAdsl_SelectedValueChanged(cboGoiCuocAdsl, null);
      }
      if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
        await this.SinhMaDVVT_BC()
        //if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MGW_INTERNET_TRUCTIEP) HT_PhanLoaiMGWAN();
      }

      if (!this.watcherActive) this.HT_GIAODIEN_DONVI()
      //HungHM - 31/08/2010 - Bổ xung ngày hết hạn đặt chỗ ( chỉ ADSL, Internet 126x, ADSL mới hiện lên)
      if (val == LoaiHinhTB.INTERNET_1260 || val == LoaiHinhTB.INTERNET_ADSL || val == LoaiHinhTB.INTERNET_FTTH || val == LoaiHinhTB.WIFI_FIBER || val == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC || val == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC) {
        this.thuebao.adsl.dtpHanDatCho_Visible = true
        this.thuebao.adsl.btnKiemTraAccount_visible = true
      } else {
        this.thuebao.adsl.dtpHanDatCho_Visible = false
        this.thuebao.adsl.btnKiemTraAccount_visible = false
      }
      this.thuebao.adsl.txtAccountADSL = ''
      this.thuebao.adsl.txtEmailAdsl = ''
      if (this.listbox.dichvu_vt.value == DichVuVienThong.IMS_DOITAC) this.thuebao.ims.txtMaTBIMS = ''
      if (this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC) this.thuebao.mgwan.txtMaTBWan.Text = ''
      if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC) this.thuebao.tsl.txtMaTSL.Text = ''

      //HungHM - 05/08/2010 - Sinh mã MyTV
      this.thuebao.adsl.txtAccountADSL_ReadOnly = false
      if (
        (!this.thuebao.adsl.txtAccountADSL || this.thuebao.adsl.txtAccountADSL.trim().length == 0) &&
        (val == LoaiHinhTB.INTERNET_MYTV || val == LoaiHinhTB.INTERNET_MYTV_B2B || val == LoaiHinhTB.HTVC_FIBERVNN_ANALOG || val == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL || val == LoaiHinhTB.WIFI_MESH || val == LoaiHinhTB.INDOOR_CAM || val == LoaiHinhTB.OUTDOOR_CAM)
      )
        this.SinhMaDVVT_BC()

      this.LoadMucCuocTB()

      // ///TuanNA: Thêm code lấy thông tin cước thuê kênh, thuê cổng đối với thuê bao Megawan
      if (
        this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN ||
        this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM ||
        this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM ||
        this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC ||
        this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC
      ) {
        this.thuebao.mgwan.cuocisp = 0
        this.thuebao.mgwan.cuocnix = 0
        this.thuebao.mgwan.soluongip = 0
        this.thuebao.mgwan.cuocip = 0
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MGW_INTERNET_TRUCTIEP || this.listbox.loaihinh_tb.value == LoaiHinhTB.NB_INTERNETTT) {
          this.listbox.phanloai_dv.enabled = true
          this.listbox.ht_phantach_tocdo.enabled = true
        } else {
          this.listbox.phanloai_dv.enabled = false
          this.listbox.ht_phantach_tocdo.enabled = false
        }
      }
      // ///Ngày 07.05.2012
      // if (dichvuvt_id == DichVuVienThong.MEGAWAN || dichvuvt_id == DichVuVienThong.TSL || dichvuvt_id == DichVuVienThong.METRONET
      //     || dichvuvt_id == DichVuVienThong.MGW_DOITAC || dichvuvt_id == DichVuVienThong.TSL_DOITAC)
      // {
      //     txtCuoc_ISP.Text = "0";
      //     txtCuoc_NIX.Text = "0";
      //     txtSoLuong_IP.Text = "0";
      //     txtCuoc_IP.Text = "0";

      //     if (loaitb_id == LoaiHinhTB.MGW_INTERNET_TRUCTIEP)
      //     {
      //         label38.Text = "Tốc độ tổng";
      //         cboPhanLoaiMGW.Enabled = true;
      //         cboPhanLoaiMGW.SelectedIndex = 0;
      //         cboPhanTachTD.Enabled = true;
      //         cboPhanTachTD.SelectedIndex = 0;

      //         cboTocDo.Enabled = true;
      //         cboTocDo.EditValue = 0;
      //         cboTocDo_PIR.Enabled = false;
      //         chkTocDo_PIR.Checked = false;
      //         cboTocDo_PIR.EditValue = 0;
      //         chkTocDo_PIR.Enabled = false;

      //         txtCuoc_ISP.Enabled = true;
      //         txtCuoc_NIX.Enabled = true;
      //         txtSoLuong_IP.Enabled = true;
      //         txtCuoc_IP.Enabled = true;
      //         //chkTocDo_ISP.Enabled = true;
      //         //chkTocDo_NIX.Enabled = true;

      //         if (Convert.ToInt32(cboPhanTachTD.SelectedValue) == 1)
      //         {
      //             chkTocDo_ISP.Enabled = true;
      //             chkTocDo_NIX.Enabled = true;

      //             cboTocDo_ISP.EditValue = 0;
      //             cboTocDo_NIX.EditValue = 0;
      //             cboTocDo_ISP.Text = "";
      //             cboTocDo_NIX.Text = "";

      //             txtCuoc_NIX.Text = "0";
      //             txtCuoc_ISP.Text = "0";
      //         }
      //         else
      //         {
      //             chkTocDo_ISP.Enabled = false;
      //             chkTocDo_NIX.Enabled = false;

      //             cboTocDo_ISP.EditValue = 0;
      //             cboTocDo_NIX.EditValue = 0;
      //             cboTocDo_ISP.Text = "";
      //             cboTocDo_NIX.Text = "";

      //             txtCuoc_NIX.Text = "0";
      //             txtCuoc_ISP.Text = "0";
      //         }

      //         //HienThi_CTK_NIX_ISP(2);
      //         //HienThi_CTK_NIX_ISP(3);
      //     }
      //     else
      //     {
      //         label38.Text = "Tốc độ CIR";
      //         cboPhanLoaiMGW.Enabled = false;
      //         cboPhanLoaiMGW.SelectedIndex = 0;
      //         cboPhanTachTD.Enabled = false;
      //         cboPhanTachTD.SelectedIndex = 0;

      //         cboTocDo.Enabled = true;
      //         cboTocDo.EditValue = 0;
      //         cboTocDo_PIR.Enabled = false;
      //         cboTocDo_PIR.EditValue = 0;
      //         chkTocDo_PIR.Enabled = true;
      //         chkTocDo_PIR.Checked = false;

      //         cboTocDo_ISP.Enabled = false;
      //         cboTocDo_NIX.Enabled = false;
      //         txtCuoc_ISP.Enabled = false;
      //         txtCuoc_NIX.Enabled = false;
      //         txtSoLuong_IP.Enabled = false;
      //         txtCuoc_IP.Enabled = false;
      //         chkTocDo_ISP.Enabled = false;
      //         chkTocDo_NIX.Enabled = false;
      //         chkTocDo_ISP.Checked = false;
      //         chkTocDo_NIX.Checked = false;

      //         cboTocDo_ISP.EditValue = 0;
      //         cboTocDo_NIX.EditValue = 0;
      //         cboTocDo_ISP.Text = "";
      //         cboTocDo_NIX.Text = "";

      //         txtCuoc_NIX.Text = "0";
      //         txtCuoc_ISP.Text = "0";
      //     }
      //     HienThi_CTK_CTC();
      // }

      await this.LAY_DS_DVGT_MACDINH(this.listbox.loaihinh_tb.value)
      await this.LAY_DS_DVK_MACDINH_TB(this.listbox.loaihinh_tb.value);

      // if (loaitb_id == LoaiHinhTB.INTERNET_MYTV || loaitb_id == LoaiHinhTB.INTERNET_MYTV_B2B)
      // {
      //     pnlMyTV.Visible = true;
      //     txtEmailAdsl.Enabled = false;
      // }
      // else
      // {
      //     pnlMyTV.Visible = false;
      //     txtEmailAdsl.Enabled = true;
      // }

      // if (loaitb_id == LoaiHinhTB.COSO_HATANG)
      //     pnlCSHT.Visible = true;
      // else
      //     pnlCSHT.Visible = false;

      // if (loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_ANALOG || loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL
      //     || loaitb_id == LoaiHinhTB.MEGACAMERA)
      // {
      //     pnlHTVC.Visible = true;
      //     txtEmailAdsl.Enabled = false;
      // }
      // else
      // {
      //     pnlHTVC.Visible = false;
      //     txtEmailAdsl.Enabled = true;
      // }

      // if (loaitb_id == LoaiHinhTB.FSECURE)
      // {
      //     pnlFsecure.Visible = true;
      //     txtEmailAdsl.Enabled = false;
      // }
      // else
      // {
      //     pnlFsecure.Visible = false;
      //     txtEmailAdsl.Enabled = true;
      // }

      // if (loaitb_id == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC || loaitb_id == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC)
      // {
      //     pnlFiber_TK.Visible = true;
      //     txtEmailAdsl.Enabled = false;
      // }
      // else
      // {
      //     pnlFiber_TK.Visible = false;
      //     txtEmailAdsl.Enabled = true;
      // }

      // if (loaitb_id == LoaiHinhTB.INTERNET_SGTV || loaitb_id == LoaiHinhTB.CAMERA_HOCDUONG)
      // {
      //     pnlDynamicInt.Top = pnlFTTH.Top + 5;
      // }
      // else if (loaitb_id == LoaiHinhTB.INTERNET_FTTH || loaitb_id == LoaiHinhTB.WIFI_FIBER || loaitb_id == LoaiHinhTB.INTERNET_ADSL
      //     || loaitb_id == LoaiHinhTB.INTERNET_MYTV || loaitb_id == LoaiHinhTB.INTERNET_MYTV_B2B || loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_ANALOG
      //     || loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL || loaitb_id == LoaiHinhTB.MEGACAMERA || loaitb_id == LoaiHinhTB.COSO_HATANG)
      // {
      //     pnlDynamicInt.Top = pnlMyTV.Top + pnlMyTV.Height + 2;
      // }
      // else if (loaitb_id == LoaiHinhTB.FSECURE || loaitb_id == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC || loaitb_id == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC)
      // {
      //     pnlDynamicInt.Top = pnlFsecure.Bottom + 2;
      // }

      // if (loaitb_id == LoaiHinhTB.INTERNET_FTTH || loaitb_id == LoaiHinhTB.WIFI_FIBER || loaitb_id == LoaiHinhTB.INTERNET_ADSL)
      // {
      //     txtTTCuoc.Enabled = false;
      //     pnlFTTH.Visible = true;
      // }
      // else
      // {
      //     pnlFTTH.Visible = false;
      // }
      if ([DichVuVienThong.ANTOAN_BAOMAT_TT, DichVuVienThong.DICHVU_CNTT, DichVuVienThong.TRUNGTAM_DULIEU, DichVuVienThong.HOINGHI_TRUYENHINH].indexOf(this.listbox.dichvu_vt.value * 1) >= 0) await this.LoadThongTin_DV_CNTT(val)
      // //ds_tien_khoanmuc = bangts.Lay_tienkhoanmuc_loaihd(LoaiHopDong.DAT_MOI);
      // DataTable dt = new DataTable();
      // dt = dsDanhMuc.Tables["TIEN_KM"].Copy();
      // dt.TableName = "danhsach";
      // ds_tien_khoanmuc.Tables.Remove("danhsach");
      // ds_tien_khoanmuc.Tables.Add(dt);
      // dt = null;
      this.m_dsTienCTKM = []
      if (!this.kt_load) this.LayTienTheoKhoanMuc()
      // dsCTM_TBI = new CT_MUA_TBI_DATA();
      // HT_ThietBi();
      // HT_DichVuGT();
      // dtiendatcoc_km = 0;
      // dtiendatcoc_tt = 0;
      // dtienkmld = 0;
      // dtienkmdc = 0;
      // dvatkmld = 0;
      // dvatkmdc = 0;
      // dsHDTB_CT = new List<HD_THUEBAO_CT>();
      // HienThiTienKhuyenMaiLapDat(dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt);

      // KT_GOI_CBO_LOAIHINH = false;

      // //Thực hiện theo SRV https://cntt.vnpt.vn/browse/VNPSR-11947
      this.thuebao.tgdungthu = 30
      //Thực hiện theo SRV https://cntt.vnpt.vn/browse/VNPSR-11947
      if (this.vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) {
        //Khách hàng doanh nghiệp và kiểm tra thời gian lập hợp đồng từ ngày 20/05/2020-30/06/2020
        if (new Date().getTime() >= new Date(2020, 5, 20).getTime() && new Date().getTime() <= new Date(2020, 6, 30).getTime() && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
          this.thuebao.tgdungthu = 60
        }
      }
      // if (dichvuvt_id == DichVuVienThong.ANTOAN_BAOMAT_TT || dichvuvt_id == DichVuVienThong.HOINGHI_TRUYENHINH
      //     || dichvuvt_id == DichVuVienThong.DICHVU_CNTT || dichvuvt_id == DichVuVienThong.TRUNGTAM_DULIEU)
      // {
      //     if ((((DataRow)((cboLoaihinhTB.SelectedItem as DataRowView).Row))["CHOPHEP_DT"] ?? "0").ToString() == "1")
      //     {
      //         txtTGDungThu.Text = ((DataRow)((cboLoaihinhTB.SelectedItem as DataRowView).Row))["SONGAY_DT"].ToString();
      //     }
      // }
    },
    'listbox.trangbi.valuecd': function(val, oldval) {
      if (!(val != oldval && val > 0)) return
      if (!this.watcherActive) return
      this.LoadMucCuocTB()
    },
    NgayYeuCau: function() {
      if (!this.watcherActive) return
      this.LoadMucCuocTB()
    },
    'diachiBC.DIACHI': function(newval, oldval) {
      if (!(newval != oldval)) return
      if (newval) this.LoadNVThuCuoc()
    },
    'diachiTT.DIACHI': function(newval, oldval) {
      if (!(newval != oldval)) return
      if (newval) this.LoadNVThuCuoc()
    },
    'diachiKH.DIACHI': function(newval, oldval) {
      if (!(newval != oldval)) return
      if (newval) this.LoadNVThuCuoc()
    },
    // //'listbox.donvi_ql.value': function(oldval, newval) { this.LoadNVThuCuoc(); }, // xem lai vi khong logic, da chuyen data sang dong duoi
    'listbox.donvi_ql.valueql': function(newval, oldval) {
      if (!(newval != oldval && newval > 0)) return
      if (!this.watcherActive) return
      if (newval) this.LoadNVThuCuoc()
    },
    'listbox.donvi_ql.value': async function(newval, oldval) {
      // if (!this.watcherActive) return
      if (!(newval != oldval && newval > 0)) return
      if (!newval) return
      for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
        if (this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.TRAM_VT || this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.TRAM_CAP_PORT)
          await API.post_sp_lay_ds_tram_thicong_theo_donvi(this.axios, { donvi_ql_id: newval, loaidv_id: LOAI_DV.TRAM_VT }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              this.DT_CONTROLS.data[i] = this.UpperCasePropertyList(response.data.data)
              // if(!this.DT_CONTROLS.value[i] || this.DT_CONTROLS.value[i]<=0) {
              //   this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0]['DONVI_ID'];
              // } else {
              var fdata = this.DT_CONTROLS.data[i].filter((x) => x.DONVI_ID == this.DT_CONTROLS.value[i] && x.DONVI_ID > 0)
              if (fdata && fdata.length > 0) this.DT_CONTROLS.value[i] = fdata[0]['DONVI_ID']
              else this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0]['DONVI_ID']
              // }
              this.DT_CONTROLS.key += 1
            }
          })
      }
    },

    'filterbox.tratruoc.ischecked': function(val) {
      if (!this.watcherActive) return
      if (this.filterbox.tratruoc.list && this.filterbox.tratruoc.list.length > 0) {
        if (!this.filterbox.tratruoc.value || this.filterbox.tratruoc.value == 0 || !this.filterbox.tratruoc.list.find((x) => x.khuyenmai_id == this.filterbox.tratruoc.value)) this.filterbox.tratruoc.value = this.filterbox.tratruoc.list[0].khuyenmai_id //else this.filterbox.tratruoc.value=0;
      }
      if (this.m_dsTienCTKM) this.m_dsTienCTKM = this.m_dsTienCTKM.filter((x) => x.kieu != 1)
      if (!val) this.cboTraTruoc_SelectedValueChanged()
    },
    'filterbox.khuyenmai.ischecked': function(val) {
      if (!this.watcherActive) return
      if (this.filterbox.khuyenmai.list && this.filterbox.khuyenmai.list.length > 0)
        if (!this.filterbox.khuyenmai.value || this.filterbox.khuyenmai.value == 0 || !this.filterbox.khuyenmai.list.find((x) => x.khuyenmai_id == this.filterbox.khuyenmai.value)) this.filterbox.khuyenmai.value = this.filterbox.khuyenmai.list[0].khuyenmai_id //else this.filterbox.khuyenmai.value=0;
      if (!val) this.cboKhuyenMai_SelectedValueChanged()
    },

    'listbox.hinhthuc_tt.value': function(newval, oldval) {
      if (!(newval != oldval && newval > 0)) return
      if (!this.watcherActive) return
      if (newval) this.LoadNVThuCuoc()
    },

    DiaChiTTCLONE: {
      handler: function(oldval, newval) {
        //Đảo ngược do code bên dưới bị ngược
        // ### recent
        if (!this.watcherActive) return
        if(oldval.TINH_ID==0) return;
        var pdata = {
          DONVIQL_HTTT: this.DONVIQL_HTTT,
          TINH_ID: oldval.TINH_ID,
          DACDIEM_ID: oldval.DACDIEM_ID ? oldval.DACDIEM_ID : 0,
          QUAN_ID: oldval.QUAN_ID,
          PHUONG_ID: oldval.PHUONG_ID,
          PHO_ID: oldval.PHO_ID ? oldval.PHO_ID : 0,
          AP_ID: oldval.AP_ID ? oldval.AP_ID : 0,
          KHU_ID: oldval.KHU_ID ? oldval.KHU_ID : 0,
          LOAIKH_ID: this.listbox.loai_kh.value,
          HTTT_ID: this.listbox.hinhthuc_tt.value,
          PHANTAP_KH: this.PHANTAP_KH,
          TINHTT_ID: newval.TINH_ID,
          QUANTT_ID: newval.QUAN_ID,
          PHUONGTT_ID: newval.PHUONG_ID,
          DACDIEMTT_ID: newval.DACDIEM_ID ? newval.DACDIEM_ID : 0,
          PHOTT_ID: newval.PHO_ID ? newval.PHO_ID : 0,
          APTT_ID: newval.AP_ID ? newval.AP_ID : 0,
          KHUTT_ID: newval.KHU_ID ? newval.KHU_ID : 0,
          KHACHHANG_ID: this.khachhang.khachhang_id,
          NGANHNGHELOC: this.listbox.nganhngheloc.value,
          COUNT_DVI_QL_ID: this.listbox.donvi_ql.list.length
        }
        API.post_fn_lay_tt_diachi_thanhtoan(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            var apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] == -2 && apidata['RESULT']['DS_DVI']) {
              // case nay xu ly ben duoi!
            } else if (apidata['ERROR_CODE'] != 1 && apidata['ERROR_CODE'] != -99) {
              this.$toast.error(apidata['MESSAGE'])
              return
            }
            if (apidata['RESULT']) apidata = apidata['RESULT']
            if (apidata['DS_DVI']) this.XuLyDonViQL(apidata['DS_DVI'])
            if (apidata['DONVQL_ID'] && apidata['DONVQL_ID'] * 1 > 0) this.listbox.donvi_ql.valueql = apidata['DONVQL_ID'] * 1
          }
        })
      },
      deep: true
    },

    'listbox.loai_kh.value': async function(newval, oldval) {
      if (!(newval != oldval && newval > 0)) return
      if (!this.watcherActive) return
      try {
        if (newval == -1) return
        var drPLKH = this.listbox.phanloai_kh.list.filter((x) => x.loaikh_id == newval)
        if (this.nhomplkh <= 1) {
          //chỉ thay đổi nếu nhóm pl là ko theo doanh thu
          this.PHANLOAIKH_ID = 0
          this.khachhang.plkh = ''
          this.vkieukh_id_ = 0
          var kieukh_id = 0
          var kieukh = ''

          this.vkieukh_id_ = 0
          var kieukh_id = 0
          var kieukh = ''

          kieukh = this.listbox.loai_kh.list.filter((x) => x.loaikh_id == newval)[0]['loai'] //.Select("LOAIKH_ID=" + cboLoaiKH.EditValue)[0]["LOAI"];

          if (kieukh) {
            this.vkieukh_id_ = kieukh
            kieukh_id = kieukh
          }

          if (drPLKH.length > 0) {
            this.PHANLOAIKH_ID = drPLKH[0]['phanloaikh_id']
            this.khachhang.plkh = drPLKH[0]['ma_plkh']
          } else {
            if (kieukh_id == KIEU_KH.CA_NHAN) {
              var dr_PLKH = this.listbox.phanloai_kh.list.filter((x) => x.hienthi_md == PHANLOAI_KH.CA_NHAN) //dsDanhMuc.Tables["PHANLOAI_KH"].Select("hienthi_md = " + PHANLOAI_KH.CA_NHAN);
              if (dr_PLKH.length > 0) {
                this.PHANLOAIKH_ID = dr_PLKH[0]['phanloaikh_id']
                this.khachhang.plkh = dr_PLKH[0]['ma_plkh']
              }
            } else {
              var dr_PLKH = this.listbox.phanloai_kh.list.filter((x) => x.hienthi_md == PHANLOAI_KH.DOANH_NGHIEP)
              if (dr_PLKH.length > 0) {
                this.PHANLOAIKH_ID = dr_PLKH[0]['phanloaikh_id'] ? dr_PLKH[0]['phanloaikh_id'] * 1 : 0
                this.khachhang.plkh = dr_PLKH[0]['ma_plkh']
              }
            }
          }
        } else {
          //region Kiểm tra mã ngân sách
          var kieukh = this.listbox.loai_kh.list.filter((x) => x.loaikh_id == newval)[0]['loai'] //.Select("LOAIKH_ID=" + cboLoaiKH.EditValue)[0]["LOAI"];
          if (kieukh) this.vkieukh_id_ = kieukh
        }
        this.thuebao.tgdungthu = 30
        //Thực hiện theo SRV https://cntt.vnpt.vn/browse/VNPSR-11947
        if (this.vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) {
          //Khách hàng doanh nghiệp và kiểm tra thời gian lập hợp đồng từ ngày 20/05/2020-30/06/2020
          if (new Date().getTime() >= new Date(2020, 5, 20).getTime() && new Date().getTime() <= new Date(2020, 6, 30).getTime() && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
            this.thuebao.tgdungthu = 60
          }
        }

        // hoangpkn : 25/10/2017 Thêm nhân viên quản lý
        var pdata = {
          ds_para: JSON.stringify({
            PHANTAP_KH: this.PHANTAP_KH,
            DICHVUVT_ID: this.listbox.dichvu_vt.value,
            LOAIKH_ID: this.listbox.loai_kh.value,
            PHUONGTT_ID: this.diachiTT.PHUONG_ID ? this.diachiTT.PHUONG_ID : 0,
            PHOTT_ID: this.diachiTT.PHO_ID ? this.diachiTT.PHO_ID : 0,
            APTT_ID: this.diachiTT.AP_ID ? this.diachiTT.AP_ID : 0,
            KHUTT_ID: this.diachiTT.KHU_ID ? this.diachiTT.KHU_ID : 0,
            DONVIQL_HTTT: this.DONVIQL_HTTT,
            HTTT_ID: this.listbox.hinhthuc_tt.value,
            KHACHHANG_ID: this.khachhang.khachhang_id,
            DACDIEMTT_ID: this.diachiTT.DACDIEM_ID ? this.diachiTT.DACDIEM_ID : 0,
            CBO_DVIQL_COUNT: 1,
            NGANHNGHELOC_ID: this.listbox.nganhngheloc.value,
            DOITUONG_ID: this.listbox.doituong.value
          })
        } //CBO_DVIQL_COUNT la dem so luong item con trong combobox, vi so luong luon >0 nen de default 1
        await API.post_fn_lay_tt_combo_loaikh(this.axios, pdata).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            var apidata = JSON.parse(response.data.data)
            if (apidata['RESULT']) apidata = apidata['RESULT']
            // Doan nay xu ly cho dong 31562-31567, dieu kien cho DichVuVienThong.DI_DONG
            if (apidata['DOITUONG_NEO'] && apidata['DOITUONG_NEO'].length > 0) {
              this.thuebao.didong.cboDTVinaPhone.list = apidata['DOITUONG_NEO']
              this.thuebao.didong.cboDTVinaPhone.value = this.thuebao.didong.cboDTVinaPhone.list[0]['DOITUONG_NEO']
            }
            if (apidata['DONVQL_ID']) this.listbox.donvi_ql.valueql = apidata['DONVQL_ID']
            if (apidata['DS_CT_KM']) this.dsKM_HDTB = apidata['DS_CT_KM']
            if (apidata['DS_DVI']) this.XuLyDonViQL(apidata['DS_DVI'])
          }
        })
        if (this.diachiTT.PHUONG_ID != 0 && (this.diachiTT.PHO_ID != 0 || this.diachiTT.AP_ID != 0 || this.diachiTT.KHU_ID != 0)) {
          this.LoadNVThuCuoc()
          // HT_NVTC_TheoDC(quantt_id, phuongtt_id, phott_id, aptt_id, khutt_id, Convert.ToInt32(cboDonViQL.SelectedValue), dacdiemtt_id); //Tuong duong ham tren

          if (this.DONVIQL_HTTT == 1) this.HienThi_NVQL_AM_HTTT()
          else this.HienThi_NVQL_AM()
        }

        // #region Lấy chi tiết khuyến mại dùng thử fill vào khuyenmai_hdtb
        if (this.listbox.loai_kh.value != -1) {
          if (this.listbox.doituong.value == DUNG_THU.DOITUONG_TB) {
            var dsTemp = []
            await API.post_lay_chitiet_km_dungthu_v2(this.axios, { vloaikh_id: this.listbox.loai_kh.value }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                dsTemp = response.data.data
              }
            })

            if (dsTemp.length > 0) {
              if (dsTemp[0]['khuyenmai_id']) {
                this.filterbox.khuyenmai.value = dsTemp[0]['khuyenmai_id']
                this.filterbox.khuyenmai.ischecked = true
              } else this.filterbox.khuyenmai.ischecked = false

              // DateTime tmp;
              var ithang_huongdc = 0,
                ithang_huongkm = 0,
                ithang_tg = 0
              var dtiendatcoc_csd = 0,
                dtien_td = 0
              this.dsKM_HDTB = []

              for (var i = 0; i < dsTemp.length; i++) {
                ithang_huongdc = 0
                ithang_huongkm = 0
                ithang_tg = 0
                dtiendatcoc_csd = 0
                dtien_td = 0
                var dr = {}
                if (dsTemp[i]['huong_dc']) ithang_huongdc = dsTemp[i]['huong_dc']
                if (dsTemp[i]['huong_km']) ithang_huongkm = dsTemp[i]['huong_km']
                if (dsTemp[i]['sothang_tg']) ithang_tg = dsTemp[i]['sothang_tg']
                if (dsTemp[i]['datcoc_csd']) dtiendatcoc_csd = dsTemp[i]['datcoc_csd']
                if (dsTemp[i]['tien_td']) dtien_td = dsTemp[i]['tien_td']
                dr.THANG_HUONGDC = ithang_huongdc
                dr.THANG_HUONGKM = ithang_huongkm
                dr.SOTHANG_TG = ithang_tg
                dr.DATCOC_CSD = dtiendatcoc_csd
                dr.TIEN_TD = dtien_td

                if (dsTemp[i]['kieu_bdkm'] == '3') {
                  try {
                    var tmp = moment(dsTemp[i]['thang_bd'], 'YYYYMM')
                      .add(ithang_huongkm, 'M')
                      .format('YYYYMM')
                    dr.THANG_BD = dsTemp[i]['thang_bd']
                    dr.THANG_KT = tmp
                  } catch (ex) {}
                }
                if (dsTemp[i]['kieu_bdtg'] == '3') {
                  try {
                    var tmp = moment(dsTemp[i]['thang_bdtg'], 'YYYYMM')
                      .add(ithang_tg, 'M')
                      .format('YYYYMM')
                    dr.THANG_BDTG = dsTemp[i]['thang_bdtg']
                    dr.THANG_KTTG = tmp
                  } catch (ex) {}
                }
                if (dsTemp[i]['kieu_bddc'] == '3') {
                  try {
                    var tmp = moment(dsTemp[i]['thang_bddc'], 'YYYYMM')
                      .add(ithang_huongkm, 'M')
                      .format('YYYYMM')
                    dr.THANG_BDDC = dsTemp[i]['thang_bddc']
                    dr.THANG_KTDC = tmp
                  } catch (ex) {}
                }
                //longdx: bổ sung thông tin tỷ lệ km
                dr.TYLE_KMLD = dsTemp[i]['tyle_kmld']
                dr.TYLE_SD = dsTemp[i]['tyle_sd']
                dr.TYLE_TB = dsTemp[i]['tyle_tb']
                dr.HDTB_ID = this.hdtb_id //-1;
                dr.CHITIETKM_ID = dsTemp[i]['chitietkm_id']
                dr.KHUYENMAI_ID = dsTemp[i]['khuyenmai_id']
                //dr.KHUYENMAI_ID_NEO = dsTemp[i]["khuyenmai_id_neo"];
                dr.KIEU_YC = 1
                this.dsKM_HDTB.push(dr)

                //Lấy tiền khuyến mại
                if (this.kmld.tien_kmld < dsTemp[i]['tien_kmld']) this.kmld.tien_kmld = dsTemp[i]['tien_kmld']
                if (this.kmld.vat_kmld < dsTemp[i]['vat_kmld']) this.kmld.vat_kmld = dsTemp[i]['vat_kmld']
                if (this.kmld.tyle_kmld < dsTemp[i]['tyle_kmld']) this.kmld.tyle_kmld = dsTemp[i]['tyle_kmld']

                if (this.kmld.tien_datcoc < dsTemp[i]['datcoc_csd']) this.kmld.tien_datcoc = dsTemp[i]['datcoc_csd']
              }
            }
          }
        }
        // #endregion
      } catch (ex) {
        var dsPL = this.listbox.phanloai_kh.list.filter((x) => x.hienthi_md == PHANLOAI_KH.CA_NHAN)
        if (dsPL && dsPL.length > 0) {
          this.PHANLOAIKH_ID = dsPL[0]['phanloaikh_id']
          this.khachhang.plkh = dsPL[0]['ma_plkh']
        }
      }
    },

    'listbox.kieu_ld.value': function(newval, oldval) {
      if (!(newval != oldval && newval > 0)) return
      this.thuebao.mgwan.madoicap = null;
      this.thuebao.mgwan.matn = null;
      this.HT_GIAODIEN_DONVI() // chuyen sang load co dieu kien phia duoi!!!!
      if (!this.watcherActive) return
      this.defaultCongNghe(newval)
      //TODO can lam them o function cboKieuLD_SelectedValueChanged

      // tiep tu line 21982
      if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH || this.listbox.dichvu_vt.value == DichVuVienThong.GPHONE || this.listbox.dichvu_vt.value == DichVuVienThong.IMS || this.listbox.dichvu_vt.value == DichVuVienThong.IMS_DOITAC) this.tocdo_id = 0
      if (!this.kt_load) {
        this.LayTienTheoKhoanMuc()
        if (this.listbox.doituong.value != DUNG_THU.DOITUONG_TB) this.HT_DS_KhuyenMai_Combobox()
        // this.HT_GIAODIEN_DONVI()
      }
      if (this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT
          || this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT
          || this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU
          || this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH) {
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.Voice_Brandname) {
          for (var i = this.ItemList.length - 1; i >= 0; i--) {

            if (this.ItemList[i].sFieldName == "TOCDO_ID") {
              var filter_kieuld = this.ItemList[i].SqlData;
              if (newval == 14069 || newval == 14070 || newval == 19543)/*đối tượng 3*/ {
                filter_kieuld = this.ItemList[i].SqlData.filter(x => x["THUONGHIEU"].includes('Đối tượng 3'));
              } else if (newval == 14052)/*đối tượng 2*/ {
                filter_kieuld = this.ItemList[i].SqlData.filter(x => x["THUONGHIEU"].includes('Đối tượng 2'));
              }
              else if (newval == 14051)/*đối tượng 1*/ {
                filter_kieuld = this.ItemList[i].SqlData.filter(x => x["THUONGHIEU"].includes('Đối tượng 1'));
              }
              this.gridEditors[i].DataSource = filter_kieuld.map((x) => ({ text: x[this.ItemList[i].sLookUpValueField], id: x[this.ItemList[i].sLookUpKeyField] }));
            }
            if (this.ItemList[i].sFieldName == "DONVIKG_ID") {
              var filter_kieuld = this.ItemList[i].SqlData;
              if (newval == 14069 || newval == 14070 || newval == 19543)/*đối tượng 3*/ {
                filter_kieuld = this.ItemList[i].SqlData.filter(x => x["TEN_DV"].includes('AArenet') || x["TEN_DV"].includes('vIMS'));
              } else if (newval == 14052)/*đối tượng 2*/ {
                filter_kieuld = this.ItemList[i].SqlData.filter(x => x["TEN_DV"].includes('Voice_brn'));
              }
              else if (newval == 14051)/*đối tượng 1*/ {
                filter_kieuld = this.ItemList[i].SqlData.filter(x => x["TEN_DV"].includes('MEG') || x["TEN_DV"].includes('VCC'));
              }
              this.gridEditors[i].DataSource = filter_kieuld.map((x) => ({ text: x[this.ItemList[i].sLookUpValueField], id: x[this.ItemList[i].sLookUpKeyField] }));
            }

            if (!(this.ItemList[i].sFieldName == "DUNGTHU"
              || this.ItemList[i].sFieldName == "THIETBI"
              || this.ItemList[i].sFieldName == "MA_DV"
              || this.ItemList[i].sFieldName == "DINHTUYEN"))
            {
            } else if (newval == 14052 || newval == 14051 || newval == 793)/*đối tượng 1, 2*/ {
              this.gridEditors[i].show = false;
              // this.ItemList[i].hidden = true;
            }
          }
        }
      }

      this.watchLock = false;
      // this.PopupThongSo(); //Xu ly luon o GUI
    },

    buttonSet: async function(newval) {
      if (!this.watcherActive) return
      switch (newval) {
        case -1:
          this.watcherActive = false
          this.filterbox.ctv.ischecked = false
          this.filterbox.nguoigt.ischecked = false
          this.listbox.madaidien.value = 0
          this.listbox.madaidien.list = []
          this.thongso_ban = newThongSoThueBao()
          this.thongso_tc = newThongSoThueBao()
          this.dt_ban_cntt = []
          this.dt_tc_cntt = []
          this.buttons.tsbtnGhiLai = true
          this.buttons.tsbtnHuyBo = true
          this.FormLoad()
          break
        case 0:
          this.loading(true)
          this.watcherActive = false
          var ctab = this.currentTab + ''
          Object.assign(this.$data, this.$options.data.call(this))
          this.thongso_ban = newThongSoThueBao()
          this.thongso_tc = newThongSoThueBao()
          this.dt_ban_cntt = []
          this.dt_tc_cntt = []
          this.buttonSet = 0
          this.loading(false)
          this.FormLoad()
          this.buttons.tsbtnNhapMoi = true
          this.currentTab = ctab
          break
        case 1:
          this.loading(true)
          this.watcherActive = false
          var ctab = this.currentTab + ''
          Object.assign(this.$data, this.$options.data.call(this))
          this.thongso_ban = newThongSoThueBao()
          this.thongso_tc = newThongSoThueBao()
          this.dt_ban_cntt = []
          this.dt_tc_cntt = []
          this.buttonSet = 1
          this.loading(false)
          this.FormLoad()
          this.buttons.tsbtnGhiLai = true
          this.buttons.tsbtnHuyBo = true
          this.buttons.tsbtnThemTT = false
          this.buttons.tsbtnXoaTT = false
          this.currentTab = ctab
          break
        case 2: // Nut huy 18281
          this.watcherActive = false
          Object.assign(this.$data, this.$options.data.call(this))
          this.buttonSet = 2
          this.FormLoad()
          this.buttons.tsbtnNhapMoi = true
          this.buttons.tsbtnXoa = true
          break
        case 3: // Nut edit
          this.buttons.tsbtnNhapMoi = true
          this.buttons.tsbtnXoa = true
          this.buttons.tsbtnGhiLai = true
          this.buttons.tsbtnHuyBo = true
          this.buttons.tsbtnXoaTB = true
          this.buttons.tsbtnThemTB = true
          this.buttons.tsbtnThanhToan = true
          this.buttons.inPhụLụcToolStripMenuItem = false
          break
        case 4:
          this.buttons.tsbtnGhiLai = true
          this.buttons.tsbtnHuyBo = true
          break
      }
    },
    'listbox.dichvu_vt.value': async function(newval, oldval) {
      this.dsCTM_TBI = []
      this.lvMuaThietbi.list = []
      this.lvDvkhac.list = []
      this.dsDK_DVK_TB = []
      this.trangbi_id = 0
      this.cloaihinh_tb_async = await this.cloaihinh_tb
      if (!this.watcherActive) return
      if (!(newval != oldval && newval > 0)) return
      this.loading(true)
      try {
        if ([DichVuVienThong.MEGAWAN, DichVuVienThong.TSL, DichVuVienThong.NOIBO_2DIEM, DichVuVienThong.METRONET, DichVuVienThong.NOIBO_DADIEM, DichVuVienThong.MGW_DOITAC, DichVuVienThong.TSL_DOITAC].indexOf(parseInt(newval)) >= 0) {
          if (!this.kiemtra_dm_mgwan_tsl) {
            var daivt_id = this.listbox.donvi_ql.value
            await API.post_lay_danhmuc_lapmoi_mgw_tsl(this.axios, { vchuoi: 'LOAI_KENH|TOCDO_KENH|LOAI_CAP|THOIHAN|DOITAC|TINH_KN|LOAI_MD|TRAM_VT_DAU-donvi_id = ' + daivt_id + '|TRAM_VT_CUOI-donvi_id = ' + daivt_id }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.listbox.donvi_dau.list = response.data.data['tram_vt_dau']
                if (this.listbox.donvi_dau.list && this.listbox.donvi_dau.list.length > 0) this.listbox.donvi_dau.value = this.listbox.donvi_dau.list[0].donvi_id
                this.listbox.donvi_cuoi.list = response.data.data['tram_vt_cuoi']
                if (this.listbox.donvi_cuoi.list && this.listbox.donvi_cuoi.list.length > 0) this.listbox.donvi_cuoi.value = this.listbox.donvi_cuoi.list[0].donvi_id
                this.listbox.tinh_kn.list = response.data.data['tinh_kn']
                if (this.listbox.tinh_kn.list && this.listbox.tinh_kn.list.filter((x) => x.tinh_id > 0).length > 0) this.listbox.tinh_kn.value = this.listbox.tinh_kn.list.filter((x) => x.tinh_id > 0)[0].tinh_id
                try {
                  this.listbox.tinh_kn.value = this.$root.token.getPhanVungID()
                } catch (ex) {}
                this.listbox.loaikenh.list = response.data.data['loai_kenh']
                if (this.listbox.loaikenh.list && this.listbox.loaikenh.list.length > 0) {
                  this.listbox.loaikenh.value = this.listbox.loaikenh.list[0].loaikenh_id
                  this.listbox.loaikenh.valuetsl = this.listbox.loaikenh.list[0].loaikenh_id
                }
                this.listbox.tocdokenh.list = response.data.data['tocdo_kenh']
                if (this.listbox.tocdokenh.list && this.listbox.tocdokenh.list.length > 0) {
                  this.listbox.tocdokenh.value = this.listbox.tocdokenh.list[0].tocdo_id
                  this.listbox.tocdokenh.valuetsl = this.listbox.tocdokenh.list[0].tocdo_id
                }
                this.listbox.doitactsl.list = response.data.data['doitac']
                if (this.listbox.doitactsl.list && this.listbox.doitactsl.list.length > 0) this.listbox.doitactsl.value = this.listbox.doitactsl.list[0].doitac_id
                this.listbox.doitacwan.list = response.data.data['doitac']
                if (this.listbox.doitacwan.list && this.listbox.doitacwan.list.length > 0) this.listbox.doitacwan.value = this.listbox.doitacwan.list[0].doitac_id
                this.listbox.loaimodem.list = response.data.data['loai_md']
                if (this.listbox.loaimodem.list && this.listbox.loaimodem.list.length > 0) this.listbox.loaimodem.value = this.listbox.loaimodem.list[0].loaimd_id
                this.listbox.loaicap.list = response.data.data['loai_cap']
                if (this.listbox.loaicap.list && this.listbox.loaicap.list.length > 0) this.listbox.loaicap.value = this.listbox.loaicap.list[0].loaicap_id
              }
            })
            if (this.thamso_nguoidung.chuquanmd_id && this.thamso_nguoidung.chuquanmd_id > 0) {
              // Tham so nay khong lay duoc tu DB o thoi diem code do khong co du lieu (select * from admin.ct_tsmd where ma_ts='CHUQUAN_ID' and phanvung_id=26;)
              this.listbox.chu_quan.valuewan = this.thamso_nguoidung.chuquanmd_id
              this.listbox.chu_quan.valuetsl = this.thamso_nguoidung.chuquanmd_id
            }
            this.kiemtra_dm_mgwan_tsl = true

            //FORMLOAD default value
            if (this.listbox.phanloai_dv.list && this.listbox.phanloai_dv.list.filter((pl) => pl.loaitb_id == 134).length > 0) this.listbox.phanloai_dv.value = this.listbox.phanloai_dv.list.filter((pl) => pl.loaitb_id == 134)[0].phanloai_id
            if (this.listbox.loai_tb.list && this.listbox.loai_tb.list.filter((tb) => tb.dichvuvt_id == this.listbox.dichvu_vt.value).length > 0) this.listbox.loai_tb.valuemgwan = this.listbox.loai_tb.list.filter((tb) => tb.dichvuvt_id == this.listbox.dichvu_vt.value)[0].thietbidc_id
            this.loaisowan = 1
            this.buttons.btnHuongKNWan = this.loaisowan * 1 == LOAINODE_MGWAN.NODE_CHINH

            //if([DichVuVienThong.MEGAWAN, DichVuVienThong.METRONET, DichVuVienThong.MGW_DOITAC].indexOf(parseInt(newval))>=0)
          }
          //Default thuebao
          this.listbox.loaihinh_tb.value = LoaiHinhTB.MEGAWAN_ADSL // 23;
          this.listbox.kieu_ld.value = KieuLapDat.DM_MGW_DOCLAP // 42
          this.listbox.trangbi.valuewan = TRANGBI.VIENTHONG_TRANGBI //4
        }
        if (newval == DichVuVienThong.CO_DINH) {
          if (!this.kiemtra_dm_codinh) {
            this.kiemtra_dm_codinh = true
            if (this.thamso_nguoidung.chuquanmd_id && this.thamso_nguoidung.chuquanmd_id > 0) {
              this.listbox.chu_quan.valuecd = this.thamso_nguoidung.chuquanmd_id
              this.listbox.chu_quan.valuedlcd = this.thamso_nguoidung.chuquanmd_id
            }
          }
          //Default thuebao
          this.listbox.loaihinh_tb.value = LoaiHinhTB.DIENTHOAI_CD
          this.listbox.kieu_ld.value = KieuLapDat.DM_CODINH
        }
        if (newval == DichVuVienThong.IMS || newval == DichVuVienThong.IMS_DOITAC) {
          if (!this.kiemtra_dm_ims) {
            this.kiemtra_dm_ims = true
            if (this.thamso_nguoidung.chuquanmd_id && this.thamso_nguoidung.chuquanmd_id > 0) {
              this.listbox.chu_quan.valueims = this.thamso_nguoidung.chuquanmd_id
              this.listbox.chu_quan.valuedlims = this.thamso_nguoidung.chuquanmd_id
            }
          }
          //default thuebao
          this.listbox.loaihinh_tb.value = LoaiHinhTB.IMS_SIP //63
          this.listbox.kieu_ld.value = 224 //KieuLapDat.DM_CODINH;
        }
        if (newval == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          if (this.listbox.loai_tb.list && this.listbox.loai_tb.list.filter((tb) => tb.dichvuvt_id == this.listbox.dichvu_vt.value).length > 0) {
            this.listbox.loai_tb.valuedau = this.listbox.loai_tb.list.filter((tb) => tb.dichvuvt_id == this.listbox.dichvu_vt.value)[0].thietbidc_id
            this.listbox.loai_tb.valuecuoi = this.listbox.loai_tb.list.filter((tb) => tb.dichvuvt_id == this.listbox.dichvu_vt.value)[0].thietbidc_id
          }
          if (this.listbox.loaicap.list && this.listbox.loaicap.list.length > 0) {
            this.listbox.loaicap.valuedau = this.listbox.loaicap.list[0].loaicap_id
            this.listbox.loaicap.valuecuoi = this.listbox.loaicap.list[0].loaicap_id
          }
          //Default thuebao
          this.listbox.loaihinh_tb.value = 67
          this.listbox.kieu_ld.value = KieuLapDat.DM_TSL_LUONG // 48
        }
        if ([DichVuVienThong.ADSL, DichVuVienThong.MEGA_EYES, DichVuVienThong.HATANG_VIENTHONG, DichVuVienThong.BRCD_DOITAC].indexOf(parseInt(newval)) >= 0) {
          if (!this.kiemtra_dm_adsl) {
            this.kiemtra_dm_adsl = true
            await API.post_lay_danhmuc_lapmoi_internet(this.axios, { vchuoi: 'KIEUTRA|THANGTRA|MUCCUOC' }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.listbox.cboKieuTra.list = response.data.data['kieutra']
                if (this.listbox.cboKieuTra.list && this.listbox.cboKieuTra.list.length > 0) this.listbox.cboKieuTra.value = this.listbox.cboKieuTra.list[0].kieutra_id
                this.listbox.cboThangTra.list = response.data.data['thangtra']
                if (this.listbox.cboThangTra.list && this.listbox.cboThangTra.list.length > 0) this.listbox.cboThangTra.value = this.listbox.cboThangTra.list[0].thang_id
                this.listbox.muccuoc.list = response.data.data['muccuoc']
                if (this.listbox.muccuoc.list && this.listbox.muccuoc.list.length > 0) this.listbox.muccuoc.value = this.listbox.muccuoc.list[0].muccuoc_id
                if (this.thamso_nguoidung.chuquanmd_id && this.thamso_nguoidung.chuquanmd_id > 0) {
                  this.listbox.chu_quan.valueadsl = this.thamso_nguoidung.chuquanmd_id
                  this.listbox.chu_quan.valuedladsl = this.thamso_nguoidung.chuquanmd_id
                } else if (this.listbox.chu_quan.list && this.listbox.chu_quan.list.length > 0) {
                  this.listbox.chu_quan.valueadsl = this.listbox.chu_quan.list[0].chuquan_id
                  this.listbox.chu_quan.valuedladsl = this.listbox.chu_quan.list[0].chuquan_id
                }
              }
            })
          }
          //Default thuebao
          this.listbox.loaihinh_tb.value = LoaiHinhTB.INTERNET_FTTH // 58;
          this.listbox.kieu_ld.value = KieuLapDat.THUE_BAO_QUANG // 51
        }
        if (newval == DichVuVienThong.DI_DONG) {
          if (!this.kiemtra_dm_didong) {
            this.kiemtra_dm_didong = true
            this.listbox.chu_quan.valuedd = 11
          }
        }
        if (newval == DichVuVienThong.GPHONE) {
          if (!this.kiemtra_dm_gphone) {
            this.kiemtra_dm_gphone = true
            //this.listbox.chu_quan.valuegp = this.thamso_nguoidung.chuquanmd_id;
          }
        }
        switch (newval * 1) {
          case DichVuVienThong.ADSL:
          case DichVuVienThong.BRCD_DOITAC:
            this.tocdo_id = 0
            if (this.thuebao.adsl.ckTuCaiADSL) this.kh_cd = 1
            else this.kh_cd = 0
            if (this.listbox.cboLoaiTB.list && this.listbox.cboLoaiTB.list.length > 0) {
              if (this.listbox.cboLoaiTB.value && this.listbox.cboLoaiTB.value > 0) this.ltb_adsl_id = this.listbox.cboLoaiTB.value
              else this.ltb_adsl_id = 1
            } else this.ltb_adsl_id = 1
            this.trangbi_id = TRANGBI.VIENTHONG_TRANGBI
            this.listbox.trangbi.valueadsl = this.trangbi_id
            //if(this.listbox.loai)
            break
            case DichVuVienThong.IMS:
          case DichVuVienThong.IMS_DOITAC:
          case DichVuVienThong.CO_DINH: // Giong ÍMS nen gop
            this.tocdo_id = 0
            this.ltb_adsl_id = 1
            this.kh_cd = 0
            this.trangbi_id = TRANGBI.KHACHHANG_TU_TRANGBI //Khách hàng tự trang bị
            this.listbox.trangbi.valuecd = this.trangbi_id
            this.listbox.trangbi.valueims = this.trangbi_id
            break
          case DichVuVienThong.DI_DONG:
            {
              // int loaikh_id_neo = Convert.ToInt32(checkdata.MAP_ID("loaikh_id_neo", DatabaseConstants.DB2 + ".loai_kh", " where loaikh_id =" + cboLoaiKH.EditValue));
              // bangts.HT_DT_VinaPhone_Combobox(cboDTVinaPhone, loaikh_id_neo);
              //
              this.tocdo_id = 0
              this.ltb_adsl_id = 1
              this.kh_cd = 0
              this.trangbi_id = TRANGBI.KHACHHANG_TU_TRANGBI //Khách hàng tự trang bị
              this.listbox.trangbi.valuedd = TRANGBI.KHACHHANG_TU_TRANGBI
              //
            }
            break
          case DichVuVienThong.TSL:
          case DichVuVienThong.NOIBO_2DIEM:
            if (this.listbox.trangbi.list && this.listbox.trangbi.list.length > 0) this.listbox.trangbi.valuetsl = TRANGBI.VIENTHONG_TRANGBI

            if (this.listbox.tocdokenh.valuetsl && this.listbox.tocdokenh.valuetsl > 0) {
              this.tocdo_id = this.listbox.tocdokenh.valuetsl
              if (!this.kt_load) this.LayTienTheoKhoanMuc()
            } else this.tocdo_id = 0
            this.ltb_adsl_id = 1
            this.kh_cd = 0
            this.thuebao.cvlct = true
            break
          case DichVuVienThong.TSL_DOITAC:
            if (this.listbox.tocdokenh.valuetsl && this.listbox.tocdokenh.valuetsl > 0) {
              this.tocdo_id = this.listbox.tocdokenh.valuetsl
              if (!this.kt_load) this.LayTienTheoKhoanMuc()
            } else this.tocdo_id = 0
            this.ltb_adsl_id = 1
            this.kh_cd = 0
            this.thuebao.cvlct = false
            break
          case DichVuVienThong.MEGAWAN:
          case DichVuVienThong.METRONET:
          case DichVuVienThong.NOIBO_DADIEM:
            if (this.listbox.loai_tb.list && this.listbox.loai_tb.list.length > 0) {
              if (this.listbox.loai_tb.valuemgwan && this.listbox.loai_tb.valuemgwan > 0) this.ltb_adsl_id = this.listbox.loai_tb.valuemgwan
              else this.ltb_adsl_id = 1
            } else this.ltb_adsl_id = 1

            this.kh_cd = 0
            if (this.listbox.trangbi.list && this.listbox.trangbi.list.length > 0) {
              this.trangbi_id = TRANGBI.VIENTHONG_TRANGBI
              this.listbox.trangbi.valuewan = this.trangbi_id
            }

            if (this.listbox.tocdokenh.valuecir && this.listbox.tocdokenh.valuecir > 0) {
              this.tocdo_id = this.listbox.tocdokenh.valuecir
              if (!this.kt_load) this.LayTienTheoKhoanMuc()
            } else this.tocdo_id = 0

            this.thuebao.cvlct = true
            break
          case DichVuVienThong.MGW_DOITAC:
            if (this.listbox.loai_tb.list && this.listbox.loai_tb.list.length > 0) {
              if (this.listbox.loai_tb.valuemgwan && this.listbox.loai_tb.valuemgwan > 0) this.ltb_adsl_id = this.listbox.loai_tb.valuemgwan
              else this.ltb_adsl_id = 1
            } else this.ltb_adsl_id = 1

            this.kh_cd = 0

            if (this.listbox.tocdokenh.valuecir && this.listbox.tocdokenh.valuecir > 0) {
              this.tocdo_id = this.listbox.tocdokenh.valuecir
              if (!this.kt_load) this.LayTienTheoKhoanMuc()
            } else this.tocdo_id = 0

            this.thuebao.cvlct = false
            break
        }
        this.LAY_DS_TBI_MACDINH(this.listbox.loaihinh_tb.value)
        let vetinh_id = ''
        let ppdata = { DICHVUVT_ID: this.listbox.dichvu_vt.value, PHOLD_ID: this.diachiLD.PHO_ID, PHUONGLD_ID: this.diachiLD.PHUONG_ID, LOAIKH_ID: this.listbox.loai_kh.value }
        await API.post_sp_lay_tt_theo_dvvt(this.axios, { ds_para: JSON.stringify(ppdata) }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let apid = JSON.parse(response.data.data)

            if (apid['ERROR_CODE'] != 1) {
              this.$toast.error(apid['MESSAGE'])
              return
            }
            apid = apid['RESULT']
            if (!apid) return
            if (apid['VETINH_ID']) vetinh_id = apid['VETINH_ID']
            if (apid['DOITUONG_NEO'] && apid['DOITUONG_NEO'].length > 0) {
              this.thuebao.didong.cboDTVinaPhone.list = apid['DOITUONG_NEO']
            } else this.thuebao.didong.cboDTVinaPhone.list = []
          }
        })
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      } finally {
        await this.HT_GIAODIEN_DONVI()
        await this.HT_DS_KhuyenMai_Combobox()
        this.loading(false)
      }
    }
  },
  filters: {
    currency: function(value) {
      let valNum = parseInt((value + '').replaceAll(',', ''))
      if (valNum >= 0) return valNum.toLocaleString('en-En')
      return value
    }
  },
  data() {
    return {
      asyncLock: false,
      isLoadKH: false,
      popup: {
        popupToaNha: true,
        Thuebao_ToaNha: true,
        chonMegaWanIOTModal: true,
        frmNhapDSThanhVien: true,
        ThongTinUser: true,
        modalImportCA: true,
        dialogHDTB_SUB_V2: true,
        frmHDTB_SUB_V3: true,
        frmHDTB_SUB_V4: true,
        frmDangKyGoiDaDVLM: true,
        thongTinHenKhachHangModal: true,
        popupInBienBan: true
      },
      isShowThueBaoToaNha: false,
      popupQueue: [],
      popupQueueWhiteList: ['dlgTimKiemNVTC', 'popupComponents'],
      currentTab: 'tab1',
      cloaihinh_tb_async: [],
      Click_kieuld: false,
      kieu: 0,
      popupInBienBan_Param: {},
      tt_nd: {},
      debug: true,
      popupRetVal: null,
      IS_HD_TUVAN: false,
      watcherActive: false,
      mgw_mtn_ktr_hoa: false,
      LoaiHinhTB: LoaiHinhTB,
      KieuLapDat: KieuLapDat,
      DS_CHUQUAN_THEO_QUYEN: '',
      ItemList: [],
      ma_tb_ht: '',
      PhanLoai_ID: '0',
      ts_kt_tthdkhdn: 0,
      // Bo sung cua phan dat moi ban cheo
      thongso_ban: newThongSoThueBao(),
      thongso_tc: newThongSoThueBao(),
      dt_ban_cntt: [],
      dt_tc_cntt: [],
      tinh: {},
      // HET Bo sung cua phan dat moi ban cheo
      LOAINODE_MGWAN: LOAINODE_MGWAN,
      popupComponent: null,
      popupComponentData: null,
      popupComponentAttr: {},
      popupComponentEvts: {
        'form-close': this.popupClosed,
        acceptChangeCTV: this.popupClosed,
        acceptChangeNGT: this.popupClosed,
        PopUpCongTacVien_Thoat: this.popupClosed
      },
      popupComponentName: '',
      ctv_id: 0,
      ma_tb: '',
      ma_tb_ao_ht_cuoi: '',
      ma_tb_ao_ht: '',
      bc_ma_tb_ao_ht: '',
      bc_ma_tb_ht: '',
      hdkhtn_id: 0,
      Tag: '',
      iKieu: 0, //0: Lắp mới, 1: Sửa khuyến mại
      header: {
        title: 'Lắp đặt mới',
        list: [
          //{ name: 'Trang chủ', link: { name: 'Ui.cards' } },
          { name: 'Lập hợp đồng', link: { name: 'Ui.cards' } },
          { name: 'Lắp đặt mới', link: { name: 'Ui.cards' } }
        ]
      },
      // datatable: {
      //   dtPhanLoaiKH: [],
      // },
      thamsomacdinh: {},
      thamso_nguoidung: {
        chuquanmd_id: 0
      },
      DONGBO_TEST: { TEST: true },
      PHANTAP_KH: 0,
      DONVIQL_HTTT: 0,
      KHUVUC_THEO_KETCUOI: this.KHUVUC_THEO_KETCUOI,
      CHONSO_MOI: false,
      CHONSO_MOI_V2: false,
      kieuld_fsecure_kem_fiber: 0,
      hc_hdtb_id: 0,
      hc_tdtt_hdtb_id: 0,
      quytrinh_tc_tn: 0,
      huonggiao_tc_tn: 0,
      hdtb_id: 0,
      hdtt_id: 0, //TODO tim cach load hdtt_id
      ma_tb_ao: '',
      _sl_cha: 0,
      PHANLOAIKH_ID: -1,
      nhomplkh: 0,
      vkieukh_id_: 0, //biến toàn cục kiểm tra KH cá nhân hay doanh nghiệp
      nhap_tocdo_thuc_adsl: 0,
      ht_loc_cbo_tram: false,
      ht_khl: 0,
      loaisowan: 0,
      loaisoisdn: 1,
      kh_cd: 0,
      ltb_adsl_id: 1,
      kt_load: true,
      tocdo_id: 0,
      trangbi_id: 0,
      tocdo_cu_id: 0,
      tocdo_moi_id: 0,
      muccuoc_id: 0,
      kiemtra_dm_mgwan_tsl: false,
      kiemtra_dm_codinh: false,
      kiemtra_dm_ims: false,
      kiemtra_dm_adsl: false,
      kiemtra_dm_didong: false,
      kiemtra_dm_gphone: false,
      ht_loc_cbo_tram: false,
      frmthuebao: '',
      DichVuVienThong: DichVuVienThong,
      ThoiHan: ThoiHan,
      buttons: {
        tsbtnXoa: false,
        tsbtnGhiLai: false,
        tsbtnHuyBo: false,
        tsbtnThanhToan: false,
        inPhụLụcToolStripMenuItem: false,
        tsbtnXoaTB: false,
        tsbtnThemTB: false,
        tsbtnThemTT: false,
        tsbtnXoaTT: false,
        btnChonSM: true,
        chkLapDatBS: false,
        btnThongTinKhac: false,
        btnChonSoIMS: true,
        btnHuongKNWan: false,
        tsbtnNhapMoi: false
      },
      diachikh_id: 0,
      diachitt_id: 0,
      diachibc_id: 0,
      diachitb_id: 0,
      diachild_id: 0,
      diachiKH: {
        DIACHI_ID: null,
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiHK: {
        DIACHI_ID: null,
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiNDD: {
        DIACHI_ID: null,
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiTT: {
        DIACHI_ID: null,
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiCT: {
        DIACHI_ID: null,
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiBC: {
        DIACHI_ID: null,
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiTB: {
        DIACHI_ID: null,
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiTBCu: {
        DIACHI_ID: null,
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiHKTBCu: {
        DIACHI_ID: null,
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiLD: {
        DIACHI_ID: null,
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiKN: {
        DIACHI_ID: null,
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiDau: {
        DIACHI_ID: null,
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiCuoi: {
        DIACHI_ID: null,
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      cbvmp: 0,
      NgayYeuCau: moment(new Date()).format('DD/MM/YYYY HH:mm:ss'),
      NgayLapHD: moment(new Date()).format('DD/MM/YYYY HH:mm:ss'),
      NgayCap: null, //moment(new Date()).format("DD/MM/YYYY"),
      NgayHH: null, //moment(new Date()).format("DD/MM/YYYY"),
      NgaySinh: null, //moment(new Date()).format("DD/MM/YYYY"),
      NgayCapHK: null, //moment(new Date()).format("DD/MM/YYYY"),
      NgaySinhTB: null, //moment(new Date()).format("DD/MM/YYYY"),
      //NgayCV: moment(new Date()).format("DD/MM/YYYY"),
      TGThueTuNgay: null, //moment(new Date()).format(this.datetimeFormat),
      TGThueDenNgay: null, //moment(new Date()).format(this.datetimeFormat),
      kt_thuenganhan: false,
      dateFormat: 'DD/MM/YYYY',
      datetimeFormat: 'DD/MM/YYYY HH:mm',
      datetimeFormatFull: 'DD/MM/YYYY HH:mm:ss',
      iKenhTN: 1,
      _fiberBoSung: '',
      maduan: '',
      VPHIEUCSKH_ID: 0,
      IS_HD_TUVAN: false,
      dtienld: 0,
      dvatld: 0,
      dtiencd: 0,
      dvatcd: 0,
      vtyle_vat_id_dnhm: 0,
      vtyle_vat_dnhm: 0,
      nhanvien_ql_am_id: 0,
      m_dsThueBao_DichVu: [],
      vtyle_vat_cd: 10,
      vtyle_vat_id_cd: 1,
      listbox: {
        trangbi: { list: [], valuewan: TRANGBI.VIENTHONG_TRANGBI, valuetsl: 0, valuecd: 3, valueims: 0, valueadsl: 0, valuedd: 0, valuegp: 0 },
        loai_tb: { list: [], value: 0, valuedau: 0, valuecuoi: 0, valuemgwan: 0 },
        chu_quan: { list: [], value: 0, valuewan: 0, valueldmgwan: 0, valuetsl: 0, valuecd: 143, valueldcd: 9, valueims: 0, valueldims: 0, valueadsl: 0, valueldadsl: 0, valuedd: 0, valuegp: 0 },
        tien_km: { list: [], value: 0 },
        doituong: { list: [], value: '' },
        dichvu_vt: { list: [], value: DichVuVienThong.CO_DINH },
        loaihinh_tb: { list: [], value: LoaiHinhTB.DIENTHOAI_CD },
        loai_khl: { list: [], value: 0 },
        loai_gt: { list: [], value: 0 },
        phanloai_kh: { list: [], value: 0 },
        loai_kh: { list: [], value: null },
        nganhang: { list: [], value: 0, valuekh: 0, sotaikhoankh: '', sotaikhoan: '', ischecked: false, ischeckedkh: false, isnganhangnn: false },
        hinhthuc_tt: { list: [], value: 0 },
        hinhthuc_tc: { list: [], value: 0, valueims: 0 },
        dantoc: { list: [], value: 0 },
        nganhnghe: { list: [], value: 0 },
        nganhngheloc: { list: [], value: 0 },
        quoctich: { list: [], value: 0 },
        hinhthuc_tthi: { list: [], value: 0 },
        kieu_hd: { list: [], value: 0 },
        goi_kt: { list: [], value: 0 },
        donvi_ql: { list: [], value: 0, valueql: 0 },
        kieu_ld: { list: [], value: KieuLapDat.DM_CODINH },
        nhacc_cu: { list: [], value: 0, ischecked: false },
        congnghe: { list: [], value: 0 },
        hinhthuc_cm: { list: [], value: 0 },
        thoihan: { list: [], value: 0, valuetsl: 0, valuewan: 0, valuecd: 0, valueadsl: 0, valueims: 0 },
        loai_csht: { list: [], value: 0 },
        doitac: { list: [], valueims: 0, valuecsht: 0, valueinternet: 0, valuecd: 0, ischeckedcd: false, ischeckedadsl: false },
        cboLoaiIP: { list: [], value: 0, values: [], valueitems: [] },
        phanloai_dv: { list: [], value: 0, enabled: false },
        ht_chitietdv_ims: { list: [], value: 0 },
        ht_phantach_tocdo: { list: [], value: 0, enabled: false },
        trangthai_yc: { list: [], value: 0 },
        donvi_dau: { list: [], value: 0 },
        donvi_cuoi: { list: [], value: 0 },
        tinh_kn: { list: [], value: 0 },
        loaikenh: { list: [], value: 0, valuetsl: 0 },
        tocdokenh: { list: [], valuecir: 0, valuepir: 0, valuetsl: 0, valueisp: 0, valuenix: 0, ischeckedpir: false, ischeckedisp: false, ischeckednix: false },
        doitactsl: { list: [], value: 0, chkDoiTacTSL: false },
        doitacwan: { list: [], value: 0, isenabled: false },
        loaimodem: { list: [], value: 0 },
        loaicap: { list: [], value: 0, valuedau: 0, valuecuoi: 0 },
        muccuoc: { list: [], value: 0, isenabled: true },
        muccuoc_tb: { list: [], value: 0 },
        thanhtoan: { list: [], value: '' },
        thanhtoancbo: { list: [], value: '' },
        danhba: { list: [], value: 0 },
        dshopdong_chuaht: { list: [], header: [], value: 0 },
        madaidien: { list: [], value: null },
        cboLoaiTB: { list: [], value: 0 },
        cboGoiCuocAdsl: { list: [], value: 0 },
        cboTocDoThucADSL: { list: [], value: 0 },
        cboHDChinh: { list: [], value: 0 },
        cboDbChinh: { list: [], value: 0 },
        cboDoiTac_CSHT: { list: [], value: 0 },
        cboLoai_CSHT: { list: [], value: 0 },
        cboKieuTra: { list: [], value: 0 },
        cboThangTra: { list: [], value: 0 },
        cboTinh: { list: [], value: 0 },
        cboTinhCuoc: {
          value: 1,
          list: [
            { id: 1, text: 'Theo kênh' },
            { id: 2, text: 'Theo lưu lượng' }
          ]
        },
        cboQuocGia_POP: { list: [], value: 0 }
      },
      tieunganh: {
        dsTNC1: [],
        dsTNC2: [],
        dsTNC3: [],
        dsTNC4: [],
        TNC1_ID: 0,
        TNC2_ID: 0,
        TNC3_ID: 0,
        TNC4_ID: 0,
        TNCMOTA: ''
      },
      thanhToanId: 0, //la maTT khi chon 1 phan tu o bang thanh toan
      // searchDate: {
      //   isEnabled: false,
      //   fromDate: new Date(),
      //   toDate: new Date(),
      //   dateconfig: {
      //     altFormat: 'd/m/Y',
      //     altInput: true,
      //     dateFormat: 'd/m/Y',
      //     allowInput:true,
      //   },
      // },
      filterbox: {
        ctv: {
          value: '',
          ischecked: false,
          ma_ctv: ''
        },
        nguoigt: {
          value: '',
          ischecked: false,
          nguoigt_id: ''
        },
        khuyenmai: {
          list: [],
          value: '',
          ischecked: false
        },
        tratruoc: {
          list: [],
          value: '',
          ischecked: false
        }
      },
      dateconfig: {
        altFormat: 'd/m/Y',
        altInput: true,
        dateFormat: 'd/m/Y',
        allowInput: true
      },
      datetimeconfig: {
        altFormat: 'd/m/Y H:i:S',
        altInput: true,
        dateFormat: 'd/m/Y H:i:S',
        allowInput: true,
        enableTime: true
      },
      popupbox: {
        nvtc: 0
      },
      khachhang: {
        makh: '',
        sogt: '',
        magd: '',
        mahd: '',
        khachhang_id: 0,
        khachhangtc_id: 0,
        tenkh: '',
        nguoidd: '',
        dienthoai: '',
        fax: '',
        chucvu: '',
        noicaphk: '',
        noicap: '',
        gioitinh: -1,
        masothue: '',
        ghichu: '',
        dactrung: '',
        PHANLOAIKH_ID: -1,
        hdkh_id: 0,
        plkh: '',
        nhom_plkh: 0
      },
      thuebao: {
        //###thuebao
        codinh: {
          somay: '',
          sochinh: '',
          dgvTienCK: {
            list: [],
            headers: [
              { fieldName: 'tuthang', headerText: 'Từ tháng', allowFiltering: true },
              { fieldName: 'denthang', headerText: 'Đến tháng', allowFiltering: true },
              { fieldName: 'tien_ck', headerText: 'Tiền cam kết', allowFiltering: true, allowHtml: true }
            ]
          },
          arraySoMay: []
        },
        mgwan: {
          //somay: '',
          soao: '',
          matn: '',
          madoicap: '',
          huongkn: '',
          vhuongkn: '',
          vrfvfi: '',
          lanip: '',
          wanip: '',
          siteid: '',
          txtMaHD_TTKD_MGWAN: '',
          luonggiukenh: false,
          chkLuongGiuKenh: false,
          cuoctk: 0,
          cuoctk_dt: 0,
          cuoctc: 0,
          cuoctc_dt: 0,
          hopdong_dt: '',
          cuoctbi: 0,
          cuocht: 0,
          soluongip: 0,
          cuocip: 0,
          cuocisp: 0,
          cuocnix: 0,
          chkKenhTong: false,
          txtHuongUT: '',
          txtDiaChi_POP: '',
          cbkQuaTB_NET: false,
          chkCapNgoaiVNPT: false,
          chkNgayHT_MGWAN: false,
          dtpNgayHT_MGWAN: moment(new Date()).format('DD/MM/YYYY HH:mm:ss'),
          txtMaTBWan: {
            Text: '',
            ReadOnly: false
          }
        },
        adsl: {
          tientra: 0,
          btnKiemTraAccount_visible: true,
          txtAccountADSL: '',
          txtSoAoAdsl: '',
          txtMaTN_ADSL: '',
          txtMaDoiCap_ADSL: '',
          validadslacc: false,
          txtEmailAdsl: '',
          chkTocDoThuc: false,
          ckTuCaiADSL: false,
          dtpHanDatCho: moment(new Date()).format('DD/MM/YYYY HH:mm:ss'),
          dtpHanDatCho_Visible: true,
          txtDienThoai_Fsecure: '',
          txtSL_Tivi: 0,
          txtCuocDT_Internet: 0,
          txtSerialSTB: '',
          dtpNgayTra: null,
          txtTTCuoc: '',
          txtCSD_FIBER_TK: 0,
          txtCTB_FIBER_TK: 0,
          pass_adsl: '',
          txtAccountADSL_ReadOnly: false,
          kh_cd_fsecure: false,
          isHopDong: 1
        },
        tsl: {
          txtMaTSL: {
            ReadOnly: false,
            Text: ''
          },
          txtMaHD_TTKD_TSL: '',
          txtSoSoiQuang: 0,
          txtSoSoiQuang_Enabled: true,
          txtCuocTKDT_TSL: 0,
          txtCuocTCDT_TSL: 0,
          txtMaHD_DT_TSL: '',
          txtCuocHT_TSL: 0,
          txtCuocTBI_TSL: 0,
          txtCuocTC_TSL: 0,
          txtCuocTK_TSL: 0,
          diachidau_id: 0,
          diachicuoi_id: 0,
          txtSoAoTSL_Dau: '',
          txtSoAoTSL_Cuoi: '',
          txtVrf_Dau: '',
          txtVrf_Cuoi: '',
          txtSiteIDTSL_Dau: '',
          txtSiteIDTSL_Cuoi: '',
          tinh_dau: {},
          tinh_cuoi: {},
          cboTinhDau: {
            list: [],
            value: 0
          },
          cboTinhCuoi: {
            list: [],
            value: 0
          },
          cboChuQuanLD_Dau: {
            list: [],
            value: 0
          },
          cboChuQuanLD_Cuoi: {
            list: [],
            value: 0
          },
          thongso_tc_dau: {},
          thongso_tc_cuoi: {},
          quytrinh_tc_tn_dau: 0,
          huonggiao_tc_tn_dau: 0,
          quytrinh_tc_tn_cuoi: 0,
          huonggiao_tc_tn_cuoi: 0
        },
        gphone: {
          txtSoSimGphone: '',
          txtSoMayGP: '',
          checkVSVX: false,
          dgvTienCKGP: {
            list: [],
            headers: [
              { fieldName: 'tuthang', headerText: 'Từ tháng', allowFiltering: true },
              { fieldName: 'denthang', headerText: 'Đến tháng', allowFiltering: true },
              { fieldName: 'tien_ck', headerText: 'Tiền cam kết', allowFiltering: true, allowHtml: true }
            ]
          }
        },
        ims: {
          txtMaTBIMS: '',
          cbkTrunk: false,
          cboTrunk: { list: [], value: 0 },
          txtMaDoiCap_IMS: 0,
          chkDoiTac_IMS: false,
          txtCuocDT_IMS: 0,
          txtMaTN_IMS: '',
          txtCuocGoiDT: 0,
          txtIp_IMS: '',
          pass_ims: '',
          dgvTienCKIMS: {
            list: [],
            headers: [
              { fieldName: 'tuthang', headerText: 'Từ tháng', allowFiltering: true },
              { fieldName: 'denthang', headerText: 'Đến tháng', allowFiltering: true },
              { fieldName: 'tien_ck', headerText: 'Tiền cam kết', allowFiltering: true, allowHtml: true }
            ]
          }
        },
        didong: {
          cboGoiCuocDD: { list: [], value: 0 },
          cboDTVinaPhone: { list: [], value: 0 },
          txtSoMayDD: '',
          txtSimDD: '',
          txtTienDuTK: 0,
          txtSoMayNTK: '',
          dgrKhuyenMai: { list: [], value: {}, headers: [] },
          LOAI_TB_DD: '',
          txtEmailDD: '', //Thay co khai bao tren form nhung khong thay co code hien thi.
          txtTenTBDD_Cu: '',
          txtNgaySinhDD_Cu: '',
          txtSoGTDD_Cu: '',
          txtNgayCapGTDD_Cu: '',
          txtDiaChiDD_Cu: '',
          txtHoKhauDD_Cu: ''
        },
        thuebao_id: 0,
        tentb: '',
        ghichu: '',
        tbhd_pl: 0,
        thuebao_id_cha: 0,
        loaisochinh: 0,
        hdtb_id_cha: 0,
        thangck: 0,
        doituong_ct_id: 0,
        tgdungthu: 0,
        tinhkhac: 0,
        khuvuc: '',
        khuvuc_id: 0,
        check_tb_adsl: 0,
        statusVdc: false,
        cvlct: false,
        congvan: '',
        NgayCVChecked: false,
        NgayCV: moment(new Date()).format('DD/MM/YYYY HH:mm:ss'),
        crm: '',
        erp: '',
        vtn: ''
      },
      thanhtoan: {
        matt: '',
        tentt: '',
        thanhtoan_id: 0,
        masothue: '',
        sodienthoai: '',
        email: '',
        chutk: '',
        tuyenthu_id: 0,
        matuyen: '',
        manvtc: '',
        tuyenthu_httt: 0,
        nhanvientc_id: 0,
        ghichu: '',
        hdmig_id: 0,
        mig_id: 0,
        mainghep: '',
        matb_dd: 0,
        manvql: ''
      },
      ma_vnpt: -1,
      thuebaocd: {
        matn: '',
        sothang_thueso: 0,
        noidung_thueso: '',
        kieu_thueso: 0,
        madoicap: null,
        cuocdoitac: 0
      },
      nganhang: {
        TIEN_DM: 0,
        DV_QHNS: 0,
        MACHUONG: 0,
        MN_KT: 0,
        MA_NDKT: 0,
        MN_NSNN: 0
      },
      thietbi: {
        tien_tbi: 0,
        vat_tbi: 0,
        tien_kmtbi: 0,
        vat_kmtbi: 0,
        tien_tgtb_tragop: 0,
        vat_tgtb_tragop: 0,
        tien_tgtb_tratruoc: 0,
        vat_tgtb_tratruoc: 0,
        dtien_kmtb: 0,
        dvat_kmtb: 0,
        dtientbi: 0,
        dvattbi: 0
      },
      //BANCHEO
      pass_ims: '',
      dsHDBCCD: [],
      dsHDBC_ADSL: [],
      dsHDBCMGWAN: [],
      dsHDBCIMS: [],
      dsDiaChi_BanCheo: [],
      dsDK_DVGT_BC: [],
      dsHDTB_Kieu_NT: [],
      //HET BANCHEO
      dsHDTB: [],
      dsHDTBGOI: [],
      dsDvKhacChose: [],
      dsDvMaster: [],
      dsDichVuKhac: [],
      dsDiaChi: [],
      dsDiaChiHDKH: [],
      dsDiaChiHDTT: [],
      dsDiaChiHDTB: [],
      dsDK_DVGT: [],
      dsTien_DatCoc: [],
      dsDK_DVKHAC: [],
      dsDK_DVK_TB: [],
      dsDK_DVK_TT: [],
      dsCTM_TBI: [],
      dsKM_HDTB: [],
      dsDC_HDTB: [],
      dsKM_Neo: [],
      DS_CTKM_LTBI: [],
      dsHDTB_CD: [],
      dsHDTBDV: [],
      dsCAMKET_HDTB: [],
      dsHDTBDV_Fsecure: [],
      dgrKhuyenMai: [],
      //dgvTienCK: [],
      dtControl: [],
      dsHDBANCHEO: [],
      dsHDTB_KV: [],
      dsHDBC_TSL: [],
      // dsHDTB_KV_tmp: [],
      dsHDTB_KV_ThemTB: [],
      dsHDKH_Sub: [],
      dsHDKH: [],
      dsHDTT: [],
      dsCTTHD: [],
      dsHDTT_NV: [],
      dsHDTB_DUNGTHU: [],
      dsTRAGOP_TBI_HDTB: [],
      ds_tien_khoanmuc: [],
      ds_tien_khoanmuc_bd: [],
      dsHDTB_DD: [],
      dsHDTB_INT: [],
      dsHDTB_ADSL: [],
      dsHDTB_MEWAN: [],
      dsHDTB_TSL: [],
      dsHDTB_GP: [],
      dsTTTT: [],
      dsTien_HDTB: [],
      dsHDTB_IMS: [],
      dsHDTB_CNTT: [],
      dsHDBC_CNTT: [],
      dsHDTB_SUB: [],
      dsHDTB_CT: [],
      dsHDTB_LoaiIp: [],
      nganhnghe_id: 0,
      lvwThueBao: [],
      lvwThanhToan: [],
      lvDvkhac: { list: [], value: 0 },
      lvDvkhac_TT: { list: [], value: 0 },
      lvDvgt: { list: [], value: null },
      lvMuaThietbi: { list: [], value: null },
      gridEditors: [],
      DT_CONTROLS: {
        dichvu_vt: 0,
        list: [],
        data: [],
        value: [],
        tagvalue: [],
        key: 0
      },
      kmld: {
        tien_kmld: 0,
        vat_kmld: 0,
        tien_datcoc: 0,
        dtienkmld: 0,
        dvatkmld: 0,
        tong_kmld: 0,
        tyle_kmld: 0,
        dtienkmdc: 0,
        dvatkmdc: 0,
        tyle_kmld_tt: 0,
        dtiendatcoc_tt: 0,
        dvatdatcoc_tt: 0,
        tong_kmld_tt: 0,
        tien_kmld_tt: 0,
        vat_kmld_tt: 0,

        dtiendatcoc_km: 0,
        dvatdatcoc_km: 0
      },
      dvgt: {
        tien_dv: 0,
        vat_dv: 0,
        tien_km_dvgt: 0,
        vat_km_dvgt: 0
      },
      dichvu: {
        dtien_dv: 0,
        dvat_dv: 0
      },
      tongtienhd: 0,
      tongtienkm: 0,
      tongvatkm: 0,
      STATUS_VDC: null,
      buttonSet: null,
      hdkh_cha_id: 0,
      chkMienCuocTB: false,
      chkVSVX: false,
      ts_sinhma_gd_theo_donvi: false,
      TUDONG_SINH_SOAO: false, //false,
      TD_GANTHEM_HDTB_DV: false,
      bDuLieuKS: false, // chi bang true khi lay du lieu tu btnLayDulieuKS_Click
      phieucskhdv_id: 0,
      loi_sinh_magd: false,
      KetCuoi_ID: -1,
      loainv_ctv_hrm: 0,
      loainv_ngt_hrm: 0,
      ts_kt_ltb_hrm: false,
      huonggiao_tn: 0,
      quytrinh_tn: 0,
      luong_id: 0,
      words: '',
      vkieuhd_id: 0,
      kiemtra_chuquan_kh: false,
      vkenh_toantrinh: 0,
    }
  },
  methods: {
    ShowSearchAccount() {
      this.popupComponentAttr = { vISKHDN:this.$root.token.getPhanVungID()==97 };
      this.popupComponent = () => import('@/modules/search/subscriber/SearchAccount')
      this.popupComponentName = 'SearchAccount'
      this.Popup('popupComponents')
    },
    ShowContractOwner() {
      try {
        // this.popupComponent.data.isPopup = true;
        this.popupComponentAttr = { hdkh_id: this.khachhang.hdkh_id, khachhang_id: this.khachhang.khachhang_id, ten_kh: this.khachhang.tenkh, diachi: this.diachiKH.DIACHI, txtTenLH: this.khachhang.tenkh, txtDiaChiLH: this.diachiKH.DIACHI }
        this.popupComponent = () => import('@/modules/contract/setup/ChangeContractOwner/popup/ThongTinLienHe')
        this.popupComponentName = 'popupThongTinLienHe'
        this.Popup('popupComponents')
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }

      //this.Popup('popupThongTinLienHe');
    },
    // searchAccountClosed(val){
    //   this.khachhang.makh = val;
    //   this.ClosePopup('popupComponents');
    //   if(this.khachhang.makh && this.khachhang.makh.trim()!="") this.MaKHChanged();
    // },
    LoadMucCuocTB() {
      //if(!this.diachiLD.DIACHI) return;

      var vtocdo_id = 0
      var vmuccuoc_id = 0 //2 Lưu lượng

      if (
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_MESH ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_SGTV ||
        this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES ||
        this.listbox.dichvu_vt.value == DichVuVienThong.HATANG_VIENTHONG ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_ANALOG ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL ||
        this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC
      ) {
        vtocdo_id = this.listbox.cboGoiCuocAdsl.value
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER || this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_MESH || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL) vmuccuoc_id = this.listbox.muccuoc.value
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT || this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT || this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU || this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH) {
        if (this.ItemList.length <= 0) {
          vtocdo_id = -2
          vmuccuoc_id = -2
        } else {
          for (var index1 = 0; index1 < this.ItemList.length; ++index1) {
            if (this.ItemList[index1].sFieldName == 'TOCDO_ID') {
              if (this.ItemList[index1].sValue) {
                vtocdo_id = this.ItemList[index1].sValue * 1
                break
              }
            }
          }
        }
      }
      this.listbox.muccuoc_tb.list = []
      var pdata = {
        tinhthicong_id: this.tinh.tinhthicong_id,
        apld_id: this.diachiLD.AP_ID ? this.diachiLD.AP_ID : 0,
        doituong_id: this.listbox.doituong.value ? this.listbox.doituong.value : this.listbox.doituong.list && this.listbox.doituong.list[0] && this.listbox.doituong.list[0].doituong_id ? this.listbox.doituong.list[0].doituong_id : 0,
        khuld_id: this.diachiLD.KHU_ID ? this.diachiLD.KHU_ID : 0,
        loaitb_id: this.listbox.loaihinh_tb.value,
        muccuoc_id: vmuccuoc_id,
        ngay: this.NgayYeuCau && this.NgayYeuCau.length > 10 ? this.NgayYeuCau.substring(0, 10) : this.NgayYeuCau,
        phold_id: this.diachiLD.PHO_ID ? this.diachiLD.PHO_ID : 0,
        phuongld_id: this.diachiLD.PHUONG_ID ? this.diachiLD.PHUONG_ID : 0,
        tocdo_id: vtocdo_id,
        trangbi_id: this.trangbi_id //this.listbox.trangbi.valuecd //default=3 //BUG cho nay can lay dong theo dichvu_vt????
      }
      API.post_lay_ds_mucuoc_tb_v2(this.axios, pdata).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.muccuoc_tb.list = response.data.data
          if (this.listbox.muccuoc_tb.list && this.listbox.muccuoc_tb.list.length > 0 && (!this.listbox.muccuoc_tb.value || this.listbox.muccuoc_tb.list.filter((x) => x.muccuoctb_id == this.listbox.muccuoc_tb.value).length <= 0))
            this.listbox.muccuoc_tb.value = this.listbox.muccuoc_tb.list[0].muccuoctb_id
        }
      })
    },
    ShowPopupCTV() {
      if (this.filterbox.ctv.ischecked) {
        this.popupComponent = () => import('@/modules/contract/setup/ChangeContractOwner/popup/CongTacVien')
        this.popupComponentName = 'popupCTV'
        // SearchAccount.data.isPopup = true;
        this.Popup('popupComponents')
      }
    },
    ShowPopupNguoiGT() {
      if (this.filterbox.nguoigt.ischecked) {
        this.popupComponent = () => import('@/modules/contract/setup/ChangeContractOwner/popup/NguoiGioiThieu')
        this.popupComponentName = 'popupNGT'
        // SearchAccount.data.isPopup = true;
        this.Popup('popupComponents')
      }
    },
    ShowPopupDVQL() {
      this.popupComponent = () => import('../InstallNewSubs/Popups/popupDonViQL')
      this.popupComponentName = 'popupDonViQL'
      // SearchAccount.data.isPopup = true;
      this.Popup('popupComponents')
    },
    ShowPopupChonSM() {
      // goi frmDSThueSo
      // this.popupComponent = ()=>import('../InstallNewSubs/Popups/popupChonSM');
      // this.popupComponentName = "popupChonSM";
      // this.Popup('popupComponents');
      try {
        if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) {
          //Cai nay mac dinh code cu = 0, neu co gia tri moi lay gia tri
          if (!this.thamsomacdinh['TS_CHONSO_CD_TINHKHAC'] || this.thamsomacdinh['TS_CHONSO_CD_TINHKHAC'] == 0) {
            if (this.diachiLD.QUAN_ID == 0 || this.diachiLD.PHUONG_ID == 0) {
              this.$toast.error('Bạn chưa chọn địa chỉ lắp đặt !')
              // txtDiaChiLD.Focus();
              return
            }
            //TODO test lai cho nay!!!
            // this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonSM')
            this.popupComponent = () => import('./Popups/popupChonSM')
            this.popupComponentName = 'popupChonSMPhuongBC'
            this.popupComponentData = {
              _tinh_id: this.tinh.tinhthicong_id,
              _quan_id: this.diachiLD.QUAN_ID,
              _phuong_id: this.diachiLD.PHUONG_ID,
              _loaiso_id: LOAISO.THUONG,
              _thueso: false,
              _mavung: this.tinh.mavung,
              loaitb_id: this.listbox.loaihinh_tb.value,
              dichvuvt_id: this.listbox.dichvu_vt.value,
              hdkh_id: this.khachhang.hdkh_id,
              donvi_ql_id: this.tinh.tinhthicong_id == 0 ? this.listbox.donvi_ql.value : 0 //ql (lay field don vi lap dat.)
            }
            this.Popup('popupComponents')
            // frmChonSMPhuongBC f = new frmChonSMPhuongBC(tinh, quanld_id, phuongld_id, LOAISO.THUONG, false);
            // f.loaitb_id = Convert.ToInt32(cboLoaihinhTB.SelectedValue);
            // f.dichvuvt_id = Convert.ToInt32(cboDichVuVT.SelectedValue);
            // f.hdkh_id = hdkh_id;
            // //f.donvi_ql_id = Convert.ToInt32(cboDaiVT.SelectedValue);
            // f.donvi_ql_id = 0;
            // f.ShowDialog();
            // if (f.chapnhan)
            // {
            //     arraySoMay = f.arraySoMay;
            //     txtSoMayCD.Text = f.ma_tb;
            //     cboLoaiSo.SelectedValue = Convert.ToInt32(f.loaiso_id);
            //     // DataTable dt = bangts.Lay_danhsach_tiencamket(f.nhomso_id).Tables[0];
            //     string str = "";
            //     str += " select b.tuthang, b.denthang, b.tien_ck";
            //     str += " from {?DB2}.nhom_so a, {?DB2}.nhomso_ck b";
            //     str += " where a.nhomso_id = b.nhomso_id";
            //     str += " and a.nhomso_id = " + f.nhomso_id;
            //     DataTable dt = bancheo.GET_DATA_SQL(tinh, str);
            //     dgvTienCK.AutoGenerateColumns = false;
            //     dgvTienCK.DataSource = dt;

            //     //Lấy tiền số đẹp vào dataset tiền khoản mục
            //     decimal vtien_sodep = f.tien_sodep;
            //     for (int i = 0; i < ds_tien_khoanmuc.Tables[0].Rows.Count; i++)
            //     {
            //         if (Convert.ToInt32(ds_tien_khoanmuc.Tables[0].Rows[i]["khoanmuctt_id"].ToString()) == 23)
            //         {
            //             ds_tien_khoanmuc.Tables[0].Rows[i]["tien"] = vtien_sodep;
            //             ds_tien_khoanmuc.Tables[0].Rows[i]["vat"] = this.round(vtien_sodep * Convert.ToDecimal(0.1));
            //             LayTongTien_HDTB();

            //             break;
            //         }
            //     }
            // }
          } else {
            this.$bvModal.show('frmChonSoMay_TinhKhac')
            // if (f.chapnhan)
            //     txtSoMayCD.Text = f.ma_tb;
            // else
            //     txtSoMayCD.Text = "";
          }
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }

      // try
      // {
      //   if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH)
      //   {
      //       if (this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_DC || this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_TL)
      //       {
      //           if (this.khachhang.khachhang_id > 0)
      //           {
      //             this.popupComponent = ()=>import('../InstallNewSubs/Popups/popupNumberRent');
      //             this.popupComponentName = "popupDSThueSo";
      //             this.popupComponentData = {
      //               vkhachhang_id: this.khachhang.khachhang_id,
      //               vma_tb: this.thuebao.codinh.somay,
      //               vkieuld_id: this.listbox.kieu_ld.value,
      //             }
      //             this.Popup('popupComponents');

      //           }
      //       }
      //       else if (this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_MOI)
      //       {
      //         this.popupComponent = ()=>import('../InstallNewSubs/Popups/popupChonSM');
      //         this.popupComponentName = "popupChonSMThue";
      //         this.popupComponentData = {
      //           _quan_id: this.diachiLD.QUAN_ID,
      //           _phuong_id: this.diachiLD.PHUONG_ID,
      //           _loaiso_id: LOAISO.THUONG,
      //           _thueso: true,
      //           loaitb_id: this.listbox.loaihinh_tb.value,
      //           dichvuvt_id: this.listbox.dichvu_vt.value,
      //           hdkh_id: this.khachhang.hdkh_id,
      //           donvi_ql_id: this.listbox.donvi_ql.value//ql (lay field don vi lap dat.)
      //         }
      //         this.Popup('popupComponents');
      //       }
      //       else if (this.listbox.kieu_ld.value == KieuLapDat.DM_TINH_KHAC)
      //       {
      //         this.$bvModal.show('frmChonSoMay_TinhKhac');
      //       }
      //       else
      //       {
      //           if (!this.diachiLD.QUAN_ID || this.diachiLD.QUAN_ID == 0 || !this.diachiLD.PHUONG_ID || this.diachiLD.PHUONG_ID == 0)
      //           {
      //               this.$toast.error("Bạn chưa chọn địa chỉ lắp đặt !");
      //               // txtDiaChiLD.Focus(); //FIXME focus vao o diachiLD
      //               return;
      //           }

      //           if (this.CHONSO_MOI)
      //           {
      //               if (this.CHONSO_MOI_V2)
      //               {
      //                 this.popupComponent = ()=>import('../InstallNewSubs/Popups/popupChonSMTheoHost');
      //                 this.popupComponentName = "popupChonSMTheoHost";
      //                 this.popupComponentData = {
      //                   _quan_id: this.diachiLD.QUAN_ID,
      //                   _phuong_id: this.diachiLD.PHUONG_ID,
      //                   _pho_id: this.diachiLD.PHO_ID,
      //                   _ap_id: this.diachiLD.AP_ID,
      //                   _khu_id: this.diachiLD.KHU_ID,
      //                   _loaiso_id: LOAISO.THUONG,
      //                   _thueso: false,
      //                   loaitb_id: this.listbox.loaihinh_tb.value,
      //                   dichvuvt_id: this.listbox.dichvu_vt.value,
      //                   hdkh_id: this.khachhang.hdkh_id,
      //                   donvi_ql_id: this.listbox.donvi_ql.value//ql (lay field don vi lap dat.)
      //                 }
      //                 this.Popup('popupComponents');
      //               }
      //               else
      //               {
      //                 this.popupComponent = ()=>import('../InstallNewSubs/Popups/popupChonSMNew');
      //                 this.popupComponentName = "popupChonSMNew";
      //                 this.popupComponentData = {
      //                   _quan_id: this.diachiLD.QUAN_ID,
      //                   _phuong_id: this.diachiLD.PHUONG_ID,
      //                   _loaiso_id: LOAISO.THUONG,
      //                   loaitb_id: this.listbox.loaihinh_tb.value,
      //                   dichvuvt_id: this.listbox.dichvu_vt.value,
      //                   hdkh_id: this.khachhang.hdkh_id,
      //                   donvi_ql_id: this.listbox.donvi_ql.value//ql (lay field don vi lap dat.)
      //                 }
      //                 this.Popup('popupComponents');
      //               }
      //           }
      //           else
      //           {
      //             //CASE MAC DINH TEST THEM MOI CO DINH
      //             this.popupComponent = ()=>import('../InstallNewSubs/Popups/popupChonSM');
      //             this.popupComponentName = "popupChonSM";
      //             this.popupComponentData = {
      //               _quan_id: this.diachiLD.QUAN_ID,
      //               _phuong_id: this.diachiLD.PHUONG_ID,
      //               _loaiso_id: LOAISO.THUONG,
      //               _thueso: false,
      //               loaitb_id: this.listbox.loaihinh_tb.value,
      //               dichvuvt_id: this.listbox.dichvu_vt.value,
      //               hdkh_id: this.khachhang.hdkh_id,
      //               donvi_ql_id: this.listbox.donvi_ql.value//ql (lay field don vi lap dat.)
      //             }
      //             this.Popup('popupComponents');
      //           }
      //       }
      //   }
      // }
      // catch (ex)
      // {
      //     this.$toast.error("" + ex); if(this.debug) console.error(ex);
      // }
    },
    btnSoAoWan_Click() {
      if (!this.diachiLD.QUAN_ID || this.diachiLD.QUAN_ID == 0 || !this.diachiLD.PHUONG_ID || this.diachiLD.PHUONG_ID == 0) {
        this.$toast.error('Bạn chưa chọn địa chỉ lắp đặt !')
        return
      }
      this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonSM')
      this.popupComponentName = 'popupChonSoAoMGWAN'
      this.popupComponentData = {
        _quan_id: this.diachiLD.QUAN_ID,
        _phuong_id: this.diachiLD.PHUONG_ID,
        _loaiso_id: LOAISO.AO,
        _thueso: false,
        loaitb_id: this.listbox.loaihinh_tb.value,
        dichvuvt_id: this.listbox.dichvu_vt.value,
        hdkh_id: this.khachhang.hdkh_id,
        donvi_ql_id: this.listbox.donvi_ql.value //ql (lay field don vi lap dat.)
      }
      this.Popup('popupComponents')
    },
    ShowPopupChonMaTT() {
      this.popupComponentData = this.khachhang.khachhang_id
      this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonMaTT')
      this.popupComponentName = 'popupChonMaTT'
      this.Popup('popupComponents')
    },
    ShowPopupKhuyenMai(loaikm = Loai_KM.KhuyenMai) {
      var dulieu = {}
      dulieu.loai = loaikm
      dulieu.dt = loaikm == Loai_KM.KhuyenMai ? filterbox.khuyenmai.list : filterbox.tratruoc.list
      this.popupComponentData = dulieu
      this.popupComponent = () => import('../InstallNewSubs/Popups/popup-Dangkychitietkhuyenmai')
      this.popupComponentName = 'popup-Dangkychitietkhuyenmai'
      this.Popup('popupComponents')
    },
    ShowPopupChonKhuyenMai(loaikm = Loai_KM.KhuyenMai) {
      var dulieu = {}
      dulieu.loai = loaikm
      dulieu.dt = loaikm == Loai_KM.KhuyenMai ? this.filterbox.khuyenmai.list : this.filterbox.tratruoc.list
      this.popupComponentData = dulieu
      this.popupComponent = () => import('../InstallNewSubs/Popups/popup-ChonKhuyenMai')
      this.popupComponentName = 'popup-ChonKhuyenMai'
      this.Popup('popupComponents')
    },
    async popupMaTNMGWAN() {
      var dulieu = {}
      var kieu = await API.post_fn_tt_kieu_ld(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, param: this.thongso_tc.kieuld_id })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return 0
        })
        .catch(() => {
          return 0
        }) //this.kieu_ld_kieu;
      switch (kieu * 1) {
        case 2:
          if (this.khachhang.khachhang_id && this.khachhang.khachhang_id > 0) {
            dulieu.khachhang_id = this.khachhang.khachhang_id
            dulieu.kieuld_id = this.listbox.kieu_ld.value
            dulieu.loaitb_id = this.listbox.loaihinh_tb.value
            dulieu.dichvuvt_id = this.listbox.dichvu_vt.value
            this.popupComponentData = dulieu
            this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBCungDoiCap')
            this.popupComponentName = 'popupDSTBCungDoiCapMGWAN' //"popupDSTBCungDoiCapMGWAN";
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp trên đường có sẵn !')
            return
          }
          break
        case 1:
          if (this.khachhang.hdkh_id && this.khachhang.hdkh_id > 0) {
            dulieu.hdkh_id = this.khachhang.hdkh_id
            dulieu.vkhachhang_id = this.khachhang.khachhang_id
            dulieu.vkieuld_id = this.listbox.kieu_ld.value
            // dulieu.loaitb_id = this.listbox.loaihinh_tb.value;
            this.popupComponentData = dulieu
            this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBLapKem')
            this.popupComponentName = 'popupDSTBLapKemMGWAN'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp kèm !')
            return
          }
          break
        case 4:
          dulieu.loaitb_id = this.listbox.loaihinh_tb.value
          dulieu.kieuld_id = this.listbox.kieu_ld.value
          this.popupComponentData = dulieu
          this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBCungDoiCap_KH_Khac')
          this.popupComponentName = 'popupDSTBCungDoiCap_KH_KhacMGWAN'
          break
      }
      this.Popup('popupComponents')
    },
    async popupMaTNADSL() {
      var dulieu = {}
      var kieu = await API.post_fn_tt_kieu_ld(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, param: this.thongso_tc.kieuld_id })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return 0
        })
        .catch(() => {
          return 0
        }) //this.kieu_ld_kieu;
      switch (kieu * 1) {
        case 2: //Lắp mới trên đường có sẵn
          if (this.khachhang.khachhang_id && this.khachhang.khachhang_id > 0) {
            dulieu.khachhang_id = this.khachhang.khachhang_id
            dulieu.kieuld_id = this.listbox.kieu_ld.value
            dulieu.loaitb_id = this.listbox.loaihinh_tb.value
            dulieu.dichvuvt_id = this.listbox.dichvu_vt.value
            this.popupComponentData = dulieu
            this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBCungDoiCap')
            this.popupComponentName = 'popupDSTBCungDoiCapADSL'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp trên đường có sẵn !')
            return
          }
          break
        case 1: //Lắp kèm
        case 3: //Lắp kèm thuê bao quang đang chuyển đổi
          if (this.khachhang.hdkh_id && this.khachhang.hdkh_id > 0) {
            dulieu.hdkh_id = this.khachhang.hdkh_id
            if (kieu * 1 == 3) dulieu.vkhachhang_id = this.khachhang.khachhang_id
            dulieu.vkieuld_id = this.listbox.kieu_ld.value
            dulieu.loaitb_id = this.listbox.loaihinh_tb.value
            dulieu.kieu = kieu
            this.popupComponentData = dulieu
            this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBLapKem')
            this.popupComponentName = 'popupDSTBLapKemADSL'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp kèm !')
            return
          }
          break
        case 4: // Lắp trên đường có sẵn của khách hàng khác
          dulieu.loaitb_id = this.listbox.loaihinh_tb.value
          dulieu.kieuld_id = this.listbox.kieu_ld.value
          this.popupComponentData = dulieu
          this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBCungDoiCap_KH_Khac')
          this.popupComponentName = 'popupDSTBCungDoiCap_KH_KhacADSL'
          break
      }
      this.Popup('popupComponents')
    },
    async popupMaTN() {
      var dulieu = {}
      var kieu = await API.post_fn_tt_kieu_ld(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, param: this.thongso_tc.kieuld_id })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return 0
        })
        .catch(() => {
          return 0
        }) //this.kieu_ld_kieu;
      switch (kieu * 1) {
        case 2:
          if (this.khachhang.khachhang_id && this.khachhang.khachhang_id > 0) {
            dulieu.khachhang_id = this.khachhang.khachhang_id
            dulieu.kieuld_id = this.listbox.kieu_ld.value
            dulieu.loaitb_id = this.listbox.loaihinh_tb.value
            dulieu.dichvuvt_id = this.listbox.dichvu_vt.value
            this.popupComponentData = dulieu
            this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBCungDoiCap')
            this.popupComponentName = 'popupDSTBCungDoiCap'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp trên đường có sẵn !')
            return
          }
          break
        case 1:
          if (this.khachhang.hdkh_id && this.khachhang.hdkh_id > 0) {
            dulieu.hdkh_id = this.khachhang.hdkh_id
            dulieu.vkhachhang_id = this.khachhang.khachhang_id
            dulieu.vkieuld_id = this.listbox.kieu_ld.value
            // dulieu.loaitb_id = this.listbox.loaihinh_tb.value;
            this.popupComponentData = dulieu
            this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBLapKem')
            this.popupComponentName = 'popupDSTBLapKem'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp kèm !')
            return
          }
          break
        case 4:
          dulieu.loaitb_id = this.listbox.loaihinh_tb.value
          dulieu.kieuld_id = this.listbox.kieu_ld.value
          this.popupComponentData = dulieu
          this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBCungDoiCap_KH_Khac')
          this.popupComponentName = 'popupDSTBCungDoiCap_KH_Khac'
          break
      }
      this.Popup('popupComponents')
    },
    Popup(modalId) {
      this.loading(false)
      if (this.$refs[modalId]) this.$refs[modalId].show()
      else this.$bvModal.show(modalId)
    },
    ClosePopup(modalId) {
      this.$bvModal.hide(modalId)
      this.popupComponent = null
    },
    async popupClosed(val) {
      if (!val) {
        this.popupRetVal = {}
        this.ClosePopup('popupComponents')
        return
      }
      this.loading(true)
      try {
        switch (this.popupComponentName) {
          case 'SearchAccount':
            if (val.ma_kh) this.khachhang.makh = val.ma_kh
            if (val.ma_tt) this.thanhtoan.matt = val.ma_tt
            if (this.khachhang.makh && this.khachhang.makh.trim() != '') this.MaKHChanged()
            break
          case 'popupInforAdd':
            //this.dsHDTB_SUB = val && val.length>0?[JSON.parse(val)]:[];
            this.dsHDKH_Sub = val && val.length > 0 ? [JSON.parse(val)] : [] // nham du lieu
            this.kiemtra_chuquan_kh = (this.dsHDKH_Sub && this.dsHDKH_Sub[0] && this.dsHDKH_Sub[0]['CHUQUAN_ID']>0);
            this.TAO_DULIEU_HDKH_SUB(this.LowerCasePropertyList(this.dsHDKH_Sub), this.dsHDKH_Sub[0]['HDKH_ID'])
            break
          case 'popupChonMaTT':
            if (val.ma_tt) this.thanhtoan.matt = val.ma_tt
            break
          case 'popupChonSoAoMGWAN':
            this.thuebao.mgwan.soao = val.somay
            break
          case 'popupChonSM': // Case chon so may them moi CO_DINH
          case 'popupChonSMNew':
          case 'popupChonSMTheoHost': // Chuyen len vi bao trung code
            if (!val.somay) return
            this.thuebao.codinh.somay = val.somay
            this.thuebao.codinh.arraySoMay = val.arraySoMay ? val.arraySoMay : []
            this.loaisoisdn = val.loaiso
            this.thuebao.codinh.dgvTienCK.list = [];
            API.post_sp_lay_danhsach_tiencamket(this.axios, { nhomso_id: val.nhomso }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.thuebao.codinh.dgvTienCK.list = response.data.data
              }
            })
            var vtien_sodep = val.tiensodep ? val.tiensodep : 0
            for (var item of this.ds_tien_khoanmuc)
              if (item['khoanmuctt_id'] == 23) {
                item['tien'] = vtien_sodep * 1
                item['vat'] = vtien_sodep * 0.1
                this.LayTongTien_HDTB()
                break
              }
            break
          case 'popupChonSMPhuongBC':
            if (!val.somay) return
            this.thuebao.codinh.somay = val.somay
            this.thuebao.codinh.arraySoMay = val.arraySoMay ? val.arraySoMay : []
            this.loaisoisdn = val.loaiso
            this.thuebao.codinh.dgvTienCK.list = [];
            API.post_get_thang_tien_ck(this.axios, { nhomso_id: val.nhomso }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.thuebao.codinh.dgvTienCK.list = response.data.data
              }
            })
            var vtien_sodep = val.tiensodep ? val.tiensodep : 0
            for (var item of this.ds_tien_khoanmuc)
              if (item['khoanmuctt_id'] == 23) {
                item['tien'] = vtien_sodep * 1
                item['vat'] = vtien_sodep * 0.1
                this.LayTongTien_HDTB()
                break
              }
            break
          case 'frmChonSMPhuongADSL':
            this.thuebao.adsl.txtSoAoAdsl = val.somay
            break
          case 'frmChonSMPhuongDiDong':
            // this.thuebao.adsl.txtSoAoAdsl = val.somay;
            this.thuebao.didong.txtSoMayDD = val.so_tb_chon
            this.thuebao.didong.txtSimDD = val.so_sim_chon
            this.thuebao.didong.txtSoMayNTK = this.thuebao.didong.txtSoMayDD
            this.thuebao.didong.cboGoiCuocDD.value = val.goicuoc_id_chon
            this.CHON_KIEULD_THEO_TB('84' + this.thuebao.didong.txtSoMayDD)
            this.CHON_LOAITB_TS_THEO_TB('84' + this.thuebao.didong.txtSoMayDD) // vuth update 0912
            if (val.kieuform == 0) this.thuebao.didong.cboGoiCuocDD.Enabled = false // vuth update fix 1109
            break
          case 'popupChonDVQL':
            if (val && val.DONVIQL_ID) {
              this.listbox.donvi_ql.valueql = val.DONVIQL_ID
              this.LoadNVThuCuoc()
              break
            } else {
              this.$toast.error('Bắt buộc phải chọn đơn vị quản lý cho khu vực giáp ranh!')
              return
            }
          case 'popupChonDVQLDau':
            if (val && val.DONVIQL_ID) {
              this.listbox.donvi_dau.value = val.DONVIQL_ID
              break
            }
          case 'popupChonDVQLCuoi':
            if (val && val.DONVIQL_ID) {
              this.listbox.donvi_cuoi.value = val.DONVIQL_ID
              break
            }
          case 'popupChonDVDau2':
            if (val && val.DONVI_ID) {
              // this.listbox.donvi_dau.value = val.DONVIQL_ID;

              this.listbox.donvi_dau.value = val.DONVI_ID
              break
            } else {
              this.$toast.error('Bắt buộc phải chọn đơn vị cho khu vực giáp ranh!')
              return
            }
          case 'popupChonDVCuoi2':
            if (val && val.DONVI_ID) {
              // this.listbox.donvi_cuoi.value = val.DONVIQL_ID;
              this.listbox.donvi_cuoi.value = val.DONVI_ID
              break
            } else {
              this.$toast.error('Bắt buộc phải chọn đơn vị quản lý cho khu vực giáp ranh!')
              return
            }
          case 'popupChonDVLD':
            if (val && val.DONVIQL_ID) {
              this.listbox.donvi_ql.value = val.DONVIQL_ID
              this.HT_GIAODIEN_DONVI()
              break
            } else {
              this.$toast.error('Bắt buộc phải chọn đơn vị lắp đặt cho khu vực giáp ranh!')
              return
            }
          case 'popupServiceAdds':
            this.m_dsThueBao_DichVu = this.LowerCasePropertyList(val)
            this.HT_DichVuGT()
            break
          case 'popupServiceOthers':
            this.dsDK_DVK_TB = val
            this.HT_DichVuKhac(this.LowerCasePropertyList(this.dsDK_DVK_TB), 1) //default 1 tren code cu
            break
          case 'popupServiceOthersTT':
            this.dsDK_DVK_TT = val
            this.HT_DichVuKhac(this.LowerCasePropertyList(this.dsDK_DVK_TT), 2) //default 2 tren code cu
            break
          case 'popupBuyDevices':
            this.dsCTM_TBI = val
            this.HT_ThietBi()
            break
          case 'popupCTV':
            this.filterbox.ctv.value = val.ten_ht
            this.filterbox.ctv.ma_ctv = val.nhanvien_id
            break
          case 'popupNGT':
            this.filterbox.nguoigt.value = val.ten_ht
            this.filterbox.nguoigt.nguoigt_id = val.nhanvien_id
            break
          case 'popupChonKhuVuc':
            this.thuebao.khuvuc = val.ma_kv
            this.dsHDTB_KV = val.hdtb_kv_data
            this.thuebao.khuvuc_id = val.khuvuc_id
            break
          case 'popupTienKM':
            this.ds_tien_khoanmuc = val
            if (this.ds_tien_khoanmuc.length > 0) {
              for (let item of this.ds_tien_khoanmuc) {
                if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
                  this.dtienld = item['tien']
                  this.dvatld = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
                  this.dtiencd = item['tien']
                  this.dvatcd = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DICHVU) {
                  this.dichvu.dtien_dv = item['tien']
                  this.dichvu.dvat_dv = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_MUATHIETBI) {
                  this.dtientbi = item['tien']
                  this.dvattbi = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT) {
                  this.kmld.dtienkmld = item['tien']
                  this.kmld.dvatkmld = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DATCOC) {
                  this.kmld.dtienkmdc = item['tien']
                  this.kmld.dvatkmdc = item['vat']
                  if (this.kmld.dtienkmdc > this.kmld.dtienkmld) {
                    this.kmld.dtienkmld = this.kmld.dtienkmdc
                    this.kmld.dvatkmld = this.kmld.dvatkmdc
                  }
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI) {
                  this.thietbi.dtien_kmtb = item['tien']
                  this.thietbi.dvat_kmtb = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC) {
                  this.kmld.dtiendatcoc_tt = item['tien']
                  this.kmld.dvatdatcoc_tt = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC_KM) {
                  this.kmld.dtiendatcoc_km = item['tien']
                  this.kmld.dvatdatcoc_km = item['vat']
                }
                // else
                // {
                //     kmtt_id = item["khoanmuctt_id"];
                //     tien_kmtt = item["tien"];
                //     tien_vat = item["vat"];
                // }
                //this.HienThiTienKhuyenMaiLapDat(dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt, kmtt_id, tien_kmtt, tien_vat);
                this.HienThiTienKhuyenMaiLapDat()
                this.LayTongTien_HDTB()
              }
            }
            // // var kmtt_id = -1;
            // // var tien_kmtt = 0;
            // // var tien_vat = 0;
            // this.ds_tien_khoanmuc = val;
            // if (this.ds_tien_khoanmuc.length > 0)
            // {
            //   for (var item of this.ds_tien_khoanmuc)
            //   {
            //     if (item["khoanmuctt_id"] == KHOANMUC_TT.KMTT_DATMOI)
            //     {
            //         this.dtienld = item["tien"];
            //         this.dvatld = item["vat"];
            //     }
            //     else if (item["khoanmuctt_id"] == KHOANMUC_TT.KMTT_CAIDAT)
            //     {
            //         this.dtiencd = item["tien"];
            //         this.dvatcd = item["vat"];
            //     }
            //     else if (item["khoanmuctt_id"] == KHOANMUC_TT.KMTT_DICHVU)
            //     {
            //         this.dichvu.dtien_dv = item["tien"];
            //         this.dichvu.dvat_dv = item["vat"];
            //     }
            //     else if (item["khoanmuctt_id"] == KHOANMUC_TT.KMTT_MUATHIETBI)
            //     {
            //         this.dtientbi = item["tien"];
            //         this.dvattbi = item["vat"];
            //     }
            //     else if (item["khoanmuctt_id"] == KHOANMUC_TT.KMTT_KM_LAPDAT)
            //     {
            //         this.kmld.dtienkmld = item["tien"];
            //         this.kmld.dvatkmld = item["vat"];
            //     }
            //     else if (item["khoanmuctt_id"] == KHOANMUC_TT.KMTT_KM_DATCOC)
            //     {
            //         this.kmld.dtienkmdc = item["tien"];
            //         this.kmld.dvatkmdc = item["vat"];
            //         if (this.kmld.dtienkmdc > this.kmld.dtienkmld)
            //         {
            //             this.kmld.dtienkmld = this.kmld.dtienkmdc;
            //             this.kmld.dvatkmld = this.kmld.dvatkmdc;
            //         }
            //     }
            //     else if (item["khoanmuctt_id"] == KHOANMUC_TT.KMTT_KM_THIETBI)
            //     {
            //         this.thietbi.dtien_kmtb = item["tien"];
            //         this.thietbi.dvat_kmtb = item["vat"];
            //     }

            //     else if (item["khoanmuctt_id"] == KHOANMUC_TT.KMTT_DATCOC)
            //     {
            //         this.kmld.dtiendatcoc_tt = item["tien"];
            //         this.kmld.dvatdatcoc_tt = item["vat"];
            //     }
            //     else if (item["khoanmuctt_id"] == KHOANMUC_TT.KMTT_DATCOC_KM)
            //     {
            //         this.kmld.dtiendatcoc_km = item["tien"];
            //         this.kmld.dvatdatcoc_km = item["vat"];
            //     }
            //     // else
            //     // {
            //     //     kmtt_id = item["khoanmuctt_id"];
            //     //     tien_kmtt = item["tien"];
            //     //     tien_vat = item["vat"];
            //     // }
            //     //this.HienThiTienKhuyenMaiLapDat(dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt, kmtt_id, tien_kmtt, tien_vat);
            //     this.HienThiTienKhuyenMaiLapDat();
            //     this.LayTongTien_HDTB();
            //   }
            // }
            break
          case 'popupCT_TienKM':
            // let kmtt_id = -1;
            // let tien_kmtt = 0;
            // let tien_vat = 0;
            this.ds_tien_khoanmuc = val
            if (this.ds_tien_khoanmuc.length > 0) {
              for (let item of this.ds_tien_khoanmuc) {
                if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
                  this.dtienld = item['tien']
                  this.dvatld = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
                  this.dtiencd = item['tien']
                  this.dvatcd = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DICHVU) {
                  this.dichvu.dtien_dv = item['tien']
                  this.dichvu.dvat_dv = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_MUATHIETBI) {
                  this.dtientbi = item['tien']
                  this.dvattbi = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT) {
                  this.kmld.dtienkmld = item['tien']
                  this.kmld.dvatkmld = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DATCOC) {
                  this.kmld.dtienkmdc = item['tien']
                  this.kmld.dvatkmdc = item['vat']
                  if (this.kmld.dtienkmdc > this.kmld.dtienkmld) {
                    this.kmld.dtienkmld = this.kmld.dtienkmdc
                    this.kmld.dvatkmld = this.kmld.dvatkmdc
                  }
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI) {
                  this.thietbi.dtien_kmtb = item['tien']
                  this.thietbi.dvat_kmtb = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC) {
                  this.kmld.dtiendatcoc_tt = item['tien']
                  this.kmld.dvatdatcoc_tt = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC_KM) {
                  this.kmld.dtiendatcoc_km = item['tien']
                  this.kmld.dvatdatcoc_km = item['vat']
                }
                // else
                // {
                //     kmtt_id = item["khoanmuctt_id"];
                //     tien_kmtt = item["tien"];
                //     tien_vat = item["vat"];
                // }
                //this.HienThiTienKhuyenMaiLapDat(dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt, kmtt_id, tien_kmtt, tien_vat);
                this.HienThiTienKhuyenMaiLapDat()
                this.LayTongTien_HDTB()
              }
            }
            break
          case 'popup-ChonKhuyenMai':
            if (val.loaikm == Loai_KM.KhuyenMai) this.filterbox.khuyenmai.value = val.khuyenmai.khuyenmai_id
            else this.filterbox.tratruoc.value = val.khuyenmai.khuyenmai_id
            break
          case 'popup-DangkychitietkhuyenmaiTT':
            await this.LaySothang_SD()
            this.dsDC_HDTB = val.dsDC_HDTB
            this.kmld.dtienkmdc = val.tien_kmld_tt
            this.kmld.dvatkmdc = val.vat_kmld_tt
            this.kmld.tyle_kmld_tt = val.tyle_kmld_tt
            this.kmld.dtiendatcoc_tt = this.round((val.tien_datcoc_tt * 10) / 11)
            this.kmld.dvatdatcoc_tt = val.tien_datcoc_tt - this.kmld.dtiendatcoc_tt
            //Kiểm tra xem nếu không có tiền khuyến mại thì ưu tiên khuyến mại theo tỷ lệ
            if (this.kmld.dtienkmdc == 0) {
              if (this.kmld.tyle_kmld_tt > 0) {
                this.kmld.dtienkmdc = this.round((this.dtienld * this.kmld.tyle_kmld_tt) / 100)
                this.kmld.dvatkmdc = ((this.dtienld + this.dvatld) * this.kmld.tyle_kmld_tt) / 100 - this.kmld.dtienkmdc
              }
            }
            this.kmld.tong_kmld_tt = this.kmld.dtienkmdc + this.kmld.dvatkmdc

            //Hiếu bổ sung hàm kiểm tra xem user đã chọn chi tiết khuyến mại nào chưa - 23.09.2010
            if (this.dsDC_HDTB.length == 0) {
              this.kmld.tien_kmld_tt = 0
              this.kmld.vat_kmld_tt = 0
              this.kmld.tyle_kmld = 0
              this.kmld.tong_kmld_tt = 0
              this.kmld.dtiendatcoc_tt = 0
              this.kmld.dvatdatcoc_tt = 0
            }

            await this.HT_ThietBi()
            await this.HT_DichVuGT()
            await this.HienThiTienKhuyenMaiLapDat() //dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt);
            // await this.LayTongTien_HDTB()
            break
          case 'popup-Dangkychitietkhuyenmai':
            this.LaySothang_SD()

            this.dsKM_HDTB = val.dsKM_HDTB
            this.kmld.dtienkmld = val.tien_kmld
            this.kmld.dvatkmld = val.vat_kmld
            this.kmld.tyle_kmld = val.tyle_kmld
            this.kmld.tien_datcoc = val.tien_datcoc
            //Kiểm tra xem nếu không có tiền khuyến mại thì ưu tiên khuyến mại theo tỷ lệ
            if (this.kmld.dtienkmld == 0) {
              if (this.kmld.tyle_kmld > 0) {
                this.kmld.dtienkmld = this.round((this.dtienld * this.kmld.tyle_kmld) / 100)
                this.kmld.dvatkmld = ((this.dtienld + this.dvatld) * this.kmld.tyle_kmld) / 100 - this.kmld.dtienkmld
              }
            }
            this.kmld.tong_kmld = this.kmld.dtienkmld + this.kmld.dvatkmld

            //Hiếu bổ sung hàm kiểm tra xem user đã chọn chi tiết khuyến mại nào chưa - 23.09.2010
            if (this.dsKM_HDTB.length > 0) {
            } else {
              this.kmld.dtienkmld = 0
              this.kmld.dvatkmld = 0
              this.kmld.tong_kmld = 0
              this.kmld.tien_datcoc = 0
              this.kmld.tyle_kmld = 0
            }
            //HienThiTienKhuyenMaiLapDat(dtienkmld, dvatkmld, tien_datcoc);
            this.HT_ThietBi()
            this.HT_DichVuGT()
            this.HienThiTienKhuyenMaiLapDat() //dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt);
            // this.LayTongTien_HDTB()
            break
          case 'popupChonMaInGhep':
            if (val && val.hdmig_id) {
              this.thanhtoan.hdmig_id = val.hdmig_id
              this.thanhtoan.mainghep = val.main_ghep
            } else {
              if (this.hdtt_id && this.hdtt_id > 0)
                await API.post_lay_ds_hopdong_tt_theo_hdtt_id(this.axios, { hdtt_id: this.hdtt_id }).then(async (response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    await this.HienThiTTHopDongTT(response.data.data)
                  }
                })
            }
            break
          case 'popupDSSoChinh':
            this.thuebao.codinh.sochinh = val['ma_tb']
            this.thuebao.loaisochinh = val['loai']
            var iid_sochinh = val['id_sochinh']
            if (this.thuebao.loaisochinh == 1) this.thuebao.thuebao_id_cha = iid_sochinh
            else this.thuebao.hdtb_id_cha = iid_sochinh
            break
          case 'popupDSThueSo':
            this.thuebao.codinh.sochinh = val['vma_tb']
            this.loaisoisdn = LOAISO.THUONG
            this.thuebaocd.kieu_thueso = val['kieu_thueso']
            this.thuebaocd.noidung_thueso = val['noidung_thueso']
            this.thuebaocd.sothang_thueso = val['sothang_thueso']
            var vtongdai_id = val['vdonvi_id']
            this.thuebao.thuebao_id = val['thuebao_id']
            this.thuebao.codinh.dgvTienCK.list = [];
            await API.post_fn_lay_tt_chon_sm(this.axios, {
              ds_para: JSON.stringify({
                DICHVUVT_ID: this.listbox.dichvu_vt.value,
                KIEULD_ID: this.listbox.kieu_ld.value,
                KHACHHANG_ID: this.khachhang.khachhang_id,
                TONGDAI_ID: vtongdai_id,
                NHOMSO_ID: val['vnhomso_id'],
                CHAPNHAN: 1,
                QUANLD_ID: this.diachiLD.QUAN_ID,
                PHUONGLD_ID: this.diachiLD.PHUONG_ID
              })
            }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                var apidata = JSON.parse(response.data.data)
                if (apidata['ERROR_CODE'] != 1) {
                  this.$toast.error(apidata['MESSAGE'])
                  return
                }
                this.thuebao.codinh.dgvTienCK.list = this.LowerCasePropertyList(apidata['RESULT']['DS_TIENCK'])
                if (apidata['RESULT']['DONVI_QL_ID'])
                  for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
                    if (this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.TRAM_VT || this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.HOST) {
                      var dl = this.DT_DV(i).filter((x) => x.id == apidata['RESULT']['DONVI_QL_ID'])
                      if (dl && dl.length > 0) this.DT_CONTROLS.value[i] = apidata['RESULT']['DONVI_QL_ID']
                    }
                  }
              }
            })
            break
          case 'popupChonSMThue':
            this.thuebao.codinh.sochinh = val['somay']
            this.loaisoisdn = LOAISO.THUONG
            this.thuebaocd.kieu_thueso = val['kieu_thueso']
            this.thuebaocd.noidung_thueso = val['noidung_thueso']
            this.thuebaocd.sothang_thueso = val['sothang_thueso']
            var vtongdai_id = val['tongdai_id']
            this.thuebao.codinh.dgvTienCK.list = [];
            await API.post_fn_lay_tt_chon_sm(this.axios, {
              ds_para: JSON.stringify({
                DICHVUVT_ID: this.listbox.dichvu_vt.value,
                KIEULD_ID: this.listbox.kieu_ld.value,
                KHACHHANG_ID: this.khachhang.khachhang_id,
                TONGDAI_ID: vtongdai_id,
                NHOMSO_ID: val['vnhomso_id'],
                CHAPNHAN: 1,
                QUANLD_ID: this.diachiLD.QUAN_ID,
                PHUONGLD_ID: this.diachiLD.PHUONG_ID
              })
            }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                var apidata = JSON.parse(response.data.data)
                if (apidata['ERROR_CODE'] != 1) {
                  this.$toast.error(apidata['MESSAGE'])
                  return
                }
                this.thuebao.codinh.dgvTienCK.list = this.LowerCasePropertyList(apidata['RESULT']['DS_TIENCK'])
                if (apidata['RESULT']['DONVI_QL_ID'])
                  for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
                    if (this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.TRAM_VT || this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.HOST) {
                      var dl = this.DT_DV(i).filter((x) => x.id == apidata['RESULT']['DONVI_QL_ID'])
                      if (dl && dl.length > 0) this.DT_CONTROLS.value[i] = apidata['RESULT']['DONVI_QL_ID']
                    }
                  }
              }
            })
            break
          case 'popupDSTBCungDoiCapBC':
            //TODO RECENT chua lam!!!
            // if (Convert.ToInt32(cboKieuLD.SelectedValue) == KieuLapDat.TACH_VLAN)
            // {
            //     long int_tb_id = frm.thuebao_id;
            //     int int_tram_id = 0;
            //     //if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) != frm.loaitb_id)
            //     //{
            //     //    Message_Box.ShowWarning("Loại hình được chọn không cùng loại hình với thuê bao lập hợp đồng !");
            //     //    return;
            //     //}

            //     //cboLoaihinhTB.SelectedValue = frm.loaitb_id;

            //     HienThiTTDiaChi(tcbancheo.LAY_DS_DIACHI_THEO_DBTBID(tinh, int_tb_id), 3);

            //     string str = "";
            //     str += " Select * ";
            //     str += " from CSS_" + tinh.matinh + ".dbtb_dv ";
            //     str += " where thuebao_id = " + int_tb_id;
            //     str += "    and loaidv_id = " + LOAI_DV.TRAM_VT;
            //     DataSet ds_dvi = new DataSet();
            //     //ds_dvi = new OracleDataBanCheo().getDataFromSQL(tinh,str, "donvi");
            //     ds_dvi = bancheo.getDataFromSQL_BC(tinh, str, "donvi");
            //     if (ds_dvi.Tables[0].Rows.Count > 0)
            //         int_tram_id = Convert.ToInt32(ds_dvi.Tables[0].Rows[0]["donvi_id"].ToString());
            //     DataSet ds = new DataSet();
            //     ds = bangts_tc.LAY_DONVI_THEO_LOAIDV_DIACHI_LD_V2(tinh, LOAI_DV.TRAM_VT, phuongld_id, phold_id, apld_id, khuld_id, dacdiemld_id);

            //     if (ds.Tables[0].Rows.Count <= 0)
            //     {
            //         ds = bangts_tc.LAY_DONVI_THEO_LOAIDV_DIACHI_LD_V2(tinh, LOAI_DV.TRAM_VT, phuongld_id, phold_id, apld_id, 0, dacdiemld_id);
            //         if (ds.Tables[0].Rows.Count <= 0)
            //         {
            //             ds = bangts_tc.LAY_DONVI_THEO_LOAIDV_DIACHI_LD_V2(tinh, LOAI_DV.TRAM_VT, phuongld_id, phold_id, 0, 0, dacdiemld_id);
            //             if (ds.Tables[0].Rows.Count <= 0)
            //             {
            //                 Message_Box.ShowWarning("Địa danh này chưa được gán đơn vị quản lý địa chỉ lắp đặt. Hãy liên hệ với Admin để xử lý!");
            //                 cboDaiVT.Text = "";
            //                 return;
            //             }
            //         }
            //     }

            //     if (ds.Tables[0].Rows.Count == 1)
            //     {
            //         cboDaiVT.SelectedValue = Convert.ToInt32(ds.Tables[0].Rows[0]["donviql_id"].ToString());
            //         for (int i = 0; i < dtControl.Rows.Count; i++)
            //         {
            //             if (Convert.ToInt32(dtControl.Rows[i]["loaidv_dich_id"].ToString()) == LOAI_DV.TRAM_VT)
            //             {
            //                 bangts.HT_DonVi_TRAMTC_Combobox(cbo[i], Convert.ToInt32(dtControl.Rows[i]["loaidv_dich_id"].ToString()), Convert.ToInt32(cboDaiVT.SelectedValue));

            //                 if (int_tram_id != 0)
            //                     cbo[i].SelectedValue = int_tram_id;
            //                 else
            //                     cbo[i].SelectedValue = Convert.ToInt32(ds.Tables[0].Rows[0]["donvi_id"].ToString());
            //                 break;
            //             }
            //         }
            //     }
            //     else
            //     {
            //         if (int_tram_id != 0)
            //         {
            //             for (int k = 0; k < ds.Tables[0].Rows.Count; k++)
            //             {
            //                 if (int_tram_id == Convert.ToInt32(ds.Tables[0].Rows[k]["donvi_id"].ToString()))
            //                 {
            //                     cboDaiVT.SelectedValue = Convert.ToInt32(ds.Tables[0].Rows[k]["donviql_id"].ToString());
            //                     for (int i = 0; i < dtControl.Rows.Count; i++)
            //                     {
            //                         if (Convert.ToInt32(dtControl.Rows[i]["loaidv_dich_id"].ToString()) == LOAI_DV.TRAM_VT)
            //                         {
            //                             bangts.HT_DonVi_TRAMTC_Combobox(cbo[i], Convert.ToInt32(dtControl.Rows[i]["loaidv_dich_id"].ToString()), Convert.ToInt32(cboDaiVT.SelectedValue));
            //                             cbo[i].SelectedValue = int_tram_id;
            //                             break;
            //                         }
            //                     }
            //                     break;
            //                 }
            //             }
            //         }
            //         else
            //         {
            //             frmChonDonVi frm1 = new frmChonDonVi(ds);
            //             frm1.donvi_index_id = tt_nd.donvi_dl_id;
            //             frm1.ShowDialog();
            //             if (frm.chapnhan)
            //             {
            //                 cboDaiVT.SelectedValue = frm1.donvi_ql_id;
            //                 for (int i = 0; i < dtControl.Rows.Count; i++)
            //                 {
            //                     if (Convert.ToInt32(dtControl.Rows[i]["loaidv_dich_id"].ToString()) == LOAI_DV.TRAM_VT)
            //                     {
            //                         bangts.HT_DonVi_TRAMTC_Combobox(cbo[i], Convert.ToInt32(dtControl.Rows[i]["loaidv_dich_id"].ToString()), Convert.ToInt32(cboDaiVT.SelectedValue));

            //                         if (int_tram_id != 0)
            //                             cbo[i].SelectedValue = int_tram_id;
            //                         else
            //                             cbo[i].SelectedValue = frm1.in_donvi_id;
            //                         break;
            //                     }
            //                 }
            //             }
            //             else
            //             {
            //                 cboDaiVT.Text = "";

            //                 for (int i = 0; i < dtControl.Rows.Count; i++)
            //                 {
            //                     if (Convert.ToInt32(dtControl.Rows[i]["loaidv_dich_id"].ToString()) == LOAI_DV.TRAM_VT)
            //                     {
            //                         cbo[i].SelectedValue = "";
            //                         break;
            //                     }
            //                 }
            //                 return;
            //             }
            //         }
            //     }

            //     LAY_DONVI_THEO_LOAIDV_DIACHI_LD_V2(phuongld_id, phold_id, apld_id, khuld_id, dacdiemld_id);

            //     Lay_DS_MucCuoc_TB(0, 0, 0, 0, Convert.ToInt32(cboLoaihinhTB.SelectedValue), Convert.ToInt32(cboDoituongTB.EditValue), dtpNgayYeuCau.Value.ToString("dd/MM/yyyy"));
            //     //Nếu DichVuVT là TSL  va MyTV thì sinh lại mã
            //     if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.MEGAWAN
            //         || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.TSL
            //         || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.ADSL
            //         && (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_MYTV
            //             || Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.MAIL_SMD
            //             || Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.Web_Hosting))
            //         SinhMaDVVT();

            //     // minhnt: hiển thị nv kinh doanh theo địa bàn
            //     HT_NV_KinhDoanh_Theo_DiaBan(quanld_id, phuongld_id, phold_id, apld_id, khuld_id,
            //         Convert.ToInt32(cboDonViQL.SelectedValue), dacdiemld_id);
            // }

            // txtMaTN_Wan.Text = frm.ma_tn;
            // txtMaDoiCap_Wan.Text = frm.ma_doicap;
            break

          case 'popupDSTBCungDoiCap':
          case 'popupDSTBLapKem':
          case 'popupDSTBCungDoiCap_KH_Khac':
            this.thuebaocd.matn = val.MA_TB
            this.thuebaocd.madoicap = val.MADOICAP
            break
          case 'popupDSTBCungDoiCapMGWAN':
            if (this.listbox.kieu_ld.value == KieuLapDat.TACH_VLAN) {
              var pdata = { KHACHHANG_ID: this.khachhang.khachhang_id, THUEBAO_ID: this.thuebao.thuebao_id, PHUONGLD_ID: this.diachiLD.PHUONG_ID, PHOLD_ID: this.diachiLD.PHO_ID, APLD_ID: this.diachiLD.AP_ID, KHULD_ID: this.diachiLD.KHU_ID, DACDIEMLD_ID: this.diachiLD.DACDIEM_ID }
              API.post_fn_lay_tt_matn_wan(this.axios, { ds_para: pdata }).then(async (response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  var apidata = JSON.parse(response.data.data)
                  if (apidata['ERROR_CODE'] != 1) {
                    this.$toast.error(apidata['MESSAGE'])
                    return
                  }
                  apidata = apidata['RESULT']
                  if (apidata['DS_DIACHI'] && apidata['DS_DIACHI'].length > 0) this.HienThiTTDiaChi(apidata['DS_DIACHI'], 3)
                  if (apidata['DS_DVI']) this.XuLyDonViLD(apidata['DS_DVI'])
                }
              })
              // TODO check lai cac xu ly tiep theo co ve da xu ly o su kien thay doi diachiLD
              this.LAY_DONVI_THEO_LOAIDV_DIACHI_LD_V2()

              this.LoadMucCuocTB() // Thay cho ham Lay_DS_MucCuoc_TB(khuld_id, apld_id, phold_id, phuongld_id, this.listbox.loaihinh_tb.value, Convert.ToInt32(cboDoituongTB.EditValue), dtpNgayYeuCau.Value.ToString("dd/MM/yyyy"));
              //Nếu DichVuVT là TSL  va MyTV thì sinh lại mã
              if (
                this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM ||
                this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM ||
                (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL &&
                  (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B || this.listbox.loaihinh_tb.value == LoaiHinhTB.MAIL_SMD || this.listbox.loaihinh_tb.value == LoaiHinhTB.Web_Hosting))
              )
                await this.SinhMaDVVT_BC()

              // minhnt: hiển thị nv kinh doanh theo địa bàn
              this.HT_NV_KinhDoanh_Theo_DiaBan() //HT_NV_KinhDoanh_Theo_DiaBan(quanld_id, phuongld_id, phold_id, apld_id, khuld_id, Convert.ToInt32(cboDonViQL.SelectedValue), dacdiemld_id); // Loai bo tham so vi dung tham so global
              if ([DichVuVienThong.MEGAWAN, DichVuVienThong.NOIBO_DADIEM, DichVuVienThong.TSL, DichVuVienThong.NOIBO_2DIEM, DichVuVienThong.ADSL, LoaiHinhTB.INTERNET_MYTV, LoaiHinhTB.INTERNET_MYTV_B2B, LoaiHinhTB.MAIL_SMD, LoaiHinhTB.Web_Hosting].indexOf(this.listbox.dichvu_vt.value * 1) >= 0) await this.SinhMaDVVT_BC()
            }
            this.thuebao.mgwan.matn = val.MA_TB
            this.thuebao.mgwan.madoicap = val.MADOICAP
            break
          case 'popupDSTBLapKemMGWAN':
          case 'popupDSTBCungDoiCap_KH_KhacMGWAN':
            this.thuebao.mgwan.matn = val.MA_TB
            this.thuebao.mgwan.madoicap = val.MADOICAP
            break
          case 'popupDSTBCungDoiCapIMS':
          case 'popupDSTBLapKemIMS':
          case 'popupDSTBCungDoiCap_KH_KhacIMS':
            this.thuebao.ims.txtMaTN_IMS = val.MA_TB
            this.thuebao.ims.txtMaDoiCap_IMS = val.MADOICAP
            break
          case 'popupDSTBCungDoiCapADSL':
          case 'popupDSTBLapKemADSL':
          case 'popupDSTBCungDoiCap_KH_KhacADSL':
            this.thuebao.adsl.txtMaTN_ADSL = val.MA_TB
            this.thuebao.adsl.txtMaDoiCap_ADSL = val.MADOICAP
            break
          case 'popupDSTBCungDoiCapCNTT':
            if (val) this.popupRetVal = val
            else this.popupRetVal = {}
            // grcMacdinh.RefreshDataSource();
            break
          // case "popupChonSMTheoHost": // Chuyen len tren vi bao trung code
          //   if(!val.somay) return;
          //   this.thuebao.codinh.somay = val.somay;
          //   this.thuebao.codinh.arraySoMay = val.arraySoMay?val.arraySoMay:[];
          //   this.loaisoisdn = val.loaiso;
          //   API.post_sp_lay_danhsach_tiencamket(this.axios, val.nhomso).then(
          //   (response) => {
          //     if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          //       this.thuebao.codinh.dgvTienCK.list=response.data.data;
          //     }
          //   });
          //   var vtien_sodep = val.tiensodep?val.tiensodep:0;
          //   for(var item of this.ds_tien_khoanmuc)
          //     if(item['khoanmuctt_id']==23) {
          //       item['tien'] = vtien_sodep;
          //       item['vat'] = vtien_sodep*0.1;
          //       this.LayTongTien_HDTB();
          //       break;
          //     }

          //   break;
          case 'popupDSHuongKN':
            this.thuebao.mgwan.huongkn = val.shuongkn
            this.thuebao.mgwan.vhuongkn = val.vma_tb
            this.diachiKN.DIACHI = val.diachi_ld
            this.thuebao.loaisochinh = val.iloai // FIXME check lai cho nay xem link vao dau????
            //TODO 2 phan ben duoi can them API:
            /*
            "txtVrf_Mgwan.Text = objCheckData.MAP_ID(""vrf"", DatabaseConstants.DB2 + "".db_mgwan"", ""where thuebao_id = "" + thuebao_id_cha);
            -> Đề xuất API viết
            select nvl(vrf,'-1') from css.db_mgwan where thuebao_id=p_thuebao_id_cha and phanvung_id=p_phanvung_id
            -----------------------------------
            txtVrf_Mgwan.Text = objCheckData.MAP_ID(""vrf"", DatabaseConstants.DB2 + "".hdtb_mgwan"", ""where hdtb_id = "" + hdtb_id_cha);
            -> Đề xuất API viết
            select nvl(vrf,'-1') from css.hdtb_mgwan where hdtb_id=p_hdtb_id_cha and phanvung_id=p_phanvung_id"
            */
           if(this.thamsomacdinh['SD_FRMDSHUONGKN_V2']==1) {
            this.thuebao.mgwan.vrfvfi = val.vrf;
            this.listbox.tinh_kn.value = val.itinh_kn_id;
           }
           else {
            this.listbox.tinh_kn.value = this.tinh.tinhthicong_id?this.tinh.tinhthicong_id:val.itinh_kn_id
            if (this.thuebao.loaisochinh == 1) {
              this.thuebao.thuebao_id_cha = val.iid_sochinh
              if (this.thamsomacdinh['TUDONG_LAY_VRF_VFI_THEO_HUONGKN'] == 1)
                API.post_ds_huong_kn_vrf1(this.axios, { id: val.iid_sochinh }).then(async (response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    this.thuebao.mgwan.vrfvfi = response.data.data['VRF']
                  }
                })
            } else {
              this.thuebao.hdtb_id_cha = val.iid_sochinh
              if (this.thamsomacdinh['TUDONG_LAY_VRF_VFI_THEO_HUONGKN'] == 1)
                API.post_ds_huong_kn_vrf2(this.axios, { id: val.iid_sochinh }).then(async (response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    this.thuebao.mgwan.vrfvfi = response.data.data['VRF']
                  }
                })
            }
          }
            break
          case 'popupTieuNganh':
            this.tieunganh = val
            break
          case 'popupTT_Fsecure_kem_ftth':
            this.thuebao.adsl.txtDienThoai_Fsecure = val.so_dt // sodt_fsecure_kem
            this.thuebao.adsl.kh_cd_fsecure = val.kh_cd_fsecure
            var _matb_tn = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.trim() : this.thuebao.adsl.txtAccountADSL
            var _madoicap = this.thuebao.adsl.txtMaDoiCap_ADSL ? this.thuebao.adsl.txtMaDoiCap_ADSL.trim() : this.thuebao.adsl.txtMaDoiCap_ADSL
            this.listbox.dichvu_vt.value = DichVuVienThong.ANTOAN_BAOMAT_TT
            this.listbox.loaihinh_tb.value = LoaiHinhTB.FSECURE
            this.listbox.kieu_ld.value = this.kieuld_fsecure_kem_fiber
            this.tocdotn_id = FSECURE_KM_12_MONTHS.FreeFSD12M_2018 // TOCDO_ID_CFreeFSD12M;// TOCDO_ID_V2;
            this.muccuoctn_id = 0
            this.listbox.cboGoiCuocAdsl.value = this.tocdotn_id
            try {
              var pdata = {
                kieuLdId: this.listbox.kieu_ld.value,
                loaiHdId: this.buttonSet == 1 ? LoaiHopDong.DAT_MOI : '1',
                loaiTbId: this.listbox.loaihinh_tb.value,
                mucCuocId: this.listbox.muccuoc.value && this.listbox.muccuoc.value > 0 ? this.listbox.muccuoc.value : -1,
                tocDoId: -1
              }
              this.huonggiao_tn = 0
              this.quytrinh_tn = 0
              this.luong_id = 0

              await API.post_lay_huonggiao_tiepnhan(this.axios, pdata).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  var dulieuapi = response.data.data
                  if (dulieuapi['huonggiao_id']) this.huonggiao_tn = dulieuapi['huonggiao_id']
                  if (dulieuapi['quytrinh_id']) this.quytrinh_tn = dulieuapi['quytrinh_id']
                  if (dulieuapi['luong_id']) this.luong_id = dulieuapi['luong_id']
                } else throw 'Nghiệp vụ "Đặt mới Fsecure kèm FTTH" chưa được thiết lập quy trình, bạn hãy liên hệ Admin để xử lý!'
              })

              // #region "Tao du lieu"

              this.dsHDTB_CD = []
              this.dsHDTB_DD = []
              this.dsHDTB_ADSL = []
              this.dsHDTB_TSL = []
              this.dsHDTB_MEWAN = []
              this.dsHDTB_GP = []
              this.dsHDTB_IMS = []
              this.dsCAMKET_HDTB = []
              //dsHDTBDV = new HDTB_DV_DATA();
              this.dsHDTBDV_Fsecure = []
              this.dsTien_HDTB = []
              this.dsDK_DVGT = []

              this.TaoDuLieu_HDTB_Fsecure_kem()
              this.TaoDuLieu_HDTT(false) //TuấnNA thêm code để cập nhật matb_dd trong nút thêm thuê bao -- ngày 18.03.2011
              //Thêm mới thongtintt, cttien 17/09/2010
              //TaoDuLieu_THONGTIN_TT(true);
              this.TaoDuLieu_CT_TIENHD_fsecure_kem(true)
              //
              this.TaoDuLieu_TIEN_DATCOC_Fsecure_kem(true)
              this.TaoDuLieu_DiaChi(true, 3)

              this.CapNhat_HDTB_ID_HDTB_KV_ThemTB()

              this.TaoDuLieu_HDTB_CNTT_Fsecure_kem(_matb_tn, _madoicap)
              // #endregion

              var pdata = {
                HD_THUEBAO: this.dsHDTB,
                HDTB_DV: this.dsHDTBDV,
                HDTB_CD: this.dsHDTB_CD,
                HDTB_DD: this.dsHDTB_DD,
                HDTB_INT: this.dsHDTB_INT,
                HDTB_ADSL: this.dsHDTB_ADSL,
                DIACHI: this.DIACHI,
                DIACHI_HDTB: this.dsDiaChiHDTB,
                CT_MUA_TBI: this.UpperCasePropertyList(this.dsCTM_TBI), //this.dsCTM_TBI,
                HDTB_MGWAN: this.dsHDTB_MEWAN, //dsHDTB_MEWAN
                HDTB_TSL: this.dsHDTB_TSL, //dsHDTB_TSL
                HDTB_GP: this.dsHDTB_GP, //dsHDTB_GP
                KHUYENMAI_HDTB: this.KHUYENMAI_HDTB,
                KHUYENMAI_HDTB: this.dsKM_HDTB && this.dsKM_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsKM_HDTB) : this.dsKM_HDTB, //this.dsKM_HDTB,
                DATCOC_HDTB: this.dsDC_HDTB && this.dsDC_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsDC_HDTB) : this.dsDC_HDTB,
                CT_TIENHD: this.dsCTTHD,
                TIEN_HDTB: this.dsTien_HDTB, //this.dsTien_HDTB,
                TIEN_DATCOC: this.dsTien_DatCoc,
                HD_THANHTOAN: this.dsHDTT,
                HDTB_IMS: this.dsHDTB_IMS, //dsHDTB_IMS
                HD_IMS: this.dsHDTB_IMS,
                CAMKET_HDTB: this.dsCAMKET_HDTB,
                HDTB_KV: this.dsHDTB_KV && this.dsHDTB_KV.length > 0 ? this.dsHDTB_KV.filter((x) => x.KHUVUC_ID && x.KHUVUC_ID > 0) : null, //this.dsHDTB_KV_tmp?this.dsHDTB_KV_tmp:this.dsHDTB_KV, da bo _tmp
                HDTB_CNTT: this.dsHDTB_CNTT, //dsHDTB_CNTT
                HUONGGIAO_ID: this.huonggiao_tn
              }
              await API.fn_themmoi_tudong_hdtb_fsecure(this.axios, pdata).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  //Khong thay xu ly gi o day!
                  //Gọi hàm cập nhật trạng thái HDTB = 1: Đã đặt chỗ thành công trên VDC
                  // laphd.CAPNHAT_STATUS_HDTB(hdtb_id, TRANGTHAI_DONGBO.CHUADONGBO); // Ham nay da xu ly o API tren cung viec them moi
                }
              })
            } catch (ex) {
              this.$toast.error('' + ex)
              if (this.debug) console.error(ex)
            }
            break
          case 'popupThongTinTC':
            if (val) this.thuebao.adsl.txtTTCuoc = val
            else this.thuebao.adsl.txtTTCuoc = ''
            break
          case 'popupChonSMTSLDau':
            if (this.thuebao.tsl.txtSoAoTSL_Cuoi && this.thuebao.tsl.txtSoAoTSL_Cuoi.trim() != '') {
              if (val.ma_tb == this.thuebao.tsl.txtSoAoTSL_Cuoi.trim()) {
                this.$toast.error('Số ảo điểm đầu phải khác số ảo điểm cuối !')
                // btnSoAoTSL_Dau.Focus();
                return
              }
            }
            this.thuebao.tsl.txtSoAoTSL_Dau = val.ma_tb
            break
          case 'popupChonSMTSLCuoi':
            if (this.thuebao.tsl.txtSoAoTSL_Dau && this.thuebao.tsl.txtSoAoTSL_Dau.trim() != '') {
              if (val.ma_tb == this.thuebao.tsl.txtSoAoTSL_Dau.trim()) {
                this.$toast.error('Số ảo điểm đầu phải khác số ảo điểm cuối !')
                // btnSoAoTSL_Dau.Focus();
                return
              }
            }
            this.thuebao.tsl.txtSoAoTSL_Cuoi = val.ma_tb
            break
          case 'popupChonSoMayGphone':
            this.thuebao.gphone.txtSoMayGP = val.somay
            this.thuebao.gphone.txtSoSimGphone = val.simcard
            this.thuebao.gphone.dgvTienCKGP.list = [];
            API.post_sp_lay_danhsach_tiencamket(this.axios, { nhomso_id: val.nhomso }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.thuebao.gphone.dgvTienCKGP.list = response.data.data
              }
            })
            break
          case 'popupChonSoMayIMS':
            this.thuebao.ims.txtMaTBIMS = val.somay
            this.thuebao.ims.arraySoMay = val.arraySoMay ? val.arraySoMay : []
            this.thuebao.ims.dgvTienCKIMS.list = [];
            API.post_sp_lay_danhsach_tiencamket(this.axios, { nhomso_id: val.nhomso }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.thuebao.ims.dgvTienCKIMS.list = response.data.data
                //Lấy tiền số đẹp vào dataset tiền khoản mục
                var vtien_sodep = val.tiensodep
                for (var item of this.ds_tien_khoanmuc) {
                  if (item['khoanmuctt_id'] == 23) {
                    item['tien'] = vtien_sodep
                    item['vat'] = this.round(vtien_sodep * 0.1)
                    this.LayTongTien_HDTB()
                    break
                  }
                }
              }
            })
            break
          case 'popupChonMauHDDT':
            if (val && val.soluong) {
              for(var i = 0; i < this.ItemList.length; i++)
                if (ItemList[i].sFieldName == 'SL_MAILING') {
                  this.ItemList[i].sValue = val.soluong
                  this.gridEditors[i].Value = val.soluong
                }
              if (val.dsHDTB_CT && val.dsHDTB_CT.length > 0) this.dsHDTB_CT = val.dsHDTB_CT
            }
            break

          case 'popupLayDuLieuTuAPI':
            this.ItemList[val.vitri].sValue = val.giatrichon
            this.gridEditors[val.vitri].Value = val.giatrichon
            const get_loaitb_id = this.listbox.loaihinh_tb.value
            //Hoannc
            const data_api = await API.fn_kiemtra_hienthi_tentruong_edu(this.axios, { loaitb_id: get_loaitb_id })
            if (data_api.data.data == 'OK') {
              const tentruong = val.bangtrave[0].ten_truong
              for (let j = 0; j < this.ItemList.length; j++) {
                if (this.ItemList[j].sFieldName == 'THUONGHIEU') {
                  this.ItemList[j].sValue = tentruong
                  this.gridEditors[j].Value = tentruong
                  break
                }
              }
            }
            break
          case 'popupDangKySoLienLac':
            for (var j = 0; j < this.ItemList.length; j++) {
              if (this.ItemList[j].sFieldName == 'SL_MAILING') {
                this.ItemList[j].sValue = val.tong_tien
                this.gridEditors[j].Value = val.tong_tien
                break
              }
            }
            for (var j = 0; j < this.ItemList.length; j++) {
              if (this.ItemList[j].sFieldName == 'SOLUONG') {
                this.ItemList[j].sValue = val.tong_tien
                this.gridEditors[j].Value = val.tongso_hs
                break
              }
            }
            break
          case 'popupChiTietHDTB':
            this.dsHDTB_CT = val.dsHDTB_CT
            for (let i = 0; i < this.ItemList.length; i++) {
              if((this.listbox.dichvu_vt.value == LoaiHinhTB.VNEDU_SMARTID && this.ItemList[i].sFieldName == 'SL_MAILING')
                || (this.listbox.dichvu_vt.value == LoaiHinhTB.VNPT_SMCC && this.ItemList[i].sFieldName == 'DOITAC')
              ) {
                this.ItemList[i].sValue = this.dsHDTB_CT.length
                this.gridEditors[i].Value = this.dsHDTB_CT.length
              }
            }
            break
          case 'popupThongSoCNTT':
            this.thongso_tc = val.thongso_tc;
            this.thongso_ban = val.thongso_ban;
            this.ItemList = this.thongso_ban.thongso_cntt;
            for(var i = 0; i< this.ItemList.length; i++) {
              if(this.ItemList[i].SqlData && this.ItemList[i].SqlData.length>0) this.gridEditors[i].DataSource = this.ItemList[i].SqlData
              this.gridEditors[i].Value = this.ItemList[i].sValue
            }
            break;
          case 'popupThongTinTBBoSung':
            if(val.cap_nhat) {
              this.dsHDTB_SUB = this.UpperCasePropertyList(val.ds_hdtb_sub);
              this.vkenh_toantrinh = val.vkenh_toantrinh;
            }
          case 'popupHDTB_CNTT_SUB':
          case 'frmChonDoiTuong_CT':
          default:
            this.popupRetVal = val
            //Chuc nang popup nay chua thay xu ly gi sau khi dong popup, tam thoi ko code
            break
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      } finally {
        this.ClosePopup('popupComponents')
        this.loading(false)
      }
    },
    HT_NV_KinhDoanh_Theo_DiaBan() {
      var pdata = {
        ap_id: this.diachiLD.AP_ID,
        dacdiem_id: this.diachiLD.DACDIEM_ID,
        donvi_ql_id: this.listbox.donvi_ql.valueql ? this.listbox.donvi_ql.valueql : 0,
        khu_id: this.diachiLD.KHU_ID,
        pho_id: this.diachiLD.PHO_ID,
        phuong_id: this.diachiLD.PHUONG_ID,
        quan_id: this.diachiLD.QUAN_ID
      }
      API.post_sp_ht_kv_cskh_theo_diaban(this.axios, pdata).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          var ds = response.data.data
          if (ds.length > 1) {
            if(!this.thuebao || !this.thuebao.khuvuc_id || !this.thuebao.khuvuc || !ds.find(x=>x.ten_kv==this.thuebao.khuvuc && x.khuvuc_id==this.thuebao.khuvuc_id)) {
              this.popupComponent = () => import('../InstallNewSubs/Popups/popupGanKhuVucQuanLyThueBao')
              this.popupComponentName = 'popupChonKhuVuc'
              this.popupComponentData = { diachi: this.diachiLD, khuvuc_id: this.thuebao.khuvuc_id, hdtb_id: this.hdtb_id, thuebao_id: this.thuebao.thuebao_id, donvi_id: this.listbox.donvi_ql.value }
              //if(this.dsCTM_TBI && this.dsCTM_TBI.length>0) this.popupComponentData.ds = this.dsCTM_TBI;
              this.Popup('popupComponents')
            }
          } else if (ds.length > 0) {
            this.thuebao.khuvuc = ds[0]['ten_kv']
            this.thuebao.khuvuc_id = ds[0]['khuvuc_id']
            if (this.thuebao.khuvuc_id)
              this.dsHDTB_KV = [
                {
                  HDTB_ID: this.hdtb_id,
                  KHUVUC_ID: this.thuebao.khuvuc_id,
                  LOAIKV_ID: LOAI_KV.KHUVUC_DIABAN,
                  NGAY_CN: new Date().toLocaleDateString('en-GB'),
                  MAY_CN: this.tt_nd.may_cn,
                  NGUOI_CN: this.$root.token.getNguoiDungID(),
                  IP_CN: 'y.y.y.y'
                }
              ]
          } else {
            this.thuebao.khuvuc = ''
            this.dsHDTB_KV = []
            this.thuebao.khuvuc_id = 0
          }
        }
      })
    },
    btnSite_ID_Click() {
      this.loading(true)
      API.post_lay_ds_tram_bts(this.axios, {})
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            var ds = response.data.data
            if (ds.length > 0) {
              this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonGrid')
              this.popupComponentName = 'popupChon_Site_ID'
              this.popupComponentData = {
                ds: ds,
                cols: [
                  { fieldName: 'stt', headerText: 'STT', allowFiltering: false, allowSorting: false },
                  { fieldName: 'bts_id', headerText: 'BTS_ID', allowFiltering: true, allowSorting: true },
                  { fieldName: 'ma_bts', headerText: 'Mã BTS', allowFiltering: true, allowSorting: true },
                  { fieldName: 'ten_bts', headerText: 'Tên BTS', allowFiltering: true, allowSorting: true }
                ],
                keycol: 'bts_id',
                allowExit: false,
                tieude: 'Chọn BTS',
                tieudebang: ''
              }
              this.Popup('popupComponents')
            } else {
              this.$toast.error('Không có dữ liệu trạm cho khu vực này!')
            }
          } else if (response.data.error == 204) this.$toast.error('Không có dữ liệu trạm cho khu vực này!')
        })
        .catch()
        .finally(() => {
          this.loading(false)
        })
    },
    getDiaChi: function(data, datatype) {
      this[datatype].DIACHI = data.diachimoi
      this[datatype].TINH_ID = data.tinh_id
      this[datatype].QUAN_ID = data.quan_id
      this[datatype].PHUONG_ID = data.phuong_id
      this[datatype].PHO_ID = data.pho_id
      this[datatype].AP_ID = data.ap_id
      this[datatype].KHU_ID = data.khu_id
      this[datatype].DACDIEM_ID = data.dacdiem_id
      this[datatype].SO_NHA = data.so_nha
      this[datatype].BLOCK = data.block
      this[datatype].TANG = data.tang
      this[datatype].PHONG = data.sophong
      this[datatype].MOTA = data.motathem
      this[datatype].Lat = data.lat
      this[datatype].Lng = data.lng
    },
    getDiaChiKH: function(data) {
      this.getDiaChi(data, 'diachiKH')
      //TODO tim don vi quanly cboDonViQL
      //this.listbox.donvi_ql.value="";
      if (!this.diachiTT.DIACHI || !this.diachiTT.TINH_ID) this.diachiTT = Object.assign({}, this.diachiKH)
      if (!this.diachiCT.DIACHI || !this.diachiCT.TINH_ID) this.diachiCT = Object.assign({}, this.diachiKH)
      // if(!this.diachiLD.DIACHI)
      //   this.diachiLD = Object.assign({}, this.diachiKH);
      // if(!this.diachiTB.DIACHI)
      //   this.diachiTB = Object.assign({}, this.diachiKH);
      if (!this.diachiHK.DIACHI || !this.diachiHK.TINH_ID) this.diachiHK = Object.assign({}, this.diachiKH)
      if (!this.diachiNDD.DIACHI || !this.diachiNDD.TINH_ID) this.diachiNDD = Object.assign({}, this.diachiKH)
    },
    getDiaChiHK: function(data) {
      this.getDiaChi(data, 'diachiHK')
    },
    getDiaChiNDD: function(data) {
      this.getDiaChi(data, 'diachiNDD')
    },
    getDiaChiTT: async function(data) {
      this.getDiaChi(data, 'diachiTT')
      if ([DichVuVienThong.MEGAWAN, DichVuVienThong.NOIBO_DADIEM, DichVuVienThong.TSL, DichVuVienThong.NOIBO_2DIEM, DichVuVienThong.ADSL, LoaiHinhTB.INTERNET_MYTV, LoaiHinhTB.MAIL_SMD, LoaiHinhTB.Web_Hosting].indexOf(this.listbox.dichvu_vt.value * 1) >= 0) await this.SinhMaDVVT_BC()
    },
    getDiaChiCT: function(data) {
      this.getDiaChi(data, 'diachiCT')
    },
    getDiaChiBC: function(data) {
      this.getDiaChi(data, 'diachiBC')
    },
    getDiaChiTB: async function(data) {
      this.getDiaChi(data, 'diachiTB')
      // if (!this.diachiLD.DIACHI || (this.diachiLD.DIACHI == this.diachiKH.DIACHI && this.diachiLD.DIACHI != this.diachiTB.DIACHI)) this.diachiLD = Object.assign({}, this.diachiTB)
      this.diachiLD = Object.assign({}, this.diachiTB) // Sua theo yeu cau cua Tester
      if ([DichVuVienThong.MEGAWAN, DichVuVienThong.NOIBO_DADIEM, DichVuVienThong.TSL, DichVuVienThong.NOIBO_2DIEM, DichVuVienThong.ADSL, LoaiHinhTB.INTERNET_MYTV, LoaiHinhTB.MAIL_SMD, LoaiHinhTB.Web_Hosting].indexOf(this.listbox.dichvu_vt.value * 1) >= 0) await this.SinhMaDVVT_BC()
    },
    getDiaChiTBCu: async function(data) {
      this.getDiaChi(data, 'diachiTBCu')
    },
    getDiaChiHKTBCu: async function(data) {
      this.getDiaChi(data, 'diachiHKTBCu')
    },
    getDiaChiLD: function(data) {
      this.getDiaChi(data, 'diachiLD')
    },
    getDiaChiKN: function(data) {
      this.getDiaChi(data, 'diachiKN')
    },
    getDiaChiDau: async function(data) {
      this.getDiaChi(data, 'diachiDau')
      if (data.quan_id > 0 && data.phuong_id > 0 && data.tinh_id != 98) {
        ////HungHM - 06/09/2010 bổ xung đơn vị quản lý đầu + đơn vị quản lý cuối
        //donvi_dau_id = Convert.ToInt32(LayDonVi_QL(obj.phuong_id, obj.pho_id));

        //Hiếu tc: 21.1.2014: sửa lại hàm lấy đơn vị quản lý.
        var ds = await bancheo.LAY_DS_DONVIQL(this.thuebao.tsl.tinh_dau, data.phuong_id, data.pho_id, data.ap_id, data.khu_id, 2)
        this.listbox.donvi_dau.list = ds && ds.length > 0 ? JSON.parse(JSON.stringify(ds)) : []
        if (!ds || ds.length <= 0) {
          this.$toast.error('Địa danh này chưa được gán đơn vị quản lý địa chỉ lắp đặt. Hãy liên hệ với Admin để xử lý!')
          return
        } else if (ds && ds.length == 1) {
          this.listbox.donvi_dau.value = ds[0]['donvi_id'] * 1
        } else {
          this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonGrid')
          this.popupComponentName = 'popupChonDVQLDau'
          this.popupComponentData = {
            ds: this.UpperCasePropertyList(ds),
            cols: [
              { fieldName: 'DONVIQL_ID', headerText: 'ID', allowFiltering: false, allowSorting: false },
              { fieldName: 'TEN_DVQL', headerText: 'Đơn vị', allowFiltering: false, allowSorting: false },
              { fieldName: 'TEN_DV', headerText: 'Tổ thi công', allowFiltering: false, allowSorting: false }
            ],
            keycol: 'DONVIQL_ID',
            allowExit: false,
            tieude: 'Chọn đơn vị quản lý',
            tieudebang: 'Danh sách đơn vị'
          }
          this.Popup('popupComponents')
          // frmChonDonVi frm = new frmChonDonVi(ds);
          // frm.donvi_index_id = donvi_dau_id;
          // frm.ShowDialog();
          // if (frm.chapnhan)
          // {
          //     donvi_dau_id = frm.donvi_ql_id;
          // }
          // else
          // {
          //     return;
          // }
        }
        // hoangpkn : 02/07/2015 : Sửa lại cách lấy combo đầu
        //bangts.HT_DonVi_loaidv_Combobox(cboVetinhTSL_Dau, donvi_dau_id, LOAI_DV.TRAM_VT);
        // bangts_tc.HT_DVI_LOAIDV_Combobox(tinh_dau, cboVetinhTSL_Dau, donvi_dau_id, LOAI_DV.TRAM_VT);
        // end hoang
      }
      this.LoadDonViDauCuoiCombobox(1)
      // if(!this.listbox.donvi_dau.value || !this.listbox.donvi_dau.list.find(x=>x.donvi_id==this.listbox.donvi_dau.value))
      //   API.post_sp_lay_donvi_id(this.axios, {"phuong_id":data.phuong_id,"pho_id":data.pho_id,"loaidv_id":LOAI_DV.TRAM_VT,"tinhthicong_id":this.thuebao.tsl.tinh_dau.tinhthicong_id}).then((response)=>{
      //     if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //       if(response.data.data[0] && response.data.data[0].donvi_id && response.data.data[0].donvi_id!=-1) this.listbox.donvi_dau.value = response.data.data[0].donvi_id;
      //     }
      //   });// new CheckData().MAP_ID(tinh_dau, "donvi_id", "CSS_" + tinh_dau.matinh + ".donvi_px", "where phuong_id =" + obj.phuong_id + " and decode(" + obj.pho_id + ",0,0, pho_id) = " + obj.pho_id + " and loaidv_id = " + LOAI_DV.TRAM_VT);
      // if (vetinh_id != "-1")
      //     cboVetinhTSL_Dau.SelectedValue = vetinh_id;
      // else
      //     cboVetinhTSL_Dau.Text = "";
    },
    getDiaChiCuoi: async function(data) {
      this.getDiaChi(data, 'diachiCuoi')

      if (data.quan_id > 0 && data.phuong_id > 0 && data.tinh_id != 98) {
        ////HungHM - 06/09/2010 bổ xung đơn vị quản lý đầu + đơn vị quản lý cuối
        //donvi_dau_id = Convert.ToInt32(LayDonVi_QL(obj.phuong_id, obj.pho_id));

        //Hiếu tc: 21.1.2014: sửa lại hàm lấy đơn vị quản lý.

        var ds = await bancheo.LAY_DS_DONVIQL(this.thuebao.tsl.tinh_cuoi, data.phuong_id, data.pho_id, data.ap_id, data.khu_id, 2)
        this.listbox.donvi_cuoi.list = ds && ds.length > 0 ? JSON.parse(JSON.stringify(ds)) : []
        if (!ds || ds.length <= 0) {
          this.$toast.error('Địa danh này chưa được gán đơn vị quản lý địa chỉ lắp đặt. Hãy liên hệ với Admin để xử lý!')
          return
        } else if (ds && ds.length == 1) {
          this.listbox.donvi_cuoi.value = ds[0]['donvi_id'] * 1
        } else {
          this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonGrid')
          this.popupComponentName = 'popupChonDVQLCuoi'
          this.popupComponentData = {
            ds: this.UpperCasePropertyList(ds),
            cols: [
              { fieldName: 'DONVIQL_ID', headerText: 'ID', allowFiltering: false, allowSorting: false },
              { fieldName: 'TEN_DVQL', headerText: 'Đơn vị', allowFiltering: false, allowSorting: false },
              { fieldName: 'TEN_DV', headerText: 'Tổ thi công', allowFiltering: false, allowSorting: false }
            ],
            keycol: 'DONVIQL_ID',
            allowExit: false,
            tieude: 'Chọn đơn vị quản lý',
            tieudebang: 'Danh sách đơn vị'
          }
          this.Popup('popupComponents')
        }
      }
      this.LoadDonViDauCuoiCombobox(2)
      // if(!this.listbox.donvi_cuoi.value || !this.listbox.donvi_cuoi.list.find(x=>x.donvi_id==this.listbox.donvi_cuoi.value))
      //   API.post_sp_lay_donvi_id(this.axios, {"phuong_id":data.phuong_id,"pho_id":data.pho_id,"loaidv_id":LOAI_DV.TRAM_VT,"tinhthicong_id":this.thuebao.tsl.tinh_cuoi.tinhthicong_id}).then((response)=>{
      //     if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //       if(response.data.data[0] && response.data.data[0].donvi_id && response.data.data[0].donvi_id!=-1) this.listbox.donvi_cuoi.value = response.data.data[0].donvi_id;
      //     }
      //   });
    },
    LoadDonViDauCuoiCombobox(loaidv) {
      let diachi = loaidv == 1 ? this.diachiDau : this.diachiCuoi
      // let dv_id = loaidv==1?this.listbox.donvi_dau.value:this.listbox.donvi_cuoi.value//this.thuebao.tsl.donvi_dau_id:this.thuebao.tsl.donvi_cuoi_id;
      let donvi = loaidv == 1 ? this.listbox.donvi_dau : this.listbox.donvi_cuoi
      let api1 = API.post_fn_lay_tt_dvi_daucuoi(this.axios, {
        tinhthicong_id: diachi.TINH_ID,
        p_ds_para: JSON.stringify({ QUAN_ID: diachi.QUAN_ID, PHUONG_ID: diachi.PHUONG_ID, PHO_ID: diachi.PHO_ID ? diachi.PHO_ID : 0, AP_ID: diachi.AP_ID ? diachi.AP_ID : 0, KHU_ID: diachi.KHU_ID ? diachi.KHU_ID : 0, TINHKHAC: 0, KIEULD_ID: 2 })
      })
      let api2 = API.post_sp_ht_donvi_ldv(this.axios, { p_donvi_id: donvi.value, p_loaidvi_id: LOAI_DV.TRAM_VT, tinhthicong_id: diachi.TINH_ID })
      Promise.all([api1, api2]).then(([resp1, resp2]) => {
        // Promise.all([api2]).then(([resp2])=>{
        if (resp2 && resp2.data && resp2.data.data && resp2.data.data.length > 0) {
          donvi.list = resp2.data.data
          donvi.value = donvi.list[0].donvi_id
        } else donvi.list = []
        if (resp1 && resp1.data && resp1.data.data && resp1.data.data.length > 0) {
          let apidata = JSON.parse(resp1.data.data)
          if (apidata['ERROR_CODE'] == 1) {
            if (apidata['RESULT'] && apidata['RESULT']['VETINH_ID']) donvi.value = apidata['RESULT']['VETINH_ID']
            else this.$toast.error(`Địa danh này chưa được gán Loại đơn vị Trạm thi công điểm ${loaidv == 1 ? 'đầu' : 'cuối'}. Hãy liên hệ với Admin để xử lý!`)
          } else if (apidata['ERROR_CODE'] == -2) {
            let ds = JSON.parse(JSON.stringify(donvi.list))
            this.UpperCasePropertyList(ds)
            this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonGrid')
            this.popupComponentName = loaidv == 1 ? 'popupChonDVDau2' : 'popupChonDVCuoi2'
            this.popupComponentData = {
              ds: ds,
              cols: [
                { fieldName: 'DONVI_ID', headerText: 'ID', allowFiltering: false, allowSorting: false },
                { fieldName: 'TEN_DV', headerText: 'TÊN', allowFiltering: false, allowSorting: false }
              ],
              keycol: 'DONVI_ID',
              allowExit: false,
              tieude: 'Chọn đơn vị',
              tieudebang: 'Danh sách đơn vị'
            }
            this.Popup('popupComponents')
          } else this.$toast.error(`Lỗi lấy đơn vị Trạm thi công điểm ${loaidv == 1 ? 'đầu' : 'cuối'}: ${apidata['MESSAGE']}`)
        }
      })
    },
    popupTimNVThuCuoc: function(diachi) {
      //this.$refs.refTimNVThuCuoc.openDialog()
      // this.$refs.dlgTimKiemNVTC.openDialog();
      //this.$toast.error('Chức năng chưa được phát triển')

      this.nvtcInput = Object.assign({}, diachi && diachi.PHUONG_ID && diachi.PHUONG_ID != 0 ? diachi : this.diachiTT)
      if (this.listbox.donvi_ql.valueql) this.nvtcInput.DONVIQL_ID = this.listbox.donvi_ql.valueql
      this.nvtcInput.HTTT_ID = this.listbox.hinhthuc_tt.value
      this.nvtcInput.DisableHTTT = true
      //this.$bvModal.show('dlgTimKiemNVTC')
      var checkexists = false
      for (var item of this.popupQueue)
        if (item.id == 'dlgTimKiemNVTC') {
          checkexists = true
          break
        }
      if (!checkexists) {
        this.popupQueue.push({ id: 'dlgTimKiemNVTC' })
        this.ShowPopupQueue()
      }
    },
    ShowPopupQueue() {
      if (this.popupQueue.length > 0 && !this.popupShowing) {
        var popup = this.popupQueue.pop()
        if (!popup) this.ShowPopupQueue()
        if (popup.id) {
          this.$bvModal.show(popup.id)
          this.popupShowing = true
        } else {
          this.popupComponent = popup.component
          this.popupComponentName = popup.name
          this.popupComponentData = popup.data
          this.Popup('popupComponents')
          this.popupShowing = true
        }
      }
    },
    getNVTCProcess(data) {
      //this.params.quanHuyen_Selected = Number(value.quanId);
      //this.params.nhanVienXLMoi_Selected = Number(value.nhanVienTC_Id);
      // this.thanhtoan.nhanvientc_id = value.rowData.NHANVIEN_ID;
      // this.thanhtoan.manvtc = value.maNVTC;
      // this.thanhtoan.tuyenthu_id = value.rowData.TUYENTHU_ID;
      // this.thanhtoan.matuyen = value.rowData.MA_TUYENTHU;
      this.thanhtoan.nhanvientc_id = data.nhanvientc_id
      this.thanhtoan.manvtc = data.ma_nvtc
      this.thanhtoan.tuyenthu_id = data.tuyenthu_id
      this.thanhtoan.matuyen = data.ma_tuyen
    },
    getTTTBHandler(e) {
      this.popupbox.nvtc = e.MA_TT
    },
    diachiKHChanged() {
      // console.log(this.diachiKH.DIACHI);
      // console.log(this.diachiTT.DIACHI);
    },
    HienThiDS_HDTT_CBO(hdkh_id) {
      API.get_lay_ds_ma_thanhtoan(this.axios, { params: { hdkhId: hdkh_id } }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.thanhtoancbo.list = response.data.data

          if (this.listbox.thanhtoancbo.list && this.listbox.thanhtoancbo.list.length > 0 && (!this.listbox.thanhtoancbo.value || this.listbox.thanhtoancbo.value <= 0))
            if (this.hdtt_id && this.hdtt_id > 0) this.listbox.thanhtoancbo.value = this.hdtt_id
            else this.listbox.thanhtoancbo.value = this.listbox.thanhtoancbo.list[0]['ID']
        }
      })
    },
    LoadTTKhuyenMai(khoanmuctt_id, loaikmid, itrangbi_id, itocdo_id, loaikm) {
      var pdata = {
        vapld_id: this.diachiLD.AP_ID ? this.diachiLD.AP_ID : 0,
        vdoituong_id: this.listbox.doituong.value,
        vhdtb_id: this.hdtb_id,
        vkhoanmuctt_id: khoanmuctt_id ? khoanmuctt_id : 0,
        vkhuld_id: this.diachiLD.KHU_ID ? this.diachiLD.KHU_ID : 0,
        vkieuld_id: this.listbox.kieu_ld.value,
        vloaikm: loaikmid ? loaikmid : 0,
        vloaitb_id: this.listbox.loaihinh_tb.value,
        vmuccuoc_id: this.listbox.muccuoc.value && this.listbox.muccuoc.value > 0 ? this.listbox.muccuoc.value : 0,
        vphold_id: this.diachiLD.PHO_ID ? this.diachiLD.PHO_ID : 0,
        vphuongld_id: this.diachiLD.PHUONG_ID ? this.diachiLD.PHUONG_ID : 0,
        vtocdo_id: itocdo_id ? itocdo_id : 0,
        vtrangbi_id: itrangbi_id ? itrangbi_id : 0 //TODO xac dinh loai trang bi cua CD hay khac?
      }
      API.post_lay_khuyenmai_hdtb(this.axios, pdata).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.filterbox[loaikm ? loaikm : 'khuyenmai'].list = response.data.data
        } else {
          this.filterbox[loaikm ? loaikm : 'khuyenmai'].list = [];
          this.filterbox[loaikm ? loaikm : 'khuyenmai'].value = 0;
          this.filterbox[loaikm ? loaikm : 'khuyenmai'].ischecked = false;
        }

        if (this.filterbox[loaikm ? loaikm : 'khuyenmai'].list && this.filterbox[loaikm ? loaikm : 'khuyenmai'].list.length > 0) {
          if (!this.filterbox[loaikm ? loaikm : 'khuyenmai'].value || this.filterbox[loaikm ? loaikm : 'khuyenmai'].value <= 0 || !this.filterbox[loaikm ? loaikm : 'khuyenmai'].list.find((x) => x.khuyenmai_id == this.filterbox[loaikm ? loaikm : 'khuyenmai'].value))
            this.filterbox[loaikm ? loaikm : 'khuyenmai'].value = this.filterbox[loaikm ? loaikm : 'khuyenmai'].list[0].khuyenmai_id //else this.filterbox.tratruoc.value=0;
        } else this.filterbox[loaikm ? loaikm : 'khuyenmai'].ischecked = false
      })
    },
    MaGDChanged(e) {
      if (e) this.khachhang.magd = e.target.value
      if (this.khachhang.magd) {
        var pdata = {
          in_donvi_dl_id: 0,
          in_donvi_id: this.$root.token.getDonViID(),
          in_loaihd_id: LoaiHopDong.DAT_MOI, // Test data 1, default code 0
          in_ma_gd: this.khachhang.magd,
          in_nhanvien_id: this.$root.token.getNhanVienID(),
          in_tthd_id: TrangThaiHD.MOI
        }
        if (this.iKieu != 0) {
          if (!this.$root.token.getDonViID()) pdata.in_donvi_id = 0
          pdata.in_tthd_id = 0
          pdata.in_nhanvien_id = 0
        }
        try {
          API.post_lay_ds_hopdong_theo_ma_gd(this.axios, pdata).then(async (response) => {
            this.loading(false)
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              await this.HienThiTTHopDongKH(response.data.data)
              // if (this.lvwThueBao.length > 0) await this.lvwThueBaoChanged(1, this.lvwThueBao[0])
            } else {
              this.$toast.error('Mã giao dịch này không tồn tại hoặc không còn là giao dịch lắp mới!')
            }
          })
        } catch (ex) {
        } finally {
          this.loading(false)
        }
      }
    },
    async MaKHChanged(e) {
      if (e) this.khachhang.makh = e.target.value
      if (!this.khachhang.makh) return
      try {
        this.loading(true)
        this.isLoadKH = true;
        this.listbox.danhba.list = []
        await API.post_lay_db_theo_matb(this.axios, { ma_tb: this.khachhang.makh, donvi_dl_id: 0, dichvuvt_id: 0 }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            this.listbox.danhba.list = response.data.data
            // this.listbox.thanhtoan.list = this.listbox.danhba.list
          }
        })
        if (this.listbox.danhba.list.length > 0) {
          if (this.listbox.danhba.list[0]['ky_hd'] != 1) {
            this.$toast.error('Khách hàng có mã ' + this.khachhang.makh + ' chưa ký hợp đồng gốc. Đề nghị bạn ký hợp đồng gốc trước khi lập phụ lục.')
          } else {
            this.HienThiTT_DanhBa(this.listbox.danhba.list)
          }
          await API.post_lay_tt_khuvuc_theo_thuebao_id(this.axios, { id: this.listbox.danhba.list[0]['thuebao_id'] }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              this.thuebao.khuvuc = response.data.data['TEN_KV']
              this.thuebao.khuvuc_id = response.data.data['KHUVUC_ID']

              this.dsHDTB_KV = []
              var dr = {}
              dr.HDTB_ID = 0
              dr.KHUVUC_ID = this.thuebao.khuvuc_id
              dr.LOAIKV_ID = LOAI_KV.KHUVUC_DIABAN
              dr.NGUOI_CN = this.$root.token.getUserName()
              dr.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
              dr.MAY_CN = this.tt_nd.may_cn
              dr.IP_CN = 'y.y.y.y'
              dr.KIEUKV_ID = 2
              if (this.thuebao.khuvuc_id) this.dsHDTB_KV.push(dr)
            }
          })
        } else {
          // Tam comment lai vi schema khdn chua co!!!
          if (this.ts_kt_tthdkhdn == 1)
          {
            var ds = await API.get_lay_tt_khdn_theo_makh(this.axios, {params: {ma_kh:this.khachhang.makh}}).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data;
              }
              else return [];
            }).catch(()=>{ return []; });
            if(ds && ds.length>0) {
              ds = this.LowerCasePropertyList(ds);
              this.HienThiTT_DanhBa_KHDN(ds);
              return;
            }
          //     var sql = string.Format("select * from khdn.customers where ma_kh = '{0}'", txtMaKH.Text.trim());
          //     ds = bangts.getDataFromSQL(sql, "ds");
          //     if (ds.length != 0)
          //     {
          //       //THANGDM1: May cho comment nay khong ro tac dung, tam bo vi co the khong can thiet!
          //         // Clear();
          //         this.HienThiTT_DanhBa_KHDN(ds);
          //         // makh_web = txtMaKH.Text.trim();
          //         // isTruocBH = true;
          //         return;
          //     }
          }
          //TODO lay ds hop dong chua hoan thanh line 12193
          var pdata = {
            in_donvi_dl_id: 0,
            in_donvi_id: this.$root.token.getDonViID(),
            in_loaihd_id: 0, // Test data 1, default code 0
            in_ma_gd: this.khachhang.makh, //BUG "HPG-LD/00744631", ma nay la ma giao dich, tai sao truyen makh o day?????
            in_nhanvien_id: this.$root.token.getNhanVienID(),
            in_tthd_id: 0
            //"vphanvung_id": this.$root.token.getPhanVungID()
          }
          //BUG xem lai cho nay, goi theo UR2.1.004_296
          await API.post_lay_ds_hopdong_theo_ma_gd(this.axios, pdata).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              this.listbox.dshopdong_chuaht.list = response.data.data.filter((x) => x.tthd_id != 6 && x.tthd_id != 7)
              this.HienThiTT_HopDong_ChuaHT(this.listbox.dshopdong_chuaht.list)
            } else this.listbox.dshopdong_chuaht.list = []
          })
          //FIXME Doan phia sau nay khong thay co o code bancheo, tam de lai, xoa sau.
          var hdkh_id = 0
          if (this.listbox.dshopdong_chuaht.list.length > 0) {
            hdkh_id = this.listbox.dshopdong_chuaht.list[0]['hdkh_id']
          } else {
            hdkh_id = this.listbox.danhba.list[0]['khachhang_id']
          }
          this.khachhang.hdkh_id = hdkh_id
          //TODO load thong tin len form line 16729

          // Hien thi danh sach hd thanh toan line 16994
          await API.post_fn_ht_tt_hd_khachhang(this.axios, { ds_para: '{"HDKH_ID":' + hdkh_id + '}' }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              var apidata = JSON.parse(response.data.data)
              if (apidata['RESULT']) apidata = apidata['RESULT']
              if (apidata['DS_HD_TT']) this.listbox.thanhtoan.list = this.LowerCasePropertyList(apidata['DS_HD_TT'])
            }
          })
          if (this.listbox.danhba.list.length <= 0 && this.listbox.thanhtoan.list.length <= 0) this.$toast.error('Thuê bao chưa có khu vực quản lý, liên hệ với admin để xử lý!!!')
        }
      } catch (ex) {
        throw ex
      } finally {
        this.loading(false)
      }
    },
    onAcceptDVKhac(value) {
      this.dsDvKhacChose = []
      this.dsDvMaster.forEach((el) => {
        const isDk = document.getElementById(`DK_${el.DVKHAC_ID}`).checked
        const ishuy = document.getElementById(`H_${el.DVKHAC_ID}`).checked
        let tenDVK = el.TEN_DVKHAC
        if (isDk) tenDVK += '(DK)'
        if (ishuy) tenDVK += '(Hủy)'
        if (isDk || ishuy) {
          this.dsDvKhacChose.push({
            DVKHAC_ID: el.DVKHAC_ID,
            TEN_DVKHAC: tenDVK,
            kieu_yc: isDk ? 1 : 0
          })
        }
      })
      this.$bvModal.hide('modal-dvkhac')
      this.dsDvKhacChose.forEach((item) => {
        this.dsDichVuKhac.push({
          DVKHAC_ID: item.DVKHAC_ID,
          TEN_DVKHAC: item.TEN_DVKHAC,
          kieu_yc: item.kieu_yc
        })
      })
    },
    getDsDVKhac: async function() {
      try {
        // var rs = await this.$root.context.get(
        //   "/web-thuno/api/thu-no/thong-tin-khach-hang/lay-danh-sach-dich-vu-khac-dbid",
        //   {
        //     pDBId: this.thanhToanId || 0,//1453312,
        //     pLoaiId: 2,//1,
        //     pLoaiTBId: 0,//58,
        //     pKieuLDId: 0//39,
        //   }
        // ); //1 theo ma thue bao, 2 theo ma thanh toan
        const dsDvKhacChoseId = this.dsDvKhacChose.map((item) => item.DVKHAC_ID)
        const dvUsing = this.dsDichVuKhac.map((item) => item.DVKHAC_ID)
        this.dsDvMaster = this.dsDK_DVK_TT // Dong bo giua code form nay va form popup
        this.dsDvMaster = this.dsDK_DVK_TT.map((item) => {
          let htmlDangKy = `<div class="check-action">
            <input type="checkbox" id="DK_${item.DVKHAC_ID}" class="check"`
          if (item.DANGKY != 0) htmlDangKy += disabled
          if (dsDvKhacChoseId.includes(item.DVKHAC_ID)) htmlDangKy += checked
          htmlDangKy += `><span class="name"></span></div>`
          return {
            ...item,
            TRANGTHAI: dvUsing.includes(item.DVKHAC_ID) ? 'Su dung' : '',
            HTML_DANGKY: htmlDangKy,
            HTML_HUY: item.DANGKY == 0 ? '<div class="check-action"><input disabled type="checkbox" id="H_${item.DVKHAC_ID}" class="check"><span class="name"></span></div>' : '<div class="check-action"><input type="checkbox" id="H_${item.DVKHAC_ID}" class="check"><span class="name"></span></div> '
          }
        })
        // this.dsDvMaster = rs.data.map(item => {
        //   let htmlDangKy =  `<div class="check-action">
        //     <input type="checkbox" id="DK_${item.DVKHAC_ID}" class="check"`
        //   if(item.DANGKY != 0) htmlDangKy+= disabled;
        //   if(dsDvKhacChoseId.includes(item.DVKHAC_ID)) htmlDangKy+= checked;
        //   htmlDangKy+=`><span class="name"></span></div>`;
        //   return {
        //   ...item,
        //   TRANGTHAI: dvUsing.includes(item.DVKHAC_ID) ? 'Su dung': '',
        //   HTML_DANGKY: htmlDangKy,
        //   HTML_HUY: item.DANGKY == 0 ? '<div class="check-action"><input disabled type="checkbox" id="H_${item.DVKHAC_ID}" class="check"><span class="name"></span></div>' : '<div class="check-action"><input type="checkbox" id="H_${item.DVKHAC_ID}" class="check"><span class="name"></span></div> '
        //   }});
      } catch (error) {
        throw error
      }
    },
    async SaveClicked() {
      this.loading(true)
      var tab = this.currentTab + ''
      try {
        var dichvuvt_id = this.listbox.dichvu_vt.value
        if (dichvuvt_id == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          if (
            !this.thongso_ban.muccuoctb_id ||
            !this.thuebao.tsl.thongso_tc_dau.muccuoctb_id ||
            !this.thuebao.tsl.thongso_tc_cuoi.muccuoctb_id
          ) {
            this.$toast.error('Bạn cần chọn các thông số kỹ thuật bằng cách chọn thông số đầu, thông số cuối !')
            return
          }
        } else if (dichvuvt_id != DichVuVienThong.DICHVU_CNTT && dichvuvt_id != DichVuVienThong.TRUNGTAM_DULIEU && dichvuvt_id != DichVuVienThong.HOINGHI_TRUYENHINH && dichvuvt_id != DichVuVienThong.ANTOAN_BAOMAT_TT) {
          if (!this.thongso_ban.muccuoctb_id || !this.thongso_tc.muccuoctb_id) {
            this.$toast.error('Bạn cần chọn các thông số kỹ thuật bằng cách chọn lại kiểu yêu cầu !')
            return
          }
        } else {
          //FIXME phan nay chua xu ly
          if (!this.thongso_ban.thongso_cntt) {
            this.$toast.error('Bạn cần chọn các thông số kỹ thuật bằng cách chọn lại kiểu yêu cầu !')
            return
          }
        }

        if (
          //Khi tạo mới hđ lắp mới FTTH, nếu tham số PHAI_CHON_KETCUOI_TAI_GD_KHI_LAP_MOI=1 thì bắt buộc GDV phải chọn kết cuối cho thuê bao mới được ghi lại.
          this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH &&
          //&& IS_HD_TUVAN
          !this.buttons.tsbtnNhapMoi &&
          this.KetCuoi_ID == -1
        ) {
          var dsTS = await API.post_lay_ds_thamso_md_mats(this.axios, { ma_ts: 'DONGBO_GOI_DA_DV' })
            .then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') return response.data.data.ten_ts ? response.data.data.ten_ts * 1 : -1
              else {
                this.$toast.error(response.data.message + ': ' + response.data.message_detail)
                return -1
              }
            })
            .catch(() => {
              return -1
            })
          if (dsTS == '1') {
            this.$toast.error('Chưa chọn kết cuối cho thuê bao.\r\nTrợ giúp: Chọn địa chỉ lắp đặt->Nhấn nút [Vị trí]->chọn 1 kết cuối từ bản đồ cho thuê bao.')
            return
          }
        }

        //TODO validate khac line 17432 - 17499
        await this.CapNhat()
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      } finally {
        this.loading(false)
        this.currentTab = tab
      }
    },
    async CapNhat() {
      var async_status = false
      this.thuebao.statusVdc = false
      var tocdotn_id = 0
      var muccuoctn_id = 0
      var KT_KVNLML = 1
      var KIEMTRA_DK_APDUNG = 'nok'

      if ([DichVuVienThong.ADSL, DichVuVienThong.MEGA_EYES, DichVuVienThong.BRCD_DOITAC, DichVuVienThong.ANTOAN_BAOMAT_TT, DichVuVienThong.TRUNGTAM_DULIEU, DichVuVienThong.DICHVU_CNTT, DichVuVienThong.HOINGHI_TRUYENHINH].indexOf(this.listbox.dichvu_vt.value * 1) >= 0) {
        tocdotn_id = this.listbox.cboGoiCuocAdsl.value
        if (
          this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_MYTV &&
          this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_MYTV_B2B &&
          this.listbox.dichvu_vt.value != DichVuVienThong.HOINGHI_TRUYENHINH &&
          this.listbox.dichvu_vt.value != DichVuVienThong.ANTOAN_BAOMAT_TT &&
          this.listbox.dichvu_vt.value != DichVuVienThong.TRUNGTAM_DULIEU &&
          this.listbox.dichvu_vt.value != DichVuVienThong.DICHVU_CNTT &&
          this.listbox.dichvu_vt.value != DichVuVienThong.BRCD_DOITAC &&
          this.listbox.dichvu_vt.value != DichVuVienThong.MEGA_EYES &&
          this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_SGTV &&
          this.listbox.loaihinh_tb.value != LoaiHinhTB.HTVC_FIBERVNN_ANALOG &&
          this.listbox.loaihinh_tb.value != LoaiHinhTB.HTVC_FIBERVNN_DIGITAL
        ) {
          muccuoctn_id = this.listbox.muccuoc.value
        }
      } else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) {
        tocdotn_id = this.listbox.cboGoiCuocAdsl.value
      } else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
        tocdotn_id = this.listbox.tocdokenh.valuetsl //Convert.ToInt32(cboTocDoKenhTSL.EditValue);
      } else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
        tocdotn_id = this.listbox.tocdokenh.valuecir //Convert.ToInt32(cboTocDo.EditValue);
      }

      // #region "KiemTra + LayDL"
      if ((this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B) && this.thamsomacdinh['MYTV_HOA'] == 1) this.thuebao.adsl.txtAccountADSL = this.thuebao.adsl.txtAccountADSL.toUpperCase()

      if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) {
        await this.btnKiemTraAccount_Click()
        if (!this.thuebao.adsl.validadslacc) return
        //Bo qua doan Line 8044 - 8072, chac da gop o phan check???
      }
      // TODO validate du lieu line 7625 - 7627
      if (!this.ngaySinhChanged()) return
      if (!(await this.KiemTraDL_KhachHang())) return
      if (!(await this.KiemTraDL_ThanhToan())) return
      // if (!this.KIEMTRA_DL_HRM(1)) return;
      if (!(await this.KiemTraDL_ThueBao(this.buttonSet == 1))) return
      //Hiếu kiểm tra xem, nếu chọn khuyến mại thì dskm_hdtb pải >0 - 23.09.2010
      // if (!KiemTraDL_KhuyenMai()) return;
      //BUG mot so tham so chua co thong tin
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.dichvu_vt.value == DichVuVienThong.HATANG_VIENTHONG) {
        if (this.buttons.tsbtnNhapMoi == false) this.SinhMaDVVT_BC()

        if (this.thamsomacdinh['FIBER_HOA'] == 1) this.thuebao.adsl.txtAccountADSL = this.thuebao.adsl.txtAccountADSL.toUpperCase()
      }

      await this.LayMaTB(this.buttonSet == 1) //line 7642
      await this.LayMaTBBC(this.buttonSet == 1)

      //Doan nay giua phan laymatb va phan check dungthu
      // #region kiemtra khach hang web
      // if (this.ts_kt_tthdkhdn == 1 && this.kiemtra_nhanvien_vti != 1) {
      if(this.$root.token.getPhanVungID() == 97 || this.$root.token.getPhanVungID() == 100) {
        var ShowError = true
        var ds_1 = await bancheo.LAY_MA_KH_WEB(this.khachhang.makh ? this.khachhang.makh.trim() : '')
        if (ds_1 && ds_1.length > 0) {
          for (var i = 0; i < ds_1.length; i++)
            if (ds_1[i]['ma_kh'] == this.khachhang.makh ? this.khachhang.makh.trim() : '') {
              ShowError = false
              break //them cho dung logic, can test lai
            }
          if (ShowError) {
            var dss = await API.get_lay_tt_khdn_theo_makh(this.axios, {params: {ma_kh:this.khachhang.makh}}).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data;
              }
              else return [];
            }).catch(()=>{ return []; });
            if(!dss || dss.length<=0) {
              this.$toast.error('Hãy chọn 1 khách hàng từ web')
              return
            }
          }
        } else {
          var dss = await API.get_lay_tt_khdn_theo_makh(this.axios, {params: {ma_kh:this.khachhang.makh}}).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data;
            }
            else return [];
          }).catch(()=>{ return []; });
          if(!dss || dss.length<=0) {
            this.$toast.error('Hãy chọn 1 khách hàng từ web')
            return
          }
        }
      }

      // #endregion
      try {
        // TraCuuChungFacade TCChung = new TraCuuChungFacade();
        var tongno = await bancheo.TRACUUNO_KHACHHANG(this.khachhang.khachhang_id)
        if (tongno > 0) {
          if (
            (await this.$confirm(`Khách hàng: ${this.khachhang.makh} vẫn còn nợ: ${tongno} (VNĐ). Bạn có muốn tiếp tục lập hợp đồng?`, 'Thông báo', {
              confirmButtonText: 'Đồng ý',
              cancelButtonText: 'Hủy'
            }).then(async () => {
              return 'Yes'
            })) != 'Yes'
          )
            return
        }
        var batbuoc_sothang_ck = this.thamsomacdinh['BATBUOC_SOTHANG_CK']
        if (batbuoc_sothang_ck && batbuoc_sothang_ck == 1) {
          if (!this.thuebao.thangck || this.thuebao.thangck == 0) {
            //(txtSoThangCK.Text == "" || txtSoThangCK.Text == "0")
            if (
              (await this.$confirm(`Hợp đồng chưa nhập số tháng cam kết. Bạn có muốn tiếp tục?`, 'Thông báo', {
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Hủy'
              }).then(async () => {
                return 'Yes'
              })) != 'Yes'
            )
              return
          }
        }
      } catch (ex) {
        if (this.debug) console.error(ex)
      }

      try {
        if (this.listbox.doituong.value == DUNG_THU.DOITUONG_TB) {
          var ktraDungThu = await API.kiemtra_tao_hopdong_dungthu_v2(this.axios, {
            vloaitb_id: this.listbox.loaihinh_tb.value,
            vloaikh_id: this.listbox.loai_kh.value,
            vkhachhang_id: this.khachhang.khachhang_id
          }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data
              }
              else return response.data.message + ": "+response.data.message_detail;
            }).catch(()=>{ return "ok"}); //thanhtoan.Kiemtra_tao_hopdong_dungthu_v2(Convert.ToInt32(cboLoaiKH.EditValue), Convert.ToInt32(cboLoaihinhTB.SelectedValue), khachhang_id);
          if (ktraDungThu != 'ok') {
            this.$toast.error(ktraDungThu)
            return
          }
          var thamso_doituong_ct = this.thamsomacdinh['CHON_DOITUONG_CHINHTHUC']
          if (thamso_doituong_ct && thamso_doituong_ct == 1) {
            var dulieu = {}
            dulieu.ds = {}
            dulieu.ds.list = await API.post_sp_lay_doituong_tb(this.axios, { nguoidung_id: this.$root.token.getNhanVienID() }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data
              }
              else return [];
            }).catch(()=>{ return []});
            dulieu.ds.value = this.thuebao.doituong_ct_id
            dulieu.ds.textcol = 'ten_dt'
            dulieu.ds.valuecol = 'doituong_id'
            dulieu.tieudebang = 'Thông tin thuê bao'
            dulieu.tieude = 'CHỌN ĐỐI TƯỢNG CHÍNH THỨC'
            dulieu.allowExit = true
            this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonComboBox')
            this.popupComponentName = 'frmChonDoiTuong_CT'
            this.popupComponentData = dulieu
            this.Popup('popupComponents')
            this.popupRetVal = null
            while(true) {
              await waitUntil(()=>this.popupRetVal!=null)
              if (this.popupRetVal == 0) {
                this.popupRetVal = null
                this.$toast.error('Hãy chọn đối tượng thuê bao sau dùng thử!')
                dulieu.ds.value = this.thuebao.doituong_ct_id
                this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonComboBox')
                this.popupComponentName = 'frmChonDoiTuong_CT'
                this.popupComponentData = dulieu
                this.Popup('popupComponents')
                continue
              }
              if (this.popupRetVal == DUNG_THU.DOITUONG_TB) {
                this.popupRetVal = null
                this.$toast.error('Hãy chọn đối tượng thuê bao khác "Thuê bao dùng thử"')
                dulieu.ds.value = DUNG_THU.DOITUONG_TB
                this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonComboBox')
                this.popupComponentName = 'frmChonDoiTuong_CT'
                this.popupComponentData = dulieu
                this.Popup('popupComponents')
                continue
              }
              if (this.popupRetVal == -1) break
              if (typeof this.popupRetVal == 'object' && Object.keys(this.popupRetVal) && Object.keys(this.popupRetVal).length == 0) break
              this.thuebao.doituong_ct_id = this.popupRetVal
              break
            }
          }
        }
      } catch (Exception) {}
      //HET doan giua laymatb va phan check dungthu

      var j_loaikenh_id = 0
      if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) j_loaikenh_id = this.listbox.loaikenh.value
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) j_loaikenh_id = this.listbox.loaikenh.valuetsl
      else j_loaikenh_id = 0
      if (this.vkenh_toantrinh == 1) j_loaikenh_id = 8;//LOAIKENH.NOIHAT;
      //BATBUOC_GHEP_MATT dong 7956
      var pdata = {
        KHACHHANG_ID: this.khachhang.khachhang_id,
        DOITUONG_ID: this.listbox.doituong.value,
        LOAIKH_ID: this.listbox.loai_kh.value,
        LOAITB_ID: this.listbox.loaihinh_tb.value,
        HDKH_ID: this.khachhang.hdkh_id,
        JS_TRATRUOC: [],
        JS_LIST: [],
        JS_MUA_TBI: [],
        THEMMOI: this.buttonSet == 1,
        KIEULD_ID: this.listbox.kieu_ld.value,
        SOMAY_CD: this.thuebao.codinh.somay,
        DICHVUVT_ID: this.listbox.dichvu_vt.value,
        TINHKHAC: this.thuebao.tinhkhac,
        MA_TB_HT: this.ma_tb_ht, //this.thuebao.codinh.somay, //FIXME khong phai codinh thi xu ly the nao???
        TTND_DVI: 1,
        TUDONG_SINH_SOAO: this.TUDONG_SINH_SOAO ? 1 : 0,
        MA_TB_AO_HT: this.ma_tb_ao_ht,
        MA_TB_AO_HT_CUOI: this.ma_tb_ao_ht_cuoi,
        SOAO_ADSL: this.thuebao.adsl.txtSoAoAdsl, //this.ma_tb_ao
        SOAO_TSL_DAU: this.thuebao.tsl.txtSoAoTSL_Dau,
        SOAO_TSL_CUOI: this.thuebao.tsl.txtSoAoTSL_Cuoi,
        SOAO_WAN: '',
        OPEN_SYNC_VINA_TRASAU: TRANGTHAI_DONGBO.OPEN_SYNC_VINA_TRASAU ? 1 : 0,
        MA_TT: this.thanhtoan.matt ? this.thanhtoan.matt : null,
        BATBUOC_GHEP_MATT: this.thamsomacdinh['BATBUOC_GHEP_MATT'] == 1,
        KIEMTRA_GHEP_MATT_CNTT: this.thamsomacdinh['KIEMTRA_GHEP_MATT_CNTT'] == 1,
        TOCDOTN_ID: tocdotn_id,
        MUCCUOCTN_ID: muccuoctn_id,
        HDKH_CHA_ID: this.hdkh_cha_id,
        HDTB_ID: this.hdtb_id,
        TRANGBI_ID: this.listbox.trangbi.valuecd, // FIXME neu khong phai CO_DINH thi cho nay xu ly the nao????
        KETCUOI_ID: this.KetCuoi_ID,
        GOICUOCADSL: this.listbox.cboGoiCuocAdsl.value,
        OPEN_SYNC_VINA: TRANGTHAI_DONGBO.OPEN_SYNC_VINA ? 1 : 0,
        GOICUOCDD_ID: 0, //TODO 2 dong nay chua lam vi chua lam phan di dong
        LOAI_TB_DD: this.thuebao.didong.LOAI_TB_DD,
        QUANLD_ID: this.diachiLD.QUAN_ID ? this.diachiLD.QUAN_ID : 0,
        PHUONGLD_ID: this.diachiLD.PHUONG_ID ? this.diachiLD.PHUONG_ID : 0,
        PHOLD_ID: this.diachiLD.PHO_ID ? this.diachiLD.PHO_ID : 0,
        APLD_ID: this.diachiLD.AP_ID ? this.diachiLD.AP_ID : 0,
        KHULD_ID: this.diachiLD.KHU_ID ? this.diachiLD.KHU_ID : 0,
        DACDIEMLD_ID: this.diachiLD.DACDIEM_ID ? this.diachiLD.DACDIEM_ID : 0,
        LAT_LD: this.diachiLD.Lat ? this.diachiLD.Lat : null, //0 se hien thong bao loi, null de bo qua
        LNG_LD: this.diachiLD.Lng ? this.diachiLD.Lng : null, //0 se hien thong bao loi, null de bo qua
        DONVI_QL_ID: this.listbox.donvi_ql.value ? this.listbox.donvi_ql.value : 0,
        NGAY_YC: this.NgayYeuCau,
        MA_GD: this.khachhang.magd,
        MA_TB: this.ma_tb ? this.ma_tb : this.khachhang.makh, //this.ma_tb?this.ma_tb:this.thuebao.codinh.somay, phia duoi dang gan this.khachhang.makh chay OK nen de o day. Code dung kha nang la phai nhu phan comment nay!
        FIBER_BS: 0,
        CONGNGHE_ID: this.listbox.congnghe.value == 0 ? null : this.listbox.congnghe.value,
        MATB_TN: this.thuebaocd.matn ? this.thuebaocd.matn.trim() : null,
        CBO_TT: this.listbox.thanhtoancbo.value,
        SL_TT: this.lvwThueBao.filter((x) => x.ten_dvvt == DichVuVienThong.DI_DONG).length,
        LOAIKENH_ID: j_loaikenh_id,
        BANCHEO: 1
      }
      var checkloi = false
      var KQ_DB_DL = null
      var dulieuapi = {}
      await API.post_fn_kt_laytt_capnhat_datmoi(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          dulieuapi = JSON.parse(response.data.data)
          if (dulieuapi['ERROR_CODE'] != 1) {
            this.$toast.error(dulieuapi['MESSAGE'])
            checkloi = true
            return
          }
          if (dulieuapi['RESULT']) dulieuapi = dulieuapi['RESULT']
          if (dulieuapi['KT_KV_NLML']) KT_KVNLML = dulieuapi['KT_KV_NLML']
          if (KT_KVNLML && KT_KVNLML != 'ok' && KT_KVNLML != 1) {
            let cfr = await this.$bvModal
              .msgBoxConfirm(`${KT_KVNLML + ''} "\r\nBạn có muốn thay đổi địa chỉ để tiếp tục?`, {
                title: 'Thông báo',
                size: 'sm',
                okTitle: 'Đồng ý',
                cancelTitle: 'Hủy'
              })
              .then((v) => {
                return v
              })
            if (cfr) {
              if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
                // VDCService vdc = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
                // vdc.HuyDatChoMegaVNN(txtAccountADSL.Text);
                await vdc.HuyDatChoMegaVNN(this.thuebao.adsl.txtAccountADSL)
              }

              // this.buttonSet = 0

              // this.$toast.success('Hợp đồng đã được thoái trả. Khách hàng sẽ được đưa vào danh sách Khách hàng tiềm năng!')
              checkloi = true;
              return 'err'
            } else KT_KVNLML = 0
          } else KT_KVNLML = 1
          if (dulieuapi['KIEMTRA_DK_APDUNG']) KIEMTRA_DK_APDUNG = dulieuapi['KIEMTRA_DK_APDUNG']
          if (dulieuapi['KQ_DB_DL']) KQ_DB_DL = dulieuapi['KQ_DB_DL']
        }
      })
      if (checkloi) return //FIXME tam dong de test
      // trien khai luon phan LayMaTB:
      // this.ma_tb_ht = this.thuebao.codinh.somay;
      // switch(this.listbox.dichvu_vt.value) {
      //   case DichVuVienThong.CO_DINH:
      //     this.ma_tb_ht = this.thuebao.codinh.somay;
      //     break;
      // }
      // TODO validate du lieu line 7650 - 7687

      //FIXME Move trong IF ra day vi dung chung cho ca case update & insert
      if (dulieuapi['DS_HUONGGIAO_TN'] && dulieuapi['DS_HUONGGIAO_TN'].QUYTRINH_ID) {
        // Them 16/9, khong hieu sao lai tra ve tu phía trên mà không cần gọi phần bên dưới????
        if (dulieuapi['DS_HUONGGIAO_TN'].QUYTRINH_ID) this.quytrinh_tn = dulieuapi['DS_HUONGGIAO_TN'].QUYTRINH_ID
        if (dulieuapi['DS_HUONGGIAO_TN'].LUONG_ID) this.luong_id = dulieuapi['DS_HUONGGIAO_TN'].LUONG_ID
        if (dulieuapi['DS_HUONGGIAO_TN'].HUONGGIAO_ID) this.huonggiao_tn = dulieuapi['DS_HUONGGIAO_TN'].HUONGGIAO_ID
      } else {
        var pdata = {
          kieuLdId: this.listbox.kieu_ld.value,
          loaiHdId: this.buttonSet == 1 ? LoaiHopDong.DAT_MOI : '1',
          loaiTbId: this.listbox.loaihinh_tb.value,
          mucCuocId: this.listbox.muccuoc.value && this.listbox.muccuoc.value > 0 ? this.listbox.muccuoc.value : -1,
          tocDoId: -1
        }
        await API.post_lay_huonggiao_tiepnhan(this.axios, pdata).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            var dlapi = response.data.data
            if (dlapi['huonggiao_id']) this.huonggiao_tn = dlapi['huonggiao_id']
            if (dlapi['quytrinh_id']) this.quytrinh_tn = dlapi['quytrinh_id']
            if (dlapi['luong_id']) this.luong_id = dlapi['luong_id']
          }
        })
      }
      if (this.buttonSet == 1) {
        // THemmoi
        // Dat cho tren VISA
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL) {
          var loaihinh_tb = this.listbox.loaihinh_tb.value
          if (loaihinh_tb == LoaiHinhTB.INTERNET_1260 || loaihinh_tb == LoaiHinhTB.INTERNET_ADSL || loaihinh_tb == LoaiHinhTB.INTERNET_FTTH || loaihinh_tb == LoaiHinhTB.WIFI_FIBER) {
            if (this.DONGBO_TEST.TEST == false) {
              // VDCService vdcService = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
              var account = this.dsHDTB[0]['MA_TB']
              var contex = this.ma_lhtb_vdc //objCheckData.MAP_ID("ma_lhtb_vdc", DatabaseConstants.DB2 + ".loaihinh_tb", "where loaitb_id =" + cboLoaihinhTB.SelectedValue.ToString());
              var pdata = {
                accountModel: { accountName: account }
                //"reservemodel": { "context":contex, "reservedTime": "2022-01-11" } //Bỏ do VISA default vào FTTH rồi
              }
              await API.post_reserveRASAccount(this.axios, pdata).then((response) => {
                if (response && response.data && response.data.data && response.data.errorCode != 1) this.thuebao.statusVdc = response.data.data == 'ok'
                else this.$toast.error(response.data.faultCode + ': ' + response.data.faultString)
              })
              if (!this.thuebao.statusVdc) {
                this.$toast.error('Có lỗi xảy ra trong quá trình đặt chỗ Account ' + account + ' lên Visa.Bạn hãy vui lòng thực hiện lại chức năng này!')
                return
              }
              this.thuebao.check_tb_adsl = true //Hiếu thêm biến kiểm tra thuê bao ADSL đã được đặt chỗ hay chưa. 5.10.2010
            } else {
              this.thuebao.statusVdc = true
              this.thuebao.check_tb_adsl = true
            }
          }
        }
        // Kich hoat dang ky len he thong Camera
        if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) {
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGACAMERA) {
            if (!this.DONGBO_TEST.TEST) {
              var matinh = this.$root.token.getMaTinh()
              // CameraService camera = new CameraService();
              var city_id = matinh
              var agent_id = matinh
              var customer_id = this.dsHDKH[0]['MA_KH']
              var subscription_id = 0
              var integrated_services
              var message = ''
              var kieu = await API.post_fn_tt_kieu_ld(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, param: this.thongso_tc.kieuld_id })
                .then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    return response.data.data
                  } else return 0
                })
                .catch(() => {
                  return 0
                }) //this.kieu_ld_kieu;
              if (kieu == 1 || kieu == 2 || kieu == 3) {
                integrated_services = 0
              } else integrated_services = 1

              var username = this.dsHDTB[0]['MA_TB']
              var password = this.dsHDTB_ADSL[0]['PASSWORD']
              var email = this.dsHDTB_ADSL[0]['EMAIL']
              var pdata =
                '{"city_id":"' + city_id + '","agent_id":"' + agent_id + '","customer_id":"' + customer_id + '","subscription_id":"' + subscription_id + '","integrated_services":"' + integrated_services + '","username":"' + username + '","password":"' + password + '","email":"' + email + '"}'
              // var rs = await this.$root.context.post("http://vnptapi.iveda.com/index.php/api/add",JSON.parse(pdata));
              // message = JSON.parse(rs.data);
              // this.thuebao.statusVdc = (message.indexOf("resultid\":\"0")>=0)
              var rs = await this.$root.context.post('/tichhop/iveda/add', JSON.parse(pdata))
              message = rs.faultString + JSON.parse(rs.data)
              this.thuebao.statusVdc = rs.errorCode == 0 //(message.indexOf("resultid\":\"0")>=0)
              // this.thuebao.statusVdc = camera.ThemMoiKhachHang(city_id, agent_id, customer_id, subscription_id, integrated_services, username, password, email, ref message);
              if (!this.thuebao.statusVdc) {
                this.$toast.error('Có lỗi xảy ra trong quá trình kích hoạt lên hệ thống Camera.\nLỗi: ' + message)
                return
              }
              this.thuebao.check_tb_adsl = true //Hiếu thêm biến kiểm tra thuê bao ADSL đã được đặt chỗ hay chưa. 5.10.2010
            } else {
              this.thuebao.statusVdc = true
              this.thuebao.check_tb_adsl = true
            }
          }
        }
        // Dang ky UMP
        //FIXME can chuyen phan nay sang API
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
          if (this.listbox.loai_tb.valuemgwan == 157) {
            //Fix ID loại thiết bị STB UMP
            var rs = await this.$root.context.post('http://10.70.52.120:4740/api/RegisterUMP', { serialNumber: this.thuebao.adsl.txtSerialSTB, mytvUsername: this.dsHDTB[0]['MA_TB'], mytvPassword: this.dsHDTB[0]['PASSWORD'] })
            var kq = JSON.parse(rs.data)
            if (kq['Message']) kq = kq['Message']
            // bool kq = DangkyUMP(txtSerialSTB.Text.trim(), dsHDTB.Tables[0].Rows[0]["MA_TB"].ToString(), dsHDTB_ADSL.Tables[0].Rows[0]["PASSWORD"].ToString(), ref message);
            if (kq.status != 'success') {
              this.$toast.error('Có lỗi trong quá trình đẩy thông tin thiết bị lên UMP. Lỗi: ' + kq.message)
              return
            }
          }
        }
      } else {
        // #region Đặt chỗ lại cho Account ADSL
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL) {
          var loaihinh_tb = this.listbox.loaihinh_tb.value
          if (loaihinh_tb == LoaiHinhTB.INTERNET_1260 || loaihinh_tb == LoaiHinhTB.INTERNET_ADSL || loaihinh_tb == LoaiHinhTB.INTERNET_FTTH || loaihinh_tb == LoaiHinhTB.WIFI_FIBER) {
            if (this.DONGBO_TEST.TEST == false) {
              // VDCService vdcService = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
              var account = this.dsHDTB[0]['MA_TB'] + ''
              if (!account || account.trim().length == 0) {
                this.$toast.error('Account không được trống. Hãy kiểm tra lại!')
                // txtAccountADSL.Focus();
                return
              }
              var pdata = {
                accountModel: { accountName: account }
                //"reservemodel": { "context":contex, "reservedTime": "2022-01-11" } //Bỏ do VISA default vào FTTH rồi
              }
              this.thuebao.statusVdc = false
              await API.post_reserveRASAccount(this.axios, pdata).then((response) => {
                if (response && response.data && response.data.data && response.data.errorCode != 1) this.thuebao.statusVdc = response.data.data == 'ok'
                else this.$toast.error(response.data.faultCode + ': ' + response.data.faultString)
              })
              //if (!vdcService.DatChoLaiMegaVNN(account, dtpHanDatCho.Value))
              if (!this.thuebao.statusVdc) {
                this.$toast.error('Có lỗi xảy ra trong quá trình đặt chỗ lại cho Account ' + account + ' lên Visa.Bạn hãy vui lòng thử lại!')
                return
              } else {
                this.$toast.success('Đặt chỗ lại cho Account ' + account + ' lên Visa thành công!')
              }
            }
          }
        }
        // #region "Cập nhật UMP"
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
          if (this.listbox.loai_tb.valuemgwan == 157) {
            //Fix ID loại thiết bị STB UMP
            var rs = await this.$root.context.post('http://10.70.52.120:4740/api/UpdateUMP', { serialNumber: this.thuebao.adsl.txtSerialSTB, mytvUsername: this.dsHDTB[0]['MA_TB'], mytvPassword: this.dsHDTB[0]['PASSWORD'] })
            var kq = JSON.parse(rs.data)
            if (kq['Message']) kq = kq['Message']
            // var kq = CapNhatUMP(txtSerialSTB.Text.trim(), dsHDTB.Tables[0].Rows[0]["MA_TB"].ToString(), dsHDTB_ADSL.Tables[0].Rows[0]["PASSWORD"].ToString(), ref message);
            if (kq.status != 'success') {
              Message_Box.ShowWarning('Có lỗi trong quá trình cập nhật thông tin thiết bị lên UMP. Lỗi: ' + kq.message)
              return
            }
          }
        }

        if (TRANGTHAI_DONGBO.OPEN_SYNC_VINA) {
          // case update thi khong can dieu kien nay????
          // #region Đồng bộ lại dữ liệu lên VinaPhone
          if (this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG && this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRASAU) {
            //if (!KiemTra_HDLD_TBDD_TraTruoc()) return; // Thay bang xu ly API ben duoi
            var checkvnp = true
            await API.post_fn_kiemtra_hdld_tbdd_tratruoc(this.axios, {
              dichvuvt_id: this.listbox.dichvu_vt.value,
              goicuoc_dd: this.thuebao.didong.cboGoiCuocDD.value,
              kieuld_id: this.listbox.kieu_ld.value,
              loai_tb_dd: this.thuebao.didong.LOAI_TB_DD, //"MB - Tra truoc",
              ma_tb: this.ma_tb
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code == 'BSS-00000000' && response.data.data != 1) {
                this.$toast.error(response.data.data)
                checkvnp = false
              }
            })
            if (!checkvnp) return

            var matb_neo = this.dsHDTB[0]['ma_tb'] //CommonFunction.ChuanHoa_XML(dsHDTB.Tables[0].Rows[0]["ma_tb"].ToString());

            var ma_hd = this.dsHDKH[0]['ma_gd']
            //Nếu dữ liệu HĐ chưa được đồng bộ với VinaPhone ( status = 0).
            //Thực hiện Insert HD + TB lên VinaPhone và Update DB
            if (KQ_DB_DL && KQ_DB_DL == 0) {
              //Tạo mới hđ khách hàng.
              var rs = await this.Insert_HDLD_VinaPhone()
              if (rs != 'OK') {
                this.$toast.error(rs)
                return
              }
              //Tạo mới hđ thuê bao neu kieu ld la hoa mang moi, chuyen tinh thi ko can -- vuth update 0912
              if (this.dsHDTB[0]['kieuld_id'] == KieuLapDat.DM_DIDONG || this.dsHDTB[0]['kieuld_id'] == KieuLapDat.DM_DIDONG_C_P) {
                rs = await this.Insert_TBLD_VinaPhone()

                if (rs == 'OK') {
                  //Doan nay da xu ly o API ins_upd ben duoi, khong can lam gi o day
                  // new LapHopDongFacade().CAPNHAT_STATUS_HDTB(hdtb_id, TRANGTHAI_DONGBO.DONGBO_LHD); // da xu ly
                  // txtStatus.Text = TRANGTHAI_DONGBO.DONGBO_LHD.ToString(); // thuoc phan CNTT???
                } else {
                  this.$toast.error('Có lỗi xảy ra trong quá trình thêm mới hợp đồng thuê bao di động trên VinaPhone.\n' + rs)

                  //nếu hđ trên CCBS chưa có thuê bao thì xóa cả HĐ.
                  var dsTB_TMP = [] //new CCBSFacade().TS_LAPHD_HOAMANGMOI_LAY_DS_THUEBAO(tt_nd.USER_NEO, ma_hd);
                  await API.post_ts_laphd_hoamangmoi_lay_ds_thuebao(this.axios, {
                    ma_tinh: this.tt_nd.tentat_ccbs,
                    ma_hd: ma_hd
                  }).then((response) => {
                    if (response && response.data && response.data.data && response.data.error_code == 'BSS-00000000' && response.data.data != 1) {
                      dsTB_TMP = response.data.data
                    }
                  })
                  //checking
                  if (!dsTB_TMP || dsTB_TMP.length == 0) {
                    var rsDel = await this.Delete_HDLD_VinaPhone(this.dsHDKH[0]['ma_gd'])
                    if (rsDel != 'OK') this.$toast.error(rsDel)
                  }
                  return
                }
              }
            } else {
              // Nếu đã có hợp đồng này trên VinaPhone rồi thì gọi hàm UpdateHD + UpdateTB
              //region vuth update 0912 cập nhật tùy theo hòa mạng mới, hay chuyển tỉnh
              if (this.dsHDTB[0]['kieuld_id'] == KieuLapDat.DM_DIDONG || this.dsHDTB[0]['kieuld_id'] == KieuLapDat.DM_DIDONG_C_P) {
                var rs = await this.Update_HDLD_VinaPhone()
                if (rs != 'OK') {
                  this.$toast.error(rs)
                  return
                }

                if (this.dsHDTB[0]['status'] == '1') {
                  //Cập nhật hđ thuê bao neu hdtb da dong bo 0306
                  rs = await this.Update_TBLD_VinaPhone()

                  if (rs != 'OK') {
                    this.$toast.error(rs)
                    return
                  }
                } else if (this.dsHDTB[0]['status'] == '0') {
                  // insert neu hdtb chưa đồng bọ 0306
                  rs = await this.Insert_TBLD_VinaPhone()
                  if (rs != 'OK') {
                    this.$toast.error(rs)
                    return
                  }
                  //Khong can xu ly cho nay vi da lam o ins_upd
                  // new LapHopDongFacade().CAPNHAT_STATUS_HDTB(hdtb_id, TRANGTHAI_DONGBO.DONGBO_LHD);
                }
              } else if (this.dsHDTB[0]['kieuld_id'] == KieuLapDat.DM_DIDONG_CHUYEN_TINH) {
                var rs = await this.Update_HD_ChuyenTinh_Vinaphone()
                if (rs != 'OK') {
                  this.$toast.error(rs)
                  return
                }
              }
            }
          }
        }
      }

      if (this.buttonSet == 1) {
        //Nhap du lieu moi INSERT
        var validateValue = null
        if (this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_DC || this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_TL) {
          validateValue = await API.post_fn_kiemtra_ma_tb_thueso(this.axios, {
            dichvuvt_id: this.listbox.dichvu_vt.value,
            loaihd_id: LoaiHopDong.DAT_MOI,
            ma_gd: this.khachhang.magd ? this.khachhang.magd : '',
            ma_tb: this.ma_tb ? this.ma_tb : '',
            phanvung_id: this.$root.token.getPhanVungID()
          })
            .then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data
              }
            })
            .catch(() => {
              return null
            })
          if (validateValue != 'OK') return
        }

        var ds = await API.post_layhuonggiao_tiepnhan_v2(this.axios, {
          dichvuvt_id: this.listbox.dichvu_vt.value,
          kieuld_id: this.listbox.kieu_ld.value,
          loaihd_id: LoaiHopDong.DAT_MOI,
          loaikenh_id: j_loaikenh_id,
          loaitb_id: this.listbox.loaihinh_tb.value,
          muccuoc_id: muccuoctn_id ? muccuoctn_id : 0,
          phanvung_id: this.$root.token.getPhanVungID(),
          tocdo_id: this.tocdo_id ? this.tocdo_id : 0
        })
          .then(async (response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            }
          })
          .catch(() => {
            return []
          }) //bangts.LayHuongGiao_TiepNhan_V2(LoaiHopDong.DAT_MOI, Convert.ToInt32(cboLoaihinhTB.SelectedValue),
        //tocdotn_id, muccuoctn_id, Convert.ToInt32(cboKieuLD.SelectedValue), j_loaikenh_id, this.listbox.dichvu_vt.value);

        this.huonggiao_tn = 0
        this.quytrinh_tn = 0

        if (!ds || ds.length <= 0) {
          this.$toast.error('Nghiệp vụ này chưa được thiết lập quy trình. Bạn hãy liên hệ Admin để xử lý!')
          return
        }
        this.huonggiao_tn = ds[0]['huonggiao_id']
        this.quytrinh_tn = ds[0]['quytrinh_id']

        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          // Lấy hướng giao, quy trình tại điểm đầu
          var rs_qt_dau = await bancheo.LayHuongGiao_TiepNhan(this.thuebao.tsl.tinh_dau.tinhthicong_id, LoaiHopDong.DAT_MOI, this.listbox.loaihinh_tb.value, this.thuebao.tsl.thongso_tc_dau.tocdo_id, this.thuebao.tsl.thongso_tc_dau.muccuoc_id, this.thuebao.tsl.thongso_tc_dau.kieuld_id)

          if (!rs_qt_dau || rs_qt_dau.length <= 0) {
            this.$toast.error('Nghiệp vụ này chưa được thiết lập quy trình ở tỉnh Thi Công điểm đầu. Liên hệ Admin để xử lý')
            return
          }
          this.thuebao.tsl.quytrinh_tc_tn_dau = 0
          this.thuebao.tsl.huonggiao_tc_tn_dau = 0
          this.thuebao.tsl.quytrinh_tc_tn_dau = rs_qt_dau[0]['quytrinh_id'] * 1
          this.thuebao.tsl.huonggiao_tc_tn_dau = rs_qt_dau[0]['huonggiao_id'] * 1

          // Lấy hướng giao, quy trình tại điểm cuối
          var rs_qt_cuoi = await bancheo.LayHuongGiao_TiepNhan(this.thuebao.tsl.tinh_cuoi.tinhthicong_id, LoaiHopDong.DAT_MOI, this.listbox.loaihinh_tb.value, this.thuebao.tsl.thongso_tc_cuoi.tocdo_id, this.thuebao.tsl.thongso_tc_cuoi.muccuoc_id, this.thuebao.tsl.thongso_tc_cuoi.kieuld_id)
          if (!rs_qt_cuoi || rs_qt_cuoi.length <= 0) {
            this.$toast.error('Nghiệp vụ này chưa được thiết lập quy trình ở tỉnh Thi Công điểm cuối. Liên hệ Admin để xử lý')
            return
          }
          this.thuebao.tsl.quytrinh_tc_tn_cuoi = 0
          this.thuebao.tsl.huonggiao_tc_tn_cuoi = 0
          this.thuebao.tsl.quytrinh_tc_tn_cuoi = rs_qt_cuoi[0]['quytrinh_id']
          this.thuebao.tsl.huonggiao_tc_tn_cuoi = rs_qt_cuoi[0]['huonggiao_id']
        } else {
          // Lấy hướng giao, quy trình tại tỉnh lắp đặt
          var rs_qt = await bancheo.LayHuongGiao_TiepNhan(this.tinh.tinhthicong_id, LoaiHopDong.DAT_MOI, this.listbox.loaihinh_tb.value, this.thongso_tc.tocdo_id, this.thongso_tc.muccuoc_id, this.thongso_tc.kieuld_id)
          if (!rs_qt || rs_qt.length <= 0) {
            this.$toast.error('Nghiệp vụ này chưa được thiết lập quy trình ở tỉnh Thi Công. Liên hệ Admin để xử lý')
            return
          }
          this.quytrinh_tc_tn = 0
          this.huonggiao_tc_tn = 0
          this.quytrinh_tc_tn = rs_qt[0]['quytrinh_id']
          this.huonggiao_tc_tn = rs_qt[0]['huonggiao_id']
        }
        await this.TaoDuLieu(this.buttonSet == 1)

        var isvalid = true
        document.querySelectorAll('.main-wrapper .page-content input').forEach((item) => {
          if (isvalid && !item.validity.valid) {
            isvalid = false
            this.$toast.error(item.getAttribute('title'))
            item.focus()
          }
        })
        if (!isvalid) return

        if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH || this.listbox.dichvu_vt.value == DichVuVienThong.GPHONE || this.listbox.dichvu_vt.value == DichVuVienThong.IMS) {
          var d = this.tinh.mavung.length - 1
          var kt_matb = this.ma_tb_ht.substring(d) //this.ma_tb_ht.substring(d, this.ma_tb_ht.length - d);

          if (!(await bancheo.KIEMTRA_MATB_KHOSO(this.tinh.tinhthicong_id, kt_matb, this.listbox.dichvu_vt.value)) && this.ma_tb_ht) {
            this.$toast.error('Số máy chưa có trong kho số !')
            // MaTB_Focus();
            return
          }
        }
        // validate so da cap hay chua
        const ktramatb = await bancheo.KIEMTRA_MATB(this.listbox.dichvu_vt.value, this.ma_tb_ht)
        if (ktramatb == 0) {
          if (this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_DC || this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_TL) {
            // hoangpkn : 10/04/2015   chưa biết code gì vào đây
          } else {
            this.$toast.error('Số máy hoặc Account đã được cấp !')
            // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
            await bancheo.CAPNHAT_KHOSO(this.ma_tb_ht, '', this.listbox.dichvu_vt.value, this.tt_nd.donvi_id)
            // MaTB_Focus();
            return
          }
        }

        //HungHM - 18/08/2010 - Kiểm tra mã thuê bao TSL
        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          if (!this.thuebao.tsl.txtMaTSL.Text || this.thuebao.tsl.txtMaTSL.Text.trim().length == 0) {
            // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
            this.$toast.error('Hãy nhập địa chỉ thuê bao để sinh mã thuê bao truyền số liệu !')
            // btnDiaChiTB.Focus();
            return
          }
          if (!this.TUDONG_SINH_SOAO) {
            //KNV:16/08/2016: Nếu thiết lập sinh số ảo tự động thì ko cần kiểm tra
            if (!(await bancheo.KIEMTRA_MATB_KHOSO_AO(this.ma_tb_ao_ht))) {
              // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
              this.$toast.error('Số ảo chưa có trong kho số hoặc chưa chọn số ảo cho điểm đầu !')
              // txtSoAoTSL_Dau.Focus();
              return
            }
            if (!(await bancheo.KIEMTRA_MATB_KHOSO_AO(this.ma_tb_ao_ht_cuoi))) {
              // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
              this.$toast.error('Số ảo chưa có trong kho số hoặc chưa chọn số ảo cho điểm cuối !')
              // txtSoAoTSL_Cuoi.Focus();
              return
            }
          }
        }
        if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM)
          if (!this.TUDONG_SINH_SOAO) {
            //KNV:16/08/2016: Nếu thiết lập sinh số ảo tự động thì ko cần kiểm tra
            if (!(await bancheo.KIEMTRA_MATB_KHOSO_AO(this.ma_tb_ao_ht))) {
              // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
              this.$toast.error('Số ảo chưa có trong kho số hoặc chưa chọn số ảo !')
              // txtSoAoWan.Focus();
              return
            }
          }

        //TuanNA: Thêm hàm kiểm tra số ảo đã được chọn cho thuê bao khác chưa -- ngày 12/02/2014
        // hàm trả về == 1 : số ảo đã được chọn cho thuê bao khác
        // hàm trả về == 0 : số ảo chưa chọn cho thuê bao nào, có thể sử dụng
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) {
          var ds_soao = await bancheo.LAY_DS_THUEBAO_THEO_MALT(this.thuebao.adsl.txtSoAoAdsl ? this.thuebao.adsl.txtSoAoAdsl.trim() : '', 0)

          if (ds_soao && ds_soao.length > 0) {
            this.$toast.error('Số ảo đã được chọn cho thuê bao: ' + ds_soao[0]['ma_tb'] + '\nBạn hãy chọn số ảo khác!')
            // txtSoAoAdsl.Focus();
            return
          }
        } else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          var ds_soao = await bancheo.LAY_DS_THUEBAO_THEO_MALT(this.thuebao.tsl.txtSoAoTSL_Dau ? this.thuebao.tsl.txtSoAoTSL_Dau.trim() : '', 0)
          if (ds_soao && ds_soao.length > 0) {
            this.$toast.error('Số ảo điểm đầu đã được chọn cho thuê bao: ' + ds_soao[0]['ma_tb'] + '\nBạn hãy chọn số ảo khác!')
            // txtSoAoTSL_Dau.Focus();
            return
          }
          ds_soao = await bancheo.LAY_DS_THUEBAO_THEO_MALT(this.thuebao.tsl.txtSoAoTSL_Cuoi ? this.thuebao.tsl.txtSoAoTSL_Cuoi.trim() : '', 0)
          if (ds_soao && ds_soao.length > 0) {
            this.$toast.error('Số ảo điểm cuối đã được chọn cho thuê bao: ' + ds_soao[0]['ma_tb'] + '\nBạn hãy chọn số ảo khác!')
            // txtSoAoTSL_Cuoi.Focus();
            return
          }
        } else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
          var ds_soao = await bancheo.LAY_DS_THUEBAO_THEO_MALT(this.thuebao.mgwan.soao ? this.thuebao.mgwan.soao.trim() : '', 0)
          if (ds_soao && ds_soao.length > 0) {
            this.$toast.error('Số ảo đã được chọn cho thuê bao: ' + ds_soao[0]['ma_tb'] + '\nBạn hãy chọn số ảo khác!')
            // txtSoAoWan.Focus();
            return
          }
        }

        if (this.khachhang.khachhang_id != 0 && (!this.thanhtoan.matt || this.thanhtoan.matt.trim() == '')) {
          if (this.thamsomacdinh['BATBUOC_GHEP_MATT'] != 1) {
            //if (MessageBox.Show("Bạn thật sự muốn sinh mã thanh toán mới không ?", "Thông báo", MessageBoxButtons.YesNo, MessageBoxIcon.Information) != DialogResult.Yes)
            if (
              (await this.$confirm(`Bạn thật sự muốn sinh mã thanh toán mới không ?`, 'Thông báo', {
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Hủy'
              }).then(async () => {
                return 'Yes'
              })) != 'Yes'
            )
              return
          } else {
            this.$toast.error('Bạn phải ghép mã thanh toán')
            return
          }
        }

        //HungHM - 28/08/2010 Kiểm tra Account đã tồn tài trên Visa hay chưa?
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) {
          var loaihinh_tb = this.listbox.loaihinh_tb.value
          if (loaihinh_tb == LoaiHinhTB.INTERNET_1260 || loaihinh_tb == LoaiHinhTB.INTERNET_ADSL || loaihinh_tb == LoaiHinhTB.INTERNET_FTTH || loaihinh_tb == LoaiHinhTB.WIFI_FIBER) {
            const startOfDay = new Date()
            startOfDay.setUTCHours(0, 0, 0, 0)
            //Kiểm tra ngày đặt chỗ
            if (moment(this.thuebao.adsl.dtpHanDatCho, 'DD/MM/YYYY HH:mm:ss').toDate() < startOfDay) {
              // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
              this.$toast.error('Ngày đặt chỗ không được nhỏ hơn ngày hiện tại!')
              // dtpHanDatCho.Focus();
              return
            }
          }

          if (loaihinh_tb != LoaiHinhTB.INTERNET_ADSL_TINH_KHAC && loaihinh_tb != LoaiHinhTB.INTERNET_FIBER_TINH_KHAC) {
            if (!this.TUDONG_SINH_SOAO) {
              //KNV:16/08/2016: Nếu thiết lập sinh số ảo tự động thì ko cần kiểm tra
              if (!(await bancheo.KIEMTRA_MATB_KHOSO_AO(this.ma_tb_ao_ht))) {
                // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
                this.$toast.error('Số ảo chưa có trong kho số hoặc chưa chọn số ảo !')
                // txtSoAoAdsl.Focus();
                return
              }
            }
          }

          if (this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT || this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU || this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT || this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH) {
            for (var index = 0; index < this.gridEditors.length; ++index) {
              if (this.gridEditors[index].ID == 'MA_TB' && (!this.gridEditors[index].Value || this.gridEditors[index].Value == '')) {
                this.$toast.error('Liên hệ admin để kiểm tra lại mã thuê bao !')
                return
              }
            }
          }
        }

        //Tao du lieu LINE 8082
        if (this.loi_sinh_magd) {
          this.loi_sinh_magd = false
          return
        }
        if (DUNG_THU.DOITUONG_TB == this.listbox.doituong.value) {
          if (1 == 0) {
            // TODO if (!Kiemtra_dungthu_mytv())
            //TODO Lấy chi tiết khuyến mại dùng thử fill vào khuyenmai_hdtb chua lam do nam ngoai pham vi CD
          } else {
            //TODO xem lai, chua xac dinh muc dich xoa du lieu o day!
            this.dsKM_HDTB = this.dsKM_HDTB.filter((x) => !(x.khuyenmai_id == 2999 || x.khuyenmai_id == 2998))
            // var _arrKM_DT = this.dsKM_HDTB.filter(x=>x.khuyenmai_id==2999 || x.khuyenmai_id==2998);
            // if(_arrKM_DT)
            //   for(var item in _arrKM_DT)
            //     item.Delete();
          }
        }
      } else {
        //TODO bo tu dong 8856 - 9014 do khong lien quan phan CO_DINH -> doan nay co ve da xu ly o phia DB phan ins_upd
        if (
          (await API.post_kiemtra_dungthu_mytv_moi(this.axios, {
            vdoituong_id: this.listbox.doituong.value,
            vloaitb_id: this.listbox.loaihinh_tb.value,
            vtocdo_id: this.listbox.cboGoiCuocAdsl.value
          })
            .then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data
              } else return 0
            })
            .catch(() => {
              return 0
            })) != 1
        ) {
          var q = await API.post_kiemtra_km_dt(this.axios, {
            vloaihinh_id: this.listbox.loaihinh_tb.value,
            vthang: moment(this.NgayYeuCau, this.datetimeFormatFull).format('MM/YYYY'),
            vdoituong: this.listbox.doituong.value,
            vhdtb_id: this.hdtb_id
          })
            .then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data
              } else return null
            })
            .catch(() => {
              return null
            }) //KIEM_TRA_DK(Convert.ToInt32(cboDoituongTB.EditValue), Convert.ToInt32(cboLoaihinhTB.SelectedValue), dtpNgayYeuCau.Value.ToString("MM/yyyy"), hdtb_id);
          if (q && q != '1' && q != '-2') {
            this.$toast.error(q)
            return
          }
        }

        if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH || this.listbox.dichvu_vt.value == DichVuVienThong.GPHONE || this.listbox.dichvu_vt.value == DichVuVienThong.IMS) {
          var d = this.tinh.mavung.length - 1
          var kt_matb = this.ma_tb_ht.substring(d) //, this.ma_tb_ht.length - d);

          if (!(await bancheo.KIEMTRA_MATB_KHOSO(this.tinh.tinhthicong_id, kt_matb, this.listbox.dichvu_vt.value)) && this.ma_tb_ht) {
            this.$toast.error('Số máy chưa có trong kho số !')
            // MaTB_Focus();
            return
          }
        }

        // validate so da cap hay chua
        const ktramatb = await bancheo.KIEMTRA_MATB(this.listbox.dichvu_vt.value, this.ma_tb_ht)
        if (ktramatb == 0) {
          if (this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_DC || this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_TL) {
            // hoangpkn : 10/04/2015   chưa biết code gì vào đây
          } else {
            this.$toast.error('Số máy hoặc Account đã được cấp !')
            // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
            await bancheo.CAPNHAT_KHOSO(this.ma_tb_ht, '', this.listbox.dichvu_vt.value, this.tt_nd.donvi_id)
            // MaTB_Focus();
            return
          }
        }
        //HungHM - 26/09/2010 - Zem lại vì bây giờ lắp theo mã đôi cáp + mã thuê bao
        //if (tracuuchung.KIEMTRA_ACC_KHILAPMOI_CD(txtMaTN_CD.Text) && dichvuvt_id == 1)
        //{
        //    Message_Box.ShowTB("Account đã được cấp cho thuê bao khác");
        //    return;
        //}
        //HungHM-09/09/2010 - Kiểm tra xem mã TB này có đang được lập hợp đồng hoặc phụ lục khác hay không?
        var kqkt = await API.post_kiemtra_ma_tb_lap_hopdong_khac(this.axios, {
          vdichvuvt_id: this.listbox.dichvu_vt.value,
          vloaihd_id: LoaiHopDong.DAT_MOI,
          vma_gd: this.khachhang.magd,
          vma_tb: this.ma_tb_ht
        })
          .then(async (response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          .catch(() => {
            return []
          })

        if (kqkt && kqkt.length > 0) {
          this.$toast.error(`Số máy/Acc: ${this.ma_tb_ht} đang được lập bởi hợp đồng (phụ lục) ${kqkt[0]['ten_loaihd']} có mã giao dịch ${kqkt[0]['ma_gd']} do User ${kqkt[0]['nguoi_cn']} thuộc đơn vị ${kqkt[0]['ten_dv']} thực hiện vào ngày ${kqkt[0]['ngay_yc']}`)
          return
        }

        //HungHM - 10/08/2010: Kiểm tra không cho phép thay đổi dịch vụ viễn thông khi cập nhật dữ liệu.
        if (this.ma_tb_ht > 0 && this.hdkh_cha_id == 0) {
          if (this.ma_tb) {
            var objCheckData = await API.post_kiemtra_update_thuebao(this.axios, {
              dichVuVtId: this.listbox.dichvu_vt.value,
              kieu: 0,
              loaiTbId: this.listbox.loaihinh_tb.value,
              maTb: this.ma_tb_ht
            })
              .then(async (response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  return response.data.data
                } else return 0
              })
              .catch(() => {
                return 0
              })
            if (objCheckData == 0) {
              this.$toast.error('Bạn không được thay đổi lại dịch vụ viễn thông và loại hình TB của thuê bao ' + this.ma_tb_ht)
              return
            }
          }
        }

        if (this.listbox.dichvu_vt.value == DichVuVienThong.GPHONE) {
          if (!bancheo.KiemTraTBTrongHD(this.thuebao.gphone.txtSoMayGP, this.lvwThueBao, 3)) {
            this.$toast.error('Không có mã thuê bao ' + this.thuebao.gphone.txtSoMayGP + ' trong HĐ/PL. Hãy nhập lại mã thuê bao')
            //    return;
          }
        }
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) {
          if (!bancheo.KiemTraTBTrongHD(this.thuebao.adsl.txtAccountADSL, this.lvwThueBao, 3)) {
            this.$toast.error('Không có mã thuê bao ' + this.thuebao.adsl.txtAccountADSL + ' trong HĐ/PL. Hãy nhập lại mã thuê bao')
            return
          }
          if (this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_ADSL_TINH_KHAC && this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_FIBER_TINH_KHAC) {
            if (!this.TUDONG_SINH_SOAO) {
              if (!(await bancheo.KIEMTRA_MATB_KHOSO_AO(this.ma_tb_ao_ht))) {
                // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
                this.$toast.error('Số ảo chưa có trong kho số hoặc chưa chọn số ảo !')
                // txtSoAoAdsl.Focus();
                return
              }
            }
          }
        }

        //TuanNA: Thêm hàm kiểm tra số ảo đã được chọn cho thuê bao khác chưa -- ngày 12/02/2014
        // hàm trả về == 1 : số ảo đã được chọn cho thuê bao khác
        // hàm trả về == 0 : số ảo chưa chọn cho thuê bao nào, có thể sử dụng
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) {
          var ds_soao = await bancheo.LAY_DS_THUEBAO_THEO_MALT(this.thuebao.adsl.txtSoAoAdsl ? this.thuebao.adsl.txtSoAoAdsl.trim() : '', this.hdtb_id)
          if (ds_soao && ds_soao.length > 0) {
            this.$toast.error('Số ảo đã được chọn cho thuê bao: ' + ds_soao[0]['ma_tb'] + '\nBạn hãy chọn số ảo khác!')
            // txtSoAoAdsl.Focus();
            return
          }
        } else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          var ds_soao = await bancheo.LAY_DS_THUEBAO_THEO_MALT(this.thuebao.tsl.txtSoAoTSL_Dau ? this.thuebao.tsl.txtSoAoTSL_Dau.trim() : '', this.hdtb_id)
          if (ds_soao && ds_soao.length > 0) {
            this.$toast.error('Số ảo điểm đầu đã được chọn cho thuê bao: ' + ds_soao[0]['ma_tb'] + '\nBạn hãy chọn số ảo khác!')
            // txtSoAoTSL_Dau.Focus();
            return
          }
          ds_soao = await bancheo.LAY_DS_THUEBAO_THEO_MALT(this.thuebao.tsl.txtSoAoTSL_Cuoi ? this.thuebao.tsl.txtSoAoTSL_Cuoi.trim() : '', this.hdtb_id)
          if (ds_soao && ds_soao.length > 0) {
            this.$toast.error('Số ảo điểm cuối đã được chọn cho thuê bao: ' + ds_soao[0]['ma_tb'] + '\nBạn hãy chọn số ảo khác!')
            // txtSoAoTSL_Cuoi.Focus();
            return
          }
        } else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
          //var ds_soao = await bancheo.LAY_DS_THUEBAO_THEO_MALT((this.thuebao.mgwan.txtMaTBWan.Text+'').trim(), this.hdtb_id);
          var ds_soao = await bancheo.LAY_DS_THUEBAO_THEO_MALT((this.thuebao.mgwan.soao + '').trim(), this.hdtb_id)
          if (ds_soao && ds_soao.length > 0) {
            this.$toast.error('Số ảo đã được chọn cho thuê bao: ' + ds_soao[0]['ma_tb'] + '\nBạn hãy chọn số ảo khác!')
            // txtSoAoWan.Focus();
            return
          }
        }

        if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
          if (!bancheo.KiemTraTBTrongHD(this.thuebao.mgwan.txtMaTBWan.Text, this.lvwThueBao, 3)) {
            this.$toast.error('Không có mã thuê bao ' + this.thuebao.mgwan.txtMaTBWan.Text + ' trong HĐ/PL. Hãy nhập lại mã thuê bao')
            return
          }
          if (!this.TUDONG_SINH_SOAO) {
            if (!(await bancheo.KIEMTRA_MATB_KHOSO_AO(this.ma_tb_ao_ht))) {
              // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
              this.$toast.error('Số ảo chưa có trong kho số hoặc chưa chọn số ảo !')
              // txtSoAoWan.Focus();
              return
            }
          }
        }
        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          if (!bancheo.KiemTraTBTrongHD(this.thuebao.tsl.txtMaTSL.Text, this.lvwThueBao, 3)) {
            this.$toast.error('Không có mã thuê bao ' + this.thuebao.tsl.txtMaTSL.Text + ' trong HĐ/PL. Hãy nhập lại mã thuê bao')
            return
          }
          if (!this.TUDONG_SINH_SOAO) {
            //KNV:16/08/2016: Nếu thiết lập sinh số ảo tự động thì ko cần kiểm tra
            if (!(await bancheo.KIEMTRA_MATB_KHOSO_AO(this.ma_tb_ao_ht))) {
              // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
              this.$toast.error('Số ảo chưa có trong kho số hoặc chưa chọn số ảo cho điểm đầu !')
              // txtSoAoTSL_Dau.Focus();
              return
            }
            if (!(await bancheo.KIEMTRA_MATB_KHOSO_AO(this.ma_tb_ao_ht_cuoi))) {
              // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
              this.$toast.error('Số ảo chưa có trong kho số hoặc chưa chọn số ảo cho điểm cuối !')
              // txtSoAoTSL_Cuoi.Focus();
              return
            }
          }
        }
        // #endregion

        //DataSet ds = bangts.LayHuongGiao_TiepNhan(LoaiHopDong.DAT_MOI, Convert.ToInt32(cboLoaihinhTB.SelectedValue), tocdotn_id, muccuoctn_id, Convert.ToInt32(cboKieuLD.SelectedValue));

        var ds = await API.post_layhuonggiao_tiepnhan_v2(this.axios, {
          dichvuvt_id: this.listbox.dichvu_vt.value,
          kieuld_id: this.listbox.kieu_ld.value,
          loaihd_id: LoaiHopDong.DAT_MOI,
          loaikenh_id: j_loaikenh_id,
          loaitb_id: this.listbox.loaihinh_tb.value,
          muccuoc_id: muccuoctn_id ? muccuoctn_id : 0,
          phanvung_id: this.$root.token.getPhanVungID(),
          tocdo_id: this.tocdo_id ? this.tocdo_id : 0
        })
          .then(async (response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            }
          })
          .catch(() => {
            return []
          })

        this.huonggiao_tn = 0
        this.quytrinh_tn = 0
        this.luong_id = 0

        if (!ds || ds.length <= 0) {
          this.$toast.error('Nghiệp vụ này chưa được thiết lập quy trình, bạn hãy liên hệ Admin để xử lý!')
          return
        }
        this.huonggiao_tn = ds[0]['huonggiao_id']
        this.quytrinh_tn = ds[0]['quytrinh_id']
        if (ds[0]['luong_id']) this.luong_id = ds[0]['luong_id'] * 1

        //// Lấy thông tin quy trình tỉnh thi công
        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          // Lấy hướng giao, quy trình tại điểm đầu
          var rs_qt_dau = await bancheo.LayHuongGiao_TiepNhan(this.thuebao.tsl.tinh_dau.tinhthicong_id, LoaiHopDong.DAT_MOI, this.listbox.loaihinh_tb.value, this.thuebao.tsl.thongso_tc_dau.tocdo_id, this.thuebao.tsl.thongso_tc_dau.muccuoc_id, this.thuebao.tsl.thongso_tc_dau.kieuld_id)
          if (!rs_qt_dau || rs_qt_dau.length <= 0) {
            this.$toast.error('Nghiệp vụ này chưa được thiết lập quy trình ở tỉnh Thi Công điểm đầu. Liên hệ Admin để xử lý')
            return
          }
          this.thuebao.tsl.quytrinh_tc_tn_dau = 0
          this.thuebao.tsl.huonggiao_tc_tn_dau = 0
          this.thuebao.tsl.quytrinh_tc_tn_dau = rs_qt_dau[0]['quytrinh_id'] * 1
          this.thuebao.tsl.huonggiao_tc_tn_dau = rs_qt_dau[0]['huonggiao_id'] * 1

          // Lấy hướng giao, quy trình tại điểm cuối
          var rs_qt_cuoi = await bancheo.LayHuongGiao_TiepNhan(this.thuebao.tsl.tinh_cuoi.tinhthicong_id, LoaiHopDong.DAT_MOI, this.listbox.loaihinh_tb.value, this.thuebao.tsl.thongso_tc_cuoi.tocdo_id, this.thuebao.tsl.thongso_tc_cuoi.muccuoc_id, this.thuebao.tsl.thongso_tc_cuoi.kieuld_id)
          if (!rs_qt_cuoi || rs_qt_cuoi.length <= 0) {
            this.$toast.error('Nghiệp vụ này chưa được thiết lập quy trình ở tỉnh Thi Công điểm cuối. Liên hệ Admin để xử lý')
            return
          }
          this.thuebao.tsl.quytrinh_tc_tn_cuoi = 0
          this.thuebao.tsl.huonggiao_tc_tn_cuoi = 0
          this.thuebao.tsl.quytrinh_tc_tn_cuoi = rs_qt_cuoi[0]['quytrinh_id']
          this.thuebao.tsl.huonggiao_tc_tn_cuoi = rs_qt_cuoi[0]['huonggiao_id']
        } else {
          // Lấy hướng giao, quy trình tại tỉnh lắp đặt
          var rs_qt = await bancheo.LayHuongGiao_TiepNhan(this.tinh.tinhthicong_id, LoaiHopDong.DAT_MOI, this.listbox.loaihinh_tb.value, this.thongso_tc.tocdo_id, this.thongso_tc.muccuoc_id, this.thongso_tc.kieuld_id)
          if (!rs_qt || rs_qt.length <= 0) {
            this.$toast.error('Nghiệp vụ này chưa được thiết lập quy trình ở tỉnh Thi Công. Liên hệ Admin để xử lý')
            return
          }
          this.quytrinh_tc_tn = 0
          this.huonggiao_tc_tn = 0
          this.quytrinh_tc_tn = rs_qt[0]['quytrinh_id']
          this.huonggiao_tc_tn = rs_qt[0]['huonggiao_id']
        }

        await this.TaoDuLieu(false)

        var isvalid = true
        document.querySelectorAll('.main-wrapper .page-content input').forEach((item) => {
          if (isvalid && !item.validity.valid) {
            isvalid = false
            this.$toast.error(item.getAttribute('title'))
            item.focus()
          }
        })
        if (!isvalid) return

        if (this.listbox.doituong.value == DUNG_THU.DOITUONG_TB) {
          if (!(await this.Kiemtra_dungthu_mytv())) {
            // #region Lấy chi tiết khuyến mại dùng thử fill vào khuyenmai_hdtb
            var dsTemp = []
            await API.post_lay_chitiet_km_dungthu_v2(this.axios, { vloaikh_id: this.listbox.loai_kh.value }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                dsTemp = response.data.data
              }
            })
            if (dsTemp && dsTemp.length > 0) {
              var ithang_huongdc = 0,
                ithang_huongkm = 0,
                ithang_tg = 0
              var dtiendatcoc_csd = 0,
                dtien_td = 0
              this.dsKM_HDTB = []

              for (var i = 0; i < dsTemp.length; i++) {
                ithang_huongdc = 0
                ithang_huongkm = 0
                ithang_tg = 0
                dtiendatcoc_csd = 0
                dtien_td = 0
                var dr = {}
                if (dsTemp[i]['huong_dc']) ithang_huongdc = dsTemp[i]['huong_dc']
                if (dsTemp[i]['huong_km']) ithang_huongkm = dsTemp[i]['huong_km']
                if (dsTemp[i]['sothang_tg']) ithang_tg = dsTemp[i]['sothang_tg']
                if (dsTemp[i]['datcoc_csd']) dtiendatcoc_csd = dsTemp[i]['datcoc_csd']
                if (dsTemp[i]['tien_td']) dtien_td = dsTemp[i]['tien_td']
                dr.THANG_HUONGDC = ithang_huongdc
                dr.THANG_HUONGKM = ithang_huongkm
                dr.SOTHANG_TG = ithang_tg
                dr.DATCOC_CSD = dtiendatcoc_csd
                dr.TIEN_TD = dtien_td

                if (dsTemp[i]['kieu_bdkm'] == '3') {
                  try {
                    var tmp = moment(dsTemp[i]['thang_bd'], 'YYYYMM')
                      .add(ithang_huongkm, 'M')
                      .format('YYYYMM')
                    dr.THANG_BD = dsTemp[i]['thang_bd']
                    dr.THANG_KT = tmp
                  } catch (ex) {}
                }
                if (dsTemp[i]['kieu_bdtg'] == '3') {
                  try {
                    var tmp = moment(dsTemp[i]['thang_bdtg'], 'YYYYMM')
                      .add(ithang_tg, 'M')
                      .format('YYYYMM')
                    dr.THANG_BDTG = dsTemp[i]['thang_bdtg']
                    dr.THANG_KTTG = tmp
                  } catch (ex) {}
                }
                if (dsTemp[i]['kieu_bddc'] == '3') {
                  try {
                    var tmp = moment(dsTemp[i]['thang_bddc'], 'YYYYMM')
                      .add(ithang_huongkm, 'M')
                      .format('YYYYMM')
                    dr.THANG_BDDC = dsTemp[i]['thang_bddc']
                    dr.THANG_KTDC = tmp
                  } catch (ex) {}
                }
                //longdx: bổ sung thông tin tỷ lệ km
                dr.TYLE_KMLD = dsTemp[i]['tyle_kmld']
                dr.TYLE_SD = dsTemp[i]['tyle_sd']
                dr.TYLE_TB = dsTemp[i]['tyle_tb']
                dr.HDTB_ID = this.hdtb_id //-1;
                dr.CHITIETKM_ID = dsTemp[i]['chitietkm_id']
                dr.KHUYENMAI_ID = dsTemp[i]['khuyenmai_id']
                //dr.KHUYENMAI_ID_NEO = dsTemp[i]["khuyenmai_id_neo"];
                dr.KIEU_YC = 1
                this.dsKM_HDTB.push(dr)

                //Lấy tiền khuyến mại
                if (this.kmld.tien_kmld < dsTemp[i]['tien_kmld']) this.kmld.tien_kmld = dsTemp[i]['tien_kmld']
                if (this.kmld.vat_kmld < dsTemp[i]['vat_kmld']) this.kmld.vat_kmld = dsTemp[i]['vat_kmld']
                if (this.kmld.tyle_kmld < dsTemp[i]['tyle_kmld']) this.kmld.tyle_kmld = dsTemp[i]['tyle_kmld']

                if (this.kmld.tien_datcoc < dsTemp[i]['datcoc_csd']) this.kmld.tien_datcoc = dsTemp[i]['datcoc_csd']
              }
            }
            // #endregion
          } else {
            //TODO xem lai, chua xac dinh muc dich xoa du lieu o day!
            this.dsKM_HDTB = this.dsKM_HDTB.filter((x) => !(x.khuyenmai_id == 2999 || x.khuyenmai_id == 2998))
            // var _arrKM_DT = this.dsKM_HDTB.filter(x=>x.khuyenmai_id==2999 || x.khuyenmai_id==2998);
            // if(_arrKM_DT)
            //   for(var item in _arrKM_DT)
            //     item.Delete();
          }
        }
      }
      // Xu ly insert / update
      {
        if (this.loainv_ctv_hrm > 0 || this.loainv_ngt_hrm > 0) {
          //TODO dong 8353, can xem 2 thong tin nay lay nhu the nao???
          if (this.dsHDKH_Sub && this.dsHDKH_Sub.length > 0) {
            this.TAO_DULIEU_HDKH_SUB(this.dsHDKH_Sub, this.dsHDKH_Sub[0]['HDKH_ID'])
          } else {
            var row_khsub = {}
            row_khsub.HDKH_ID = this.dsHDKH[0]['HDKH_ID']
            if (this.loainv_ctv_hrm > 0) row_khsub.LOAINV_CTV_HRM = this.loainv_ctv_hrm
            if (this.loainv_ngt_hrm > 0) row_khsub.LOAINV_NGT_HRM = this.loainv_ngt_hrm
            this.dsHDKH_Sub = []
            this.dsHDKH_Sub.push(row_khsub)
          }
        } else {
          if (this.ts_kt_ltb_hrm && this.words.indexOf(this.listbox.loaihinh_tb.value) && this.dsHDKH_Sub && this.dsHDKH_Sub.length > 0) this.TAO_DULIEU_HDKH_SUB(this.dsHDKH_Sub, this.dsHDKH[0]['HDKH_ID'])
        }
        //this.CapNhat_DiaChiBC(); // TODO LINE 8413
        //TODO inset du lieu vao DB va hien thi. LINE 8389
        //FIXME array [] la chua lay duoc du lieu o thoi diem hien tai.
        var pdata = {
          HD_KHACHHANG: this.dsHDKH,
          HD_THUEBAO: this.dsHDTB,
          HD_THANHTOAN: this.dsHDTT,
          HD_BANCHEO: this.dsHDBANCHEO,
          HDTB_BANCHEO: this.dsHDTBBANCHEO,
          HDBC_MGWAN: this.dsHDBCMGWAN,
          HDBC_ADSL: this.dsHDBC_ADSL,
          HDBC_CD: this.dsHDBCCD,
          DANGKY_DVGT_BC: this.dsDK_DVGT_BC,
          HDBC_TSL: this.dsHDBC_TSL,
          HDBC_IMS: this.dsHDBCIMS,
          DIACHI_BANCHEO: this.dsDiaChi_BanCheo,
          HDBC_CNTT: this.dsHDBC_CNTT,
          HDTB_KIEU_NT: this.dsHDTB_Kieu_NT,
          HDTB_DV: this.dsHDTBDV,
          HDTB_CD: this.dsHDTB_CD,
          HDTB_DD: this.dsHDTB_DD,
          HDTB_INT: this.dsHDTB_INT,
          HDTB_ADSL: this.dsHDTB_ADSL,
          DIACHI: this.dsDiaChi,
          DIACHI_HDKH: this.dsDiaChiHDKH,
          DIACHI_HDTT: this.dsDiaChiHDTT,
          DIACHI_HDTB: this.dsDiaChiHDTB,
          DANGKY_DVGT: this.dsDK_DVGT,
          DANGKY_DVK: this.dsDK_DVKHAC,
          CT_MUA_TBI: this.UpperCasePropertyList(this.dsCTM_TBI),
          HDTB_MGWAN: this.dsHDTB_MEWAN, //dsHDTB_MEWAN
          HDTB_TSL: this.dsHDTB_TSL, //dsHDTB_TSL
          HDTB_GP: this.dsHDTB_GP, //dsHDTB_GP
          // KHUYENMAI_HDTB: this.dsKM_HDTB,
          // DATCOC_HDTB: this.dsDC_HDTB,
          KHUYENMAI_HDTB: this.dsKM_HDTB && this.dsKM_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsKM_HDTB) : this.dsKM_HDTB, //this.dsKM_HDTB,
          DATCOC_HDTB: this.dsDC_HDTB && this.dsDC_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsDC_HDTB) : this.dsDC_HDTB,
          THONGTIN_TT: this.dsTTTT, //this.dsTTTT,
          CT_TIENHD: this.dsCTTHD,
          TIEN_HDTB: this.dsTien_HDTB, //this.dsTien_HDTB,
          TIEN_DATCOC: this.dsTien_DatCoc,
          HDTB_IMS: this.dsHDTB_IMS, //dsHDTB_IMS
          CAMKET_HDTB: this.dsCAMKET_HDTB,
          HUONGGIAO_ID: this.huonggiao_tn,
          HDTB_KV: this.dsHDTB_KV && this.dsHDTB_KV.length > 0 ? this.dsHDTB_KV.filter((x) => x.KHUVUC_ID && x.KHUVUC_ID > 0) : null, //this.dsHDTB_KV_tmp?this.dsHDTB_KV_tmp:this.dsHDTB_KV, da bo _tmp
          HDTB_CNTT: this.dsHDTB_CNTT, //dsHDTB_CNTT
          HDTT_NV: this.dsHDTT_NV,
          HDTB_DUNGTHU: this.dsHDTB_DUNGTHU,
          TRAGOP_TBI_HDTB: this.dsTRAGOP_TBI_HDTB,
          HDTB_LOAIIP: this.dsHDTB_LoaiIp, //this.dsHDTB_LoaiIp,
          HDKH_SUB: this.dsHDKH_Sub,
          HDTB_SUB: this.dsHDTB_SUB, //this.dsHDTB_SUB,
          HDTB_CT: this.dsHDTB_CT, //this.dsHDTB_CT, //Chi co o phan dich vu CNTT / frmChiTietHDTB
          THEMMOI: this.buttonSet == 1,
          LOAITB_ID: this.listbox.loaihinh_tb.value,
          DICHVUVT_ID: this.listbox.dichvu_vt.value,
          KT_KVNLML: KT_KVNLML, //BUG KT_KVNLML nhung de mac dinh de chay test
          TUDONG_SINH_SOAO: this.TUDONG_SINH_SOAO ? 1 : 0, // Chi dung cho cac case MEGAWAN...

          MAKH_WEB: this.khachhang.makh,
          DS_DIACHI_BC: {
            DIACHIBC_ID: this.diachiBC.DIACHI_ID,
            HDTT_ID: this.hdtt_id,
            PHOBC_ID: this.diachiBC.PHO_ID,
            PHUONGBC_ID: this.diachiBC.PHUONG_ID,
            QUANBC_ID: this.diachiBC.QUAN_ID,
            SONHA_BC: this.diachiBC.SO_NHA,
            DIACHI_BC: this.diachiBC.DIACHI,
            TINHBC_ID: this.diachiBC.TINH_ID,
            APBC_ID: this.diachiBC.AP_ID,
            KHUBC_ID: this.diachiBC.KHU_ID,
            DACDIEMBC_ID: this.diachiBC.DACDIEM_ID,
            BLOCK: this.diachiBC.BLOCK?this.diachiBC.BLOCK:null,
            TANG: this.diachiBC.TANG?this.diachiBC.TANG:null,
            PHONG: this.diachiBC.PHONG?this.diachiBC.PHONG:null,
            MOTA: this.diachiBC.BLOCK?this.diachiBC.MOTA:null,
            VIDO: this.diachiBC.VIDO?this.diachiBC.VIDO:null,
            KINHDO: this.diachiBC.KINHDO?this.diachiBC.KINHDO:null,
          },
          LIST_SERIAL: [],
          IS_TRUOCBH: 0,
          KIEMTRA_DK_APDUNG: 'ok', //BUG KIEMTRA_DK_APDUNG nhung de mac dinh de chay test

          TD_GANTHEM_HDTB_DV: this.TD_GANTHEM_HDTB_DV ? 1 : 0,
          STATUS_VDC: this.STATUS_VDC,
          OPEN_SYNC_VINA: TRANGTHAI_DONGBO.OPEN_SYNC_VINA ? 1 : 0,

          MA_TB: this.ma_tb ? this.ma_tb : this.khachhang.makh,
          MA_TB_HT: this.ma_tb_ht, //this.thuebao.codinh.somay, gan thay cho bien global bang bien local vi sau nay se thay doi theo loai dich vu
          MA_TB_AO: this.ma_tb_ao,
          MA_TB_AO_HT: this.ma_tb_ao_ht,
          MA_TB_AO_HT_CUOI: this.ma_tb_ao_ht_cuoi,
          MA_TB_AO_CUOI: '',

          DULIEU_KS: this.bDuLieuKS ? 1 : 0,
          SD_FRMSHUONGKN_V2: this.thamsomacdinh['SD_FRMDSHUONGKN_V2'] == 1 ? 1 : 0,
          LOAISOWAN: this.loaisowan,
          VRF: this.thuebao.mgwan.vrfvfi,
          MA_TB_DIACHILD: null,
          VPHIEUCSKHDV_ID: this.phieucskhdv_id, // TODO chua biet load nhu the nao
          KETCUOI_ID: this.KetCuoi_ID,
          LAT_LD: this.diachiLD.Lat,
          LNG_LD: this.diachiLD.Lng,
          FIBER_BS: 0,
          CONGNGHE_ID: this.listbox.congnghe.value == 0 ? null : this.listbox.congnghe.value,
          MATB_TN: this.thuebaocd.matn ? this.thuebaocd.matn.trim() : null
        }
        //thay API.post_fn_ins_update_hd_datmoi bang CSS.LAPHOPDONG_COMMON.FN_INS_UPDATE_HD_DATMOI_BANCHEO /web-hopdong/thanhly-thuebao-bancheo/fn_ins_update_hd_datmoi_bancheo
        // {
        //     "p_ds_para": "",
        //         "p_tt_nd": ""
        // }
        await API.post_fn_ins_update_hd_datmoi_bancheo(this.axios, { p_ds_para: JSON.stringify(pdata), p_tt_nd: JSON.stringify(this.tt_nd) }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            var hdkh_id = this.khachhang.hdkh_id
            var data = JSON.parse(response.data.data)
            var apidata1 = data['RESULT'] //JSON.parse();
            if (data['ERROR_CODE'] != 1) {
              this.$toast.error(data['MESSAGE'])
              checkloi = true
              return
            } else {
              if(KT_KVNLML!=1) {
                if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
                  // VDCService vdc = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
                  // vdc.HuyDatChoMegaVNN(txtAccountADSL.Text);
                  await vdc.HuyDatChoMegaVNN(this.thuebao.adsl.txtAccountADSL)
                }

                this.buttonSet = 0

                this.$toast.success('Hợp đồng đã được thoái trả. Khách hàng sẽ được đưa vào danh sách Khách hàng tiềm năng!')
                return 'err'
              }
              if (this.buttonSet == 1) {
                this.DatMoi_Fsecure_kem_fiber()
                this.Them_MyTV_vao_goi_giadinh()

                if (this.thamsomacdinh['SD_FRMDSHUONGKN_V2'] == 1 && apidata1['KQ_VFI_VRF']) {
                  var KQ_VFI_VRF = apidata1['KQ_VFI_VRF']
                  if (KQ_VFI_VRF && KQ_VFI_VRF != 'ok') this.$toast.error(KQ_VFI_VRF)
                }
              }
              this.$toast.success(data['MESSAGE'])
            }
            if (checkloi) return
            var api1 = API.get_lay_ds_hopdong_tb_theo_hdkh_id(this.axios, { params: { hdkh_id: hdkh_id } }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                var ds_hdkh_tmp = response.data.data
                ds_hdkh_tmp = this.LowerCasePropertyList(ds_hdkh_tmp)
                await this.HienThiDanhSacHDTB(ds_hdkh_tmp)
                await this.HienThiTTHopDongTB(ds_hdkh_tmp)
              }
            })
            var api2 = API.get_lay_ds_hopdong_thanhtoan_theo_hdkh(this.axios, { params: { hdKhId: hdkh_id } }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                var ds_hdtt_tmp = response.data.data
                ds_hdtt_tmp = this.LowerCasePropertyList(ds_hdtt_tmp)
                await this.HienThiDanhSacHDTT(ds_hdtt_tmp)
                await this.HienThiTTHopDongTT(ds_hdtt_tmp)
              }
            })
            Promise.all([api1, api2]).then(async () => {
              this.HienThiDS_HDTT_CBO(hdkh_id)
              this.buttonSet = 3
            })
            if (this.kiemtra_nhanvien_vti == 1)
            {
              //TODO chờ popup tích hợp
                // string temp = tdan.GET_VALUE_FUNC("{?DB2}.fn_kiemtra_nhap_thongtin_thanhtoan_bs",
                //     "vhdkh_id", hdkh_id, "vnhanvien_id", tt_nd.nhanvien_id, "vhdtb_id", hdtb_id).ToString();
                // if (temp == "OK")
                // {
                //     frmThongTinTT_BoSung frm = new frmThongTinTT_BoSung(hdkh_id, hdtb_id);
                //     frm.dichvuvt_id = dichvuvt_id;
                //     frm.ShowDialog();
                // }
                // else if (temp == "Done")
                // {
                //     Message_Box.ShowTB("Đã ghi nhận thông tin thanh toán");
                // }
            }

            //Thay doan nay bang ham moi
            // await API.post_fn_lay_ds_ht_capnhat_datmoi(this.axios, { "ds_para": JSON.stringify({"HDKH_ID":this.khachhang.hdkh_id}) }).then(async (response) => {
            //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            //     var apidata = JSON.parse(response.data.data);
            //     if(apidata['ERROR_CODE']==1) {
            //       var ds_hdkh_tmp = apidata['RESULT']['DS_HDTB'];
            //       var ds_hdtt_tmp = apidata['RESULT']['DS_HDTT'];
            //       ds_hdkh_tmp = this.LowerCasePropertyList(ds_hdkh_tmp);
            //       ds_hdtt_tmp = this.LowerCasePropertyList(ds_hdtt_tmp);

            //       await this.HienThiDanhSacHDTB(ds_hdkh_tmp);
            //       await this.HienThiTTHopDongTB(ds_hdkh_tmp);
            //       await this.HienThiDanhSacHDTT(ds_hdtt_tmp);
            //       await this.HienThiTTHopDongTT(ds_hdtt_tmp);
            //     }
            //   }
            // });
            // HienThiDS_HDTB_CBO(this.khachhang.hdkh_id); //  100% la comment
            // this.HienThiDS_HDTT_CBO(this.khachhang.hdkh_id); // Da load du lieu san, chi can reset lai gia tri duoc chon la duoc.

            // this.buttonSet = 3;
            //this.$toast.success("Đã cập nhật dữ liệu lên hệ thống của Viễn thông tỉnh thành công!");
            //Da tich hop vao insert API, chi can truyen dung phieucskhdv_id vao insert API la xong.
            // if (this.phieucskhdv_id > 0)
            // {
            //     new TruyenDanFacade().EXECUTE_PROC("{?DB2}.b2a_ht_phieucskhdv",
            //     "vphieucskhdv_id", this.phieucskhdv_id,
            //     "vnhanvien_id", tt_nd.nhanvien_id,
            //     "vdonvi_id", tt_nd.donvi_id,
            //     "vnguoi_cn", tt_nd.ma_nd,
            //     "vip_cn", tt_nd.ip,
            //     "vmay_cn", tt_nd.may_cn,
            //     "vkieu", 1);
            // }
          }
        })
        this.buttons.tsbtnXoaTB = !this.lvwThueBao || this.lvwThueBao.length <= 1

        if (this.OnDatMoi) {
          try {
            this.$emit('OnDatMoi', { hdkh_id: this.khachhang.hdkh_id, hdtt_id: this.hdtt_id, hdtb_id: this.hdtb_id, PhieuHs_ID: this.PhieuHs_ID, TenKH: this.khachhang.tenkh })
            //OnDatMoi.Invoke(this, hdkh_id, hdtt_id, hdtb_id, PhieuHs_ID, txtTenKH.Text);
          } catch (ex) {
            this.$toast.error('' + ex)
            if (this.debug) console.error(ex)
          }
        }
        //this.PhieuHs_ID = 0; //FIXME xem lai co can lenh gan nay khong????, tam thoi khong thay code cu xu ly ghi gi den bien nay.
      }
    },
    async TaoDuLieu(themmoi) {
      await this.TaoDuLieu_HDKH(themmoi)
      if (this.loi_sinh_magd) return
      await this.TaoDuLieu_HDTT(themmoi)
      await this.TaoDuLieu_HDTB(themmoi)
      if (DUNG_THU.DOITUONG_TB == this.listbox.doituong.value) {
        await this.TaoDuLieu_HDTB_DUNGTHU(themmoi)
      }
      await this.TaoDuLieu_HDTT_NV(themmoi)
      // await this.TaoDuLieu_THONGTIN_TT(themmoi);
      await this.TaoDuLieu_CT_TIENHD(true)
      await this.TaoDuLieu_DiaChi(themmoi, 4)
      await this.TaoDuLieu_DiaChi_BanCheo(themmoi, 4)
      await this.TaoDuLieu_DKDV()
      await this.TaoDuLieu_DKDV_BC()
      this.dsTien_HDTB = []
      if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
        this.TaoDuLieu_TIEN_HDTB_TC(true)
      }
      await this.TaoDuLieu_TIEN_DATCOC(themmoi)
      await this.CapNhat_HDTB_ID_DangKyDV()
      await this.CapNhat_HDTB_ID_HDTB_KV()

      if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
        this.dsHDBANCHEO = []
        this.dsHDTBBANCHEO = []
        await this.TaoDuLieu_HDBANCHEO_TSL(themmoi, 1)
        await this.TaoDuLieu_HDBANCHEO_TSL(themmoi, 2)
      } else await this.TaoDuLieu_HDBANCHEO(themmoi)

      if (themmoi) {
        if ((this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) && this.thamsomacdinh['MGW_MTN_KTR_HOA'] && this.thamsomacdinh['MGW_MTN_KTR_HOA'] == 1)
          this.ma_vnpt = this.ma_tb_ht.toUpperCase()
        else this.ma_vnpt = this.ma_tb_ht
      }

      this.dsHDTB_CD = []
      this.dsHDTB_DD = []
      this.dsHDTB_INT = []
      this.dsHDTB_ADSL = []
      this.dsHDTB_TSL = []
      this.dsHDTB_MEWAN = []
      this.dsHDTB_GP = []
      this.dsHDTB_IMS = []
      this.dsCAMKET_HDTB = []
      this.dsHDTBDV = []
      this.dsHDTB_CNTT = []
      this.dsHDTB_LoaiIp = []
      switch (this.listbox.dichvu_vt.value * 1) {
        case DichVuVienThong.CO_DINH:
          await this.TaoDuLieu_HDTB_CD(themmoi)
          await this.TaoDuLieu_HDBC_CD(themmoi)
          await this.TaoDuLieu_CAMKET_HDTB(true)
          break
        case DichVuVienThong.DI_DONG:
          this.TaoDuLieu_HDTB_DD(themmoi)
          break
        case DichVuVienThong.MEGAWAN:
        case DichVuVienThong.METRONET:
        case DichVuVienThong.MGW_DOITAC:
        case DichVuVienThong.NOIBO_DADIEM:
          await this.TaoDuLieu_HDTB_MGWAN(themmoi)
          await this.TaoDuLieu_HDBC_MGWAN(themmoi)
          await this.TaoDuLieu_HDTB_LOAIIP_MGWAN()
          await this.TaoDuLieu_HDTB_KIEU_NT()
          break
        case DichVuVienThong.MEGA_EYES:
          await this.TaoDuLieu_HDTB_ADSL(themmoi)
          break
        case DichVuVienThong.ADSL:
        case DichVuVienThong.HATANG_VIENTHONG:
        case DichVuVienThong.BRCD_DOITAC:
          await this.TaoDuLieu_HDTB_ADSL(themmoi)
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
            await this.TaoDuLieu_HDTB_LOAIIP()
          }
          await this.TaoDuLieu_HDBC_ADSL(themmoi)
          break
        case DichVuVienThong.TSL:
        case DichVuVienThong.TSL_DOITAC:
        case DichVuVienThong.NOIBO_2DIEM:
          await this.TaoDuLieu_HDTB_TSL(themmoi)
          this.dsHDBC_TSL = []
          await this.TaoDuLieu_HDBC_TSL(themmoi, 1)
          await this.TaoDuLieu_HDBC_TSL(themmoi, 2)
          await this.TaoDuLieu_HDTB_KIEU_NT()
          break
        case DichVuVienThong.GPHONE:
          await this.TaoDuLieu_HDTB_GP(true)
          await this.TaoDuLieu_CAMKET_HDTB(true)
          break
        case DichVuVienThong.IMS:
        case DichVuVienThong.IMS_DOITAC:
          await this.TaoDuLieu_HDTB_IMS(true)
          await this.TaoDuLieu_HDBC_IMS(themmoi)
          await this.TaoDuLieu_CAMKET_HDTB(true)
          break
        case DichVuVienThong.TRUNGTAM_DULIEU:
        case DichVuVienThong.HOINGHI_TRUYENHINH:
        case DichVuVienThong.ANTOAN_BAOMAT_TT:
        case DichVuVienThong.DICHVU_CNTT:
          this.dsHDTB_CNTT = this.thongso_ban.thongso_cntt
          this.dsHDBC_CNTT = this.thongso_tc.thongso_cntt
          this.dsHDTB_CNTT = this.ItemList
          //Tạo cho bảng hdtb_dv
          for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

        if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
          throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
          return;
        }
            var row = {}
            row.HDTB_ID = this.hdtb_id
            row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
            row.DONVI_ID = this.DT_CONTROLS.value[i]
            row.KIEUDV_ID = 2
            this.dsHDTBDV.push(row)
          }
          //Duong them
          await this.TAO_DULIEU_HDTB_SUB(themmoi)
          //End
          break
      }
    },
    async TaoDuLieu_HDKH(themmoi) {
      this.dsHDKH = []
      var rowHDKH = {}
      var vmagd_temp = ''
      var dulieuapi = {}
      await API.post_fn_lay_tt_taodl_hdkh(this.axios, {
        ds_para: JSON.stringify({
          DONVI_ID: this.$root.token.getDonViID(),
          LOAIHD_ID: LoaiHopDong.DAT_MOI,
          DONVI_DL_ID: '0',
          DONVI_QL_ID: this.listbox.donvi_ql.value ? this.listbox.donvi_ql.value : 0,
          TS_SINHMA_GD_THEO_DONVI: this.ts_sinhma_gd_theo_donvi ? 1 : 0,
          MA_HD: this.khachhang.mahd ? this.khachhang.mahd : '',
          MA_KH: this.khachhang.makh ? this.khachhang.makh : '',
          THEMMOI: themmoi
        })
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          dulieuapi = JSON.parse(response.data.data)
        }
      })
      //FIXME check lai cho nay vi mat hdkh_id
      if (!dulieuapi || dulieuapi['ERROR_CODE'] != 1) {
        throw dulieuapi?dulieuapi["MESSAGE"]:"Lỗi tạo dữ liệu hợp đồng khách hàng! "+response.data.message+": "+response.data.message_detail;
      }
      //FIXME check lai cho nay vi mat hdkh_id
      if (dulieuapi && dulieuapi['ERROR_CODE'] == 1) {
        if (dulieuapi['RESULT']) dulieuapi = dulieuapi['RESULT']
        if (dulieuapi['HDKH_ID']) {
          rowHDKH.HDKH_ID = dulieuapi['HDKH_ID']
          if (rowHDKH.HDKH_ID && rowHDKH.HDKH_ID > 0) this.khachhang.hdkh_id = rowHDKH.HDKH_ID
        }
        if (dulieuapi['MA_GD']) rowHDKH.MA_GD = dulieuapi['MA_GD']
        if (dulieuapi['MA_HD']) rowHDKH.MA_HD = dulieuapi['MA_HD']
        if (dulieuapi['MA_KH']) this.khachhang.makh = dulieuapi['MA_KH']
      }
      if (!rowHDKH.HDKH_ID || rowHDKH.HDKH_ID == 0) {
        if (this.khachhang.hdkh_id && this.khachhang.hdkh_id > 0) rowHDKH.HDKH_ID = this.khachhang.hdkh_id
        else
          await API.post_get_keys(this.axios, { keyname: 'HD_KHACHHANG' }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              rowHDKH.HDKH_ID = response.data.data // 4039
              this.khachhang.hdkh_id = rowHDKH.HDKH_ID
            }
          })
      }

      if (this.hdkh_cha_id > 0) rowHDKH.HDKH_CHA_ID = this.hdkh_cha_id
      if (themmoi) {
        if(rowHDKH.MA_GD) this.khachhang.magd = rowHDKH.MA_GD
        else rowHDKH.MA_GD = this.khachhang.magd
        if(rowHDKH.MA_HD) this.khachhang.mahd = rowHDKH.MA_HD
        else rowHDKH.MA_HD = this.khachhang.mahd;
        rowHDKH.NGAY_YC = moment(new Date()).format('DD/MM/YYYY') //TODO can doi thanh lay sysdate tu server thong qua ngay_cn cua user login, la goi ham sysdate tu server
      } else {
        rowHDKH.MA_GD = this.khachhang.magd
        rowHDKH.MA_HD = this.khachhang.mahd
        rowHDKH.NGAY_YC = moment(new Date()).format('DD/MM/YYYY') //TODO can doi thanh lay sysdate tu server thong qua ngay_cn cua user login, la goi ham sysdate tu server
      }
      if (!this.khachhang.makh) {
        //TODO sinh ma khach hang
        //this.khachhang.makh = new HoanThienHoSoFacade().SINH_MAKH(Convert.ToInt32(cboDonViQL.SelectedValue));
        this.khachhang.khachhang_id = 0
      }
      rowHDKH.MA_KH = this.khachhang.makh
      if (this.khachhang.khachhang_id > 0) {
        rowHDKH.KHACHHANG_ID = this.khachhang.khachhang_id
        rowHDKH.NGAYLAP_HD = this.NgayLapHD ? this.NgayLapHD : moment(new Date()).format(this.datetimeFormatFull)
      } else {
        if (!this.khachhang.hdkh_id || this.khachhang.hdkh_id == 0) rowHDKH.NGAYLAP_HD = moment(new Date()).format(this.datetimeFormatFull)
        else rowHDKH.NGAYLAP_HD = this.NgayLapHD ? this.NgayLapHD : moment(new Date()).format(this.datetimeFormatFull)
        // rowHDKH.NGAYLAP_HD = this.NgayLapHD;
      }
      rowHDKH.TEN_KH = this.khachhang.tenkh
      rowHDKH.DIACHI_KH = this.diachiKH.DIACHI ? this.diachiKH.DIACHI.trim() : null
      rowHDKH.NGUOI_DD = this.khachhang.nguoidd ? this.khachhang.nguoidd.trim() : null
      rowHDKH.SO_DT = this.khachhang.dienthoai
      rowHDKH.CHUCDANH_DD = this.khachhang.chucvu
      rowHDKH.HOKHAU = this.diachiHK.DIACHI ? this.diachiHK.DIACHI.trim() : null
      if (this.NgayCapHK) rowHDKH.NGAY_HK = this.NgayCapHK
      rowHDKH.NOICAP_HK = this.khachhang.noicaphk ? this.khachhang.noicaphk.trim() : null
      if (this.NgaySinh) rowHDKH.NGAY_SN = this.NgaySinh
      rowHDKH.LOAIGT_ID = this.listbox.loai_gt.value
      rowHDKH.SO_GT = this.khachhang.sogt
      if (this.NgayCap) {
        rowHDKH.NGAYCAP = this.NgayCap
      }
      rowHDKH.NOICAP = this.khachhang.noicap ? this.khachhang.noicap.trim() : null
      rowHDKH.SO_FAX = this.khachhang.fax ? this.khachhang.fax.trim() : null
      rowHDKH.DONVI_ID = this.$root.token.getDonViID()
      rowHDKH.NHANVIEN_ID = this.$root.token.getNhanVienID()
      rowHDKH.KHLON_ID = this.listbox.loai_khl.value
      rowHDKH.LOAIKH_ID = this.listbox.loai_kh.value
      //TODO thieu cai checkbox lapdatbosung nam chim duoi checkbox CTV o tren cung cua form
      // if (chkLapDatBS.Checked)
      //     rowHDKH.BOSUNGTB_ID = 1;
      // else
      rowHDKH.BOSUNGTB_ID = 0
      rowHDKH.LOAIHD_ID = LoaiHopDong.DAT_MOI

      //if (chkKHKT3.Checked)
      //    rowHDKH.KH_KT3 = 1;
      //else
      //    rowHDKH.KH_KT3 = 0;

      rowHDKH.NGUOI_CN = this.$root.token.getUserName()
      rowHDKH.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
      rowHDKH.MAY_CN = this.tt_nd.may_cn
      rowHDKH.IP_CN = 'xxx'

      rowHDKH.GIOITINH = this.khachhang.gioitinh
      rowHDKH.DANTOC_ID = this.listbox.dantoc.value
      rowHDKH.QUOCTICH_ID = this.listbox.quoctich.value
      rowHDKH.NGANHNGHE_ID = this.listbox.nganhngheloc.value
      rowHDKH.DIACHI_NDD = this.diachiNDD.DIACHI
      if (this.NgayHH) {
        rowHDKH.NGAYHETHAN_GT = this.NgayHH
      }
      rowHDKH.MST = this.khachhang.masothue
      if (this.listbox.nganhang.ischeckedkh) {
        rowHDKH.NGANHANG_ID = this.listbox.nganhang.valuekh
        rowHDKH.STK = this.listbox.nganhang.sotaikhoankh ? this.listbox.nganhang.sotaikhoankh.trim() : null
      }

      //TuấnNA thêm tạo dữ liệu tiểu ngành cấp 1,2,3 --- Ngày 03/12/2010
      rowHDKH.TNC1_ID = this.tieunganh.TNC1_ID
      rowHDKH.TNC2_ID = this.tieunganh.TNC2_ID
      rowHDKH.TNC3_ID = this.tieunganh.TNC3_ID
      rowHDKH.TNC4_ID = this.tieunganh.TNC4_ID
      //
      rowHDKH.GHICHU = this.khachhang.ghichu ? this.khachhang.ghichu.trim() : null
      rowHDKH.DACTRUNG = this.khachhang.dactrung ? this.khachhang.dactrung.trim() : null
      //rowHDKH.SO_GT_KEM = CommonFunction.StringToString(txtGiayToKem.Text.trim());

      if (this.filterbox.ctv.ischecked && this.filterbox.ctv.value) {
        rowHDKH.CTV_ID = this.filterbox.ctv.ma_ctv //ctv_id;
        if (this.listbox.hinhthuc_tthi.list && this.listbox.hinhthuc_tthi.list.length > 0) if (this.listbox.hinhthuc_tthi.value) rowHDKH.HTTTHI_ID = this.listbox.hinhthuc_tthi.value //Convert.ToInt32(cboHinhThucTThi.SelectedValue);
      }
      if (this.filterbox.nguoigt.ischecked && this.filterbox.nguoigt.value) {
        rowHDKH.NHANVIENGT_ID = this.filterbox.nguoigt.nguoigt_id //nguoigt_id;
      }

      rowHDKH.KIEUHD_ID = this.listbox.kieu_hd.value
      //vkieuhd_id = Convert.ToInt32(cboKieu_HD.SelectedValue);
      rowHDKH.PHANLOAIKH_ID = this.khachhang.PHANLOAIKH_ID != -1 ? this.khachhang.PHANLOAIKH_ID : 0
      rowHDKH.KENHTN_ID = this.iKenhTN
      //Bổ sung cho HCM theo y/c chị Tô Thảo - TP DHNV TTKD
      rowHDKH.MA_DUAN = this.maduan
      //PNLINH B2A 02/05/2020
      if (this.VPHIEUCSKH_ID != 0) {
        rowHDKH.PHIEUCSKH_ID = this.VPHIEUCSKH_ID
      }
      this.dsHDKH.push(rowHDKH)
      // TODO chua xu ly phan update
      // if (themmoi == false)
      // {
      //     dsHDKH.AcceptChanges();
      //     dsHDKH.HD_KHACHHANG.Rows[0].SetModified();
      // }
    },
    async TaoDuLieu_HDTT(themmoi) {
      var dulieuapi = ''
      this.dsHDTT = []
      var rowHDTT = {}
      await API.post_fn_lay_tt_taodl_hdtt(this.axios, {
        ds_para: JSON.stringify({
          LOAITB_ID: this.listbox.loaihinh_tb.value,
          KHACHHANG_ID: this.khachhang.khachhang_id,
          HDKH_ID: this.khachhang.hdkh_id,
          OPEN_SYNC_VINA_TRASAU: 0,
          MA_TT: this.thanhtoan.matt ? this.thanhtoan.matt : null,
          THEMMOI: themmoi,
          DONVI_QL_ID: this.listbox.donvi_ql.valueql ? this.listbox.donvi_ql.valueql : 0,
          QUANLD_ID: this.diachiLD.QUAN_ID ? this.diachiLD.QUAN_ID : 0,
          NGANHANG_ID: this.listbox.nganhang.value
        })
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          dulieuapi = JSON.parse(response.data.data)
        }
      })
      if (dulieuapi && dulieuapi['ERROR_CODE'] == 1) {
        if (dulieuapi['RESULT']) dulieuapi = dulieuapi['RESULT']
        if (dulieuapi['HDTT_ID']) {
          rowHDTT.HDTT_ID = dulieuapi['HDTT_ID']
          this.hdtt_id = dulieuapi['HDTT_ID']
        } else if (this.hdtt_id) rowHDTT.HDTT_ID = this.hdtt_id
        if (dulieuapi['MA_TT']) rowHDTT.MA_TT = dulieuapi['MA_TT']
      }
      else if(dulieuapi && dulieuapi['ERROR_CODE'] != 1) throw `Lỗi tạo dữ liệu HDTT ${dulieuapi['MESSAGE']}`;
      rowHDTT.HDKH_ID = this.khachhang.hdkh_id
      if (!this.thanhtoan.matt) {
        this.thanhtoan.matt = rowHDTT.MA_TT
        this.thanhtoan.thanhtoan_id = 0
      }
      if (this.thanhtoan.thanhtoan_id > 0) rowHDTT.THANHTOAN_ID = this.thanhtoan.thanhtoan_id

      rowHDTT.MA_TT = this.thanhtoan.matt ? this.thanhtoan.matt.trim() : null
      rowHDTT.TEN_TT = this.thanhtoan.tentt ? this.thanhtoan.tentt.trim() : null
      rowHDTT.DIACHI_TT = this.diachiTT.DIACHI
      rowHDTT.DIACHI_BC = this.diachiBC.DIACHI
      //rowHDTT.MATB_DD = txtMaTT.Text;
      //rowHDTT.MS_NSNN = "";
      //rowHDTT.ML_NSNN = "";
      rowHDTT.MST = this.thanhtoan.masothue ? this.thanhtoan.masothue.trim() : null
      // if (ts_kt_mst_kh == 1)
      //     rowHDTT.MST = txtMST_TT2.Text.trim().Replace(" ", "");
      // else
      //     rowHDTT.MST = txtMST_TT.Text.trim().Replace(" ", "");
      rowHDTT.HTTT_ID = this.listbox.hinhthuc_tt.value
      rowHDTT.STK = this.listbox.nganhang.sotaikhoan ? this.listbox.nganhang.sotaikhoan.trim() : null
      rowHDTT.SO_DT = this.thanhtoan.sodienthoai ? this.thanhtoan.sodienthoai.trim() : null
      rowHDTT.EMAIL = this.thanhtoan.email ? this.thanhtoan.email.trim() : null
      rowHDTT.CHU_TK = this.thanhtoan.chutk ? this.thanhtoan.chutk.trim() : null
      if (dulieuapi['LOAI_NH']) rowHDTT.LOAI_NH = dulieuapi['LOAI_NH']

      if (this.listbox.nganhang.ischecked) {
        rowHDTT.NGANHANG_ID = this.listbox.nganhang.value

        if (rowHDTT.LOAI_NH == '2') {
          rowHDTT.DV_QHNS = this.nganhang.DV_QHNS
          rowHDTT.MACHUONG = this.nganhang.MACHUONG
          rowHDTT.MN_KT = this.nganhang.MN_KT
          rowHDTT.MA_NDKT = this.nganhang.MA_NDKT
          rowHDTT.MN_NSNN = this.nganhang.MN_NSNN
        }
        rowHDTT.TIEN_DM = 0
      }

      rowHDTT.DONVI_ID = this.listbox.donvi_ql.valueql
      if (this.thanhtoan.tuyenthu_id != 0) rowHDTT.TUYENTHU_ID = this.thanhtoan.tuyenthu_id
      rowHDTT.MATB_DD = this.listbox.madaidien.value

      rowHDTT.NGUOI_CN = this.$root.token.getUserName()
      rowHDTT.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
      rowHDTT.MAY_CN = this.tt_nd.may_cn
      rowHDTT.IP_CN = 'xxx'

      //rowHDTT.DIACHI_CT = CommonFunction.StringToString(txtDiaChiCT.Text);
      rowHDTT.DIACHI_CT = this.diachiCT.DIACHI
      rowHDTT.GHICHU = this.thanhtoan.ghichu
      rowHDTT.MATB_DD = this.listbox.madaidien.value

      if (this.listbox.hinhthuc_tc.value && this.listbox.hinhthuc_tc.value > 0) rowHDTT.HTTC_ID = this.listbox.hinhthuc_tc.value
      else rowHDTT.HTTC_ID = HINHTHUC_TC.TRONGOI_THEO_HD

      this.dsHDTT.push(rowHDTT)
      //TODO chua xu ly update
      // if (themmoi == false)
      // {
      //     dsHDTT.AcceptChanges();
      //     dsHDTT.HD_THANHTOAN.Rows[0].SetModified();
      // }
    },
    LoadNVThuCuoc() {
      var diachi = {}
      if (this.diachiBC.DIACHI) diachi = this.diachiBC
      else if (this.diachiTT.DIACHI) diachi = this.diachiTT
      else if (this.diachiKH.DIACHI) diachi = this.diachiKH
      if (!diachi.DIACHI) return

      var pdata = {
        vap_id: diachi.AP_ID ? diachi.AP_ID : 0,
        vdacdiem_id: 0,
        vdonvi_ql_id: this.listbox.donvi_ql.valueql ? this.listbox.donvi_ql.valueql : 0,
        vkhu_id: diachi.KHU_ID ? diachi.KHU_ID : 0,
        //"vphanvung_id": this.$root.token.getPhanVungID(),
        vpho_id: diachi.PHO_ID ? diachi.PHO_ID : 0,
        vphuong_id: diachi.PHUONG_ID
      }
      if (this.listbox.hinhthuc_tt.value && this.listbox.hinhthuc_tt.value > 0 && this.thanhtoan.tuyenthu_httt == 1) {
        API.post_ht_nvtc_theodc_v2(this.axios, pdata)
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //TODO popup chon nhan vien thu cuoc frmTraCuuNVTC
              //Sau do lay du lieu.
              if (response.data.data.length > 0) {
                var obj = response.data.data[0] //BUG lay tam mac dinh nhan vien dau tien

                this.thanhtoan.nhanvientc_id = obj.nhanvien_id
                this.thanhtoan.manvtc = obj.manv_tc
                this.thanhtoan.tuyenthu_id = obj.tuyenthu_id
                this.thanhtoan.matuyen = obj.ma_tuyen
              }
            }
          })
          .catch(() => {})
      } else {
        API.post_ht_nvtc_theodc(this.axios, pdata)
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //TODO popup chon nhan vien thu cuoc frmTraCuuNVTC
              //Sau do lay du lieu.
              if (response.data.data.length > 0) {
                var obj = response.data.data[0] //BUG lay tam mac dinh nhan vien dau tien

                this.thanhtoan.nhanvientc_id = obj.nhanvien_id
                this.thanhtoan.manvtc = obj.manv_tc
                this.thanhtoan.tuyenthu_id = obj.tuyenthu_id
                this.thanhtoan.matuyen = obj.ma_tuyen
              }
            }
          })
          .catch(() => {})
      }
    },
    async HT_GIAODIEN_DONVI() {
      if (!this.listbox.kieu_ld.value || this.listbox.kieu_ld.value <= 0) return
      var tocdotn_id = 0
      var muccuoctn_id = 0
      // TODO xu ly cac phan nay theo qua trinh lam
      if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.HATANG_VIENTHONG || this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC) {
        tocdotn_id = this.listbox.cboGoiCuocAdsl.value
        if ((this.listbox.muccuoc.isenabled && this.listbox.dichvu_vt.value != DichVuVienThong.BRCD_DOITAC) || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) muccuoctn_id = this.listbox.muccuoc.value
      } else if (this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT || this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT || this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU || this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH)
        tocdotn_id = this.listbox.cboGoiCuocAdsl.value
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) tocdotn_id = this.listbox.cboGoiCuocAdsl.value
      else if ((this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) && this.listbox.tocdokenh.valuetsl != null && this.listbox.tocdokenh.valuetsl != '') tocdotn_id = this.listbox.tocdokenh.valuetsl
      //Convert.ToInt32(cboTocDoKenhTSL.EditValue);
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) tocdotn_id = this.listbox.tocdokenh.valuecir

      // if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH){

      var j_loaikenh_id = 0
      if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) j_loaikenh_id = this.listbox.loaikenh.value
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) j_loaikenh_id = this.listbox.loaikenh.valuetsl
      else j_loaikenh_id = 0
      await API.post_fn_lay_tt_giaodien_dvi(this.axios, {
        // tinhthicong_id: this.tinh.tinhthicong_id,
        ds_para: JSON.stringify({
          // p_ds_para: JSON.stringify({
          DICHVUVT_ID: this.listbox.dichvu_vt.value,
          TOCDOTN_ID: tocdotn_id ? tocdotn_id : 0,
          MUCCUOCTN_ID: muccuoctn_id,
          LOAITB_ID: this.listbox.loaihinh_tb.value,
          KIEULD_ID: this.listbox.kieu_ld.value,
          DAIVT_ID: this.listbox.donvi_ql.value,
          HT_LOC_CBO_TRAM: this.ht_loc_cbo_tram ? 1 : 0,
          PHUONGLD_ID: this.diachiLD.PHUONG_ID,
          PHOLD_ID: this.diachiLD.PHO_ID,
          APLD_ID: this.diachiLD.AP_ID,
          KHULD_ID: this.diachiLD.KHU_ID,
          DACDIEM_ID: this.diachiLD.DACDIEM_ID,
          LOAIKENH_ID: j_loaikenh_id,
          BANCHEO: 1
        })
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          var dulieuapi = JSON.parse(response.data.data)
          if (dulieuapi['RESULT']['DT_CONTROLS']) this.DT_CONTROLS.list = dulieuapi['RESULT']['DT_CONTROLS']
          if (dulieuapi['RESULT']['DS_DATA']) this.DT_CONTROLS.data = dulieuapi['RESULT']['DS_DATA']
          if (dulieuapi['RESULT']['DS_GT_DVI']) this.DT_CONTROLS.value = dulieuapi['RESULT']['DS_GT_DVI']
          for (var i = 0; i < this.DT_CONTROLS.data.length; i++) {
            if (this.DT_CONTROLS.data[i] && this.DT_CONTROLS.data[i].length > 0 && !this.DT_CONTROLS.value[i]) {
              this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0].DONVI_ID
              this.DT_CONTROLS.tagvalue[i] = this.DT_CONTROLS.data[i][0].LOAIDV_ID
            }
            if (this.kiemtra_nhanvien_vti == 1 && this.DT_CONTROLS.data[i] && (this.DT_CONTROLS.data[i][0]["loaidv_dich_id".toUpperCase()] == LOAI_DV.TTKD_NGHIEMTHU
                || this.DT_CONTROLS.data[i][0]["loaidv_dich_id".toUpperCase()] == LOAI_DV.HOANTHIEN_HOSO))
                this.DT_CONTROLS.value[i] = 35133;//Phòng Khách hàng doanh nghiệp quốc tê
          }
          this.DT_CONTROLS.dichvu_vt = this.listbox.dichvu_vt.value
          this.DT_CONTROLS.key += 1
        }
      })
      // }
      //TODO doan con lai co ve khong lam gi hon ngoai gan gia tri mac dinh (DS_GT_DVI), do do khong can thuc hien gi them.
    },
    async TaoDuLieu_HDTB(themmoi) {
      // #region HD_THUEBAO_DATA
      this.dsHDTB = []

      var rowHDTB = {}
      this.ma_tb_ht = this.thuebao.codinh.somay
      await this.LayMaTB(false) // Xu ly lai this.ma_tb_ht
      await this.LayMaTBBC(false)
      var ds_chitiet_km = []
      let thuebao_id = this.thuebao.thuebao_id
      var STATUS_TONGDAI_CD = false
      if (themmoi) {
        //var pdata = {
        //  kieuLdId: this.listbox.kieu_ld.value,
        //  loaiHdId: themmoi ? LoaiHopDong.DAT_MOI : '1',
        //  loaiTbId: this.listbox.loaihinh_tb.value,
        //  mucCuocId: this.listbox.muccuoc.value && this.listbox.muccuoc.value > 0 ? this.listbox.muccuoc.value : -1,
        //  tocDoId: -1
        //}
        //await API.post_lay_huonggiao_tiepnhan(this.axios, pdata).then((response) => {
        //  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
        //    var dulieuapi = response.data.data
        //    if (dulieuapi['huonggiao_id']) this.huonggiao_tn = dulieuapi['huonggiao_id']
        //    if (dulieuapi['quytrinh_id']) this.quytrinh_tn = dulieuapi['quytrinh_id']
        //    if (dulieuapi['luong_id']) this.luong_id = dulieuapi['luong_id']
        //  }
        //})

        if ((this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) && (!this.thuebao.tsl.txtMaTSL.Text || this.thuebao.tsl.txtMaTSL.Text.trim().length == 0)) {
          this.SinhMaDVVT_BC()
        }

        if (
          this.thamsomacdinh['TS_SINH_MATB_DOITAC'] == 1 &&
          (this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.IMS_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC)
        ) {
          this.SINH_MATB_DICHVU_DOITAC()
        }
      }
      await API.post_fn_lay_tt_taodl_hdtb(this.axios, {
        kieu: 1,
        ds_para: JSON.stringify({ THEMMOI: themmoi, MA_TB_HT: this.ma_tb_ht, MUCUOCTB_ID: this.listbox.muccuoc_tb.value, LUONG_ID: this.luong_id, CODE: 'STATUS_TONGDAI_CD', DS_CHITIETKM_ID: ds_chitiet_km && ds_chitiet_km.length > 0 ? ds_chitiet_km : null, KIEULD_ID: this.listbox.kieu_ld.value })
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          var dulieuapi = JSON.parse(response.data.data)
          if (dulieuapi && dulieuapi['ERROR_CODE'] == 1) {
            if (dulieuapi['RESULT']) dulieuapi = dulieuapi['RESULT']
            if (dulieuapi['HDTB_ID']) {
              rowHDTB.HDTB_ID = dulieuapi['HDTB_ID']
              this.hdtb_id = dulieuapi['HDTB_ID']
            }
            if (dulieuapi['MUCUOC_TB']) rowHDTB.MUCUOC_TB = dulieuapi['MUCUOC_TB']
            if (dulieuapi['DS_CTKM_LTBI']) {
              rowHDTB.DS_CTKM_LTBI = dulieuapi['DS_CTKM_LTBI']
              this.DS_CTKM_LTBI = rowHDTB.DS_CTKM_LTBI
            }
            if (dulieuapi['STATUS']) STATUS_TONGDAI_CD = true
            if (dulieuapi['THUEBAO_ID']) thuebao_id = dulieuapi['THUEBAO_ID']
          }
          else if(dulieuapi) throw `Lỗi tạo dữ liệu HDTB: ${dulieuapi['MESSAGE']}`;
        }
        else throw `Lỗi tạo dữ liệu HDTB ${response.data.message}: ${response.data.message_detail}`;
      })
      if ((!rowHDTB.HDTB_ID || rowHDTB.HDTB_ID == 0) && this.hdtb_id && this.hdtb_id > 0) rowHDTB.HDTB_ID = this.hdtb_id
      if (themmoi) rowHDTB.HDTT_ID = this.hdtt_id
      else rowHDTB.HDTT_ID = this.listbox.thanhtoancbo.value && this.listbox.thanhtoancbo.value > 0 ? this.listbox.thanhtoancbo.value : this.hdtt_id
      rowHDTB.HDKH_ID = this.khachhang.hdkh_id

      if (thuebao_id > 0) rowHDTB.THUEBAO_ID = thuebao_id

      // await this.LayMaTB(false); //Goi truoc o phia tren de xu ly cac API can dung toi o tren.
      rowHDTB.MA_TB = this.ma_tb_ht ? this.ma_tb_ht.toLowerCase() : null

      //Hieutc: fix cho Nghệ an tạm vì ws VASC tự hoa hết mới điên
      //CƯờng đi uống về bị say-> anh Hiếu bắt sửa nếu sai anh em sửa lại hộ
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV && this.thamsomacdinh['MYTV_HOA'] == 1) rowHDTB.MA_TB = rowHDTB.MA_TB.toUpperCase()

      if ((this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.dichvu_vt.value == DichVuVienThong.HATANG_VIENTHONG) && this.thamsomacdinh['FIBER_HOA'] == 1) rowHDTB.MA_TB = rowHDTB.MA_TB.toUpperCase()

      if ((this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) && this.thamsomacdinh['MGW_MTN_KTR_HOA'] == 1) rowHDTB.MA_TB = rowHDTB.MA_TB.toUpperCase()

      if (
        (this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT || this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT || this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU || this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH) &&
        this.thamsomacdinh['CNTT_HOA'] == 1
      )
        rowHDTB.MA_TB = rowHDTB.MA_TB.toUpperCase().trim()

      if (!rowHDTB.MA_TB) {
        // this.$toast.error("Mã thuê bao / số máy / account không được phép để trống!");
        throw 'Lỗi: Mã thuê bao / số máy / account không được phép để trống!'
      }
      if (this.listbox.kieu_ld.value == KieuLapDat.DM_DIDONG_C_P) {
        // vuth update 26/12 set thuebao_id
        if (thuebao_id > 0) rowHDTB.THUEBAO_ID = thuebao_id
      }

      rowHDTB.TEN_TB = this.thuebao.tentb ? this.thuebao.tentb.trim() : null
      rowHDTB.DIACHI_TB = this.diachiTB.DIACHI
      rowHDTB.GHICHU = this.thuebao.ghichu
      rowHDTB.KIEULD_ID = this.listbox.kieu_ld.value
      rowHDTB.LOAITB_ID = this.listbox.loaihinh_tb.value
      rowHDTB.DOITUONG_ID = this.listbox.doituong.value
      rowHDTB.DONVI_ID = this.listbox.donvi_ql.value
      rowHDTB.TTHD_ID = TrangThaiHD.MOI
      rowHDTB.DICHVUVT_ID = this.listbox.dichvu_vt.value
      if (this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG) rowHDTB.NGAY_HT = this.NgayYeuCau //dtpNgayYeuCau.Value;
      rowHDTB.KIEU_TB = '0' //Kiểu thuê bao thường.

      rowHDTB.NGUOI_CN = this.$root.token.getUserName()
      rowHDTB.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
      rowHDTB.MAY_CN = this.tt_nd.may_cn
      rowHDTB.IP_CN = 'xxx'

      rowHDTB.CHUYENMANG = this.listbox.nhacc_cu.ischecked ? 1 : 0
      if (this.listbox.nhacc_cu.ischecked) {
        if (this.listbox.nhacc_cu.value && this.listbox.nhacc_cu.value > 0) rowHDTB.NHACC_CU_ID = this.listbox.nhacc_cu.value
        if (this.listbox.hinhthuc_cm.value && this.listbox.hinhthuc_cm.value > 0) rowHDTB.HTCM_ID = this.listbox.hinhthuc_cm.value
      }
      //TODO tim xem load phan TBHD_PL nhu the nao???
      rowHDTB.TBHD_PL = this.thuebao.tbhd_pl ? this.thuebao.tbhd_pl : 1 //TBHD_PL; // Tuan them truong TBHD_PL cho thue bao --> 1 <-> In HD; 0 <-> In PL --- Ngay 24/08/2010
      rowHDTB.DIACHI_LD = this.diachiLD.DIACHI
      if (this.NgaySinhTB) {
        if(moment(this.NgaySinhTB).isValid())
          rowHDTB.NGAY_SN = moment(this.NgaySinhTB).format('DD/MM/YYYY')
        else
          rowHDTB.NGAY_SN = this.NgaySinhTB
      }

      if (this.listbox.muccuoc_tb.value > 0 && this.listbox.kieu_ld.value != 13224) {
        // tổng rà soát 12.2020 duongpd
        rowHDTB.MUCUOCTB_ID = this.listbox.muccuoc_tb.value
        //rowHDTB.MUCUOC_TB da lay o phia tren
        //rowHDTB.MUCUOC_TB = objCheckData.MAP_ID("cuoc_tb", DatabaseConstants.DB2 + ".muccuoc_tb", "where mucuoctb_id = " + Convert.ToInt32(cboMucCuocTB.SelectedValue)));
      }
      if (this.listbox.kieu_ld.value == 13224) {
        rowHDTB.MUCUOCTB_ID = 20000 // mức cước tổng rà soát
        rowHDTB.MUCUOC_TB = 1
      }
      if (
        rowHDTB.DICHVUVT_ID == DichVuVienThong.DI_DONG ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.ADSL ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.IMS ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.DICHVU_CNTT ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.ANTOAN_BAOMAT_TT ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.HOINGHI_TRUYENHINH ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.TRUNGTAM_DULIEU ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.HATANG_VIENTHONG
      ) {
        if (
          rowHDTB.LOAITB_ID != LoaiHinhTB.INTERNET_MYTV &&
          rowHDTB.LOAITB_ID != LoaiHinhTB.HTVC_FIBERVNN_ANALOG &&
          rowHDTB.LOAITB_ID != LoaiHinhTB.HTVC_FIBERVNN_DIGITAL &&
          rowHDTB.DICHVUVT_ID != DichVuVienThong.DICHVU_CNTT &&
          rowHDTB.DICHVUVT_ID != DichVuVienThong.ANTOAN_BAOMAT_TT &&
          rowHDTB.DICHVUVT_ID != DichVuVienThong.TRUNGTAM_DULIEU &&
          rowHDTB.DICHVUVT_ID != DichVuVienThong.HOINGHI_TRUYENHINH &&
          rowHDTB.DICHVUVT_ID != DichVuVienThong.HATANG_VIENTHONG &&
          rowHDTB.DICHVUVT_ID != DichVuVienThong.IMS
        )
          //Xet doi voi thue bao di dong tra sau hoac adsl, ftth
          rowHDTB.STATUS = '0'
        //BUG cho nay chua xu ly//themmoi ? "0" : txtStatus.Text; //HungHM - trạng thái đồng bộ
        else rowHDTB.STATUS = '0' //Doi voi thue bao mytv, IMS
      }

      if (rowHDTB.DICHVUVT_ID == DichVuVienThong.BRCD_DOITAC) rowHDTB.STATUS = '0'

      if (rowHDTB.DICHVUVT_ID == DichVuVienThong.GPHONE) rowHDTB.STATUS = '1'

      if (rowHDTB.DICHVUVT_ID == DichVuVienThong.CO_DINH) {
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.PABX || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN2B_CD || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN2B_CQ || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN30B_CD || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN30B_CQ) {
          if (this.thuebao.loaisochinh == 1) {
            if (this.thuebao.thuebao_id_cha != 0) rowHDTB.THUEBAO_CHA_ID = this.thuebao.thuebao_id_cha
          } else if (this.thuebao.hdtb_id_cha != 0) rowHDTB.HDTB_CHA_ID = this.thuebao.hdtb_id_cha
        } else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.TRUNGKE_THUONG || this.listbox.loaihinh_tb.value == LoaiHinhTB.TRUNGKE_TUONGTU || this.listbox.loaihinh_tb.value == LoaiHinhTB.TRUNGKE_2M) {
          if (this.thuebao.loaisochinh == 1) {
            if (this.thuebao.thuebao_id_cha != 0) rowHDTB.THUEBAO_CHA_ID = this.thuebao.thuebao_id_cha
          } else if (this.thuebao.hdtb_id_cha != 0) rowHDTB.HDTB_CHA_ID = this.thuebao.hdtb_id_cha
        }
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
        if (this.thuebao.loaisochinh == 1) {
          if (this.thuebao.thuebao_id_cha != 0) rowHDTB.THUEBAO_CHA_ID = this.thuebao.thuebao_id_cha
        } else {
          if (this.thuebao.hdtb_id_cha != 0) rowHDTB.HDTB_CHA_ID = this.thuebao.hdtb_id_cha
        }
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.IMS && this.listbox.loaihinh_tb.value == LoaiHinhTB.IMS_SIPTRUNKING) {
        if (this.thuebao.ims.cbkTrunk) {
          //DataTable dt = (DataTable)cboTrunk.Properties.DataSource;
          if (this.thuebao.ims.cboTrunk.value && this.thuebao.ims.cboTrunk.value != 0) {
            //string loai = dt.Select("id = " + cboTrunk.EditValue)[0]["loai"];
            var loai = this.thuebao.ims.cboTrunk.list.filter((x) => x.id == this.thuebao.ims.cboTrunk.value)[0]['loai']
            if (loai == '1') rowHDTB.HDTB_CHA_ID = this.thuebao.ims.cboTrunk.value
            if (loai == '2') rowHDTB.THUEBAO_CHA_ID = this.thuebao.ims.cboTrunk.value
          }
        }
      }

      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
        if (this.thuebao.adsl.isHopDong == 1) {
          if (this.listbox.cboHDChinh.value) rowHDTB.HDTB_CHA_ID = this.listbox.cboHDChinh.value
        } else if (this.thuebao.adsl.isHopDong == 0) {
          if (this.listbox.cboDbChinh.value) rowHDTB.THUEBAO_CHA_ID = this.listbox.cboDbChinh.value
        }
      }

      if (STATUS_TONGDAI_CD) rowHDTB.STATUS = '0'

      //HungHM - 06/09/2010 thêm dvql đầu + cuối
      rowHDTB.DONVI_DAU_ID = this.listbox.donvi_dau.value
      rowHDTB.DONVI_CUOI_ID = this.listbox.donvi_cuoi.value

      if (this.kt_thuenganhan == true) {
        rowHDTB.TG_THUE_TU = this.TGThueTuNgay ? this.TGThueTuNgay : null
        rowHDTB.TG_THUE_DEN = this.TGThueDenNgay ? this.TGThueDenNgay : null
      } else {
        rowHDTB.TG_THUE_TU = null
        rowHDTB.TG_THUE_DEN = null
      }

      rowHDTB.QUYTRINH_ID = this.quytrinh_tn
      if (this.listbox.goi_kt.value > 0) {
        rowHDTB.GOIKT_ID = this.listbox.goi_kt.value
      }
      if (this.thuebao.thangck > 0) rowHDTB.SOTHANG_CK = this.thuebao.thangck

      if (this.thuebao.doituong_ct_id != 0) rowHDTB.DOITUONG_CT_ID = this.thuebao.doituong_ct_id
      //VinhPV thêm lựa chọn trạng thái yêu cầu (KH xây/sửa nhà) 27/02/2019
      if (this.listbox.trangthai_yc.value > 0) {
        //(CAPNHAT_TRANGTHAI_YEUCAU)
        rowHDTB.TRANGTHAIYC_ID = this.listbox.trangthai_yc.value //Convert.ToInt32(cboTrangThaiYC.SelectedValue);
      } else rowHDTB.TRANGTHAIYC_ID = 1
      this.dsHDTB.push(rowHDTB)
      // if (themmoi == false)
      // {
      //     dsHDTB.AcceptChanges();
      //     dsHDTB.HD_THUEBAO.Rows[0].SetModified();
      // }
      // #endregion
      // TODO Chua ro nghiep vu phan cuoi nay, xu ly sau.
      // //tien tra gop luu 1 lan thoi
      var blKiemTraTraGop = false
      // //longdx: bo sung thong tin hdtb_id vao bang khuyenmai, dat coc
      for (var row of this.dsDC_HDTB) {
        row.HDTB_ID = this.hdtb_id
        row.TIEN_TG = this.TongTien_TG(row.CHITIETKM_ID)
        if (row.TIEN_TG > 0) blKiemTraTraGop = true
      }
      for (var row of this.dsKM_HDTB) {
        row.HDTB_ID = this.hdtb_id
        if (!blKiemTraTraGop) row.TIEN_TG = this.TongTien_TG(row.CHITIETKM_ID)
      }
      for (var row of this.dsTRAGOP_TBI_HDTB) {
        row.HDTB_ID = this.hdtb_id
      }
    },
    TaoDuLieu_HDTB_DUNGTHU() {
      this.dsHDTB_DUNGTHU = []
      var rowHDTB = {}
      rowHDTB.HDTB_ID = this.hdtb_id
      rowHDTB.SONGAY = this.thuebao.tgdungthu
      //TODO dung thu cac dich vu khong phai co dinh, chua xay dung
      rowHDTB.NGUOI_CN = this.$root.token.getUserName()
      rowHDTB.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
      rowHDTB.MAY_CN = this.tt_nd.may_cn
      rowHDTB.IP_CN = 'xxx'
      this.dsHDTB_DUNGTHU.push(rowHDTB)
    },
    TaoDuLieu_HDTT_NV(themmoi) {
      //TODO can xem cach load nhanvien_ql_am_id
      if (this.nhanvien_ql_am_id != 0) {
        var rowhdtt_nv = {}
        rowhdtt_nv.HDTT_ID = this.hdtt_id
        rowhdtt_nv.NHANVIEN_ID = this.nhanvien_ql_am_id
        rowhdtt_nv.MAY_CN = this.tt_nd.may_cn
        rowhdtt_nv.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
        rowhdtt_nv.NGUOI_CN = this.$root.token.getUserName()
        this.dsHDTT_NV.push(rowhdtt_nv)
      }
    },
    TaoDuLieu_THONGTIN_TT(themmoi) {
      //Khong co code, 100% comment
    },
    async TaoDuLieu_CT_TIENHD(themmoi) {
      this.dsCTTHD = []
      var rowCTTHD = {}
      //this.listbox.tien_km.list = this.ds_tien_khoanmuc.Tables[0] (load o khi load form)
      for (var km of this.ds_tien_khoanmuc) {
        if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_MUATHIETBI) {
          for (var tb of this.dsCTM_TBI) {
            var rowCTTHD = {}
            rowCTTHD.HDTB_ID = this.hdtb_id
            if (themmoi) {
              await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                }
              })
            }
            rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']
            var tien = 0
            var vat = 0
            var soluong = 1
            if (tb['soluong']) soluong = tb['soluong']
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IOFFICE || this.listbox.loaihinh_tb.value == LoaiHinhTB.HNTH_NGN || this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING) {
              if (tb['sl_cha'] && tb['sl_cha'] != 0) {
                h_sl_cha = tb['sl_cha']
                h_block_dau = tb['block_dau']
                h_block_tiep = tb['block_tiep']
                h_gia_block = tb['gia_block_tiep']
                h_vat_block = tb['vat_block_tiep']
                h_sl_conlai = 0

                if (h_sl_cha >= h_block_dau) {
                  h_sl_conlai = h_sl_cha - h_block_dau

                  var t2 = h_sl_conlai % h_block_tiep
                  h_sl_bl = 0
                  if (t2 > 0) h_sl_bl = h_sl_conlai / tb['block_tiep'] + 1
                  else h_sl_bl = h_sl_conlai / tb['block_tiep']

                  var tien_block = 0
                  var vat_block = 0

                  tien_block = h_sl_bl * tb['gia_block_tiep']
                  vat_block = h_sl_bl * tb['vat_block_tiep']
                  tien = (tb['tien'] + tien_block) * soluong
                  vat = (tb['vat'] + vat_block) * soluong
                }
              } else {
                tien = tb['tien'] * soluong
                vat = tb['vat'] * soluong
              }
            } else {
              tien = tb['tien'] * soluong
              vat = tb['vat'] * soluong
            }
            rowCTTHD.TIEN = tien ? tien * 1 : 0
            rowCTTHD.VAT = vat ? vat * 1 : 0
            rowCTTHD.ID = tb['loaitbi_id']
            rowCTTHD.LOAI_ID = 3
            rowCTTHD.TYLE_VAT = tb['tyle_vat']
            rowCTTHD.TYLE_VAT_ID = tb['tyle_vat_id']
            this.dsCTTHD.push(rowCTTHD)
          }
        } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI) {
          for (var tb of this.dsCTM_TBI) {
            // TODO dsCTM_TBI lay o danh sach mua thiet bi (nut)
            var rowCTTHD = {}
            rowCTTHD.HDTB_ID = this.hdtb_id
            if (themmoi) {
              await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                }
              })
            }
            rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']
            var tien
            var vat
            var soluong = 1
            soluong = tb['soluong']

            tien = tb['tien_km'] * soluong
            vat = tb['vat_km'] * soluong

            rowCTTHD.TIEN = tien && Math.abs(tien) ? Math.abs(tien) * -1 : 0
            rowCTTHD.VAT = vat && Math.abs(vat) ? Math.abs(vat) * -1 : 0
            rowCTTHD.ID = tb['loaitbi_id']
            rowCTTHD.LOAI_ID = 3
            rowCTTHD.TYLE_VAT = tb['tyle_vat']
            rowCTTHD.TYLE_VAT_ID = tb['tyle_vat_id']
            this.dsCTTHD.push(rowCTTHD)
          }
        } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_TRATRUOC_THIETBI) {
          for (var tb of this.dsCTM_TBI) {
            // TODO dsCTM_TBI lay o danh sach mua thiet bi (nut)
            var rowCTTHD = {}
            rowCTTHD.HDTB_ID = this.hdtb_id
            if (themmoi) {
              await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                }
              })
            }
            rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']
            var tien
            var vat
            var soluong = 1
            soluong = tb['soluong']

            tien = tb['tien_tratruoc'] * soluong
            vat = tb['vat_tratruoc'] * soluong

            rowCTTHD.TIEN = tien ? tien * 1 : 0
            rowCTTHD.VAT = vat ? vat * 1 : 0
            rowCTTHD.ID = tb['loaitbi_id']
            rowCTTHD.LOAI_ID = 3
            rowCTTHD.TYLE_VAT = tb['tyle_vat']
            rowCTTHD.TYLE_VAT_ID = tb['tyle_vat_id']
            this.dsCTTHD.push(rowCTTHD)
          }
        } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DICHVU) {
          for (var dv of this.m_dsThueBao_DichVu) {
            // TODO m_dsThueBao_DichVu lay o danh sach dich vu gia tang (nut btnEditDVGT)
            if (dv['dangky'] == 1 && dv['huy'] == 0) {
              var rowCTTHD = {}
              rowCTTHD.HDTB_ID = this.hdtb_id
              if (themmoi) {
                await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                  }
                })
              }
              rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']
              var tien = 0
              var vat = 0

              tien = dv['cuoc_ld']
              vat = dv['vat_ld']

              rowCTTHD.TIEN = tien ? tien * 1 : 0
              rowCTTHD.VAT = vat ? vat * 1 : 0
              rowCTTHD.ID = dv['dichvugt_id']
              rowCTTHD.LOAI_ID = 2
              rowCTTHD.TYLE_VAT = dv['tyle_vat']
              rowCTTHD.TYLE_VAT_ID = dv['tyle_vat_id']
              this.dsCTTHD.push(rowCTTHD)
            }
          }
        } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DVGT) {
          for (var dv of this.m_dsThueBao_DichVu) {
            // TODO m_dsThueBao_DichVu lay o danh sach dich vu gia tang (nut btnEditDVGT)
            if (dv['dangky'] == 1 && dv['huy'] == 0) {
              var tien = 0
              var vat = 0

              tien = dv['cuoc_kmld']
              vat = dv['vat_kmld']
              if (tien != 0 && vat != 0) {
                var rowCTTHD = {}
                rowCTTHD.HDTB_ID = this.hdtb_id
                if (themmoi) {
                  await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                    if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                      rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                    }
                  })
                }
                rowCTTHD.KHOANMUCTT_ID = KHOANMUC_TT.KMTT_KM_DVGT

                rowCTTHD.TIEN = tien && Math.abs(tien) ? Math.abs(tien) * -1 : 0
                rowCTTHD.VAT = vat && Math.abs(vat) ? Math.abs(vat) * -1 : 0
                rowCTTHD.ID = dv['dichvugt_id']
                rowCTTHD.LOAI_ID = 2
                rowCTTHD.TYLE_VAT = dv['tyle_vat']
                rowCTTHD.TYLE_VAT_ID = dv['tyle_vat_id']
                this.dsCTTHD.push(rowCTTHD)
              }
            }
          }
        } else {
          if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT || km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI || km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DATCOC) {
            var rowCTTHD = {}
            rowCTTHD.HDTB_ID = this.hdtb_id
            if (themmoi) {
              await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                }
              })
            }
            rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']

            if (km['tien'] > 0) {
              rowCTTHD.TIEN = km['tien'] ? km['tien'] * -1 : 0
              rowCTTHD.VAT = km['vat'] ? km['vat'] * -1 : 0
            } else {
              rowCTTHD.TIEN = km['tien'] ? km['tien'] * 1 : 0
              rowCTTHD.VAT = km['vat'] ? km['vat'] * 1 : 0
            }
            rowCTTHD.ID = km['khoanmuctt_id']
            rowCTTHD.LOAI_ID = 1

            rowCTTHD.TYLE_VAT = 10
            rowCTTHD.TYLE_VAT_ID = 1
            this.dsCTTHD.push(rowCTTHD)
          }
          //#region vuth them tien so dep di dong tra sau
          else if (TRANGTHAI_DONGBO.OPEN_SYNC_VINA_TRASAU && this.listbox.kieu_ld.value == KieuLapDat.DM_DIDONG && km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_SODEP) {
            var dtTienCcbs = await this.LayTienSoDepDDTraSau('84' + (this.thuebao.didong.txtSoMayDD + '').trim())

            var rowCTTHD = {}
            rowCTTHD.HDTB_ID = this.hdtb_id
            if (themmoi)
              await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                }
              })
            rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']

            rowCTTHD.TIEN = dtTienCcbs[0]['tiendv'] ? dtTienCcbs[0]['tiendv'] * 1 : 0
            rowCTTHD.VAT = dtTienCcbs[0]['tiendvvat'] ? dtTienCcbs[0]['tiendvvat'] * 1 : 0
            rowCTTHD.ID = km['khoanmuctt_id']
            rowCTTHD.LOAI_ID = 1

            rowCTTHD.TYLE_VAT = 10
            rowCTTHD.TYLE_VAT_ID = 1

            this.dsCTTHD.push(rowCTTHD)
          }
          //#endregion vuth them tien so dep di dong tra sau
          else {
            // #region cuonglt.hpg 24/01/2022 - Còn lại
            let codl_ctkm = false;
            if (this.m_dsTienCTKM != null && this.m_dsTienCTKM.length > 0)
            {
              for (let dtr of this.m_dsTienCTKM)
              {
                //1 la KMTT DATCOC
                if ((dtr["tien"] != 0 || dtr["vat"] != 0) && dtr["kieu"] == 2 && dtr["khoanmuctt_id"] == km["khoanmuctt_id"])
                {
                    let rowCTTHD = {};
                    rowCTTHD.HDTB_ID = this.hdtb_id;
                    if (themmoi)
                      await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                          rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                        }
                      })
                    rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id'];

                    rowCTTHD.TIEN = dtr["tien"]?dtr["tien"]*1:0;
                    rowCTTHD.VAT = dtr["vat"]?dtr["vat"]*1:0;
                    rowCTTHD.ID = dtr["id"];
                    rowCTTHD.LOAI_ID = 1;
                    rowCTTHD.TYLE_VAT = dtr["tyle_vat"]*1;
                    rowCTTHD.TYLE_VAT_ID = dtr["tyle_vat_id"]*1;

                    // end hoàng

                    this.dsCTTHD.push(rowCTTHD)
                    codl_ctkm = true;
                }
              }
            }
            if (!codl_ctkm)
            {
                // #region Trường hợp còn lại
                ////Lamnt: Bỏ zem đoạn này do khoản mục = 0 không insert vào ct_tienhd -> không thanh toán được.
                ////11/06/2019
                ////Cuonglt mở lại theo yêu cầu anh Hiếu BABA
                if (km["tien"] != 0 || km["vat"] != 0)
                {
                    let rowCTTHD = {};
                    rowCTTHD.HDTB_ID = this.hdtb_id;
                    if (themmoi)
                      rowCTTHD.CT_TIENHD_ID = await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                          return response.data.data;
                        }
                      })
                    rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id'];

                    rowCTTHD.TIEN = km['tien']?km['tien'] * 1:0
                    rowCTTHD.VAT = km['vat']?km['vat'] * 1:0
                    rowCTTHD.ID = km['khoanmuctt_id'] * 1
                    rowCTTHD.LOAI_ID = 1;

                    // hoangpkn : 20/08/2019. Tạm fix

                    if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
                      rowCTTHD.TYLE_VAT = this.vtyle_vat_dnhm
                      rowCTTHD.TYLE_VAT_ID = this.vtyle_vat_id_dnhm
                    } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
                      rowCTTHD.TYLE_VAT = this.vtyle_vat_cd
                      rowCTTHD.TYLE_VAT_ID = this.vtyle_vat_id_cd
                    } else {
                      rowCTTHD.TYLE_VAT = 10
                      rowCTTHD.TYLE_VAT_ID = 1
                    }
                    // end hoàng

                    this.dsCTTHD.push(rowCTTHD)
                }
                // #endregion
            }
            // #endregion

          }
          // else {
          //   ////Lamnt: Bỏ zem đoạn này do khoản mục = 0 không insert vào ct_tienhd -> không thanh toán được.
          //   ////11/06/2019
          //   ////Cuonglt mở lại theo yêu cầu anh Hiếu BABA
          //   if (km['tien'] != 0 || km['vat'] != 0) {
          //     var rowCTTHD = {}
          //     rowCTTHD.HDTB_ID = this.hdtb_id
          //     if (themmoi) {
          //       await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
          //         if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          //           rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
          //         }
          //       })
          //     }
          //     rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']

          //     rowCTTHD.TIEN = km['tien'] ? km['tien'] * 1 : 0
          //     rowCTTHD.VAT = km['vat'] ? km['vat'] * 1 : 0
          //     rowCTTHD.ID = km['khoanmuctt_id']
          //     rowCTTHD.LOAI_ID = 1

          //     // hoangpkn : 20/08/2019. Tạm fix
          //     if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
          //       rowCTTHD.TYLE_VAT = this.vtyle_vat_dnhm
          //       rowCTTHD.TYLE_VAT_ID = this.vtyle_vat_id_dnhm
          //     } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
          //       rowCTTHD.TYLE_VAT = this.vtyle_vat_cd
          //       rowCTTHD.TYLE_VAT_ID = this.vtyle_vat_id_cd
          //     } else {
          //       rowCTTHD.TYLE_VAT = 10
          //       rowCTTHD.TYLE_VAT_ID = 1
          //     }
          //     // end hoàng
          //     this.dsCTTHD.push(rowCTTHD)
          //   }
          // }
        }
      }
      if (this.dsCTTHD.length == 0) {
        var rowCTTHD = {}
        rowCTTHD.HDTB_ID = this.hdtb_id
        if (themmoi) {
          await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              rowCTTHD.CT_TIENHD_ID = response.data.data
            }
          })
        }
        // rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']
        rowCTTHD.KHOANMUCTT_ID = 1
        rowCTTHD.TIEN = 0
        rowCTTHD.VAT = 0
        rowCTTHD.ID = 1
        rowCTTHD.LOAI_ID = 1
        this.dsCTTHD.push(rowCTTHD)
      }
    },
    async TaoDuLieu_DiaChi(themmoi, kieu) {
      this.dsDiaChi = []
      this.dsDiaChiHDKH = []
      this.dsDiaChiHDTT = []
      this.dsDiaChiHDTB = []
      var diachikh_id = this.diachiKH.DIACHI_ID
      if (kieu == 1 || kieu == 4) {
        var rowDiaChiKH = {}

        if (themmoi)
          await API.post_fn_lay_tt_taodl_diachi(this.axios, { ds_para: JSON.stringify({ THEMMOI: themmoi, KIEU: kieu ? kieu : 1, DICHVUVT_ID: this.listbox.dichvu_vt.value }) }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //"data": "{\"ERROR_CODE\":1,\"MESSAGE\":\"Thành công\",\"RESULT\":{\"DIACHIKH_ID\":20025699}}"
              var dulieuapi = JSON.parse(response.data.data)
              if (dulieuapi['RESULT']['DIACHIKH_ID']) diachikh_id = dulieuapi['RESULT']['DIACHIKH_ID']
              if (!this.diachiKH.DIACHI_ID || this.diachiKH.DIACHI_ID == 0) this.diachiKH.DIACHI_ID = diachikh_id
            }
          })
        rowDiaChiKH.DIACHI_ID = diachikh_id
        if (this.diachiKH.TINH_ID && this.diachiKH.TINH_ID != 0) rowDiaChiKH.TINH_ID = this.diachiKH.TINH_ID
        if (this.diachiKH.QUAN_ID && this.diachiKH.QUAN_ID != 0) rowDiaChiKH.QUAN_ID = this.diachiKH.QUAN_ID
        if (this.diachiKH.PHUONG_ID && this.diachiKH.PHUONG_ID != 0) rowDiaChiKH.PHUONG_ID = this.diachiKH.PHUONG_ID
        if (this.diachiKH.PHO_ID && this.diachiKH.PHO_ID != 0) rowDiaChiKH.PHO_ID = this.diachiKH.PHO_ID
        if (this.diachiKH.AP_ID && this.diachiKH.AP_ID != 0) rowDiaChiKH.AP_ID = this.diachiKH.AP_ID
        if (this.diachiKH.KHU_ID && this.diachiKH.KHU_ID != 0) rowDiaChiKH.KHU_ID = this.diachiKH.KHU_ID
        if (this.diachiKH.DACDIEM_ID && this.diachiKH.DACDIEM_ID != 0) rowDiaChiKH.DACDIEM_ID = this.diachiKH.DACDIEM_ID
        rowDiaChiKH.SONHA = this.diachiKH.SONHA ? this.diachiKH.SONHA.trim() : ''

        if (this.diachiKH.BLOCK) rowDiaChiKH.BLOCK = this.diachiKH.BLOCK
        if (this.diachiKH.TANG) rowDiaChiKH.TANG = this.diachiKH.TANG
        if (this.diachiKH.PHONG) rowDiaChiKH.PHONG = this.diachiKH.PHONG
        if (this.diachiKH.MOTA) rowDiaChiKH.MOTA = this.diachiKH.MOTA

        rowDiaChiKH.DIACHI = this.diachiKH.DIACHI ? this.diachiKH.DIACHI.trim() : ''
        this.diachiKH = rowDiaChiKH
        this.dsDiaChi.push(rowDiaChiKH)

        var rowDiaChiHDKH = {}
        rowDiaChiHDKH.DIACHI_ID = diachikh_id
        rowDiaChiHDKH.HDKH_ID = this.khachhang.hdkh_id
        rowDiaChiHDKH.KINHDO = this.diachiKH.Lng
        rowDiaChiHDKH.VIDO = this.diachiKH.Lat
        this.dsDiaChiHDKH.push(rowDiaChiHDKH)
        //TODO xu ly update (chua lam)
        // if (themmoi == false)
        // {
        //     dsDiaChiHDKH.AcceptChanges();
        //     dsDiaChiHDKH.DIACHI_HDKH.Rows[0].SetModified();
        // }
      }

      if (kieu == 2 || kieu == 4) {
        var rowDiaChiTT = {}
        var rowDiaChiBC = {}
        var diachitt_id = this.diachiTT.DIACHI_ID
        var diachibc_id = this.diachiBC.DIACHI_ID

        if (themmoi)
          await API.post_fn_lay_tt_taodl_diachi(this.axios, { ds_para: JSON.stringify({ THEMMOI: themmoi, KIEU: kieu ? kieu : 2, DICHVUVT_ID: this.listbox.dichvu_vt.value }) }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //"data": "{\"ERROR_CODE\":1,\"MESSAGE\":\"Thành công\",\"RESULT\":{\"DIACHIKH_ID\":20025699}}"
              var dulieuapi = JSON.parse(response.data.data)
              diachitt_id = dulieuapi['RESULT']['DIACHITT_ID']
            }
          })
        //DiachiTT
        rowDiaChiTT.DIACHI_ID = diachitt_id
        rowDiaChiTT.TINH_ID = this.diachiTT.TINH_ID
        rowDiaChiTT.QUAN_ID = this.diachiTT.QUAN_ID
        rowDiaChiTT.PHUONG_ID = this.diachiTT.PHUONG_ID
        if (this.diachiTT.PHO_ID && this.diachiTT.PHO_ID != 0) rowDiaChiTT.PHO_ID = this.diachiTT.PHO_ID
        if (this.diachiTT.AP_ID && this.diachiTT.AP_ID != 0) rowDiaChiTT.AP_ID = this.diachiTT.AP_ID
        if (this.diachiTT.KHU_ID && this.diachiTT.KHU_ID != 0) rowDiaChiTT.KHU_ID = this.diachiTT.KHU_ID
        if (this.diachiTT.DACDIEM_ID && this.diachiTT.DACDIEM_ID != 0) rowDiaChiTT.DACDIEM_ID = this.diachiTT.DACDIEM_ID
        rowDiaChiTT.SONHA = this.diachiTT.SONHA ? this.diachiTT.SONHA.trim() : ''

        if (this.diachiTT.BLOCK) rowDiaChiTT.BLOCK = this.diachiTT.BLOCK
        if (this.diachiTT.TANG) rowDiaChiTT.TANG = this.diachiTT.TANG
        if (this.diachiTT.PHONG) rowDiaChiTT.PHONG = this.diachiTT.PHONG
        if (this.diachiTT.MOTA) rowDiaChiTT.MOTA = this.diachiTT.MOTA

        rowDiaChiTT.DIACHI = this.diachiTT.DIACHI ? this.diachiTT.DIACHI.trim() : ''

        this.diachiTT = rowDiaChiTT //tuanlv thêm
        this.dsDiaChi.push(rowDiaChiTT)
        //if (themmoi)
        //{
        var rowDiaChiHDTT = {}
        rowDiaChiHDTT.DIACHI_ID = diachitt_id
        rowDiaChiHDTT.DIACHIBC_ID = diachibc_id //TODO can xem lai cach load diachibc_id
        rowDiaChiHDTT.HDTT_ID = this.hdtt_id
        rowDiaChiHDTT.KINHDO = this.diachiTT.Lng
        rowDiaChiHDTT.VIDO = this.diachiTT.Lat
        rowDiaChiHDTT.KINHDO_BC = this.diachiBC.Lng
        rowDiaChiHDTT.VIDO_BC = this.diachiBC.Lat
        this.dsDiaChiHDTT.push(rowDiaChiHDTT)
        //TODO cap nhat du lieu (chua lam)
        // if (themmoi == false)
        // {
        //     dsDiaChiHDTT.AcceptChanges();
        //     dsDiaChiHDTT.DIACHI_HDTT.Rows[0].SetModified();
        // }
      }

      if (kieu == 3 || kieu == 4) {
        //Create by Hiếu  - 14/7/2010 - Địa chỉ lắp đặt & địa chỉ thuê bao
        var rowDiaChiTB = {}
        var rowDiachiLD = {}
        var diachitb_id = this.diachiTB.DIACHI_ID
        var diachild_id = this.diachiLD.DIACHI_ID
        if (themmoi) {
          // await API.post_fn_lay_tt_taodl_diachi(this.axios, {"ds_para":JSON.stringify({"THEMMOI":themmoi,"KIEU":kieu?kieu:2,"DICHVUVT_ID":this.listbox.dichvu_vt.value})}).then((response) => {
          //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          //     //"data": "{\"ERROR_CODE\":1,\"MESSAGE\":\"Thành công\",\"RESULT\":{\"DIACHIKH_ID\":20025699}}"
          //     var dulieuapi = JSON.parse(response.data.data);
          //     diachitb_id = dulieuapi['RESULT']['DIACHIKH_ID']
          //   }
          // });
          await API.post_fn_lay_tt_taodl_diachi(this.axios, { ds_para: JSON.stringify({ THEMMOI: themmoi, KIEU: kieu ? kieu : 2, DICHVUVT_ID: this.listbox.dichvu_vt.value }) }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //"data": "{\"ERROR_CODE\":1,\"MESSAGE\":\"Thành công\",\"RESULT\":{\"DIACHIKH_ID\":20025699}}"
              var dulieuapi = JSON.parse(response.data.data)
              diachild_id = dulieuapi['RESULT']['DIACHILD_ID']
              diachitb_id = dulieuapi['RESULT']['DIACHITB_ID']
              if (dulieuapi['RESULT']['DIACHIDAU_ID']) this.diachiDau.DIACHI_ID = dulieuapi['RESULT']['DIACHIDAU_ID']
              if (dulieuapi['RESULT']['DIACHICUOI_ID']) this.diachiCuoi.DIACHI_ID = dulieuapi['RESULT']['DIACHICUOI_ID']
            }
          })
        }
        //Địa chỉ lắp đặt --> dataset dsdiachi
        rowDiachiLD.DIACHI_ID = diachild_id
        rowDiachiLD.TINH_ID = this.diachiLD.TINH_ID
        rowDiachiLD.QUAN_ID = this.diachiLD.QUAN_ID
        rowDiachiLD.PHUONG_ID = this.diachiLD.PHUONG_ID
        if (this.diachiLD.PHO_ID && this.diachiLD.PHO_ID != 0) rowDiachiLD.PHO_ID = this.diachiLD.PHO_ID
        if (this.diachiLD.AP_ID && this.diachiLD.AP_ID != 0) rowDiachiLD.AP_ID = this.diachiLD.AP_ID
        if (this.diachiLD.KHU_ID && this.diachiLD.KHU_ID != 0) rowDiachiLD.KHU_ID = this.diachiLD.KHU_ID
        if (this.diachiLD.DACDIEM_ID && this.diachiLD.DACDIEM_ID != 0) rowDiachiLD.DACDIEM_ID = this.diachiLD.DACDIEM_ID
        rowDiachiLD.SONHA = this.diachiLD.SONHA ? this.diachiLD.SONHA.trim() : ''
        // Kieun v
        rowDiachiLD.BLOCK = this.diachiLD.BLOCK ? this.diachiLD.BLOCK.trim() : ''
        rowDiachiLD.TANG = this.diachiLD.TANG ? this.diachiLD.TANG.trim() : ''
        rowDiachiLD.PHONG = this.diachiLD.PHONG ? this.diachiLD.PHONG.trim() : ''
        rowDiachiLD.MOTA = this.diachiLD.MOTA ? this.diachiLD.MOTA.trim() : ''

        rowDiachiLD.DIACHI = this.diachiLD.DIACHI ? this.diachiLD.DIACHI.trim() : ''
        this.diachiLD = rowDiachiLD //tuanlv thêm
        this.dsDiaChi.push(rowDiachiLD)
        //Địa chỉ thuê bao --> dataset dsdiachi
        rowDiaChiTB.DIACHI_ID = diachitb_id
        rowDiaChiTB.TINH_ID = this.diachiTB.TINH_ID
        rowDiaChiTB.QUAN_ID = this.diachiTB.QUAN_ID
        rowDiaChiTB.PHUONG_ID = this.diachiTB.PHUONG_ID
        if (this.diachiTB.PHO_ID && this.diachiTB.PHO_ID != 0) rowDiaChiTB.PHO_ID = this.diachiTB.PHO_ID
        if (this.diachiTB.AP_ID && this.diachiTB.AP_ID != 0) rowDiaChiTB.AP_ID = this.diachiTB.AP_ID
        if (this.diachiTB.KHU_ID && this.diachiTB.KHU_ID != 0) rowDiaChiTB.KHU_ID = this.diachiTB.KHU_ID
        if (this.diachiTB.DACDIEM_ID && this.diachiTB.DACDIEM_ID != 0) rowDiaChiTB.DACDIEM_ID = this.diachiTB.DACDIEM_ID
        rowDiaChiTB.SONHA = this.diachiTB.SONHA ? this.diachiTB.SONHA.trim() : ''
        // Kieu nv
        rowDiaChiTB.BLOCK = this.diachiTB.BLOCK ? this.diachiTB.BLOCK.trim() : ''
        rowDiaChiTB.TANG = this.diachiTB.TANG ? this.diachiTB.TANG.trim() : ''
        rowDiaChiTB.PHONG = this.diachiTB.PHONG ? this.diachiTB.PHONG.trim() : ''
        rowDiaChiTB.MOTA = this.diachiTB.MOTA ? this.diachiTB.MOTA.trim() : ''

        rowDiaChiTB.DIACHI = this.diachiTB.DIACHI ? this.diachiTB.DIACHI.trim() : ''
        this.diachiTB = rowDiaChiTB //tuanlv thêm
        this.dsDiaChi.push(rowDiaChiTB)

        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          var rowDiaChiDau = {}
          // if (themmoi)
          //     diachidau_id = new GetKeyFacade().GetKey("DIACHI");
          rowDiaChiDau.DIACHI_ID = this.diachiDau.DIACHI_ID
          rowDiaChiDau.TINH_ID = this.diachiDau.TINH_ID
          rowDiaChiDau.QUAN_ID = this.diachiDau.QUAN_ID
          rowDiaChiDau.PHUONG_ID = this.diachiDau.PHUONG_ID
          if (this.diachiDau.PHO_ID && this.diachiDau.PHO_ID != 0) rowDiaChiDau.PHO_ID = this.diachiDau.PHO_ID
          if (this.diachiDau.AP_ID && this.diachiDau.AP_ID != 0) rowDiaChiDau.AP_ID = this.diachiDau.AP_ID
          if (this.diachiDau.KHU_ID && this.diachiDau.KHU_ID != 0) rowDiaChiDau.KHU_ID = this.diachiDau.KHU_ID
          rowDiaChiDau.SONHA = this.diachiDau.SONHA

          rowDiaChiDau.BLOCK = this.diachiDau.BLOCK ? this.diachiDau.BLOCK.trim() : ''
          rowDiaChiDau.TANG = this.diachiDau.TANG ? this.diachiDau.TANG.trim() : ''
          rowDiaChiDau.PHONG = this.diachiDau.PHONG ? this.diachiDau.PHONG.trim() : ''
          rowDiaChiDau.MOTA = this.diachiDau.MOTA ? this.diachiDau.MOTA.trim() : ''

          rowDiaChiDau.DIACHI = this.diachiDau.DIACHI
          this.dsDiaChi.push(rowDiaChiDau)

          var rowDiaChiCuoi = {}
          // if (themmoi)
          //     diachicuoi_id = new GetKeyFacade().GetKey("DIACHI");
          rowDiaChiCuoi.DIACHI_ID = this.diachiCuoi.DIACHI_ID
          rowDiaChiCuoi.TINH_ID = this.diachiCuoi.TINH_ID
          rowDiaChiCuoi.QUAN_ID = this.diachiCuoi.QUAN_ID
          rowDiaChiCuoi.PHUONG_ID = this.diachiCuoi.PHUONG_ID
          if (this.diachiCuoi.PHO_ID && this.diachiCuoi.PHO_ID != 0) rowDiaChiCuoi.PHO_ID = this.diachiCuoi.PHO_ID
          if (this.diachiCuoi.AP_ID && this.diachiCuoi.AP_ID != 0) rowDiaChiCuoi.AP_ID = this.diachiCuoi.AP_ID
          if (this.diachiCuoi.KHU_ID && this.diachiCuoi.KHU_ID != 0) rowDiaChiCuoi.KHU_ID = this.diachiCuoi.KHU_ID
          rowDiaChiCuoi.SONHA = this.diachiCuoi.SONHA

          rowDiaChiCuoi.BLOCK = this.diachiCuoi.BLOCK ? this.diachiCuoi.BLOCK.trim() : ''
          rowDiaChiCuoi.TANG = this.diachiCuoi.TANG ? this.diachiCuoi.TANG.trim() : ''
          rowDiaChiCuoi.PHONG = this.diachiCuoi.PHONG ? this.diachiCuoi.PHONG.trim() : ''
          rowDiaChiCuoi.MOTA = this.diachiCuoi.MOTA ? this.diachiCuoi.MOTA.trim() : ''

          rowDiaChiCuoi.DIACHI = this.diachiCuoi.DIACHI
          this.dsDiaChi.push(rowDiaChiCuoi)
        }

        //if (themmoi)
        //{
        var rowDiaChiHDTB = {}
        rowDiaChiHDTB.DIACHI_ID = diachitb_id
        rowDiaChiHDTB.HDTB_ID = this.hdtb_id
        rowDiaChiHDTB.DIACHILD_ID = diachild_id
        rowDiaChiHDTB.KINHDO = this.diachiTB.Lng
        rowDiaChiHDTB.VIDO = this.diachiTB.Lat
        rowDiaChiHDTB.KINHDO_LD = this.diachiLD.Lng
        rowDiaChiHDTB.VIDO_LD = this.diachiLD.Lat
        this.dsDiaChiHDTB.push(rowDiaChiHDTB)
        //}
        //TODO update du lieu (chua lam)
        // if (themmoi == false)
        // {
        //     dsDiaChiHDTB.AcceptChanges();
        //     dsDiaChiHDTB.DIACHI_HDTB.Rows[0].SetModified();
        // }
      }
      //TODO update du lieu (chua lam)
      // if (themmoi == false)
      // {
      //     dsDiaChi.AcceptChanges();
      //     if (kieu == 1 || kieu == 2 || kieu == 3)
      //     {
      //         dsDiaChi.DIACHI.Rows[0].SetModified();

      //         if (kieu == 3)
      //         {
      //             dsDiaChi.DIACHI.Rows[1].SetModified();
      //             if (dichvuvt_id == DichVuVienThong.TSL || dichvuvt_id == DichVuVienThong.TSL_DOITAC)
      //             {
      //                 dsDiaChi.DIACHI.Rows[2].SetModified();
      //             }
      //         }
      //     }
      //     else
      //     {
      //         dsDiaChi.DIACHI.Rows[0].SetModified();
      //         dsDiaChi.DIACHI.Rows[1].SetModified();
      //         dsDiaChi.DIACHI.Rows[2].SetModified();
      //         dsDiaChi.DIACHI.Rows[3].SetModified();
      //         if (dichvuvt_id == DichVuVienThong.TSL || dichvuvt_id == DichVuVienThong.TSL_DOITAC)
      //         {
      //             dsDiaChi.DIACHI.Rows[4].SetModified();
      //             dsDiaChi.DIACHI.Rows[5].SetModified();
      //         }
      //     }
      // }
      //end
    },
    TaoDuLieu_DKDV() {
      this.dsDK_DVGT = []
      var kieu_dk_dvgt = 0
      if(this.m_dsThueBao_DichVu && this.m_dsThueBao_DichVu.length>0)
      for (var dr of this.m_dsThueBao_DichVu.filter(x=>!x.bancheo || x.bancheo==0)) {
        if (dr['dangky'] == '1') kieu_dk_dvgt = KieuCaiDatDVGT.KIEU_CD_THEM_MOI_DVGT
        else if (dr['huy'] == '1') kieu_dk_dvgt = KieuCaiDatDVGT.KIEU_CD_HUY_DVGT
        else {
          continue
        }

        var rowHDTDDV = {}
        rowHDTDDV.HDTB_ID = this.hdtb_id
        rowHDTDDV.NGAY_YC = this.NgayYeuCau
        rowHDTDDV.DICHVUGT_ID = dr['dichvugt_id']
        rowHDTDDV.NOIDUNG = dr['noidung']
        rowHDTDDV.KIEU_YC = kieu_dk_dvgt
        if (dr['cuoc_sd']) rowHDTDDV.CUOC_SD = dr['cuoc_sd']
        else rowHDTDDV.CUOC_SD = 0
        if (dr['vat_sd']) rowHDTDDV.VAT_SD = dr['vat_sd']
        else rowHDTDDV.VAT_SD = 0

        //if (dr["sl_cha"].trim() != "")
        //    rowHDTDDV.SL_CHA = Convert.ToInt64(dr["sl_cha"]);
        //else
        rowHDTDDV.SL_CHA = 0

        var jsl_cha = 0
        //TODO chua lam vi khong phai phan codinh
        // if (this.loaihinh_tb.value == LoaiHinhTB.IOFFICE || this.loaihinh_tb.value == LoaiHinhTB.VNPT_HIS)
        // {
        //     if (this.loaihinh_tb.value == LoaiHinhTB.VNPT_HIS)
        //     {
        //         var phanloai_his = "";
        //         for (int index_ = 0; index_ < this.gridEditors.Count; ++index_)
        //         {
        //             if (this.gridEditors[index_].ID == "PHANLOAI_ID" && this.gridEditors[index_].Value != "")
        //             {
        //                 phanloai_his = this.gridEditors[index_].Value;
        //                 break;
        //             }
        //         }
        //         if (phanloai_his == "50")
        //         {
        //             for (int index_ = 0; index_ < this.gridEditors.Count; ++index_)
        //             {
        //                 if (this.gridEditors[index_].ID == "TONGSO_ND" && this.gridEditors[index_].Value != "")
        //                 {
        //                     jsl_cha = Convert.ToInt64(this.gridEditors[index_].Value);
        //                     break;
        //                 }
        //             }
        //         }
        //     }
        //     else
        //     {
        //         for (int index_ = 0; index_ < this.gridEditors.Count; ++index_)
        //         {
        //             if (this.gridEditors[index_].ID == "TONGSO_ND" && this.gridEditors[index_].Value != "")
        //             {
        //                 jsl_cha = Convert.ToInt64(this.gridEditors[index_].Value);
        //                 break;
        //             }
        //         }
        //     }

        // }
        // if (this.loaihinh_tb.value == LoaiHinhTB.HNTH_NGN || this.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING)
        // {
        //     for (int index_ = 0; index_ < this.gridEditors.Count; ++index_)
        //     {
        //         if (this.gridEditors[index_].ID == "SL_MAILING" && this.gridEditors[index_].Value != "")
        //         {
        //             jsl_cha = Convert.ToInt64(this.gridEditors[index_].Value);
        //             break;
        //         }
        //     }
        // }
        if (jsl_cha != 0 && dr['block_tiep'] && dr['block_tiep'] && dr['block_tiep'] != 0) rowHDTDDV.SL_CHA = jsl_cha
        else rowHDTDDV.SL_CHA = 0

        if (dr['block_dau']) rowHDTDDV.BLOCK_DAU = dr['block_dau']
        else rowHDTDDV.BLOCK_DAU = 0

        if (dr['block_tiep']) rowHDTDDV.BLOCK_TIEP = dr['block_tiep']
        else rowHDTDDV.BLOCK_TIEP = 0

        if (dr['gia_block_tiep']) rowHDTDDV.GIA_BLOCK_TIEP = dr['gia_block_tiep']
        else rowHDTDDV.GIA_BLOCK_TIEP = 0

        if (dr['vat_block_tiep']) rowHDTDDV.VAT_BLOCK_TIEP = dr['vat_block_tiep']
        else rowHDTDDV.VAT_BLOCK_TIEP = 0

        if (dr['he_so']) rowHDTDDV.HE_SO = dr['he_so']
        else rowHDTDDV.HE_SO = 0

        rowHDTDDV.TTTH = 1
        this.dsDK_DVGT.push(rowHDTDDV)
      }
    },
    TaoDuLieu_TIEN_DATCOC(themmoi) {
      this.dsTien_DatCoc = []
      var row = {}
      row.HDTB_ID = this.hdtb_id
      row.THUEBAO_ID = 0
      row.LOAITIEN_ID = 1
      //TODO load tien dat coc tu phan khuyen mai
      row.GIATRI = this.kmld.dtiendatcoc_tt + this.kmld.dvatdatcoc_tt + this.kmld.dtiendatcoc_km + this.kmld.dvatdatcoc_km

      this.dsTien_DatCoc.push(row)
      //TODO phan update chua lam
      // if (themmoi == false)
      // {
      //     dsTien_DatCoc.AcceptChanges();
      //     dsTien_DatCoc.TIEN_HDTB_TC.Rows[0].SetModified();
      // }
    },
    CapNhat_HDTB_ID_DangKyDV() {
      this.dsDK_DVKHAC = [] //Object.assign({}, this.dsDK_DVK_TB); // Add du lieu o duoi nen khong copy object
      for (var dv of this.dsDK_DVK_TB) {
        var rowDK_DVK = {}
        rowDK_DVK.DVKHAC_ID = dv['dvkhac_id']
        rowDK_DVK.HD_ID = this.hdtb_id
        rowDK_DVK.LOAIID = dv['loaiid']
        rowDK_DVK.NGAY_YC = dv['ngay_yc'] ? moment(dv['ngay_yc']).format('DD/MM/YYYY') : moment(new Date()).format('DD/MM/YYYY')
        rowDK_DVK.NOIDUNG = dv['noidung'] ? dv['noidung'] : ''
        rowDK_DVK.KIEU_YC = dv['kieu_yc'] ? dv['kieu_yc'] : 0
        rowDK_DVK.TTTH = dv['ttth'] ? dv['ttth'] : 0
        this.dsDK_DVKHAC.push(rowDK_DVK)
      }
      for (var dv of this.dsDK_DVK_TT) {
        var rowDK_DVK = {}
        rowDK_DVK.DVKHAC_ID = dv['dvkhac_id']
        rowDK_DVK.HD_ID = this.hdtt_id
        rowDK_DVK.LOAIID = dv['loaiid']
        rowDK_DVK.NGAY_YC = moment(dv['ngay_yc']).isValid() ? moment(dv['ngay_yc']).format('DD/MM/YYYY') : moment(dv['ngay_yc'], 'DD/MM/YYYY').isValid() ? dv['ngay_yc'] : moment(new Date()).format('DD/MM/YYYY')
        rowDK_DVK.NOIDUNG = dv['noidung'] ? dv['noidung'] : ''
        rowDK_DVK.KIEU_YC = dv['kieu_yc']
        rowDK_DVK.TTTH = dv['ttth']
        rowDK_DVK.USER_TC = dv['user_tc']
        rowDK_DVK.PASS_TC = dv['pass_tc']
        rowDK_DVK.STATUS = 0
        this.dsDK_DVKHAC.push(rowDK_DVK)
      }
      for (var i = 0; i < this.dsCTM_TBI.length; i++) this.dsCTM_TBI[i]['hdtb_id'] = this.hdtb_id
      var khuyenmai_id_neo = ''
      for (var km of this.dgrKhuyenMai) {
        //this.dgrKhuyenMai la grid ben di dong
        if (km['dangky'] == 1) {
          khuyenmai_id_neo = km['khuyenmai_id']
          break
        }
      }
      for (var i = 0; i < this.dsKM_HDTB.length; i++) {
        this.dsKM_HDTB[i]['HDTB_ID'] = this.hdtb_id
        if (khuyenmai_id_neo != '') this.dsKM_HDTB[i]['KHUYENMAI_ID_NEO'] = khuyenmai_id_neo
        this.dsKM_HDTB[i]['TIEN_TG'] = this.TongTien_TG(this.dsKM_HDTB[i]['CHITIETKM_ID'])
      }
    },
    TongTien_TG(chitietkm_id) {
      var dTien_TG = 0
      var dTien = 0
      var dVat = 0
      var dTien_tt = 0
      var dVat_tt = 0
      var dTien_km = 0
      var dVat_km = 0
      var dSoLuong = 0

      var dt = this.DS_CTKM_LTBI
      for (var i = 0; i < dt.length; i++) {
        var ltb = dt[i]['loaitbi_id']
        var drs = this.dsCTM_TBI.filter((x) => x.loaitbi_id == ltb)
        for (var dr of drs) {
          dTien = dr['tien']
          dVat = dr['tien']
          dTien_tt = dr['tien_tratruoc']
          dVat_tt = dr['vat_tratruoc']
          dTien_km = dr['tien_km']
          dVat_km = dr['vat_km']
          dSoLuong = dr['soluong']
          dTien_TG = dTien_TG + (dTien - dTien_tt - dTien_km) * dSoLuong
        }
      }
      return dTien_TG
    },
    CapNhat_HDTB_ID_HDTB_KV() {
      // this.dsHDTB_KV_tmp = [];
      // this.dsHDTB_KV_tmp = [...this.dsHDTB_KV];
      // if(!this.dsHDTB_KV_tmp) this.dsHDTB_KV_tmp = [];
      for (var i = 0; i < this.dsHDTB_KV.length; i++) {
        this.dsHDTB_KV[i]['HDTB_ID'] = this.hdtb_id
      }
    },
    async TaoDuLieu_HDTB_MGWAN(themmoi) {
      this.dsHDTB_MEWAN = []
      var rowHDTB_MGWAN = {}
      var dulieuapi = {}
      var pdata = {
        LOAISOWAN: this.loaisowan,
        SD_FRMSHUONGKN_V2: this.thamsomacdinh['SD_FRMDSHUONGKN_V2'] == 1 ? 1 : 0,
        VRF_MGWAN: this.thuebao.mgwan.vrfvfi,
        DICHVUVT_ID: this.listbox.dichvu_vt.value,
        LOAITB_ID: this.listbox.loaihinh_tb.value,
        KIEULD_ID: this.listbox.kieu_ld.value,
        THEMMOI: themmoi ? 1 : 0,
        MADOICAP_WAN: this.thuebao.mgwan.madoicap ? this.thuebao.mgwan.madoicap : 0,
        MATN_WAN: this.thuebao.mgwan.matn
      }
      await API.post_fn_lay_tt_taodl_hdtb_mgwan(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          //"data": "{\"ERROR_CODE\":1,\"MESSAGE\":\"Thành công\",\"RESULT\":{\"DIACHIKH_ID\":20025699}}"
          dulieuapi = JSON.parse(response.data.data)
          if (dulieuapi['ERROR_CODE'] != 1) {
            this.$toast.error(dulieuapi['MESSAGE'])
            return
          }
          dulieuapi = dulieuapi['RESULT']
        }
      })
      rowHDTB_MGWAN.HDTB_ID = this.hdtb_id
      rowHDTB_MGWAN.TOCDO_ID = this.listbox.tocdokenh.valuecir

      if (this.listbox.tocdokenh.ischeckedpir) rowHDTB_MGWAN.TOCDO_PIR_ID = this.listbox.tocdokenh.valuepir
      else rowHDTB_MGWAN.TOCDO_PIR_ID = null

      if (this.listbox.congnghe.value > 0) rowHDTB_MGWAN.CONGNGHE_ID = this.listbox.congnghe.value
      else rowHDTB_MGWAN.CONGNGHE_ID = null
      rowHDTB_MGWAN.LOAIMD_ID = this.listbox.loaimodem.value
      rowHDTB_MGWAN.LOAIKENH_ID = this.listbox.loaikenh.value
      rowHDTB_MGWAN.THIETBIDC_ID = this.listbox.loai_tb.valuemgwan
      await this.LayMaTB(themmoi)
      await this.LayMaTBBC(themmoi)
      rowHDTB_MGWAN.MA_LT = this.ma_tb_ao_ht
      rowHDTB_MGWAN.LAN_IP = this.thuebao.mgwan.lanip ? this.thuebao.mgwan.lanip.trim() : ''
      rowHDTB_MGWAN.WAN_IP = this.thuebao.mgwan.wanip ? this.thuebao.mgwan.wanip.trim() : ''
      if (themmoi && dulieuapi['VRF']) this.thuebao.mgwan.vrfvfi = dulieuapi['VRF']
      if ((this.loaisowan != 1 || this.thamsomacdinh['SD_FRMDSHUONGKN_V2'] != 1) && this.thuebao.mgwan.vrfvfi) rowHDTB_MGWAN.VRF = this.thuebao.mgwan.vrfvfi ? this.thuebao.mgwan.vrfvfi.trim() : ''
      else {
        var str = await bancheo.sinh_vfi_vrf_v2(100, this.listbox.dichvu_vt.value, this.listbox.loaihinh_tb.value)
        //  new BanCheoBase().GET_STRING_FUNCTION(new BanCheoBase().tinh_thicong(100), "{?DB2}.sinh_vfi_vrf_v2",
        //                                                                                                 "vdichvuvt_id", dichvuvt_id,
        //                                                                                                 "vloaihinh_tb", cboLoaihinhTB.SelectedValue);
        this.thuebao.mgwan.vrfvfi = str
        rowHDTB_MGWAN.VRF = str
      }
      //HungHM - 07/09/2010 bổ xung thêm tham số cho wan
      rowHDTB_MGWAN.HUONG_KN = this.thuebao.mgwan.vhuongkn
      if (this.listbox.tinh_kn.value > 0) rowHDTB_MGWAN.TINH_KN_ID = this.listbox.tinh_kn.value

      if (this.KetCuoi_ID > 0) rowHDTB_MGWAN.KETCUOI_ID = this.KetCuoi_ID

      rowHDTB_MGWAN.THOIHAN_ID = this.listbox.thoihan.valuewan
      rowHDTB_MGWAN.TRANGBI_ID = this.listbox.trangbi.valuewan
      rowHDTB_MGWAN.CHUQUAN_ID = this.listbox.chu_quan.valuewan
      rowHDTB_MGWAN.CHUQUANLD_ID = this.listbox.chu_quan.valueldmgwan
      rowHDTB_MGWAN.MA_PL = this.thuebao.mgwan.txtMaHD_TTKD_MGWAN ? this.thuebao.mgwan.txtMaHD_TTKD_MGWAN.trim() : ''
      rowHDTB_MGWAN.SITE_ID = this.thuebao.mgwan.siteid
      rowHDTB_MGWAN.LOAINODE_ID = this.loaisowan
      rowHDTB_MGWAN.LOAICAP_ID = this.listbox.loaicap.value

      rowHDTB_MGWAN.TINHKHAC = this.TinhKhacLD;//Convert.ToInt16(dsDanhMuc.Tables["KIEU_LD"].Select("kieuld_id = " + Convert.ToInt32(cboKieuLD.SelectedValue)).CopyToDataTable().Rows[0]["tinhkhac"].ToString());

      //if (txtDiaChi_KN.Text.trim() != "")
      rowHDTB_MGWAN.DIACHI_KN = this.diachiKN.DIACHI

      if (this.chkLuongGiuKenh) rowHDTB_MGWAN.GIUKENH = this.thuebao.mgwan.luonggiukenh ? 1 : 0


      if (this.thongso_ban.mhkn_id) rowHDTB_MGWAN.MHKN_ID = this.thongso_ban.mhkn_id;
      if (this.thongso_ban.tocdo_pop) rowHDTB_MGWAN.TOCDO_POP = this.thongso_ban.tocdo_pop;
      if (this.thongso_ban.gdkn_pop_id) rowHDTB_MGWAN.GDKN_POP_ID = this.thongso_ban.gdkn_pop_id;
      if (this.thongso_ban.gdkn_kh_id) rowHDTB_MGWAN.GDKN_KH_ID = this.thongso_ban.gdkn_kh_id;
      if (this.thongso_ban.cauhinh_dt_id) rowHDTB_MGWAN.CAUHINH_DT_ID = this.thongso_ban.cauhinh_dt_id;
      if (this.thongso_ban.kieu_duplex_id) rowHDTB_MGWAN.KIEU_DUPLEX_ID = this.thongso_ban.kieu_duplex_id;
      if (this.thongso_ban.kieukn_id) rowHDTB_MGWAN.KIEUKN_ID = this.thongso_ban.kieukn_id;

      rowHDTB_MGWAN.WAN_IP = this.thongso_ban.wan_ip;
      rowHDTB_MGWAN.MTU_SIZE = this.thongso_ban.mtu_size;
      rowHDTB_MGWAN.DIEM_POP = this.thongso_ban.diem_pop;
      rowHDTB_MGWAN.LAN_IP = this.thongso_ban.lan_ip;
      rowHDTB_MGWAN.CE_IP = this.thongso_ban.ce_ip;
      rowHDTB_MGWAN.IP_POP = this.thongso_ban.tt_ip;
      rowHDTB_MGWAN.SL_IP = this.thongso_ban.sl_ip;
      rowHDTB_MGWAN.TEN_TRUNK_NNI = this.thongso_ban.ten_trunk_nni;
      rowHDTB_MGWAN.SO_AS = this.thongso_ban.so_as;
      rowHDTB_MGWAN.HQOS = this.thongso_ban.hqos;
      rowHDTB_MGWAN.COS = this.thongso_ban.cos;
      rowHDTB_MGWAN.VLAN_TRANSPARENT = this.thongso_ban.vlan_transparent;

      if (this.listbox.doitacwan.isenabled) {
        rowHDTB_MGWAN.DOITAC_ID = this.listbox.doitacwan.value
        if (this.thuebao.mgwan.cuoctk_dt) rowHDTB_MGWAN.CUOC_TKDT = this.thuebao.mgwan.cuoctk_dt
        else rowHDTB_MGWAN.CUOC_TKDT = 0
        if (this.thuebao.mgwan.cuoctc_dt) rowHDTB_MGWAN.CUOC_TCDT = this.thuebao.mgwan.cuoctc_dt
        else rowHDTB_MGWAN.CUOC_TCDT = 0

        rowHDTB_MGWAN.MAHD_DT = this.thuebao.mgwan.hopdong_dt ? this.thuebao.mgwan.hopdong_dt.trim() : ''
      } else {
        rowHDTB_MGWAN.DOITAC_ID = null
        rowHDTB_MGWAN.CUOC_TKDT = null
        rowHDTB_MGWAN.CUOC_TCDT = null
        rowHDTB_MGWAN.MAHD_DT = null
      }

      ///TuanNA: Bổ sung tham số cước thuê kênh, thuê cổng cho wan
      ///Ngày 08.05.2012
      ///
      if (this.thuebao.mgwan.cuocht) rowHDTB_MGWAN.CUOC_HT = this.thuebao.mgwan.cuocht
      else rowHDTB_MGWAN.CUOC_HT = 0
      if (this.thuebao.mgwan.cuoctbi) rowHDTB_MGWAN.CUOC_TBI = this.thuebao.mgwan.cuoctbi
      else rowHDTB_MGWAN.CUOC_TBI = 0
      if (this.thuebao.mgwan.cuoctc) rowHDTB_MGWAN.CUOC_TC = this.thuebao.mgwan.cuoctc
      else rowHDTB_MGWAN.CUOC_TC = 0
      if (this.thuebao.mgwan.cuoctk) rowHDTB_MGWAN.CUOC_TK = this.thuebao.mgwan.cuoctk
      else rowHDTB_MGWAN.CUOC_TK = 0
      //HungHM - Bổ xung thêm mã truy nhập + mã đôi cáp
      rowHDTB_MGWAN.MATB_TN = this.thuebao.mgwan.matn //txtMaTN_Wan.Text;
      var kieu = 0
      if (dulieuapi['KIEU']) kieu = dulieuapi['KIEU']
      //Nếu lắp trên đường có sẵn hoặc lắp kèm thì lấy mã đôi cáp từ form chọn xuống
      if (kieu == KIEULAP.LAP_KEM || kieu == KIEULAP.LAP_LINE_SAN) {
        if (!this.thuebao.mgwan.madoicap || this.thuebao.mgwan.madoicap.trim().length == 0) {
          throw 'Đối với kiểu lắp đặt là lắp kèm hoặc trên đường có sẵn thì mã đôi cáp không được trống.'
          // this.$toast.error("Đối kiểu lắp đặt là lắp kèm hoặc trên đường có sẵn thì mã đôi cáp không được trống.");
          // return;
        }
        rowHDTB_MGWAN.MADOICAP = this.thuebao.mgwan.madoicap.trim()
      } //TH còn lại sinh mã đôi cáp
      else {
        if (dulieuapi['MADOICAP']) {
          rowHDTB_MGWAN.MADOICAP = dulieuapi['MADOICAP']
          this.thuebao.mgwan.madoicap = dulieuapi['MADOICAP']
        }
      }

      if (this.listbox.kieu_ld.value == KieuLapDat.TACH_VLAN) {
        if (dulieuapi['DS_MG'] && dulieuapi['DS_MG'].length > 0 && dulieuapi['DS_MG'][0].length > 0) {
          var ds_mg = dulieuapi['DS_MG'][0][0]
          ds_mg = this.LowerCasePropertyList(ds_mg)
          if (ds_mg['port_id']) rowHDTB_MGWAN.PORT_ID = ds_mg['port_id']
          if (ds_mg['vci_vpi_id']) rowHDTB_MGWAN.VCI_VPI_ID = ds_mg['vci_vpi_id']

          rowHDTB_MGWAN.SLOT_PE = ds_mg[0]['slot_pe']
          rowHDTB_MGWAN.PORT_PE = ds_mg[0]['port_pe']
          rowHDTB_MGWAN.LAN_IP = ds_mg[0]['lan_ip']
          rowHDTB_MGWAN.WAN_IP = ds_mg[0]['wan_ip']
          rowHDTB_MGWAN.ROUTE = ds_mg[0]['route']
          rowHDTB_MGWAN.LINK = ds_mg[0]['link']
          rowHDTB_MGWAN.VRF = ds_mg[0]['vrf']
          rowHDTB_MGWAN.SVLAN = ds_mg[0]['svlan']
          rowHDTB_MGWAN.CVLAN = ds_mg[0]['cvlan']
        }
      }
      if (this.listbox.kieu_ld.value == KieuLapDat.DATMOI_KENHPHU_AO) rowHDTB_MGWAN.KP_AO = 1
      else rowHDTB_MGWAN.KP_AO = 0

      if (this.thuebao.cvlct) {
        rowHDTB_MGWAN.MA_CV = this.thuebao.congvan ? this.thuebao.congvan.trim() : ''
        rowHDTB_MGWAN.NGAY_CV = this.thuebao.NgayCV
      }
      if (this.thuebao.mgwan.chkNgayHT_MGWAN) rowHDTB_MGWAN.NGAY_YCHT = this.thuebao.mgwan.dtpNgayHT_MGWAN;//dtpNgayHT_MGWAN.Value;
      rowHDTB_MGWAN.MA_CRM = this.thuebao.crm ? this.thuebao.crm.trim() : ''
      rowHDTB_MGWAN.ID_ERP = this.thuebao.erp ? this.thuebao.erp.trim() : ''
      rowHDTB_MGWAN.MAKENH_VTN = this.thuebao.vtn ? this.thuebao.vtn.trim() : ''

      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MGW_INTERNET_TRUCTIEP || this.listbox.loaihinh_tb.value == LoaiHinhTB.NB_INTERNETTT) {
        rowHDTB_MGWAN.PHANLOAI_ID = this.listbox.phanloai_dv.value
        rowHDTB_MGWAN.PHANTACH_TD = this.listbox.ht_phantach_tocdo.value
        if (this.thuebao.mgwan.soluongip) rowHDTB_MGWAN.SL_IP = this.thuebao.mgwan.soluongip
        else rowHDTB_MGWAN.SL_IP = 0

        if (this.thuebao.mgwan.cuocip) rowHDTB_MGWAN.CUOC_IP = this.thuebao.mgwan.cuocip
        else rowHDTB_MGWAN.CUOC_IP = 0

        if (this.listbox.tocdokenh.ischeckednix) {
          rowHDTB_MGWAN.TOCDO_NIX = this.listbox.tocdokenh.valuenix
          if (this.thuebao.mgwan.cuocnix) rowHDTB_MGWAN.CUOC_NIX = this.thuebao.mgwan.cuocnix
          else rowHDTB_MGWAN.CUOC_NIX = 0
        } else {
          rowHDTB_MGWAN.TOCDO_NIX = null
          rowHDTB_MGWAN.CUOC_NIX = null
        }

        if (this.listbox.tocdokenh.ischeckedisp) {
          rowHDTB_MGWAN.TOCDO_ISP = this.listbox.tocdokenh.valueisp
          if (this.thuebao.mgwan.cuocisp) rowHDTB_MGWAN.CUOC_ISP = this.thuebao.mgwan.cuocisp
          else rowHDTB_MGWAN.CUOC_ISP = 0
        } else {
          rowHDTB_MGWAN.TOCDO_ISP = null
          rowHDTB_MGWAN.CUOC_ISP = null
        }
      } else {
        rowHDTB_MGWAN.PHANLOAI_ID = null
        rowHDTB_MGWAN.PHANTACH_TD = null
        rowHDTB_MGWAN.SL_IP = null
        rowHDTB_MGWAN.CUOC_IP = null
        rowHDTB_MGWAN.TOCDO_NIX = null
        rowHDTB_MGWAN.TOCDO_ISP = null
        rowHDTB_MGWAN.CUOC_NIX = null
        rowHDTB_MGWAN.CUOC_ISP = null
      }
      if (!themmoi) rowHDTB_MGWAN.MA_VNPT = this.ma_vnpt
      rowHDTB_MGWAN.KENH_TONG = this.thuebao.mgwan.chkKenhTong?1:0;

      this.dsHDTB_MEWAN.push(rowHDTB_MGWAN)
      //if (themmoi == false)
      // {
      //     dsHDTB_MEWAN.AcceptChanges();
      //     dsHDTB_MEWAN.HDTB_MGWAN.Rows[0].SetModified();
      // }

      //Tạo cho bảng hdtb_dv
      for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

        if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
          throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
          return;
        }
        var row = {}
        row.HDTB_ID = this.hdtb_id
        row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
        row.DONVI_ID = this.DT_CONTROLS.value[i]
        row.KIEUDV_ID = 2
        this.dsHDTBDV.push(row)
      }
      //End
    },
    async TaoDuLieu_HDTB_CD(themmoi) {
      this.dsHDTB_CD = []
      var rowHDTB_CD = {}
      rowHDTB_CD.HDTB_ID = this.hdtb_id
      if (this.chkVSVX) rowHDTB_CD.MC_TBCD_ID = 1
      else rowHDTB_CD.MC_TBCD_ID = 0

      if (this.chkMienCuocTB) rowHDTB_CD.MIENCUOC_TB = 1
      else rowHDTB_CD.MIENCUOC_TB = 0

      if (this.KetCuoi_ID > 0) rowHDTB_CD.KETCUOI_ID = this.KetCuoi_ID // TODO xem khi nao thi load duoc cai nay KetCuoi_ID khi them moi

      if (this.listbox.congnghe.value > 0) rowHDTB_CD.CONGNGHE_ID = this.listbox.congnghe.value
      else rowHDTB_CD.CONGNGHE_ID = null

      //HungHM - Bổ xung thêm mã truy nhập + mã đôi cáp
      rowHDTB_CD.MATB_TN = this.thuebaocd.matn ? this.thuebaocd.matn.trim() : null
      rowHDTB_CD.THOIHAN_ID = this.listbox.thoihan.valuecd

      if (this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_DC || this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_TL || this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_MOI) {
        rowHDTB_CD.TG_THUESO = this.thuebaocd.sothang_thueso
        if (this.thuebaocd.kieu_thueso == THUESO.TRUOTSO) {
          rowHDTB_CD.SOTRUOT = this.thuebaocd.noidung_thueso
          rowHDTB_CD.NOIDUNG_TB = ''
        }
        if (this.thuebaocd.kieu_thueso == THUESO.THONGBAO) {
          rowHDTB_CD.SOTRUOT = ''
          rowHDTB_CD.NOIDUNG_TB = this.thuebaocd.noidung_thueso
        }
      }
      var kieu = this.listbox.kieu_ld.value
      //Nếu lắp trên đường có sẵn hoặc lắp kèm thì lấy mã đôi cáp từ form chọn xuống
      await API.post_fn_lay_tt_taodl_hdtb_cd(this.axios, { ds_para: JSON.stringify({ THEMMOI: themmoi, KIEULD_ID: kieu ? kieu : 2, MADOICAP_CD: this.thuebaocd.madoicap ? this.thuebaocd.madoicap : null }) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          var dulieuapi = JSON.parse(response.data.data)

          if (dulieuapi['ERROR_CODE'] == 1) {
            if (dulieuapi['RESULT']['MADOICAP']) {
              this.thuebaocd.madoicap = dulieuapi['RESULT']['MADOICAP']
              rowHDTB_CD.MADOICAP = this.thuebaocd.madoicap
            }
          } else {
            this.$toast.error(dulieuapi['RESULT']['MESSAGE'])
          }
        }
      })
      rowHDTB_CD.TRANGBI_ID = this.listbox.trangbi.valuecd
      rowHDTB_CD.CHUQUAN_ID = this.listbox.chu_quan.valuecd
      rowHDTB_CD.CHUQUANLD_ID = this.listbox.chu_quan.valueldcd
      if (this.listbox.doitac.ischeckedcd) {
        rowHDTB_CD.DOITAC_ID = this.listbox.doitac.valuecd
        if (this.thuebaocd.cuocdoitac && this.thuebaocd.cuocdoitac > 0) rowHDTB_CD.CUOC_DOITAC = this.thuebaocd.cuocdoitac
        else rowHDTB_CD.CUOC_DOITAC = 0
      } else {
        rowHDTB_CD.DOITAC_ID = null
        rowHDTB_CD.CUOC_DOITAC = null
      }
      if (!themmoi) rowHDTB_CD.MA_VNPT = this.ma_vnpt

      this.dsHDTB_CD.push(rowHDTB_CD)
      //TODO xu ly update???
      // if (themmoi == false)
      // {
      //     dsHDTB_CD.AcceptChanges();
      //     dsHDTB_CD.HDTB_CD.Rows[0].SetModified();
      // }

      //Tạo cho bảng hdtb_dv
      for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

        if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
          throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
          return;
        }
        var row = {}
        row.HDTB_ID = this.hdtb_id
        row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
        row.DONVI_ID = this.DT_CONTROLS.value[i]
        row.KIEUDV_ID = 2
        this.dsHDTBDV.push(row)
      }
      //End
    },
    TaoDuLieu_CAMKET_HDTB(themmoi) {
      this.dsCAMKET_HDTB = []
      if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) {
        //TODO can co load dgvTienCK tu dt = bangts.Lay_danhsach_tiencamket_hdtb(hdtb_id).Tables[0]; o method HienThiTTMoRong(long hdtb_id, int dichvuvt_id)
        for (var ck of this.thuebao.codinh.dgvTienCK.list) {
          if (!ck['tuthang'] || !ck['denthang'] || !ck['tien_ck']) continue
          if (ck['tuthang'] == '' || ck['denthang'] == '' || ck['tien_ck'] == '') continue
          var row = {}
          row.HDTB_ID = this.hdtb_id
          row.TUTHANG = ck['tuthang']
          row.DENTHANG = ck['denthang']
          row.TIEN_CK = ck['tien_ck']
          row.NGUOI_CN = this.$root.token.getUserName()
          row.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
          row.MAY_CN = this.tt_nd.may_cn
          this.dsCAMKET_HDTB.push(row)
        }
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.GPHONE) {
        for (var ds of this.thuebao.gphone.dgvTienCKGP.list) {
          if (!ds['tuthanggp'] || !ds['denthanggp'] || !ds['tien_ckgp']) continue

          var row = {}
          row.HDTB_ID = this.hdtb_id
          row.TUTHANG = ds['tuthanggp']
          row.DENTHANG = ds['denthanggp']
          row.TIEN_CK = ds['tien_ckgp']
          row.NGUOI_CN = this.$root.token.getUserName()
          row.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
          row.MAY_CN = this.tt_nd.may_cn
          this.dsCAMKET_HDTB.push(row)
        }
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.IMS) {
        for (var ds of this.thuebao.ims.dgvTienCKIMS.list) {
          if (!ds['tuthangims'] || !ds['denthangims'] || !ds['tien_ckims']) continue

          var row = {}
          row.HDTB_ID = this.hdtb_id
          row.TUTHANG = ds['tuthangims']
          row.DENTHANG = ds['denthangims']
          row.TIEN_CK = ds['tien_ckims']
          row.NGUOI_CN = this.$root.token.getUserName()
          row.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
          row.MAY_CN = this.tt_nd.may_cn
          this.dsCAMKET_HDTB.push(row)
        }
      }
    },
    TAO_DULIEU_HDKH_SUB(ds_hdkh_sub_p, v_hdkh_id) {
      this.dsHDKH_Sub = []
      let row = {}
      var ds_hdkh_sub = JSON.parse(JSON.stringify(ds_hdkh_sub_p))
      ds_hdkh_sub = this.LowerCasePropertyList(ds_hdkh_sub)
      row.CHUCVU_GT = ds_hdkh_sub[0]['chucvu_gt']
      row.HDKH_ID = v_hdkh_id && v_hdkh_id > 0 ? v_hdkh_id : this.khachhang.hdkh_id
      if (ds_hdkh_sub[0]['ngaycap_gt'])
        // ThangDM1 bo sung trong hop du lieu tra ve tu API xu ly luon ham nay -> format ve cho dung dinh dang!
        row.NGAYCAP_GT = (ds_hdkh_sub[0]['ngaycap_gt'] + '').indexOf('T') >= 0 ? moment(ds_hdkh_sub[0]['ngaycap_gt']).format('DD/MM/YYYY') : ds_hdkh_sub[0]['ngaycap_gt'] // moment(ds_hdkh_sub[0]["ngaycap_gt"]).format("DD/MM/YYYY");
      row.NGUOI_GT = ds_hdkh_sub[0]['nguoi_gt']
      if (ds_hdkh_sub[0]['so_phong']) row.SO_PHONG = ds_hdkh_sub[0]['so_phong']

      row.SOGIAY_GT = ds_hdkh_sub[0]['sogiay_gt']
      row.MA_NS = ds_hdkh_sub[0]['ma_ns']
      if (ds_hdkh_sub[0]['khoi_id']) row.KHOI_ID = ds_hdkh_sub[0]['khoi_id']
      //if (vkieukh_id_ == 1)
      if (this.vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) {
        row.SO_HD_KHDN = ds_hdkh_sub[0]['so_hd_khdn']
        row.SO_PL_KHDN = ds_hdkh_sub[0]['so_pl_khdn']
        if (ds_hdkh_sub[0]['kenh_pt'] == '1') {
          row.KENH_PT = 1
          row.LOAIKENH = null
          if (ds_hdkh_sub[0]['kenh_id']) row.KENH_ID = ds_hdkh_sub[0]['kenh_id']
        } else {
          row.KENH_PT = 2
          if (ds_hdkh_sub[0]['loaikenh']) row.LOAIKENH = ds_hdkh_sub[0]['loaikenh']
          if (ds_hdkh_sub[0]['kenh_id']) row.KENH_ID = ds_hdkh_sub[0]['kenh_id']
        }
      }
      if (this.ts_kt_tthdkhdn == 1) {
        row.SO_HD_KHDN = ds_hdkh_sub[0]['so_hd_khdn']
        row.MA_KHDN = ds_hdkh_sub[0]['ma_khdn']
        if (ds_hdkh_sub[0]['giatri_hd']) {
          row.GIATRI_HD = ds_hdkh_sub[0]['giatri_hd']
        }
        if (ds_hdkh_sub[0]['ngay_ky_hd']) {
          if(moment(ds_hdkh_sub[0]['ngay_ky_hd']).isValid())
            row.NGAY_KY_HD = moment(ds_hdkh_sub[0]['ngay_ky_hd']).format('DD/MM/YYYY')
          else
            row.NGAY_KY_HD = ds_hdkh_sub[0]['ngay_ky_hd'];

          if(row.NGAY_KY_HD && row.NGAY_KY_HD.indexOf(' ')>0) row.NGAY_KY_HD = row.NGAY_KY_HD.substring(0,row.NGAY_KY_HD.indexOf(' ')).trim();
        }
        row.GIAY_UQ = ds_hdkh_sub[0]['giay_uq']
        if (ds_hdkh_sub[0]['loaihdkh_id'] && ds_hdkh_sub[0]['loaihdkh_id'] != '-1') {
          row.LOAIHDKH_ID = ds_hdkh_sub[0]['loaihdkh_id']
        }
        if (ds_hdkh_sub[0]['tinhtranghd_id'] && ds_hdkh_sub[0]['tinhtranghd_id'] != '-1') {
          row.TINHTRANGHD_ID = ds_hdkh_sub[0]['tinhtranghd_id']
        }
      }
      if(ds_hdkh_sub[0]['kenhban_id'])
        row.KENHBAN_ID = ds_hdkh_sub[0]['kenhban_id']
      if(ds_hdkh_sub[0]['chuquan_id'])
        row.CHUQUAN_ID = ds_hdkh_sub[0]['chuquan_id']
      if (this.loainv_ctv_hrm > 0) {
        row.LOAINV_CTV_HRM = this.loainv_ctv_hrm
      }

      if (this.loainv_ngt_hrm > 0) {
        row.LOAINV_NGT_HRM = this.loainv_ngt_hrm
      }
      this.dsHDKH_Sub.push(row)
    },
    HienThiDanhSacHDTB(ds) {
      var tongtienhd = 0
      var tongtientb = 0
      this.lvwThueBao = []
      var i = 1
      for (var myRow of ds) {
        //var item = [i++];
        var item = { stt: i++ }
        tongtientb = myRow['tongtien'] ? myRow['tongtien'] : 0
        item.tongtien = tongtientb //myRow["tongtien"];
        item.hdtb_id = myRow['hdtb_id']
        item.ma_tt = myRow['ma_tt']
        item.ma_tb = myRow['ma_tb']
        item.ten_tb = this.ChuanHoaTen(myRow['ten_tb'])
        item.diachi_ld = this.ChuanHoaTen(myRow['diachi_ld'])
        item.ten_dvvt = myRow['ten_dvvt']
        item.loaihinh_tb = myRow['loaihinh_tb']
        item.manv_tc = myRow['manv_tc']
        item.trangthai_dongbo = myRow['trangthai_dongbo']
        item.dichvuvt_id = myRow['dichvuvt_id']
        item.hdtb_cha_id = myRow['hdtb_cha_id']
        item.loaitb_id = myRow['loaitb_id']
        tongtienhd = tongtienhd + tongtientb
        this.lvwThueBao.push(item)
      }
      this.tongtienhd = tongtienhd ? tongtienhd : 0
      if (i >= 2) {
        this.buttons.tsbtnThemTT = true
        this.buttons.tsbtnXoaTB = i != 2
      } else {
        this.buttons.tsbtnXoaTB = false
        this.buttons.tsbtnThemTB = false
      }
    },
    async HienThiTTHopDongTB(ds) {

      this.thuebao.hdtb_id_cha = 0
      this.thuebao.thuebao_id_cha = 0
      if (ds.length > 0) {
        this.listbox.dichvu_vt.value = ds[0]['dichvuvt_id']
        await delay(1000);
        this.listbox.loaihinh_tb.value = ds[0]['loaitb_id']
        await delay(1000);
        if (ds[0]['tinh_thicong']) {
          this.listbox.cboTinh.value = ds[0]['tinh_thicong']
          await this.cboTinh_EditValueChanged()
        }
        // this.tinh = await bancheo.tinh_thicong(this.listbox.cboTinh.value)
        this.thuebao.tbhd_pl = ds[0]['tbhd_pl']
        this.hdtb_id = ds[0]['hdtb_id']
        if (ds[0]['thuebao_id']) this.thuebao.thuebao_id = ds[0]['thuebao_id']
        else this.thuebao.thuebao_id = 0
        var dsNV = []
        var pdata = ''
        if (this.thuebao.thuebao_id && this.thuebao.thuebao_id != 0) pdata = '{"BANCHEO":1,"THUEBAO_ID":' + this.thuebao.thuebao_id + ',"LOAITB_ID":2}'
        // tcDB.LAY_DS_KHUVUC_THEO_HD_DB(thuebao_id, 2);
        else pdata = '{"BANCHEO":1,"THUEBAO_ID":0,"HDTB_ID":' + this.hdtb_id + ',"LOAITB_ID":' + this.listbox.loaihinh_tb.value + '}' // tcDB.LAY_DS_KHUVUC_THEO_HD_DB(hdtb_id, 1);
        var apidata = {}
        await API.post_fn_lay_tt_hdtb(this.axios, { ds_para: pdata }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            apidata = JSON.parse(response.data.data)
            if (apidata['RESULT']) apidata = apidata['RESULT']
          }
        })
        if (apidata['DS_NV']) dsNV = apidata['DS_NV']
        this.thuebao.khuvuc = ''
        if (dsNV && dsNV.length > 0) {
          this.thuebao.khuvuc = dsNV[0]['TEN_KV']
          this.thuebao.khuvuc_id = dsNV[0]['KHUVUC_ID']
        }
        this.listbox.nhacc_cu.ischecked = ds[0]['chuyenmang'] == 1
        if (this.listbox.nhacc_cu.ischecked && ds[0]['nhacc_cu_id']) this.listbox.nhacc_cu.value = ds[0]['nhacc_cu_id']
        if (this.listbox.nhacc_cu.ischecked && ds[0]['htcm_id']) this.listbox.hinhthuc_cm.value = ds[0]['htcm_id']
        this.thuebao.tentb = this.ChuanHoaTen(ds[0]['ten_tb'])
        this.diachiTB.DIACHI = ds[0]['diachi_tb']
        this.diachiLD.DIACHI = ds[0]['diachi_ld']
        await API.get_lay_ds_diachi_theo_hdtbid(this.axios, { params: { hdtbId: this.hdtb_id } }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            this.HienThiTTDiaChi(response.data.data, 3) //LINE 13862
          }
        })
        this.thuebao.ghichu = ds[0]['ghichu']
        //txtStatus.Text = ds[0]["status"]; // TODO chua xu ly cai nay vi khong nam trong muc CO_DINH, thuoc phan CNTT
        if (ds[0]['ngay_sn']) this.NgaySinhTB = ds[0]['ngay_sn']
        // FIXME dau vao theo ngay thang nam san roi, dang string. Test lai xem co can format bang moment ko?
        else if (!this.NgaySinhTB) this.NgaySinhTB = null
        for (var i = 0; i < ds.length; i++) {
          if (ds[i]['loaitb_id'] == LoaiHinhTB.INTERNET_ADSL || ds[i]['loaitb_id'] == LoaiHinhTB.INTERNET_FTTH || ds[i]['loaitb_id'] == LoaiHinhTB.WIFI_FIBER) {
            if (ds[i]['status'] == 1) {
              this.thuebao.check_tb_adsl = true
              break
            }
          }
          if (ds[i]['loaitb_id'] == LoaiHinhTB.FSECURE) {
            if (ds[i]['status'] == 5) {
              this.thuebao.check_tb_adsl = true
              break
            }
          }
        }

        this.listbox.kieu_ld.value = ds[0]['kieuld_id']

        {
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.PABX || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN2B_CD || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN2B_CQ || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN30B_CD || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN30B_CQ) {
            if (!ds[0]['ma_tb_cha']) {
              this.loaisoisdn = LOAISO_ISDN.SOCHINH
              this.thuebao.codinh.sochinh = ''
            } else {
              this.thuebao.codinh.sochinh = ds[0]['ma_tb_cha']
              this.loaisoisdn = LOAISO_ISDN.SOPHU
              if (!ds[0]['hdtb_cha_id']) {
                this.thuebao.hdtb_id_cha = ds[0]['hdtb_cha_id']
                this.loaisochinh = 0
              } else {
                this.thuebao.thuebao_id_cha = ds[0]['thuebao_cha_id']
                this.loaisochinh = 1
              }
            }
          }
        }

        this.listbox.doituong.value = ds[0]['doituong_id']
        if (ds[0]['doituong_ct_id']) this.thuebao.doituong_ct_id = ds[0]['doituong_ct_id']

        //Lấy ds mức cước thuê bao
        //this.Lay_DS_MucCuoc_TB(khuld_id, apld_id, phold_id, phuongld_id, this.listbox.loaihinh_tb.value, Convert.ToInt32(cboDoituongTB.EditValue), dtpNgayYeuCau.Value.ToString("dd/MM/yyyy"));
        await this.LoadMucCuocTB() // thay ham tren bang ham nay tuong duong

        this.listbox.donvi_ql.value = ds[0]['donvi_id']
        this.listbox.thanhtoancbo.value = ds[0]['hdtt_id']
        if(await API.post_fn_tt_hdtb_sub(this.axios,{type: 1, param: this.hdtb_id}).then(response=>{
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000')
            return response.data.data==1;
          else return false;
        }).catch(ex=>{ return false; }))
          this.vkenh_toantrinh = 1;
        else this.vkenh_toantrinh = 0;
        //this.thuebao.codinh.somay = ds[0]["ma_tb"]; // FIXME: cho nay khong dung code cu -> bỏ
        this.ma_tb = ds[0]['ma_tb']
        this.ma_tb_ht = ds[0]['ma_tb']
        if (ds[0]['goikt_id']) this.listbox.goi_kt.value = ds[0]['goikt_id']
        else this.listbox.goi_kt.value = 0

        //HungHM - 07/09/2010 chỉ áp dụng với TSL
        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          this.listbox.donvi_dau.value = ds[0]['donvi_dau_id']
          this.listbox.donvi_cuoi.value = ds[0]['donvi_cuoi_id']
        }
        var m_dsThueBao_DichVu = []
        var dsDK_DVK_TB = []
        //var pdata = "{\"THUEBAO_ID\":0,\"HDTB_ID\":"+this.hdtb_id+",\"LOAITB_ID\":"+this.listbox.loaihinh_tb.value+"}"
        // await API.post_fn_lay_tt_hdtb(this.axios, { ds_para: pdata }).then((response) => {
        //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
        //     var apidata = JSON.parse(response.data.data);
        //   }
        // });
        if (apidata['DS_DK_DVK']) dsDK_DVK_TB = apidata['DS_DK_DVK']
        if (apidata['DS_TB_DICHVU']) m_dsThueBao_DichVu = apidata['DS_TB_DICHVU']
        this.m_dsThueBao_DichVu = this.LowerCasePropertyList(m_dsThueBao_DichVu)
        await this.HT_DichVuGT()
        this.dsDK_DVK_TB = this.LowerCasePropertyList(dsDK_DVK_TB)
        await this.HT_DichVuKhac(this.LowerCasePropertyList(dsDK_DVK_TB), 1)
        //Hiếu 5.10.2010: Lấy ds khuyến mại đã được lập
        var kieu_ld = this.listbox.kieu_ld.value
        try {
          this.asyncLock = true;
          this.watcherActive = false;
          await this.HienThiTTMoRong(this.hdtb_id, this.listbox.dichvu_vt.value)
          await waitUntil(()=>!this.asyncLock);
        } catch (ex) {
          throw ex;
        }
        finally {
          this.asyncLock = false;
          this.watcherActive = true;
        }
        // await this.HienThiTTMoRong(this.hdtb_id, this.listbox.dichvu_vt.value)
        var kq = {}
        if (this.listbox.dichvu_vt.value != DichVuVienThong.TSL && this.listbox.dichvu_vt.value != DichVuVienThong.NOIBO_2DIEM ) {
          kq = await bancheo.Gan_thongso_bancheo_hdtb(this.hdtb_id, { thongso_ban: this.thongso_ban, thongso_tc: this.thongso_tc })
          this.thongso_ban = kq.thongso_ban
          this.thongso_tc = kq.thongso_tc
        } else {
          kq = await bancheo.Gan_thongso_bancheo_hdtb_tsl(this.hdtb_id, { thongso_ban: this.thongso_ban, thongso_tc_dau: this.thuebao.tsl.thongso_tc_dau, thongso_tc_cuoi: this.thuebao.tsl.thongso_tc_cuoi })
          this.thongso_ban = kq.thongso_ban
          this.thuebao.tsl.thongso_tc_dau = kq.thongso_tc_dau
          this.thuebao.tsl.thongso_tc_cuoi = kq.thongso_tc_cuoi
        }

        //Mức cước thuê bao giờ để trong bảng hd_thuebao - Lamnt: 13/08/2013
        if (ds[0]['mucuoctb_id']) this.listbox.muccuoc_tb.value = ds[0]['mucuoctb_id']

        if (ds[0]['tg_thue_tu']) {
          this.TGThueTuNgay = moment(ds[0]['tg_thue_tu']).format('DD/MM/YYYY')
          this.TGThueDenNgay = moment(ds[0]['tg_thue_den']).format('DD/MM/YYYY')
          this.kt_thuenganhan = true
        } else {
          this.TGThueTuNgay = moment(new Date()).format('DD/MM/YYYY')
          this.TGThueDenNgay = moment(new Date()).format('DD/MM/YYYY')
          this.kt_thuenganhan = false
        }

        await this.HT_DS_KhuyenMai_Combobox()
        if (apidata['KETCUOI_ID']) this.KetCuoi_ID = apidata['KETCUOI_ID']
        else this.KetCuoi_ID = -1

        //Lấy ra các đơn vị được chọn
          await this.HT_GIAODIEN_DONVI();
        {
          var dtTemp = []
          if (apidata['HDTB_DV']) dtTemp = apidata['HDTB_DV']
          if (dtTemp.length > 0) {
            for (var i = 0; i < this.DT_CONTROLS.value; i++) {
              // var cbo = this.DT_CONTROLS.value[i];
              var dr = dtTemp.filter((x) => x.loaidv_id == this.DT_CONTROLS.tagvalue[i])
              if (dr.Length > 0) {
                if (dr[0]['DONVI_ID']) this.DT_CONTROLS.value[i] = dr[0]['DONVI_ID']
                else {
                  // Them case else nay xu ly khi thay doi du lieu tu chon gia tri moi
                  var j = 0
                  for (; j < this.DT_CONTROLS.data[i].length; j++) if (this.DT_CONTROLS.data[i][j].DONVI_ID == this.DT_CONTROLS.value[i]) break
                  if (j >= this.DT_CONTROLS.data[i].length) this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0].DONVI_ID
                }
                this.DT_CONTROLS.key += 1
                //this.DT_CONTROLS.tagvalue[i] = dr[0]["LOAIDV_ID"];
              }
            }
          }
        }

        //Hieustc: 2.6.2011: Hiển thị chi tiết khuyến mại neo
        if (this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG) {
          if (this.dsKM_HDTB.length > 0) {
            for (var i = 0; i < this.dsKM_Neo.length; i++) {
              if (this.dsKM_HDTB[0]['khuyenmai_id_neo'] == this.dsKM_Neo[i]['khuyenmai_id']) {
                this.dsKM_Neo[i]['dangky'] = 1
                break
              }
            }
          }
        }

        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL) {
          this.cbvmp = ds[0]['vmp'] && ds[0]['vmp'] != 0 ? true : false
        }

        //Longdx: bổ sung lấy chi tiết KM
        //DataSet dsTemp = tchopdong.LAY_CHITIET_KM_THEO_HDTB_ID(hdtb_id, 0);
        var dsTemp = []
        var dsTempTT = []
        if (apidata['DS_CTKM']) dsTemp = this.LowerCasePropertyList(apidata['DS_CTKM'])
        this.dsKM_HDTB = []
        if (dsTemp.length > 0) {
          if (dsTemp[0]['khuyenmai_id']) {
            this.filterbox.khuyenmai.value = dsTemp[0]['khuyenmai_id']
            this.filterbox.khuyenmai.ischecked = true
          } else {
            this.filterbox.khuyenmai.ischecked = false
          }
          this.dsKM_HDTB = [...dsTemp] //Object.assign({}, dsTemp)
          // this.filterbox.khuyenmai.list = this.dsKM_HDTB
        }
        else {
          this.filterbox.khuyenmai.ischecked = false
          this.dsKM_HDTB = []
          // this.filterbox.khuyenmai.list = this.dsKM_HDTB
          // this.LoadTTKhuyenMai(KHOANMUC_TT.KMTT_DATMOI, 0)
        }

        //Longdx: bổ sung lấy chi tiết KM
        if (apidata['DS_DATCOC']) dsTempTT = this.LowerCasePropertyList(apidata['DS_DATCOC'])
        this.dsDC_HDTB = []
        if (dsTempTT.length > 0) {
          if (dsTempTT[0]['khuyenmai_id']) {
            this.filterbox.tratruoc.value = dsTempTT[0]['khuyenmai_id']
            this.filterbox.tratruoc.ischecked = true
          } else {
            this.filterbox.tratruoc.ischecked = false
          }
          this.dsDC_HDTB = [...dsTempTT]

          for (var item of this.dsDC_HDTB) {
            item['ngay_bd'] = item['ngay_bd'] && (item['ngay_bd'] + '').indexOf('T') > 0 ? moment(item['ngay_bd']).format('DD/MM/YYYY') : item['ngay_bd']
            item['ngay_bddc'] = item['ngay_bddc'] && (item['ngay_bddc'] + '').indexOf('T') > 0 ? moment(item['ngay_bddc']).format('DD/MM/YYYY') : item['ngay_bddc'] //item["ngay_bddc"];
            item['ngay_kt'] = item['ngay_kt'] && (item['ngay_kt'] + '').indexOf('T') > 0 ? moment(item['ngay_kt']).format('DD/MM/YYYY') : item['ngay_kt'] //item["ngay_kt"];
            item['ngay_ktdc'] = item['ngay_ktdc'] && (item['ngay_ktdc'] + '').indexOf('T') > 0 ? moment(item['ngay_ktdc']).format('DD/MM/YYYY') : item['ngay_ktdc'] //item["ngay_ktdc"];
          }
          // this.filterbox.tratruoc.list = this.dsDC_HDTB
        } else {
          this.filterbox.tratruoc.ischecked = false
          this.dsDC_HDTB = []
          // this.filterbox.tratruoc.list = this.dsDC_HDTB
          // this.LoadTTKhuyenMai(KHOANMUC_TT.KMTT_DATMOI, 1, 'tratruoc')
        }
        await delay(1000);
        this.dsCTM_TBI = []
        if (apidata['DS_MUA_TBI']) this.dsCTM_TBI = this.LowerCasePropertyList([...apidata['DS_MUA_TBI']])
        if (apidata['DS_TIENHD_KM']) this.ds_tien_khoanmuc = this.LowerCasePropertyList([...apidata['DS_TIENHD_KM']])
        this.ds_tien_khoanmuc_bd = [...this.ds_tien_khoanmuc]
        for (var i = 0; i < this.ds_tien_khoanmuc.length; i++) {
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
            this.dtienld = this.ds_tien_khoanmuc[i]['tien']
            this.dvatld = this.ds_tien_khoanmuc[i]['vat']
          }
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
            this.dtiencd = this.ds_tien_khoanmuc[i]['tien']
            this.dvatcd = this.ds_tien_khoanmuc[i]['vat']
          }
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DICHVU) {
            this.dichvu.dtien_dv = this.ds_tien_khoanmuc[i]['tien']
            this.dichvu.dvat_dv = this.ds_tien_khoanmuc[i]['vat']
          }
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT) {
            this.kmld.dtienkmld = this.ds_tien_khoanmuc[i]['tien']
            this.kmld.dvatkmld = this.ds_tien_khoanmuc[i]['vat']
          }
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DATCOC) {
            this.kmld.dtienkmdc = this.ds_tien_khoanmuc[i]['tien']
            this.kmld.dvatkmdc = this.ds_tien_khoanmuc[i]['vat']
          }
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC) {
            this.kmld.dtiendatcoc_tt = this.ds_tien_khoanmuc[i]['tien']
            this.kmld.dvatdatcoc_tt = this.ds_tien_khoanmuc[i]['vat']
          }
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC_KM) {
            this.kmld.dtiendatcoc_km = this.ds_tien_khoanmuc[i]['tien']
            this.kmld.dvatdatcoc_km = this.ds_tien_khoanmuc[i]['vat']
          }
        }
        await this.HT_ThietBi()
        //this.HT_DichVuGT();
        await this.HienThiTienKhuyenMaiLapDat()
        if (apidata['DS_MUA_TBI']) this.dsCTM_TBI = this.LowerCasePropertyList([...apidata['DS_MUA_TBI']])
        if (apidata['DS_TIENHD_KM']) this.ds_tien_khoanmuc = this.LowerCasePropertyList([...apidata['DS_TIENHD_KM']])
        await this.LayTongTien_HDTB()
        if (ds[0]['loaitb_id'] == LoaiHinhTB.INTERNET_MYTV) {
          this.HT_DS_DBCHINH_MYTV()
          this.HT_DS_HDCHINH_MYTV()
          if (ds[0]['hdtb_cha_id'] && ds[0]['hdtb_cha_id'] != 0) {
            this.thuebao.adsl.isHopDong = 1
            this.listbox.cboHDChinh.value = ds[0]['hdtb_cha_id']
          }

          if (ds[0]['thuebao_cha_id'] && ds[0]['thuebao_cha_id'] != 0) {
            this.thuebao.adsl.isHopDong = 0
            this.listbox.cboDbChinh.value = ds[0]['thuebao_cha_id']
          }
        }
        //TODO bo qua vi khong phai CO_DINH

        if (ds[0]['loaitb_id'] == LoaiHinhTB.IMS_SIPTRUNKING) {
          this.HT_DS_TRUNK_IMS()
          if (ds[0]['hdtb_cha_id'] && ds[0]['hdtb_cha_id'] != 0) {
            this.thuebao.ims.cbkTrunk = true
            this.thuebao.ims.cboTrunk.value = ds[0]['hdtb_cha_id']
          }

          if (ds[0]['thuebao_cha_id'] && ds[0]['thuebao_cha_id'] != 0) {
            this.thuebao.ims.cbkTrunk = true
            this.thuebao.ims.cboTrunk.value = ds[0]['thuebao_cha_id'] ? ds[0]['thuebao_cha_id'] * 1 : 0 //Convert.ToInt64(ds[0]["thuebao_cha_id"]);
          }
        }

        this.thuebao.thangck = ds[0]['sothang_ck']
      }
    },
    HT_DS_TRUNK_IMS() {
      try {
        API.post_ht_ds_tb_chinh_ims(this.axios, {
          hdkh_id: this.khachhang.hdkh_id ? this.khachhang.hdkh_id : 0,
          khachhang_id: this.khachhang.khachhang_id ? this.khachhang.khachhang_id : 0
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            this.thuebao.ims.cboTrunk.list = response.data.data
            if (this.thuebao.ims.cboTrunk.list && this.thuebao.ims.cboTrunk.list.length > 0 && (!this.thuebao.ims.cboTrunk.value || this.thuebao.ims.cboTrunk.value <= 0)) this.thuebao.ims.cboTrunk.value = this.thuebao.ims.cboTrunk.list[0].trunkid
          }
        })
      } catch (ex) {
        this.$toast.error('Lỗi khi lấy thông tin đường trunk ! ' + this.debug ? ex : '')
        if (this.debug) console.error(ex)
      }
    },
    ChuanHoaTen(ten) {
      if (!ten) return ''
      var ten_new = ''
      var str_con = ten.trim()
      var str_xl = ''
      var k = 0
      var found = true
      if (str_con.length < 1) return
      str_con = str_con.replaceAll(/\s+/g, ' ')
      try {
        while (found) {
          k = str_con.indexOf(' ')
          if (k > 0) {
            str_xl = str_con.substring(0, k)
            str_con = str_con.substring(k + 1)
            str_xl = this.ChuyenChuHoa(str_xl)
            if (ten_new != '') ten_new += ' ' + str_xl
            else ten_new = str_xl
            found = true
          } else found = false
        }
        if (str_con != '') {
          str_xl = str_con
          str_xl = this.ChuyenChuHoa(str_xl)
          if (ten_new != '') ten_new = ten_new + ' ' + str_xl
          else ten_new = str_xl
        }
        return ten_new
      } catch (e) {
        return ten
      }
    },
    ChuyenChuHoa(str) {
      var kq = ''
      if (str.ismatch(/[A-Z][A-Z]/g)) kq = str.toUpperCase()
      else {
        if (str[0] == '(') kq = str[0] + str[1].toUpperCase() + str.substring(2).toLowerCase()
        else kq = str[0].toUpperCase() + str.substring(1).toLowerCase()
      }
      return kq
    },
    HienThiTTDiaChi(ds, kieu) {
      ds = this.LowerCasePropertyList(ds)
      if (ds.length > 0) {
        switch (kieu * 1) {
          case 1:
            if (ds[0]['tinh_thicong']) {
              this.listbox.cboTinh.value = ds[0]['tinh_thicong']
              this.cboTinh_EditValueChanged()
            }
            this.diachiKH.DIACHI_ID = ds[0]['diachi_id']
            this.diachiKH.TINH_ID = ds[0]['tinh_id']
            this.diachiKH.QUAN_ID = ds[0]['quan_id']
            this.diachiKH.PHUONG_ID = ds[0]['phuong_id']
            if (ds[0]['pho_id']) this.diachiKH.PHO_ID = ds[0]['pho_id']
            else this.diachiKH.PHO_ID = 0
            if (ds[0]['ap_id']) this.diachiKH.AP_ID = ds[0]['ap_id']
            else this.diachiKH.AP_ID = 0
            if (ds[0]['khu_id']) this.diachiKH.KHU_ID = ds[0]['khu_id']
            else this.diachiKH.KHU_ID = 0
            if (ds[0]['dacdiem_id']) this.diachiKH.DACDIEM_ID = ds[0]['dacdiem_id']
            else this.diachiKH.DACDIEM_ID = 0
            this.diachiKH.SO_NHA = this.ChuanHoaTen(ds[0]['sonha'])

            if (ds[0]['block']) this.diachiKH.BLOCK = ds[0]['block']
            if (ds[0]['tang']) this.diachiKH.TANG = ds[0]['tang']
            if (ds[0]['phong']) this.diachiKH.PHONG = ds[0]['phong']
            if (ds[0]['mota']) this.diachiKH.MOTA = ds[0]['mota']

            if (ds[0]['vido'] && ds[0]['vido']) this.diachiKH.Lat = ds[0]['vido']
            else this.diachiKH.Lat = 0
            if (ds[0]['kinhdo'] && ds[0]['kinhdo']) this.diachiKH.Lng = ds[0]['kinhdo']
            else this.diachiKH.Lng = 0
            break
          case 2:
            this.diachiTT.DIACHI_ID = ds[0]['diachi_id']
            this.diachiTT.TINH_ID = ds[0]['tinh_id']
            this.diachiTT.QUAN_ID = ds[0]['quan_id']
            this.diachiTT.PHUONG_ID = ds[0]['phuong_id']
            if (ds[0]['pho_id']) this.diachiTT.PHO_ID = ds[0]['pho_id']
            else this.diachiTT.PHO_ID = 0
            if (ds[0]['ap_id']) this.diachiTT.AP_ID = ds[0]['ap_id']
            else this.diachiTT.AP_ID = 0
            if (ds[0]['khu_id']) this.diachiTT.KHU_ID = ds[0]['khu_id']
            else this.diachiTT.KHU_ID = 0
            if (ds[0]['dacdiem_id']) this.diachiTT.DACDIEM_ID = ds[0]['dacdiem_id']
            else this.diachiTT.DACDIEM_ID = 0
            this.diachiTT.SO_NHA = this.ChuanHoaTen(ds[0]['sonha'])

            if (ds[0]['block']) this.diachiTT.BLOCK = ds[0]['block']
            if (ds[0]['tang']) this.diachiTT.TANG = ds[0]['tang']
            if (ds[0]['phong']) this.diachiTT.PHONG = ds[0]['phong']
            if (ds[0]['mota']) this.diachiTT.MOTA = ds[0]['mota']

            if (ds[0]['vido'] && ds[0]['vido']) this.diachiTT.Lat = ds[0]['vido']
            else this.diachiTT.Lat = 0
            if (ds[0]['kinhdo'] && ds[0]['kinhdo']) this.diachiTT.Lng = ds[0]['kinhdo']
            else this.diachiTT.Lng = 0

            if (ds[0]['diachibc_id']) this.diachiBC.DIACHI_ID = ds[0]['diachibc_id']
            else this.diachiBC.DIACHI_ID = 0
            if (ds[0]['tinhbc_id']) this.diachiBC.TINH_ID = ds[0]['tinhbc_id']
            else this.diachiBC.TINH_ID = 0
            if (ds[0]['quanbc_id']) this.diachiBC.QUAN_ID = ds[0]['quanbc_id']
            else this.diachiBC.QUAN_ID = 0
            if (ds[0]['phuongbc_id']) this.diachiBC.PHUONG_ID = ds[0]['phuongbc_id']
            else this.diachiBC.PHUONG_ID = 0
            if (ds[0]['phobc_id']) this.diachiBC.PHO_ID = ds[0]['phobc_id']
            else this.diachiBC.PHO_ID = 0
            if (ds[0]['apbc_id']) this.diachiBC.AP_ID = ds[0]['apbc_id']
            else this.diachiBC.AP_ID = 0
            if (ds[0]['khubc_id']) this.diachiBC.KHU_ID = ds[0]['khubc_id']
            else this.diachiBC.KHU_ID = 0
            if (ds[0]['dacdiembc_id']) this.diachiBC.DACDIEM_ID = ds[0]['dacdiembc_id']
            else this.diachiBC.DACDIEM_ID = 0
            if (ds[0]['sonha_bc']) this.diachiBC.SO_NHA = this.ChuanHoaTen(ds[0]['sonha_bc'])
            else this.diachiBC.SO_NHA = ''

            if (ds[0]['block']) this.diachiBC.BLOCK = ds[0]['block']
            if (ds[0]['tang']) this.diachiBC.TANG = ds[0]['tang']
            if (ds[0]['phong']) this.diachiBC.PHONG = ds[0]['phong']
            if (ds[0]['mota']) this.diachiBC.MOTA = ds[0]['mota']

            if (ds[0]['vido_bc'] && ds[0]['vido_bc']) this.diachiBC.Lat = ds[0]['vido_bc']
            else this.diachiBC.Lat = 0
            if (ds[0]['kinhdo_bc'] && ds[0]['kinhdo_bc']) this.diachiBC.Lng = ds[0]['kinhdo_bc']
            else this.diachiBC.Lng = 0
            break
          case 3:
            this.diachiTB.DIACHI_ID = ds[0]['diachi_id']
            this.diachiLD.DIACHI_ID = ds[0]['diachild_id']
            this.diachiTB.TINH_ID = ds[0]['tinh_id']
            this.diachiTB.QUAN_ID = ds[0]['quan_id']
            this.diachiTB.PHUONG_ID = ds[0]['phuong_id']
            if (ds[0]['pho_id']) this.diachiTB.PHO_ID = ds[0]['pho_id']
            else this.diachiTB.PHO_ID = 0
            if (ds[0]['ap_id']) this.diachiTB.AP_ID = ds[0]['ap_id']
            else this.diachiTB.AP_ID = 0
            if (ds[0]['khu_id']) this.diachiTB.KHU_ID = ds[0]['khu_id']
            else this.diachiTB.KHU_ID = 0
            if (ds[0]['dacdiem_id']) this.diachiTB.DACDIEM_ID = ds[0]['dacdiem_id']
            else this.diachiTB.DACDIEM_ID = 0
            this.diachiTB.SO_NHA = this.ChuanHoaTen(ds[0]['sonha'])

            if (ds[0]['block']) this.diachiTB.BLOCK = ds[0]['block']
            if (ds[0]['tang']) this.diachiTB.TANG = ds[0]['tang']
            if (ds[0]['phong']) this.diachiTB.PHONG = ds[0]['phong']
            if (ds[0]['mota']) this.diachiTB.MOTA = ds[0]['mota']

            if (ds[0]['vido'] && ds[0]['vido']) this.diachiTB.Lat = ds[0]['vido']
            else this.diachiTB.Lat = 0
            if (ds[0]['kinhdo'] && ds[0]['kinhdo']) this.diachiTB.Lng = ds[0]['kinhdo']
            else this.diachiTB.Lng = 0

            if (ds[0]['tinhld_id']) this.diachiLD.TINH_ID = ds[0]['tinhld_id']
            else this.diachiLD.TINH_ID = 0
            if (ds[0]['quanld_id']) this.diachiLD.QUAN_ID = ds[0]['quanld_id']
            else this.diachiLD.QUAN_ID = 0
            if (ds[0]['phuongld_id']) this.diachiLD.PHUONG_ID = ds[0]['phuongld_id']
            else this.diachiLD.PHUONG_ID = 0
            if (ds[0]['phold_id']) this.diachiLD.PHO_ID = ds[0]['phold_id']
            else this.diachiLD.PHO_ID = 0
            if (ds[0]['apld_id']) this.diachiLD.AP_ID = ds[0]['apld_id']
            else this.diachiLD.AP_ID = 0
            if (ds[0]['khuld_id']) this.diachiLD.KHU_ID = ds[0]['khuld_id']
            else this.diachiLD.KHU_ID = 0
            if (ds[0]['dacdiemld_id']) this.diachiLD.DACDIEM_ID = ds[0]['dacdiemld_id']
            else this.diachiLD.DACDIEM_ID = 0
            if (ds[0]['sonha_ld']) this.diachiLD.SO_NHA = this.ChuanHoaTen(ds[0]['sonha_ld'])
            else this.diachiLD.SO_NHA = ''

            if (ds[0]['block']) this.diachiLD.BLOCK = ds[0]['block']
            if (ds[0]['tang']) this.diachiLD.TANG = ds[0]['tang']
            if (ds[0]['phong']) this.diachiLD.PHONG = ds[0]['phong']
            if (ds[0]['mota']) this.diachiLD.MOTA = ds[0]['mota']

            if (ds[0]['vido_ld'] && ds[0]['vido_ld']) this.diachiLD.Lat = ds[0]['vido_ld']
            else this.diachiLD.Lat = 0
            if (ds[0]['kinhdo_ld'] && ds[0]['kinhdo_ld']) this.diachiLD.Lng = ds[0]['kinhdo_ld']
            else this.diachiLD.Lng = 0

            if (this.listbox.kieu_ld.value == KieuLapDat.TACH_VLAN) {
              this.diachiTB.DIACHI = ds[0]['diachi']
              this.diachiLD.DIACHI = ds[0]['diachi_ld']
            }

            if (ds[0]['diachiid']) this.diachiTB.DIACHI_ID = ds[0]['diachiid']
            if (ds[0]['diachildid']) this.diachiLD.DIACHI_ID = ds[0]['diachildid']
            if (ds[0]['tinhid']) this.diachiTB.TINH_ID = ds[0]['tinhid']
            if (ds[0]['quanid']) this.diachiTB.QUAN_ID = ds[0]['quanid']
            if (ds[0]['phuongid']) this.diachiTB.PHUONG_ID = ds[0]['phuongid']
            if (ds[0]['phoid']) this.diachiTB.PHO_ID = ds[0]['phoid']
            // else
            //     this.diachiTB.PHO_ID = 0;
            if (ds[0]['apid']) this.diachiTB.AP_ID = ds[0]['apid']
            // else
            //     this.diachiTB.AP_ID = 0;
            if (ds[0]['khuid']) this.diachiTB.KHU_ID = ds[0]['khuid']
            // else
            //     this.diachiTB.KHU_ID = 0;
            if (ds[0]['dacdiemid']) this.diachiTB.DACDIEM_ID = ds[0]['dacdiemid']
            // else
            //     this.diachiTB.DACDIEM_ID = 0;

            // DOAN NAY DE FIX LOI DU LIEU RA KHONG CO DAU _
            if (ds[0]['tinhldid']) this.diachiLD.TINH_ID = ds[0]['tinhldid']
            // else this.diachiLD.TINH_ID = 0;
            if (ds[0]['quanldid']) this.diachiLD.QUAN_ID = ds[0]['quanldid']
            // else this.diachiLD.QUAN_ID = 0;
            if (ds[0]['phuongldid']) this.diachiLD.PHUONG_ID = ds[0]['phuongldid']
            // else this.diachiLD.PHUONG_ID = 0;
            if (ds[0]['pholdid']) this.diachiLD.PHO_ID = ds[0]['pholdid']
            // else
            //     this.diachiLD.PHO_ID = 0;
            if (ds[0]['apldid']) this.diachiLD.AP_ID = ds[0]['apldid']
            // else
            //     this.diachiLD.AP_ID = 0;
            if (ds[0]['khuldid']) this.diachiLD.KHU_ID = ds[0]['khuldid']
            // else
            //     this.diachiLD.KHU_ID = 0;
            if (ds[0]['dacdiemldid']) this.diachiLD.DACDIEM_ID = ds[0]['dacdiemldid']
            // else
            //     this.diachiLD.DACDIEM_ID = 0;
            if (ds[0]['sonhald']) this.diachiLD.SO_NHA = this.ChuanHoaTen(ds[0]['sonhald'])

            if (ds[0]['block']) this.diachiLD.BLOCK = ds[0]['block']
            if (ds[0]['tang']) this.diachiLD.TANG = ds[0]['tang']
            if (ds[0]['phong']) this.diachiLD.PHONG = ds[0]['phong']
            if (ds[0]['mota']) this.diachiLD.MOTA = ds[0]['mota']

            // else this.diachiLD.SO_NHA = '';
            if (ds[0]['vidold']) this.diachiLD.Lat = ds[0]['vidold']
            // else
            //     this.diachiLD.Lat = 0;
            if (ds[0]['kinhdold']) this.diachiLD.Lng = ds[0]['kinhdold']
            // else
            //     this.diachiLD.Lng = 0;

            if (this.listbox.kieu_ld.value == KieuLapDat.TACH_VLAN && ds[0]['diachild']) {
              this.diachiLD.DIACHI = ds[0]['diachild']
            }
            this.LAY_DONVI_THEO_LOAIDV_DIACHI_LD_V2() //phuongld_id, phold_id, apld_id, khuld_id, dacdiemld_id LINE 15387 -- bo qua tham so vi global san roi
            break
        }
      }
    },
    LAY_DONVI_THEO_LOAIDV_DIACHI_LD_V2() {
      var newval = this.diachiLD
      var pdata1 = {
        DT_CONTROLS: this.DT_CONTROLS.list,
        PHIEUHS_ID: this.PHIEUHS_ID ? this.PHIEUHS_ID : 0,
        PHUONG_ID: newval.PHUONG_ID ? newval.PHUONG_ID : 0,
        PHO_ID: newval.PHO_ID ? newval.PHO_ID : 0,
        AP_ID: newval.AP_ID ? newval.AP_ID : 0,
        KHU_ID: newval.KHU_ID ? newval.KHU_ID : 0,
        DACDIEM_ID: newval.DACDIEM_ID ? newval.DACDIEM_ID : 0,
        TTND_DV_ID: this.$root.token.getNguoiDungID(),
        HDKH_ID: this.khachhang.hdkh_id,
        CTV_ID: this.filterbox.ctv.value,
        NGUOIGT_ID: this.filterbox.nguoigt.value,
        BANCHEO: 1
      }
      API.post_fn_lay_donvi_theo_loaidv_diachi_ld_v2(this.axios, { ds_para: JSON.stringify(pdata1) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          var dulieuapi = JSON.parse(response.data.data)
          if (dulieuapi['RESULT']['DS_GT_DVI'] && dulieuapi['RESULT']['DS_GT_DVI'].length > 0 && this.DT_CONTROLS.data.length == dulieuapi['RESULT']['DS_GT_DVI'].length) {
            this.DT_CONTROLS.value = dulieuapi['RESULT']['DS_GT_DVI']
            for (var i = 0; i < this.DT_CONTROLS.data.length; i++) {
              if (this.DT_CONTROLS.data[i] && this.DT_CONTROLS.data[i].length > 0 && !this.DT_CONTROLS.value[i]) {
                this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0].DONVI_ID
                this.DT_CONTROLS.tagvalue[i] = this.DT_CONTROLS.data[i][0].LOAIDV_ID
              }
            }
            this.DT_CONTROLS.dichvu_vt = this.listbox.dichvu_vt.value
            this.DT_CONTROLS.key += 1
          }
        }
      })
      //HienThi_PBH_KBH() // TODO co 1 dieu kien nao do goi den day, check lai sau.
    },
    LowerCasePropertyList(obj) {
      return obj.map(function(item) {
        for (var key in item) {
          var upper = key.toLowerCase()
          // check if it already wasn't uppercase
          if (upper !== key) {
            item[upper] = item[key]
            delete item[key]
          }
        }
        return item
      })
    },
    UpperCasePropertyList(obj) {
      return obj.map(function(item) {
        for (var key in item) {
          var upper = key.toUpperCase()
          // check if it already wasn't uppercase
          if (upper !== key) {
            item[upper] = item[key]
            delete item[key]
          }
        }
        return item
      })
    },
    async LayTienTheoKhoanMuc() {
      var muccuoc = 0
      if (
        this.listbox.dichvu_vt.value != DichVuVienThong.ADSL &&
        this.listbox.dichvu_vt.value != DichVuVienThong.MEGAWAN &&
        this.listbox.dichvu_vt.value != DichVuVienThong.METRONET &&
        this.listbox.dichvu_vt.value != DichVuVienThong.NOIBO_DADIEM &&
        this.listbox.dichvu_vt.value != DichVuVienThong.BRCD_DOITAC &&
        this.listbox.dichvu_vt.value != DichVuVienThong.MGW_DOITAC
      ) {
        this.kh_cd = 0
        this.ltb_adsl_id = 1
      } else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER) {
        //TODO chua lam do thuoc phan BB
        if (this.listbox.cboLoaiTB.value == LOAITBI_ADSL.ADSL) return
        if (this.listbox.kieu_ld.value == KieuLapDat.DM_ADSL_CO_SAN_DT || this.listbox.kieu_ld.value == KieuLapDat.DM_ADSL_KHONG_SO || this.listbox.kieu_ld.value == KieuLapDat.DM_ADSL_KEM_DT) return
        if (this.listbox.kieu_ld.value == KieuLapDat.MYTV_KHONGSO_CAPDONG) return
      } else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_1260) {
        if (this.listbox.kieu_ld.value == KieuLapDat.DM_CODINH) return
      }

      // var tocdo = this.tocdo_id;
      // muccuoc = this.muccuoc_id;
      if (this.listbox.dichvu_vt.value == 4) {
        //TODO xu ly sau vi khong thuoc phan co dinh
        this.muccuoc_id = this.listbox.muccuoc.value
        this.tocdo_id = this.listbox.cboGoiCuocAdsl.value
      }
      //UR 2.1.4.068
      var pdata = {
        vapld_id: this.diachiLD.AP_ID,
        vdichvuvt_id: this.listbox.dichvu_vt.value,
        vdoituong_id: this.listbox.doituong.value,
        vkh_cd: this.kh_cd,
        vkhuld_id: this.diachiLD.KHU_ID,
        vkieuld_id: this.listbox.kieu_ld.value,
        vloaihd_id: 0,
        vloaitb_id: this.listbox.loaihinh_tb.value,
        vltb_adsl_cu_id: 0,
        vltb_adsl_id: 0,
        vltb_adsl_moi_id: 0,
        vmuccuoc_id: this.muccuoc_id,
        vngay_yc: this.NgayYeuCau,
        vphanvung_id: this.$root.token.getPhanVungID(),
        vphold_id: this.diachiLD.PHO_ID,
        vphuongld_id: this.diachiLD.PHUONG_ID,
        vtocdo_cu_id: this.tocdo_cu_id,
        vtocdo_id: this.tocdo_id,
        vtocdo_moi_id: this.tocdo_moi_id,
        vtrangbi_id: this.listbox.trangbi.valuecd //BUG can xem lai cho nay khi khong dung cho co dinh
      }
      await API.post_lay_tien_khoanmuc_ld_v2(this.axios, pdata).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          var ds = response.data.data
          if (ds.length > 0) {
            this.HienThiTienLapDat(ds)
            this.LayTongTien_HDTB()
          } else {
            this.dtienld = 0
            this.dtiencd = 0
          }
        }
      })
    },
    HienThiTienLapDat(ds) {
      var kt_cd = true
      var kt_lm = true
      if (ds && ds.length > 0)
        for (var item of ds) {
          item.tien = item.tien * 1
          item.vat = item.vat * 1
          item.tyle_vat = item.tyle_vat * 1
        }
      if (ds[0]['tien'] != -1) {
        for (var i = 0; i < ds.length; i++) {
          if (ds[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
            this.dtiencd = ds[i]['tien']
            this.dvatcd = ds[i]['vat']
            this.vtyle_vat_id_cd = ds[i]['tyle_vat_id']
            this.vtyle_vat_cd = ds[i]['tyle_vat']

            kt_cd = false
          } else if (ds[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
            this.dtienld = ds[0]['tien']
            this.dvatld = ds[0]['vat']
            this.vtyle_vat_id_dnhm = ds[i]['tyle_vat_id']
            this.vtyle_vat_dnhm = ds[i]['tyle_vat']
            kt_lm = false
          } else if (ds[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_HOAMANG_DD_TRASAU) {
            //TODO hoan thien tu day
            for (var j = 0; j < this.listbox.tien_km.list.length; j++) {
              if (this.listbox.tien_km.list[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_HOAMANG_DD_TRASAU) {
                this.listbox.tien_km.list[j]['tien'] = ds[0]['tien']
                this.listbox.tien_km.list[j]['vat'] = ds[0]['vat']
              }
            }
          }
        }
        if (kt_cd == true) {
          this.dtiencd = 0
          this.dvatcd = 0
        }
        if (kt_lm == true) {
          this.dtienld = 0
          this.dvatld = 0
        }
      } else {
        this.dtienld = 0
        this.dvatld = 0
        this.dtiencd = 0
        this.dvatcd = 0
        this.vtyle_vat_id_dnhm = 1
        this.vtyle_vat_dnhm = 10
        this.vtyle_vat_id_cd = 1
        this.vtyle_vat_cd = 10
      }
      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
          this.ds_tien_khoanmuc[j]['tien'] = this.dtienld
          this.ds_tien_khoanmuc[j]['vat'] = this.dvatld
        }
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
          this.ds_tien_khoanmuc[j]['tien'] = this.dtiencd
          this.ds_tien_khoanmuc[j]['vat'] = this.dvatcd
        }
      }
      this.HienThiTienKhuyenMaiLapDat()
    },
    //private void HienThiTienKhuyenMaiLapDat(decimal tien_kmld, decimal vat_kmld, decimal tien_datcoc, decimal tien_kmld_tt, decimal vat_kmld_tt, decimal dtiendatcoc_tt)
    HienThiTienKhuyenMaiLapDat() {
      // NOTE thay doi do tham so lay global, khong can thiet su dung tham so.
      var dtienkmld_tmp = this.kmld.dtienkmld * 1
      var dvatkmld_tmp = this.kmld.dvatkmld * 1
      var dtyle_kmld_tmp = this.kmld.tyle_kmld * 1
      if (Math.abs(dtienkmld_tmp) < Math.abs(this.kmld.dtienkmdc)) {
        dtienkmld_tmp = this.kmld.dtienkmdc
        dvatkmld_tmp = this.kmld.dvatkmdc
      }
      if (dtyle_kmld_tmp < this.kmld.tyle_kmld_tt) {
        dtyle_kmld_tmp = this.kmld.tyle_kmld_tt
      }
      if (dtyle_kmld_tmp > 0) {
        dtienkmld_tmp = this.round((this.dtienld * dtyle_kmld_tmp) / 100)
        dvatkmld_tmp = ((this.dtienld + this.dvatld) * dtyle_kmld_tmp) / 100 - dtienkmld_tmp
      }
      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT) {
          if (this.kmld.dtienkmld < 0) {
            this.ds_tien_khoanmuc[j]['tien'] = dtienkmld_tmp * -1
            this.ds_tien_khoanmuc[j]['vat'] = dvatkmld_tmp * -1
          } else {
            this.ds_tien_khoanmuc[j]['tien'] = dtienkmld_tmp
            this.ds_tien_khoanmuc[j]['vat'] = dvatkmld_tmp
          }
        }

        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC) {
          this.ds_tien_khoanmuc[j]['tien'] = this.round(this.kmld.dtiendatcoc_tt)
          this.ds_tien_khoanmuc[j]['vat'] = this.round(this.kmld.dvatdatcoc_tt)
        }
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC_KM) {
          this.ds_tien_khoanmuc[j]['tien'] = this.round((this.kmld.dtiendatcoc_km * 10) / 11)
          this.ds_tien_khoanmuc[j]['vat'] = this.round(this.kmld.dtiendatcoc_km / 11)
        }
      }
      this.LayTongTien_HDTB()
    },
    LayTongTien_HDTB() {
      try {
        var dtongtien = 0
        var dtongvat = 0
        if (this.ds_tien_khoanmuc && this.ds_tien_khoanmuc.length > 0)
          for (var item of this.ds_tien_khoanmuc) {
            item.tien = item.tien * 1
            item.vat = item.vat * 1
            item.tyle_vat = item.tyle_vat * 1
          }
        for (var i = 0; i < this.ds_tien_khoanmuc.length; i++) {
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT || this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DATCOC) {
            if (this.ds_tien_khoanmuc[i]['tien'] < 0) {
              dtongtien += this.ds_tien_khoanmuc[i]['tien'] ? this.ds_tien_khoanmuc[i]['tien'] : 0
              dtongvat += this.ds_tien_khoanmuc[i]['vat'] ? this.ds_tien_khoanmuc[i]['vat'] : 0
            } else {
              dtongtien += this.ds_tien_khoanmuc[i]['tien'] * -1
              dtongvat += this.ds_tien_khoanmuc[i]['vat'] * -1
            }
          } else if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] != KHOANMUC_TT.KMTT_TRAGOP_THIETBI && this.ds_tien_khoanmuc[i]['khoanmuctt_id'] != KHOANMUC_TT.KMTT_KM_THIETBI && this.ds_tien_khoanmuc[i]['khoanmuctt_id'] != KHOANMUC_TT.KMTT_MUATHIETBI) {
            dtongtien += this.ds_tien_khoanmuc[i]['tien'] ? this.ds_tien_khoanmuc[i]['tien'] : 0
            dtongvat += this.ds_tien_khoanmuc[i]['vat'] ? this.ds_tien_khoanmuc[i]['vat'] : 0
          }
        }
        //duongpd them tinh tien cho dich vu SLL
        if (this.listbox.loaihinh_tb.value == 215) {
          for (var item of this.gridEditors) {
            //TODO load gridEditors tu khoang dong 32516 voi su kien bam nut repositoryItemButtonEdit_ButtonClick
            if (item.ID == 'SOLUONG') {
              dtongtien = ((item.Value ? item.Value : '') ? 1 : item.Value * 1) * dtongtien
              dtongvat = ((item.Value ? item.Value : '') ? 1 : item.Value * 1) * dtongvat
              break
            }
          }
        }
        this.tongtienkm = dtongtien ? dtongtien : 0
        this.tongvatkm = dtongvat ? dtongvat : 0
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
        throw ex
      }
    },
    HienThiDanhSacHDTT(ds) {
      this.listbox.thanhtoan.list = ds
      for (var i = 0; i < this.listbox.thanhtoan.list.length; i++) this.listbox.thanhtoan.list[i].stt = i + 1
      this.buttons.tsbtnXoaTT = this.listbox.thanhtoan.list && this.listbox.thanhtoan.list.length > 0
      //THANGDM1 20211201 - Bo phan sau nay vi thay doi co che binding du lieu voi HTML Vue
      // this.lvwThanhToan = [];
      // if(ds.length>0) {
      //   for(var i=0;i<ds.length;i++) {
      //     var lvItem = [i+1];
      //     lvItem.push(ds[i]['hdtt_id']);
      //     lvItem.push(ds[i]['ma_tt']);
      //     lvItem.push(this.ChuanHoaTen(ds[i]['ten_tt']));
      //     lvItem.push(this.ChuanHoaTen(ds[i]['diachi_tt']));
      //     lvItem.push(this.ChuanHoaTen(ds[i]['diachi_ct']));
      //     this.lvwThanhToan.push(lvItem);
      //   }
      // }
      // console.log(this.lvwThanhToan,ds,this.listbox.thanhtoan.list);
      // if(this.lvwThanhToan.length>0) this.buttons.tsbtnXoaTT=true;
      // else this.buttons.tsbtnXoaTT = false;
    },
    async HienThiTTHopDongTT(ds) {
      if (ds.length > 0) {
        this.hdtt_id = ds[0]['hdtt_id']
        this.thanhtoan.matt = ds[0]['ma_tt']
        if (ds[0]['thanhtoan_id'] != '') this.thanhtoan.thanhtoan_id = ds[0]['thanhtoan_id']
        else this.thanhtoan.thanhtoan_id = 0

        this.thanhtoan.tentt = this.ChuanHoaTen(ds[0]['ten_tt'])
        this.diachiTT.DIACHI = ds[0]['diachi_tt']
        this.diachiBC.DIACHI = this.ChuanHoaTen(ds[0]['diachi_bc'])
        //HungHM-16/08/2010 - bổ xung thêm các column mới thêm vào bang hd_thanhtoan
        this.diachiCT.DIACHI = ds[0]['diachi_ct']

        this.thanhtoan.ghichu = ds[0]['ghichu']
        var dsDiaChiTT = []
        var DS_MA_DAIDIEN = []
        var MANVTC = ''
        var MA_TUYEN = ''
        var DS_DK_DVK = []
        await API.post_fn_lay_tt_hdtt(this.axios, { ds_para: JSON.stringify({ HDTT_ID: this.hdtt_id }) }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            var apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] == 1) {
              this.thanhtoan.hdmig_id = apidata['RESULT']['HDMIG_ID']
              this.thanhtoan.mainghep = apidata['RESULT']['MA_IG']
              dsDiaChiTT = this.LowerCasePropertyList(apidata['RESULT']['TT_DIACHIA_HDTT'])
              if (apidata['RESULT']['DS_MA_DAIDIEN'] && apidata['RESULT']['DS_MA_DAIDIEN'].length > 0) DS_MA_DAIDIEN = this.LowerCasePropertyList(apidata['RESULT']['DS_MA_DAIDIEN'])
              MANVTC = apidata['RESULT']['MANVTC']
              MA_TUYEN = apidata['RESULT']['MA_TUYEN']
              DS_DK_DVK = apidata['RESULT']['DS_DK_DVK']
            }
          }
        })
        if (!MA_TUYEN && ds[0]['ma_tuyen']) MA_TUYEN = ds[0]['ma_tuyen']
        if (!MANVTC && ds[0]['manv_tc']) MANVTC = ds[0]['manv_tc']

        if (!this.thanhtoan.hdmig_id || this.thanhtoan.hdmig_id == 0) {
          this.thanhtoan.hdmig_id = 0
          this.thanhtoan.mainghep = ''
        }

        this.nganhang.DV_QHNS = ds[0]['dv_qhns']
        this.nganhang.MACHUONG = ds[0]['machuong']
        this.nganhang.MN_KT = ds[0]['mn_kt']
        this.nganhang.MA_NDKT = ds[0]['ma_ndkt']
        this.nganhang.MN_NSNN = ds[0]['mn_nsnn']
        if (ds[0]['tien_dm']) this.nganhang.TIEN_DM = ds[0]['tien_dm']
        else this.nganhang.TIEN_DM = 0
        this.thanhtoan.masothue = ds[0]['mst']
        // if (ts_kt_mst_kh == 1)
        //     txtMST_TT2.Text = ds[0]["mst"];
        // else
        //     txtMST_TT.Text = ds[0]["mst"];
        this.listbox.nganhang.sotaikhoan = ds[0]['stk']
        this.thanhtoan.sodienthoai = ds[0]['so_dt']
        this.thanhtoan.email = ds[0]['email']
        this.thanhtoan.chutk = ds[0]['chu_tk']

        if (ds[0]['nganhang_id']) {
          this.listbox.nganhang.ischecked = true
          this.listbox.nganhang.value = ds[0]['nganhang_id']
        } else {
          this.listbox.nganhang.ischecked = false
        }

        this.HienThiTTDiaChi(dsDiaChiTT, 2) // LINE 13709
        if (DS_MA_DAIDIEN && DS_MA_DAIDIEN.length > 0) this.listbox.madaidien.list = DS_MA_DAIDIEN //Thay cho ca doan if else loang ngoang o day
        if (ds[0]['matb_dd']) this.listbox.madaidien.value = ds[0]['matb_dd']

        // if (ds[0]["nganhang_id"] != "")
        //     cboNganHang.EditValue = ds[0]["nganhang_id"];
        this.listbox.hinhthuc_tt.value = ds[0]['httt_id']
        if (ds[0]['httc_id']) this.listbox.hinhthuc_tc.value = ds[0]['httc_id']

        if (ds[0]['donvi_id']) this.listbox.donvi_ql.valueql = ds[0]['donvi_id']
        if (this.listbox.donvi_ql.valueql < 0) this.listbox.donvi_ql.valueql = 0

        if (ds[0]['nhanvien_id'] != '') {
          this.thanhtoan.nhanvientc_id = ds[0]['nhanvien_id']
          this.thanhtoan.manvtc = MANVTC
        } else {
          this.thanhtoan.nhanvientc_id = 0
          this.thanhtoan.manvtc = ''
        }

        if (ds[0]['tuyenthu_id'] != '') {
          this.thanhtoan.tuyenthu_id = ds[0]['tuyenthu_id']
          this.thanhtoan.matuyen = MA_TUYEN
        } else {
          this.thanhtoan.tuyenthu_id = 0
          this.thanhtoan.matuyen = ''
        }
        if (ds[0]['matb_dd']) this.listbox.madaidien.value = ds[0]['matb_dd']

        this.dsDK_DVK_TT = [...DS_DK_DVK] //Object.assign({}, DS_DK_DVK);
        this.HT_DichVuKhac(this.dsDK_DVK_TT, 2)

        this.HienThi_NVQL_AM_DB_HD(2, this.hdtt_id)
      }
    },
    HT_DichVuKhac(dset, vloaiid) {
      dset = this.LowerCasePropertyList(dset)
      if (vloaiid == 1) {
        this.lvDvkhac.list = dset
      } else {
        this.lvDvkhac_TT.list = dset
      }
    },
    HienThi_NVQL_AM_DB_HD(i_kieu, id) {
      API.post_sp_lay_nhanvien_ql(this.axios, { id: id, kieu: i_kieu }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          if (response.data.data.length <= 0) {
            this.thanhtoan.manvql = ''
            this.nhanvien_ql_am_id = 0
          } else {
            var nvql = response.data.data[0]
            this.thanhtoan.manvql = nvql['ma_nv'] + ' - ' + nvql['ten_nv']
            this.nhanvien_ql_am_id = nvql['nhanvien_id']
          }
        }
      })
    },
    Lay_DS_MucCuoc_TB(vkhuld_id, vapld_id, vphold_id, vphuongld_id, vloaitb_id, vdoituong_id, ngay) {
      this.tocdo_id = 0
      this.muccuoc_id = 0
      //this.listbox.muccuoc.value = 0;
      //var vmuccuoc_id = 0; //2 Lưu lượng // FIXME Thay bang listbox phia tren, can check lai!

      if (
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_SGTV ||
        this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES ||
        this.listbox.dichvu_vt.value == DichVuVienThong.HATANG_VIENTHONG ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_ANALOG ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL ||
        this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC
      ) {
        this.tocdo_id = this.listbox.cboGoiCuocAdsl.value
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL) this.muccuoc_id = this.listbox.muccuoc.value //vmuccuoc_id = Convert.ToInt32(cboMucCuoc.SelectedValue);
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT || this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT || this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU || this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH) {
        if (this.ItemList.length <= 0) {
          this.tocdo_id = -2
          this.muccuoc_id = -2
        } else {
          for (var index1 = 0; index1 < this.ItemList.length; ++index1) {
            if (this.ItemList[index1].sFieldName == 'TOCDO_ID') {
              if (this.ItemList[index1].sValue != '') {
                this.tocdo_id = this.ItemList[index1].sValue
                break
              }
            }
          }
        }
      }
      //TODO chua lam doan nay vi khong thuoc phan CODINH
      // DataSet ds = new DataSet();
      // int vtrangbi_id = 0;
      // if (cboLoaihinhTB.SelectedValue != null && cboLoaihinhTB.SelectedValue == LoaiHinhTB.INTERNET_MYTV
      //     && cboTrangBiADSL.Items.Count > 0)
      //     vtrangbi_id = Convert.ToInt32(cboTrangBiADSL.SelectedValue);
      // ds = tcdanhba.LAY_DS_MUCUOC_TB_V2(vkhuld_id, vapld_id, vphold_id, vphuongld_id, vloaitb_id, vdoituong_id, vtocdo_id, vmuccuoc_id, ngay, vtrangbi_id);
      // API.post_lay_ds_mucuoc_tb_v2(this.axios,pdata).then((response) => {
      //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //     this.listbox.muccuoc_tb.list = response.data.data;
      //   }
      // });
      // if (ds.Count > 0)
      // {
      //     cboMucCuocTB.DataSource = ds.Tables[0];
      //     cboMucCuocTB.ValueMember = "mucuoctb_id";
      //     cboMucCuocTB.DisplayMember = "tenmuccuoc";
      // }
      // else
      // {
      //     cboMucCuocTB.DataSource = null;
      //     txtCSD_FIBER_TK.Text = "0";
      // }
      this.LoadMucCuocTB()
    },
    async HT_DichVuGT() {
      var kt = true // Kiểm tra xem có đăng ký dịch vụ nào không, nếu không trả tiền dv, vatdv về 0
      this.dvgt.tien_dv = 0
      this.dvgt.vat_dv = 0
      this.dvgt.tien_km_dvgt = 0
      this.dvgt.vat_km_dvgt = 0
      var dTyLe_KM_DVGT = 0
      var dtien_kmdvgt_tmp = 0
      var dvat_kmdvgt_tmp = 0
      this.lvDvgt.list = []
      var str = ''
      for (var i = 0; i < this.m_dsThueBao_DichVu.length; i++) {
        if (this.m_dsThueBao_DichVu[i]['huy'] == '1' || this.m_dsThueBao_DichVu[i]['dangky'] == '1') {
          str = this.m_dsThueBao_DichVu[i]['ten_dvgt']
          if (this.m_dsThueBao_DichVu[i]['dangky'] == '1' && this.m_dsThueBao_DichVu[i]['huy'] == '0') {
            kt = false
            //Hiếu bổ sung code tính tiền dịch vụ
            if (this.m_dsThueBao_DichVu[i]['cuoc_ld'] != '') {
              this.dvgt.tien_dv = this.dvgt.tien_dv + this.m_dsThueBao_DichVu[i]['cuoc_ld']
            }
            if (this.m_dsThueBao_DichVu[i]['vat_ld'] != '') {
              this.dvgt.vat_dv = this.dvgt.vat_dv + this.m_dsThueBao_DichVu[i]['vat_ld']
            }

            str = str + ' (ĐK)'
            var dtTMP_KMDVGT = []
            await API.post_ctkm_dvgt(this.axios, { dschitietkm_id: this.ds_CTKM(), dichvugt_id: this.m_dsThueBao_DichVu[i]['dichvugt_id'] }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                dtTMP_KMDVGT = response.data.data
              }
            })
            if (dtTMP_KMDVGT.length > 0) {
              dTyLe_KM_DVGT = dtTMP_KMDVGT[0]['tyle_giamcuoc_ld']
            } // hoangpkn : 13/12/2018. Thêm đoạn else
            else {
              dtien_kmdvgt_tmp = 0
              dvat_kmdvgt_tmp = 0
              dTyLe_KM_DVGT = 0
            }

            if (dTyLe_KM_DVGT > 0) {
              dtien_kmdvgt_tmp = this.round((this.m_dsThueBao_DichVu[i]['cuoc_ld'] * dTyLe_KM_DVGT) / 100)
              dvat_kmdvgt_tmp = this.round((this.m_dsThueBao_DichVu[i]['vat_ld'] * dTyLe_KM_DVGT) / 100)
            }
            if (dtTMP_KMDVGT.length > 0) {
              this.m_dsThueBao_DichVu[i]['cuoc_kmld'] = dtien_kmdvgt_tmp
              this.m_dsThueBao_DichVu[i]['vat_kmld'] = dvat_kmdvgt_tmp
              this.dvgt.tien_km_dvgt += dtien_kmdvgt_tmp
              this.dvgt.vat_km_dvgt += dvat_kmdvgt_tmp
            }
          }
          if (this.m_dsThueBao_DichVu[i]['huy'] == '1') str = str + ' (Hủy)'
          this.lvDvgt.list.push(str)
        }
      }
      if (kt == true) {
        this.dvgt.tien_dv = 0
        this.dvgt.vat_dv = 0
      }
      this.HienThiTienDichVu(this.dvgt.tien_dv, this.dvgt.vat_dv)
      this.HienThiTienKhuyenMai_DVGT(this.dvgt.tien_km_dvgt, this.dvgt.vat_km_dvgt)
    },
    HienThiTienDichVu(tien_dv, vat_dv) {
      this.dichvu.dtien_dv = tien_dv
      this.dichvu.dvat_dv = vat_dv
      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DICHVU) {
          this.ds_tien_khoanmuc[j]['tien'] = tien_dv
          this.ds_tien_khoanmuc[j]['vat'] = vat_dv
        }
      }

      this.LayTongTien_HDTB()
    },
    HienThiTienKhuyenMai_DVGT(tien_kmdvgt, vat_kmdvgt) {
      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DVGT) {
          if (tien_kmdvgt > 0) {
            this.ds_tien_khoanmuc[j]['tien'] = tien_kmdvgt * -1
            this.ds_tien_khoanmuc[j]['vat'] = vat_kmdvgt * -1
          } else {
            this.ds_tien_khoanmuc[j]['tien'] = tien_kmdvgt
            this.ds_tien_khoanmuc[j]['vat'] = vat_kmdvgt
          }
        }
      }

      this.LayTongTien_HDTB()
    },
    ds_CTKM() {
      var sDS = '-1'
      for (var km of this.dsKM_HDTB) {
        if (km['chitietkm_id']) sDS = sDS + ',' + km['chitietkm_id']
      }
      for (var km of this.dsDC_HDTB) {
        if (km['chitietkm_id']) sDS = sDS + ',' + km['chitietkm_id']
      }
      return '' + sDS
    },
    async HienThiTTMoRong(hdtb_id, dichvuvt_id) {
      var ds = []
      var dt = []
      if (this.ma_tb_ht && !this.ma_tb) this.ma_tb = this.ma_tb_ht //chua biet tai sao khong co du lieu cho this.ma_tb -> kiem tra thay ma_tb_ht co du lieu can thiet -> gan tam o day!
      switch (dichvuvt_id * 1) {
        case DichVuVienThong.CO_DINH:
          if (this.ma_tb) this.thuebao.codinh.somay = this.ma_tb
          // Ham dung chugn -> bo ra ngoai switch case
          // await API.post_fn_hienthi_tt_morong(this.axios, { "ds_para": JSON.stringify({"HDTB_ID":hdtb_id,"DICHVUVT_ID":dichvuvt_id,"LOAITB_ID":0}) }).then((response) => {
          //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          //     var apidata = JSON.parse(response.data.data);
          //     if(apidata['RESULT']) apidata = apidata['RESULT'];
          //     if(apidata['DS_HDTB']) ds = apidata['DS_HDTB'];
          //     if(apidata['DS_TIEN_CAMKET']) dt = apidata['DS_TIEN_CAMKET'];
          //   }
          // });
          // ds = this.LowerCasePropertyList(ds);
          // dt = this.LowerCasePropertyList(dt);
          break
        case DichVuVienThong.MEGAWAN:
        case DichVuVienThong.METRONET:
        case DichVuVienThong.MGW_DOITAC:
        case DichVuVienThong.NOIBO_DADIEM:
          if (this.ma_tb) this.thuebao.mgwan.txtMaTBWan.Text = this.ma_tb
          break
        case DichVuVienThong.DI_DONG:
          this.thuebao.didong.txtSoMayDD = this.ma_tb
          //ds = tchopdong.LAY_DS_HDTB_DD_THEO_HDTB_ID(hdtb_id);
          break
        // case DichVuVienThong.DICHVU_CNTT:
        // case DichVuVienThong.HOINGHI_TRUYENHINH:
        // case DichVuVienThong.ANTOAN_BAOMAT_TT:
        // case DichVuVienThong.TRUNGTAM_DULIEU:
        //     ds = new DataSet();
        //     ds = tchopdong.LAY_DS_HDTB_CNTT_THEO_HDTB_ID(hdtb_id);
        //     dsHDTB_CT = new List<HD_THUEBAO_CT>();
        //     break;
        case DichVuVienThong.ADSL:
        case DichVuVienThong.HATANG_VIENTHONG:
        case DichVuVienThong.BRCD_DOITAC:
          this.thuebao.adsl.txtAccountADSL = this.ma_tb
          break
        case DichVuVienThong.MEGA_EYES:
          this.thuebao.adsl.txtAccountADSL = this.ma_tb
          break
        case DichVuVienThong.TSL:
        case DichVuVienThong.TSL_DOITAC:
        case DichVuVienThong.NOIBO_2DIEM:
          this.thuebao.tsl.txtMaTSL.Text = this.ma_tb
          break
        case DichVuVienThong.GPHONE:
          this.thuebao.gphone.txtSoMayGP = this.ma_tb
          break
        case DichVuVienThong.IMS:
        case DichVuVienThong.IMS_DOITAC:
          this.thuebao.ims.txtMaTBIMS = this.ma_tb
          break
        default:
          break
      }
      var apidata = {}
      await API.post_fn_hienthi_tt_morong(this.axios, { ds_para: JSON.stringify({ HDTB_ID: hdtb_id, DICHVUVT_ID: dichvuvt_id, LOAITB_ID: this.listbox.loaihinh_tb.value, BANCHEO: 1 }) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          apidata = JSON.parse(response.data.data)
          if (apidata['RESULT']) apidata = apidata['RESULT']
          if (apidata['DS_HDTB']) ds = apidata['DS_HDTB']
          if (apidata['DS_TIEN_CAMKET']) dt = apidata['DS_TIEN_CAMKET']
        }
      })
      ds = this.LowerCasePropertyList(ds)
      dt = this.LowerCasePropertyList(dt)
      if (ds.length > 0) {
        this.ma_tb_ao = ''
        this.thuebao.cvlct = false
        this.thuebao.congvan = ''
        this.thuebao.NgayCV = moment(new Date()).format('DD/MM/YYYY')
        this.thuebao.crm = ''
        this.thuebao.erp = ''
        this.thuebao.vtn = ''
        if (ds[0]['ma_vnpt']) this.ma_vnpt = ds['ma_vnpt']
        else this.ma_vnpt = -1

        switch (dichvuvt_id * 1) {
          case DichVuVienThong.CO_DINH:
            this.chkVSVX = ds[0]['mc_tbcd_id'] == '1'
            this.chkMienCuocTB = ds[0]['miencuoc_tb'] == '1'
            this.thuebaocd.madoicap = ds[0]['madoicap']
            this.thuebaocd.matn = ds[0]['matb_tn']
            if (ds[0]['sotruot']) {
              this.thuebaocd.kieu_thueso = THUESO.TRUOTSO
              this.thuebaocd.sothang_thueso = ds[0]['tg_thueso']
              this.thuebaocd.noidung_thueso = ds[0]['sotruot']
            }
            if (ds[0]['noidung_tb'] != '') {
              this.thuebaocd.kieu_thueso = THUESO.THONGBAO
              this.thuebaocd.sothang_thueso = ds[0]['tg_thueso']
              this.thuebaocd.noidung_thueso = ds[0]['noidung_tb']
            }
            if (ds[0]['sotruot'] == '' && ds[0]['noidung_tb'] == '') {
              this.thuebaocd.kieu_thueso = 0
              this.thuebaocd.sothang_thueso = 0
              this.thuebaocd.noidung_thueso = ''
            }

            if (ds[0]['doitac_id']) {
              this.listbox.doitac.ischeckedcd = true
              this.listbox.doitac.valuecd = ds[0]['doitac_id']
              this.thuebaocd.cuocdoitac = ds[0]['cuoc_doitac']
            } else {
              this.listbox.doitac.ischeckedcd = false
              this.thuebaocd.cuocdoitac = '0'
            }

            if (ds[0]['congnghe_id']) this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = 0

            if (ds[0]['trangbi_id']) this.listbox.trangbi.valuecd = ds[0]['trangbi_id']
            if (ds[0]['chuquan_id']) this.listbox.chu_quan.valuecd = ds[0]['chuquan_id']
            if (ds[0]['chuquanld_id']) this.listbox.chu_quan.valueldcd = ds[0]['chuquanld_id']
            this.thuebao.codinh.dgvTienCK.list = [];
            this.thuebao.codinh.dgvTienCK.list = dt
            break
          case DichVuVienThong.IMS:
            this.thuebao.ims.txtMaTN_IMS = ds[0]['matb_tn']
            this.thuebao.ims.txtMaDoiCap_IMS = ds[0]['madoicap']
            if (ds[0]['chuquan_id']) this.listbox.chu_quan.valueims = ds[0]['chuquan_id']
            if (ds[0]['chuquanld_id']) this.listbox.chu_quan.valueldims = ds[0]['chuquanld_id']
            if (ds[0]['trangbi_id']) this.listbox.trangbi.valueims = ds[0]['trangbi_id']

            if (ds[0]['doitac_id']) {
              this.thuebao.ims.chkDoiTac_IMS = true
              this.thuebao.ims.cboDoiTac_IMS.value = ds[0]['doitac_id']
              this.thuebao.ims.txtCuocDT_IMS = ds[0]['cuoc_doitac']
            } else {
              this.thuebao.ims.chkDoiTac_IMS = false
              this.thuebao.ims.txtCuocDT_IMS = 0
            }

            if (ds[0]['congnghe_id']) this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = -1

            this.thuebao.ims.txtCuocGoiDT = ds[0]['sl_cuocgoi']
            if (ds[0]['ctdv_id']) this.listbox.ht_chitietdv_ims.value = ds[0]['ctdv_id']
            this.thuebao.ims.txtIp_IMS = ds[0]['ip']

            this.thuebao.ims.pass_ims = ds[0]['password']
            this.thuebao.ims.dgvTienCKIMS.list = [];
            this.thuebao.ims.dgvTienCKIMS.list = dt
            break

          case DichVuVienThong.MEGAWAN:
          case DichVuVienThong.METRONET:
          case DichVuVienThong.MGW_DOITAC:
          case DichVuVienThong.NOIBO_DADIEM:
            this.listbox.tocdokenh.valuecir = ds[0]['tocdo_id']
            if (ds[0]['tocdo_pir_id']) {
              this.listbox.tocdokenh.ischeckedpir = true
              this.listbox.tocdokenh.valuepir = ds[0]['tocdo_pir_id']
            } else {
              this.listbox.tocdokenh.ischeckedpir = false
              this.listbox.tocdokenh.valuepir = ds[0]['tocdo_id']
            }

            if (ds[0]['congnghe_id']) this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = -1

            if (ds[0]['phanloai_id']) this.listbox.phanloai_dv.value = ds[0]['phanloai_id']
            else this.listbox.phanloai_dv.value = 0

            if (ds[0]['phantach_td']) this.listbox.ht_phantach_tocdo.value = ds[0]['phantach_td']
            else
              try {
                this.listbox.ht_phantach_tocdo.value = this.listbox.ht_phantach_tocdo.list[0].phantach_id
              } catch (ex) {
                this.listbox.ht_phantach_tocdo.value = 0
              }

            if (ds[0]['tinh_kn_id']) this.listbox.tinh_kn.value = ds[0]['tinh_kn_id']
            else this.listbox.tinh_kn.value = 0

            this.thuebao.cvlct = true
            if (ds[0]['ma_cv']) {
              this.thuebao.cvlct = true
              this.thuebao.congvan = ds[0]['ma_cv']
              this.NgayCV = ds[0]['ngay_cv']
            }

            this.thuebao.crm = ds[0]['MA_CRM']
            this.thuebao.erp = ds[0]['ID_ERP']
            this.thuebao.vtn = ds[0]['MAKENH_VTN']

            this.thuebao.mgwan.lanip = ds[0]['lan_ip']
            this.thuebao.mgwan.wanip = ds[0]['wan_ip']
            this.thuebao.mgwan.vrfvfi = ds[0]['vrf']

            this.listbox.loaimodem.value = ds[0]['loaimd_id']
            this.listbox.loaikenh.value = ds[0]['loaikenh_id']
            this.listbox.loai_tb.valuemgwan = ds[0]['thietbidc_id']
            this.loaisowan = ds[0]['loainode_id']
            this.buttons.btnHuongKNWan = this.loaisowan * 1 == LOAINODE_MGWAN.NODE_CHINH
            this.diachiKN.DIACHI = ds[0]['diachi_kn']
            this.thuebao.mgwan.huongkn = ds[0]['huong_kn']
            this.thuebao.mgwan.vhuongkn = ds[0]['huong_kn']
            //HungHM - 07/09/2010
            this.listbox.thoihan.valuewan = ds[0]['thoihan_id']
            this.listbox.trangbi.valuewan = ds[0]['trangbi_id']
            this.listbox.chu_quan.valuewan = ds[0]['chuquan_id']
            if (ds[0]['chuquanld_id']) this.listbox.chu_quan.valueldmgwan = ds[0]['chuquanld_id']

            this.thuebao.mgwan.madoicap = ds[0]['madoicap']
            this.thuebao.mgwan.soao = ds[0]['ma_lt']
            this.ma_tb_ao = ds[0]['ma_lt']
            this.thuebao.mgwan.txtMaHD_TTKD_MGWAN = ds[0]['ma_pl']
            this.thuebao.mgwan.siteid = ds[0]['site_id']
            this.listbox.loaicap.value = ds[0]['loaicap_id']
            if (ds[0]['giukenh']) {
              this.thuebao.mgwan.luonggiukenh = ds[0]['giukenh'] == '1'
            }
            if (ds[0]['doitac_id']) {
              this.listbox.doitacwan.isenabled = true
              this.listbox.doitacwan.value = ds[0]['doitac_id']
              this.thuebao.mgwan.cuoctk_dt = ds[0]['cuoc_tkdt'] ? ds[0]['cuoc_tkdt'] : 0
              this.thuebao.mgwan.cuoctc_dt = ds[0]['cuoc_tcdt'] ? ds[0]['cuoc_tcdt'] : 0
              this.thuebao.mgwan.hopdong_dt = ds[0]['mahd_dt']
            } else {
              this.listbox.doitacwan.isenabled = false
              this.thuebao.mgwan.cuoctk_dt = 0
              this.thuebao.mgwan.cuoctc_dt = 0
              this.thuebao.mgwan.hopdong_dt = ''
            }

            this.thuebao.mgwan.matn = ds[0]['matb_tn']
            this.thuebao.mgwan.cuoctc = ds[0]['cuoc_tc'] ? ds[0]['cuoc_tc'] : 0
            this.thuebao.mgwan.cuoctk = ds[0]['cuoc_tk'] ? ds[0]['cuoc_tk'] : 0
            this.thuebao.mgwan.cuoctbi = ds[0]['cuoc_tbi'] ? ds[0]['cuoc_tbi'] : 0
            this.thuebao.mgwan.cuocht = ds[0]['cuoc_ht'] ? ds[0]['cuoc_ht'] : 0

            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MGW_INTERNET_TRUCTIEP || this.listbox.loaihinh_tb.value == LoaiHinhTB.NB_INTERNETTT) {
              if (ds[0]['tocdo_nix']) {
                this.listbox.tocdokenh.ischeckednix = true
                this.listbox.tocdokenh.valuenix = ds[0]['tocdo_nix']
              } else {
                this.listbox.tocdokenh.ischeckednix = false
                this.listbox.tocdokenh.valuenix = 0
              }

              if (ds[0]['tocdo_isp']) {
                this.listbox.tocdokenh.ischeckedisp = true
                this.listbox.tocdokenh.valueisp = ds[0]['tocdo_isp']
              } else {
                this.listbox.tocdokenh.ischeckedisp = false
                this.listbox.tocdokenh.valueisp = 0
              }

              if (ds[0]['sl_ip']) this.thuebao.mgwan.soluongip = ds[0]['sl_ip']
              else this.thuebao.mgwan.soluongip = 0

              if (ds[0]['cuoc_ip']) this.thuebao.mgwan.cuocip = ds[0]['cuoc_ip']
              else this.thuebao.mgwan.cuocip = 0

              if (ds[0]['cuoc_nix']) this.thuebao.mgwan.cuocnix = ds[0]['cuoc_nix']
              else this.thuebao.mgwan.cuocnix = 0

              if (ds[0]['cuoc_isp']) this.thuebao.mgwan.cuocisp = ds[0]['cuoc_isp']
              else this.thuebao.mgwan.cuocisp = 0
            } else {
              this.thuebao.mgwan.soluongip = 0
              this.thuebao.mgwan.cuocip = 0
              this.thuebao.mgwan.cuocnix = 0
              this.thuebao.mgwan.cuocisp = 0
              this.listbox.tocdokenh.valueisp = 0
              this.listbox.tocdokenh.valuenix = 0
            }
            break
          case DichVuVienThong.ADSL:
          case DichVuVienThong.HATANG_VIENTHONG:
          case DichVuVienThong.BRCD_DOITAC:
            this.thuebao.adsl.txtEmailAdsl = ds[0]['email']
            this.thuebao.adsl.txtSL_Tivi = ds[0]['sltv_htvc']
            this.thuebao.adsl.txtDienThoai_Fsecure = ds[0]['so_dt'] // số điện thoại Fsecure

            if (ds[0]['congnghe_id']) this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = 0

            if (ds[0]['kh_cd'] == '1') this.thuebao.adsl.ckTuCaiADSL = true
            else this.thuebao.adsl.ckTuCaiADSL = false

            if (ds[0]['chuquan_id']) this.listbox.chu_quan.valueadsl = ds[0]['chuquan_id']

            if (ds[0]['chuquanld_id']) this.listbox.chu_quan.valueldadsl = ds[0]['chuquanld_id']

            if (ds[0]['doitac_id'] && ds[0]['doitac_id'] != '') {
              this.listbox.doitac.ischeckedadsl = true
              this.listbox.doitac.valueinternet = ds[0]['doitac_id']
              this.thuebao.adsl.txtCuocDT_Internet = ds[0]['cuoc_doitac']
            } else {
              this.listbox.doitac.ischeckedadsl = false
              this.thuebao.adsl.txtCuocDT_Internet = 0
            }

            this.tocdo_id = ds[0]['tocdo_id']
            this.listbox.cboGoiCuocAdsl.value = ds[0]['tocdo_id']
            //Cuong moi them
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
              this.listbox.cboLoaiIP.values = apidata['DS_LOAIIP'] // xu ly het doan code ben duoi
              if (this.listbox.cboLoaiIP.values && this.listbox.cboLoaiIP.values.length > 0) {
                this.listbox.cboLoaiIP.value = this.listbox.cboLoaiIP.values[0]
                this.listbox.cboLoaiIP.valueitems = []
                for (var item of this.listbox.cboLoaiIP.values) {
                  var item1 = this.listbox.cboLoaiIP.list.find((x) => x.loaiip_id == item.LOAIIP_ID)
                  if (item1 && item1.loaiip_id && item1.loaiip_id > 0) this.listbox.cboLoaiIP.valueitems.push(item1)
                }
                this.listbox.cboLoaiIP.valueitems = this.listbox.cboLoaiIP.valueitems.map((lo) => ({ id: lo.loaiip_id, text: lo.loai_ip }))
                this.listbox.cboLoaiIP.values = this.listbox.cboLoaiIP.valueitems.map((x) => x.id)
              }
              // if (this.listbox.cboLoaiIP.list && this.listbox.cboLoaiIP.list.length > 0)
              // {
              //     var ds_lip = laphd2.GET_DATA_PROC("{?DB2}.lay_ds_loaiip_theo_hdtb_id", "in_hdtb_id", hdtb_id);
              //     if (ds_lip != null && ds_lip.Rows.Count > 0)
              //     {
              //         ds_lip.AcceptChanges();
              //         for (int i = 0; i < cboLoaiIP.Properties.Items.Count; i++)
              //         {
              //             if (ds_lip.Select("LOAIIP_ID=" + cboLoaiIP.Properties.Items[i].Value + "").Length > 0)
              //             {
              //                 cboLoaiIP.Properties.Items[i].CheckState = CheckState.Checked;
              //             }
              //             else
              //                 cboLoaiIP.Properties.Items[i].CheckState = CheckState.Unchecked;
              //         }
              //     }
              // }
            }

            this.listbox.cboTocDoThucADSL.value = -1
            if (ds[0]['tocdothuc_id']) this.listbox.cboTocDoThucADSL.value = ds[0]['tocdothuc_id']
            else this.listbox.cboTocDoThucADSL.value = -1

            if (this.listbox.cboTocDoThucADSL.value != null && this.listbox.cboGoiCuocAdsl.value != this.listbox.cboTocDoThucADSL.value) this.thuebao.adsl.chkTocDoThuc = true

            this.listbox.muccuoc.value = ds[0]['muccuoc_id']
            if (ds[0]['thietbidc_id']) this.listbox.cboLoaiTB.value = ds[0]['thietbidc_id']
            this.thuebao.adsl.txtMaDoiCap_ADSL = ds[0]['madoicap']
            this.thuebao.adsl.txtMaTN_ADSL = ds[0]['matb_tn']
            this.thuebao.adsl.txtSoAoAdsl = ds[0]['ma_lt']
            this.ma_tb_ao = ds[0]['ma_lt']
            //this.ma_tb_ao_ht = ds[0]["ma_lt"]; // FIXME Can xem lai cho nay vi ma_lt o ham ghi lai dung ma_tb_ao_ht, khong phai ma_tb_ao
            this.listbox.cboKieuTra.value = ds[0]['kieutra_id']
            if (ds[0]['kieutra_id'] == 1) this.listbox.cboThangTra.value = ds[0]['thang_id']

            if (ds[0]['trangbi_id']) this.listbox.trangbi.valueadsl = ds[0]['trangbi_id']
            this.thuebao.adsl.txtTTCuoc = ds[0]['thongtin_tc']
            this.thuebao.adsl.pass_adsl = ds[0]['password']

            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC) {
              if (ds[0]['cuoc_sd']) this.thuebao.adsl.txtCSD_FIBER_TK = ds[0]['cuoc_sd']
              else this.thuebao.adsl.txtCSD_FIBER_TK = 0

              if (ds[0]['cuoc_tbi']) this.thuebao.adsl.txtCTB_FIBER_TK = ds[0]['cuoc_tbi']
              else this.thuebao.adsl.txtCTB_FIBER_TK = 0
            } else {
              this.thuebao.adsl.txtCSD_FIBER_TK = 0
              this.thuebao.adsl.txtCTB_FIBER_TK = 0
            }

            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.COSO_HATANG) {
              if (ds[0]['doitac_id']) this.listbox.cboDoiTac_CSHT.value = ds[0]['doitac_id']

              if (ds[0]['loai_csht_id']) this.listbox.cboLoai_CSHT.value = ds[0]['loai_csht_id']
            }
            this.thuebao.adsl.txtSerialSTB = ds[0]['serial_stb']
            break
          case DichVuVienThong.MEGA_EYES:
            //txtMaTN_ADSL.Text = ds[0]["so_dt"].ToString();
            this.thuebao.adsl.txtEmailAdsl = ds[0]['email']
            if (ds[0]['kh_cd'] == 1) this.thuebao.adsl.ckTuCaiADSL = true
            else this.thuebao.adsl.ckTuCaiADSL = false

            if (ds[0]['congnghe_id']) this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = -1

            this.tocdo_id = ds[0]['tocdo_id']
            this.listbox.cboGoiCuocAdsl.value = ds[0]['tocdo_id']
            this.listbox.muccuoc.value = ds[0]['muccuoc_id']
            this.listbox.cboLoaiTB.value = ds[0]['thietbidc_id']
            this.thuebao.adsl.txtMaDoiCap_ADSL = ds[0]['madoicap']
            this.thuebao.adsl.txtMaTN_ADSL = ds[0]['matb_tn']
            this.thuebao.adsl.txtSoAoAdsl = ds[0]['ma_lt']
            this.ma_tb_ao = ds[0]['ma_lt']
            this.listbox.cboKieuTra.value = ds[0]['kieutra_id']
            if (ds[0]['kieutra_id'] == 1) this.listbox.cboThangTra.value = ds[0]['thang_id']

            if (ds[0]['trangbi_id']) this.listbox.trangbi.valueadsl = ds[0]['trangbi_id']

            this.thuebao.adsl.txtTTCuoc = ds[0]['thongtin_tc']
            this.thuebao.adsl.pass_adsl = ds[0]['password']
            break
          case DichVuVienThong.TSL:
          case DichVuVienThong.TSL_DOITAC:
          case DichVuVienThong.NOIBO_2DIEM:
            this.listbox.tocdokenh.valuetsl = ds[0]['tocdo_id']
            this.listbox.loaikenh.valuetsl = ds[0]['loaikenh_id']
            this.listbox.thoihan.valuetsl = ds[0]['thoihan_id']
            this.listbox.trangbi.valuetsl = ds[0]['trangbi_id']
            this.listbox.chu_quan.valuetsl = ds[0]['chuquan_id']
            this.thuebao.tsl.txtMaHD_TTKD_TSL = ds[0]['ma_pl']
            this.thuebao.tsl.txtSoSoiQuang = ds[0]['sl_soiquang']

            if (ds[0]['congnghe_id']) this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = -1

            if (ds[0]['doitac_id']) {
              this.listbox.doitactsl.chkDoiTacTSL = true
              this.listbox.doitactsl.value = ds[0]['doitac_id']
              this.thuebao.tsl.txtCuocTKDT_TSL = ds[0]['cuoc_tkdt'] ? ds[0]['cuoc_tkdt'] : 0
              this.thuebao.tsl.txtCuocTCDT_TSL = ds[0]['cuoc_tcdt'] ? ds[0]['cuoc_tcdt'] : 0
              this.thuebao.tsl.txtMaHD_DT_TSL = ds[0]['mahd_dt']
            } else {
              this.listbox.doitactsl.chkDoiTacTSL = false
              this.thuebao.tsl.txtCuocTKDT_TSL = 0
              this.thuebao.tsl.txtCuocTCDT_TSL = 0
              this.thuebao.tsl.txtMaHD_DT_TSL = ''
            }
            this.thuebao.cvlct = true //chkCongVan.Enabled = true;
            if (ds[0]['ma_cv']) {
              this.thuebao.cvlct = true
              this.thuebao.congvan = ds[0]['ma_cv'] //txtCongVan.Text = ds[0]["ma_cv"];
              this.thuebao.NgayCV = ds[0]['ngay_cv'] //dtpNgayCV.Value = ds[0]["ngay_cv"];
            }

            this.thuebao.crm = ds[0]['MA_CRM']
            this.thuebao.erp = ds[0]['ID_ERP']
            this.thuebao.vtn = ds[0]['MAKENH_VTN']

            this.thuebao.tsl.txtCuocTC_TSL = ds[0]['cuoc_tc']
            this.thuebao.tsl.txtCuocTK_TSL = ds[0]['cuoc_tk']
            this.thuebao.tsl.txtCuocTBI_TSL = ds[0]['cuoc_tbi']
            this.thuebao.tsl.txtCuocHT_TSL = ds[0]['cuoc_ht']

            for (var i = 0; i < ds.length; i++) {
              if (ds[i]['daucuoi_id'] == 1) {
                //Nếu là điểm đầu
                this.diachiDau.DIACHI_ID = ds[i]['diachi_id']
                if (ds[i]['kinhdo_ld']) this.diachiDau.Lng = ds[i]['kinhdo_ld']
                //Lng_DD
                else this.diachiDau.Lng = 0

                if (ds[i]['vido_ld']) this.diachiDau.Lat = ds[i]['vido_ld']
                //Lat_DD
                else this.diachiDau.Lat = 0
                this.thuebao.tsl.cboChuQuanLD_Dau.value = ds[i]['chuquanld_id']
                this.thuebao.tsl.txtSoAoTSL_Dau = ds[i]['ma_lt']
                this.ma_tb_ao = ds[i]['ma_lt']
                this.ma_tb_ao_ht = this.ma_tb_ao // Them cho chac, sau nay bo cai ma_tb_ao vi ma_tb_ao doi voi TSL luon gan = ma_tb_ao_ht
                this.listbox.loai_tb.valuedau = ds[i]['thietbidc_id']
                this.listbox.loaicap.valuedau = ds[i]['loaicap_id']
                this.thuebao.tsl.txtSiteIDTSL_Dau = ds[i]['site_id']
                this.thuebao.tsl.txtVrf_Dau = ds[i]['vrf']
              } else {
                this.diachiCuoi.DIACHI_ID = ds[i]['diachi_id']

                if (ds[i]['kinhdo_ld']) this.diachiCuoi.Lng = ds[i]['kinhdo_ld']
                //Lng_DC
                else this.diachiCuoi.Lng = 0

                if (ds[i]['vido_ld']) this.diachiCuoi.Lat = ds[i]['vido_ld']
                //Lat_DC
                else this.diachiCuoi.Lat = 0
                this.thuebao.tsl.cboChuQuanLD_Cuoi.value = ds[i]['chuquanld_id']
                this.thuebao.tsl.txtSoAoTSL_Cuoi = ds[i]['ma_lt']
                this.ma_tb_ao_ht_cuoi = ds[i]['ma_lt'] //ma_tb_ao_cuoi luon = ma_tb_ao_ht_cuoi nen thay the luon, khong dung bien kia nua
                this.listbox.loai_tb.valuecuoi = ds[i]['thietbidc_id']
                this.listbox.loaicap.valuecuoi = ds[i]['loaicap_id']
                this.thuebao.tsl.txtSiteIDTSL_Cuoi = ds[i]['site_id']
                this.thuebao.tsl.txtVrf_Cuoi = ds[i]['vrf']
              }
            }
            this.HienThiTTDiaChi_TSL()
            for (var i = 0; i < ds.length; i++) {
              if (ds[i]['daucuoi_id'] == 1) {
                //Nếu là điểm đầu
                this.listbox.donvi_dau.value = apidata['DONVI_DAU_ID'] //donvi_dau_id = Convert.ToInt32(objCheckData.MAP_ID("donvi_dau_id", DatabaseConstants.DB2 + ".hd_thuebao", "where hdtb_id = " + hdtb_id));
                this.diachiDau.DIACHI = ds[i]['diachi'] //txtDiaChiDau.Text = CommonFunction.ChuanHoaTen(ds[i]["diachi"].ToString());

                // Da xu ly o 2 dong tren, gan thang gia tri combobox
                //bangts.HT_DVi_loaidv_Combobox1(cboVetinhTSL_Dau, donvi_dau_id, LOAI_DV.TRAM_VT);
                // string str = "select * from " + DatabaseConstants.DB2 + ".hdtb_dv where hdtb_id = " + hdtb_id + " and loaidv_id = " + LOAI_DV.TRAM_VT + " and kieudv_id = 1";
                // DataTable dtTemp = bangts.GetDataSql(str);
                // if (dtTemp.Rows.Count > 0)
                //     cboVetinhTSL_Dau.SelectedValue = dtTemp.Rows[0]["donvi_id"].ToString();
              } else {
                this.listbox.donvi_cuoi.value = apidata['DONVI_CUOI_ID'] //donvi_cuoi_id = Convert.ToInt32(objCheckData.MAP_ID("donvi_cuoi_id", DatabaseConstants.DB2 + ".hd_thuebao", "where hdtb_id = " + hdtb_id));
                this.diachiCuoi.DIACHI = ds[i]['diachi'] //txtDiaChiCuoi.Text = CommonFunction.ChuanHoaTen(ds[i]["diachi"].ToString());
                // Da xu ly o 2 dong tren, gan thang gia tri combobox
                // bangts.HT_DVi_loaidv_Combobox1(cboVetinhTSL_Cuoi, donvi_cuoi_id, LOAI_DV.TRAM_VT);

                // string str = "select * from " + DatabaseConstants.DB2 + ".hdtb_dv where hdtb_id = " + hdtb_id + " and loaidv_id = " + LOAI_DV.TRAM_VT + " and kieudv_id = 2";
                // DataTable dtTemp = bangts.GetDataSql(str);
                // if (dtTemp.Rows.Count > 0)
                //     cboVetinhTSL_Cuoi.SelectedValue = dtTemp.Rows[0]["donvi_id"].ToString();
              }
            }
            break
          case DichVuVienThong.GPHONE:
            this.thuebao.gphone.txtSoSimGphone = ds[0]['simcard']
            this.thuebao.gphone.checkVSVX = ds[0]['mc_tbgp_id'] == '1'
            if (ds[0]['trangbi_id']) this.listbox.trangbi.valuegp = ds[0]['trangbi_id']
            if (ds[0]['chuquan_id']) this.listbox.chu_quan.valuegp = ds[0]['chuquan_id']

            if (ds[i]['congnghe_id'] != '') this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = -1
            this.thuebao.gphone.dgvTienCKGP.list = [];
            this.thuebao.gphone.dgvTienCKGP.list = dt
            break

          case DichVuVienThong.ANTOAN_BAOMAT_TT:
          case DichVuVienThong.HOINGHI_TRUYENHINH:
          case DichVuVienThong.DICHVU_CNTT:
          case DichVuVienThong.TRUNGTAM_DULIEU:
            await this.LoadThongTin_DV_CNTT(this.listbox.loaihinh_tb.value);
            this.thongso_ban.thongso_cntt = this.ItemList;

            var datas = await API.post_lay_ds_hdtb_cntt_theo_hdtb_id_bc(this.axios,{vhdtb_id:hdtb_id, vkieu:1}).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000')
                return response.data.data
              else return [];
            }).catch((ex)=>{ return []; });//bancheo.GET_DATA_OBJECT_PL("{?DB2}.LAY_DS_HDTB_CNTT_THEO_HDTB_ID_BC", "returnds", "vhdtb_id", hdtb_id, "vkieu", 1);
            var ItemList_dv = [];
            ItemList_dv = await this.Init_Properties(this.listbox.loaihinh_tb.value, "HDTB_CNTT", "00000", ItemList_dv);
            if(datas && datas.length>0)
            for (var index = 0; index < ItemList_dv.length; index++)
            {
                ItemList_dv[index].sValue = datas[0][this.ItemList[index].sFieldName.toLowerCase()] ? datas[0][this.ItemList[index].sFieldName.toLowerCase()] : datas[0][this.ItemList[index].sFieldName];//datas.Rows[0][ItemList_dv[index].sFieldName].ToString();
            }
            this.thongso_tc.thongso_cntt = ItemList_dv;
            this.dt_ban_cntt = ds;
            this.dt_tc_cntt = datas;
            break;
        }
      }

      this.asyncLock = false;
    },
    HienThiTTDiaChi_TSL() {
      //{"DIACHI_DAU_ID":1,"DIACHI_CUOI_ID":4}
      API.post_fn_hienthi_tt_diachi_tsl(this.axios, { ds_para: JSON.stringify({ DIACHI_DAU_ID: this.diachiDau.DIACHI_ID, DIACHI_CUOI_ID: this.diachiCuoi.DIACHI_ID, BANCHEO: 1 }) }).then(async (response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          var apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            this.$toast.error(apidata['MESSAGE'])
            return
          }
          if (apidata['RESULT']) apidata = apidata['RESULT']
          var ds = apidata['DS_DIACHI_DAU']
          if (ds.length > 0) {
            this.diachiDau.TINH_ID = ds[0]['tinh_id'.toUpperCase()]
            this.thuebao.tsl.cboTinhDau.value = this.diachiDau.TINH_ID
            this.diachiDau.QUAN_ID = ds[0]['quan_id'.toUpperCase()]
            this.diachiDau.PHUONG_ID = ds[0]['phuong_id'.toUpperCase()]

            if (ds[0]['pho_id'.toUpperCase()]) this.diachiDau.PHO_ID = ds[0]['pho_id'.toUpperCase()]
            else this.diachiDau.PHO_ID = 0
            if (ds[0]['ap_id'.toUpperCase()]) this.diachiDau.AP_ID = ds[0]['ap_id'.toUpperCase()]
            else this.diachiDau.AP_ID = 0
            if (ds[0]['khu_id'.toUpperCase()]) this.diachiDau.KHU_ID = ds[0]['khu_id'.toUpperCase()]
            else this.diachiDau.KHU_ID = 0
            this.diachiDau.SONHA = ds[0]['sonha'.toUpperCase()]

            if (ds[0]['block'.toUpperCase()]) this.diachiDau.BLOCK = ds[0]['block'.toUpperCase()]
            if (ds[0]['tang'.toUpperCase()]) this.diachiDau.TANG = ds[0]['tang'.toUpperCase()]
            if (ds[0]['phong'.toUpperCase()]) this.diachiDau.PHONG = ds[0]['phong'.toUpperCase()]
            if (ds[0]['mota'.toUpperCase()]) this.diachiDau.MOTA = ds[0]['mota'.toUpperCase()]

            var ds = await bancheo.LAY_DS_DONVIQL({ tinhthicong_id: this.diachiDau.TINH_ID }, this.diachiDau.PHUONG_ID, this.diachiDau.PHO_ID, this.diachiDau.AP_ID, this.diachiDau.KHU_ID, 2)
            this.listbox.donvi_dau.list = ds && ds.length > 0 ? JSON.parse(JSON.stringify(ds)) : []
            this.LoadDonViDauCuoiCombobox(1)
            // LoadDonViDauCuoiCombobox
          }
          ds = apidata['DS_DIACHI_CUOI']
          if (ds.length > 0) {
            this.diachiCuoi.TINH_ID = ds[0]['tinh_id'.toUpperCase()]
            this.thuebao.tsl.cboTinhCuoi.value = this.diachiCuoi.TINH_ID
            this.diachiCuoi.QUAN_ID = ds[0]['quan_id'.toUpperCase()]
            this.diachiCuoi.PHUONG_ID = ds[0]['phuong_id'.toUpperCase()]

            if (ds[0]['pho_id'.toUpperCase()]) this.diachiCuoi.PHO_ID = ds[0]['pho_id'.toUpperCase()]
            else this.diachiCuoi.PHO_ID = 0
            if (ds[0]['ap_id'.toUpperCase()]) this.diachiCuoi.AP_ID = ds[0]['ap_id'.toUpperCase()]
            else this.diachiCuoi.AP_ID = 0
            this.diachiCuoi.SONHA = ds[0]['sonha'.toUpperCase()]

            if (ds[0]['block'.toUpperCase()]) this.diachiCuoi.BLOCK = ds[0]['block'.toUpperCase()]
            if (ds[0]['tang'.toUpperCase()]) this.diachiCuoi.TANG = ds[0]['tang'.toUpperCase()]
            if (ds[0]['phong'.toUpperCase()]) this.diachiCuoi.PHONG = ds[0]['phong'.toUpperCase()]
            if (ds[0]['mota'.toUpperCase()]) this.diachiCuoi.MOTA = ds[0]['mota'.toUpperCase()]

            var ds = await bancheo.LAY_DS_DONVIQL({ tinhthicong_id: this.diachiCuoi.TINH_ID }, this.diachiCuoi.PHUONG_ID, this.diachiCuoi.PHO_ID, this.diachiCuoi.AP_ID, this.diachiCuoi.KHU_ID, 2)
            this.listbox.donvi_cuoi.list = ds && ds.length > 0 ? JSON.parse(JSON.stringify(ds)) : []
            this.LoadDonViDauCuoiCombobox(2)
          }
        }
      })
    },
    HT_DS_KhuyenMai_Combobox() {
      var itocdo_id = 0
      var itrangbi_id = 3
      if (this.listbox.kieu_ld.list.length <= 0) return
      if (!this.listbox.doituong.value || this.listbox.doituong.value == 0) return
      if (this.listbox.trangbi.list.length <= 0) return
      switch (this.listbox.dichvu_vt.value * 1) {
        case DichVuVienThong.CO_DINH:
          itocdo_id = 0

          if (this.listbox.trangbi.list.length <= 0) itrangbi_id = TRANGBI.VIENTHONG_TRANGBI
          else itrangbi_id = this.listbox.trangbi.valuecd

          break
        case DichVuVienThong.MEGAWAN:
        case DichVuVienThong.MGW_DOITAC:
        case DichVuVienThong.MGW_DOITAC:
        case DichVuVienThong.METRONET:
        case DichVuVienThong.NOIBO_DADIEM:
          itocdo_id = this.listbox.tocdokenh.valuecir
          itrangbi_id = this.listbox.trangbi.valuewan
          break
        case DichVuVienThong.ADSL:
          //Thay return -> break o 3 dong nay vi loi khong load duoc khuyen mai!!!
          if (!this.listbox.cboGoiCuocAdsl.list || this.listbox.cboGoiCuocAdsl.list.length <= 0) break
          if (this.listbox.trangbi.list.length <= 0) break
          if (!this.listbox.muccuoc.list || this.listbox.muccuoc.list.length <= 0) break
          itocdo_id = this.listbox.cboGoiCuocAdsl.value
          itrangbi_id = this.listbox.trangbi.valueadsl
          break
        case DichVuVienThong.ANTOAN_BAOMAT_TT:
        case DichVuVienThong.DICHVU_CNTT:
        case DichVuVienThong.TRUNGTAM_DULIEU:
        case DichVuVienThong.HOINGHI_TRUYENHINH:
        case DichVuVienThong.BRCD_DOITAC:
          // if (!this.listbox.cboGoiCuocAdsl.list || this.listbox.cboGoiCuocAdsl.list.length<=0) return;
          if (this.listbox.trangbi.list.length <= 0) itrangbi_id = TRANGBI.VIENTHONG_TRANGBI
          else itrangbi_id = this.listbox.trangbi.valueadsl
          itocdo_id = this.listbox.cboGoiCuocAdsl.value
          break
        case DichVuVienThong.GPHONE:
          itocdo_id = 0
          if (this.listbox.trangbi.list.length <= 0) return
          itrangbi_id = this.listbox.trangbi.valuegp
          break
        case DichVuVienThong.TSL_DOITAC:
        case DichVuVienThong.TSL:
        case DichVuVienThong.NOIBO_2DIEM:
          itocdo_id = this.listbox.tocdokenh.valuetsl //cboTocDoKenhTSL
          itrangbi_id = this.listbox.trangbi.valuetsl //cboTrangBi
          break
        case DichVuVienThong.DI_DONG:
          itocdo_id = this.thuebao.didong.cboGoiCuocDD.value
          itrangbi_id = this.listbox.trangbi.valuedd
          break
      }
      this.trangbi_id = itrangbi_id
      this.tocdo_id = itocdo_id
      //TODO else cac case khac truoc LINE 26464
      //dsKhuyenMai = tchopdong.LAY_KHUYENMAI_HDTB(this.listbox.loaihinh_tb.value, this.listbox.kieu_ld.value, phuongld_id, KHOANMUC_TT.KMTT_DATMOI, phold_id, apld_id, khuld_id, itrangbi_id, Convert.ToInt32(cboDoituongTB.EditValue), itocdo_id, muccuoc_id, 0, hdtb_id);
      this.LoadTTKhuyenMai(KHOANMUC_TT.KMTT_DATMOI, 0, itrangbi_id, itocdo_id) // ham tuong duong doan code nay!
      //this.filterbox.khuyenmai.ischecked = false // disable bang code tren form.
      //longdx: bo sung ham lay thong tin tra truoc
      //dsTraTruoc = tchopdong.LAY_KHUYENMAI_HDTB(this.listbox.loaihinh_tb.value, this.listbox.kieu_ld.value, phuongld_id, KHOANMUC_TT.KMTT_DATMOI, phold_id, apld_id, khuld_id, itrangbi_id, Convert.ToInt32(cboDoituongTB.EditValue), itocdo_id, muccuoc_id, 1, hdtb_id);
      this.LoadTTKhuyenMai(KHOANMUC_TT.KMTT_DATMOI, 1, itrangbi_id, itocdo_id, 'tratruoc')
      //cboTraTruoc.DataSource = dsTraTruoc.Tables[0];
      //cboTraTruoc.ValueMember = "khuyenmai_id";
      //cboTraTruoc.DisplayMember = "ten_km";
      //--------cboTraTruoc-------------
      // this.filterbox.tratruoc.ischecked = false // disable bang code tren form.
    },
    async HT_ThietBi() {
      try {
        var vsl_cha = -1
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IOFFICE) {
          if (this.gridEditors != null) {
            if (this._sl_cha != -1) vsl_cha = this._sl_cha
            else {
              for (var index_ = 0; index_ < this.gridEditors.length; ++index_) {
                if (this.gridEditors[index_].ID == 'TONGSO_ND' && this.gridEditors[index_].Value != '') {
                  vsl_cha = this.gridEditors[index_].Value
                  break
                }
              }
            }
          }
        }
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING || this.listbox.loaihinh_tb.value == LoaiHinhTB.HNTH_NGN || this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MCAP || this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_LIS) {
          if (this.gridEditors != null) {
            if (this._sl_cha != -1) vsl_cha = this._sl_cha
            else {
              for (var index_ = 0; index_ < this.gridEditors.length; ++index_) {
                if (this.gridEditors[index_].ID == 'SL_MAILING' && this.gridEditors[index_].Value != '') {
                  vsl_cha = this.gridEditors[index_].Value
                  if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MCAP) {
                    for (var index1_ = 0; index1_ < this.gridEditors.length; ++index1_) {
                      if (this.gridEditors[index1_].ID == 'SO_THANG' && this.gridEditors[index1_].Value != '') {
                        if (this.gridEditors[index1_].Value % 12 == 0) {
                          vsl_cha = vsl_cha * (this.gridEditors[index1_].Value / 12)
                        }
                        break
                      }
                    }
                  }
                  break
                }
              }
            }
          }
        }

        this.dsTRAGOP_TBI_HDTB = []
        var kt = true //Kiểm tra xem biến
        this.thietbi.tien_tbi = 0
        this.thietbi.vat_tbi = 0
        var soluong = 1
        this.thietbi.tien_kmtbi = 0
        this.thietbi.vat_kmtbi = 0
        this.thietbi.tien_tgtb_tragop = 0
        this.thietbi.vat_tgtb_tragop = 0
        this.thietbi.tien_tgtb_tratruoc = 0
        this.thietbi.vat_tgtb_tratruoc = 0

        var dTyLe_KMTB = 0
        var dtien_kmtbi_tmp = 0
        var dvat_kmtbi_tmp = 0
        var dtien_tbi_tmp = 0
        var dvat_tbi_tmp = 0
        var dtien_tgtb_tratruoc_tmp = 0
        var dvat_tgtb_tratruoc_tmp = 0
        var dtien_tgtb_tragop_tmp = 0
        var dvat_tgtb_tragop_tmp = 0
        var str = ''
        this.lvMuaThietbi.list = []
        for (var i = 0; i < this.dsCTM_TBI.length; i++) {
          var apidata = {}
          await API.post_fn_lay_cho_ht_thietbi(this.axios, { ds_para: JSON.stringify({ LOAITBI_ID: this.dsCTM_TBI[i]['loaitbi_id'], DS_CT_KM_ID: '' + this.ds_CTKM() }) }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              apidata = JSON.parse(response.data.data)
              if (apidata['RESULT']) apidata = apidata['RESULT']
            }
          })
          if (apidata['LOAI_TBI']) str = apidata['LOAI_TBI']
          this.lvMuaThietbi.list.push(str)
          //Hiếu bổ sung thêm tiền mua thiết bị ngày 14/09/2010
          //Hiếu bổ sung code tính tiền mua thiết bị
          kt = false
          soluong = this.dsCTM_TBI[i]['soluong']
          if (this.dsCTM_TBI[i]['tien'] || this.dsCTM_TBI[i]['tien'] == 0) {
            dtien_tbi_tmp = this.dsCTM_TBI[i]['tien']
            this.thietbi.tien_tbi = this.thietbi.tien_tbi + dtien_tbi_tmp * soluong
          }
          if (this.dsCTM_TBI[i]['vat'] || this.dsCTM_TBI[i]['vat']==0) {
            dvat_tbi_tmp = this.dsCTM_TBI[i]['vat']
            this.thietbi.vat_tbi = this.thietbi.vat_tbi + dvat_tbi_tmp * soluong
          }

          if (vsl_cha != -1) {
            if (this.dsCTM_TBI[i]['block_tiep'] && this.dsCTM_TBI[i]['gia_block_tiep'] && this.dsCTM_TBI[i]['gia_block_tiep'] != 0) {
              if (
                this.listbox.loaihinh_tb.value == LoaiHinhTB.IOFFICE ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.HNTH_NGN ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MCAP ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_LIS
              ) {
                if (vsl_cha > this.dsCTM_TBI[i]['block_dau']) {
                  var vsl_conlai = vsl_cha - this.dsCTM_TBI[i]['block_dau']

                  var t2 = vsl_conlai % this.dsCTM_TBI[i]['block_tiep']
                  var vsl_bl = 0
                  if (t2 > 0) vsl_bl = vsl_conlai / this.dsCTM_TBI[i]['block_tiep'] + 1
                  else vsl_bl = vsl_conlai / this.dsCTM_TBI[i]['block_tiep']

                  var tien_block = 0
                  tien_block = vsl_bl * this.dsCTM_TBI[i]['gia_block_tiep']
                  dtien_tbi_tmp += tien_block
                  this.thietbi.tien_tbi = this.thietbi.tien_tbi + tien_block * soluong
                }
              }
            }

            if (this.dsCTM_TBI[i]['block_tiep'] && this.dsCTM_TBI[i]['vat_block_tiep'] && this.dsCTM_TBI[i]['vat_block_tiep'] != 0) {
              if (
                this.listbox.loaihinh_tb.value == LoaiHinhTB.IOFFICE ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.HNTH_NGN ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MCAP ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_LIS
              ) {
                if (vsl_cha > this.dsCTM_TBI[i]['block_dau']) {
                  var vsl_conlai = vsl_cha - this.dsCTM_TBI[i]['block_dau']

                  var t3 = vsl_conlai % this.dsCTM_TBI[i]['block_tiep']
                  var rsl_bl = 0
                  if (t3 > 0) rsl_bl = vsl_conlai / this.dsCTM_TBI[i]['block_tiep'] + 1
                  else rsl_bl = vsl_conlai / this.dsCTM_TBI[i]['block_tiep']

                  var vat_block = 0
                  vat_block = rsl_bl * this.dsCTM_TBI[i]['vat_block_tiep']
                  dvat_tbi_tmp += vat_block
                  this.thietbi.vat_tbi = this.thietbi.vat_tbi + vat_block * soluong
                }
              }
            }
          }

          var dtTMP_KMTBI = []
          if (apidata['TMP_KMTBI']) dtTMP_KMTBI = this.LowerCasePropertyList(apidata['TMP_KMTBI'])
          if (dtTMP_KMTBI.length > 0) {
            dtien_kmtbi_tmp = dtTMP_KMTBI.Rows[0]['tien_km']
            dvat_kmtbi_tmp = dtTMP_KMTBI.Rows[0]['vat_km']
            dTyLe_KMTB = dtTMP_KMTBI.Rows[0]['tyle_km']
          } // hoangpkn : 13/12/2018. Thêm đoạn else
          else {
            dtien_kmtbi_tmp = 0
            dvat_kmtbi_tmp = 0
            dTyLe_KMTB = 0
          }

          if (dTyLe_KMTB > 0) {
            dtien_kmtbi_tmp = this.round((dtien_tbi_tmp * dTyLe_KMTB) / 100)
            dvat_kmtbi_tmp = this.round((dvat_tbi_tmp * dTyLe_KMTB) / 100)
          }
          if (dtTMP_KMTBI.length > 0) {
            this.dsCTM_TBI[i]['tien_km'] = dtien_kmtbi_tmp
            this.dsCTM_TBI[i]['vat_km'] = dvat_kmtbi_tmp
            this.thietbi.tien_kmtbi += dtien_kmtbi_tmp * soluong
            this.thietbi.vat_kmtbi += dvat_kmtbi_tmp * soluong
          }
          var dtTMP = []
          if (apidata['TMP_TRAGOP']) dtTMP = this.LowerCasePropertyList(apidata['TMP_TRAGOP'])
          if (dtTMP.length > 0) {
            //có định nghĩa trả góp
            if (this.dsCTM_TBI[i]['tien_tratruoc'] || this.dsCTM_TBI[i]['tien_tratruoc']==0) dtien_tgtb_tratruoc_tmp = this.dsCTM_TBI[i]['tien_tratruoc']
            if (this.dsCTM_TBI[i]['vat_tratruoc'] || this.dsCTM_TBI[i]['vat_tratruoc']==0) dvat_tgtb_tratruoc_tmp = this.dsCTM_TBI[i]['vat_tratruoc']

            var rowtgtb = {}
            rowtgtb.HDTB_ID = 0
            rowtgtb.CHITIETKM_ID = dtTMP[0]['chitietkm_id']
            rowtgtb.LOAITBI_ID = this.dsCTM_TBI[i]['loaitbi_id']
            rowtgtb.TIEN = dtien_tbi_tmp
            rowtgtb.VAT = dvat_tbi_tmp
            rowtgtb.SOLUONG = soluong
            rowtgtb.TIEN_KM = dtien_kmtbi_tmp
            rowtgtb.VAT_KM = dvat_kmtbi_tmp
            rowtgtb.TYLE_KM = dTyLe_KMTB
            rowtgtb.TIEN_TRATRUOC = dtien_tgtb_tratruoc_tmp
            rowtgtb.VAT_TRATRUOC = dvat_tgtb_tratruoc_tmp
            rowtgtb.TIEN_TRAGOP = (dtien_tbi_tmp - dtien_kmtbi_tmp) * soluong - dtien_tgtb_tratruoc_tmp
            rowtgtb.VAT_TRAGOP = (dvat_tbi_tmp - dvat_kmtbi_tmp) * soluong - dvat_tgtb_tratruoc_tmp
            this.dsTRAGOP_TBI_HDTB.push(rowtgtb)
          } else {
            dtien_tgtb_tratruoc_tmp = dtien_tbi_tmp - dtien_kmtbi_tmp
            dvat_tgtb_tratruoc_tmp = dvat_tbi_tmp - dvat_kmtbi_tmp
            this.dsCTM_TBI[i]['tien_tratruoc'] = dtien_tgtb_tratruoc_tmp
            this.dsCTM_TBI[i]['vat_tratruoc'] = dvat_tgtb_tratruoc_tmp
          }

          this.thietbi.tien_tgtb_tratruoc += dtien_tgtb_tratruoc_tmp * soluong
          this.thietbi.vat_tgtb_tratruoc += dvat_tgtb_tratruoc_tmp * soluong
          this.thietbi.tien_tgtb_tragop += (dtien_tbi_tmp - Math.abs(dtien_kmtbi_tmp) - dtien_tgtb_tratruoc_tmp) * soluong
          this.thietbi.vat_tgtb_tragop += (dvat_tbi_tmp - Math.abs(dvat_kmtbi_tmp) - dvat_tgtb_tratruoc_tmp) * soluong
        }

        if (kt) {
          this.thietbi.tien_tbi = 0
          this.thietbi.vat_tbi = 0
          this.thietbi.tien_kmtbi = 0
          this.thietbi.vat_kmtbi = 0
          this.thietbi.tien_tgtb_tratruoc = 0
          this.thietbi.vat_tgtb_tratruoc = 0
          this.thietbi.tien_tgtb_tragop = 0
          this.thietbi.vat_tgtb_tragop = 0
        }
        this.thietbi.dtien_kmtb = this.thietbi.tien_kmtbi
        this.thietbi.dvat_kmtb = this.thietbi.vat_kmtbi
        this.HienThiTienMuaThietBi()
        this.HienThiTienKhuyenMai_ThietBi()
        this.HienThiTienTraTruocThietBi()
        this.HienThiTienTraGopThietBi()
      } catch (ex) {
        this.$toast.error('' + ex)
        throw ex
      }
    },
    HienThiTienMuaThietBi() {
      this.thietbi.dtientbi = this.thietbi.tien_tbi
      this.thietbi.dvattbi = this.thietbi.vat_tbi

      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_MUATHIETBI) {
          this.ds_tien_khoanmuc[j]['tien'] = this.thietbi.tien_tbi
          this.ds_tien_khoanmuc[j]['vat'] = this.thietbi.vat_tbi
        }
      }

      this.LayTongTien_HDTB()
    },
    HienThiTienKhuyenMai_ThietBi() {
      this.thietbi.dtien_kmtb = this.thietbi.tien_kmtb
      this.thietbi.dvat_kmtb = this.thietbi.vat_kmtbi

      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI) {
          if (this.thietbi.tien_kmtb > 0) {
            this.ds_tien_khoanmuc[j]['tien'] = this.thietbi.tien_kmtb * -1
            this.ds_tien_khoanmuc[j]['vat'] = this.thietbi.vat_kmtbi * -1
          } else {
            this.ds_tien_khoanmuc[j]['tien'] = this.thietbi.tien_kmtb
            this.ds_tien_khoanmuc[j]['vat'] = this.thietbi.vat_kmtbi
          }
        }
      }

      this.LayTongTien_HDTB()
    },
    HienThiTienTraTruocThietBi() {
      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_TRATRUOC_THIETBI) {
          this.ds_tien_khoanmuc[j]['tien'] = this.thietbi.tien_tgtb_tratruoc
          this.ds_tien_khoanmuc[j]['vat'] = this.thietbi.vat_tgtb_tratruoc
        }
      }

      this.LayTongTien_HDTB()
    },
    HienThiTienTraGopThietBi() {
      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_TRAGOP_THIETBI) {
          this.ds_tien_khoanmuc[j]['tien'] = this.thietbi.tien_tgtb_tragop
          this.ds_tien_khoanmuc[j]['vat'] = this.thietbi.vat_tgtb_tragop
        }
      }

      this.LayTongTien_HDTB()
    },
    async HienThiTT_DanhBa(ds) {
      try {
        if (ds.length > 0) {
          this.thuebao.tbhd_pl = 0
          this.NgayYeuCau = moment(new Date()).format(this.datetimeFormatFull)
          if (ds[0]['ngaylap_hd']) this.NgayLapHD = ds[0]['ngaylap_hd']
          if (!this.NgayLapHD) this.NgayLapHD = moment(new Date()).format(this.datetimeFormatFull)
          this.khachhang.makh = ds[0]['ma_kh']
          this.khachhang.mahd = ds[0]['ma_hd']
          this.khachhang.khachhang_id = ds[0]['khachhang_id']
          if (this.khachhang.khachhang_id > 0) this.khachhang.khachhangtc_id = await bancheo.LAY_KHACHHANGID_THICONG(this.tinh, this.khachhang.khachhang_id) // tcbancheo.LAY_KHACHHANGID_THICONG(tinh, khachhang_id);
          this.khachhang.tenkh = this.ChuanHoaTen(ds[0]['ten_kh'])
          this.diachiKH.DIACHI = this.ChuanHoaTen(ds[0]['diachi_kh'])
          if (ds[0]['loaikh_id']) this.listbox.loai_kh.value = ds[0]['loaikh_id']
          if (!ds[0]['diachi_ndd'] || ds[0]['diachi_ndd'].length == 0) this.diachiNDD.DIACHI = this.ChuanHoaTen(ds[0]['diachi_kh'])
          else this.diachiNDD.DIACHI = this.ChuanHoaTen(ds[0]['diachi_ndd'])
          if (this.listbox.loai_kh.value == Loai_KH.CANHAN_HOGIADINH && (!ds[0]['nguoi_dd'] || ds[0]['nguoi_dd'].trim() == '')) this.khachhang.nguoidd = this.khachhang.tenkh
          else this.khachhang.nguoidd = this.ChuanHoaTen(ds[0]['nguoi_dd'])

          if (ds[0]['nganhnghe_id']) {
            this.listbox.nganhngheloc.value = ds[0]['nganhnghe_id']
            this.nganhnghe_id = ds[0]['nganhnghe_id']
          }

          //TuấnNA thêm code hiển thị thông tin id tiểu ngành c1,c2,c3 -- Ngày 03/12/2010
          if (ds[0]['tnc1_id'] != '') this.tieunganh.TNC1_ID = ds[0]['tnc1_id']
          else this.tieunganh.TNC1_ID = 0
          if (ds[0]['tnc2_id'] != '') this.tieunganh.TNC2_ID = ds[0]['tnc2_id']
          else this.tieunganh.TNC2_ID = 0
          if (ds[0]['tnc3_id'] != '') this.tieunganh.TNC3_ID = ds[0]['tnc3_id']
          else this.tieunganh.TNC3_ID = 0
          if (ds[0]['tnc4_id'] != '') this.tieunganh.TNC4_ID = ds[0]['tnc4_id']
          else this.tieunganh.TNC4_ID = 0
          //

          this.khachhang.dienthoai = ds[0]['so_dt']
          this.khachhang.fax = ds[0]['so_fax']

          // this.diachiHK.DIACHI = this.ChuanHoaTen(ds[0]["hokhau"]);

          if (ds[0]['ngay_sn']) this.NgaySinh = ds[0]['ngay_sn']
          else this.NgaySinh = null
          this.khachhang.sogt = ds[0]['so_gt']
          if (ds[0]['ngaycap']) this.NgayCap = ds[0]['ngaycap']
          else this.NgayCap = null

          //Hiếu bổ sung 1 số thông tin thiếu 27.09.2010
          if (ds[0]['ngayhethan_gt']) this.NgayHH = ds[0]['ngayhethan_gt']
          else this.NgayHH = null
          this.khachhang.chucvu = ds[0]['chucdanh']
          this.diachiHK.DIACHI = this.ChuanHoaTen(ds[0]['hokhau'])
          this.khachhang.noicaphk = this.ChuanHoaTen(ds[0]['noicap_hk'])
          if (ds[0]['ngaycap'])
            //FIXME ngay_hk moi dung chu nhi????
            this.NgayCapHK = ds[0]['ngaycap']
          else this.NgayCapHK = null
          this.khachhang.masothue = ds[0]['mst']
          this.listbox.nganhang.sotaikhoankh = ds[0]['stk']
          if (ds[0]['nganhang_id']) {
            this.listbox.nganhang.ischeckedkh = true
            this.listbox.nganhang.valuekh = ds[0]['nganhang_id']
          } else this.listbox.nganhang.ischeckedkh = false
          this.khachhang.dactrung = ds[0]['dactrung']
          //txtGiayToKem.Text = ds[0]["so_gt_kem"];
          this.khachhang.ghichu = ds[0]['ghichu']
          if (ds[0]['loaigt_id'] != '') this.listbox.loai_gt.value = ds[0]['loaigt_id']
          this.khachhang.noicap = this.ChuanHoaTen(ds[0]['noicap'])
          this.listbox.loai_khl.value = ds[0]['khlon_id']
          this.diachiCT.DIACHI = this.ChuanHoaTen(ds[0]['diachi_ct'])
          this.nganhang.DV_QHNS = ds[0]['dv_qhns']
          this.nganhang.MACHUONG = ds[0]['machuong']
          this.nganhang.MN_KT = ds[0]['mn_kt']
          this.nganhang.MA_NDKT = ds[0]['ma_ndkt']
          this.nganhang.MN_NSNN = ds[0]['mn_nsnn']
          if (ds[0]['tien_dm']) this.nganhang.TIEN_DM = ds[0]['tien_dm']

          //Thông tin thanh toán
          //HungHM - 20/09/2010 Zem lai : nếu txtMaTT = null thì sẽ tự sinh mã TT mới, hoặc chọn List mã TT
          //txtMaTT.Text = ds["ma_tt"];
          this.thanhtoan.thanhtoan_id = ds[0]['thanhtoan_id']
          this.thanhtoan.mainghep = ds[0]['main_ghep']
          if (ds[0]['mig_id']) {
            this.thanhtoan.mig_id = ds[0]['mig_id']
          }
          this.thanhtoan.tentt = this.ChuanHoaTen(ds[0]['ten_tt'])
          this.diachiTT.DIACHI = this.ChuanHoaTen(ds[0]['diachi_tt'])
          //địa chỉ báo cước
          this.diachiBC.DIACHI = this.ChuanHoaTen(ds[0]['diachi_bc'])
          //
          if (!ds[0]['diachi_ct']) this.diachiCT.DIACHI = this.ChuanHoaTen(ds[0]['diachi_tt'])
          else this.diachiCT.DIACHI = this.ChuanHoaTen(ds[0]['diachi_ct'])

          var vetinh_id = ''
          await API.post_fn_lay_tt_danhba(this.axios, { ds_para: JSON.stringify({ KHACHHANG_ID: this.khachhang.khachhang_id, THANHTOAN_ID: this.thanhtoan.thanhtoan_id, THUEBAO_ID: ds[0]['thuebao_id'], PHANLOAIKH_ID: ds[0]['phanloaikh_id'] ? ds['phanloaikh_id'] : null, BANCHEO: 1 }) }).then(
            (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                var apidata = JSON.parse(response.data.data)
                if (apidata['RESULT']) apidata = apidata['RESULT']
                if (apidata['DS_DIACHI_DBKH']) this.HienThiTTDiaChi(apidata['DS_DIACHI_DBKH'], 1)
                if (apidata['DS_DIACHI_DBTT']) this.HienThiTTDiaChi(apidata['DS_DIACHI_DBTT'], 2)
                // if(apidata['DS_DIACHI_TB'])
                //   this.HienThiTTDiaChi(apidata['DS_DIACHI_TB'],3);
                if (apidata['DS_MADD'] && apidata['DS_MADD'].length > 0) this.listbox.madaidien.list = this.LowerCasePropertyList(apidata['DS_MADD'])
                if (apidata['NVTC_ID']) this.thanhtoan.nhanvientc_id = apidata['NVTC_ID']
                if (apidata['TUYENTHU_ID']) this.thanhtoan.tuyenthu_id = apidata['TUYENTHU_ID']
                if (apidata['MA_NV']) this.thanhtoan.manvtc = apidata['MA_NV']
                if (apidata['MA_TUYEN']) this.thanhtoan.matuyen = apidata['MA_TUYEN']
                if (apidata['VETINH_ID']) vetinh_id = apidata['VETINH_ID']
                if (apidata['MA_PLKH']) this.khachhang.plkh = apidata['MA_PLKH']
                if (apidata['NHOM_PLKH'] && apidata['NHOM_PLKH'] != '-1') this.khachhang.nhom_plkh = apidata['NHOM_PLKH']
                //ds1 = response.data.data;
              }
            }
          )

          if (ds[0]['matb_dd']) this.listbox.madaidien.value = ds[0]['matb_dd']

          //txtMaTBDD.Text = ds["matb_dd"];
          this.thanhtoan.masothue = ds[0]['mst_tt']
          // if (ts_kt_mst_kh == 1)
          //     txtMST_TT2.Text = ds["mst_tt"];
          // else
          //     txtMST_TT.Text = ds["mst_tt"];
          this.listbox.nganhang.sotaikhoan = ds[0]['stk_tt']
          this.thanhtoan.sodienthoai = ds[0]['so_dt_tt']
          this.thanhtoan.email = ds[0]['email_tt']
          this.thanhtoan.chutk = ds[0]['chu_tk_tt']
          if (ds[0]['nganhang_id_tt']) this.listbox.nganhang.value = ds[0]['nganhang_id_tt']
          this.listbox.hinhthuc_tt.value = ds[0]['httt_id']
          if (ds[0]['httc_id']) this.listbox.hinhthuc_tc.value = ds[0]['httc_id']
          if (ds[0]['donvi_id']) this.listbox.donvi_ql.valueql = ds[0]['donvi_id']

          if (!ds[0]['nhanvien_id']) {
            this.thanhtoan.nhanvientc_id = 0
            this.thanhtoan.manvtc = ''
          }

          if (!ds[0]['tuyenthu_id']) {
            this.thanhtoan.tuyenthu_id = 0
            this.thanhtoan.matuyen = ''
          }

          this.thanhtoan.matb_dd = ds[0]['matb_dd']
          this.HienThi_NVQL_AM_DB_HD(1, this.thanhtoan.thanhtoan_id)
          //Thông tin thuê bao
          //HIếu bổ sung thêm một số thông tin 1.10.2010
          this.thuebao.tentb = this.ChuanHoaTen(ds[0]['ten_tb'])
          this.diachiTB.DIACHI = this.ChuanHoaTen(ds[0]['diachi_tb'])

          if (ds['donviql_id']) this.listbox.donvi_ql.value = ds[0]['donviql_id']

          if (this.ht_loc_cbo_tram) this.HT_GIAODIEN_DONVI()

          //
          this.listbox.doituong.value = ds['doituong_id'] ? ds[0]['doituong_id'] : this.listbox.doituong.list ? this.listbox.doituong.list[0].doituong_id : null

          //Lấy ds mức cước thuê bao
          //Index trạm thi công theo phường
          // string vetinh_id = ""; // da xu ly o tren
          // vetinh_id = objCheckData.MAP_ID("donvi_id", DatabaseConstants.DB2 + ".donvi_px", "where phuong_id =" + phuongld_id + " and decode(" + phold_id + ",0, 0, pho_id) = " + phold_id + " and loaidv_id = " + LOAI_DV.TRAM_VT);

          if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) {
            if (vetinh_id != '-1') this.buttons.btnChonSM = true
            // else
            //     this.buttons.btnChonSM = false;
          } else if (this.listbox.dichvu_vt.value == DichVuVienThong.IMS) this.buttons.btnChonSoIMS = vetinh_id != '-1'
          //Cac case con lai khong co code -> bo qua
          //Lay_DS_MucCuoc_TB(khuld_id, apld_id, phold_id, phuongld_id, this.listbox.loaihinh_tb.value, Convert.ToInt32(cboDoituongTB.EditValue), dtpNgayYeuCau.Value.ToString("dd/MM/yyyy"));
          this.LoadMucCuocTB() // Thay ham kia bang ham nay tuong duong
          //
          if (ds['diachi_ld']) this.diachiLD.DIACHI = this.ChuanHoaTen(ds[0]['diachi_tb'])
          else this.diachiLD.DIACHI = this.ChuanHoaTen(ds[0]['diachi_ld'])
          if (ds['ngay_sn']) this.NgaySinhTB = ds[0]['ngay_sn']
          else if (!this.NgaySinhTB) this.NgaySinhTB = null

          this.buttons.chkLapDatBS = true
          //Hien thi thong tin khuyen mai
          this.HT_DS_KhuyenMai_Combobox()
        } else {
          this.thuebao.tbhd_pl = 1
          this.buttons.chkLapDatBS = false
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        //throw ex;
      }
    },
    async HienThiTTHopDongKH(ds) {
      try {
        this.loading(true)
        if (ds.length > 0) {
          this.khachhang.hdkh_id = ds[0]['hdkh_id']
          var dthdkh_sub = []
          var DS_HD_TT = []
          var DS_HD_TB = []
          var vhdkhtn_id = ''
          if (ds[0]['hdkh_cha_id']) {
            this.hdkh_cha_id = ds[0]['hdkh_cha_id'] * 1
            //KieuNV:Kiểm tra xem hợp đồng cha có phải là hợp đồng tư vấn dịch vụ hay không.
            var loaihd_cha_id = await API.post_fn_tt_hd_khachhang(this.axios, { param: this.hdkh_cha_id, type: 1 })
              .then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  return response.data.data
                } else return -1
              })
              .catch(() => {
                return -1
              }) //.MAP_ID("loaihd_id", DatabaseConstants.DB2 + ".hd_khachhang", "where hdkh_id =" + hdkh_cha_id);
            if (loaihd_cha_id == LoaiHopDong.TUVAN_DV + '') {
              this.IS_HD_TUVAN = true
            }
          }

          if (
            await API.post_kiemtra_magd_bancheo(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, vmagd: this.khachhang.magd })
              .then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  return response.data.data.dem == 0
                } else return false
              })
              .catch(() => {
                return false
              })
          ) {
            //bc_checkdata.KIEMTRA_MAGD_BANCHEO(tinh.tinhthicong_id, txtMaGD.Text))
            this.$toast.error('Mã giao dịch không thuộc hợp đồng bán chéo. Hoặc không phải tỉnh thi công : ' + this.tinh.tentinh)
            return
          }

          await API.post_fn_ht_tt_hd_khachhang(this.axios, {
            ds_para: JSON.stringify({
              BANCHEO: 1,
              HDKH_ID: this.khachhang.hdkh_id,
              HDKH_CHA_ID: ds[0]['hdkh_cha_id'] ? ds[0]['hdkh_cha_id'] : null,
              CTV_ID: ds[0]['ctv_id'] ? ds[0]['ctv_id'] : null,
              NVGT_ID: ds[0]['nhanviengt_id'] ? ds[0]['nhanviengt_id'] : null,
              PHANLOAIKH_ID: ds[0]['phanloaikh_id'] ? ds[0]['phanloaikh_id'] : null,
              LOAIHD_ID: ds[0]['loaihd_id'] ? ds[0]['loaihd_id'] : null
            })
          }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              var apidata = JSON.parse(response.data.data)
              if (apidata['RESULT']) apidata = apidata['RESULT']
              if (apidata['HDKH_SUB']) dthdkh_sub = this.LowerCasePropertyList(apidata['HDKH_SUB'])
              if (apidata['IS_HD_TUVAN']) this.IS_HD_TUVAN = apidata['IS_HD_TUVAN']
              if (apidata['DC_HDKH']) this.HienThiTTDiaChi(this.LowerCasePropertyList(apidata['DC_HDKH']), 1)
              if (ds[0]['ctv_id']) {
                if (apidata['TEN_NV_CTV']) this.filterbox.ctv.value = apidata['TEN_NV_CTV']
                if (apidata['MA_NV_CTV']) this.filterbox.ctv.ma_ctv = apidata['MA_NV_CTV']
                this.ctv_id = ds[0]['ctv_id']
                this.filterbox.ctv.ischecked = true
              } else {
                this.filterbox.ctv.value = ''
                this.filterbox.ctv.ma_ctv = ''
                this.filterbox.ctv.ischecked = false
              }
              if (ds[0]['nhanviengt_id']) {
                if (apidata['MA_NVGT']) this.filterbox.nguoigt.nguoigt_id = apidata['MA_NVGT']
                if (apidata['TEN_NVGT']) this.filterbox.nguoigt.value = apidata['TEN_NVGT']
                this.filterbox.nguoigt.nguoigt_id = ds[0]['nhanviengt_id']
                this.filterbox.nguoigt.ischecked = true
              } else {
                this.filterbox.nguoigt.nguoigt_id = ''
                this.filterbox.nguoigt.value = ''
                this.filterbox.nguoigt.ischecked = false
              }
              if (apidata['MA_PLKH']) this.khachhang.plkh = apidata['MA_PLKH']
              if (apidata['NHOM_PLKH']) this.khachhang.nhom_plkh = apidata['NHOM_PLKH']
              if (apidata['DS_HD_TT']) DS_HD_TT = this.LowerCasePropertyList(apidata['DS_HD_TT'])
              //if (apidata['DS_HD_TB']) DS_HD_TB = this.LowerCasePropertyList(apidata['DS_HD_TB'])
              if (apidata['DS_HDKH_BC']) DS_HD_TB = this.LowerCasePropertyList(apidata['DS_HDKH_BC'])
              if (apidata['HDKHTN_ID']) vhdkhtn_id = apidata['HDKHTN_ID']
              if (apidata['KT_TC_BC']) this.Khoa_HD_BC_Tinh_ThiCong(true)
              else this.Khoa_HD_BC_Tinh_ThiCong(false)
            }
          })
          this.dsHDKH_Sub = []
          if (dthdkh_sub.length > 0) {
            this.TAO_DULIEU_HDKH_SUB(dthdkh_sub, this.khachhang.hdkh_id)
          }
          // if (ds[0]["hdkh_cha_id"])
          // {
          //     this.hdkh_cha_id = ds[0]["hdkh_cha_id"];

          //     //KieuNV:Kiểm tra xem hợp đồng cha có phải là hợp đồng tư vấn dịch vụ hay không.
          //     //FIXME chưa biết load dữ liệu gì ở đây
          //     var loaihd_cha_id = objCheckData.MAP_ID("loaihd_id", DatabaseConstants.DB2 + ".hd_khachhang", "where hdkh_id =" + hdkh_cha_id);
          //     if (loaihd_cha_id == LoaiHopDong.TUVAN_DV)
          //     {
          //       this.IS_HD_TUVAN = true;
          //     }
          // }
          //if (!string.IsNullOrEmpty(ds[0]["kieuhd_id"]))
          //    cboKieuHD.SelectedValue = Convert.ToInt32(ds[0]["kieuhd_id"]);
          if (ds[0]['ngay_yc']) this.NgayYeuCau = ds[0]['ngay_yc']
          else this.NgayYeuCau = moment(new Date()).format(this.datetimeFormatFull)
          if (ds[0]['ngaylap_hd']) this.NgayLapHD = ds[0]['ngaylap_hd']
          else this.NgayLapHD = moment(new Date()).format(this.datetimeFormatFull)
          this.khachhang.magd = ds[0]['ma_gd']
          this.khachhang.mahd = ds[0]['ma_hd']
          this.khachhang.makh = ds[0]['ma_kh']
          //if(this.khachhang.makh) this.MaKHChanged(); //THANGDM1 Bo sung them luong de load du lieu khach hang tu dong UPDATED 20211130: thao tac nay sai. Thong tin load o day chi dung cho danh ba
          if (ds[0]['khachhang_id']) this.khachhang.khachhang_id = ds[0]['khachhang_id']
          else this.khachhang.khachhang_id = 0
          if (this.khachhang.khachhang_id > 0) this.khachhang.khachhangtc_id = await bancheo.LAY_KHACHHANGID_THICONG(this.tinh, this.khachhang.khachhang_id) // tcbancheo.LAY_KHACHHANGID_THICONG(tinh, khachhang_id);

          if (ds[0]['loaikh_id'] && ds[0]['loaikh_id']) this.listbox.loai_kh.value = ds[0]['loaikh_id'] * 1
          var kieuKH_temp = this.listbox.loai_kh.list.filter((x) => x.loaikh_id == this.listbox.loai_kh.value)[0]['loai']

          if (kieuKH_temp) {
            this.vkieukh_id_ = kieuKH_temp
          }

          if (ds[0]['kieuhd_id']) this.listbox.kieu_hd.value = ds[0]['kieuhd_id']
          else this.listbox.kieu_hd.value = KIEU_HD.TAI_GD
          this.vkieuhd_id = this.listbox.kieu_hd.value

          this.khachhang.tenkh = this.ChuanHoaTen(ds[0]['ten_kh'])

          this.diachiKH.DIACHI = ds[0]['diachi_kh']

          this.khachhang.nguoidd = this.ChuanHoaTen(ds[0]['nguoi_dd'])
          this.khachhang.chucvu = this.ChuanHoaTen(ds[0]['chucdanh_dd'])
          this.khachhang.dienthoai = ds[0]['so_dt']
          this.khachhang.fax = ds[0]['so_fax']

          this.diachiHK.DIACHI = this.ChuanHoaTen(ds[0]['hokhau'])
          this.khachhang.noicaphk = this.ChuanHoaTen(ds[0]['noicap_hk'])

          if (ds[0]['ngay_hk']) {
            this.NgayCapHK = moment(ds[0]['ngay_hk']).format('DD/MM/YYYY')
          } else {
            this.NgayCapHK = null
          }

          if (ds[0]['ngay_sn']) {
            this.NgaySinh = ds[0]['ngay_sn']
          } else {
            this.NgaySinh = null
          }
          this.NgayYeuCau = ds[0]['ngay_yc']

          //HungHM - bổ xung các trường còn thiếu mới thêm vào bảng hd_khachhang
          if (ds[0]['ngaylap_hd']) this.NgayLapHD = ds[0]['ngaylap_hd']
          else this.NgayLapHD = moment(new Date()).format(this.datetimeFormatFull)
          if (ds[0]['gioitinh']) {
            this.khachhang.gioitinh = ds[0]['gioitinh']
          } else this.khachhang.gioitinh = -1
          if (ds[0]['quoctich_id']) {
            this.listbox.quoctich.value = ds[0]['quoctich_id']
          }
          if (ds[0]['dantoc_id']) {
            this.listbox.dantoc.value = ds[0]['dantoc_id']
          }
          if (ds[0]['nganhnghe_id']) {
            this.listbox.nganhngheloc.value = ds[0]['nganhnghe_id']
            this.nganhnghe_id = ds[0]['nganhnghe_id']
            // cboNganhNgheLoc.Properties.LockEvents();
            // cboNganhNgheLoc.EditValue = ds[0]["nganhnghe_id"];
            // nganhnghe_id = ds[0]["nganhnghe_id"];
            // cboNganhNgheLoc.Properties.UnLockEvents();
          }
          //TuấnNA thêm code hiển thị thông tin id tiểu ngành c1,c2,c3 -- Ngày 03/12/2010
          if (ds[0]['tnc1_id']) this.tieunganh.TNC1_ID = ds[0]['tnc1_id']
          else this.tieunganh.TNC1_ID = 0
          if (ds[0]['tnc2_id']) this.tieunganh.TNC2_ID = ds[0]['tnc2_id']
          else this.tieunganh.TNC2_ID = 0
          if (ds[0]['tnc3_id']) this.tieunganh.TNC3_ID = ds[0]['tnc3_id']
          else this.tieunganh.TNC3_ID = 0
          if (ds[0]['tnc4_id']) this.tieunganh.TNC4_ID = ds[0]['tnc4_id']
          else this.tieunganh.TNC4_ID = 0
          //

          this.diachiNDD.DIACHI = this.ChuanHoaTen(ds[0]['diachi_ndd'])
          if (ds[0]['ngayhethan_gt']) this.NgayHH = moment(ds[0]['ngayhethan_gt']).format('DD/MM/YYYY')
          else this.NgayHH = null
          this.khachhang.masothue = ds[0]['mst']
          // if (ts_kt_mst_kh == 1)
          //     txtMaSTKH2.Text = ds[0]["mst"];
          // else
          //     txtMaSTKH.Text = ds[0]["mst"];
          this.listbox.nganhang.sotaikhoankh = ds[0]['stk']
          if (ds[0]['nganhang_id']) {
            this.listbox.nganhang.valuekh = ds[0]['nganhang_id']
            this.listbox.nganhang.ischeckedkh = true
          }
          //end edited
          this.khachhang.sogt = ds[0]['so_gt']

          if (ds[0]['ngaycap']) {
            this.NgayCap = ds[0]['ngaycap']
          } else {
            this.NgayCap = null
          }

          this.listbox.loai_gt.value = ds[0]['loaigt_id']
          this.khachhang.noicap = this.ChuanHoaTen(ds[0]['noicap'])
          this.buttons.chkLapDatBS = ds[0]['bosungtb_id'] == '1'
          this.listbox.loai_khl.value = ds[0]['khlon_id']
          this.khachhang.ghichu = ds[0]['ghichu']
          this.khachhang.dactrung = ds[0]['dactrung']

          if (ds[0]['httthi_id']) {
            this.listbox.hinhthuc_tthi.value = ds[0]['httthi_id']
          } else this.listbox.hinhthuc_tthi.value = 0

          //PNLINH: B2A 02/05/2020
          if (ds[0]['phieucskh_id'] != '') {
            this.VPHIEUCSKH_ID = ds[0]['phieucskh_id']
          }
          //
          this.maduan = ds[0]['ma_duan']

          if (ds[0]['loaihd_id'] != LoaiHopDong.TIEPNHAN_DATMOI && ds[0]['loaihd_id'] != LoaiHopDong.KHAOSATDATMOI && ds[0]['loaihd_id'] != LoaiHopDong.TIEPNHANHD) {
            //SetButton(3);
            this.buttonSet = 3
            this.HienThiDS_HDTT_CBO(this.khachhang.hdkh_id)
            this.HienThiTTHopDongTT(DS_HD_TT)
            //this.HienThiDS_HDTB_CBO(hdkh_id); // 100% comment nen khong code
            this.HienThiDanhSacHDTT(DS_HD_TT)
            this.HienThiDanhSacHDTB(DS_HD_TB)
            this.HienThiTTHopDongTB(DS_HD_TB)

            if (vhdkhtn_id == '-1') this.hdkhtn_id = 0
            else this.hdkhtn_id = vhdkhtn_id
          } else {
            if (ds[0]['loaihd_id'] == LoaiHopDong.TIEPNHAN_DATMOI) this.hdkhtn_id = this.khachhang.hdkh_id
            //SetButton(4);
            this.buttonSet = 4
          }

          //SetButton(3);
          if (this.lvwThueBao.length > 1) this.buttons.tsbtnXoaTB = true
          else this.buttons.tsbtnXoaTB = false

          // SendKeys.Send("{TAB}");

          try {
            //TODO chưa làm vì chưa quan trọng ở phần cố định
            //BusinessFacade.BanCheoFacade.BanCheoBase bc = new BusinessFacade.BanCheoFacade.BanCheoBase();
            // if (bc.Kiem_tra_thi_cong_ban_cheo(hdtb_id))
            //     this.Khoa_HD_BC_Tinh_ThiCong(true);
            // else
            //     this.Khoa_HD_BC_Tinh_ThiCong(false);
          } catch (ex) {}
        } else {
          this.buttonSet = 0
          //  SetButton(0);
        }
      } catch (exp) {
        this.$toast.error('' + exp)
        throw exp
      } finally {
        this.loading(false)
      }
    },
    Khoa_HD_BC_Tinh_ThiCong(khoa) {
      // TODO chưa làm vì không quan trọng ở phần cố định
      // cboChuQuan_ADSL.Enabled = !khoa;
      // cboChuQuanLD_Internet.Enabled = !khoa;
      // cboTocDoThucADSL.Enabled = !khoa;
      // cboGoiCuocAdsl.Enabled = !khoa;
      // cboTocDo.Enabled = !khoa;
      // cboChuQuanWan.Enabled = !khoa;
      // cboChuQuanLD_Mgwan.Enabled = !khoa;
      // cboChuQuan_TSL.Enabled = !khoa;
      // cboTocDoKenhTSL.Enabled = !khoa;
      // chkKhuyenMai.Enabled = !khoa;
      // chkTraTruoc.Enabled = !khoa;
      // cboChuQuan_CD.Enabled = !khoa;
      // cboChuQuanLD_CD.Enabled = !khoa;
      // cboChuQuan_DD.Enabled = !khoa;
      // cboChuQuan_GP.Enabled = !khoa;
      // cboChuQuan_IMS.Enabled = !khoa;
      // cboChuQuanLD_IMS.Enabled = !khoa;
    },
    showPopupSearchContract() {
      this.$refs.popupSearchContract.showModal()
    },
    async acceptSearchContract(item) {
      this.khachhang.magd = item.ma_gd

      if (
        await API.post_kiemtra_magd_bancheo(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, vmagd: this.khachhang.magd })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data.dem == 0
            } else return false
          })
          .catch(() => {
            return false
          })
      ) {
        this.$toast.error('Mã giao dịch không thuộc hợp đồng bán chéo. Hoặc không phải tỉnh thi công : ' + this.tinh.tentinh)
        return
      }

      if (this.khachhang.magd && this.khachhang.magd.trim() != '') this.MaGDChanged()
      //TODO RECENT chua lam phan nay!!!! khong thay nhac den trong khao sat, tam bo qua
      // if ((txtMaGD.Text != "") && (f.loaihd_id != LoaiHopDong.TIEPNHAN_DATMOI)
      //     && (f.loaihd_id != LoaiHopDong.KHAOSATDATMOI)
      //     && f.loaihd_id != LoaiHopDong.TIEPNHANHD
      //     )
      // {
      //     HienThiTTHopDongKH(tchopdong.LAY_DS_HOPDONG_THEO_MA_GD(txtMaGD.Text, LoaiHopDong.DAT_MOI, (int)tt_nd.donvi_id, TrangThaiHD.MOI, (int)tt_nd.nhanvien_id, 0));
      // }
      // else if ((txtMaGD.Text != "") && (f.loaihd_id == LoaiHopDong.TIEPNHAN_DATMOI))
      // {
      //     DataSet ds = new DataSet();
      //     ds = tchopdong.LAY_DS_HOPDONG_THEO_MA_GD(txtMaGD.Text, LoaiHopDong.TIEPNHAN_DATMOI, (int)tt_nd.donvi_id, TrangThaiHD.DA_THI_CONG_XONG, (int)tt_nd.nhanvien_id, tt_nd.donvi_dl_id);
      //     HienThiTTHopDongKH(ds);
      //     if (ds.Tables[0].Rows.Count > 0)
      //     {
      //         long vhdtb_id = 0;
      //         vhdtb_id = f.hdtb_id;
      //         txtMaGD.Focus();
      //         ds = tchopdong.LAY_DS_HOPDONG_TB_THEO_HDTB_ID_BC(vhdtb_id);
      //         HienThiTTHopDongTBTiepNhan(ds);
      //         txtMaGD.Text = "";
      //         dtpNgayLapHD.Value = tt_nd.ngay_cn;
      //         dtpNgayYeuCau.Value = tt_nd.ngay_cn;
      //         lvwThueBao.Items.Clear();
      //         lvwThanhToan.Items.Clear();
      //         txtMaTT.Text = "";
      //         txtMaTBDD.Text = "";
      //         cboMaDD.Properties.Items.Clear();
      //         cboMaDD.Text = "";
      //     }
      // }
      // else if ((txtMaGD.Text != "") && (f.loaihd_id == LoaiHopDong.KHAOSATDATMOI))
      // {
      //     DataSet ds = new DataSet();
      //     ds = tchopdong.LAY_DS_HOPDONG_THEO_MA_GD(txtMaGD.Text, LoaiHopDong.KHAOSATDATMOI, (int)tt_nd.donvi_id, TrangThaiHD.HOAN_THANH, (int)tt_nd.nhanvien_id, tt_nd.donvi_dl_id);

      //     if (ds.Tables[0].Rows.Count > 0)
      //     {
      //         if (bangts.KiemTra_TrangThaiKS(ds.Tables[0].Rows[0]["hdkh_id"].ToString()))
      //         {
      //             HienThiTTHopDongKH(ds);
      //             long vhdtb_id = 0;
      //             vhdtb_id = f.hdtb_id;
      //             txtMaGD.Focus();
      //             ds = tchopdong.LAY_DS_HOPDONG_TB_THEO_HDTB_ID_BC(vhdtb_id);
      //             HienThiTTHopDongTBTiepNhan(ds);
      //             txtMaGD.Text = "";
      //             dtpNgayLapHD.Value = tt_nd.ngay_cn;
      //             dtpNgayYeuCau.Value = tt_nd.ngay_cn;
      //             lvwThueBao.Items.Clear();
      //             lvwThanhToan.Items.Clear();
      //             txtMaTT.Text = "";
      //             txtMaTBDD.Text = "";
      //             cboMaDD.Properties.Items.Clear();
      //             cboMaDD.Text = "";
      //             hdkh_cha_id = Convert.ToInt64(ds.Tables[0].Rows[0]["hdkh_id"].ToString());
      //             hdkh_id = 0;
      //             hdtb_id = 0;
      //         }
      //     }
      // }
      // else if ((txtMaGD.Text != "") && (f.loaihd_id == LoaiHopDong.TIEPNHANHD))
      // {
      //     DataSet ds = new DataSet();
      //     ds = tchopdong.LAY_DS_HOPDONG_THEO_MA_GD(txtMaGD.Text, LoaiHopDong.TIEPNHANHD, 0, TrangThaiHD.HOAN_THANH, 0, 0);

      //     if (ds.Tables[0].Rows.Count > 0)
      //     {
      //         if (bangts.KiemTra_TrangThaiKS(ds.Tables[0].Rows[0]["hdkh_id"].ToString()))
      //         {
      //             HienThiTTHopDongKH(ds);
      //             hdkh_cha_id = Convert.ToInt64(ds.Tables[0].Rows[0]["hdkh_id"].ToString());
      //             long vhdtb_id = 0;
      //             vhdtb_id = f.hdtb_id;
      //             txtMaGD.Focus();
      //             ds = tchopdong.LAY_DS_HOPDONG_TB_THEO_HDTB_ID_BC(vhdtb_id);
      //             HienThiTTHopDongTBTiepNhan(ds);
      //             txtMaGD.Text = "";
      //             dtpNgayLapHD.Value = tt_nd.ngay_cn;
      //             dtpNgayYeuCau.Value = tt_nd.ngay_cn;
      //             lvwThueBao.Items.Clear();
      //             lvwThanhToan.Items.Clear();
      //             txtMaTT.Text = "";
      //             txtMaTBDD.Text = "";
      //             cboMaDD.Properties.Items.Clear();
      //             cboMaDD.Text = "";
      //             hdkh_id = 0;
      //             hdtb_id = 0;
      //         }
      //     }
      // }
    },
    maTTChanged() {
      // this.thanhtoan.matt = e.target.value
      if (this.thanhtoan.matt)
        API.post_lay_db_theo_matb(this.axios, { ma_tb: this.thanhtoan.matt, donvi_dl_id: 0, dichvuvt_id: 0 }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            //this.listbox.danhba.list=response.data.data;
            this.HienThiTT_DanhBa(response.data.data)
          }
        })
      // this.HienThiTT_DanhBa(tcdanhba.LAY_DB_THEO_MATB(txtMaTT.Text, 0, 0));
    },
    defaultCongNghe(newval) {
      if (newval && newval > 0) {
        if ((!this.listbox.congnghe.value || this.listbox.congnghe.value == 0) && this.listbox.kieu_ld.value && this.listbox.kieu_ld.value > 0 && this.listbox.congnghe.list != null && this.listbox.congnghe.list.length > 0) {
          var list = this.listbox.congnghe.list.filter((cn) => cn.kieuld_id == this.listbox.kieu_ld.value)
          if (list && list.length > 0) this.listbox.congnghe.value = list[0].congnghe_id
        }
      }
    },
    HienThi_NVQL_AM_HTTT() {
      //Convert.ToInt32(cboLoaiKH.EditValue), Loai_NV.NHANVIEN_KINHDOANH, phuongtt_id, phott_id, aptt_id, khutt_id, nhanvientc_id, Convert.ToInt32(cboDonViQL.SelectedValue), Convert.ToInt32(cboHTTT.EditValue)
      try {
        if (!this.kt_load) {
          var pdata = {
            vap_id: this.diachiTT.AP_ID,
            vdonviql_id: this.listbox.donvi_ql.valueql,
            vhttt_id: this.listbox.hinhthuc_tt.value,
            vkhu_id: this.diachiTT.KHU_ID,
            vloaikh_id: this.listbox.loai_kh.value,
            vloainv_id: Loai_NV.NHANVIEN_KINHDOANH,
            vnvtc_id: this.thanhtoan.nhanvientc_id,
            vpho_id: this.diachiTT.PHO_ID,
            vphuong_id: this.diachiTT.PHUONG_ID
          }
          API.post_lay_ds_nhanvien_ql_am_v2(this.axios, pdata).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              var rowData = response.data.data
              this.thanhtoan.manvql = rowData['ma_nv'] + ' - ' + rowData['ten_nv']
              this.nhanvien_ql_am_id = rowData['nhanvien_id']
            } else {
              this.thanhtoan.manvql = ''
              this.nhanvien_ql_am_id = 0
            }
          })
        }
      } catch (ex) {
        this.$toast.error('Có lỗi : ' + ex)
      }
    },
    HienThi_NVQL_AM() {
      //Convert.ToInt32(cboLoaiKH.EditValue), Loai_NV.NHANVIEN_KINHDOANH, phuongtt_id, phott_id, aptt_id, khutt_id, dacdiemtt_id, nhanvientc_id, Convert.ToInt32(cboDonViQL.SelectedValue)
      try {
        if (!this.kt_load) {
          var pdata = {
            PHANTAP_KH: this.PHANTAP_KH,
            PHUONG_ID: this.diachiTT.PHUONG_ID,
            PHO_ID: this.diachiTT.PHO_ID,
            AP_ID: this.diachiTT.AP_ID,
            KHU_ID: this.diachiTT.KHU_ID,
            DACDIEM_ID: this.diachiTT.DACDIEM_ID,
            LOAIKH_ID: this.listbox.loai_kh.value,
            NGANHNGHELOC_ID: this.listbox.nganhngheloc.value,
            CBO_DONVIQL_ID: this.listbox.donvi_ql.valueql,
            NVTC_ID: this.thanhtoan.nhanvientc_id,
            DONVIQL_ID: this.listbox.donvi_ql.valueql,
            KHACHHANG_ID: this.khachhang.khachhang_id,
            LOAINV_ID: Loai_NV.NHANVIEN_AM
          }
          API.post_fn_lay_tt_nvql_am(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              var rowData = JSON.parse(response.data.data)
              if (rowData['ERROR_CODE'] != -1) {
                this.thanhtoan.manvql = rowData['RESULT']['TXT_NV_QL']
                this.nhanvien_ql_am_id = rowData['RESULT']['NHANVIEN_QL_AM_ID']
              } else this.$toast.error('' + rowData['MESSAGE'])
            } else {
              this.thanhtoan.manvql = ''
              this.nhanvien_ql_am_id = 0
            }
          })
        }
      } catch (ex) {
        this.$toast.error('Có lỗi : ' + ex)
      }
    },
    ChuyenTrang(page, param) {
      this.$router.push({ name: page, params: param })
    },
    PopupTrang(page, param) {
      const routeData = this.$router.resolve({name: page, params: param});
      window.open(routeData.href, '_blank');
    },
    tsbtnRequestChange_Click() {
      this.PopupTrang('ChangeCustomerInfor',{tag:0,hdkh_id:this.khachhang.hdkh_id});
    },
    tsbtnApproveChange_Click() {
      this.PopupTrang('ChangeCustomerInfor',{tag:1,hdkh_id:this.khachhang.hdkh_id});
    },
    XuLyDonViQL(ds) {
      if(this.$root.token.getPhanVungID()==97) return;
      if (!ds || ds.length <= 0) {
        if (this.listbox.donvi_ql.list.length != 1) {
          this.$toast.error('Địa danh này chưa được gán đơn vị quản lý địa chỉ thanh toán. Hãy liên hệ với Admin để xử lý!')
          return
        }
      } else if (ds.length == 1) {
        this.listbox.donvi_ql.valueql = ds[0]['DONVI_ID']
        this.LoadNVThuCuoc()
      } else {
        this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonGrid')
        this.popupComponentName = 'popupChonDVQL'
        this.popupComponentData = {
          ds: ds,
          cols: [
            { fieldName: 'DONVIQL_ID', headerText: 'ID', allowFiltering: false, allowSorting: false },
            { fieldName: 'TEN_DVQL', headerText: 'Đơn vị', allowFiltering: false, allowSorting: false },
            { fieldName: 'TEN_DV', headerText: 'Tổ thi công', allowFiltering: false, allowSorting: false }
          ],
          keycol: 'DONVIQL_ID',
          allowExit: false,
          tieude: 'Chọn đơn vị quản lý',
          tieudebang: 'Danh sách đơn vị'
        }
        this.Popup('popupComponents')
      }
    },
    XuLyDonViLD(ds) {
      if(this.$root.token.getPhanVungID()==97) return;
      if (!ds || ds.length <= 0) {
        if (this.listbox.donvi_ql.list.length != 1) {
          this.$toast.error('Địa danh này chưa được gán đơn vị quản lý địa chỉ. Hãy liên hệ với Admin để xử lý!')
          if(this.$root.token.getPhanVungID()!=98)
            this.listbox.donvi_ql.value = null
          return
        }
      } else if (ds.length == 1) {
        this.listbox.donvi_ql.value = ds[0]['DONVIQL_ID']
        if (ds[0]['DONVI_ID'])
          for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
            if (this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.TRAM_VT || this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.TRAM_CAP_PORT) {
              var dl = this.DT_DV(i).filter((x) => x.id == ds[0]['DONVI_ID'])
              if (dl && dl.length > 0) this.DT_CONTROLS.value[i] = ds[0]['DONVI_ID']
            }
          }
        // this.HT_GIAODIEN_DONVI();
      } else {
        this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonGrid')
        this.popupComponentName = 'popupChonDVLD'
        this.popupComponentData = {
          ds: ds,
          cols: [
            { fieldName: 'DONVIQL_ID', headerText: 'ID', allowFiltering: false, allowSorting: false },
            { fieldName: 'TEN_DVQL', headerText: 'Đơn vị', allowFiltering: false, allowSorting: false },
            { fieldName: 'TEN_DV', headerText: 'Tổ thi công', allowFiltering: false, allowSorting: false }
          ],
          keycol: 'DONVIQL_ID',
          allowExit: false,
          tieude: 'Chọn đơn vị lắp đặt',
          tieudebang: 'Danh sách đơn vị'
        }
        this.Popup('popupComponents')
      }
    },
    nganhangTTChanged(val) {
      if (!val) return
      this.listbox.nganhang.isnganhangnn = this.listbox.nganhang.list.filter((x) => x.nganhang_id == val)[0].loai_nh == 2
      if (this.listbox.nganhang.isnganhangnn) this.$bvModal.show('modal-nganhangnn')
    },
    popupTieuNganh() {
      if (!this.watcherActive) return
      this.popupComponent = () => import('../InstallNewSubs/Popups/popupTieuNganh')
      this.popupComponentName = 'popupTieuNganh'
      this.popupComponentData = { vnganhnghe_id: this.listbox.nganhngheloc.value, tieunganh: this.tieunganh }
      this.Popup('popupComponents')
      // this.$bvModal.show('modal-tieunganh');
      // API.post_lay_ds_tieunganh(this.axios, { "vkieu":1, "vnganhnghe_id": this.listbox.nganhngheloc.value, "vtc_id": 0 }).then((response) => {
      //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //     this.tieunganh.dsTNC1 = response.data.data;
      //     if(this.tieunganh.dsTNC1 && this.tieunganh.dsTNC1.length>0) this.tieunganh.TNC1_ID = this.tieunganh.dsTNC1[0].tnc1_id;
      //   }
      //   else { this.tieunganh.dsTNC1 = []; this.tieunganh.TNC1_ID = 0; }
      // });
    },
    popupDVCongThem() {
      //this.popupComponent = () => import('../InstallNewSubs/Popups/popupServiceAdds')
      this.popupComponent = () => import('./Popups/popupServiceAdds')
      this.popupComponentName = 'popupServiceAdds'
      this.popupComponentData = { _loaitb_id: this.listbox.loaihinh_tb.value, _hdtb_id: this.hdtb_id, _linhvuc_id: 0, _tocdo_id: this.tocdo_id, lvDvgt: this.m_dsThueBao_DichVu.filter((x) => x.dangky), m_dsThueBao_DichVu: this.m_dsThueBao_DichVu }
      this.Popup('popupComponents')
    },
    popupDVKhac() {
      this.popupComponent = () => import('../InstallNewSubs/Popups/popupServiceOthers')
      this.popupComponentName = 'popupServiceOthers'
      this.popupComponentData = { _loaitb_id: this.listbox.loaihinh_tb.value, _loai_id: 1, _thanhtoan_id: this.thanhtoan.thanhtoan_id } //default trong code cu, loai_id=1, thanhtoan_id=0
      if (this.dsDK_DVK_TB && this.dsDK_DVK_TB.length > 0) this.popupComponentData.ds = this.dsDK_DVK_TB
      this.Popup('popupComponents')
    },
    popupDVKhacTT() {
      this.popupComponent = () => import('../InstallNewSubs/Popups/popupServiceOthers')
      this.popupComponentName = 'popupServiceOthersTT'
      this.popupComponentData = { _loaitb_id: this.listbox.loaihinh_tb.value, _loai_id: 2, _thanhtoan_id: this.thanhtoan.thanhtoan_id } //default trong code cu, loai_id=1, thanhtoan_id=0
      if (this.dsDK_DVK_TT && this.dsDK_DVK_TT.length > 0) this.popupComponentData.ds = this.dsDK_DVK_TT
      this.Popup('popupComponents')
    },
    popupMuaTB() {
      this.popupComponent = () => import('../InstallNewSubs/Popups/popupBuyDevices')
      this.popupComponentName = 'popupBuyDevices'
      this.popupComponentData = { _loaitb_id: this.listbox.loaihinh_tb.value }
      if (this.dsCTM_TBI && this.dsCTM_TBI.length > 0) this.popupComponentData.ds = this.dsCTM_TBI
      this.Popup('popupComponents')
    },
    popupChonKhuVuc() {
      if (!this.diachiLD.QUAN_ID || this.diachiLD.QUAN_ID <= 0 || !this.diachiLD.PHUONG_ID || this.diachiLD.PHUONG_ID <= 0) {
        this.$toast.error('Chưa có thông tin về địa chỉ lắp đặt. Bạn hãy kiểm tra lại!')
        return
      }
      this.popupComponent = () => import('../InstallNewSubs/Popups/popupGanKhuVucQuanLyThueBao')
      this.popupComponentName = 'popupChonKhuVuc'
      this.popupComponentData = { diachi: this.diachiLD, khuvuc_id: this.thuebao.khuvuc_id, hdtb_id: this.hdtb_id, thuebao_id: this.thuebao.thuebao_id, donvi_id: this.listbox.donvi_ql.value }
      //if(this.dsCTM_TBI && this.dsCTM_TBI.length>0) this.popupComponentData.ds = this.dsCTM_TBI;
      this.Popup('popupComponents')
    },
    popupDSHuongKN() {
      this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSHuongKN' + (this.thamsomacdinh['SD_FRMDSHUONGKN_V2'] == 1 ? 'V2' : ''))
      this.popupComponentName = 'popupDSHuongKN'
      this.popupComponentData = { kieu: this.listbox.chu_quan.valuewan == 9 ? 0 : 1, dichvuvt_id: this.listbox.dichvu_vt.value, tinhkn_id: this.listbox.tinh_kn.value } // O day dung enums CHUQUAN.VNPT_TINH nhung chi co 1 gia tri duy nhat = 9 nen loai bo enums luon!
      this.Popup('popupComponents')
    },
    async popupTienKM() {
      let ds = []
      if (this.thamsomacdinh['HT_KMTT'] && this.thamsomacdinh['HT_KMTT'] == 1) {
        await API.post_lay_ds_tien_kmtt(this.axios, { vkieuld_id: this.listbox.kieu_ld.value, vloaihd_id: LoaiHopDong.DAT_MOI, vloaitb_id: this.listbox.loaihinh_tb.value }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            ds = response.data.data
            if (this.ds_tien_khoanmuc && this.ds_tien_khoanmuc.length > 0)
              for (let item of ds) {
                let items = this.ds_tien_khoanmuc.filter((x) => x.khoanmuctt_id == item.khoanmuctt_id)
                if (items && items.length > 0) {
                  item.tien = items[0].tien
                  item.vat = items[0].vat
                  item.tongtien = item.tien + item.vat
                }
              }
          }
        })
        this.popupComponentData = {
          ds: ds,
          cols: [
            { fieldName: 'tentat_kmtt', headerText: 'Khoản mục', allowFiltering: false, allowSorting: false, isPrimaryKey: true },
            { fieldName: 'tongtien', textAlign: 'right', allowEditing: true, editType: 'numericedit', format: 'N', customAttributes: { class: 'tongtien' }, headerText: 'Tổng tiền', allowFiltering: false, allowSorting: false, edit: 'tongtienParam' },
            { fieldName: 'tien', textAlign: 'right', allowEditing: true, editType: 'numericedit', format: 'N', customAttributes: { class: 'cuoclapdat' }, headerText: 'Tiền', allowFiltering: false, allowSorting: false, edit: 'tienParam' },
            { fieldName: 'vat', textAlign: 'right', format: 'N', customAttributes: { class: 'vatlapdat' }, headerText: 'Vat', allowFiltering: false, allowSorting: false },
            { fieldName: 'tyle_vat', textAlign: 'right', format: 'N', headerText: 'Tỷ lệ vat', allowFiltering: false, allowSorting: false }
          ],
          keycol: 'khoanmuctt_id',
          allowExit: false,
          tieude: 'Chi tiết tiền khoản mục',
          tieudebang: 'Chi tiết khoản mục thanh toán',
          vkieuld_id: this.listbox.kieu_ld.value,
          vloaihd_id: LoaiHopDong.DAT_MOI,
          vloaitb_id: this.listbox.loaihinh_tb.value,
          ds_tien_caidat: this.ds_tien_khoanmuc,
          m_dsTienCTKM: this.m_dsTienCTKM,
          is_nv_vnpti: this.kiemtra_nhanvien_vti //TODO xem them cho nay o popup, kha nang se khong round tien./
        }

        this.popupComponentName = 'popupCT_TienKM'
        this.popupComponent = () => import('../InstallNewSubs/Popups/popupCT_TienKM')
        this.Popup('popupComponents')
      } else {
        await API.post_lay_khoanmuc_tt_theo_loaihd(this.axios, { vloaihd_id: LoaiHopDong.DAT_MOI }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            ds = response.data.data
            if (this.ds_tien_khoanmuc && this.ds_tien_khoanmuc.length > 0)
              for (let item of ds) {
                let items = this.ds_tien_khoanmuc.filter((x) => x.khoanmuctt_id == item.khoanmuctt_id)
                if (items && items.length > 0) {
                  item.tien = items[0].tien ? items[0].tien : 0
                  item.vat = items[0].vat ? items[0].vat : 0
                  item.tongtien = item.tien + item.vat
                }
              }
          }
        })
        this.popupComponentData = {
          ds: ds,
          cols: [
            { fieldName: 'tentat_kmtt', headerText: 'Khoản mục', allowFiltering: false, allowSorting: false, isPrimaryKey: true },
            { fieldName: 'tongtien', textAlign: 'right', allowEditing: true, editType: 'numericedit', format: 'N', customAttributes: { class: 'tongtien' }, headerText: 'Tổng tiền', allowFiltering: false, allowSorting: false, edit: 'tongtienParam' },
            { fieldName: 'tien', textAlign: 'right', allowEditing: true, editType: 'numericedit', format: 'N', customAttributes: { class: 'cuoclapdat' }, headerText: 'Tiền', allowFiltering: false, allowSorting: false, edit: 'tienParam' },
            { fieldName: 'vat', textAlign: 'right', format: 'N', customAttributes: { class: 'vatlapdat' }, headerText: 'Vat', allowFiltering: false, allowSorting: false }
          ],
          keycol: 'khoanmuctt_id',
          allowExit: false,
          tieude: 'Chi tiết tiền khoản mục',
          tieudebang: 'Chi tiết khoản mục thanh toán'
        }
        this.popupComponentName = 'popupTienKM'
        this.popupComponent = () => import('../InstallNewSubs/Popups/popupTienKM')
        this.Popup('popupComponents')
      }
      // var ds = [];
      // if(this.thamsomacdinh["HT_KMTT"] && this.thamsomacdinh["HT_KMTT"]==1) {
      //   await API.post_lay_ds_tien_kmtt(this.axios, { "vkieuld_id": this.listbox.kieu_ld.value, "vloaihd_id": LoaiHopDong.DAT_MOI, "vloaitb_id": this.listbox.loaihinh_tb.value }).then((response) => {
      //     if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //       ds = response.data.data;
      //       if(this.ds_tien_khoanmuc && this.ds_tien_khoanmuc.length>0)
      //         for(var item of ds) {
      //           var items = this.ds_tien_khoanmuc.filter(x=>x.khoanmuctt_id==item.khoanmuctt_id);
      //           if(items && items.length>0) {
      //             item.tien = items[0].tien;
      //             item.vat  = items[0].vat;
      //             item.tongtien = item.tien+item.vat;
      //           }
      //         }
      //     }
      //   });
      //   this.popupComponentData = {"ds":ds,cols:[
      //     {fieldName: 'tentat_kmtt', headerText: 'Khoản mục', allowFiltering: false, allowSorting: false, isPrimaryKey:true},
      //     {fieldName: 'tongtien', textAlign:'right', allowEditing:true, editType: 'numericedit', format:'N', customAttributes:{class: 'tongtien'},  headerText: 'Tổng tiền', allowFiltering: false, allowSorting: false, edit:"tongtienParam"},
      //     {fieldName: 'tien', textAlign:'right', allowEditing:true, editType: 'numericedit', format:'N', customAttributes:{class: 'cuoclapdat'},  headerText: 'Tiền', allowFiltering: false, allowSorting: false, edit:"tienParam"},
      //     {fieldName: 'vat', textAlign:'right', format:'N', customAttributes:{class: 'vatlapdat'}, headerText: 'Vat', allowFiltering: false, allowSorting: false},
      //     {fieldName: 'tyle_vat', textAlign:'right', format:'N', headerText: 'Tỷ lệ vat', allowFiltering: false, allowSorting: false},
      //   ],keycol: "khoanmuctt_id",allowExit:false,tieude:"Chi tiết tiền khoản mục",tieudebang:"Chi tiết khoản mục thanh toán",}
      // }
      // else {
      //   await API.post_lay_khoanmuc_tt_theo_loaihd(this.axios, { "vloaihd_id": LoaiHopDong.DAT_MOI }).then((response) => {
      //     if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //       ds = response.data.data;
      //       if(this.ds_tien_khoanmuc && this.ds_tien_khoanmuc.length>0)
      //         for(var item of ds) {
      //           var items = this.ds_tien_khoanmuc.filter(x=>x.khoanmuctt_id==item.khoanmuctt_id);
      //           if(items && items.length>0) {
      //             item.tien = items[0].tien?items[0].tien:0;
      //             item.vat  = items[0].vat?items[0].vat:0;
      //             item.tongtien = item.tien+item.vat;
      //           }
      //         }
      //     }
      //   });
      //   this.popupComponentData = {"ds":ds,cols:[
      //     {fieldName: 'tentat_kmtt', headerText: 'Khoản mục', allowFiltering: false, allowSorting: false, isPrimaryKey:true},
      //     {fieldName: 'tongtien', textAlign:'right', allowEditing:true, editType: 'numericedit', format:'N', customAttributes:{class: 'tongtien'},  headerText: 'Tổng tiền', allowFiltering: false, allowSorting: false, edit:"tongtienParam"},
      //     {fieldName: 'tien', textAlign:'right', allowEditing:true, editType: 'numericedit', format:'N', customAttributes:{class: 'cuoclapdat'},  headerText: 'Tiền', allowFiltering: false, allowSorting: false, edit:"tienParam"},
      //     {fieldName: 'vat', textAlign:'right', format:'N', customAttributes:{class: 'vatlapdat'}, headerText: 'Vat', allowFiltering: false, allowSorting: false},
      //   ],keycol: "khoanmuctt_id",allowExit:false,tieude:"Chi tiết tiền khoản mục",tieudebang:"Chi tiết khoản mục thanh toán",}
      // }
      // this.popupComponentName = "popupTienKM";
      // this.popupComponent = ()=>import('../InstallNewSubs/Popups/popupTienKM');
      // this.Popup('popupComponents');
    },
    async tsbtnThemTB_Click() {
      this.loading(true)
      // ThangDM1 bo sung kiem tra tu nut ghi lai 20231003
      if(this.listbox.dichvu_vt.value==DichVuVienThong.DI_DONG && this.listbox.loaihinh_tb.value==LoaiHinhTB.HoaMangChuyenTinh) {
        this.$toast.error("Không hỗ trợ thêm thuê bao với loại hình di động hoà mạng chuyển tỉnh!");
        this.loading(false)
        return;
      }
      var dichvuvt_id = this.listbox.dichvu_vt.value
      if (dichvuvt_id == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
        if (
          !this.thongso_ban.muccuoctb_id ||
          !this.thuebao.tsl.thongso_tc_dau.muccuoctb_id ||
          !this.thuebao.tsl.thongso_tc_cuoi.muccuoctb_id
        ) {
          this.$toast.error('Bạn cần chọn các thông số kỹ thuật bằng cách chọn thông số đầu, thông số cuối !')
          this.loading(false)
          return
        }
      } else if (dichvuvt_id != DichVuVienThong.DICHVU_CNTT && dichvuvt_id != DichVuVienThong.TRUNGTAM_DULIEU && dichvuvt_id != DichVuVienThong.HOINGHI_TRUYENHINH && dichvuvt_id != DichVuVienThong.ANTOAN_BAOMAT_TT) {
        if (!this.thongso_ban.muccuoctb_id || !this.thongso_tc.muccuoctb_id) {
          this.$toast.error('Bạn cần chọn các thông số kỹ thuật bằng cách chọn lại kiểu yêu cầu !')
          this.loading(false)
          return
        }
      } else {
        //FIXME phan nay chua xu ly
        if (!this.thongso_ban.thongso_cntt) {
          this.$toast.error('Bạn cần chọn các thông số kỹ thuật bằng cách chọn lại kiểu yêu cầu !')
          this.loading(false)
          return
        }
      }
      // END ThangDM1 bo sung kiem tra tu nut ghi lai 20231003
      //TODO bo qua 17528 - 17539 do khong lien quan phan CO_DINH
      if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH && this.thuebao.codinh.arraySoMay && this.thuebao.codinh.arraySoMay.length > 0)
        //for(var sm of this.thuebao.codinh.arraySoMay) {
        while (this.thuebao.codinh.arraySoMay && this.thuebao.codinh.arraySoMay.length > 0) {
          this.thuebao.codinh.somay = this.thuebao.codinh.arraySoMay.pop()
          await this.ThemHDThueBao()
        }
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH && (!this.thuebao.codinh.arraySoMay || this.thuebao.codinh.arraySoMay.length <= 0)) {
        this.$toast.error('Bạn cần chọn danh sách số máy cần thêm thuê bao!')
        this.ShowPopupChonSM()
      } else {
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IMS_SIPTRUNKING && this.thuebao.ims.arraySoMay && this.thuebao.ims.arraySoMay.length > 0)
          for (var sm of this.thuebao.ims.arraySoMay) {
            this.thuebao.ims.txtMaTBIMS = sm
            this.ThemHDThueBao()
          }
        else this.ThemHDThueBao()
      }
      this.loading(false)
    },
    async ThemHDThueBao() {
      try {
        var tocdotn_id = 0
        var muccuoctn_id = 0
        let KT_KVNLML = 1
        //TODO bo qua 10549 - 10593 do khong lien quan phan CO_DINH
        //trien khai luon cua LayMaTB(true)
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
          await this.SinhMaDVVT_BC()
          // if (fiber_hoa)
          //     txtAccountADSL.Text = txtAccountADSL.Text.ToUpper();
        }
        if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
          await this.SinhMaDVVT_BC()
          tocdotn_id = this.listbox.tocdokenh.valuecir
        } else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC) tocdotn_id = this.listbox.tocdokenh.valuetsl
        //Convert.ToInt32(cboTocDoKenhTSL.EditValue);
        else if (
          this.listbox.dichvu_vt.value == DichVuVienThong.ADSL ||
          this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES ||
          this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC ||
          this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT ||
          this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU ||
          this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH ||
          this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT
        ) {
          tocdotn_id = this.listbox.cboGoiCuocAdsl.value
          if (
            this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_MYTV &&
            // ANh Hiếu bảo thêm
            this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_MYTV_B2B &&
            this.listbox.dichvu_vt.value != DichVuVienThong.HOINGHI_TRUYENHINH &&
            this.listbox.dichvu_vt.value != DichVuVienThong.ANTOAN_BAOMAT_TT &&
            this.listbox.dichvu_vt.value != DichVuVienThong.TRUNGTAM_DULIEU &&
            this.listbox.dichvu_vt.value != DichVuVienThong.DICHVU_CNTT &&
            this.listbox.dichvu_vt.value != DichVuVienThong.BRCD_DOITAC &&
            this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_SGTV &&
            this.listbox.loaihinh_tb.value != LoaiHinhTB.HTVC_FIBERVNN_ANALOG &&
            this.listbox.loaihinh_tb.value != LoaiHinhTB.HTVC_FIBERVNN_DIGITAL &&
            this.listbox.loaihinh_tb.value != LoaiHinhTB.TIVI_SAMSUNG
          ) {
            muccuoctn_id = this.listbox.muccuoc.value
          }
        }
        await this.LayMaTB(true)
        await this.LayMaTBBC(true)
        if (!(await this.KiemTraDL_ThueBao(true))) return
        if (!this.ngaySinhChanged()) return
        // this.ma_tb_ht = this.thuebao.codinh.somay;

        var j_loaikenh_id = 0
        if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) j_loaikenh_id = this.listbox.loaikenh.value
        else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) j_loaikenh_id = this.listbox.loaikenh.valuetsl
        else j_loaikenh_id = 0

        // var pdata = {
        //   KHACHHANG_ID: this.khachhang.khachhang_id,
        //   DOITUONG_ID: this.listbox.doituong.value,
        //   LOAIKH_ID: this.listbox.loai_kh.value,
        //   LOAITB_ID: this.listbox.loaihinh_tb.value,
        //   HDKH_ID: this.khachhang.hdkh_id,
        //   JS_TRATRUOC: [],
        //   JS_LIST: [],
        //   JS_MUA_TBI: [],
        //   THEMMOI: true,//this.buttonSet == 1,
        //   KIEULD_ID: this.listbox.kieu_ld.value,
        //   SOMAY_CD: this.thuebao.codinh.somay,
        //   DICHVUVT_ID: this.listbox.dichvu_vt.value,
        //   TINHKHAC: this.thuebao.tinhkhac,
        //   MA_TB_HT: this.ma_tb_ht,
        //   TTND_DVI: 1,
        //   TUDONG_SINH_SOAO: this.TUDONG_SINH_SOAO ? 1 : 0,
        //   MA_TB_AO_HT: this.ma_tb_ao_ht,
        //   MA_TB_AO_HT_CUOI: this.ma_tb_ao_ht_cuoi,
        //   SOAO_ADSL: this.thuebao.adsl.txtSoAoAdsl,
        //   SOAO_TSL_DAU: this.thuebao.tsl.txtSoAoTSL_Dau,
        //   SOAO_TSL_CUOI: this.thuebao.tsl.txtSoAoTSL_Cuoi,
        //   SOAO_WAN: this.thuebao.mgwan.soao,
        //   OPEN_SYNC_VINA_TRASAU: TRANGTHAI_DONGBO.OPEN_SYNC_VINA_TRASAU ? 1 : 0,
        //   MA_TT: this.thanhtoan.matt ? this.thanhtoan.matt : null,
        //   BATBUOC_GHEP_MATT: this.thamsomacdinh['BATBUOC_GHEP_MATT'],
        //   KIEMTRA_GHEP_MATT_CNTT: this.thamsomacdinh['KIEMTRA_GHEP_MATT_CNTT'],
        //   TOCDOTN_ID: tocdotn_id,
        //   MUCCUOCTN_ID: muccuoctn_id,
        //   LOAIKENH_ID: j_loaikenh_id,
        //   BANCHEO: 1,
        // }
        // await API.post_fn_kt_laytt_capnhat_datmoi(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
        //   if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
        //     var dulieuapi = JSON.parse(response.data.data)
        //     if (dulieuapi['ERROR_CODE'] != 1) {
        //       this.$toast.error(dulieuapi['MESSAGE'])
        //       throw dulieuapi['MESSAGE'];
        //     }
        //     if (dulieuapi['RESULT']) dulieuapi = dulieuapi['RESULT']
        //     if (dulieuapi['KT_KVNLML']) KT_KVNLML = dulieuapi['KT_KVNLML']
        //     if (dulieuapi['KIEMTRA_DK_APDUNG']) KIEMTRA_DK_APDUNG = dulieuapi['KIEMTRA_DK_APDUNG']
        //   }
        // })
        // UPDATE 20230711'

        let p1data = {
          FIBER_BS: this._fiberBoSung,
          KIEULD_ID: this.listbox.kieu_ld.value,
          CONGNGHE_ID: this.listbox.congnghe.value,
          MATB_TN: this.thuebao.adsl.txtMaTN_ADSL,
          TINHKHAC: this.TinhKhac,
          HDKH_ID: this.khachhang.hdkh_id,
          MA_TB_HT: this.ma_tb_ht,
          MA_TB_HT_AO: this.ma_tb_ao_ht,
          MATB_WAN: this.thuebao.mgwan.somay,
          TOCDOTN_ID: tocdotn_id,
          MUCCUOCTN_ID: muccuoctn_id,
          LOAITB_ID: this.listbox.loaihinh_tb.value,
          DICHVUVT_ID: this.listbox.dichvu_vt.value,
          TTND_DVI: this.$root.token.getDonViID(),
          SOAO_ADSL: this.thuebao.adsl.txtSoAoAdsl,
          DOITUONG_ID: this.listbox.doituong.value,
          GOICUOCADSL: this.listbox.cboGoiCuocAdsl.value,
          DONVI_QL_ID: this.listbox.donvi_ql.value,
          NGAY_YC: this.NgayYeuCau ? this.NgayYeuCau.substring(3, 10) : this.NgayYeuCau,
          SOAO_TSL_DAU: this.thuebao.tsl.txtSoAoTSL_Dau,
          SOAO_TSL_CUOI: this.thuebao.tsl.txtSoAoTSL_Cuoi,
          SOAO_WAN: this.thuebao.mgwan.soao,
          HDTB_ID: this.hdtb_id ? this.hdtb_id : 0,
          TRANGBI_ID: this.trangbi_id,
          LOAIKH_ID: this.listbox.loai_kh.value,
          KHACHHANG_ID: this.khachhang.khachhang_id,
          DONGBO_TEST: this.DONGBO_TEST.TEST,
          TINHTHICONG_ID: this.tinh.tinhthicong_id,
          TC_TOCDOTN_ID: this.thongso_tc.tocdo_id,
          TC_MUCCUOCTN_ID: this.thongso_tc.muccuoc_id,
          TC_KIEULD_ID: this.thongso_tc.kieuld_id,
          LOAIKENH_ID: j_loaikenh_id,
          BANCHEO: 1
        }
        let dulieuapi = {}
        let err = await API.post_fn_lay_tt_them_thuebao_datmoi(this.axios, { ds_para: JSON.stringify(p1data) }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            dulieuapi = JSON.parse(response.data.data)
            if (dulieuapi['ERROR_CODE'] == 0) {
              this.$toast.error(dulieuapi['MESSAGE'])
              return 'err'
            }
            if (dulieuapi['RESULT']) dulieuapi = dulieuapi['RESULT']
            if (dulieuapi['KT_KV_NLML']) KT_KVNLML = dulieuapi['KT_KV_NLML']
            if (KT_KVNLML && KT_KVNLML != 'ok' && KT_KVNLML != 1) {
              let cfr = await this.$bvModal
                .msgBoxConfirm(`${KT_KVNLML + ''} "\r\nBạn có muốn thay đổi địa chỉ để tiếp tục?`, {
                  title: 'Thông báo',
                  size: 'sm',
                  okTitle: 'Đồng ý',
                  cancelTitle: 'Hủy'
                })
                .then((v) => {
                  return v
                })
              if (cfr) {
                if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
                  // VDCService vdc = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
                  // vdc.HuyDatChoMegaVNN(txtAccountADSL.Text);
                  await vdc.HuyDatChoMegaVNN(this.thuebao.adsl.txtAccountADSL)
                }

                // this.buttonSet = 0

                // this.$toast.success('Hợp đồng đã được thoái trả. Khách hàng sẽ được đưa vào danh sách Khách hàng tiềm năng!')
                return 'err'
              } else KT_KVNLML = 0
            } else KT_KVNLML = 1
            if (dulieuapi['KIEMTRA_DK_APDUNG']) KIEMTRA_DK_APDUNG = dulieuapi['KIEMTRA_DK_APDUNG']
            return null
          }
        })
        if (err && err == 'err') return

        if (dulieuapi['DS_HUONGGIAO_TN'] && dulieuapi['DS_HUONGGIAO_TN'].length > 0) {
          if (dulieuapi['DS_HUONGGIAO_TN'][0].QUYTRINH_ID) this.quytrinh_tn = dulieuapi['DS_HUONGGIAO_TN'][0].QUYTRINH_ID
          if (dulieuapi['DS_HUONGGIAO_TN'][0].LUONG_ID) this.luong_id = dulieuapi['DS_HUONGGIAO_TN'][0].LUONG_ID
          if (dulieuapi['DS_HUONGGIAO_TN'][0].HUONGGIAO_ID) this.huonggiao_tn = dulieuapi['DS_HUONGGIAO_TN'][0].HUONGGIAO_ID
        } else {
          var ds = await API.post_layhuonggiao_tiepnhan_v2(this.axios, {
            dichvuvt_id: this.listbox.dichvu_vt.value,
            kieuld_id: this.listbox.kieu_ld.value,
            loaihd_id: LoaiHopDong.DAT_MOI,
            loaikenh_id: j_loaikenh_id,
            loaitb_id: this.listbox.loaihinh_tb.value,
            muccuoc_id: muccuoctn_id ? muccuoctn_id : 0,
            phanvung_id: this.$root.token.getPhanVungID(),
            tocdo_id: this.tocdo_id ? this.tocdo_id : 0
          })
            .then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data
              }
            })
            .catch(() => {
              return []
            }) //bangts.LayHuongGiao_TiepNhan_V2(LoaiHopDong.DAT_MOI, Convert.ToInt32(cboLoaihinhTB.SelectedValue),
          //tocdotn_id, muccuoctn_id, Convert.ToInt32(cboKieuLD.SelectedValue), j_loaikenh_id, this.listbox.dichvu_vt.value);

          if (!ds || ds.length <= 0) {
            this.$toast.error('Nghiệp vụ này chưa được thiết lập quy trình. Bạn hãy liên hệ Admin để xử lý!')
            return
          }
          this.huonggiao_tn = 0
          this.quytrinh_tn = 0

          this.huonggiao_tn = ds[0]['huonggiao_id']
          this.quytrinh_tn = ds[0]['quytrinh_id']
        }

        if (dulieuapi['DS_HUONGGIAO_TC'] && dulieuapi['DS_HUONGGIAO_TC'].length > 0) {
          if (dulieuapi['DS_HUONGGIAO_TC'][0].QUYTRINH_ID) this.quytrinh_tc_tn = dulieuapi['DS_HUONGGIAO_TC'][0].QUYTRINH_ID
          if (dulieuapi['DS_HUONGGIAO_TC'][0].LUONG_ID) this.luong_tc_id = dulieuapi['DS_HUONGGIAO_TC'][0].LUONG_ID
          if (dulieuapi['DS_HUONGGIAO_TC'][0].HUONGGIAO_ID) this.huonggiao_tc_tn = dulieuapi['DS_HUONGGIAO_TC'][0].HUONGGIAO_ID
        } else {
          // Lấy hướng giao, quy trình tại tỉnh lắp đặt
          var rs_qt = await bancheo.LayHuongGiao_TiepNhan(this.tinh.tinhthicong_id, LoaiHopDong.DAT_MOI, this.listbox.loaihinh_tb.value, this.thongso_tc.tocdo_id, this.thongso_tc.muccuoc_id, this.thongso_tc.kieuld_id)
          if (!rs_qt || rs_qt.length <= 0) {
            this.$toast.error('Nghiệp vụ này chưa được thiết lập quy trình ở tỉnh Thi Công. Liên hệ Admin để xử lý')
            return
          }
          this.quytrinh_tc_tn = 0
          this.huonggiao_tc_tn = 0
          this.quytrinh_tc_tn = rs_qt[0]['quytrinh_id']
          this.huonggiao_tc_tn = rs_qt[0]['huonggiao_id']
        }

        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          // Lấy hướng giao, quy trình tại điểm đầu
          var rs_qt_dau = await bancheo.LayHuongGiao_TiepNhan(this.thuebao.tsl.tinh_dau.tinhthicong_id, LoaiHopDong.DAT_MOI, this.listbox.loaihinh_tb.value, this.thuebao.tsl.thongso_tc_dau.tocdo_id, this.thuebao.tsl.thongso_tc_dau.muccuoc_id, this.thuebao.tsl.thongso_tc_dau.kieuld_id)

          if (!rs_qt_dau || rs_qt_dau.length <= 0) {
            this.$toast.error('Nghiệp vụ này chưa được thiết lập quy trình ở tỉnh Thi Công điểm đầu. Liên hệ Admin để xử lý')
            return
          }
          this.thuebao.tsl.quytrinh_tc_tn_dau = 0
          this.thuebao.tsl.huonggiao_tc_tn_dau = 0
          this.thuebao.tsl.quytrinh_tc_tn_dau = rs_qt_dau[0]['quytrinh_id'] * 1
          this.thuebao.tsl.huonggiao_tc_tn_dau = rs_qt_dau[0]['huonggiao_id'] * 1

          // Lấy hướng giao, quy trình tại điểm cuối
          var rs_qt_cuoi = await bancheo.LayHuongGiao_TiepNhan(this.thuebao.tsl.tinh_cuoi.tinhthicong_id, LoaiHopDong.DAT_MOI, this.listbox.loaihinh_tb.value, this.thuebao.tsl.thongso_tc_cuoi.tocdo_id, this.thuebao.tsl.thongso_tc_cuoi.muccuoc_id, this.thuebao.tsl.thongso_tc_cuoi.kieuld_id)
          if (!rs_qt_cuoi || rs_qt_cuoi.length <= 0) {
            this.$toast.error('Nghiệp vụ này chưa được thiết lập quy trình ở tỉnh Thi Công điểm cuối. Liên hệ Admin để xử lý')
            return
          }
          this.thuebao.tsl.quytrinh_tc_tn_cuoi = 0
          this.thuebao.tsl.huonggiao_tc_tn_cuoi = 0
          this.thuebao.tsl.quytrinh_tc_tn_cuoi = rs_qt_cuoi[0]['quytrinh_id']
          this.thuebao.tsl.huonggiao_tc_tn_cuoi = rs_qt_cuoi[0]['huonggiao_id']
        }

        //await this.TaoDuLieu(true); //??? tai sao truoc lai viet TaoDuLieu o day????
        await this.TaoDuLieu_HDTT(false)
        await this.TaoDuLieu_HDTB(true)
        if (this.listbox.doituong.value == DUNG_THU.DOITUONG_TB) await this.TaoDuLieu_HDTB_DUNGTHU(true)
        await this.TaoDuLieu_THONGTIN_TT(true)
        await this.TaoDuLieu_CT_TIENHD(true)
        this.dsTien_HDTB = []
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
          this.TaoDuLieu_TIEN_HDTB_TC(true)
        }
        await this.TaoDuLieu_TIEN_DATCOC(true)
        await this.TaoDuLieu_DiaChi(true, 3)
        await this.TaoDuLieu_DiaChi_BanCheo(true, 3)
        await this.TaoDuLieu_DKDV()
        await this.CapNhat_HDTB_ID_DangKyDV()

        await this.CapNhat_HDTB_ID_HDTB_KV_ThemTB() // LINE 10812 ###RECENT

        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          this.dsHDBANCHEO = []
          this.dsHDTBBANCHEO = []
          await this.TaoDuLieu_HDBANCHEO_TSL(true, 1)
          await this.TaoDuLieu_HDBANCHEO_TSL(true, 2)
        } else await this.TaoDuLieu_HDBANCHEO(true)

        this.dsHDTB_CD = []
        this.dsHDTB_DD = []
        this.dsHDTB_ADSL = []
        this.dsHDTB_TSL = []
        this.dsHDTB_MEWAN = []
        this.dsHDTB_GP = []
        this.dsHDTB_IMS = []
        this.dsCAMKET_HDTB = []
        this.dsHDTBDV = []
        this.dsHDTB_CNTT = []
        switch (this.listbox.dichvu_vt.value * 1) {
          case DichVuVienThong.CO_DINH:
            await this.TaoDuLieu_HDTB_CD(true)
            await this.TaoDuLieu_HDBC_CD(true)
            await this.TaoDuLieu_CAMKET_HDTB(true)
            break
          case DichVuVienThong.DI_DONG:
            await this.TaoDuLieu_HDTB_DD(true)
            break
          case DichVuVienThong.MEGAWAN:
          case DichVuVienThong.METRONET:
          case DichVuVienThong.MGW_DOITAC:
          case DichVuVienThong.NOIBO_DADIEM:
            await this.TaoDuLieu_HDTB_MGWAN(true)
            await this.TaoDuLieu_HDBC_MGWAN(true)
            await this.TaoDuLieu_HDTB_LOAIIP_MGWAN()
            await this.TaoDuLieu_HDTB_KIEU_NT()
            break
          case DichVuVienThong.MEGA_EYES:
            await this.TaoDuLieu_HDTB_ADSL(true)
            break
          case DichVuVienThong.DICHVU_CNTT:
          case DichVuVienThong.ANTOAN_BAOMAT_TT:
          case DichVuVienThong.TRUNGTAM_DULIEU:
          case DichVuVienThong.HOINGHI_TRUYENHINH:
            this.dsHDTB_CNTT = this.thongso_ban.thongso_cntt
            this.dsHDBC_CNTT = this.thongso_tc.thongso_cntt
            this.dsHDTB_CNTT = this.ItemList
            //Tạo cho bảng hdtb_dv
            for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

        if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
          throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
          return;
        }
              var row = {}
              row.HDTB_ID = this.hdtb_id
              row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
              row.DONVI_ID = this.DT_CONTROLS.value[i]
              row.KIEUDV_ID = 2
              this.dsHDTBDV.push(row)
            }
            await TAO_DULIEU_HDTB_SUB(true)
            break
          case DichVuVienThong.ADSL:
          case DichVuVienThong.HATANG_VIENTHONG:
          case DichVuVienThong.BRCD_DOITAC:
            await this.TaoDuLieu_HDTB_ADSL(true)
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
              await this.TaoDuLieu_HDTB_LOAIIP()
            }
            await this.TaoDuLieu_HDBC_ADSL(true)
            break
          case DichVuVienThong.TSL:
          case DichVuVienThong.TSL_DOITAC:
          case DichVuVienThong.NOIBO_2DIEM:
            await this.TaoDuLieu_HDTB_TSL(true)
            this.dsHDBC_TSL = []
            await this.TaoDuLieu_HDBC_TSL(true, 1)
            await this.TaoDuLieu_HDBC_TSL(true, 2)
            await this.TaoDuLieu_HDTB_KIEU_NT()
            break
          case DichVuVienThong.GPHONE:
            await this.TaoDuLieu_HDTB_GP(true)
            await this.TaoDuLieu_CAMKET_HDTB(true)
            break
          case DichVuVienThong.IMS:
          case DichVuVienThong.IMS_DOITAC:
            await this.TaoDuLieu_HDTB_IMS(true)
            await this.TaoDuLieu_HDBC_IMS(true)
            await this.TaoDuLieu_CAMKET_HDTB(true)
            break
        }
        //TODO bo qua tu 10913 - 11052
        // Dat cho tren VISA
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL) {
          var loaihinh_tb = this.listbox.loaihinh_tb.value
          if (loaihinh_tb == LoaiHinhTB.INTERNET_1260 || loaihinh_tb == LoaiHinhTB.INTERNET_ADSL || loaihinh_tb == LoaiHinhTB.INTERNET_FTTH || loaihinh_tb == LoaiHinhTB.WIFI_FIBER) {
            if (this.DONGBO_TEST.TEST == false) {
              // VDCService vdcService = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
              var account = this.dsHDTB[0]['MA_TB']
              var contex = this.ma_lhtb_vdc //objCheckData.MAP_ID("ma_lhtb_vdc", DatabaseConstants.DB2 + ".loaihinh_tb", "where loaitb_id =" + cboLoaihinhTB.SelectedValue.ToString());
              var pdata = {
                accountModel: { accountName: account }
                //"reservemodel": { "context":contex, "reservedTime": "2022-01-11" } //Bỏ do VISA default vào FTTH rồi
              }
              await API.post_reserveRASAccount(this.axios, pdata).then((response) => {
                if (response && response.data && response.data.data && response.data.errorCode != 1) this.thuebao.statusVdc = response.data.data == 'ok'
                else this.$toast.error(response.data.faultCode + ': ' + response.data.faultString)
              })
              if (!this.thuebao.statusVdc) {
                this.$toast.error('Có lỗi xảy ra trong quá trình đặt chỗ Account ' + account + ' lên Visa.Bạn hãy vui lòng thực hiện lại chức năng này!')
                return
              }
              this.thuebao.check_tb_adsl = true //Hiếu thêm biến kiểm tra thuê bao ADSL đã được đặt chỗ hay chưa. 5.10.2010
            } else {
              this.thuebao.statusVdc = true
              this.thuebao.check_tb_adsl = true
            }
          }
        }
        // Kich hoat dang ky len he thong Camera
        if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) {
          var loaihinh_tb = this.listbox.loaihinh_tb.value
          if (loaihinh_tb == LoaiHinhTB.MEGACAMERA) {
            if (this.DONGBO_TEST.TEST == false) {
              var matinh = this.$root.token.getMaTinh()
              // CameraService camera = new CameraService();
              var city_id = matinh
              var agent_id = matinh
              var customer_id = this.dsHDKH[0]['MA_KH']
              var subscription_id = 0
              var integrated_services
              var message = ''
              var kieu = await API.post_fn_tt_kieu_ld(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, param: this.thongso_tc.kieuld_id })
                .then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    return response.data.data
                  } else return 0
                })
                .catch(() => {
                  return 0
                }) //this.kieu_ld_kieu;
              if (kieu == 1 || kieu == 2 || kieu == 3) {
                integrated_services = 0
              } else integrated_services = 1

              var username = this.dsHDTB[0]['MA_TB']
              var password = this.dsHDTB_ADSL[0]['PASSWORD']
              var email = this.dsHDTB_ADSL[0]['EMAIL']
              //FIXME can chuyen phan nay len API
              var pdata =
                '{"city_id":"' + city_id + '","agent_id":"' + agent_id + '","customer_id":"' + customer_id + '","subscription_id":"' + subscription_id + '","integrated_services":"' + integrated_services + '","username":"' + username + '","password":"' + password + '","email":"' + email + '"}'
              // var rs = await this.$root.context.post("http://vnptapi.iveda.com/index.php/api/add",JSON.parse(pdata));
              // message = JSON.parse(rs.data);
              // this.thuebao.statusVdc = (message.indexOf("resultid\":\"0")>=0)
              var rs = await this.$root.context.post('/tichhop/iveda/add', JSON.parse(pdata))
              message = rs.faultString + JSON.parse(rs.data)
              this.thuebao.statusVdc = rs.errorCode == 0 //(message.indexOf("resultid\":\"0")>=0)
              // this.thuebao.statusVdc = camera.ThemMoiKhachHang(city_id, agent_id, customer_id, subscription_id, integrated_services, username, password, email, ref message);
              if (!this.thuebao.statusVdc) {
                this.$toast.error('Có lỗi xảy ra trong quá trình kích hoạt lên hệ thống Camera.\nLỗi: ' + message)
                return
              }
              this.thuebao.check_tb_adsl = true //Hiếu thêm biến kiểm tra thuê bao ADSL đã được đặt chỗ hay chưa. 5.10.2010
            } else {
              this.thuebao.statusVdc = true
              this.thuebao.check_tb_adsl = true
            }
          }
        }

        // #region Đồng bộ dữ liệu lên VinaPhone vuth update 0912 :Tạo mới hđ thuê bao nếu là hòa mạng mới, ngược lại nếu hòa mạng chuyển tỉnh thì thêm gọi hàm TS_LAPHD_CHUYENTINH_NEW_THUEBAO_CTS
        if (this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG && this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRASAU) {
          if (this.dsHDTB[0]['kieuld_id'] == KieuLapDat.DM_DIDONG || this.dsHDTB[0]['kieuld_id'] == KieuLapDat.DM_DIDONG_C_P) {
            var rs = await this.Insert_TBLD_VinaPhone()

            if (rs != 'OK') {
              this.$toast.error('Có lỗi xảy ra trong quá trình thêm mới hợp đồng thuê bao di động trên VinaPhone.\n' + rs)
              return
            }
          } else if (this.dsHDTB[0]['kieuld_id'] == KieuLapDat.DM_DIDONG_CHUYEN_TINH) {
            var rs = await this.Insert_HDLD_VinaPhone()
            var ma_hd = this.dsHDKH[0]['ma_gd']

            if (rs != 'OK') {
              this.$toast.error(rs)
              return
            }
          }
        }
        // #endregion

        if (this.listbox.doituong.value == DUNG_THU.DOITUONG_TB) {
          if (!(await this.Kiemtra_dungthu_mytv())) {
            // #region Lấy chi tiết khuyến mại dùng thử fill vào khuyenmai_hdtb
            var dsTemp = []
            await API.post_lay_chitiet_km_dungthu_v2(this.axios, { vloaikh_id: this.listbox.loai_kh.value }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                dsTemp = response.data.data
              }
            })

            if (dsTemp.length > 0) {
              // if (dsTemp[0]["khuyenmai_id"])
              // {
              //   this.filterbox.khuyenmai.value = dsTemp[0]["khuyenmai_id"];
              //   this.filterbox.khuyenmai.ischecked = true;
              // }
              // else
              //   this.filterbox.khuyenmai.ischecked = false;

              // DateTime tmp;
              var ithang_huongdc = 0,
                ithang_huongkm = 0,
                ithang_tg = 0
              var dtiendatcoc_csd = 0,
                dtien_td = 0
              this.dsKM_HDTB = []

              for (var i = 0; i < dsTemp.length; i++) {
                ithang_huongdc = 0
                ithang_huongkm = 0
                ithang_tg = 0
                dtiendatcoc_csd = 0
                dtien_td = 0
                var dr = {}
                if (dsTemp[i]['huong_dc']) ithang_huongdc = dsTemp[i]['huong_dc']
                if (dsTemp[i]['huong_km']) ithang_huongkm = dsTemp[i]['huong_km']
                if (dsTemp[i]['sothang_tg']) ithang_tg = dsTemp[i]['sothang_tg']
                if (dsTemp[i]['datcoc_csd']) dtiendatcoc_csd = dsTemp[i]['datcoc_csd']
                if (dsTemp[i]['tien_td']) dtien_td = dsTemp[i]['tien_td']
                dr.THANG_HUONGDC = ithang_huongdc
                dr.THANG_HUONGKM = ithang_huongkm
                dr.SOTHANG_TG = ithang_tg
                dr.DATCOC_CSD = dtiendatcoc_csd
                dr.TIEN_TD = dtien_td

                if (dsTemp[i]['kieu_bdkm'] == '3') {
                  try {
                    var tmp = moment(dsTemp[i]['thang_bd'], 'YYYYMM')
                      .add(ithang_huongkm, 'M')
                      .format('YYYYMM')
                    dr.THANG_BD = dsTemp[i]['thang_bd']
                    dr.THANG_KT = tmp
                  } catch (ex) {}
                }
                if (dsTemp[i]['kieu_bdtg'] == '3') {
                  try {
                    var tmp = moment(dsTemp[i]['thang_bdtg'], 'YYYYMM')
                      .add(ithang_tg, 'M')
                      .format('YYYYMM')
                    dr.THANG_BDTG = dsTemp[i]['thang_bdtg']
                    dr.THANG_KTTG = tmp
                  } catch (ex) {}
                }
                if (dsTemp[i]['kieu_bddc'] == '3') {
                  try {
                    var tmp = moment(dsTemp[i]['thang_bddc'], 'YYYYMM')
                      .add(ithang_huongkm, 'M')
                      .format('YYYYMM')
                    dr.THANG_BDDC = dsTemp[i]['thang_bddc']
                    dr.THANG_KTDC = tmp
                  } catch (ex) {}
                }
                //longdx: bổ sung thông tin tỷ lệ km
                dr.TYLE_KMLD = dsTemp[i]['tyle_kmld']
                dr.TYLE_SD = dsTemp[i]['tyle_sd']
                dr.TYLE_TB = dsTemp[i]['tyle_tb']
                dr.HDTB_ID = this.hdtb_id //-1;
                dr.CHITIETKM_ID = dsTemp[i]['chitietkm_id']
                dr.KHUYENMAI_ID = dsTemp[i]['khuyenmai_id']
                //dr.KHUYENMAI_ID_NEO = dsTemp[i]["khuyenmai_id_neo"];
                dr.KIEU_YC = 1
                this.dsKM_HDTB.push(dr)

                //Lấy tiền khuyến mại
                if (this.kmld.tien_kmld < dsTemp[i]['tien_kmld']) this.kmld.tien_kmld = dsTemp[i]['tien_kmld']
                if (this.kmld.vat_kmld < dsTemp[i]['vat_kmld']) this.kmld.vat_kmld = dsTemp[i]['vat_kmld']
                if (this.kmld.tyle_kmld < dsTemp[i]['tyle_kmld']) this.kmld.tyle_kmld = dsTemp[i]['tyle_kmld']

                if (this.kmld.tien_datcoc < dsTemp[i]['datcoc_csd']) this.kmld.tien_datcoc = dsTemp[i]['datcoc_csd']
              }
            }
            // #endregion
          } else {
            //TODO xem lai, chua xac dinh muc dich xoa du lieu o day!
            this.dsKM_HDTB = this.dsKM_HDTB.filter((x) => !(x.khuyenmai_id == 2999 || x.khuyenmai_id == 2998))
            // var _arrKM_DT = this.dsKM_HDTB.filter(x=>x.khuyenmai_id==2999 || x.khuyenmai_id==2998);
            // if(_arrKM_DT)
            //   for(var item in _arrKM_DT)
            //     item.Delete();
          }
        }
        var them_hrm = false
        if (this.loainv_ctv_hrm > 0 || this.loainv_ngt_hrm > 0) {
          if (this.dsHDKH_Sub && this.dsHDKH_Sub.length > 0) {
            await this.TAO_DULIEU_HDKH_SUB(this.dsHDKH_Sub, this.dsHDKH_Sub[0]['HDKH_ID'])
          } else {
            var row_khsub = {}
            row_khsub.HDKH_ID = this.dsHDKH[0]['HDKH_ID']
            if (this.loainv_ctv_hrm > 0) {
              row_khsub.LOAINV_CTV_HRM = this.loainv_ctv_hrm
            }
            if (this.loainv_ngt_hrm > 0) {
              row_khsub.LOAINV_NGT_HRM = this.loainv_ngt_hrm
            }
            this.dsHDKH_Sub = []
            this.dsHDKH_Sub.push(row_khsub)
          }
          them_hrm = true
        }

        var pdata = {
          HD_BANCHEO: this.dsHDBANCHEO,
          HDTB_BANCHEO: this.dsHDTBBANCHEO,
          HDBC_MGWAN: this.dsHDBCMGWAN,
          HDBC_ADSL: this.dsHDBC_ADSL,
          HDBC_CD: this.dsHDBCCD,
          DANGKY_DVGT_BC: this.dsDK_DVGT_BC,
          HDBC_TSL: this.dsHDBC_TSL,
          HDBC_IMS: this.dsHDBCIMS,
          DIACHI_BANCHEO: this.dsDiaChi_BanCheo,
          HDBC_CNTT: this.dsHDBC_CNTT,
          //HD_KHACHHANG:this.dsHDKH,
          HD_THUEBAO: this.dsHDTB,
          HD_THANHTOAN: this.dsHDTT,
          HDTB_DV: this.dsHDTBDV,
          HDTB_CD: this.dsHDTB_CD,
          HDTB_DD: this.dsHDTB_DD,
          HDTB_INT: this.dsHDTB_INT,
          HDTB_ADSL: this.dsHDTB_ADSL,
          DIACHI: this.dsDiaChi,
          // DIACHI_HDKH:this.dsDiaChiHDKH,
          // DIACHI_HDTT:this.dsDiaChiHDTT,
          DIACHI_HDTB: this.dsDiaChiHDTB,
          DANGKY_DVGT: this.dsDK_DVGT,
          DANGKY_DVK: this.dsDK_DVKHAC,
          CT_MUA_TBI: this.UpperCasePropertyList(this.dsCTM_TBI),
          HDTB_MGWAN: this.dsHDTB_MEWAN, //dsHDTB_MEWAN
          HDTB_TSL: this.dsHDTB_TSL, //dsHDTB_TSL
          HDTB_GP: this.dsHDTB_GP, //dsHDTB_GP
          KHUYENMAI_HDTB: this.dsKM_HDTB && this.dsKM_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsKM_HDTB) : this.dsKM_HDTB, //this.dsKM_HDTB,
          DATCOC_HDTB: this.dsDC_HDTB && this.dsDC_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsDC_HDTB) : this.dsDC_HDTB,
          THONGTIN_TT: this.dsTTTT, //this.dsTTTT,
          CT_TIENHD: this.dsCTTHD,
          TIEN_HDTB: this.dsTien_HDTB, //this.dsTien_HDTB,
          TIEN_DATCOC: this.dsTien_DatCoc,
          HDTB_IMS: this.dsHDTB_IMS, //dsHDTB_IMS
          CAMKET_HDTB: this.dsCAMKET_HDTB,
          HUONGGIAO_ID: this.huonggiao_tn,
          HDTB_KV:
            this.dsHDTB_KV_ThemTB && this.dsHDTB_KV_ThemTB.length > 0 && this.dsHDTB_KV_ThemTB.filter((x) => x.KHUVUC_ID && x.KHUVUC_ID > 0).length > 0
              ? this.dsHDTB_KV_ThemTB.filter((x) => x.KHUVUC_ID && x.KHUVUC_ID > 0)
              : this.dsHDTB_KV && this.dsHDTB_KV.length > 0
              ? this.dsHDTB_KV.filter((x) => x.KHUVUC_ID && x.KHUVUC_ID > 0)
              : null,
          HDTB_CNTT: this.dsHDTB_CNTT, //dsHDTB_CNTT
          // HDTT_NV: this.dsHDTT_NV,
          HDTB_DUNGTHU: this.dsHDTB_DUNGTHU,
          // TRAGOP_TBI_HDTB: this.dsTRAGOP_TBI_HDTB,
          // HDTB_LOAIIP: this.dsHDTB_LoaiIp, //this.dsHDTB_LoaiIp,
          HDKH_SUB: this.dsHDKH_Sub,
          HDTB_SUB: this.dsHDTB_SUB, //this.dsHDTB_SUB,
          THEM_HRM: them_hrm,
          // HDTB_CT: this.dsHDTB_CT,//this.dsHDTB_CT, //Chi co o phan dich vu CNTT / frmChiTietHDTB
          // THEMMOI: this.buttonSet==1,
          LOAITB_ID: this.listbox.loaihinh_tb.value,
          DICHVUVT_ID: this.listbox.dichvu_vt.value,
          KT_KVNLML: KT_KVNLML, //BUG KT_KVNLML nhung de mac dinh de chay test
          // TUDONG_SINH_SOAO: this.TUDONG_SINH_SOAO?1:0, // Chi dung cho cac case MEGAWAN...

          // MAKH_WEB: this.khachhang.makh,
          // DS_DIACHI_BC:{
          //   DIACHIBC_ID:this.diachiBC.DIACHI_ID,
          //   HDTT_ID: this.hdtt_id,
          //   PHOBC_ID: this.diachiBC.PHO_ID,
          //   PHUONGBC_ID: this.diachiBC.PHUONG_ID,
          //   QUANBC_ID: this.diachiBC.QUAN_ID,
          //   SONHA_BC: this.diachiBC.SO_NHA,
          //   DIACHI_BC: this.diachiBC.DIACHI,
          //   TINHBC_ID: this.diachiBC.TINH_ID,
          //   APBC_ID: this.diachiBC.AP_ID,
          //   KHUBC_ID: this.diachiBC.KHU_ID,
          //   DACDIEMBC_ID: this.diachiBC.DACDIEM_ID,
          // },
          // LIST_SERIAL: [],
          // IS_TRUOCBH: 0,
          // KIEMTRA_DK_APDUNG: 'ok',//BUG KIEMTRA_DK_APDUNG nhung de mac dinh de chay test

          TD_GANTHEM_HDTB_DV: this.TD_GANTHEM_HDTB_DV ? 1 : 0,
          STATUS_VDC: this.STATUS_VDC,
          OPEN_SYNC_VINA: TRANGTHAI_DONGBO.OPEN_SYNC_VINA ? 1 : 0,

          // MA_TB: this.khachhang.makh,
          MA_TB_HT: this.ma_tb_ht, //this.thuebao.codinh.somay,
          // MA_TB_AO: "",
          MA_TB_AO_HT: this.ma_tb_ao_ht,
          MA_TB_AO_HT_CUOI: this.ma_tb_ao_ht_cuoi,
          // MA_TB_AO_CUOI: "",

          DULIEU_KS: this.bDuLieuKS ? 1 : 0,
          SD_FRMSHUONGKN_V2: this.thamsomacdinh['SD_FRMDSHUONGKN_V2'] == 1 ? 1 : 0,
          LOAISOWAN: this.loaisowan,
          VRF: this.thuebao.mgwan.vrfvfi,
          MA_TB_DIACHILD: null,
          // VPHIEUCSKHDV_ID: this.phieucskhdv_id, // TODO chua biet load nhu the nao
          // KETCUOI_ID:null,
          // LAT_LD:this.diachiLD.Lat,
          // LNG_LD:this.diachiLD.Lng,
          // FIBER_BS:null,
          // CONGNGHE_ID:this.listbox.congnghe.value==0?null:this.listbox.congnghe.value,
          // MATB_TN:this.thuebaocd.matn?this.thuebaocd.matn.trim():null,
          BANCHEO: 1
        }
        await API.post_fn_them_hopdong_thuebao(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            // var hdkh_id = this.khachhang.hdkh_id;
            var data = JSON.parse(response.data.data)
            if (data['ERROR_CODE'] != 1) {
              this.$toast.error(data['MESSAGE'])
              return
              throw data['MESSAGE']
            } else {
              if(KT_KVNLML!=1) {
                if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
                  // VDCService vdc = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
                  // vdc.HuyDatChoMegaVNN(txtAccountADSL.Text);
                  await vdc.HuyDatChoMegaVNN(this.thuebao.adsl.txtAccountADSL)
                }

                this.buttonSet = 0

                this.$toast.success('Hợp đồng đã được thoái trả. Khách hàng sẽ được đưa vào danh sách Khách hàng tiềm năng!')
                return 'err'
              }
              this.$toast.success(data['MESSAGE'])
            }
            if (!(this.thuebao.codinh.arraySoMay && this.thuebao.codinh.arraySoMay.length > 0))
              API.post_fn_lay_ds_ht_capnhat_datmoi(this.axios, { ds_para: JSON.stringify({ HDKH_ID: this.khachhang.hdkh_id }) }).then(async (response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  var apidata = JSON.parse(response.data.data)
                  if (apidata['ERROR_CODE'] == 1) {
                    this.DatMoi_Fsecure_kem_fiber()
                    this.Them_MyTV_vao_goi_giadinh()
                    // this.HienThiDS_HDTB_CBO(); // 100% comment nen khong code
                    var ds_hdkh_tmp = apidata['RESULT']['DS_HDTB']
                    ds_hdkh_tmp = this.LowerCasePropertyList(ds_hdkh_tmp)
                    this.HienThiDanhSacHDTB(ds_hdkh_tmp)
                    // this.HienThiTTHopDongTB(ds_hdkh_tmp);

                    if (this.lvwThueBao.length <= 1) this.buttons.tsbtnXoaTB = false
                    else this.buttons.tsbtnXoaTB = true
                  }
                }
              })
          }
        })
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    CapNhat_HDTB_ID_HDTB_KV_ThemTB() {
      this.dsHDTB_KV_ThemTB = []
      if (this.dsHDTB_KV && this.dsHDTB_KV.length > 0)
        for (var item of this.dsHDTB_KV) {
          var dr = {}
          dr.HDTB_ID = this.hdtb_id
          dr.KHUVUC_ID = item['KHUVUC_ID']
          dr.LOAIKV_ID = LOAI_KV.KHUVUC_DIABAN
          dr.NGUOI_CN = this.$root.token.getUserName()
          dr.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
          dr.MAY_CN = this.tt_nd.may_cn
          dr.IP_CN = 'y.y.y.y'
          this.dsHDTB_KV_ThemTB.push(dr)
        }
      else {
        let dr = {}
        dr.HDTB_ID = this.hdtb_id
        dr.KHUVUC_ID = this.thuebao.khuvuc_id
        dr.LOAIKV_ID = LOAI_KV.KHUVUC_DIABAN
        dr.NGUOI_CN = this.$root.token.getUserName()
        dr.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
        dr.MAY_CN = null
        dr.IP_CN = null
        this.dsHDTB_KV_ThemTB.push(dr)
      }
    },
    async tsbtnXoa_Click() {
      this.$bvModal
        .msgBoxConfirm('Bạn thật sự muốn xóa hợp đồng không ?', {
          title: 'Xác nhận hành động',
          size: 'sm',
          okTitle: 'Đồng ý',
          cancelTitle: 'Hủy'
        })
        .then(async (v) => {
          if (v) {
            try {
              var DS_HDTB = this.lvwThueBao.map((x) => ({ HDTB_ID: x.hdtb_id, LOAITB_ID: x.loaitb_id }))
              var pdata = { HDKH_ID: this.khachhang.hdkh_id, DS_HDTB: DS_HDTB }
              API.post_fn_lay_tt_kt_xoa_hopdong(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  var data = JSON.parse(response.data.data)
                  if (data['ERROR_CODE'] != 1) this.$toast.error(data['MESSAGE'])
                  else {
                    data = data['RESULT']
                    if (this.DONGBO_TEST.TEST == false) {
                      for (var i = 0; i < this.lvwThueBao.length; i++) {
                        var l_hdtb_id = this.lvwThueBao[i]['hdtb_id']
                        var in_loaitb_id = this.lvwThueBao[i]['loaitb_id']
                        var str_matb = this.lvwThueBao[i]['ma_tb']

                        if (in_loaitb_id == LoaiHinhTB.INTERNET_ADSL || in_loaitb_id == LoaiHinhTB.INTERNET_FTTH || in_loaitb_id == LoaiHinhTB.WIFI_FIBER) {
                          await API.post_unReservedAccount(this.axios, { accountName: str_matb }).then((response) => {
                            if (response && response.data && response.data.data && response.data.errorCode != 1)
                              if (response.data.data == 'ok') this.$toast.success('Hủy đặt chỗ account ' + str_matb + ' trên Visa thành công!')
                              else this.$toast.error('Có lỗi xảy ra trong quá trình hủy đặt chỗ account ' + str_matb + ' trên Visa!')
                            else this.$toast.error(response.data.faultCode + ': ' + response.data.faultString)
                          })
                        }
                      }
                      //dungpa - xoa thue bao dang ky goi tren ccbs
                      // #region xoa thue bao dang ky goi tren ccbs
                      var dongbo_dadv = await API.post_lay_ds_thamso_md_mats(this.axios, { ma_ts: 'DONGBO_GOI_DA_DV' }).then((response) => {
                        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') return response.data.data.ten_ts ? response.data.data.ten_ts * 1 : -1
                        else {
                          this.$toast.error(response.data.message + ': ' + response.data.message_detail)
                          return -1
                        }
                      })
                      if (dongbo_dadv == 1) {
                        var _dsGoi = await API.post_lay_tt_goi_gdvp(this.axios, { vhdkh_id: this.khachhang.hdkh_id, vhdtb_id: 0, vnguoi_kh: this.tt_nd.ma_nd }).then((response) => {
                          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') return response.data.data
                          else {
                            this.$toast.error(response.data.message + ': ' + response.data.message_detail)
                            return {}
                          }
                        })
                        if (_dsGoi.vreturn_home.length > 0) {
                          for (var gitem of _dsGoi.vreturn_home) {
                            API.post_delete_package_css(this.axios, {
                              account: gitem.acc_fiber,
                              agent: this.tt_nd.tentat_ccbs,
                              channel: '1',
                              msisdn: '84' + gitem.ma_tb,
                              packageid: gitem.goi_neo_id,
                              // "request_id": "string",
                              // "service": "string",
                              // "serviceid": "string",
                              typeid: '1',
                              userid: this.tt_nd.ma_nv,
                              userip: await this.$root.token.getIP()
                            }).then((response) => {
                              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                                var kq = response.data.data
                                if (!kq.result_code) throw 'Có lỗi trong quá trình kích hoạt gói tích hợp trên VNP: ' + kq.errorMessage
                              } else {
                                this.$toast.error(response.data.message + ': ' + response.data.message_detail)
                                return {}
                              }
                            })
                          }
                        }

                        if (_dsGoi.vreturn_gdvp.length > 0) {
                          for (var gitem of _dsGoi.vreturn_gdvp) {
                            API.post_delete_package_css(this.axios, {
                              account: gitem.acc_fiber,
                              agent: this.tt_nd.tentat_ccbs,
                              channel: '1',
                              msisdn: '84' + gitem.ma_tb,
                              packageid: gitem.goi_neo_id,
                              // "request_id": "string",
                              // "service": "string",
                              // "serviceid": "string",
                              typeid: '1',
                              userid: this.tt_nd.ma_nv,
                              userip: await this.$root.token.getIP()
                            }).then((response) => {
                              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                                var kq = response.data.data
                                if (!kq.result_code) throw 'Có lỗi trong quá trình kích hoạt gói tích hợp trên VNP: ' + kq.errorMessage
                              } else {
                                this.$toast.error(response.data.message + ': ' + response.data.message_detail)
                                return {}
                              }
                            })
                          }
                        }
                      }
                      // #endregion
                      //end dungpa
                    }
                    // #region KieuNV:Kiểm tra nếu trong hđ có thuê bao di động trả sau thì gọi hàm xóa hđ trên CCBS. vuth update 0912
                    var CoDiDong = false
                    for (var item in this.lvwThueBao) {
                      if (item['loaitb_id'] == LoaiHinhTB.DIDONGTRASAU) {
                        CoDiDong = true
                        break
                      }
                    }
                    //Nếu hợp đồng có thuê bao di động thì gọi hàm xóa trên Vinaphone.
                    if (CoDiDong) {
                      var ck = {}
                      var chuaxoa_hopdong_hoamangmoi = true // hop dong hoa mang moi chi phai xoa 1 lan theo ma gd.
                      for (var i = 0; i < this.lvwThueBao.length; i++) {
                        var l_hdtb_id = this.lvwThueBao[i]['hdtb_id']
                        var kieuld_id_current = 0
                        if (data['DS_HD_KLD'])
                          for (var item of data['DS_HD_KLD'])
                            if (item['HDTB_ID'] == l_hdtb_id) {
                              kieuld_id_current = item['KIEULD_ID']
                              break
                            }
                        var str_matb = this.lvwThueBao[i]['ma_tb']
                        if ((kieuld_id_current == KieuLapDat.DM_DIDONG || kieuld_id_current == KieuLapDat.DM_DIDONG_C_P) && chuaxoa_hopdong_hoamangmoi) {
                          var rsDel = await this.Delete_HDLD_VinaPhone(this.khachhang.magd)
                          if (rsDel != 'OK') {
                            var cfr = await this.$bvModal
                              .msgBoxConfirm(rsDel + '\r\nBạn có chắc muốn tiếp tục xóa HĐ trên dữ liệu viễn thông tỉnh?', {
                                title: 'Xác nhận hành động',
                                size: 'sm',
                                okTitle: 'Đồng ý',
                                cancelTitle: 'Hủy'
                              })
                              .then(async (v) => {
                                return v
                              })

                            if (!cfr) return
                          }
                          chuaxoa_hopdong_hoamangmoi = false // xóa thành công thì thuê bao khác trong hđ ko phải gọi hàm xóa trên vinaphone nữa.
                        } else if (kieuld_id_current == KieuLapDat.DM_DIDONG_CHUYEN_TINH) {
                          var rsDel = this.Delete_HD_ChuyenTinh_VinaPhone('84' + str_matb) // phải xóa từng hợp đồng
                          if (rsDel != 'OK') {
                            var cfr = await this.$bvModal
                              .msgBoxConfirm(rsDel + '\r\nBạn có chắc muốn tiếp tục xóa HĐ trên dữ liệu viễn thông tỉnh?', {
                                title: 'Xác nhận hành động',
                                size: 'sm',
                                okTitle: 'Đồng ý',
                                cancelTitle: 'Hủy'
                              })
                              .then(async (v) => {
                                return v
                              })

                            if (!cfr) return
                          }
                        }
                      }
                    }
                    // #endregion

                    // #region "Xóa UMP"
                    if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
                      if (this.listbox.loai_tb.valuemgwan == 157) {
                        //Fix ID loại thiết bị STB UMP
                        var rs = await this.$root.context.post('http://10.70.52.120:4740/api/DeleteUMP', { serialNumber: this.thuebao.adsl.txtSerialSTB }) //"mytvUsername":this.dsHDTB[0]["MA_TB"],"mytvPassword":this.dsHDTB[0]["PASSWORD"],
                        var kq = JSON.parse(rs.data)
                        if (kq['Message']) kq = kq['Message']
                        // var kq = CapNhatUMP(txtSerialSTB.Text.trim(), dsHDTB.Tables[0].Rows[0]["MA_TB"].ToString(), dsHDTB_ADSL.Tables[0].Rows[0]["PASSWORD"].ToString(), ref message);
                        if (kq.status != 'success') {
                          this.$toast.error('Có lỗi trong quá trình xóa thông tin thiết bị trên UMP. Lỗi: ' + kq.message)
                          return
                        }

                        // string message = "";
                        // bool kq = XoaUMP(txtSerialSTB.Text.trim(), ref message);
                        // if (!kq)
                        // {
                        //     Message_Box.ShowWarning("Có lỗi trong quá trình xóa thông tin thiết bị lên UMP. Lỗi: " + message);
                        //     return;
                        // }
                      }
                    }
                    // #endregion

                    var psubdata = { HDKH_ID: this.khachhang.hdkh_id, DS_HDTB: DS_HDTB, DONGBO_TEST: this.DONGBO_TEST.TEST, BANCHEO: 1 }
                    API.post_fn_xoa_hopdong_datmoi(this.axios, { ds_para: JSON.stringify(psubdata) }).then((response) => {
                      if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                        var apidata = JSON.parse(response.data.data)
                        if (apidata['ERROR_CODE'] != 1) this.$toast.error(apidata['MESSAGE'])
                        else {
                          this.$toast.success(apidata['MESSAGE'])
                          this.buttonSet = 0
                          //Trong code cu la khong lam gi them o day!!!!
                          // API.post_lay_ds_hopdong_tb_theo_hdkh_id(this.axios, { "ds_para": JSON.stringify(psubdata) }).then((response) => {
                          //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {

                          //   }
                          // });
                          // var ds_hdkh_tmp = apidata['RESULT']['DS_HDTB'];
                          // ds_hdkh_tmp = this.LowerCasePropertyList(ds_hdkh_tmp);

                          // this.HienThiDanhSacHDTB(ds_hdkh_tmp);
                          // // this.HienThiTTHopDongTB(ds_hdkh_tmp);

                          // if(this.lvwThueBao.length<=1) this.buttons.tsbtnXoaTB = false;
                          // else this.buttons.tsbtnXoaTB = true;
                        }
                      }
                    })
                  }
                }
              })
            } catch (ex) {
              this.$toast.error('' + ex)
              if (this.debug) console.error(ex)
            }
          }
        })
    },
    async tsbtnXoaTB_Click() {
      if (this.lvwThueBao.length == 1) {
        this.$toast.error('Hợp đồng này hiện đang có 1 thuê bao, bạn hãy thực hiện chức năng xóa hợp đồng !')
        return
      }
      this.$bvModal
        .msgBoxConfirm('Bạn thật sự muốn xóa thuê bao không ?', {
          title: 'Xác nhận hành động',
          size: 'sm',
          okTitle: 'Đồng ý',
          cancelTitle: 'Hủy'
        })
        .then(async (v) => {
          if (v) {
            try {
              var pdata = { HDTB_ID: this.hdtb_id, DONGBO_TEST: this.DONGBO_TEST.TEST, BANCHEO: 1 }
              API.post_fn_kiemtra_xoa_thuebao(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  var data = JSON.parse(response.data.data)
                  if (data['ERROR_CODE'] != 1) this.$toast.error(data['MESSAGE'])
                  else {
                    data = data['RESULT']
                    if (this.DONGBO_TEST.TEST == false) {
                      for (var i = 0; i < this.lvwThueBao.length; i++) {
                        var l_hdtb_id = this.lvwThueBao[i]['hdtb_id']
                        var in_loaitb_id = this.lvwThueBao[i]['loaitb_id']
                        var str_matb = this.lvwThueBao[i]['ma_tb']

                        if (in_loaitb_id == LoaiHinhTB.INTERNET_ADSL || in_loaitb_id == LoaiHinhTB.INTERNET_FTTH || in_loaitb_id == LoaiHinhTB.WIFI_FIBER) {
                          await API.post_unReservedAccount(this.axios, { accountName: str_matb }).then((response) => {
                            if (response && response.data && response.data.data && response.data.errorCode != 1)
                              if (response.data.data == 'ok') this.$toast.success('Hủy đặt chỗ account ' + str_matb + ' trên Visa thành công!')
                              else this.$toast.error('Có lỗi xảy ra trong quá trình hủy đặt chỗ account ' + str_matb + ' trên Visa!')
                            else this.$toast.error(response.data.faultCode + ': ' + response.data.faultString)
                          })
                        }
                      }
                      // TODO chua lam phan nay DI_DONG
                      //dungpa - xoa thue bao dang ky goi tren ccbs
                      // #region xoa thue bao dang ky goi tren ccbs
                      // DataSet dsTS = new ThamSo_MDFacade().LAY_DS_THAMSO_MD_MATS("DONGBO_GOI_DA_DV");
                      // int dongbo_dadv = -1;
                      // if (dsTS != null && dsTS.Tables[0].Rows.Count > 0)
                      // {
                      //     dongbo_dadv = Convert.ToInt32(dsTS.Tables[0].Rows[0]["TEN_TS"].ToString());
                      // }
                      // if (dongbo_dadv == 1)
                      // {
                      //     DataSet _dsGoi = new BangTuDienFacade().THUCTHI_PROCEDURE("LAY_TT_GOI_GDVP", DatabaseConstants.DB2, new string[] { "goi_home", "goi_gdvp" }, "vhdkh_id", hdkh_id, "vhdtb_id", 0, "vnguoi_kh", tt_nd.ma_nd);
                      //     if (_dsGoi.Tables["goi_home"].Rows.Count > 0)
                      //     {
                      //         WS_GOITICHHOP_VTN _ws = new WS_GOITICHHOP_VTN();
                      //         string _error = "";
                      //         string _result = "";
                      //         for (int i = 0; i < _dsGoi.Tables["goi_home"].Rows.Count; i++)
                      //         {
                      //             _result = _ws.XOA_GOI_V3(_dsGoi.Tables["goi_home"].Rows[i]["goi_neo_id"].ToString(), "84" + _dsGoi.Tables["goi_home"].Rows[i]["ma_tb"].ToString(), _dsGoi.Tables["goi_home"].Rows[i]["acc_fiber"].ToString(), "1", tt_nd.tentat, ref _error);
                      //             if (_result != "0")
                      //             {
                      //                 Message_Box.ShowWarning("Có lỗi trong quá trình kích hoạt gói tích hợp trên VNP: " + _error);
                      //                 return;
                      //             }
                      //         }
                      //     }

                      //     if (_dsGoi.Tables["goi_gdvp"].Rows.Count > 0)
                      //     {
                      //         WS_GOITICHHOP_VTN _ws = new WS_GOITICHHOP_VTN();
                      //         string _error = "";
                      //         string _result = "";
                      //         for (int i = 0; i < _dsGoi.Tables["goi_gdvp"].Rows.Count; i++)
                      //         {
                      //             _result = _ws.XOA_GOI_V3(_dsGoi.Tables["goi_gdvp"].Rows[i]["goi_neo_id"].ToString(), "84" + _dsGoi.Tables["goi_gdvp"].Rows[i]["ma_tb"].ToString(), _dsGoi.Tables["goi_gdvp"].Rows[i]["acc_fiber"].ToString(), "1", tt_nd.tentat, ref _error);
                      //             if (_result != "0")
                      //             {
                      //                 Message_Box.ShowWarning("Có lỗi trong quá trình kích hoạt gói tích hợp trên VNP: " + _error);
                      //                 return;
                      //             }
                      //         }
                      //     }
                      // }
                      // #endregion
                      //end dungpa
                    }
                    //TODO chua lam phan nay
                    // #region KieuNV:Kiểm tra nếu trong hđ có thuê bao di động trả sau thì gọi hàm xóa hđ trên CCBS. vuth update 0912
                    var CoDiDong = false
                    for (var item in this.lvwThueBao) {
                      if (item['loaitb_id'] == LoaiHinhTB.DIDONGTRASAU) {
                        CoDiDong = true
                        break
                      }
                    }
                    //Nếu hợp đồng có thuê bao di động thì gọi hàm xóa trên Vinaphone.
                    if (CoDiDong) {
                      var ck = {}
                      var chuaxoa_hopdong_hoamangmoi = true // hop dong hoa mang moi chi phai xoa 1 lan theo ma gd.
                      for (var i = 0; i < this.lvwThueBao.length; i++) {
                        var l_hdtb_id = this.lvwThueBao[i]['hdtb_id']
                        var kieuld_id_current = 0
                        if (data['DS_HD_KLD'])
                          for (var item of data['DS_HD_KLD'])
                            if (item['HDTB_ID'] == l_hdtb_id) {
                              kieuld_id_current = item['KIEULD_ID']
                              break
                            }
                        var str_matb = this.lvwThueBao[i]['ma_tb']
                        if ((kieuld_id_current == KieuLapDat.DM_DIDONG || kieuld_id_current == KieuLapDat.DM_DIDONG_C_P) && chuaxoa_hopdong_hoamangmoi) {
                          var rsDel = await this.Delete_HDLD_VinaPhone(this.khachhang.magd)
                          if (rsDel != 'OK') {
                            var cfr = await this.$bvModal
                              .msgBoxConfirm(rsDel + '\r\nBạn có chắc muốn tiếp tục xóa HĐ trên dữ liệu viễn thông tỉnh?', {
                                title: 'Xác nhận hành động',
                                size: 'sm',
                                okTitle: 'Đồng ý',
                                cancelTitle: 'Hủy'
                              })
                              .then(async (v) => {
                                return v
                              })

                            if (!cfr) return
                          }
                          chuaxoa_hopdong_hoamangmoi = false // xóa thành công thì thuê bao khác trong hđ ko phải gọi hàm xóa trên vinaphone nữa.
                        } else if (kieuld_id_current == KieuLapDat.DM_DIDONG_CHUYEN_TINH) {
                          var rsDel = this.Delete_HD_ChuyenTinh_VinaPhone('84' + str_matb) // phải xóa từng hợp đồng
                          if (rsDel != 'OK') {
                            var cfr = await this.$bvModal
                              .msgBoxConfirm(rsDel + '\r\nBạn có chắc muốn tiếp tục xóa HĐ trên dữ liệu viễn thông tỉnh?', {
                                title: 'Xác nhận hành động',
                                size: 'sm',
                                okTitle: 'Đồng ý',
                                cancelTitle: 'Hủy'
                              })
                              .then(async (v) => {
                                return v
                              })

                            if (!cfr) return
                          }
                        }
                      }
                    }
                    // #endregion

                    //FIXME code xoa thue bao khong thay xoa UMP?????
                    // // #region "Xóa UMP"
                    // if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV)
                    // {
                    //     if (this.listbox.loai_tb.valuemgwan == 157) //Fix ID loại thiết bị STB UMP
                    //     {
                    //       var rs = await this.$root.context.post("http://10.70.52.120:4740/api/DeleteUMP",{"serialNumber":this.thuebao.adsl.txtSerialSTB,});//"mytvUsername":this.dsHDTB[0]["MA_TB"],"mytvPassword":this.dsHDTB[0]["PASSWORD"],
                    //         var kq = JSON.parse(rs.data);
                    //         // var kq = CapNhatUMP(txtSerialSTB.Text.trim(), dsHDTB.Tables[0].Rows[0]["MA_TB"].ToString(), dsHDTB_ADSL.Tables[0].Rows[0]["PASSWORD"].ToString(), ref message);
                    //         if (kq.status!="success")
                    //         {
                    //             Message_Box.ShowWarning("Có lỗi trong quá trình xóa thông tin thiết bị trên UMP. Lỗi: " + kq.message);
                    //             return;
                    //         }

                    //         // string message = "";
                    //         // bool kq = XoaUMP(txtSerialSTB.Text.trim(), ref message);
                    //         // if (!kq)
                    //         // {
                    //         //     Message_Box.ShowWarning("Có lỗi trong quá trình xóa thông tin thiết bị lên UMP. Lỗi: " + message);
                    //         //     return;
                    //         // }
                    //     }
                    // }
                    // // #endregion

                    // laphd2.XOA_HDTB_BC(hdtb_id);
                    var psubdata = { HDTB_ID: this.hdtb_id, KIEULD_ID: this.listbox.kieu_ld.value }
                    //API.post_fn_xoa_thuebao_datmoi(this.axios, { "ds_para": JSON.stringify(psubdata) }).then((response) => {
                    await API.post_xoa_hdtb_bc(this.axios, { vhdtb_id: this.hdtb_id }).then(async (response) => {
                      if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                        var data = response.data
                        if (data.data == '1' || data.data == 1) {
                          this.$toast.success('Xóa thành công!');
                          await API.post_lay_ds_hopdong_tb_theo_hdkh_id(this.axios, {"in_hdkh_id":this.khachhang.hdkh_id }).then((response) => {
                            if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                              var ds_hdkh_tmp = response.data.data;
                              ds_hdkh_tmp = this.LowerCasePropertyList(ds_hdkh_tmp);
                              this.HienThiDanhSacHDTB(ds_hdkh_tmp);
                              this.HienThiTTHopDongTB(ds_hdkh_tmp); // FIXME cho nay trong code cu khong co, nhung co ve can de refresh lai hop dong sau khi xoa
                            }
                          });
                          if(this.lvwThueBao.length<=1) this.buttons.tsbtnXoaTB = false;
                          else this.buttons.tsbtnXoaTB = true;
                        } else {
                          this.$toast.error(data.message+' '+data.message_detail)
                        }
                        // var apidata = JSON.parse(response.data.data)
                        // if (data['ERROR_CODE'] != 1) this.$toast.error(data['MESSAGE'])
                        // else {
                        //   this.$toast.success(data['MESSAGE'])
                        //   API.post_lay_ds_hopdong_tb_theo_hdkh_id(this.axios, { in_hdkh_id: this.khachhang.hdkh_id }).then((response) => {
                        //     if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                        //       var ds_hdkh_tmp = response.data.data
                        //       ds_hdkh_tmp = this.LowerCasePropertyList(ds_hdkh_tmp)
                        //       this.HienThiDanhSacHDTB(ds_hdkh_tmp)
                        //       this.HienThiTTHopDongTB(ds_hdkh_tmp) // FIXME cho nay trong code cu khong co, nhung co ve can de refresh lai hop dong sau khi xoa
                        //     }
                        //   })
                        //   if (this.lvwThueBao.length <= 1) this.buttons.tsbtnXoaTB = false
                        //   else this.buttons.tsbtnXoaTB = true
                        // }
                      }
                    })
                  }
                }
              })
            } catch (ex) {
              this.$toast.error('' + ex)
              if (this.debug) console.error(ex)
            }
          }
        })
    },
    tenKHChanged(v) {
      this.khachhang.tenkh = v.target.value
      if (this.khachhang.tenkh && this.khachhang.tenkh.trim() != '') {
        if (!this.thanhtoan.tentt || this.thanhtoan.tentt.trim() == '') this.thanhtoan.tentt = this.khachhang.tenkh
        if (!this.thuebao.tentb || this.thuebao.tentb.trim() == '') this.thuebao.tentb = this.khachhang.tenkh
        if (!this.khachhang.nguoidd || this.khachhang.nguoidd.trim() == '') this.khachhang.nguoidd = this.khachhang.tenkh
      }
    },
    ngaySinhChanged() {
      if (this.NgaySinh && !this.NgaySinhTB) this.NgaySinhTB = this.NgaySinh
      if (moment().diff(this.NgaySinh, 'years') < 18 && this.vkieukh_id_ == KIEU_KH.CA_NHAN) {
        this.$toast.error('Khách hàng chưa đủ 18 tuổi để làm hợp đồng!')
        return false
      }
      return true
    },
    async btnThongTinKhacClick() {
      var ts_kt_mstmns_kh = this.thamsomacdinh['KIEMTRA_MSTMNS_KHDN']
      // if (this.khachhang.hdkh_id <= 0 && ts_kt_mstmns_kh != 1) {
      //   this.$toast.error('Hãy lập hợp đồng trước')
      //   return
      // }
      if (!this.listbox.loai_kh.value || this.listbox.loai_kh.value == -1) {
        this.$toast.error('Bạn hãy chọn loại khách hàng trước')
        return
      }
      if (this.ts_kt_tthdkhdn == 1 && !this.khachhang.makh && this.kiemtra_nhanvien_vti == 0)
      {
        this.$toast.error("Bạn hãy chọn mã khách hàng web trước !");
          return;
      }
      var chuquan_id = await API.post_fn_tt_dbkh_sub(this.axios,{type: 1, param: this.khachhang.khachhang_id}).then(response=>{
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000')
          return response.data.data;
        else return -1;
      }).catch(err=>{return -1;});
      this.kiemtra_chuquan_kh = chuquan_id && chuquan_id!=-1 ? true : false;
      this.popupComponent = () => import('../InstallNewSubs/Popups/popupInforAdd')
      this.popupComponentName = 'popupInforAdd'
      //this.popupComponentData = {_hdkh_id:this.khachhang.hdkh_id,_nhapmoi:this.buttonSet==1,_vma_kh:this.khachhang.makh,_vkieukh_id:this.vkieukh_id_,_ts_kt_tthdkhdn:this.ts_kt_tthdkhdn}
      this.popupComponentData = {
        _hdkh_id: this.khachhang.hdkh_id,
        _nhapmoi: this.buttonSet == 1,
        _vma_kh: this.kiemtra_nhanvien_vti==1?"VNPTI":this.khachhang.makh,
        _vkieukh_id: this.vkieukh_id_,
        _ts_kt_tthdkhdn: this.ts_kt_tthdkhdn,
        ts_kt_mstmns_kh: ts_kt_mstmns_kh,
        loaikh: this.listbox.loai_kh.value,
        mast: this.khachhang.masothue,
        dsHDKH_Sub: this.dsHDKH_Sub && this.dsHDKH_Sub.length > 0 ? this.dsHDKH_Sub : [],
      }
      this.popupComponentAttr = {isbancheo: this.$root.token.getPhanVungID()==97,}
      this.Popup('popupComponents')
    },
    async ThongBao(msg, title) {
      if (!title) title = 'Lỗi dữ liệu'
      await this.$bvModal.msgBoxOk(msg, {
        title: title,
        size: 'sm',
        okTitle: 'Đồng ý'
      })
    },
    async ValidateModal(bvEvent, modalId) {
      switch (modalId) {
        case 'modal-tieunganh':
          if (
            (this.tieunganh.dsTNC1 && this.tieunganh.dsTNC1.length > 0 && (!this.tieunganh.TNC1_ID || this.tieunganh.TNC1_ID <= 0)) ||
            (this.tieunganh.dsTNC2 && this.tieunganh.dsTNC2.length > 0 && (!this.tieunganh.TNC2_ID || this.tieunganh.TNC2_ID <= 0)) ||
            (this.tieunganh.dsTNC3 && this.tieunganh.dsTNC3.length > 0 && (!this.tieunganh.TNC3_ID || this.tieunganh.TNC3_ID <= 0)) ||
            (this.tieunganh.dsTNC4 && this.tieunganh.dsTNC4.length > 0 && (!this.tieunganh.TNC4_ID || this.tieunganh.TNC4_ID <= 0))
          )
            await this.$toast.error('Bạn chưa chọn chi tiết ngành nghề. Hãy kiểm tra lại!')
          return
        default:
          return
      }
    },
    loaikhChanged(node, insid) {
      this.buttons.btnThongTinKhac = node.cate != 'Cá nhân'
      if (!this.buttons.btnThongTinKhac && this.khachhang.gioitinh == -1) this.khachhang.gioitinh = 0
    },
    async btnChiTietTraTruoc_Click() {
      try {
        var vmuccuoctn_id = 0
        var vtocdotn_id = 0
        //TODO bo qua vi khong phai phan co dinh
        if (
          this.listbox.dichvu_vt.value == DichVuVienThong.ADSL ||
          this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT ||
          this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT ||
          this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU ||
          this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH
        ) {
          if (this.listbox.cboGoiCuocAdsl.value != null && this.listbox.cboGoiCuocAdsl.value != '') vtocdotn_id = this.listbox.cboGoiCuocAdsl.value
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER) {
            if (this.listbox.muccuoc.value != null && this.listbox.muccuoc.value >= 0) vmuccuoctn_id = this.listbox.muccuoc.value
          }
        } else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) vtocdotn_id = this.listbox.tocdokenh.valuecir
        //Convert.ToInt32(cboTocDo.EditValue);
        else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) vtocdotn_id = this.listbox.tocdokenh.valuetsl

        //Hiếu bổ sung thêm hàm lấy tiền khuyến mại 23.09.2010

        var khuyenmai_id_tt = this.filterbox.tratruoc.value
        var kt = -1
        await API.get_kiemTraThoiHanKM(this.axios, { params: { khuyenMaiId: this.filterbox.tratruoc.value, ngayYc: this.NgayYeuCau ? this.NgayYeuCau : null } }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            kt = response.data.data
          }
        })
        if (kt == 0) {
          var ngay_kt_km = ''
          await API.post_lay_ngaykt_km(this.axios, { km_id: this.filterbox.tratruoc.value }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              ngay_kt_km = response.data.data
            }
          })
          var tenkm = this.filterbox.tratruoc.list.filter((x) => x.khuyenmai_id == this.filterbox.tratruoc.value)[0].ten_km
          await this.$bvModal
            .msgBoxConfirm('Khuyến mại ' + tenkm + ' đã hết thời hạn từ ngày ' + ngay_kt_km + '.\nBạn có muốn tiếp tục chọn chi tiết khuyến mại?', {
              title: 'Xác nhận hành động',
              size: 'sm',
              okTitle: 'Đồng ý',
              cancelTitle: 'Hủy'
            })
            .then(async (v) => {
              if (!v) {
                //FIXME khong ro dung lam gi, code cu gan nhu ko co tac dung
                this.kmld.tien_kmld_tt = 0
                this.kmld.vat_kmld_tt = 0
                this.kmld.tyle_kmld = 0
                this.kmld.tong_kmld_tt = 0
                this.kmld.dtiendatcoc_tt = 0
                this.kmld.dvatdatcoc_tt = 0
                await this.HT_ThietBi()
                await this.HT_DichVuGT()
                await this.HienThiTienKhuyenMaiLapDat()
                await this.LayTongTien_HDTB()
              } else kt = 1
            })
          if (kt != 1) return
        }
        // Vinh[v zem lai sualoi anh Long
        this.popupComponent = () => import('../InstallNewSubs/Popups/popup-Dangkychitietkhuyenmai')
        this.popupComponentName = 'popup-DangkychitietkhuyenmaiTT'
        this.popupComponentData = {
          khuyenmai_id: khuyenmai_id_tt,
          vchuyenmang: this.listbox.nhacc_cu.ischecked ? 1 : 0,
          _hdtb_id: this.hdtb_id,
          vdichvuvt_id: this.listbox.dichvu_vt.value,
          m_dsThueBao_DichVu: this.m_dsThueBao_DichVu,
          dsDC_HDTB: this.LowerCasePropertyList(this.dsDC_HDTB),
          vtocdotn_id: vtocdotn_id,
          vmuccuoctn_id: vmuccuoctn_id,
          loaihinh_tb: this.listbox.loaihinh_tb.value,
          kieu_km: 1
        } // 0: khuyen mai, 1 tra truoc
        this.Popup('popupComponents')
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async btnChiTietKM_Click() {
      var vmuccuoctn_id = 0
      var vtocdotn_id = 0
      //TODO tam bo qua vi khong lien quan den co dinh
      if (
        this.listbox.dichvu_vt.value == DichVuVienThong.ADSL ||
        this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT ||
        this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT ||
        this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU ||
        this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH ||
        this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC
      ) {
        if (this.listbox.cboGoiCuocAdsl.value != null && this.listbox.cboGoiCuocAdsl.value != '') vtocdotn_id = this.listbox.cboGoiCuocAdsl.value
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER) {
          if (this.listbox.muccuoc.value != null && this.listbox.muccuoc.value >= 0) vmuccuoctn_id = this.listbox.muccuoc.value
        }
      } else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC) vtocdotn_id = this.listbox.tocdokenh.valuecir
      //Convert.ToInt32(cboTocDo.EditValue);
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC) vtocdotn_id = this.listbox.tocdokenh.valuetsl //Convert.ToInt32(cboTocDoKenhTSL.EditValue);

      //Hiếu bổ sung thêm hàm lấy tiền khuyến mại 23.09.2010
      var khuyenmai_id = this.filterbox.khuyenmai.value
      var kt = -1
      await API.get_kiemTraThoiHanKM(this.axios, { khuyenMaiId: khuyenmai_id, ngayYc: this.NgayYeuCau ? this.NgayYeuCau : null }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          kt = response.data.data
        }
      })
      if (kt == 0) {
        var ngay_kt_km = ''
        await API.post_lay_ngaykt_km(this.axios, { km_id: khuyenmai_id }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            ngay_kt_km = response.data.data
          }
        })
        var tenkm = this.filterbox.khuyenmai.list.filter((x) => x.khuyenmai_id == this.filterbox.khuyenmai.value)[0].ten_km
        await this.$bvModal
          .msgBoxConfirm('Khuyến mại ' + tenkm + ' đã hết thời hạn từ ngày ' + ngay_kt_km + '.\nBạn có muốn tiếp tục chọn chi tiết khuyến mại?', {
            title: 'Xác nhận hành động',
            size: 'sm',
            okTitle: 'Đồng ý',
            cancelTitle: 'Hủy'
          })
          .then(async (v) => {
            if (!v) {
              //FIXME khong ro dung lam gi, code cu gan nhu ko co tac dung
              this.kmld.dtienkmld = 0
              this.kmld.dvatkmld = 0
              this.kmld.tyle_kmld = 0
              this.kmld.tong_kmld = 0
              this.kmld.tien_datcoc = 0
              await this.HT_ThietBi()
              await this.HT_DichVuGT()
              await this.HienThiTienKhuyenMaiLapDat()
              await this.LayTongTien_HDTB()
            } else kt = 1
          })
        if (kt != 1) return
      }
      //VinhPV xem lai sua loi cho anh Long
      this.popupComponent = () => import('../InstallNewSubs/Popups/popup-Dangkychitietkhuyenmai')
      this.popupComponentName = 'popup-Dangkychitietkhuyenmai'
      this.popupComponentData = {
        khuyenmai_id: khuyenmai_id,
        vchuyenmang: this.listbox.nhacc_cu.ischecked ? 1 : 0,
        _hdtb_id: this.hdtb_id,
        vdichvuvt_id: this.listbox.dichvu_vt.value,
        m_dsThueBao_DichVu: this.m_dsThueBao_DichVu,
        dsKM_HDTB: this.LowerCasePropertyList(this.dsKM_HDTB),
        vtocdotn_id: vtocdotn_id,
        vmuccuoctn_id: vmuccuoctn_id,
        loaihinh_tb: this.listbox.loaihinh_tb.value,
        kieu_km: 0
      } // 0: khuyen mai, 1 tra truoc
      this.Popup('popupComponents')
    },
    LaySothang_SD() {
      this.thuebao.thangck = 0
      API.post_fn_lay_thang_sd(this.axios, { ds_para: JSON.stringify({ CHK_KHUYENMAI: this.filterbox.khuyenmai.ischecked ? 1 : 0, CHK_TRATRUOC: this.filterbox.tratruoc.ischecked ? 1 : 0, CBO_TRATRUOC: this.filterbox.tratruoc.value, CBO_KHUYENMAI: this.filterbox.khuyenmai.value }) }).then(
        (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            var kq = JSON.parse(response.data.data)
            if (kq && kq['RESULT'] && kq['RESULT']['SOTHANG_SD']) this.thuebao.thangck = kq['RESULT']['SOTHANG_SD']
          }
        }
      )
    },
    async DangXayDung() {
      this.$toast.error('Chức năng đang được xây dựng và hoàn thiện!')
      if (window && window.Bugpilot) {
        window.Bugpilot.identify({
          id: this.$root.token.getNhanVienID(), // Required
          email: this.$root.token.getUserName(), // Required
          province: this.$root.token.getMaTinh()
        })
        window.Bugpilot.saveReport({
          source: 'InstallNewSubsCrossSale', // Optional
          userProvidedDescription: 'Lap Dat Moi Ban Cheo' // Optional
        })
      }

      await this.TaoDuLieu(this.buttonSet == 1)
    },
    lvwThueBaoChanged(idx, item) {
      try {
        if (idx >= 0) {
          this.loading(true)
          this.hdtb_id = item.hdtb_id
          API.post_lay_ds_hopdong_tb_theo_hdtb_id(this.axios, { in_hdtb_id: item.hdtb_id })
            .then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                var ds = response.data.data
                if (ds && ds.length > 0) this.HienThiTTHopDongTB(ds)
              }
            })
            .finally(() => this.loading(false))
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async ThemHDThanhToan() {
      try {
        this.thanhtoan.matt = ''
        this.loading(true)
        await API.post_fn_kiemtra_dl_thanhtoan(this.axios, {
          ds_para: JSON.stringify({
            DICHVUVT_ID: this.listbox.dichvu_vt.value,
            LOAITB_ID: this.listbox.loaihinh_tb.value,
            BB_CHON_DD: 0,
            QUANTT_ID: this.diachiTT.QUAN_ID,
            PHUONGTT_ID: this.diachiTT.PHUONG_ID,
            PHOTT_ID: this.diachiTT.PHO_ID,
            APTT_ID: this.diachiTT.AP_ID,
            KHUTT_ID: this.diachiTT.KHU_ID,
            HDTB_ID: this.hdtb_id,
            MA_TT: this.thanhtoan.matt,
            THANHTOAN_ID: this.thanhtoan.thanhtoan_id,
            MASOTHUE: this.thanhtoan.masothue,
            TS_KT_MST: this.thamsomacdinh['KIEMTRA_MST'] && this.thamsomacdinh['KIEMTRA_MST'] == 1 ? 1 : 0,
            HDKH_ID: this.khachhang.hdkh_id,
            KHACHHANG_ID: this.khachhang.khachhang_id
          })
        }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            var apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] == 1) {
              await this.TaoDuLieu_HDTT(true)
              await this.TaoDuLieu_HDTT_NV(true)
              await this.TaoDuLieu_DiaChi(true, 2)
              var pdata = {
                HD_THANHTOAN: this.dsHDTT,
                DIACHI: this.dsDiaChi,
                DIACHI_HDTT: this.dsDiaChiHDTT,
                HDTT_NV: this.dsHDTT_NV,
                DS_DIACHI_BC: {
                  DIACHIBC_ID: this.diachiBC.DIACHI_ID,
                  HDTT_ID: this.hdtt_id,
                  PHOBC_ID: this.diachiBC.PHO_ID,
                  PHUONGBC_ID: this.diachiBC.PHUONG_ID,
                  QUANBC_ID: this.diachiBC.QUAN_ID,
                  SONHA_BC: this.diachiBC.SO_NHA,
                  DIACHI_BC: this.diachiBC.DIACHI,
                  TINHBC_ID: this.diachiBC.TINH_ID,
                  APBC_ID: this.diachiBC.AP_ID,
                  KHUBC_ID: this.diachiBC.KHU_ID,
                  DACDIEMBC_ID: this.diachiBC.DACDIEM_ID,
                  BLOCK: this.diachiBC.BLOCK?this.diachiBC.BLOCK:null,
                  TANG: this.diachiBC.TANG?this.diachiBC.TANG:null,
                  PHONG: this.diachiBC.PHONG?this.diachiBC.PHONG:null,
                  MOTA: this.diachiBC.BLOCK?this.diachiBC.MOTA:null,
                }
              }
              await API.post_fn_them_hopdong_thanhtoan(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  //new DatMoiFacade().ThemMoi_HopDongTT(dsHDTT, dsDiaChi, dsDiaChiHDTT, dsHDTT_NV);
                  var apidata = JSON.parse(response.data.data)
                  if (apidata['ERROR_CODE'] == 1) {
                    this.$toast.success(apidata['MESSAGE'])
                    //Them diachi bao cuoc
                    this.diachiBC.DIACHI_ID = 0
                    // this.CapNhat_DiaChiBC(); // co ve da xu ly o buoc insert tren
                    //
                    await this.HienThiDS_HDTT_CBO(this.khachhang.hdkh_id)
                    await API.get_ds_hopdong_tt_theo_hdkh_id(this.axios, { params: { hdkhId: this.khachhang.hdkh_id } }).then(async (response) => {
                      if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                        await this.HienThiDanhSacHDTT(response.data.data)
                      }
                    })
                  } else this.$toast.error(apidata['MESSAGE'])
                }
              })
            } else this.$toast.error(apidata['MESSAGE'])
            //"data": "{\"ERROR_CODE\":1,\"MESSAGE\":\"Thành công\",\"RESULT\":{}}"
          }
        })
        this.loading(false)
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async lvwThanhToanChanged(idx, item) {
      try {
        this.loading(true)
        if (idx >= 0 && item) {
          this.hdtt_id = item.hdtt_id
          await API.post_lay_ds_hopdong_tt_theo_hdtt_id(this.axios, { hdtt_id: this.hdtt_id }).then(async (response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              await this.HienThiTTHopDongTT(response.data.data)
            }
          })
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      } finally {
        this.loading(false)
      }
    },
    async tsbtnXoaTT_Click() {
      if (!this.hdtt_id || this.hdtt_id <= 0) return
      this.$bvModal
        .msgBoxConfirm('Bạn thật sự muốn xóa thanh toán không ?', {
          title: 'Xác nhận hành động',
          size: 'sm',
          okTitle: 'Đồng ý',
          cancelTitle: 'Hủy'
        })
        .then(async (v) => {
          if (v) {
            try {
              this.loading(true)
              await API.post_fn_xoa_hopdong_thanhtoan(this.axios, { ds_para: JSON.stringify({ HDTT_ID: this.hdtt_id }) }).then(async (response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  var apidata = JSON.parse(response.data.data)
                  if (apidata['ERROR_CODE'] == 0) this.$toast.error(apidata['MESSAGE'])
                  else {
                    this.$toast.success(apidata['MESSAGE'])
                    await this.HienThiDS_HDTT_CBO(this.khachhang.hdkh_id)
                    await API.get_ds_hopdong_tt_theo_hdkh_id(this.axios, { params: { hdkhId: this.khachhang.hdkh_id } }).then(async (response) => {
                      if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                        await this.HienThiDanhSacHDTT(response.data.data)
                      }
                    })
                  }
                }
              })
            } catch (ex) {
              this.$toast.error('' + ex)
              if (this.debug) console.error(ex)
            } finally {
              this.loading(false)
            }
          }
        })
    },
    async btnChonSoChinh_Click() {
      if ((!this.khachhang.khachhang_id || this.khachhang.khachhang_id == 0) && (!this.khachhang.hdkh_id || this.khachhang.hdkh_id == 0)) {
        this.$toast.error('Chưa có thông tin khách hàng/hợp đồng !')
        return
      }
      /*
      frmDSSoChinh frm = new frmDSSoChinh();
      if (khachhang_id > 0)
      {
          frm.vid = khachhang_id;
          frm.vloai = 1;
      }
      if (hdkh_id > 0)
      {
          frm.vid = hdkh_id;
          frm.vloai = 2;
      }
      frm.vdichvuvt_id = DichVuVienThong.CO_DINH;
      frm.vloaitb_id = this.listbox.loaihinh_tb.value;
      frm.ShowDialog();
      */
      var tieude = 'Chọn số chính Pabx'
      switch (this.listbox.dichvu_vt.value * 1) {
        case DichVuVienThong.MEGAWAN:
          tieude = 'Chọn hướng kết nối Megawan'
          break
        case DichVuVienThong.CO_DINH:
        case DichVuVienThong.IMS:
          tieude = 'Chọn số chính'
          break
        case DichVuVienThong.HOINGHI_TRUYENHINH:
          tieude = 'Chọn điểm cầu chính'
          break
      }
      var dlist = []
      //BUG: Khong thay gan vkieu, de mac dinh theo DB mau = 1
      var vid = this.khachhang.hdkh_id ? this.khachhang.hdkh_id : this.khachhang.khachhang_id;
      var vloai = this.khachhang.hdkh_id > 0 ? 2 : this.khachhang.khachhang_id > 0 ? 1 : 0;
      if(vloai != 2 && this.khachhang.khachhang_id) {
        var vvid = await bancheo.LAY_KHACHHANGID_THICONG(this.tinh, this.khachhang.khachhang_id)
        if(vvid && vvid>0) vid = vvid+'';
        else {
          this.$toast.error(`Không thể tìm được khách hàng tương ứng bên tỉnh thi công`);
        }
      }
      await API.post_fn_lay_tt_load_dssochinh(this.axios, {
        ds_para: JSON.stringify({ VDICHVUVT_ID: this.listbox.dichvu_vt.value, VID: vid, VLOAI: vloai, VLOAITB_ID: this.listbox.loaihinh_tb.value, VKIEU: 1, BANCHEO: 1, TINH_THICONG: this.tinh.tinhthicong_id }),
        phanvung_id: this.tinh.tinhthicong_id
      }).then(async (response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            this.$toast.error(apidata['MESSAGE'])
            return
          } else {
            dlist = apidata['RESULT']['DS']
            if (dlist) dlist = this.LowerCasePropertyList(dlist)
            if (apidata['RESULT']['TEXT']) tieude = apidata['RESULT']['TEXT']
          }
        }
      })
      if(dlist && dlist.length>0) {
        this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonGrid')
        this.popupComponentName = 'popupDSSoChinh'
        this.popupComponentData = {
          ds: dlist,
          cols: [
            { fieldName: 'loaihinh_tb', headerText: 'Loại hình', allowFiltering: false, allowSorting: false },
            { fieldName: 'ma_tb', headerText: 'Mã thuê bao', allowFiltering: false, allowSorting: false },
            { fieldName: 'trangthai_tb', headerText: 'Trạng thái', allowFiltering: false, allowSorting: false },
            { fieldName: 'tocdo', headerText: 'Tốc độ', allowFiltering: false, allowSorting: false },
            { fieldName: 'diachi_ld', headerText: 'Địa chỉ LĐ', allowFiltering: false, allowSorting: false },
            { fieldName: 'mucuoc_tb', headerText: 'Mức cước', allowFiltering: false, allowSorting: false },
            { fieldName: 'id_sochinh', headerText: 'ID Số chính', allowFiltering: false, allowSorting: false },
            { fieldName: 'loai', headerText: 'kieuld_id', allowFiltering: false, allowSorting: false }
          ],
          keycol: '',
          allowExit: false,
          tieude: tieude,
          tieudebang: ''
        }
        this.Popup('popupComponents')
      }
      else this.$toast.error("Không có dữ liệu danh sách để lựa chọn. Vui lòng xem lại hoặc liên hệ admin!");
    },
    btnTaoMIG_Click() {
      if (!this.khachhang.hdkh_id || this.khachhang.hdkh_id == 0) {
        this.$toast.error('Chưa có thông tin về hợp đồng khách hàng!')
        return
      }

      var obj = {}
      obj.hdkh_id = this.khachhang.hdkh_id
      obj.khachhang_id = this.khachhang.khachhang_id
      obj.hdtt_id = this.hdtt_id
      obj.thanhtoan_id = this.thanhtoan.thanhtoan_id
      obj.fmig_id = this.thanhtoan.mig_id
      obj.fhdmig_id = this.thanhtoan.hdmig_id
      obj.ma_tt = this.thanhtoan.matt
      obj.ten_tt = this.thanhtoan.tentt

      this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonMaInGhep')
      this.popupComponentName = 'popupChonMaInGhep'
      this.popupComponentData = obj
      this.Popup('popupComponents')
    },
    async FormLoad() {
      this.loading(true)
      this.isLoadKH = false;
      this.watcherActive = false
      API.get_lay_dk_bang(this.axios, { params: { tenBang: 'CHUQUAN' } }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.DS_CHUQUAN_THEO_QUYEN = response.data.data
        }
      })
      this.tt_nd = await this.$root.token.getThongTinNguoiDung()
      this.tt_nd.may_cn = await this.$root.token.getMachine()
      this.ctv_id = this.$root.token.getNhanVienID()
      var api1 = API.post_lay_danhmuc_lapmoi_tt_chung_v8(this.axios, {
        vchuoi: 'TRANG_BI|LOAI_TB|CHU_QUAN|TIEN_KM|DOITUONG|DICHVU_VT|LOAIHINH_TB|LOAI_KHL|LOAI_GT|PHANLOAI_KH|LOAI_KH|NGANHANG|HINHTHUC_TT|HINHTHUC_TC|DANTOC|NGANHNGHE|QUOCTICH|HINHTHUC_TTHI|KIEU_HD|GOI_KT|DONVI_QL|KIEU_LD|NHACC_CU|CONGNGHE|HINHTHUC_CM|THOIHAN|LOAI_CSHT|DOITAC|LOAI_IP|PHANLOAI_DV'
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.trangbi.list = response.data.data['trangbi']
          if (this.listbox.trangbi.list && this.listbox.trangbi.list.length > 0) {
            this.listbox.trangbi.valuetsl = this.listbox.trangbi.list[0].trangbi_id
            this.listbox.trangbi.valuecd = this.listbox.trangbi.list[0].trangbi_id
            this.listbox.trangbi.valueims = this.listbox.trangbi.list[0].trangbi_id
            this.listbox.trangbi.valueadsl = this.listbox.trangbi.list[0].trangbi_id
            this.listbox.trangbi.valuedd = this.listbox.trangbi.list[0].trangbi_id
            this.listbox.trangbi.valuegp = this.listbox.trangbi.list[0].trangbi_id
          }
          this.listbox.loai_tb.list = response.data.data['loai_tb']
          this.listbox.chu_quan.list = response.data.data['chu_quan']
          if (this.listbox.chu_quan.list && this.listbox.chu_quan.list.length > 0) {
            this.listbox.chu_quan.valueldcd = this.listbox.chu_quan.list[0].chuquan_id * 1
            this.listbox.chu_quan.valuecd = this.listbox.chu_quan.list[0].chuquan_id * 1
            this.listbox.chu_quan.valuewan = this.listbox.chu_quan.list[0].chuquan_id * 1
            this.listbox.chu_quan.valueldmgwan = this.listbox.chu_quan.list[0].chuquan_id * 1
            this.listbox.chu_quan.valueadsl = this.listbox.chu_quan.list[0].chuquan_id * 1
            this.listbox.chu_quan.valueldadsl = this.listbox.chu_quan.list[0].chuquan_id * 1
            this.listbox.chu_quan.valuetsl = this.listbox.chu_quan.list[0].chuquan_id * 1
            this.listbox.chu_quan.valueims = this.listbox.chu_quan.list[0].chuquan_id * 1
            this.listbox.chu_quan.valueldims = this.listbox.chu_quan.list[0].chuquan_id * 1
          }
          this.thuebao.tsl.cboChuQuanLD_Dau.list = response.data.data['chu_quan']
          if (this.thuebao.tsl.cboChuQuanLD_Dau.list && this.thuebao.tsl.cboChuQuanLD_Dau.list.length > 0) {
            this.thuebao.tsl.cboChuQuanLD_Dau.value = this.thuebao.tsl.cboChuQuanLD_Dau.list[0].chuquan_id * 1
          }
          this.thuebao.tsl.cboChuQuanLD_Cuoi.list = response.data.data['chu_quan']
          if (this.thuebao.tsl.cboChuQuanLD_Cuoi.list && this.thuebao.tsl.cboChuQuanLD_Cuoi.list.length > 0) {
            this.thuebao.tsl.cboChuQuanLD_Cuoi.value = this.thuebao.tsl.cboChuQuanLD_Cuoi.list[0].chuquan_id * 1
          }
          this.listbox.tien_km.list = response.data.data['tien_km']
          this.ds_tien_khoanmuc = JSON.parse(JSON.stringify(this.listbox.tien_km.list))
          this.listbox.doituong.list = response.data.data['doituong']
          if (this.listbox.doituong.list && this.listbox.doituong.list.length > 0) this.listbox.doituong.value = this.listbox.doituong.list && this.listbox.doituong.list[0] ? this.listbox.doituong.list[0].doituong_id : 0
          this.listbox.dichvu_vt.list = response.data.data['dichvu_vt']
          if (this.listbox.dichvu_vt.list && this.listbox.dichvu_vt.list.length > 0) this.listbox.dichvu_vt.value = this.listbox.dichvu_vt.list[0].dichvuvt_id
          this.listbox.loaihinh_tb.list = response.data.data['loaihinh_tb']
          this.listbox.loai_khl.list = response.data.data['loai_khl']
          this.dtPhanLoaiKH = this.listbox.loai_khl.list.filter((x) => x.nhom_pl == '1')
          this.listbox.loai_gt.list = response.data.data['loai_gt']
          if (this.listbox.loai_gt.list && this.listbox.loai_gt.list.length > 0) this.listbox.loai_gt.value = this.listbox.loai_gt.list[0].loaigt_id
          this.listbox.phanloai_kh.list = response.data.data['phanloai_kh']
          this.listbox.loai_kh.list = response.data.data['loai_kh']
          this.listbox.nganhang.list = response.data.data['nganhang']
          this.listbox.hinhthuc_tt.list = response.data.data['hinhthuc_tt']
          if (this.listbox.hinhthuc_tt.list && this.listbox.hinhthuc_tt.list.length > 0) this.listbox.hinhthuc_tt.value = this.listbox.hinhthuc_tt.list[0].httt_id
          this.listbox.hinhthuc_tc.list = response.data.data['hinhthuc_tc']
          if (this.listbox.hinhthuc_tc.list && this.listbox.hinhthuc_tc.list.length > 0) {
            this.listbox.hinhthuc_tc.value = this.listbox.hinhthuc_tc.list[0].httc_id
            this.listbox.hinhthuc_tc.valueims = 2 //Default 2 do o day filter chi co gia tri 2 hoac 3//this.listbox.hinhthuc_tc.list[0].httc_id;
          }
          this.listbox.dantoc.list = response.data.data['dantoc']
          if (this.listbox.dantoc.list && this.listbox.dantoc.list.length > 0) this.listbox.dantoc.value = this.listbox.dantoc.list[0].dantoc_id
          this.listbox.nganhnghe.list = response.data.data['nganhnghe']
          if (this.listbox.nganhnghe.list && this.listbox.nganhnghe.list.length > 0) this.listbox.nganhnghe.value = this.listbox.nganhnghe.list[0].nganhnghe_id
          this.listbox.quoctich.list = response.data.data['quoctich']
          if (this.listbox.quoctich.list && this.listbox.quoctich.list.length > 0) this.listbox.quoctich.value = this.listbox.quoctich.list[0].quoctich_id
          this.listbox.hinhthuc_tthi.list = response.data.data['hinhthuc_tthi']
          if (this.listbox.hinhthuc_tthi.list && this.listbox.hinhthuc_tthi.list.length > 0) this.listbox.hinhthuc_tthi.value = this.listbox.hinhthuc_tthi.list[0].httthi_id == 0 ? this.listbox.hinhthuc_tthi.list[1].httthi_id : this.listbox.hinhthuc_tthi.list[0].httthi_id
          this.listbox.kieu_hd.list = response.data.data['kieu_hd']
          if (this.listbox.kieu_hd.list && this.listbox.kieu_hd.list.length > 0) this.listbox.kieu_hd.value = this.listbox.kieu_hd.list[0].kieuhd_id
          this.listbox.goi_kt.list = response.data.data['goi_kt']
          this.listbox.donvi_ql.list = response.data.data['donvi_ql']
          if (this.listbox.donvi_ql.list && this.listbox.donvi_ql.list.filter((dv) => dv.loaidv_id == 3).length > 0) this.listbox.donvi_ql.value = this.listbox.donvi_ql.list.filter((dv) => dv.loaidv_id == 3)[0].donvi_id
          if (this.listbox.donvi_ql.list && this.listbox.donvi_ql.list.filter((dv) => dv.loaidv_id == 2).length > 0) this.listbox.donvi_ql.valueql = this.listbox.donvi_ql.list.filter((dv) => dv.loaidv_id == 2)[0].donvi_id
          this.listbox.kieu_ld.list = response.data.data['kieu_ld']
          this.listbox.nhacc_cu.list = response.data.data['nhacc_cu']
          this.listbox.congnghe.list = response.data.data['congnghe']
          this.defaultCongNghe(this.listbox.kieu_ld.value)
          this.listbox.hinhthuc_cm.list = response.data.data['hinhthuc_cm']
          this.listbox.thoihan.list = response.data.data['thoihan']
          if (this.listbox.thoihan.list && this.listbox.thoihan.list.length > 0) {
            this.listbox.thoihan.valuecd = this.listbox.thoihan.list[0].thoihan_id
            this.listbox.thoihan.value = this.listbox.thoihan.list[0].thoihan_id
            this.listbox.thoihan.valuetsl = this.listbox.thoihan.list[0].thoihan_id
            this.listbox.thoihan.valuewan = this.listbox.thoihan.list[0].thoihan_id
            this.listbox.thoihan.valueadsl = this.listbox.thoihan.list[0].thoihan_id
            this.listbox.thoihan.valueims = this.listbox.thoihan.list[0].thoihan_id
          }
          this.listbox.loai_csht.list = response.data.data['loai_csht']
          if (this.listbox.loai_csht.list && this.listbox.loai_csht.list.length > 0) {
            this.listbox.loai_csht.value = this.listbox.loai_csht.list[0].loai_csht_id
          }
          this.listbox.cboLoai_CSHT.list = response.data.data['loai_csht']
          if (this.listbox.cboLoai_CSHT.list && this.listbox.cboLoai_CSHT.list.length > 0) {
            this.listbox.cboLoai_CSHT.value = this.listbox.cboLoai_CSHT.list[0].loai_csht_id
          }
          this.listbox.doitac.list = response.data.data['doitac']
          if (this.listbox.doitac.list && this.listbox.doitac.list.length > 0) {
            this.listbox.doitac.valuecsht = this.listbox.doitac.list[0].doitac_id
            this.listbox.doitac.valueims = this.listbox.doitac.list[0].doitac_id
          }
          this.listbox.cboDoiTac_CSHT.list = response.data.data['doitac']
          if (this.listbox.cboDoiTac_CSHT.list && this.listbox.cboDoiTac_CSHT.list.length > 0) {
            this.listbox.cboDoiTac_CSHT.value = this.listbox.cboDoiTac_CSHT.list[0].doitac_id
          }
          this.listbox.cboLoaiIP.list = response.data.data['loaiip']
          if (this.listbox.cboLoaiIP.list && this.listbox.cboLoaiIP.list.length > 0) {
            this.listbox.cboLoaiIP.value = this.listbox.cboLoaiIP.list[0].loaiip_id
            this.listbox.cboLoaiIP.values = [this.listbox.cboLoaiIP.list[0].loaiip_id]
            this.listbox.cboLoaiIP.valueitems = [this.listbox.cboLoaiIP.list[0]].map((lo) => ({ id: lo.loaiip_id, text: lo.loai_ip }))
          }
          this.listbox.phanloai_dv.list = response.data.data['phanloai_dv']
        }
      })
      var api2 = API.post_lay_ds_nganhnghe(this.axios, { vma: 'NGANHNGHE' }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.nganhngheloc.list = response.data.data
          if (this.listbox.nganhngheloc.list && this.listbox.nganhngheloc.list.length > 0) this.listbox.nganhngheloc.value = this.listbox.nganhngheloc.list[0].nganhnghe_id
        }
      })
      var api3 = API.post_sp_ht_chitietdv_ims(this.axios, { kieu: '1' }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.ht_chitietdv_ims.list = response.data.data
          if (this.listbox.ht_chitietdv_ims.list && this.listbox.ht_chitietdv_ims.list.length > 0) this.listbox.ht_chitietdv_ims.value = this.listbox.ht_chitietdv_ims.list[0].ctdv_id
        }
      })
      var api4 = API.post_sp_ht_phantach_tocdo(this.axios, { kieu: '1' }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.ht_phantach_tocdo.list = response.data.data
          if (this.listbox.ht_phantach_tocdo.list && this.listbox.ht_phantach_tocdo.list.length > 0) this.listbox.ht_phantach_tocdo.value = this.listbox.ht_phantach_tocdo.list[0].phantach_id
        }
      })
      var api5 = API.post_lay_thamso_macdinh(this.axios, { vma_ts: 'CHUQUAN_ID' }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.thamso_nguoidung.chuquanmd_id = response.data.data
        }
      })
      var api6 = API.post_lay_thamso_md(this.axios, { kieu_id: 0 }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.thamsomacdinh = response.data.data.reduce(function(result, item, index, array) {
            result[item['ma_ts']] = item['ten_ts'] //a, b, c
            return result
          }, {}) //.map(x => ({ [x['ma_ts']]:x['ten_ts'] }));
          this.TUDONG_SINH_SOAO = this.thamsomacdinh['TUDONG_SINH_SOAO'] ? true : false
          if (this.thamsomacdinh['PHANTAP_KH'] && this.thamsomacdinh['PHANTAP_KH'] == 1) this.PHANTAP_KH = 1
          if (this.thamsomacdinh['DONVIQL_HTTT'] && this.thamsomacdinh['DONVIQL_HTTT'] == 1) this.DONVIQL_HTTT = 1
          if (this.thamsomacdinh['CHONSO_MOI'] && this.thamsomacdinh['CHONSO_MOI'].length > 0) this.CHONSO_MOI = true
          if (this.thamsomacdinh['CHONSO_MOI_V2'] && this.thamsomacdinh['CHONSO_MOI_V2'].length > 0) this.CHONSO_MOI_V2 = true
          if (this.thamsomacdinh['KHUVUC_THEO_KETCUOI'] && this.thamsomacdinh['KHUVUC_THEO_KETCUOI'] == 1) this.KHUVUC_THEO_KETCUOI = 1
          if (this.thamsomacdinh['THEM_TT_HDKHDN'] && this.thamsomacdinh['THEM_TT_HDKHDN'] == 1) this.ts_kt_tthdkhdn = 1

          //TODO cai tham so mac dinh nay de gan gia tri dieu khien. Thay doi logic de xu ly sau cho gon code.
        }
      })
      //TODO HT_DS_KhuyenMai_Combobox(); Khong can goi o day vi cac tham so can thiet de tinh toan ham nay chua load o giai doan nay.
      var api7 = API.post_lay_ds_dvk_macdinh(this.axios, { vloaiid: 2, vloaitb_id: 0 }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          //day la lay tu ham LAY_DS_DVK_TT_MACDINH, trong ham nay sau khi dua du lieu ra datarow (DANGKY_DVKRow) thi goi tiep 1 ham khac: HT_DichVuKhac de hien thi ra Listbox lvDvkhac
          this.dsDK_DVK_TT = response.data.data.map((x) => ({ DVKHAC_ID: x['dvkhac_id'], TEN_DVKHAC: x['ten_dvkhac'], KIEU_YC: x['caidat_md'], LOAIID: x['loaiid'], TTTH: 0, HD_ID: this.hdtb_id, NGAY_YC: this.NgayYeuCau }))
          this.HT_DichVuKhac(this.dsDK_DVK_TT, 2)
          /*
          for (int i = 0; i < dset.Tables[0].Rows.Count; i++)
          {
              DataSet ds = bangts.TTCT_DichVuKhac(Convert.ToInt32(dset.Tables[0].Rows[i]["dvkhac_id"]));
              str = ds[0]["ten_dvkhac"];
              lvDvkhac.Items.Add(str);
          }
          */
          //this.thamsomacdinh = response.data.data.map(x => ({ [x['ma_ts']]:x['ten_ts'] }));
        }
      })
      var api8 = API.post_lay_ds_dl_nghiepvu(this.axios, { p_ds_para: null, p_nghiepvu: 'HT_TRANGTHAI_YC' }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.trangthai_yc.list = response.data.data
          if (this.listbox.trangthai_yc.list && this.listbox.trangthai_yc.list.length > 0) this.listbox.trangthai_yc.value = this.listbox.trangthai_yc.list[0].trangthaiyc_id
        }
      })
      var api9 = API.post_lay_ds_tinh_thicong_combobox(this.axios, {}).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.cboTinh.list = response.data.data
          if (this.listbox.cboTinh.list && this.listbox.cboTinh.list.length > 0) {
            this.listbox.cboTinh.value = this.listbox.cboTinh.list[0].tinh_id
            this.cboTinh_EditValueChanged()
          }
        }
      })
      var api10 = API.post_DS_TINH_THICONG(this.axios, {}).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.thuebao.tsl.cboTinhDau.list = this.UpperCasePropertyList(response.data.data)
          this.thuebao.tsl.cboTinhCuoi.list = this.UpperCasePropertyList(response.data.data)
          if (response.data.data.length > 0) {
            if (!this.thuebao.tsl.cboTinhDau.value) this.thuebao.tsl.cboTinhDau.value = 0//response.data.data[0].TINH_ID ? response.data.data[0].TINH_ID : response.data.data[1].TINH_ID
            if (!this.thuebao.tsl.cboTinhCuoi.value) this.thuebao.tsl.cboTinhCuoi.value = 0//response.data.data[0].TINH_ID ? response.data.data[0].TINH_ID : response.data.data[1].TINH_ID
            // this.cboTinh_EditValueChanged();
          }
        }
      })
      //TODO LINE 1546 - 1625
      // #region Tham so khac
      var str = ''
      if (this.Tag) {
        str = this.Tag
        var words = str.split('+')
        if (words.length >= 1) this.iKieu = words[0]
        if (words.length >= 2) {
          this.iKenhTN = words[1]
        }

        if (words.length >= 3) {
          this._fiberBoSung = words[2]
        }
      } else {
        this.iKieu = 0
      }
      // FIXME day la de doi ten form (dung chung)
      if (this.iKieu == 1) {
        this.header.title = 'SỬA KM ĐẶT MỚI'
      } else {
        this.header.title = 'LẮP ĐẶT MỚI'
      }
      // visibleToolStripMenuAndControl(iKieu == 0);
      // hoangpkn : 06/10/2016 Không cho chọn kiểu trả trước với Mytv
      //cboKieuTra.Enabled = false; //FIXME chua xu ly
      // end hoang
      //cboTocDo_PIR.Enabled = false; //FIXME chua xu ly
      // TODO lam sau, chua xu ly!
      // if (ht_khl == 1)
      // {
      //     lblKHL.Visible = true;
      //     cboKhachHangLon.Visible = true;
      //     lblPhanLoaiKH.Visible = false;
      //     txtPhanLoaiKH.Visible = false;
      // }
      // else
      // {
      //     lblKHL.Visible = false;
      //     cboKhachHangLon.Visible = false;
      //     lblPhanLoaiKH.Visible = true;
      //     txtPhanLoaiKH.Visible = true;
      // }
      // txtMaTT.ContextMenu = new ContextMenu();

      //FIXME IMPORTANT load mac dinh thong tin ctv
      if (this.thamsomacdinh['MACDINH_CTV_NGUOIDUNG'] == 1) {
        // await API.post_lay_ds_thamso_md(this.axios, {
        //   list_of_cols: '*',
        //   order: '',
        //   schema: 'admin',
        //   table_name: 'nhanvien',
        //   where: 'nhanvien_id = ' + this.$root.token.getNhanVienID()
        // }).then((response) => {
        await API.post_sp_tt_nhanvien(this.axios, { p_type: 3, p_param: this.$root.token.getNhanVienID() }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            this.filterbox.ctv.value = response.data.data[0].ten_nv
            this.filterbox.ctv.ma_ctv = response.data.data[0].nhanvien_id //ma_nv la ma text
            this.filterbox.ctv.ischecked = true
          }
        })

        //     CheckDataFacade checkdata = new CheckDataFacade();
        //     ctv_id = tt_nd.nhanvien_id;
        //     ma_ctv = tt_nd.ma_nv;
        //     donvi_ctv_id = tt_nd.donvi_id;
        //txtCTV.Text = checkdata.MAP_ID("ten_nv", DatabaseConstants.DB1 + ".nhanvien", "where nhanvien_id =" + ctv_id);
        //     form_load = true;
        //     chkCTV.Checked = true;//Làm thế này để ko bật form chọn ctv khi load lúc đầu
        //     form_load = false;
      }

      if (this.thamsomacdinh['THEM_TT_HDKHDN'] == 1) {
        this.ts_kt_tthdkhdn = 1
        // btnTTKhac.Text = "Thông tin hợp đồng";
      }
      // if (this.ts_kt_tthdkhdn == 1) {
      //   API.post_kiemtra_nhanvien_vti_khdn(this.axios, {
      //     tinhthicong_id: 100,
      //     vnhanvien_id: this.$root.token.getNhanVienID(), //tt_nd.nhanvien_id,
      //     vdonvi_id: this.$root.token.getDonViDuLieuID(), //tt_nd.donvi_dl_id,
      //     vnguoidung_id: this.tt_nd.nguoidung_id
      //   }).then((response) => {
      //     if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //       this.kiemtra_nhanvien_vti = response.data.data == 'OK' ? 1 : 0
      //     }
      //   })
      // }

      //TODO neu matinh == 'HNI' thi bat nut btnSite_ID
      // if (matinh == "HNI")
      //     btnSite_ID.Visible = true;
      // // #endregion
      // Form Shown event
      this.listbox.trangbi.valuecd = TRANGBI.KHACHHANG_TU_TRANGBI
      this.listbox.trangbi.valueims = TRANGBI.KHACHHANG_TU_TRANGBI
      this.listbox.trangbi.valueadsl = TRANGBI.KHACHHANG_TU_TRANGBI
      var api12 = this.LAY_DS_DVGT_MACDINH(this.listbox.loaihinh_tb.value)
      var api13 = this.LAY_DS_DVK_MACDINH_TB(this.listbox.loaihinh_tb.value)
      // TODO chua xu ly do muc dich phan nay chua ro rang
      // if (!chuanhoa_cntt && !chuanhoa_ca)
      //   cboDichVuVT_SelectedValueChanged(cboDichVuVT, null);
      this.kt_load = false
      await Promise.all([api1, api2, api3, api4, api5, api6, api7, api8, api9, api10, api12, api13])
        .then(async () => {
          await this.HT_GIAODIEN_DONVI()
          await this.LayTienTheoKhoanMuc()
        })
        .catch(() => {})
        .then(async () => {
          await this.HT_GIAODIEN_DONVI()
          await this.LayTienTheoKhoanMuc()
        })
        .finally(() => {})
        .then(async () => {
          this.loading(false)
          const rsTinh = await this.$refs.dlgChonTinh.showModal()
          if (rsTinh) {
            this.listbox.cboTinh.value = rsTinh
            // label29.Text += " " + tinh.matinh.ToUpper(); <- TODO: can xac dinh vi tri cua label 29
            this.cboTinh_EditValueChanged()
          }
          this.watcherActive = true
          // var oridata = Object.assign({}, this.$data);
          // this.originalData = oridata;
          if (this.$route.query.makh && this.$route.query.makh.trim() != '') {
            this.khachhang.makh = this.$route.query.makh //https://onebss-dev.vnptit3.vn/#/contract/installnewsubs?makh=HPG-001162767
            this.MaKHChanged()
          }
          if (this.$route.query.magd && this.$route.query.magd.trim() != '') {
            this.khachhang.magd = this.$route.query.magd //https://onebss-dev.vnptit3.vn/#/contract/installnewsubs?magd=HPG-LD%2F00736701
            this.MaGDChanged()
          }
        })
    },
    LoadTuHopDongTuVan(phdkh_cha_id) {
      this.IS_HD_TUVAN = true
      try {
        this.buttonSet = 1
        API.post_sp_lay_thongtin_hdkh_tuvan(this.axios, { hdkh_cha_id: phdkh_cha_id, kieu: 1 }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            var apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] == 1) {
              this.hdkh_cha_id = phdkh_cha_id
              apidata = apidata['RESULT']
              if (apidata['KHACHHANG_ID'] && apidata['KHACHHANG_ID'] > 0) {
                this.khachhang.khachhang_id = apidata['KHACHHANG_ID']
                this.khachhang.makh = apidata['MA_KH']
                let e = { target: { value: apidata['MA_KH'] } }
                this.MaKHChanged(e)
              } else {
                if (apidata['TEN_KH']) {
                  this.khachhang.tenkh = apidata['TEN_KH']
                  this.thanhtoan.tentt = apidata['TEN_KH']
                  this.thuebao.tentb = apidata['TEN_KH']
                }
                if (apidata['DIACHI_KH']) {
                  this.diachiKH.DIACHI = apidata['DIACHI_KH']
                  this.diachiTT.DIACHI = apidata['DIACHI_KH']
                  this.diachiTB.DIACHI = apidata['DIACHI_KH']
                  this.diachiLD.DIACHI = apidata['DIACHI_KH']
                }
                if (apidata['TINH_ID']) {
                  this.diachiKH.TINH_ID = apidata['TINH_ID']
                  this.diachiTT.TINH_ID = apidata['TINH_ID']
                  this.diachiTB.TINH_ID = apidata['TINH_ID']
                  this.diachiLD.TINH_ID = apidata['TINH_ID']
                }
                if (apidata['QUAN_ID']) {
                  this.diachiKH.QUAN_ID = apidata['QUAN_ID']
                  this.diachiTT.QUAN_ID = apidata['QUAN_ID']
                  this.diachiTB.QUAN_ID = apidata['QUAN_ID']
                  this.diachiLD.QUAN_ID = apidata['QUAN_ID']
                }
                if (apidata['PHUONG_ID']) {
                  this.diachiKH.PHUONG_ID = apidata['PHUONG_ID']
                  this.diachiTT.PHUONG_ID = apidata['PHUONG_ID']
                  this.diachiTB.PHUONG_ID = apidata['PHUONG_ID']
                  this.diachiLD.PHUONG_ID = apidata['PHUONG_ID']
                }
                if (apidata['PHO_ID']) {
                  this.diachiKH.PHO_ID = apidata['PHO_ID']
                  this.diachiTT.PHO_ID = apidata['PHO_ID']
                  this.diachiTB.PHO_ID = apidata['PHO_ID']
                  this.diachiLD.PHO_ID = apidata['PHO_ID']
                }
                if (apidata['KHU_ID']) {
                  this.diachiKH.KHU_ID = apidata['KHU_ID']
                  this.diachiTT.KHU_ID = apidata['KHU_ID']
                  this.diachiTB.KHU_ID = apidata['KHU_ID']
                  this.diachiLD.KHU_ID = apidata['KHU_ID']
                }
                if (apidata['AP_ID']) {
                  this.diachiKH.AP_ID = apidata['AP_ID']
                  this.diachiTT.AP_ID = apidata['AP_ID']
                  this.diachiTB.AP_ID = apidata['AP_ID']
                  this.diachiLD.AP_ID = apidata['AP_ID']
                }
                if (apidata['SONHA']) {
                  this.diachiKH.SONHA = apidata['SONHA']
                  this.diachiTT.SONHA = apidata['SONHA']
                  this.diachiTB.SONHA = apidata['SONHA']
                  this.diachiLD.SONHA = apidata['SONHA']
                }
                if (apidata['BLOCK']) {
                  this.diachiKH.BLOCK = apidata['BLOCK']
                  this.diachiTT.BLOCK = apidata['BLOCK']
                  this.diachiTB.BLOCK = apidata['BLOCK']
                  this.diachiLD.BLOCK = apidata['BLOCK']
                }
                if (apidata['TANG']) {
                  this.diachiKH.TANG = apidata['TANG']
                  this.diachiTT.TANG = apidata['TANG']
                  this.diachiTB.TANG = apidata['TANG']
                  this.diachiLD.TANG = apidata['TANG']
                }
                if (apidata['PHONG']) {
                  this.diachiKH.PHONG = apidata['PHONG']
                  this.diachiTT.PHONG = apidata['PHONG']
                  this.diachiTB.PHONG = apidata['PHONG']
                  this.diachiLD.PHONG = apidata['PHONG']
                }
                if (apidata['MOTA']) {
                  this.diachiKH.MOTA = apidata['MOTA']
                  this.diachiTT.MOTA = apidata['MOTA']
                  this.diachiTB.MOTA = apidata['MOTA']
                  this.diachiLD.MOTA = apidata['MOTA']
                }
                if (apidata['VIDO']) {
                  this.diachiKH.Lat = apidata['VIDO']
                  this.diachiTT.Lat = apidata['VIDO']
                  this.diachiTB.Lat = apidata['VIDO']
                  this.diachiLD.Lat = apidata['VIDO']
                }
                if (apidata['KINHDO']) {
                  this.diachiKH.Lng = apidata['KINHDO']
                  this.diachiTT.Lng = apidata['KINHDO']
                  this.diachiTB.Lng = apidata['KINHDO']
                  this.diachiLD.Lng = apidata['KINHDO']
                }
                if (apidata['SO_DT']) {
                  this.khachhang.dienthoai = apidata['SO_DT']
                }
                if (apidata['LOAIGT_ID']) this.listbox.loai_gt.value = apidata['LOAIGT_ID']
                if (apidata['SO_GT']) this.khachhang.sogt = apidata['SO_GT']
                if (apidata['NGAYCAP']) this.NgayCap = apidata['NGAYCAP']
                if (apidata['NOICAP']) this.khachhang.noicap = apidata['NOICAP']
              }
            } else this.$toast.error(apidata['MESSAGE'])
          }
        })
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    LoadTuHopDongTuVan_v2(phdkh_cha_id, vdichvuvt_id, vloaitb_id) {
      if (vdichvuvt_id) this.listbox.dichvu_vt.value = vdichvuvt_id
      if (vloaitb_id) this.listbox.loaihinh_tb.value = vloaitb_id
      this.LoadTuHopDongTuVan(phdkh_cha_id)
    },
    cboLoaiSoWan_SelectedValueChanged(item) {
      if (!item || item <= 0) return
      this.thuebao.hdtb_id_cha = 0
      this.thuebao.thuebao_id_cha = 0
      this.thuebao.mgwan.huongkn = ''
      this.thuebao.mgwan.vhuongkn = ''
      this.listbox.tinh_kn.value = 0
      try {
        this.listbox.tinh_kn.value = this.$root.token.getPhanVungID()
      } catch (ex) {}
      this.diachiKN = this.$options.data.call(this).diachiKN
      this.buttons.btnHuongKNWan = item * 1 == LOAINODE_MGWAN.NODE_CHINH
    },
    async LayMaTBBC(vthem_moi) {
      this.bc_ma_tb_ao_ht = ''
      var _loaitb_id = 0
      if (this.listbox.loaihinh_tb.value) _loaitb_id = this.listbox.loaihinh_tb.value * 1
      switch (this.listbox.dichvu_vt.value * 1) {
        case DichVuVienThong.CO_DINH:
          this.bc_ma_tb_ht = this.thuebao.codinh.somay //txtSoMayCD.Text.trim();
          break
        case DichVuVienThong.DI_DONG:
          this.bc_ma_tb_ht = this.thuebao.didong.txtSoMayDD ? this.thuebao.didong.txtSoMayDD.trim() : this.thuebao.didong.txtSoMayDD //txtSoMayDD.Text.trim();
          break
        case DichVuVienThong.MEGA_EYES:
          this.bc_ma_tb_ht = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.trim() : this.thuebao.adsl.txtAccountADSL //txtAccountADSL.Text.trim();
          if (this.TUDONG_SINH_SOAO && vthem_moi) this.bc_ma_tb_ao_ht = await bancheo.SINH_MALT(this.tinh.tinhthicong_id, this.diachiLD.QUAN_ID, DichVuVienThong.MEGA_EYES, _loaitb_id, '')
          //sinhmoi.SINH_MALT(tinh, quanld_id, DichVuVienThong.MEGA_EYES, _loaitb_id, "");
          else this.bc_ma_tb_ao_ht = this.thuebao.adsl.txtSoAoAdsl ? this.thuebao.adsl.txtSoAoAdsl.trim() : '' //txtSoAoAdsl.Text.trim();
          break
        case DichVuVienThong.DICHVU_CNTT:
        case DichVuVienThong.ANTOAN_BAOMAT_TT:
        case DichVuVienThong.TRUNGTAM_DULIEU:
        case DichVuVienThong.HOINGHI_TRUYENHINH:
        case 50:
          if (this.gridEditors == null) return
          // grvMacdinh.CloseEditor();
          for (var index = 0; index < this.gridEditors.length; ++index) {
            if (this.gridEditors[index].ID == 'MA_TB')
              if (this.gridEditors[index].Value && this.gridEditors[index].Value != '') {
                this.bc_ma_tb_ht = this.gridEditors[index].Value
                break
              }
          }
          break
        case DichVuVienThong.ADSL:
        case DichVuVienThong.HATANG_VIENTHONG:
          if (_loaitb_id == LoaiHinhTB.INTERNET_MYTV && this.thamsomacdinh['MYTV_HOA'] == 1) {
            this.thuebao.adsl.txtAccountADSL = this.thuebao.adsl.txtAccountADSL.toUpperCase()
          }
          this.bc_ma_tb_ht = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.trim() : this.thuebao.adsl.txtAccountADSL
          this.bc_ma_tb_ao_ht = '' // hoàng pkn : truyền tạm = null. chuyển hợp đồng update sau ( hàm bancheo_chuyentinh_tc)
          break
        case DichVuVienThong.MEGAWAN:
        case DichVuVienThong.METRONET:
        case DichVuVienThong.NOIBO_DADIEM:
          this.bc_ma_tb_ht = this.thuebao.mgwan.txtMaTBWan.Text ? this.thuebao.mgwan.txtMaTBWan.Text.trim() : this.thuebao.mgwan.txtMaTBWan.Text
          if (this.TUDONG_SINH_SOAO && vthem_moi) {
            this.bc_ma_tb_ao_ht = await bancheo.SINH_MALT(this.tinh.tinhthicong_id, this.diachiLD.QUAN_ID, this.listbox.dichvu_vt.value, _loaitb_id, '') //sinhmoi.SINH_MALT(tinh, quanld_id, DichVuVienThong.METRONET, _loaitb_id, "");
            this.thuebao.mgwan.soao = this.ma_tb_ao_ht
          } else this.bc_ma_tb_ao_ht = this.thuebao.mgwan.soao ? this.thuebao.mgwan.soao.trim() : this.thuebao.mgwan.soao //txtSoAoWan.Text.trim();
          break
        case DichVuVienThong.TSL:
        case DichVuVienThong.NOIBO_2DIEM:
          this.bc_ma_tb_ht = this.thuebao.tsl.txtMaTSL.Text ? this.thuebao.tsl.txtMaTSL.Text.trim() : this.thuebao.tsl.txtMaTSL.Text
          if (this.TUDONG_SINH_SOAO && vthem_moi) {
            this.bc_ma_tb_ao_ht = await bancheo.SINH_MALT(this.tinh.tinhthicong_id, this.diachiLD.QUAN_ID, (this.listbox.dichvu_vt.value==DichVuVienThong.NOIBO_2DIEM?DichVuVienThong.NOIBO_2DIEM:DichVuVienThong.TSL), _loaitb_id, '') //sinhmoi.SINH_MALT(tinh, quanld_id, DichVuVienThong.TSL, _loaitb_id, "");
            this.bc_ma_tb_ao_ht_cuoi = await bancheo.SINH_MALT(this.tinh.tinhthicong_id, this.diachiLD.QUAN_ID, (this.listbox.dichvu_vt.value==DichVuVienThong.NOIBO_2DIEM?DichVuVienThong.NOIBO_2DIEM:DichVuVienThong.TSL), _loaitb_id, '') //sinhmoi.SINH_MALT(tinh, quanld_id, DichVuVienThong.TSL, _loaitb_id, "");
          } else {
            this.bc_ma_tb_ao_ht = this.thuebao.tsl.txtSoAoTSL_Dau ? this.thuebao.tsl.txtSoAoTSL_Dau.trim() : this.thuebao.tsl.txtSoAoTSL_Dau
            this.bc_ma_tb_ao_ht_cuoi = this.thuebao.tsl.txtSoAoTSL_Cuoi ? this.thuebao.tsl.txtSoAoTSL_Cuoi.trim() : this.thuebao.tsl.txtSoAoTSL_Cuoi
          }

          break
        case DichVuVienThong.GPHONE:
          this.bc_ma_tb_ht = this.thuebao.gphone.txtSoMayGP ? this.thuebao.gphone.txtSoMayGP.trim() : this.thuebao.gphone.txtSoMayGP
          break
        case DichVuVienThong.IMS:
          this.bc_ma_tb_ht = this.thuebao.ims.txtMaTBIMS ? this.thuebao.ims.txtMaTBIMS.trim() : this.thuebao.ims.txtMaTBIMS
          break
        //case 50 da ghep phia tren
      }
    },
    async LayMaTB(themmoi) {
      this.ma_tb_ao_ht = ''
      var _loaitb_id = this.listbox.loaihinh_tb.value
      switch (this.listbox.dichvu_vt.value * 1) {
        case DichVuVienThong.CO_DINH:
          this.ma_tb_ht = this.thuebao.codinh.somay
          break
        case DichVuVienThong.DI_DONG:
          this.ma_tb_ht = this.thuebao.didong.txtSoMayDD ? this.thuebao.didong.txtSoMayDD.trim() : this.thuebao.didong.txtSoMayDD
          break
        case DichVuVienThong.MEGA_EYES:
          this.ma_tb_ht = this.thuebao.adsl.txtSoAoAdsl ? this.thuebao.adsl.txtSoAoAdsl.trim() : ''
          if (this.TUDONG_SINH_SOAO && themmoi) {
            await API.post_sinh_malt(this.axios, {
              vdichvuvt_id: DichVuVienThong.MEGA_EYES,
              vloaitb_id: _loaitb_id,
              vquan_id: this.diachiKH.QUAN_ID,
              vtentat: this.$root.token.getMaTinh()
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.data != -1 && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.ma_tb_ao_ht = response.data.data
                this.thuebao.adsl.txtSoAoAdsl = this.ma_tb_ao_ht
              }
            })
          } else this.ma_tb_ao_ht = this.thuebao.adsl.txtSoAoAdsl ? this.thuebao.adsl.txtSoAoAdsl.trim() : ''

          if(themmoi && this.listbox.dichvu_vt.value==DichVuVienThong.ADSL) {
            // this.$toast.error("Đã loại bỏ khoảng trắng khỏi mã thuê bao / Account.");
            // this.$toast.error("Account không được phép chứa khoảng trắng")
            if((this.ma_tb_ht+'').indexOf(' ')>=0)
              throw "Mã thuê bao / Account không được chứa khoảng trắng!"
            if(!(/^[a-zA-Z0-9-_\.]+$/.test(this.ma_tb_ht+'')))
              throw "Mã thuê bao / Account không hợp lệ! Chỉ được chứa các ký tự A-Za-z0-9 và các dấu -_. "
            // this.ma_tb_ao_ht = this.ma_tb_ao_ht.replace(/\s/g, "");
            // this.thuebao.adsl.txtSoAoAdsl = this.thuebao.adsl.txtSoAoAdsl.replace(/\s/g, "");
          }
          break
        // case DichVuVienThong.DICHVU_CNTT:
        // case DichVuVienThong.ANTOAN_BAOMAT_TT:
        // case DichVuVienThong.TRUNGTAM_DULIEU:
        // case DichVuVienThong.HOINGHI_TRUYENHINH:
        //     grvMacdinh.CloseEditor();
        //     for (int index = 0; index < this.gridEditors.Count; ++index)
        //     {
        //         if (this.gridEditors[index].ID == "MA_TB")
        //         {
        //             ma_tb_ht = this.gridEditors[index].Value.ToString();
        //             break;
        //         }
        //     }
        //     break;
        case DichVuVienThong.ADSL:
        case DichVuVienThong.HATANG_VIENTHONG:
        case DichVuVienThong.BRCD_DOITAC:
          if ((_loaitb_id == LoaiHinhTB.INTERNET_MYTV || _loaitb_id == LoaiHinhTB.INTERNET_MYTV_B2B) && this.thamsomacdinh['MYTV_HOA'] == 1) {
            this.thuebao.adsl.txtAccountADSL = this.thuebao.adsl.txtAccountADSL.toUpperCase()
          }
          this.ma_tb_ht = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.trim() : this.thuebao.adsl.txtAccountADSL
          if (this.TUDONG_SINH_SOAO && themmoi) {
            await API.post_sinh_malt(this.axios, {
              vdichvuvt_id: DichVuVienThong.ADSL,
              vloaitb_id: _loaitb_id,
              vquan_id: this.diachiKH.QUAN_ID,
              vtentat: this.$root.token.getMaTinh()
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.data != -1 && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.ma_tb_ao_ht = response.data.data
                this.thuebao.adsl.txtSoAoAdsl = this.ma_tb_ao_ht
              }
            })
          } else this.ma_tb_ao_ht = this.thuebao.adsl.txtSoAoAdsl ? this.thuebao.adsl.txtSoAoAdsl.trim() : ''
          break
        case DichVuVienThong.MEGAWAN:
        case DichVuVienThong.METRONET:
        case DichVuVienThong.MGW_DOITAC:
        case DichVuVienThong.NOIBO_DADIEM:
          this.ma_tb_ht = this.thuebao.mgwan.txtMaTBWan.Text
          if (this.TUDONG_SINH_SOAO && themmoi) {
            await API.post_sinh_malt(this.axios, {
              vdichvuvt_id: this.listbox.dichvu_vt.value,
              vloaitb_id: _loaitb_id,
              vquan_id: this.diachiKH.QUAN_ID,
              vtentat: this.$root.token.getMaTinh()
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.data != -1 && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.ma_tb_ao_ht = response.data.data
                this.thuebao.mgwan.soao = response.data.data
              }
            })
          } else this.ma_tb_ao_ht = this.thuebao.mgwan.soao
          break
        case DichVuVienThong.TSL:
        case DichVuVienThong.TSL_DOITAC:
        case DichVuVienThong.NOIBO_2DIEM:
          this.ma_tb_ht = this.thuebao.tsl.txtMaTSL.Text ? this.thuebao.tsl.txtMaTSL.Text.trim() : this.thuebao.tsl.txtMaTSL.Text
          if (this.TUDONG_SINH_SOAO && themmoi) {
            await API.post_sinh_malt(this.axios, {
              vdichvuvt_id: (this.listbox.dichvu_vt.value==DichVuVienThong.NOIBO_2DIEM?DichVuVienThong.NOIBO_2DIEM:DichVuVienThong.TSL),
              vloaitb_id: _loaitb_id,
              vquan_id: this.diachiKH.QUAN_ID,
              vtentat: this.$root.token.getMaTinh()
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.data != -1 && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.ma_tb_ao_ht = response.data.data
                this.thuebao.tsl.txtSoAoTSL_Dau = this.ma_tb_ao_ht
              }
            })

            await API.post_sinh_malt(this.axios, {
              vdichvuvt_id: (this.listbox.dichvu_vt.value==DichVuVienThong.NOIBO_2DIEM?DichVuVienThong.NOIBO_2DIEM:DichVuVienThong.TSL),
              vloaitb_id: _loaitb_id,
              vquan_id: this.diachiKH.QUAN_ID,
              vtentat: this.$root.token.getMaTinh()
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.data != -1 && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.ma_tb_ao_ht_cuoi = response.data.data
                this.thuebao.tsl.txtSoAoTSL_Cuoi = this.ma_tb_ao_ht_cuoi
              }
            })
          } else {
            this.ma_tb_ao_ht = this.thuebao.tsl.txtSoAoTSL_Dau ? this.thuebao.tsl.txtSoAoTSL_Dau.trim() : this.thuebao.tsl.txtSoAoTSL_Dau
            this.ma_tb_ao_ht_cuoi = this.thuebao.tsl.txtSoAoTSL_Cuoi ? this.thuebao.tsl.txtSoAoTSL_Cuoi.trim() : this.thuebao.tsl.txtSoAoTSL_Cuoi
          }
          break
        case DichVuVienThong.GPHONE:
          this.ma_tb_ht = this.thuebao.gphone.txtSoMayGP ? this.thuebao.gphone.txtSoMayGP.trim() : this.thuebao.gphone.txtSoMayGP
          break
        case DichVuVienThong.IMS:
        case DichVuVienThong.IMS_DOITAC:
          this.ma_tb_ht = this.thuebao.ims.txtMaTBIMS ? this.thuebao.ims.txtMaTBIMS.trim() : this.thuebao.ims.txtMaTBIMS
          break
        // case 50:
        //     grvMacdinh.CloseEditor();
        //     for (int index = 0; index < this.gridEditors.Count; ++index)
        //     {
        //         if (this.gridEditors[index].ID == "MA_TB")
        //         {
        //             ma_tb_ht = this.gridEditors[index].Value.ToString();
        //             break;
        //         }
        //     }
        //     break;
      }
    },
    async SinhMaDVVT_BC() {
      //tt_nd.tentat = "mã tỉnh"
      if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
        // var lhd = new LapHopDongFacade2();
        // var checkdata = new CheckDataFacade();
        // var TienTo = checkdata.MAP_ID("tiento", DatabaseConstants.DB2 + ".quan", "where quan_id =" + quantt_id); //??? khong su dung -> bỏ qua
        var tinh_id = this.$root.token.getPhanVungID()
        var ts_sinh_ma_tb_5300 = this.thamsomacdinh['TS_SINH_MA_TB_5300'] == 1 ? 1 : 0
        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          if (tinh_id == 100 || tinh_id==97) {
            var strMatb = await bancheo.SINH_MATB(100, this.diachiTT.QUAN_ID, this.listbox.dichvu_vt.value, this.listbox.loaihinh_tb.value, (this.tt_nd.tentat_ccbs+'').toLowerCase()) //this.tinh.tinhthicong_id
            if (strMatb != '-1') {
              this.thuebao.tsl.txtMaTSL.Text = strMatb
              this.thuebao.tsl.txtMaTSL.ReadOnly = true
            }
          } else if (ts_sinh_ma_tb_5300 == 0) {
            var strMatb = await bancheo.SINH_MATB(100, this.diachiTT.QUAN_ID, this.listbox.dichvu_vt.value, this.listbox.loaihinh_tb.value, (this.tt_nd.tentat_ccbs+'').toLowerCase()) //lhd.SINH_MATB(quantt_id, this.listbox.dichvu_vt.value, Convert.ToInt32(cboLoaihinhTB.SelectedValue), tt_nd.tentat.ToLower()); this.tinh.tinhthicong_id
            if (strMatb != '-1') {
              this.thuebao.tsl.txtMaTSL.Text = strMatb
              this.thuebao.tsl.txtMaTSL.ReadOnly = true
            }
          } else {
            var strMatb = await bancheo.SINH_MATB(100, 0, this.listbox.dichvu_vt.value, this.listbox.loaihinh_tb.value, (this.tt_nd.tentat_ccbs+'').toLowerCase())
            // bancheo.GET_STRING_FUNCTION(bancheo.tinh_thicong(100), "{?DB2}.SINH_MATB"
            //                                                                       , "vquan_id", 0
            //                                                                       , "vdichvuvt_id", this.listbox.dichvu_vt.value
            //                                                                       , "vloaitb_id", Convert.ToInt32(cboLoaihinhTB.SelectedValue)
            //                                                                       , "vtentat", tt_nd.tentat.ToLower()
            //                                                                       );
            if (strMatb != '-1') {
              this.thuebao.tsl.txtMaTSL.Text = strMatb
              this.thuebao.tsl.txtMaTSL.ReadOnly = true
            }
          }
        } else this.thuebao.tsl.txtMaTSL.ReadOnly = false
        if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
          if (tinh_id == 100 || tinh_id == 97) {
            //(tt_nd.tinh_id == 100)
            var strMatb = await bancheo.SINH_MATB(100, this.diachiTT.QUAN_ID, this.listbox.dichvu_vt.value, this.listbox.loaihinh_tb.value, (this.tt_nd.tentat_ccbs+'').toLowerCase()) //lhd.SINH_MATB(quantt_id, this.listbox.dichvu_vt.value, Convert.ToInt32(cboLoaihinhTB.SelectedValue), tt_nd.tentat.ToLower());
            if (strMatb != '-1') {
              this.thuebao.mgwan.txtMaTBWan.Text = strMatb //txtMaTBWan.Text = strMatb;
              this.thuebao.mgwan.txtMaTBWan.ReadOnly = true
            }
          } else if (ts_sinh_ma_tb_5300 == 0) {
            var strMatb = await bancheo.SINH_MATB(100, this.diachiTT.QUAN_ID, this.listbox.dichvu_vt.value, this.listbox.loaihinh_tb.value, (this.tt_nd.tentat_ccbs+'').toLowerCase()) //lhd.SINH_MATB(quantt_id, this.listbox.dichvu_vt.value, Convert.ToInt32(cboLoaihinhTB.SelectedValue), tt_nd.tentat.ToLower());
            if (strMatb != '-1') {
              this.thuebao.mgwan.txtMaTBWan.Text = strMatb
              this.thuebao.mgwan.txtMaTBWan.ReadOnly = true
            }
          } else {
            var strMatb = await bancheo.SINH_MATB(100, 0, this.listbox.dichvu_vt.value, this.listbox.loaihinh_tb.value, (this.tt_nd.tentat_ccbs+'').toLowerCase())
            // bancheo.GET_STRING_FUNCTION(bancheo.tinh_thicong(100), "{?DB2}.SINH_MATB"
            //                                                                       , "vquan_id", 0
            //                                                                       , "vdichvuvt_id", this.listbox.dichvu_vt.value
            //                                                                       , "vloaitb_id", Convert.ToInt32(cboLoaihinhTB.SelectedValue)
            //                                                                       , "vtentat", tt_nd.tentat.ToLower()
            //                                                                       );
            if (strMatb != '-1') {
              this.thuebao.mgwan.txtMaTBWan.Text = strMatb
              this.thuebao.mgwan.txtMaTBWan.ReadOnly = true
            }
          }
        } else this.thuebao.mgwan.txtMaTBWan.ReadOnly = false
      } else {
        if (this.diachiTB.QUAN_ID && this.diachiTB.QUAN_ID != 0) {
          // var lhd = new LapHopDongFacade2();
          // var BC_checkdata = new CheckData();
          // var TienTo = BC_checkdata.MAP_ID(tinh, "tiento", "CSS_" + tinh.matinh + ".quan", "where quan_id =" + quantb_id);

          if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
            var strMatb = await bancheo.SINH_MATB(this.tinh.tinhthicong_id, this.diachiTB.QUAN_ID, this.listbox.dichvu_vt.value, this.listbox.loaihinh_tb.value, this.tinh.matinh.toLowerCase()) //sinhmoi.SINH_MATB(tinh, quantb_id, this.listbox.dichvu_vt.value, Convert.ToInt32(cboLoaihinhTB.SelectedValue), tinh.matinh.ToLower());
            if (strMatb != '-1') {
              this.thuebao.tsl.txtMaTSL.Text = strMatb
              this.thuebao.tsl.txtMaTSL.ReadOnly = true
            }
          } else this.thuebao.tsl.txtMaTSL.ReadOnly = false
          if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
            var strMatb = await bancheo.SINH_MATB(this.tinh.tinhthicong_id, this.diachiTB.QUAN_ID, this.listbox.dichvu_vt.value, this.listbox.loaihinh_tb.value, this.tinh.matinh.toLowerCase()) //sinhmoi.SINH_MATB(tinh, quantb_id, this.listbox.dichvu_vt.value, Convert.ToInt32(cboLoaihinhTB.SelectedValue), tinh.matinh.ToLower());
            if (strMatb != '-1') {
              this.thuebao.mgwan.txtMaTBWan.Text = strMatb
              this.thuebao.mgwan.txtMaTBWan.ReadOnly = true
            }
          } else this.thuebao.mgwan.txtMaTBWan.ReadOnly = false

          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_ANALOG || this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL)
            this.thuebao.adsl.txtAccountADSL = await bancheo.SINH_MATB(this.tinh.tinhthicong_id, this.diachiTB.QUAN_ID, this.listbox.dichvu_vt.value, this.listbox.loaihinh_tb.value, this.tinh.matinh.toLowerCase()) //sinhmoi.SINH_MATB(tinh, quantb_id, this.listbox.dichvu_vt.value, Convert.ToInt32(cboLoaihinhTB.SelectedValue), tinh.matinh.ToLower());

          if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL) {
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
              //string strMatb = lhd.SINH_MATB(quantt_id, this.listbox.dichvu_vt.value, Convert.ToInt32(cboLoaihinhTB.SelectedValue), tt_nd.tentat.ToLower());
              var strMatb = await bancheo.SINH_MATB(this.tinh.tinhthicong_id, this.diachiTB.QUAN_ID, this.listbox.dichvu_vt.value, this.listbox.loaihinh_tb.value, this.tinh.matinh.toLowerCase()) //sinhmoi.SINH_MATB(tinh, quantb_id, this.listbox.dichvu_vt.value, Convert.ToInt32(cboLoaihinhTB.SelectedValue), tinh.matinh.ToLower());
              if (strMatb != '-1') {
                this.thuebao.adsl.txtAccountADSL = strMatb
                this.thuebao.adsl.txtAccountADSL_ReadOnly = true
              } else this.thuebao.adsl.txtAccountADSL_ReadOnly = false
            }
          }

          if (this.listbox.dichvu_vt.value == DichVuVienThong.HATANG_VIENTHONG) {
            var strMatb = await bancheo.SINH_MATB(this.tinh.tinhthicong_id, this.diachiTB.QUAN_ID, this.listbox.dichvu_vt.value, this.listbox.loaihinh_tb.value, this.tinh.matinh.toLowerCase()) //sinhmoi.SINH_MATB(tinh, quantb_id, this.listbox.dichvu_vt.value, Convert.ToInt32(cboLoaihinhTB.SelectedValue), tinh.matinh.ToLower());
            if (strMatb != '-1') {
              this.thuebao.adsl.txtAccountADSL.Text = strMatb
              this.thuebao.adsl.txtAccountADSL_ReadOnly = true
            } else this.thuebao.adsl.txtAccountADSL_ReadOnly = false
          }
        }
      }
    },
    async SinhMaDVVT() {
      if (!this.diachiTT.QUAN_ID || this.diachiTT.QUAN_ID <= 0) return
      await API.post_fn_sinhma_dvvt(this.axios, {
        ds_para: JSON.stringify({ QUANTT_ID: this.diachiTT.QUAN_ID, DICHVUVT_ID: this.listbox.dichvu_vt.value, LOAITB_ID: this.listbox.loaihinh_tb.value, TS_SINH_MA_TB_5300: this.thamsomacdinh['TS_SINH_MA_TB_5300'] == 1 ? 1 : 0, TENTAT: this.$root.token.getMaTinh() })
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          var apidata = JSON.parse(response.data.data)
          if (apidata['RESULT'] && apidata['RESULT']['SINH_MA_TB']) {
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_ANALOG || this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL) this.thuebao.adsl.txtAccountADSL = apidata['RESULT']['SINH_MA_TB']

            switch (this.listbox.dichvu_vt.value * 1) {
              case DichVuVienThong.TSL:
              case DichVuVienThong.NOIBO_2DIEM:
                if (apidata['RESULT']['SINH_MA_TB'] != -1) {
                  this.thuebao.tsl.txtMaTSL.Text = apidata['RESULT']['SINH_MA_TB']
                  this.thuebao.tsl.txtMaTSL.ReadOnly = true
                }
                break
              case DichVuVienThong.MEGAWAN:
              case DichVuVienThong.METRONET:
              case DichVuVienThong.NOIBO_DADIEM:
                this.thuebao.mgwan.txtMaTBWan.Text = apidata['RESULT']['SINH_MA_TB']
                break
              case DichVuVienThong.ADSL:
                this.thuebao.adsl.txtAccountADSL_ReadOnly = false
                if (
                  this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV ||
                  this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B ||
                  this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH ||
                  this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_MESH ||
                  this.listbox.loaihinh_tb.value == LoaiHinhTB.TIVI_SAMSUNG
                ) {
                  var strMatb = apidata['RESULT']['SINH_MA_TB']
                  if (strMatb != -1) {
                    this.thuebao.adsl.txtAccountADSL = strMatb
                    this.thuebao.adsl.txtAccountADSL_ReadOnly = true
                  } else this.thuebao.adsl.txtAccountADSL_ReadOnly = false
                }
                break
              case DichVuVienThong.HATANG_VIENTHONG:
                this.thuebao.adsl.txtAccountADSL_ReadOnly = false
                var strMatb = apidata['RESULT']['SINH_MA_TB']
                if (strMatb != -1) {
                  this.thuebao.adsl.txtAccountADSL = strMatb
                  this.thuebao.adsl.txtAccountADSL_ReadOnly = true
                } else this.thuebao.adsl.txtAccountADSL_ReadOnly = false
                break
              case DichVuVienThong.MEGA_EYES:
                this.thuebao.adsl.txtAccountADSL_ReadOnly = false
                if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INDOOR_CAM || this.listbox.loaihinh_tb.value == LoaiHinhTB.OUTDOOR_CAM) {
                  var strMatb = apidata['RESULT']['SINH_MA_TB']
                  if (strMatb != -1) {
                    this.thuebao.adsl.txtAccountADSL = strMatb
                    this.thuebao.adsl.txtAccountADSL_ReadOnly = true
                  } else this.thuebao.adsl.txtAccountADSL_ReadOnly = false
                }
                break
            }
          }
        }
      })
    },
    async cboGoiCuocAdsl_SelectedValueChanged(val) {
      if (!val) return
      try {
        this.loading(true)
        // await API.post_tocdo_thuc_adsl_theo_tocdoid(this.axios,{ "id": this.listbox.cboGoiCuocAdsl.value }).then((response) => {
        //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
        //     this.listbox.cboTocDoThucADSL.list = response.data.data;
        //     if(this.listbox.cboTocDoThucADSL.list && this.listbox.cboTocDoThucADSL.list.length>0 && !this.listbox.cboTocDoThucADSL.value)
        //       this.listbox.cboTocDoThucADSL.value = this.listbox.cboTocDoThucADSL.list[0].TOCDO_ID;
        //   }
        // });

        this.listbox.cboTocDoThucADSL.value = this.listbox.cboGoiCuocAdsl.value
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      } finally {
        this.loading(false)
      }
      if (this.thamsomacdinh['MACDINH_VMP'] == 1) {
        this.cbvmp = true
        this.chkVMP_CheckedChanged() // Xu ly thay ham goc o day!
      } else this.cbvmp = false

      //HungHM-04/09/2010 Bổ xung 1 tý nghiệp vụ gói cước MyTV
      if ([LoaiHinhTB.INTERNET_MYTV, LoaiHinhTB.INTERNET_SGTV, DichVuVienThong.MEGA_EYES, LoaiHinhTB.MAIL_SMD, LoaiHinhTB.Web_Hosting, LoaiHinhTB.HTVC_FIBERVNN_ANALOG, LoaiHinhTB.HTVC_FIBERVNN_DIGITAL].indexOf(this.listbox.loaihinh_tb.value * 1) >= 0) {
        this.listbox.muccuoc.isenabled = false
        this.listbox.muccuoc.value = MUCCUOC.TRON_GOI
        //TuanNA: hiểnthị tiền trả trước của MyTV -- ngày 17.12.2011
        if (this.listbox.cboThangTra.list && this.listbox.cboThangTra.list.length > 0) {
          if (this.listbox.cboKieuTra.value == 1 && (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B)) {
            this.thuebao.adsl.tientra = 0 //txtTienTra.Text = "0"
          }
        }

        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B) {
          this.HT_DS_DBCHINH_MYTV()
          this.HT_DS_HDCHINH_MYTV()
        }
      } else {
        this.listbox.muccuoc.isenabled = true
        if (this.listbox.muccuoc.list.length > 0) this.listbox.muccuoc.value = this.listbox.muccuoc.list[0].muccuoc_id
      }
      //FIXME doan nay bo qua vi load o mounted cboLoaiIP roi, thay doi co the anh huong logic load. line 25132
      // if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH)
      // {
      //     // var dt_cuoc_adsl = cboGoiCuocAdsl.Properties.DataSource as DataTable;
      //     if (this.listbox.cboGoiCuocAdsl.list && this.listbox.cboGoiCuocAdsl.list.length > 0)
      //     {
      //         var t = this.listbox.cboGoiCuocAdsl.list.filter(x=>x.iptinh && x.iptinh>0 && x.tocdo_id==this.listbox.cboGoiCuocAdsl.value);//dt_cuoc_adsl.Select("IPTINH is not null and IPTINH>0 and tocdo_id=" + cboGoiCuocAdsl.EditValue);
      //         if (t && t.length == 0)
      //         {
      //             this.listbox.cboLoaiIP.list = [];
      //         }
      //         else
      //         {
      //           //Da co load loaiip vao cboLoaiIP o mounted
      //           // bangts.HienThi_CheckBox_Combobox(cboLoaiIP, dsDanhMuc.Tables["LOAI_IP"], "loaiip_id", "loai_ip", "chon", "1");
      //           // cboLoaiIP.Properties.PopupFormMinSize = new Size(cboLoaiIP.Width, 100);
      //         }
      //     }
      //     else
      //     {
      //         this.listbox.cboLoaiIP.list = [];
      //     }
      // }
      // else
      // {
      //     this.listbox.cboLoaiIP.list = [];
      // }

      //Lấy danh sách khuyến mại
      this.tocdo_id = this.listbox.cboGoiCuocAdsl.value ? this.listbox.cboGoiCuocAdsl.value : 0

      //HIeutc: 03.06.2019: Ko cần cảnh báo đâu, tạm bỏ
      if (!this.kt_load) {
        await this.LayTienTheoKhoanMuc()
        if (this.listbox.doituong.value != DUNG_THU.DOITUONG_TB) await this.HT_DS_KhuyenMai_Combobox()
      }
        await this.HT_GIAODIEN_DONVI()
      if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL) {
        API.post_kiemtra_ma_toc_do_doi_tuong_khachhang_ut(this.axios, { vtocdo_id: this.listbox.cboGoiCuocAdsl.value }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            if (response.data.data != 'error') this.listbox.doituong.value = response.data.data * 1
          }
        })
      }
    },
    HT_DS_DBCHINH_MYTV() {
      var pdata = {
        diachi_ld: this.diachiLD.DIACHI,
        hdkh_id: this.khachhang.hdkh_id ? this.khachhang.hdkh_id : 0,
        khachhang_id: this.khachhang.khachhang_id ? this.khachhang.khachhang_id : 0,
        kieu: 2,
        ma_tb: this.thuebao.adsl.txtAccountADSL,
        tocdo_id: this.listbox.cboGoiCuocAdsl.value,
        upper: this.thamsomacdinh['MYTV_HOA'] == 1 ? 1 : 0
      }
      API.post_lay_ds_thuebao_chinh(this.axios, pdata).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.cboDbChinh.list = response.data.data
          if (this.listbox.cboDbChinh.list && this.listbox.cboDbChinh.list.length > 0) this.listbox.cboDbChinh.value = this.listbox.cboDbChinh.list[0].thuebao_id // text lay ma_tb
        }
      })
    },
    HT_DS_HDCHINH_MYTV() {
      var pdata = {
        diachi_ld: this.diachiLD.DIACHI,
        hdkh_id: this.khachhang.hdkh_id ? this.khachhang.hdkh_id : 0,
        khachhang_id: this.khachhang.khachhang_id ? this.khachhang.khachhang_id : 0,
        kieu: 1,
        ma_tb: this.thuebao.adsl.txtAccountADSL,
        tocdo_id: this.listbox.cboGoiCuocAdsl.value,
        upper: this.thamsomacdinh['MYTV_HOA'] == 1 ? 1 : 0
      }
      API.post_lay_ds_thuebao_chinh(this.axios, pdata).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.cboHDChinh.list = response.data.data
          if (this.listbox.cboHDChinh.list && this.listbox.cboHDChinh.list.length > 0) this.listbox.cboHDChinh.value = this.listbox.cboHDChinh.list[0].hdtb_id // text lay ma_tb
        }
      })
    },
    btnChonSoAoAdsl_Click() {
      if (!this.diachiLD.QUAN_ID || this.diachiLD.QUAN_ID == 0 || !this.diachiLD.PHUONG_ID || this.diachiLD.PHUONG_ID == 0) {
        this.$toast.error('Bạn chưa chọn địa chỉ lắp đặt !')
        return
      }

      //this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonSM')
      this.popupComponent = () => import('./Popups/popupChonSM')
      this.popupComponentName = 'frmChonSMPhuongADSL'
      this.popupComponentData = {
        _tinh_id: this.diachiLD.TINH_ID,
        _quan_id: this.diachiLD.QUAN_ID,
        _phuong_id: this.diachiLD.PHUONG_ID,
        _loaiso_id: LOAISO.AO,
        _thueso: false,
        loaitb_id: this.listbox.loaihinh_tb.value,
        dichvuvt_id: this.listbox.dichvu_vt.value,
        hdkh_id: this.khachhang.hdkh_id,
        donvi_ql_id: 0 //this.listbox.donvi_ql.value //ql (lay field don vi lap dat.)
      }
      this.Popup('popupComponents')
    },
    async btnKiemTraAccount_Click() {
      try {
        if (!this.thuebao.adsl.txtAccountADSL || this.thuebao.adsl.txtAccountADSL == '') throw 'Chưa nhập account ADSL!'
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) {
          var loaihinh_tb = this.listbox.loaihinh_tb.value

          if (loaihinh_tb == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC || loaihinh_tb == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC) {
            //TODO cho` link form nay frmTraCuuVDC UR2.8.023!
            // frmTraCuuVDC fvdc = new frmTraCuuVDC(1, txtAccountADSL.Text.trim());
            // fvdc.ShowDialog();
          } else {
            await API.post_kiemtra_matb(this.axios, { dichVuVtId: this.listbox.dichvu_vt.value, hdtbId: this.hdtb_id, maTb: this.thuebao.adsl.txtAccountADSL }).then((response) => {
              if (response && response.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                if (response.data.data != 0) {
                  throw 'Account ' + this.thuebao.adsl.txtAccountADSL + ' đã được cấp. Bạn hãy kiểm tra lại'
                } else this.thuebao.adsl.validadslacc = true //FIXME doan nay them vao vi khi test camera no chay qua va khong thay doi gia tri nay dan den chet chuong trinh
              }
            })
            if (loaihinh_tb == LoaiHinhTB.INTERNET_1260 || loaihinh_tb == LoaiHinhTB.INTERNET_ADSL || loaihinh_tb == LoaiHinhTB.INTERNET_FTTH || loaihinh_tb == LoaiHinhTB.WIFI_FIBER) {
              await API.post_lookupRASAccount(this.axios, { accountName: this.thuebao.adsl.txtAccountADSL }).then((response) => {
                if (response != null && response.data != null && response.data.data != null && ((response.data.error_code != null && response.data.error_code === 'BSS-00000000') || (response.data.errorCode != null && response.data.errorCode == 0))) {
                  // var parser = new DOMParser();
                  // var xmlDoc = parser.parseFromString(response.data.data,"text/xml");
                  var ele = response.data.faultString //xmlDoc.getElementsByTagName("faultstring");
                  if (ele) {
                    if (ele.indexOf('không có quyền tác động tài khoản này') >= 0) throw 'Account ' + this.thuebao.adsl.txtAccountADSL + ' đã được sử dụng tại hệ thống của tỉnh khác. Bạn hãy vui lòng chọn Account khác!'
                    else if (ele.indexOf('Tài khoản yêu cầu') >= 0) throw 'Bạn hãy vui lòng chọn Account khác!'
                  } else throw 'Account ' + this.thuebao.adsl.txtAccountADSL + ' đã tồn tại trên Visa. Bạn hãy vui lòng chọn Account khác! '
                }
                this.$toast.success('Tài khoản ' + this.thuebao.adsl.txtAccountADSL + ' chưa được sử dụng. Bạn có thể thực hiện đặt chỗ cho Account này!')
                this.thuebao.adsl.validadslacc = true
              })
            } else if (loaihinh_tb == LoaiHinhTB.INTERNET_MYTV || loaihinh_tb == LoaiHinhTB.INTERNET_MYTV_B2B) {
              if (this.thamsomacdinh['MYTV_HOA'] == 1) this.thuebao.adsl.txtAccountADSL = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.toUpperCase().trim() : this.thuebao.adsl.txtAccountADSL
              else this.thuebao.adsl.txtAccountADSL = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.toLowerCase().trim() : this.thuebao.adsl.txtAccountADSL
              await API.post_getSubscriberInfo(this.axios, { iptvaccount: this.thuebao.adsl.txtAccountADSL, tinhthicong_id:this.tinh.tinhthicong_id }).then((response) => {
                if (response != null && response.data != null && response.data.data != null && ((response.data.error_code != null && response.data.error_code === 'BSS-00000000') || (response.data.errorCode != null && response.data.errorCode == 0))) {
                  if (!response.data.data.idno) {
                  } else throw 'Account ' + this.thuebao.adsl.txtAccountADSL + ' đã được cấp. Bạn hãy kiểm tra lại'
                }
                else if(response && response.data && response.data.faultString && response.data.faultString.indexOf('không tồn tại trong hệ thống') < 0) {
                  throw "Lỗi xác thực tài khoản: " + response.data.faultString;
                }
                this.$toast.success('Tài khoản ' + this.thuebao.adsl.txtAccountADSL + ' chưa được sử dụng. Bạn có thể thực hiện đặt chỗ cho Account này!')
                this.thuebao.adsl.validadslacc = true
              })
            }
          }
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
        this.thuebao.adsl.validadslacc = false
      }
    },
    txtAccountADSL_TextChanged(v) {
      this.thuebao.adsl.txtAccountADSL = v.target.value
      if (!this.thuebao.adsl.txtAccountADSL) return
      this.thuebao.adsl.txtEmailAdsl = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.toLowerCase().trim() + '@vnn.vn' : ''
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_ANALOG || this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL) {
        this.thuebao.adsl.txtEmailAdsl = ''
      }
      //nhapt thêm 26062017
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGACAMERA) {
        if (this.thuebao.adsl.txtAccountADSL && this.thuebao.adsl.txtAccountADSL.length > 0 && !this.thuebao.adsl.txtAccountADSL.match(/^[a-zA-Z0-9_-]+$/g)) {
          this.$toast.error('Thuê bao VNPT Camera chỉ chấp nhận các kí tự a -> z; A -->Z , 0 ->9 ; - hoặc _. Hãy thử lại!')
          return
        }
      }
    },
    async TaoDuLieu_HDTB_ADSL(themmoi) {
      this.dsHDTB_ADSL = []
      var rowHDTB_ADSL = {}
      var apidata = {}
      var pdata = { THEMMOI: 1, GOICUOCADSL_ID: this.listbox.cboGoiCuocAdsl.value, KIEULD_ID: this.listbox.kieu_ld.value, MADOICAP_ADSL: this.thuebao.adsl.txtMaDoiCap_ADSL, MATKHAU_MD_ADSL: 'random_sql', TT_CUOC: this.thuebao.adsl.txtTTCuoc } // fix random_sql theo code cu
      await API.post_fn_lay_tt_taodl_hdtb_adsl(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            this.$toast.error(apidata['MESSAGE'])
            return
          }
          if (apidata['RESULT']) apidata = apidata['RESULT']
        }
      })

      rowHDTB_ADSL.HDTB_ID = this.hdtb_id
      rowHDTB_ADSL.EMAIL = this.thuebao.adsl.txtEmailAdsl
      if (this.thuebao.adsl.ckTuCaiADSL) rowHDTB_ADSL.KH_CD = 1
      else rowHDTB_ADSL.KH_CD = 0
      rowHDTB_ADSL.TOCDO_ID = this.listbox.cboGoiCuocAdsl.value //vgoicuocasdl; // doi voi ADSL, vgoicuocasdl = this.listbox.cboGoiCuocAdsl.value

      if (this.thuebao.adsl.chkTocDoThuc) rowHDTB_ADSL.TOCDOTHUC_ID = this.listbox.cboTocDoThucADSL.value
      else rowHDTB_ADSL.TOCDOTHUC_ID = rowHDTB_ADSL.TOCDO_ID

      if (this.KetCuoi_ID > 0) rowHDTB_ADSL.KETCUOI_ID = this.KetCuoi_ID

      rowHDTB_ADSL.MUCCUOC_ID = this.listbox.muccuoc.value
      rowHDTB_ADSL.THOIHAN_ID = this.listbox.thoihan.valueadsl

      if (this.listbox.cboLoaiTB.value && this.listbox.cboLoaiTB.value != 0) rowHDTB_ADSL.THIETBIDC_ID = this.listbox.cboLoaiTB.value
      rowHDTB_ADSL.MA_LT = this.ma_tb_ao_ht
      //HungHM - 31/08/2010 bổ xung thêm ngày đặt chỗ cho Accont ADSL, FTTH
      var loaitb_id = this.listbox.loaihinh_tb.value
      if (loaitb_id == LoaiHinhTB.INTERNET_1260 || loaitb_id == LoaiHinhTB.INTERNET_ADSL || loaitb_id == LoaiHinhTB.INTERNET_FTTH || loaitb_id == LoaiHinhTB.WIFI_FIBER) rowHDTB_ADSL.HANDATCHO = this.thuebao.adsl.dtpHanDatCho
      if (loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_ANALOG || loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL || loaitb_id == LoaiHinhTB.MEGACAMERA) rowHDTB_ADSL.SLTV_HTVC = this.thuebao.adsl.txtSL_Tivi

      if (loaitb_id == LoaiHinhTB.FSECURE) rowHDTB_ADSL.SO_DT = this.thuebao.adsl.txtDienThoai_Fsecure

      if (loaitb_id == LoaiHinhTB.COSO_HATANG) {
        rowHDTB_ADSL.DOITAC_ID = this.listbox.cboDoiTac_CSHT.value
        rowHDTB_ADSL.LOAI_CSHT_ID = this.listbox.cboLoai_CSHT.value
      }

      var profiledsl_id = -1
      if (apidata['PROFILEDSL_ID']) profiledsl_id = apidata['PROFILEDSL_ID']
      if (profiledsl_id != -1) rowHDTB_ADSL.PROFILEDSL_ID = profiledsl_id
      else rowHDTB_ADSL.PROFILEDSL_ID = null

      if (this.listbox.congnghe.value > 0) rowHDTB_ADSL.CONGNGHE_ID = this.listbox.congnghe.value
      else rowHDTB_ADSL.CONGNGHE_ID = null

      if (this.listbox.doitac.ischeckedadsl) {
        rowHDTB_ADSL.DOITAC_ID = this.listbox.doitac.valueinternet
        if (this.thuebao.adsl.txtCuocDT_Internet) rowHDTB_ADSL.CUOC_DOITAC = this.thuebao.adsl.txtCuocDT_Internet
        else rowHDTB_ADSL.CUOC_DOITAC = 0
      } else {
        rowHDTB_ADSL.DOITAC_ID = null
        rowHDTB_ADSL.CUOC_DOITAC = null
      }

      rowHDTB_ADSL.VMP = this.cbvmp ? 1 : 0
      //HungHM - Bổ xung thêm mã truy nhập + mã đôi cáp
      rowHDTB_ADSL.MATB_TN = this.thuebao.adsl.txtMaTN_ADSL
      //Lamnt: Bổ sung trường serial_stb
      rowHDTB_ADSL.SERIAL_STB = this.thuebao.adsl.txtSerialSTB

      if (apidata['MADOICAP']) {
        rowHDTB_ADSL.MADOICAP = apidata['MADOICAP']
        this.thuebao.adsl.txtMaDoiCap_ADSL = apidata['MADOICAP']
      }

      rowHDTB_ADSL.TRANGBI_ID = this.listbox.trangbi.valueadsl
      rowHDTB_ADSL.CHUQUAN_ID = this.listbox.chu_quan.valueadsl
      rowHDTB_ADSL.CHUQUANLD_ID = this.listbox.chu_quan.valueldadsl
      rowHDTB_ADSL.KIEUTRA_ID = this.listbox.cboKieuTra.value
      if (rowHDTB_ADSL.KIEUTRA_ID == 1) {
        rowHDTB_ADSL.THANG_ID = this.listbox.cboThangTra.value
        rowHDTB_ADSL.NGAYTRA = this.thuebao.adsl.dtpNgayTra
      }

      //if (apidata['MATKHAU_MD_ADSL']) rowHDTB_ADSL.PASSWORD = apidata['MATKHAU_MD_ADSL']

      if (apidata['PASS_ADSL']) rowHDTB_ADSL.PASSWORD = apidata['PASS_ADSL']
      else if (apidata['MATKHAU_MD_ADSL']) rowHDTB_ADSL.PASSWORD = apidata['MATKHAU_MD_ADSL']
      if(!rowHDTB_ADSL.PASSWORD && this.thuebao.adsl.pass_adsl) rowHDTB_ADSL.PASSWORD = this.thuebao.adsl.pass_adsl;

      if (this.listbox.doitac.ischeckedadsl) {
        rowHDTB_ADSL.USERNAME = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.trim() : ''
        if (this.listbox.doitac.valueinternet) {
          rowHDTB_ADSL.USERNAME = (this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.trim() : '') + this.listbox.doitac.list.filter((x) => x.doitac_id == this.listbox.doitac.valueinternet)[0]['username_sub'].trim() //dsDanhMuc.Tables["DOITAC"].Select("doitac_id = " + Convert.ToInt32(cboDoiTac_Internet.EditValue)).CopyToDataTable().Rows[0]["username_sub"].ToString().trim();
        }
      } else rowHDTB_ADSL.USERNAME = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.trim() : ''

      if (!this.thuebao.adsl.txtTTCuoc) {
        if (apidata['SL_IP_MP']) this.thuebao.adsl.txtTTCuoc = apidata['SL_IP_MP']
      }
      rowHDTB_ADSL.THONGTIN_TC = this.thuebao.adsl.txtTTCuoc

      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC) {
        rowHDTB_ADSL.CUOC_SD = this.thuebao.adsl.txtCSD_FIBER_TK
        rowHDTB_ADSL.CUOC_TBI = this.thuebao.adsl.txtCTB_FIBER_TK
      }
      if (!themmoi) rowHDTB_ADSL.MA_VNPT = this.ma_vnpt
      this.dsHDTB_ADSL.push(rowHDTB_ADSL)
      // if (themmoi == false)
      // {
      //     dsHDTB_ADSL.AcceptChanges();
      //     dsHDTB_ADSL.HDTB_ADSL.Rows[0].SetModified();
      // }

      //Tạo cho bảng hdtb_dv
      for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

        if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
          throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
          return;
        }
        var row = {}
        row.HDTB_ID = this.hdtb_id
        row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
        row.DONVI_ID = this.DT_CONTROLS.value[i]
        row.KIEUDV_ID = 2
        this.dsHDTBDV.push(row)
      }
      //End
    },
    TaoDuLieu_HDTB_LOAIIP() {
      try {
        this.dsHDTB_LoaiIp = []
        if (this.listbox.cboLoaiIP.values && this.listbox.cboLoaiIP.values.length > 0)
          for (var loaiip of this.listbox.cboLoaiIP.values) {
            var rowHDTB_LIP = {}
            rowHDTB_LIP.HDTB_ID = this.hdtb_id
            rowHDTB_LIP.LOAIIP_ID = loaiip //Convert.ToInt32(cboLoaiIP.Properties.Items[i].Value.ToString());
            this.dsHDTB_LoaiIp.push(rowHDTB_LIP)
          }
        else {
          var rowHDTB_LIP = {}
          rowHDTB_LIP.HDTB_ID = this.hdtb_id
          rowHDTB_LIP.LOAIIP_ID = this.listbox.cboLoaiIP.value //Convert.ToInt32(cboLoaiIP.Properties.Items[i].Value.ToString());
          this.dsHDTB_LoaiIp.push(rowHDTB_LIP)
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async DatMoi_Fsecure_kem_fiber() {
      try {
        this.kieuld_fsecure_kem_fiber = 0
        await API.post_lay_tt_fs_kem_ftth_v2(this.axios, { vloaihd_id: LoaiHopDong.DAT_MOI }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            this.kieuld_fsecure_kem_fiber = response.data.data[0]['ten_ts']
          }
        })

        if (
          this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH && //lắp mới fiber
          this.kieuld_fsecure_kem_fiber != 0 // thỏa mãn điều kiện kèm fsecure
        ) {
          this.$bvModal
            .msgBoxConfirm('Đang trong thời gian khuyến mại: Lắp mới Fiber sẽ được tặng 01 gói Fsecure miễn phí. Bạn có đồng ý nhận khuyến mại?', {
              title: 'Xác nhận hành động',
              size: 'sm',
              okTitle: 'Đồng ý',
              cancelTitle: 'Không đồng ý'
            })
            .then(async (v) => {
              if (v) {
                //Message_Box.ShowTB("Đang trong thời gian khuyến mại: Lắp mới Fiber sẽ được tặng 01 gói Fsecure miễn phí!");
                this.popupComponent = () => import('../InstallNewSubs/Popups/popupTT_Fsecure_kem_ftth')
                this.popupComponentName = 'popupTT_Fsecure_kem_ftth'
                this.popupComponentData = { so_dt: this.khachhang.dienthoai }
                this.Popup('popupComponents')
              }
            })
        }
      } catch (Exception) {}
    },
    async Them_MyTV_vao_goi_giadinh() {
      try {
        var pdata = { KIEULD_ID: this.listbox.kieu_ld.value, MATN_ADSL: this.thuebao.adsl.txtMaTN_ADSL, MUCCUOC_ID: this.listbox.muccuoc.value, GOICUOCADSL: this.listbox.cboGoiCuocAdsl.value, HDTB_ID: this.hdtb_id }
        await API.post_fn_lay_tt_mytv_vao_goigd(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            var apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] == -99) return
            else if (apidata['ERROR_CODE'] != 1) {
              this.$toast.error(apidata['MESSAGE'])
              return
            }
            if (apidata['RESULT']) apidata = apidata['RESULT']

            // js_hdtb_goi_dadv.put('GOI_ID',l_goi_id);
            // js_hdtb_goi_dadv.put('NHOMTB_ID',l_nhomtb_id);
            // js_hdtb_goi_dadv.put('CHUNHOM',0);
            // js_hdtb_goi_dadv.put('HDTB_ID',l_hdtb_id);
            // js_hdtb_goi_dadv.put('THANG_HUONG',0);
            // l_result_js.put('HDTB_GOI_DADV',js_hdtb_goi_dadv);
            if (apidata['HDTB_GOI_DADV'] && apidata['HDTB_GOI_DADV'].length > 0) {
              var ds = apidata['HDTB_GOI_DADV']
              var goi_id = ds[0]['GOI_ID']
              var nhomtb_id = ds[0]['NHOMTB_ID']
              this.$bvModal
                .msgBoxConfirm(`Thuê bao Fiber: ${this.thuebao.adsl.txtMaTN_ADSL} đang tham gia gói gia đình. Bạn có đồng ý thêm thuê bao MyTV này vào cùng gói gia đình với Fiber không?`, {
                  title: 'Xác nhận hành động',
                  size: 'sm',
                  okTitle: 'Đồng ý',
                  cancelTitle: 'Không đồng ý'
                })
                .then(async (v) => {
                  if (v) {
                    TaoDuLieu_HDTB_GOI_DADV(goi_id, nhomtb_id)
                    await API.post_sp_insert_hdtb_goi_dadv(this.axios, { js_hdtb_goi_dadv: JSON.stringify(this.dsHDTBGOI) }).then(async (response) => {
                      if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                      } else this.$toast.error(`${response.data.message}: ${response.data.message_detail}`)
                    })
                  }
                })
            }
          }
        })
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    TaoDuLieu_HDTB_GOI_DADV(goi_id, nhomtb_id) {
      this.dsHDTBGOI = []
      var rowGOI = {}
      rowGOI.GOI_ID = goi_id
      rowGOI.NHOMTB_ID = nhomtb_id
      rowGOI.CHUNHOM = 0
      rowGOI.HDTB_ID = this.hdtb_id
      rowGOI.THANG_HUONG = 0
      this.dsHDTBGOI.push(rowGOI)
    },
    async TaoDuLieu_HDTB_Fsecure_kem(themmoi) {
      // #region HD_THUEBAO_DATA
      this.dsHDTB = []
      // await API.post_get_keys(this.axios, {"keyname":"HD_THUEBAO"}).then((response) => {
      //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //     rowHDTB.HDTB_ID = response.data.data; // 4039
      //     this.hdtb_id = rowHDTB.HDTB_ID;
      //   }
      // });
      // this.hdtb_id = new GetKeyFacade().GetKey("HD_THUEBAO");

      var rowHDTB = {}

      // rowHDTB.HDTB_ID = this.hdtb_id; // Da gen key o tren
      rowHDTB.HDTT_ID = this.hdtt_id
      rowHDTB.HDKH_ID = this.khachhang.hdkh_id

      rowHDTB.MA_TB = 'fse_0' + this.thuebao.adsl.txtDienThoai_Fsecure

      rowHDTB.TEN_TB = this.thuebao.tentb
      rowHDTB.DIACHI_TB = this.diachiTB.DIACHI
      rowHDTB.GHICHU = this.thuebao.ghichu
      rowHDTB.KIEULD_ID = this.kieuld_fsecure_kem_fiber
      rowHDTB.LOAITB_ID = LoaiHinhTB.FSECURE
      rowHDTB.DOITUONG_ID = this.listbox.doituong.value
      rowHDTB.DONVI_ID = this.listbox.donvi_ql.value
      rowHDTB.TTHD_ID = TrangThaiHD.MOI
      rowHDTB.DICHVUVT_ID = DichVuVienThong.ANTOAN_BAOMAT_TT

      rowHDTB.KIEU_TB = '0' //Kiểu thuê bao thường.
      rowHDTB.NGUOI_CN = this.$root.token.getNguoiDungID()
      rowHDTB.NGAY_CN = new Date().toLocaleDateString('en-GB')
      rowHDTB.MAY_CN = this.tt_nd.may_cn
      rowHDTB.IP_CN = 'xxx'
      //LONGDX: bổ sung thông tin thuê bao mạng khác chuyển sang
      rowHDTB.CHUYENMANG = this.listbox.nhacc_cu.ischecked ? 1 : 0
      if (this.listbox.nhacc_cu.ischecked) {
        if (this.listbox.nhacc_cu.value && this.listbox.nhacc_cu.value > 0) {
          rowHDTB.NHACC_CU_ID = this.listbox.nhacc_cu.value
        }
        if (this.listbox.hinhthuc_cm.value && this.listbox.hinhthuc_cm.value > 0) {
          rowHDTB.HTCM_ID = this.listbox.hinhthuc_cm.value
        }
      }
      rowHDTB.TBHD_PL = this.thuebao.tbhd_pl // Tuan them truong TBHD_PL cho thue bao --> 1 <-> In HD; 0 <-> In PL --- Ngay 24/08/2010
      //HungHM-27/06/2010: bổ xung thêm các column cho bảng HD_ThueBao
      rowHDTB.DIACHI_LD = this.diachiLD.DIACHI
      if (this.NgaySinhTB) {
        rowHDTB.NGAY_SN = this.NgaySinhTB
      }

      var STATUS_TONGDAI_CD = true
      rowHDTB.STATUS = '0'

      await API.post_fn_lay_tt_taodl_hdtb(this.axios, {
        kieu: 2,
        ds_para: JSON.stringify({ THEMMOI: themmoi, MA_TB_HT: this.ma_tb_ht, MUCUOCTB_ID: this.listbox.muccuoc_tb.value, LUONG_ID: this.luong_id, CODE: 'STATUS_TONGDAI_CD', DS_CHITIETKM_ID: null, KIEULD_ID: this.listbox.kieu_ld.value })
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          var dulieuapi = JSON.parse(response.data.data)
          if (dulieuapi && dulieuapi['ERROR_CODE'] == 1) {
            if (dulieuapi['RESULT']) dulieuapi = dulieuapi['RESULT']
            if (dulieuapi['HDTB_ID']) {
              rowHDTB.HDTB_ID = dulieuapi['HDTB_ID']
              this.hdtb_id = dulieuapi['HDTB_ID']
            }
            // if(dulieuapi['MUCUOC_TB']) rowHDTB.MUCUOC_TB = dulieuapi['MUCUOC_TB'];
            if (dulieuapi['DS_CTKM_LTBI']) {
              rowHDTB.DS_CTKM_LTBI = dulieuapi['DS_CTKM_LTBI']
              this.DS_CTKM_LTBI = rowHDTB.DS_CTKM_LTBI
            } else this.DS_CTKM_LTBI = []
            if (dulieuapi['STATUS']) STATUS_TONGDAI_CD = true
          }
        }
      })

      if (STATUS_TONGDAI_CD) rowHDTB.STATUS = '0'

      //HungHM - 06/09/2010 thêm dvql đầu + cuối
      rowHDTB.DONVI_DAU_ID = this.listbox.donvi_dau.value
      rowHDTB.DONVI_CUOI_ID = this.listbox.donvi_cuoi.value

      if (this.kt_thuenganhan == true) {
        rowHDTB.TG_THUE_TU = this.TGThueTuNgay
        rowHDTB.TG_THUE_DEN = this.TGThueDenNgay
      }

      rowHDTB.QUYTRINH_ID = this.quytrinh_tn
      if (this.listbox.goi_kt.value > 0) {
        rowHDTB.GOIKT_ID = this.listbox.goi_kt.value
      }

      rowHDTB.SOTHANG_CK = 0

      this.dsHDTB.push(rowHDTB)
    },
    async TaoDuLieu_CT_TIENHD_fsecure_kem(themmoi) {
      this.dsCTTHD = []
      var rowCTTHD

      for (var i = 0; i < this.ds_tien_khoanmuc.length; i++) {
        if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_MUATHIETBI || this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI || this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_TRATRUOC_THIETBI) {
          for (var j = 0; j < dsCTM_TBI.length; j++) {
            rowCTTHD = {}
            rowCTTHD.HDTB_ID = this.hdtb_id
            if (themmoi) {
              await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  rowCTTHD.CT_TIENHD_ID = response.data.data
                }
              })
            }
            rowCTTHD.KHOANMUCTT_ID = this.ds_tien_khoanmuc[i]['khoanmuctt_id']
            var tien
            var vat
            var soluong = 1
            soluong = this.dsCTM_TBI[j]['soluong']
            tien = 0 //Convert.ToDecimal(CommonFunction.Unformat_tien(dsCTM_TBI.Tables[0].Rows[j]["tien"].ToString())) * soluong;
            vat = 0 //Convert.ToDecimal(CommonFunction.Unformat_tien(dsCTM_TBI.Tables[0].Rows[j]["vat"].ToString())) * soluong;
            rowCTTHD.TIEN = 0 //tien;
            rowCTTHD.VAT = 0 //vat;
            rowCTTHD.ID = this.dsCTM_TBI[j]['loaitbi_id']
            rowCTTHD.LOAI_ID = 3
            this.dsCTTHD.push(rowCTTHD)
          }
        } else if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DICHVU) {
          for (var j = 0; j < this.m_dsThueBao_DichVu.length; j++) {
            if (this.m_dsThueBao_DichVu[j]['dangky'] == 1 && this.m_dsThueBao_DichVu[j]['huy'] == 0) {
              rowCTTHD = {}
              rowCTTHD.HDTB_ID = this.hdtb_id
              if (themmoi) {
                await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    rowCTTHD.CT_TIENHD_ID = response.data.data
                  }
                })
              }
              rowCTTHD.KHOANMUCTT_ID = KHOANMUC_TT.KMTT_DICHVU
              var tien = 0 //Tiền dịch vụ chưa khuyến mại
              var vat = 0 //Vat dịch vụ chưa khuyến mại
              tien = 0 //Convert.ToDecimal(CommonFunction.Unformat_tien(this.m_dsThueBao_DichVu[j]["cuoc_ld"].ToString()));
              rowCTTHD.TIEN = 0 //tien;
              vat = 0 //Convert.ToDecimal(CommonFunction.Unformat_tien(this.m_dsThueBao_DichVu[j]["vat_ld"].ToString()));
              rowCTTHD.VAT = 0 //vat;
              rowCTTHD.ID = this.m_dsThueBao_DichVu[j]['dichvugt_id']
              rowCTTHD.LOAI_ID = 2
              this.dsCTTHD.push(rowCTTHD)
            }
          }
        } else {
          rowCTTHD = {}
          rowCTTHD.HDTB_ID = this.hdtb_id
          if (themmoi) {
            await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                rowCTTHD.CT_TIENHD_ID = response.data.data
              }
            })
          }
          rowCTTHD.KHOANMUCTT_ID = this.ds_tien_khoanmuc[i]['khoanmuctt_id']

          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT || this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI || this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DATCOC) {
            if (this.ds_tien_khoanmuc[i]['tien'] > 0) {
              rowCTTHD.TIEN = 0 //Convert.ToDecimal(this.ds_tien_khoanmuc[i]["tien"].ToString()) * -1;
              rowCTTHD.VAT = 0 //Convert.ToDecimal(this.ds_tien_khoanmuc[i]["vat"].ToString()) * -1;
            } else {
              rowCTTHD.TIEN = 0 //Convert.ToDecimal(this.ds_tien_khoanmuc[i]["tien"].ToString());
              rowCTTHD.VAT = 0 //Convert.ToDecimal(this.ds_tien_khoanmuc[i]["vat"].ToString());
            }
          } else {
            rowCTTHD.TIEN = 0 //Convert.ToDecimal(this.ds_tien_khoanmuc[i]["tien"].ToString());
            rowCTTHD.VAT = 0 //Convert.ToDecimal(this.ds_tien_khoanmuc[i]["vat"].ToString());
          }
          rowCTTHD.ID = this.ds_tien_khoanmuc[i]['khoanmuctt_id']
          rowCTTHD.LOAI_ID = 1
          this.dsCTTHD.push(rowCTTHD)
        }
      }
    },
    TaoDuLieu_TIEN_DATCOC_Fsecure_kem(themmoi) {
      this.dsTien_DatCoc = []
      var row = {}

      row.HDTB_ID = this.hdtb_id
      row.THUEBAO_ID = 0
      row.LOAITIEN_ID = 1
      row.GIATRI = 0 // dtiendatcoc_tt + dvatdatcoc_tt + dtiendatcoc_km + dvatdatcoc_km;

      dsTien_DatCoc.push(row)
      // if (themmoi == false)
      // {
      //     dsTien_DatCoc.AcceptChanges();
      //     dsTien_DatCoc.TIEN_HDTB_TC.Rows[0].SetModified();
      // }
    },
    TaoDuLieu_HDTB_CNTT_Fsecure_kem(_matb_tn, _madoicap) {
      this.Init_Properties(LoaiHinhTB.FSECURE, 'HDTB_CNTT', '00000', this.ItemList)

      for (var index1 = 0; index1 < this.ItemList.length; ++index1) {
        if (this.ItemList[index1].sFieldName == 'MA_TB') this.ItemList[index1].sValue = 'fse_0' + this.thuebao.adsl.txtDienThoai_Fsecure //sodt_fsecure_kem;

        if (this.ItemList[index1].sFieldName == 'TOCDO_ID') this.ItemList[index1].sValue = FSECURE_KM_12_MONTHS.FreeFSD12M_2018.ToString() // TOCDO_ID_CFreeFSD12M;// TOCDO_ID_V2;
        if (this.ItemList[index1].sFieldName == 'MUCCUOC_ID') this.ItemList[index1].sValue = '1' //trọn gói
        if (this.ItemList[index1].sFieldName == 'SO_DT') this.ItemList[index1].sValue = this.thuebao.adsl.txtDienThoai_Fsecure //sodt_fsecure_kem;
        if (this.ItemList[index1].sFieldName == 'MATB_TN') this.ItemList[index1].sValue = _matb_tn //txtAccountADSL.Text.trim();//matb_tn của fse là mã tb fiber
        if (this.ItemList[index1].sFieldName == 'MADOICAP') this.ItemList[index1].sValue = _madoicap //txtMaDoiCap_ADSL.Text.trim()
        if (this.ItemList[index1].sFieldName == 'CHUQUAN_ID') this.ItemList[index1].sValue = this.listbox.chu_quan.valueadsl
      }
      var pdata = { QUYTRINH_ID: this.quytrinh_tn, HDTB_ID: this.hdtb_id, DS_HDTB_DV: this.dsHDTBDV }
      API.post_fn_lay_tt_taodl_hdtb_cntt_fs_kem(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          var apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            this.$toast.error(apidata['MESSAGE'])
            return
          }
          var dt_tmp = apidata['RESULT']['DS_HDTB_DV']
          var inloaidv_id = 0
          var indonvi_id = 0
          for (var i = 0; i < dt_tmp.length; i++) {
            inloaidv_id = dt_tmp[i]['LOAIDV_ID'] //["loaidv_dich_id"]; //trong stored da doi ten: drow.put('LOAIDV_ID',i.loaidv_dich_id);
            indonvi_id = dt_tmp[i]['DONVI_ID'] // Da xu ly trong stored!
            if (inloaidv_id != LOAI_DV.GIAODICH) {
              var dr = this.dsHDTBDV.filter((x) => x.LOAIDV_ID == inloaidv_id)

              if (dr.length > 0)
                //tìm đc trong số các đơn vị của fiber
                indonvi_id = dr[0]['DONVI_ID']
              // Doan else nay da xu ly o dng truoc lenh if, lay tu stored ra san
              // else
              // {
              // Không tìm được --> lấy đvị mặc định
              // string str_donvi = "";
              // str_donvi += "select a.donvi_id from ";
              // str_donvi += DatabaseConstants.DB1 + ".donvi a, ";
              // str_donvi += DatabaseConstants.DB1 + ".donvi_ldv b ";
              // str_donvi += " where a.donvi_id = b.donvi_id ";
              // str_donvi += "  and b.loaidv_id = " + inloaidv_id;

              // DataTable dt_donvi = bangts.GetDataSql(str_donvi);

              // indonvi_id = Convert.ToInt32(dt_donvi.Rows[0]["donvi_id"].ToString());
              // }

              var row = {}
              row.HDTB_ID = this.hdtb_id
              row.LOAIDV_ID = inloaidv_id
              row.DONVI_ID = indonvi_id
              row.KIEUDV_ID = 2
              this.dsHDTBDV_Fsecure.push(row)
            }
          }
        }
      })
    },
    async Init_Properties(vloaitb_id, table_name, opt_list, ItemList) {
      await API.post_lay_danhsach_thuoctinh_datmoi(this.axios, {
        vloaitb_id: vloaitb_id,
        vopt_list: opt_list,
        vten_bang: table_name
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          var ds = response.data.data
          ItemList = []
          //if (ItemList.length <= 0) return
          for (var i = 0; i < ds.length; i++) {
            var row = ds[i]
            if (!ItemList[i]) ItemList[i] = {}
            ItemList[i].sCaption = row['ten_hienthi']
            ItemList[i].sFieldName = row['field_name']
            ItemList[i].iDataType = row['data_type']
            ItemList[i].iAtt = row['att']
            ItemList[i].sMinvalue = row['min_value']
            ItemList[i].sMaxValue = row['max_value']
            ItemList[i].nFieldLength = row['field_length'] ? 0 : row['field_length']
            ItemList[i].sValue = row['field_value']
            ItemList[i].bIsNotNull = row['field_nullable'] ? false : row['field_nullable'] == '0' ? true : false
            ItemList[i].bIsUnique = row['field_unique'] ? false : row['field_unique'] == '0' ? false : true
            ItemList[i].sLookUpTableName = row['parent_table']
            ItemList[i].sLookUpKeyField = row['parent_keyfield']
            ItemList[i].sLookUpValueField = row['parent_descfield']
            ItemList[i].strDepandField = row['depend_field']
            ItemList[i].StrSql = row['lookup_sql']
            if (row['lookup_sql_response']) ItemList[i].SqlData = this.UpperCasePropertyList(row['lookup_sql_response'])
          }
        }
        return ItemList;
      })
    },
    async btnThongTinTC_Click() {
      // ThongTinTC()
      // this.DangXayDung();
      // return;
      try {
        if (!this.listbox.muccuoc_tb.value || this.listbox.muccuoc_tb.value <= 0) {
          this.$toast.error('Chưa có mức cước thuê bao. Bạn hãy kiểm tra lại!')
          return
        }
        var apidata = {}
        await API.post_fn_lay_thongtin_tc(this.axios, { ds_para: JSON.stringify({ MUCCUOCTB_ID: this.listbox.muccuoc_tb.value, DICHVUVT_ID: this.listbox.dichvu_vt.value, GOICUOC_ADSL: this.listbox.cboGoiCuocAdsl.value }) }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] != 1) {
              this.$toast.error(apidata['MESSAGE'])
              return
            }
            apidata = apidata['RESULT']
          }
        })
        // CheckDataFacade obj = new CheckDataFacade();
        // string cuoc_tb = obj.MAP_ID("cuoc_tb", DatabaseConstants.DB2 + ".muccuoc_tb", "where mucuoctb_id =" + cboMucCuocTB.SelectedValue);
        // string cuockhoan = obj.MAP_ID("cuockhoan", DatabaseConstants.DB2 + ".muccuoc_tb", "where mucuoctb_id =" + cboMucCuocTB.SelectedValue);
        // string cuoc_tg = obj.MAP_ID("cuoc_tg", DatabaseConstants.DB2 + ".muccuoc_tb", "where mucuoctb_id =" + cboMucCuocTB.SelectedValue);
        // string cuoc_ll = obj.MAP_ID("cuoc_ll", DatabaseConstants.DB2 + ".muccuoc_tb", "where mucuoctb_id =" + cboMucCuocTB.SelectedValue);
        var cuoc_tb = apidata['CUOC_TB'] ? apidata['CUOC_TB'] : 0
        var cuockhoan = apidata['CUOCKHOAN'] ? apidata['CUOCKHOAN'] : 0
        var cuoc_tg = apidata['CUOC_TG'] ? apidata['CUOC_TG'] : 0
        var cuoc_ll = apidata['CUOC_LL'] ? apidata['CUOC_LL'] : 0

        if (cuoc_tb == '-1') cuoc_tb = '0'
        if (cuockhoan == '-1') cuockhoan = '0'
        if (cuoc_tg == '-1') cuoc_tg = '0'
        if (cuoc_ll == '-1') cuoc_ll = '0'

        var dulieu = {
          cuoc_tb: cuoc_tb,
          cuoc_tg: cuoc_tg,
          cuockhoan: cuockhoan,
          cuoc_ll: cuoc_ll,
          muccuoctb_id: this.listbox.muccuoc_tb.value ? this.listbox.muccuoc_tb.value : 0,
          mienip: apidata['MIENIP'] ? apidata['MIENIP'] : null,
          loaitb_id: this.listbox.loaihinh_tb.value,
          thongtintc: this.thuebao.adsl.txtTTCuoc
        }

        this.popupComponent = () => import('../InstallNewSubs/Popups/popupThongTinTC')
        this.popupComponentName = 'popupThongTinTC'
        this.popupComponentData = dulieu
        this.Popup('popupComponents')
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    chkVMP_CheckedChanged() {
      if (this.cbvmp && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
        API.post_kiemtra_vmp(this.axios, { id: this.listbox.cboGoiCuocAdsl.value }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            if (response.data.data.length > 0) return
          }
          this.$toast.error('VMP không được đăng ký với tốc độ này. Mời bạn chọn lại!')
          this.cbvmp = false
          return
        })
      }
    },
    async cboCongNghe_SelectedValueChanged() {
      try {
        this.loading(true)
        if (this.ccongnghe.length > 0) {
          if (!this.listbox.congnghe.value || this.listbox.congnghe.value <= 0) return
          if (this.kt_load == false) {
            // var dk = "sudung = 1"; // khong dung, da tich hop trong stored
            await API.post_sp_ht_tocdo_adsl_theo_loaitb(this.axios, { congnghe_id: this.listbox.congnghe.value ? this.listbox.congnghe.value : 0, kieuld_id: this.listbox.kieu_ld.value, loaitb_id: this.listbox.loaihinh_tb.value }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.listbox.cboGoiCuocAdsl.list = response.data.data
                if (this.listbox.cboGoiCuocAdsl.list && this.listbox.cboGoiCuocAdsl.list.length > 0) this.listbox.cboGoiCuocAdsl.value = this.listbox.cboGoiCuocAdsl.list.filter((x) => x.tocdo_id > 0)[0].tocdo_id
                await this.cboGoiCuocAdsl_SelectedValueChanged(this.listbox.cboGoiCuocAdsl.value)
                // this.listbox.cboGoiCuocAdsl.values = [this.listbox.cboGoiCuocAdsl.value];
              }
            })
          }
        }
      } catch (ex) {
        this.$toast.error('Lỗi khi chọn công nghệ: ' + ex)
      } finally {
        this.loading(false)
      }
    },
    TaoDuLieu_TIEN_HDTB_TC(themmoi) {
      this.dsTien_HDTB = []
      var row = {}

      row.HDTB_ID = this.hdtb_id
      row.THUEBAO_ID = 0
      row.LOAITIEN_ID = 3
      if (this.thuebao.adsl.tientra) row.GIATRI = this.thuebao.adsl.tientra
      else row.GIATRI = 0

      this.dsTien_HDTB.push(row)
      // if (themmoi == false)
      // {
      //     dsTien_HDTB.AcceptChanges();
      //     dsTien_HDTB.TIEN_HDTB_TC.Rows[0].SetModified();
      // }
    },
    async Kiemtra_dungthu_mytv() {
      var kq = false
      await API.post_kiemtra_dungthu_mytv_moi(this.axios, {
        vdoituong_id: this.listbox.doituong.value,
        vloaitb_id: this.listbox.loaihinh_tb.value,
        vtocdo_id: this.tocdo_id
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          kq = response.data.data == 1
        }
      })
      return kq
    },
    async GiaoDien_DichVuVT(dichvuvt_id) {
      switch (
        dichvuvt_id * 1 // Bo qua cac case chi bat tat giao dien
      ) {
        case DichVuVienThong.MEGAWAN:
        case DichVuVienThong.METRONET:
        case DichVuVienThong.NOIBO_DADIEM:
          if (!this.thuebao.mgwan.txtMaTBWan.Text || this.thuebao.mgwan.txtMaTBWan.Text == '') this.SinhMaDVVT_BC()
          break
        case DichVuVienThong.MEGA_EYES:
          this.listbox.muccuoc_tb.value = MUCCUOC.TRON_GOI
          break
        case DichVuVienThong.TSL:
        case DichVuVienThong.NOIBO_2DIEM:
          //txtMaHD.ReadOnly = false; //FIXME Xac dinh lai xem la o nao, can thiet phai set khong?
          //HungHM - 18/08/2010 Sinh mã TSL
          if (this.thuebao.tsl.txtMaTSL.Text == '') this.SinhMaDVVT_BC()
          break
      }
    },
    async TaoDuLieu_HDTB_TSL(themmoi) {
      var kt_tram_capport = 0
      await API.post_huonggiao_ldv(this.axios, {
        quytrinh_id: this.quytrinh_tn,
        loaidv_dich_id: LOAI_DV.TRAM_CAP_PORT
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          kt_tram_capport = 1
        }
      })

      this.dsHDTB_TSL = []
      var rowHDTB_TSL = {}
      var row = {}

      for (var i = 0; i < 2; i++) {
        rowHDTB_TSL = {}
        rowHDTB_TSL.HDTB_ID = this.hdtb_id
        rowHDTB_TSL.DAUCUOI_ID = i + 1
        rowHDTB_TSL.MA_PL = this.thuebao.tsl.txtMaHD_TTKD_TSL ? this.thuebao.tsl.txtMaHD_TTKD_TSL.trim() : ''
        rowHDTB_TSL.TOCDO_ID = this.listbox.tocdokenh.valuetsl //Convert.ToInt32(cboTocDoKenhTSL.EditValue);
        rowHDTB_TSL.LOAIKENH_ID = this.listbox.loaikenh.valuetsl //Convert.ToInt32(cboLoaiKenhTSL.SelectedValue);
        rowHDTB_TSL.THOIHAN_ID = this.listbox.thoihan.valuetsl //Convert.ToInt32(cboThoiHan_TSL.SelectedValue);
        rowHDTB_TSL.TRANGBI_ID = this.listbox.trangbi.valuetsl //Convert.ToInt32(cboTrangBi.SelectedValue);
        rowHDTB_TSL.CHUQUAN_ID = this.listbox.chu_quan.valuetsl //Convert.ToInt32(cboChuQuan_TSL.EditValue);

        if (this.KetCuoi_ID > 0) rowHDTB_TSL.KETCUOI_ID = this.KetCuoi_ID

        if (this.listbox.congnghe.value > 0) rowHDTB_TSL.CONGNGHE_ID = this.listbox.congnghe.value
        //Convert.ToInt32(cboCongNghe.SelectedValue);
        else rowHDTB_TSL.CONGNGHE_ID = null //SetCONGNGHE_IDNull();

        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.CAPQUANG_TRANG_TSL) {
          if (this.thuebao.tsl.txtSoSoiQuang) rowHDTB_TSL.SL_SOIQUANG = this.thuebao.tsl.txtSoSoiQuang
          else rowHDTB_TSL.SL_SOIQUANG = null //SetSL_SOIQUANGNull();
        } else rowHDTB_TSL.SL_SOIQUANG = null //SetSL_SOIQUANGNull();

        if (this.listbox.doitactsl.chkDoiTacTSL) {
          rowHDTB_TSL.DOITAC_ID = this.listbox.doitactsl.value //Convert.ToInt32(cboDoiTacTSL.SelectedValue);
          if (this.thuebao.tsl.txtCuocTKDT_TSL) rowHDTB_TSL.CUOC_TKDT = this.thuebao.tsl.txtCuocTKDT_TSL
          //Convert.ToDecimal(Common.Utilities.CommonFunction.Unformat_tien(txtCuocTKDT_TSL.Text));
          else rowHDTB_TSL.CUOC_TKDT = 0
          if (this.thuebao.tsl.txtCuocTCDT_TSL) rowHDTB_TSL.CUOC_TCDT = this.thuebao.tsl.txtCuocTCDT_TSL
          //Convert.ToDecimal(Common.Utilities.CommonFunction.Unformat_tien(txtCuocTCDT_TSL.Text));
          else rowHDTB_TSL.CUOC_TCDT = 0

          rowHDTB_TSL.MAHD_DT = this.thuebao.tsl.txtMaHD_DT_TSL ? this.thuebao.tsl.txtMaHD_DT_TSL.trim() : '' //txtMaHD_DT_TSL.Text.trim();
        }

        if (this.thuebao.cvlct) {
          rowHDTB_TSL.MA_CV = this.thuebao.congvan ? this.thuebao.congvan.trim() : ''
          rowHDTB_TSL.NGAY_CV = this.thuebao.NgayCV
        }

        rowHDTB_TSL.MA_CRM = this.thuebao.crm ? this.thuebao.crm.trim() : ''
        rowHDTB_TSL.ID_ERP = this.thuebao.erp ? this.thuebao.erp.trim() : ''
        rowHDTB_TSL.MAKENH_VTN = this.thuebao.vtn ? this.thuebao.vtn.trim() : ''

        if (this.thuebao.tsl.txtCuocHT_TSL) rowHDTB_TSL.CUOC_HT = this.thuebao.tsl.txtCuocHT_TSL
        //Convert.ToDecimal(Common.Utilities.CommonFunction.Unformat_tien(txtCuocHT_TSL.Text));
        else rowHDTB_TSL.CUOC_HT = 0

        if (this.thuebao.tsl.txtCuocTBI_TSL) rowHDTB_TSL.CUOC_TBI = this.thuebao.tsl.txtCuocTBI_TSL
        //Convert.ToDecimal(Common.Utilities.CommonFunction.Unformat_tien(txtCuocTBI_TSL.Text));
        else rowHDTB_TSL.CUOC_TBI = 0

        if (this.thuebao.tsl.txtCuocTC_TSL) rowHDTB_TSL.CUOC_TC = this.thuebao.tsl.txtCuocTC_TSL
        //Convert.ToDecimal(Common.Utilities.CommonFunction.Unformat_tien(txtCuocTC_TSL.Text));
        else rowHDTB_TSL.CUOC_TC = 0

        if (this.thuebao.tsl.txtCuocTK_TSL) rowHDTB_TSL.CUOC_TK = this.thuebao.tsl.txtCuocTK_TSL
        //Convert.ToDecimal(Common.Utilities.CommonFunction.Unformat_tien(txtCuocTK_TSL.Text));
        else rowHDTB_TSL.CUOC_TK = 0
        if (this.ma_vnpt != '-1') rowHDTB_TSL.MA_VNPT = this.ma_vnpt

        if (i == 0) {
          //Nếu là điểm đầu
          rowHDTB_TSL.DIACHI = this.diachiDau.DIACHI
          rowHDTB_TSL.DIACHI_ID = this.diachiDau.DIACHI_ID
          rowHDTB_TSL.KINHDO_LD = this.diachiDau.Lng
          rowHDTB_TSL.VIDO_LD = this.diachiDau.Lat
          rowHDTB_TSL.MA_TB_SUB = this.thuebao.tsl.txtMaTSL.Text ? this.thuebao.tsl.txtMaTSL.Text.trim() + '_01' : '_01'
          rowHDTB_TSL.MA_LT = this.ma_tb_ao_ht

          rowHDTB_TSL.TINH_ID = this.thuebao.tsl.tinh_dau.tinhthicong_id
          rowHDTB_TSL.TINH_DC_ID = 1

          if (this.$root.token.getPhanVungID() == this.thuebao.tsl.tinh_dau.tinhthicong_id) {
            //(this.tt_nd.tinh_id == tinh_dau.tinhthicong_id)
            row = {}
            row.HDTB_ID = this.hdtb_id
            row.LOAIDV_ID = LOAI_DV.TRAM_VT
            row.KIEUDV_ID = i + 1
            row.DONVI_ID = this.listbox.donvi_dau.value
            this.dsHDTBDV.push(row)

            if (kt_tram_capport == 1) {
              row = {}
              row.HDTB_ID = this.hdtb_id
              row.LOAIDV_ID = LOAI_DV.TRAM_CAP_PORT
              row.KIEUDV_ID = i + 1
              row.DONVI_ID = this.listbox.donvi_dau.value
              this.dsHDTBDV.push(row)
            }
          }

          rowHDTB_TSL.THIETBIDC_ID = this.listbox.loai_tb.valuedau //Convert.ToInt32(cboLoaiTBTSL_Dau.SelectedValue);
          rowHDTB_TSL.LOAICAP_ID = this.listbox.loaicap.valuedau //Convert.ToInt32(cboLoaiCap_Dau.SelectedValue);
          rowHDTB_TSL.SITE_ID = this.thuebao.tsl.txtSiteIDTSL_Dau ? this.thuebao.tsl.txtSiteIDTSL_Dau.trim() : this.thuebao.tsl.txtSiteIDTSL_Dau
          rowHDTB_TSL.VRF = this.thuebao.tsl.txtVrf_Dau ? this.thuebao.tsl.txtVrf_Dau.trim() : this.thuebao.tsl.txtVrf_Dau
          rowHDTB_TSL.CHUQUANLD_ID = this.thuebao.tsl.cboChuQuanLD_Dau.value //this.thuebao.tsl.thongso_tc_dau.chuquanld_id;//Convert.ToInt32(cboChuQuanLD_Dau.SelectedValue);
          if (this.thongso_ban.mhkn_id != 0) rowHDTB_TSL.MHKN_ID = this.thongso_ban.mhkn_id
          if (this.thongso_ban.gdkn_id != 0) rowHDTB_TSL.GDKN_ID = this.thongso_ban.gdkn_id
          if (this.thongso_ban.yc_baove != 0) rowHDTB_TSL.YC_BAOVE = this.thongso_ban.yc_baove
          if (this.thongso_ban.nhomloaikenh_id != 0) rowHDTB_TSL.NHOMLOAIKENH_ID = this.thongso_ban.nhomloaikenh_id
          if (this.thongso_ban.hatang_vnpt != 0) rowHDTB_TSL.HATANG_VNPT = this.thongso_ban.hatang_vnpt

          rowHDTB_TSL.MTU_SIZE = this.thongso_ban.mtu_size
          rowHDTB_TSL.AUTO_NEGO = this.thongso_ban.auto_nego
          rowHDTB_TSL.SNBP = this.thongso_ban.sncp
          rowHDTB_TSL.CAP_CHINH = this.thongso_ban.cap_chinh
          rowHDTB_TSL.CAP_DUPHONG = this.thongso_ban.cap_duphong

          // row.DONVI_ID = this.listbox.donvi_dau.value;//Convert.ToInt32(cboVetinhTSL_Dau.SelectedValue);
          // this.dsHDTBDV.push(row);
          // if (kt_tram_capport == 1)
          // {
          //     row = {};
          //     row.HDTB_ID = this.hdtb_id;
          //     row.LOAIDV_ID = LOAI_DV.TRAM_CAP_PORT;
          //     row.KIEUDV_ID = i + 1;
          //     row.DONVI_ID = this.listbox.donvi_dau.value;//Convert.ToInt32(cboVetinhTSL_Dau.SelectedValue);
          //     this.dsHDTBDV.push(row);
          // }

          // rowHDTB_TSL.THIETBIDC_ID = this.listbox.loai_tb.valuedau; //Convert.ToInt32(cboLoaiTBTSL_Dau.SelectedValue);
          // rowHDTB_TSL.LOAICAP_ID = this.listbox.loaicap.valuedau; //Convert.ToInt32(cboLoaiCap_Dau.SelectedValue);
          // rowHDTB_TSL.SITE_ID = this.thuebao.tsl.txtSiteIDTSL_Dau.trim();
          // rowHDTB_TSL.VRF = this.thuebao.tsl.txtVrf_Dau.trim();
          //rowHDTB_TSL.SO_DT = txtSoDTDau.Text;
        } else {
          rowHDTB_TSL.DIACHI = this.diachiCuoi.DIACHI
          rowHDTB_TSL.DIACHI_ID = this.diachiCuoi.DIACHI_ID
          rowHDTB_TSL.KINHDO_LD = this.diachiCuoi.Lng
          rowHDTB_TSL.VIDO_LD = this.diachiCuoi.Lat
          rowHDTB_TSL.MA_TB_SUB = this.thuebao.tsl.txtMaTSL.Text ? this.thuebao.tsl.txtMaTSL.Text.trim() + '_02' : '_02'
          rowHDTB_TSL.MA_LT = this.ma_tb_ao_ht_cuoi

          rowHDTB_TSL.TINH_ID = this.thuebao.tsl.tinh_cuoi.tinhthicong_id
          rowHDTB_TSL.TINH_DC_ID = 2

          if (this.$root.token.getPhanVungID() == this.thuebao.tsl.tinh_cuoi.tinhthicong_id) {
            //(this.tt_nd.tinh_id == tinh_dau.tinhthicong_id)
            row = {}
            row.HDTB_ID = this.hdtb_id
            row.LOAIDV_ID = LOAI_DV.TRAM_VT
            row.KIEUDV_ID = i + 1
            row.DONVI_ID = this.listbox.donvi_cuoi.value
            this.dsHDTBDV.push(row)

            if (kt_tram_capport == 1) {
              row = {}
              row.HDTB_ID = this.hdtb_id
              row.LOAIDV_ID = LOAI_DV.TRAM_CAP_PORT
              row.KIEUDV_ID = i + 1
              row.DONVI_ID = this.listbox.donvi_cuoi.value
              this.dsHDTBDV.push(row)
            }
          }

          rowHDTB_TSL.THIETBIDC_ID = this.listbox.loai_tb.valuecuoi //Convert.ToInt32(cboLoaiTBTSL_Dau.SelectedValue);
          rowHDTB_TSL.LOAICAP_ID = this.listbox.loaicap.valuecuoi //Convert.ToInt32(cboLoaiCap_Dau.SelectedValue);
          rowHDTB_TSL.SITE_ID = this.thuebao.tsl.txtSiteIDTSL_Cuoi ? this.thuebao.tsl.txtSiteIDTSL_Cuoi.trim() : this.thuebao.tsl.txtSiteIDTSL_Cuoi
          rowHDTB_TSL.VRF = this.thuebao.tsl.txtVrf_Cuoi ? this.thuebao.tsl.txtVrf_Cuoi.trim() : this.thuebao.tsl.txtVrf_Cuoi
          rowHDTB_TSL.CHUQUANLD_ID = this.thuebao.tsl.cboChuQuanLD_Cuoi.value //this.thuebao.tsl.thongso_tc_dau.chuquanld_id;//Convert.ToInt32(cboChuQuanLD_Dau.SelectedValue);
          if (this.thongso_ban.mhkn_id != 0) rowHDTB_TSL.MHKN_ID = this.thongso_ban.mhkn_id
          if (this.thongso_ban.gdkn_id != 0) rowHDTB_TSL.GDKN_ID = this.thongso_ban.gdkn_id
          if (this.thongso_ban.yc_baove != 0) rowHDTB_TSL.YC_BAOVE = this.thongso_ban.yc_baove
          if (this.thongso_ban.nhomloaikenh_id != 0) rowHDTB_TSL.NHOMLOAIKENH_ID = this.thongso_ban.nhomloaikenh_id
          if (this.thongso_ban.hatang_vnpt != 0) rowHDTB_TSL.HATANG_VNPT = this.thongso_ban.hatang_vnpt

          rowHDTB_TSL.MTU_SIZE = this.thongso_ban.mtu_size
          rowHDTB_TSL.AUTO_NEGO = this.thongso_ban.auto_nego
          rowHDTB_TSL.SNBP = this.thongso_ban.sncp
          rowHDTB_TSL.CAP_CHINH = this.thongso_ban.cap_chinh
          rowHDTB_TSL.CAP_DUPHONG = this.thongso_ban.cap_duphong

          // row.DONVI_ID = this.listbox.donvi_cuoi.value;//Convert.ToInt32(cboVetinhTSL_Cuoi.SelectedValue);
          // this.dsHDTBDV.push(row);
          // if (kt_tram_capport == 1)
          // {
          //     row = {};
          //     row.HDTB_ID = this.hdtb_id;
          //     row.LOAIDV_ID = LOAI_DV.TRAM_CAP_PORT;
          //     row.KIEUDV_ID = i + 1;
          //     row.DONVI_ID = this.listbox.donvi_cuoi.value;//Convert.ToInt32(cboVetinhTSL_Cuoi.SelectedValue);
          //     this.dsHDTBDV.push(row);
          // }

          // rowHDTB_TSL.THIETBIDC_ID = this.listbox.loai_tb.valuecuoi; //Convert.ToInt32(cboLoaiTBTSL_Cuoi.SelectedValue);
          // rowHDTB_TSL.LOAICAP_ID = this.listbox.loaicap.valuecuoi; //Convert.ToInt32(cboLoaiCap_Cuoi.SelectedValue);
          // rowHDTB_TSL.SITE_ID = this.thuebao.tsl.txtSiteIDTSL_Cuoi.trim();
          // rowHDTB_TSL.VRF = this.thuebao.tsl.txtVrf_Cuoi.trim();
          // //rowHDTB_TSL.SO_DT = txtSoDTCuoi.Text;
        }
        // if (!themmoi)
        //     rowHDTB_TSL.MA_VNPT = this.ma_vnpt;

        this.dsHDTB_TSL.push(rowHDTB_TSL)
      }

      // if (themmoi == false)
      // {
      //     dsHDTB_TSL.AcceptChanges();
      //     dsHDTB_TSL.HDTB_TSL.Rows[0].SetModified();
      //     dsHDTB_TSL.HDTB_TSL.Rows[1].SetModified();
      // }

      //Tạo cho bảng hdtb_dv
      // //Với Truyền số liệu thì tự thêm các dòng # trạm viễn thông
      for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

        if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
          throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
          return;
        }
        if (this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0 != LOAI_DV.TRAM_VT) {
          var row = {}
          row.HDTB_ID = this.hdtb_id
          row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
          row.DONVI_ID = this.DT_CONTROLS.value[i]
          row.KIEUDV_ID = 2
          this.dsHDTBDV.push(row)
        }
      }
      //End
    },
    btnSoAoTSL_Click() {
      try {
        if (this.listbox.dichvu_vt.value != DichVuVienThong.CO_DINH) {
          if (this.diachiDau.QUAN_ID == 0 || this.diachiDau.PHUONG_ID == 0) {
            this.$toast.error('Bạn chưa chọn địa chỉ điểm đầu !')
            // txtDiaChiDau.Focus();
            return
          }

          this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonSM')
          this.popupComponentName = 'popupChonSMTSLDau'
          this.popupComponentData = {
            _quan_id: this.diachiDau.QUAN_ID,
            _phuong_id: this.diachiDau.PHUONG_ID,
            _loaiso_id: LOAISO.AO,
            _thueso: false,
            loaitb_id: this.listbox.loaihinh_tb.value,
            dichvuvt_id: this.listbox.dichvu_vt.value,
            hdkh_id: this.khachhang.hdkh_id,
            donvi_ql_id: this.listbox.donvi_dau.value //this.listbox.donvi_ql.value//ql (lay field don vi lap dat.)
          }
          this.Popup('popupComponents')
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    btnSoAoTSL_Cuoi_Click() {
      try {
        if (this.listbox.dichvu_vt.value != DichVuVienThong.CO_DINH) {
          if (this.diachiCuoi.QUAN_ID == 0 || this.diachiCuoi.PHUONG_ID == 0) {
            this.$toast.error('Bạn chưa chọn địa chỉ điểm cuối !')
            // txtDiaChiDau.Focus();
            return
          }

          this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonSM')
          this.popupComponentName = 'popupChonSMTSLCuoi'
          this.popupComponentData = {
            _quan_id: this.diachiCuoi.QUAN_ID,
            _phuong_id: this.diachiCuoi.PHUONG_ID,
            _loaiso_id: LOAISO.AO,
            _thueso: false,
            loaitb_id: this.listbox.loaihinh_tb.value,
            dichvuvt_id: this.listbox.dichvu_vt.value,
            hdkh_id: this.khachhang.hdkh_id,
            donvi_ql_id: this.listbox.donvi_cuoi.value //this.listbox.donvi_ql.value//ql (lay field don vi lap dat.)
          }
          this.Popup('popupComponents')
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async SINH_MATB_DICHVU_DOITAC() {
      var pdata = {
        vchuquan_id: 85,
        vdichvuvt_id: this.listbox.dichvu_vt.value,
        vloaitb_id: this.listbox.loaihinh_tb.value
      }
      switch (pdata.vdichvuvt_id * 1) {
        case DichVuVienThong.BRCD_DOITAC:
          pdata.vchuquan_id = this.listbox.chu_quan.valueadsl
          break
        case DichVuVienThong.IMS_DOITAC:
          pdata.vchuquan_id = this.listbox.chu_quan.valueims
          break
        case DichVuVienThong.MGW_DOITAC:
          pdata.vchuquan_id = this.listbox.chu_quan.valuewan
          break
        case DichVuVienThong.TSL_DOITAC:
          pdata.vchuquan_id = this.listbox.chu_quan.valuetsl
          break
      }
      await API.post_sinh_matb_doitac(this.axios, pdata).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          if (response.data.data != '' && response.data.data != -1)
            switch (pdata.vdichvuvt_id * 1) {
              case DichVuVienThong.BRCD_DOITAC:
                this.thuebao.adsl.txtAccountADSL = response.data.data
                break
              case DichVuVienThong.IMS_DOITAC:
                this.thuebao.ims.txtMaTBIMS = response.data.data
                break
              case DichVuVienThong.MGW_DOITAC:
                this.thuebao.mgwan.txtMaTBWan.Text = response.data.data
                break
              case DichVuVienThong.TSL_DOITAC:
                this.thuebao.tsl.txtMaTSL.Text = response.data.data
                break
            }
        }
      })
    },
    btnGphone_Click() {
      if (!this.diachiLD.QUAN_ID || this.diachiLD.QUAN_ID == 0 || !this.diachiLD.PHUONG_ID || this.diachiLD.PHUONG_ID == 0) {
        this.$toast.error('Bạn chưa chọn địa chỉ lắp đặt !')
        return
      }
      this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonSM')
      this.popupComponentName = 'popupChonSoMayGphone'
      this.popupComponentData = {
        _quan_id: this.diachiLD.QUAN_ID,
        _phuong_id: this.diachiLD.PHUONG_ID,
        _loaiso_id: LOAISO.THUONG,
        _thueso: false,
        loaitb_id: this.listbox.loaihinh_tb.value,
        dichvuvt_id: this.listbox.dichvu_vt.value,
        hdkh_id: this.khachhang.hdkh_id,
        donvi_ql_id: this.listbox.donvi_ql.value //ql (lay field don vi lap dat.)
      }
      this.Popup('popupComponents')
    },
    async TaoDuLieu_HDTB_GP() {
      this.dsHDTB_GP = []
      var rowHDTB_GP = {}

      rowHDTB_GP.HDTB_ID = this.hdtb_id
      rowHDTB_GP.SIMCARD = this.thuebao.gphone.txtSoSimGphone
      rowHDTB_GP.MC_TBGP_ID = this.thuebao.gphone.checkVSVX ? 1 : 0 // checkbox an

      if (this.listbox.congnghe.value > 0) rowHDTB_GP.CONGNGHE_ID = this.listbox.congnghe.value
      else rowHDTB_GP.CONGNGHE_ID = null

      rowHDTB_GP.TRANGBI_ID = this.listbox.trangbi.valuegp
      rowHDTB_GP.CHUQUAN_ID = this.listbox.chu_quan.valuegp
      this.dsHDTB_GP.push(rowHDTB_GP)
      // if (themmoi == false)
      // {
      //     dsHDTB_GP.AcceptChanges();
      //     dsHDTB_GP.HDTB_GP.Rows[0].SetModified();
      // }

      //Tạo cho bảng hdtb_dv
      for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

        if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
          throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
          return;
        }
        var row = {}
        row.HDTB_ID = this.hdtb_id
        row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
        row.DONVI_ID = this.DT_CONTROLS.value[i]
        row.KIEUDV_ID = 2
        this.dsHDTBDV.push(row)
      }
      //End
    },
    async cboTrangBiGphone_SelectedValueChanged() {
      if (!this.listbox.trangbi.list || this.listbox.trangbi.list.length <= 0 || !this.listbox.trangbi.valuetsl || this.listbox.trangbi.valuetsl <= 0) return
      this.trangbi_id = this.listbox.trangbi.valuetsl
      this.LoadMucCuocTB()
      if (!this.kt_load) {
        this.HT_DS_KhuyenMai_Combobox()
        this.LayTienTheoKhoanMuc()
      }
    },
    btnChonSoIMS_Click() {
      if (!this.diachiLD.QUAN_ID || this.diachiLD.QUAN_ID == 0 || !this.diachiLD.PHUONG_ID || this.diachiLD.PHUONG_ID == 0) {
        this.$toast.error('Bạn chưa chọn địa chỉ lắp đặt !')
        return
      }
      this.popupComponent = () => import('./Popups/popupChonSM.vue') //()=>import('../InstallNewSubs/Popups/popupChonSM');
      this.popupComponentName = 'popupChonSoMayIMS'
      this.popupComponentData = {
        _tinh_id: this.tinh.tinhthicong_id,
        _mavung: this.tinh.mavung,
        _quan_id: this.diachiLD.QUAN_ID,
        _phuong_id: this.diachiLD.PHUONG_ID,
        _loaiso_id: LOAISO.THUONG,
        _thueso: false,
        loaitb_id: this.listbox.loaihinh_tb.value,
        dichvuvt_id: this.listbox.dichvu_vt.value,
        hdkh_id: this.khachhang.hdkh_id,
        donvi_ql_id: this.listbox.donvi_ql.value //ql (lay field don vi lap dat.)
      }
      this.Popup('popupComponents')
    },
    async TaoDuLieu_HDTB_IMS(themmoi) {
      this.dsHDTB_IMS = []
      var rowHDTB_IMS = {}
      rowHDTB_IMS.HDTB_ID = this.hdtb_id
      var pdata = { KIEULD_ID: this.listbox.kieu_ld.value, MADOICAP_IMS: this.thuebao.ims.txtMaDoiCap_IMS ? this.thuebao.ims.txtMaDoiCap_IMS : 0, THEMMOI: themmoi ? 1 : 0 }
      var apidata = {}
      await API.post_fn_lay_tt_taodl_hdtb_ims(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          var apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            this.$toast.error(apidata['MESSAGE'])
            throw apidata['MESSAGE'];
          }
          apidata = apidata['RESULT']
        }
      })
      if (apidata['MADOICAP']) this.thuebao.ims.txtMaDoiCap_IMS = apidata['MADOICAP']
      rowHDTB_IMS.MADOICAP = this.thuebao.ims.txtMaDoiCap_IMS
      rowHDTB_IMS.THOIHAN_ID = this.listbox.thoihan.valueims

      if (this.listbox.congnghe.value > 0) rowHDTB_IMS.CONGNGHE_ID = this.listbox.congnghe.value
      else rowHDTB_IMS.CONGNGHE_ID = null

      if (this.thuebao.ims.chkDoiTac_IMS) {
        rowHDTB_IMS.DOITAC_ID = this.listbox.doitac.valueims
        if (this.thuebao.ims.txtCuocDT_IMS) rowHDTB_IMS.CUOC_DOITAC = this.thuebao.ims.txtCuocDT_IMS
        else rowHDTB_IMS.CUOC_DOITAC = 0
      } else {
        rowHDTB_IMS.DOITAC_ID = null
        rowHDTB_IMS.CUOC_DOITAC = null
      }

      rowHDTB_IMS.MATB_TN = this.thuebao.ims.txtMaTN_IMS
      rowHDTB_IMS.TRANGBI_ID = this.listbox.trangbi.valueims
      // BangThamSo bts = new BangThamSo();
      // DataTable _dt = bts.getDataFromSQL("select dauso_ims from " + DatabaseConstants.DB2 + ".tinh where tentat = '" + DatabaseConstants.DB2.Substring(4) + "'", "tinh").Tables[0];
      rowHDTB_IMS.USERNAME = '84' + (apidata['DAUSO_IMS'] ? apidata['DAUSO_IMS'] : '') + this.ma_tb_ht.toLowerCase()

      if (themmoi == true) {
        //Chốt all tỉnh mật khẩu sinh theo dạng độ dài 10 ký tự
        this.thuebao.ims.pass_ims = ''
        this.thuebao.ims.pass_ims = this.GetRandomText(10)
      }
      rowHDTB_IMS.PASSWORD = this.thuebao.ims.pass_ims

      rowHDTB_IMS.CHUQUAN_ID = this.listbox.chu_quan.valueims
      rowHDTB_IMS.CHUQUANLD_ID = this.listbox.chu_quan.valueldims
      rowHDTB_IMS.TINHKHAC = apidata['TINHKHACH']
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IMS_SIPTRUNKING) {
        rowHDTB_IMS.SL_CUOCGOI = this.thuebao.ims.txtCuocGoiDT
        rowHDTB_IMS.CTDV_ID = this.listbox.ht_chitietdv_ims.value //Convert.ToInt32(cboChiTietDV.SelectedValue);
        if (this.listbox.ht_chitietdv_ims.value == ChiTietDV_IMS.internet) rowHDTB_IMS.IP = this.thuebao.ims.txtIp_IMS ? this.thuebao.ims.txtIp_IMS.trim() : this.thuebao.ims.txtIp_IMS

        if (this.thuebao.ims.cbkTrunk) rowHDTB_IMS.TRUNKID = this.thuebao.ims.cboTrunk
        rowHDTB_IMS.HTTC_ID = this.listbox.hinhthuc_tc.valueims
      } else {
        rowHDTB_IMS.SL_CUOCGOI = null
        rowHDTB_IMS.CTDV_ID = null
        rowHDTB_IMS.IP = null
      }
      if (!themmoi) rowHDTB_IMS.MA_VNPT = this.ma_vnpt

      this.dsHDTB_IMS.push(rowHDTB_IMS)

      // if (themmoi == false)
      // {
      //     dsHDTB_IMS.AcceptChanges();
      //     dsHDTB_IMS.HDTB_IMS.Rows[0].SetModified();
      // }

      //Tạo cho bảng hdtb_dv
      for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

        if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
          throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
          return;
        }
        var row = {}
        row.HDTB_ID = this.hdtb_id
        row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
        row.DONVI_ID = this.DT_CONTROLS.value[i]
        row.KIEUDV_ID = 2
        this.dsHDTBDV.push(row)
      }
      //End
    },

    generateUUID() {
      // Public Domain/MIT
      var d = new Date().getTime() //Timestamp
      var d2 = (typeof performance !== 'undefined' && performance.now && performance.now() * 1000) || 0 //Time in microseconds since page-load or 0 if unsupported
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 //random number between 0 and 16
        if (d > 0) {
          //Use timestamp until depleted
          r = (d + r) % 16 | 0
          d = Math.floor(d / 16)
        } else {
          //Use microseconds since page-load if supported
          r = (d2 + r) % 16 | 0
          d2 = Math.floor(d2 / 16)
        }
        return (c === 'x' ? r : (r & 0x3) | 0x8).toString(16)
      })
    },
    GetRandomText(length) {
      var uniqueID = this.generateUUID()
      var randString = ''
      var j = 0
      for (var i = 0; i < uniqueID.length && j < length; i++) {
        var l_ch = uniqueID[i]
        if ((l_ch >= 'A' && l_ch <= 'Z') || (l_ch >= 'a' && l_ch <= 'z') || (l_ch >= '0' && l_ch <= '9')) {
          randString += l_ch
          j++
        }
      }
      return randString
    },
    async btnMaTN_IMS_Click() {
      var dulieu = {}
      var kieu = await API.post_fn_tt_kieu_ld(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, param: this.thongso_tc.kieuld_id })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return 0
        })
        .catch(() => {
          return 0
        }) //this.kieu_ld_kieu;
      switch (kieu * 1) {
        case 2:
          if (this.khachhang.khachhang_id && this.khachhang.khachhang_id > 0) {
            dulieu.khachhang_id = this.khachhang.khachhang_id
            dulieu.kieuld_id = this.listbox.kieu_ld.value
            dulieu.loaitb_id = this.listbox.loaihinh_tb.value
            dulieu.dichvuvt_id = this.listbox.dichvu_vt.value
            this.popupComponentData = dulieu
            this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBCungDoiCap')
            this.popupComponentName = 'popupDSTBCungDoiCapIMS'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp trên đường có sẵn !')
            return
          }
          break
        case 1:
          if (this.khachhang.hdkh_id && this.khachhang.hdkh_id > 0) {
            dulieu.hdkh_id = this.khachhang.hdkh_id
            dulieu.vkhachhang_id = this.khachhang.khachhang_id
            dulieu.vkieuld_id = this.listbox.kieu_ld.value
            // dulieu.loaitb_id = this.listbox.loaihinh_tb.value;
            this.popupComponentData = dulieu
            this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBLapKem')
            this.popupComponentName = 'popupDSTBLapKemIMS'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp kèm !')
            return
          }
          break
        case 4:
          dulieu.loaitb_id = this.listbox.loaihinh_tb.value
          dulieu.kieuld_id = this.listbox.kieu_ld.value
          this.popupComponentData = dulieu
          this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBCungDoiCap_KH_Khac')
          this.popupComponentName = 'popupDSTBCungDoiCap_KH_KhacIMS'
          break
      }
      this.Popup('popupComponents')
    },
    async TaoDuLieu_HDTB_DD(themmoi) {
      this.dsHDTB_DD = []
      var rowHDTB_DD = {}

      rowHDTB_DD.HDTB_ID = this.hdtb_id
      rowHDTB_DD.SIMCARD = this.thuebao.didong.txtSimDD
      rowHDTB_DD.TIEN_DTK = this.thuebao.didong.txtTienDuTK
      rowHDTB_DD.GOICUOC_ID = this.thuebao.didong.cboGoiCuocDD.value //HungHM - Them column GOICUOC_ID

      rowHDTB_DD.SOMAY_NTK = this.thuebao.didong.txtSoMayDD //HungHM - Them column SOMAY_NTK
      rowHDTB_DD.TRANGBI_ID = this.listbox.trangbi.valuedd

      rowHDTB_DD.GHICHU = this.thuebao.ghichu //txtGhiChuTB.Text;

      this.dsHDTB_DD.push(rowHDTB_DD)
      // if (themmoi == false)
      // {
      //     dsHDTB_DD.AcceptChanges();
      //     dsHDTB_DD.HDTB_DD.Rows[0].SetModified();
      // }
    },
    async Insert_HDLD_VinaPhone() {
      var kt_dulieu_vina = 0 // FIXME de tam, day la bien global
      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      var defNull = 'Phải chọn loại thuê bao di động trả sau'
      if (!this.listbox.dichvu_vt.value || this.listbox.dichvu_vt.value != DichVuVienThong.DI_DONG) return defNull
      if (!this.listbox.loaihinh_tb.value || this.listbox.loaihinh_tb.value != LoaiHinhTB.DIDONGTRASAU) return defNull
      var pdata = {
        KIEULD_ID: this.listbox.kieu_ld.value,
        QUANTT_ID: this.diachiTT.QUAN_ID,
        PHUONGTT_ID: this.diachiTT.PHUONG_ID,
        PHOTT_ID: this.diachiTT.PHO_ID,
        QUANLD_ID: this.diachiLD.QUAN_ID,
        PHUONGLD_ID: this.diachiLD.PHUONG_ID,
        DONVI_TT_ID: this.dsHDTT[0]['donvi_id'],
        GOICUOC_ID: this.dsHDTB_DD[0]['goicuoc_id'],
        HTTT_ID: this.dsHDTT[0]['httt_id'],
        LOAIGT_ID: this.dsHDKH[0]['loaigt_id'],
        QUOCTICH_ID: this.listbox.quoctich.value,
        MA_NVTV: this.thanhtoan.manvtc,
        MA_TT: this.dsHDTT[0]['ma_tt'],
        QUANKH_ID: this.diachiKH.QUAN_ID,
        PHUONGKH_ID: this.diachiKH.PHUONG_ID,
        PHOKH_ID: this.diachiKH.PHO_ID,
        TNC2_ID: this.dsHDKH[0]['tnc2_id'],
        NGANHANG_ID: this.dsHDTT[0]['nganhang_id'],
        CTV_ID: this.ctv_id,
        LOAIKH_ID: this.dsHDKH[0]['loaikh_id']
      }
      var apidata = {}
      await API.post_fn_lay_tt_hdld_vinaphone(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            defNull = apidata['MESSAGE']
            kt_dulieu_vina = 1
            return
          }
          apidata = apidata['RESULT']
        }
      })
      if (kt_dulieu_vina == 1) return defNull
      // CheckDataFacade checkdata = new CheckDataFacade();
      // VINAService vina = new VINAService();
      if (!this.tt_nd.user_neo || this.tt_nd.user_neo == -1) {
        kt_dulieu_vina = 1
        return 'Thông tin người dùng chưa đồng bộ với dữ liệu VinaPhone. Bạn không thể tiếp tục cập nhật dữ liệu.'
      }

      if (this.listbox.kieu_ld.value && this.listbox.kieu_ld.value == KieuLapDat.DM_DIDONG_CHUYEN_TINH) {
        //#region Hòa mạng chuyển tỉnh
        try {
          var inputObj = {}
          inputObj.userid = this.tt_nd.user_neo
          inputObj.dia_chi_bc = this.diachiBC.DIACHI

          inputObj.quanct_id = apidata['QUANCT_ID']
          inputObj.phuongct_id = apidata['PHUONGCT_ID']
          inputObj.phoct_id = apidata['PHOCT_ID']
          inputObj.quanld = apidata['QUANLD_ID']
          inputObj.phuonglapdat_id = apidata['PHUONGLD_ID']
          inputObj.phold = apidata['PHOLD_ID']

          inputObj.dia_chi_ct = this.dsHDTT[0]['diachi_tt']
          inputObj.so_nha_ct = this.diachiTT.SONHA //CommonFunction.ChuanHoa_XML(sonhatt);

          inputObj.quantt_id = inputObj.quanct_id
          inputObj.phuongtt_id = inputObj.phuongct_id
          inputObj.phott_id = inputObj.phoct_id
          inputObj.dia_chi_tt = inputObj.dia_chi_ct
          inputObj.sonha_tt = inputObj.so_nha_ct

          inputObj.mst = this.dsHDTT[0]['mst']
          inputObj.noi_cap = this.dsHDKH[0]['noicap']
          inputObj.inchitiet = '0'
          inputObj.nv_hd = ''
          inputObj.ghi_chu = ''
          inputObj.email_bc = this.thuebao.didong.txtEmailDD
          inputObj.email_hd = this.thuebao.didong.txtEmailDD

          inputObj.loai_dc_bao_cuoc = '0'
          inputObj.kieu_bao_cuoc = '0'
          inputObj.ma_bc = apidata['MA_BC']
          // vuth update 0912 fix ma_bc va nganhang
          inputObj.ngan_hang = '0'
          inputObj.so_tb = '84' + this.dsHDTB[0]['ma_tb']
          inputObj.ma_t = ''
          inputObj.sonha_ld = this.diachiLD.SONHA
          inputObj.nguoi_gt = ''
          inputObj.dia_chi_hd = ''
          inputObj.ma_tinh = this.tt_nd.tentat_ccbs // vuth update 0912
          inputObj.taikhoan = ''

          inputObj.so_giay_to = this.dsHDKH[0]['so_gt']
          if (this.thuebao.didong.cboDTVinaPhone.list.length > 0) {
            inputObj.doi_tuong_su_dung = this.thuebao.didong.cboDTVinaPhone.value
          }
          if (!inputObj.doi_tuong_su_dung) inputObj.doi_tuong_su_dung = '1'
          inputObj.loai_tb = apidata['LOAI_TB']

          inputObj.ten_tt = this.dsHDTT[0]['ten_tt']
          inputObj.dienthoai_ld = this.khachhang.dienthoai

          inputObj.diadiem_tt_id = apidata['DIADIEM_TT_ID']

          inputObj.ten_tb = this.dsHDTB[0]['ten_tb']
          inputObj.chuyenkhoan_id = '0' // vuth update 0912
          inputObj.in_hd_id = '0'

          inputObj.loaigt_id = apidata['LOAIGT_ID']

          inputObj.ngay_cap = this.dsHDKH[0]['ngaycap']

          inputObj.so_sim = this.dsHDTB_DD[0]['simcard']

          inputObj.ngay_sinh = this.dsHDTB[0]['ngay_sn']
          inputObj.doituong_id = inputObj.doi_tuong_su_dung
          inputObj.quoc_tich = apidata['QUOC_TICH'] // vuth update 0912
          inputObj.ma_nv = apidata['MANV_VNP'] //23072020
          inputObj.makh = this.khachhang.makh;
          var rs = {};
          await API.post_ts_laphd_chuyentinh_new_thuebao_cts(this.axios, inputObj).then(async (response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              rs = response.data.data
              if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;
            }
              rs.Message = response.data.message
          })

          if (!rs.IssSuccessed) return 'Lỗi xảy ra trong quá trình thêm mới hợp đồng hòa mạng chuyển tỉnh lên Vinaphone.' + rs.Message
        } catch (ex) {
          return 'Lỗi xảy ra trong quá trình thêm mới hợp đồng hòa mạng chuyển tỉnh lên Vinaphone.' + ex
        }
        this.$toast.success(`Tạo mới hợp đồng hòa mạng chuyển tỉnh ${this.dsHDKH[0]['ma_gd']} trên VinaPhone thành công!`)
        //#endregion
      } else {
        // #region Hòa mạng mới
        try {
          var thangcamket = this.thuebao.thangck
          if (!thangcamket) {
            return 'Số tháng cam kết không được để trống'
          }
          if (!([12, 24].indexOf(thangcamket * 1) >= 0)) return 'Số tháng cam kết phải là 12 hoặc 24 tháng'

          var inputObj = {}
          var matt_neo = apidata['MA_TT_NEO']
          if (matt_neo == '-1') matt_neo = this.dsHDTT[0]['ma_tt']

          inputObj.userid = this.tt_nd.user_neo
          inputObj.ma_hd = this.dsHDKH[0]['ma_gd']
          inputObj.ma_kh = matt_neo
          inputObj.ma_cq = ''
          inputObj.coquan = this.dsHDKH[0]['ten_kh']
          inputObj.nguoi_dai_dien = this.dsHDKH[0]['nguoi_dd']
          inputObj.chuc_danh = this.dsHDKH[0]['chucdanh_dd']
          inputObj.dienthoai_lh = this.dsHDKH[0]['so_dt']

          inputObj.quan_id = apidata['QUAN_ID']

          inputObj.phuong_id = apidata['PHUONG_ID']

          inputObj.pho_id = apidata['PHO_ID']
          inputObj.so_nha = this.diachiKH.SONHA
          inputObj.dia_chi_ct = this.dsHDKH[0]['diachi_kh']

          inputObj.dia_chi_tt = this.dsHDTT[0]['diachi_tt']
          inputObj.quan_tt = apidata['QUANTT_ID']
          inputObj.phuongtt_id = apidata['PHUONGTT_ID']
          inputObj.phott_id = apidata['PHOTT_ID']
          inputObj.so_nha_tt = this.diachiTT.SONHA

          inputObj.so_giay_to = this.dsHDKH[0]['so_gt']
          inputObj.ngay_cap_giay_to = this.dsHDKH[0]['ngaycap']
          inputObj.noi_cap_giay_to = this.dsHDKH[0]['noicap']
          inputObj.loaigt_id = apidata['LOAIGT_ID']

          inputObj.ngay_sinh = this.dsHDKH[0]['ngay_sn']
          if (this.dsHDKH[0]['gioitinh'])
            // vuth update 23/12
            inputObj.gender = this.dsHDKH[0]['gioitinh'] == '0' ? '0' : '1'
          if (!this.dsHDKH[0]['matb_dd']) inputObj.sodaidien = this.dsHDKH[0]['ma_tb']
          else inputObj.sodaidien = this.dsHDKH[0]['matb_dd']

          inputObj.loai_kh = apidata['LOAI_KH']

          inputObj.khach_hang_lon = apidata['KHLON_ID_NEO']
          if (inputObj.khach_hang_lon == -1) inputObj.khach_hang_lon = 1 // loai kh lon ko can vuth update 1405
          inputObj.nganhnghe = apidata['NGANHNGHE']
          inputObj.uutien = '0'

          inputObj.dangky_db_0_1 = '0'
          for (var dvk of this.dsDK_DVKHAC)
            if ([1, 7].indexOf(dvk['dvkhac_id'] * 1) >= 0) {
              inputObj.dangky_db_0_1 = '1'
              break
            }

          inputObj.dangky_tv_0_1 = '0'

          inputObj.dia_diem_tt = apidata['DIADIEM_TT_ID']

          inputObj.ma_bc = apidata['MA_BC']

          inputObj.ten_tt = this.dsHDTT[0]['ten_tt']

          inputObj.ms_thue = this.dsHDTT[0]['mst']
          //inputObj.ngan_hang_id = "";
          //04/05/2020 fix giup Vu-HTH
          if (this.dsHDTT[0]['nganhang_id'] && apidata['NGAN_HANG_ID']) inputObj.ngan_hang_id = apidata['NGAN_HANG_ID']
          inputObj.tai_khoan = this.dsHDTT[0]['stk']
          inputObj.ngay_lap_hd = this.dsHDKH[0]['ngay_yc']
          inputObj.ghichu = this.dsHDTT[0]['ghichu']

          inputObj.userid = this.tt_nd.user_neo

          //Lấy id đơn vị quản lý map với CCBS. Ưu tiên lấy id ttkd, nếu ko có thì lấy id của đơn vị ql địa chỉ tt
          inputObj.donvi_ql_id = apidata['DONVI_QL_ID']
          if (inputObj.donvi_ql_id == '-1') {
            inputObj.donvi_ql_id = ''
          }

          //Nhân viên thu cước
          inputObj.ma_nv = apidata['MA_NV']
          if (inputObj.ma_nv == '-1') return 'chưa có dữ liệu manv_vnp trong bảng nhanvien_vnp ứng với ma_nv = ' + this.thanhtoan.manvtc
          //23072020
          else {
            //Nếu là HCM thì mã nv thu cước VNP cộng thêm H
            //if (tt_nd.tentat.ToUpper() == "HCM")
            if (this.tt_nd.tentat_ccbs == 'HCM') {
              // Khong co tentat, chi co ccbs va vasc
              inputObj.ma_nv += 'H'
            }
          }
          inputObj.email = this.thuebao.didong.txtEmailDD

          inputObj.khachang_rui_ro_0_1 = '0'
          inputObj.so_giay_to1 = ''
          inputObj.ngay_cap1 = ''
          inputObj.noi_cap1 = ''
          inputObj.loai_giay_to1 = '1'
          inputObj.chuyen_khoan_id = ''
          inputObj.ky_ten = ''
          var ma_hrm_ctv = ''
          if (this.ctv_id > 0) {
            ma_hrm_ctv = apidata['MA_HRM_CTV']
          }
          inputObj.nguoi_gioi_thieu = ma_hrm_ctv

          inputObj.ma_tuyen = '' //Mã tuyến có thể để trống
          inputObj.thong_tin_tuyen = ''
          inputObj.ma_qhns = ''
          inputObj.ma_tinh = this.tt_nd.tentat_ccbs

          var rs = {} //new CCBSFacade().TS_LAPHD_HOAMANGMOI_LAPHD(inputObj);
          await API.post_ts_laphd_hoamangmoi_laphd(this.axios, inputObj).then(async (response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              rs = response.data.data;
              if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed == null) rs.IssSuccessed = true;
            }
            rs.Message = response.data.message;
          })
          //#region log goi api ccbs
          var log_action = 'frmDatMoi.TS_LAPHD_HOAMANGMOI_LAPHD'
          var log_param = `ma_hd_neo=${inputObj.ma_hd}; ma_kh = ${inputObj.ma_kh};user_neo=${inputObj.userid}`
          var log_note = `giá trị trả về từ api: result.IsSucceed=${rs.IssSuccessed}; result.Message=${rs.Message}`
          try {
            await API.post_log_action(this.axios, {
              vphanvung_id: this.$root.token.getPhanVungID(),
              vuser_name: this.$root.token.getUserName(),
              vcomputer_name: this.$root.token.getIP(),
              vaction_name: log_action,
              vkey_parameter: log_param,
              vserver_name: this.$root.token.getMachine(),
              vnote: log_note,
              PROCEDURE_NAME: 'ADMIN.QUANTRI_HETHONG.Log_Action'
            }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              }
            })
            //  DataAccess.LogActions.LogAction(log_action, log_param, log_note);
          } catch (ex) {
            this.$toast.error('Ghi log lên server that bai, log len local log/logfile: ' + log_action + ' ' + log_param + ' ' + log_note)
          }
          //#endregion
          if (!rs.IssSuccessed) return 'Lỗi xảy ra trong quá trình thêm mới hợp đồng di động lên Vinaphone.' + rs.Message
        } catch (ex) {
          return 'Lỗi xảy ra trong quá trình thêm mới hợp đồng di động lên Vinaphone.' + ex
        }
        this.$toast.success(`Tạo mới hợp đồng hòa mạng ${this.dsHDKH[0]['ma_gd']} trên VinaPhone thành công!`)
        //#endregion
      }

      return 'OK'
    },
    async Insert_TBLD_VinaPhone() {
      var defNull = ''
      var apidata = {}
      var pdata = {
        KIEULD_ID: this.listbox.kieu_ld.value,
        QUANTT_ID: this.diachiTT.QUAN_ID,
        PHUONGTT_ID: this.diachiTT.PHUONG_ID,
        PHOTT_ID: this.diachiTT.PHO_ID,
        QUANLD_ID: this.diachiLD.QUAN_ID,
        PHUONGLD_ID: this.diachiLD.PHUONG_ID,
        DONVI_TT_ID: this.dsHDTT[0]['donvi_id'],
        GOICUOC_ID: this.dsHDTB_DD[0]['goicuoc_id'],
        HTTT_ID: this.dsHDTT[0]['httt_id'],
        LOAIGT_ID: this.dsHDKH[0]['loaigt_id'],
        QUOCTICH_ID: this.listbox.quoctich.value,
        MA_NVTV: this.thanhtoan.manvtc,
        MA_TT: this.dsHDTT[0]['ma_tt'],
        QUANKH_ID: this.diachiKH.QUAN_ID,
        PHUONGKH_ID: this.diachiKH.PHUONG_ID,
        PHOKH_ID: this.diachiKH.PHO_ID,
        TNC2_ID: this.dsHDKH[0]['tnc2_id'],
        NGANHANG_ID: this.dsHDTT[0]['nganhang_id'],
        CTV_ID: this.ctv_id,
        LOAIKH_ID: this.dsHDKH[0]['loaikh_id']
      }
      API.post_fn_lay_tt_ins_tbld_vnp(this.axios, {
        ds_para: JSON.stringify(pdata)
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code == 'BSS-00000000' && response.data.data != 1) {
          apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            defNull = apidata['MESSAGE']
            return
          }
          apidata = apidata['RESULT']
        }
      })
      if (defNull && defNull != '') return defNull

      var thangcamket = this.thuebao.thangck
      if (!thangcamket) {
        return 'Số tháng cam kết không được để trống'
      }
      if (!([12, 24].indexOf(thangcamket * 1) >= 0)) return 'Số tháng cam kết phải là 12 hoặc 24 tháng'

      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      var status = false
      try {
        var inputObj = {}

        if (!this.tt_nd.user_neo) return 'Thông tin người dùng chưa đồng bộ với dữ liệu VinaPhone. Bạn không thể tiếp tục cập nhật dữ liệu.'

        //Lấy id đơn vị quản lý map với CCBS. Ưu tiên lấy id ttkd, nếu ko có thì lấy id của đơn vị ql địa chỉ tt
        inputObj.donv_ql_id = apidata['DONVI_QL_ID']
        if (inputObj.donv_ql_id == '-1') inputObj.donv_ql_id = ''

        inputObj.so_nha = this.diachiTB.SONHA
        inputObj.thutu_in = '1'
        inputObj.so_sim = this.dsHDTB_DD[0]['simcard']
        inputObj.so_tb = '84' + this.dsHDTB[0]['ma_tb']

        inputObj.ma_bc = apidata['MA_BC']

        inputObj.donvitc_id = inputObj.donv_ql_id

        inputObj.tra_cuu_trong_db_0_1 = '1'
        inputObj.giapdanh = '1'
        inputObj.dangky_db_0_1 = '0'

        for (var i = 0; i < this.dsDK_DVKHAC.length; i++) {
          if (this.dsDK_DVKHAC[i]['dvkhac_id'] == 1 || this.dsDK_DVKHAC[i]['dvkhac_id'] == 7) {
            inputObj.dangky_db_0_1 = '1'
            break
          }
        }

        inputObj.ten_tb = this.dsHDTB[0]['ten_tb']
        inputObj.thuebao_id = ''
        inputObj.ma_hd = this.dsHDKH.length > 0 ? this.dsHDKH[0]['ma_gd'] : this.khachhang.magd.trim()
        inputObj.dia_chi = this.dsHDTB[0]['diachi_tb']
        inputObj.loaitb_id = apidata['LOAITB_ID']

        if (this.thuebao.didong.cboDTVinaPhone.list.length > 0) inputObj.doituong_id = this.thuebao.didong.cboDTVinaPhone.value
        if (!inputObj.doituong_id) inputObj.doituong_id = '1'

        for (var dr of this.ds_tien_khoanmuc) {
          if (dr['khoanmuctt_id'] == KHOANMUC_TT.KMTT_HOAMANG_DD_TRASAU) {
            inputObj.cuoc_ld = dr['tien']
            inputObj.vat_ld = dr['vat']
            break
          }
        }
        var dtTienCCBS = await this.LayTienSoDepDDTraSau('84' + this.thuebao.didong.txtSoMayDD.trim())
        inputObj.cuoc_dv = dtTienCCBS[0]['tiendv'] //"0";
        inputObj.vat_dv = dtTienCCBS[0]['tiendvvat'] //(Convert.ToDecimal(inputObj.cuoc_dv) * (decimal)0.1).ToString();

        inputObj.cuoc_ld = dtTienCCBS[0]['giatien']
        inputObj.vat_ld = dtTienCCBS[0]['vat']
        inputObj.loaidb_id = '0'
        inputObj.inchitiet = '0'

        for (var i = 0; i < this.dsDK_DVKHAC.length; i++) {
          if (this.dsDK_DVKHAC[i]['dvkhac_id'] == 2 || this.dsDK_DVKHAC[i]['dvkhac_id'] == 3 || this.dsDK_DVKHAC[i]['dvkhac_id'] == 5) {
            inputObj.inchitiet = '1'
            break
          }
        }
        inputObj.chungloai_id = ''
        inputObj.tienmay = '0'
        inputObj.vat_may = '0'
        inputObj.ghichu = this.dsHDTB[0]['ghichu']

        inputObj.quan_id = apidata['QUAN_ID']
        inputObj.phuong_id = apidata['PHUONG_ID']
        inputObj.pho_id = apidata['PHO_ID']

        inputObj.kieu_ld_id = apidata['KIEULD_ID']
        inputObj.loai_kh = apidata['LOAIKH_ID_NEO']

        inputObj.donvild_id = ''

        if (this.dsKM_HDTB.length > 0) inputObj.khuyenmai_id = this.dsKM_HDTB[0]['khuyenmai_id_neo']
        inputObj.tien_km = '0'
        inputObj.loai_dc_bao_cuoc = '0'
        inputObj.kieu_bao_cuoc = '0'
        inputObj.ma_bao_cuoc = '0'
        inputObj.ngay_sinh = this.dsHDTB[0]['ngay_sn']
        inputObj.kh_doanhnghiep_0_1 = ''

        inputObj.thangcamket = this.thuebao.thangck
        if (!inputObj.thangcamket) return 'Số tháng cam kết không được để trống'
        if (!([12, 24].indexOf(inputObj.thangcamket) >= 0)) return 'Số tháng cam kết phải là 12 hoặc 24 tháng'

        inputObj.ma_tinh = this.tt_nd.tentat_ccbs
        //#region vuth update 0912
        if (this.tt_nd.tentat_ccbs == 'HCM')
          // Khong co tentat, chi co ccbs va vasc
          inputObj.tach_ma = '1'
        else inputObj.tach_ma = '0'
        //#endregion
        inputObj.userid = this.tt_nd.user_neo

        //Edit 20230820 - ThangDM1 - Them theo yeu cau cua CCBS
        inputObj.so_giay_to = this.khachhang.sogt;
        inputObj.loai_giay_to = this.listbox.loai_gt.list.find(x=>x.loaigt_id==this.listbox.loai_gt.value) && this.listbox.loai_gt.list.find(x=>x.loaigt_id==this.listbox.loai_gt.value).loaigt_id_neo?this.listbox.loai_gt.list.find(x=>x.loaigt_id==this.listbox.loai_gt.value).loaigt_id_neo:this.listbox.loai_gt.value;
        inputObj.noi_cap = this.khachhang.noicap;
        inputObj.ngay_cap = this.NgayCap;
        //Edit 20230820 - ThangDM1 - Them theo yeu cau cua CCBS - END
        //inputObj.cuoc_ld = "0"; //vuth update 1505
        //inputObj.vat_ld = "0";
        /////////////////////start tuanla đẹp trai thêm cho MNP/////////////////////
        if (this.listbox.nhacc_cu.ischecked && this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG && this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRASAU) {
          var inputObj_mnp = {}
          inputObj_mnp.bill_limit = inputObj.bill_limit
          inputObj_mnp.chungloai_id = inputObj.chungloai_id
          inputObj_mnp.congvan = inputObj.congvan
          inputObj_mnp.cuoc_dv = inputObj.cuoc_dv
          inputObj_mnp.cuoc_ld = '0'
          inputObj_mnp.dangky_db_0_1 = inputObj.dangky_db_0_1
          inputObj_mnp.dia_chi = inputObj.dia_chi
          inputObj_mnp.dia_chi_thuongtru = inputObj.dia_chi_thuongtru
          inputObj_mnp.doi_tuong_su_dung = inputObj.doi_tuong_su_dung
          inputObj_mnp.doituong_id = inputObj.doituong_id
          inputObj_mnp.donv_ql_id = inputObj.donv_ql_id
          inputObj_mnp.donvild_id = inputObj.donvild_id
          inputObj_mnp.donvitc_id = inputObj.donvitc_id
          inputObj_mnp.dslk = inputObj.dslk
          inputObj_mnp.dssllk = inputObj.dssllk
          inputObj_mnp.dstenlk = inputObj.dstenlk
          inputObj_mnp.email = inputObj.email
          inputObj_mnp.ghichu = inputObj.ghichu
          inputObj_mnp.giapdanh = inputObj.giapdanh
          inputObj_mnp.imei = inputObj.imei
          inputObj_mnp.inchitiet = inputObj.inchitiet
          inputObj_mnp.kh_doanhnghiep_0_1 = inputObj.kh_doanhnghiep_0_1
          inputObj_mnp.khuyenmai_id = inputObj.khuyenmai_id
          inputObj_mnp.kieu_bao_cuoc = inputObj.kieu_bao_cuoc
          inputObj_mnp.kieu_ld_id = inputObj.kieu_ld_id
          inputObj_mnp.loai_dc_bao_cuoc = inputObj.loai_dc_bao_cuoc
          inputObj_mnp.loai_giay_to = inputObj.loai_giay_to
          inputObj_mnp.loai_goi = inputObj.loai_goi
          inputObj_mnp.loai_goi_dk = inputObj.loai_goi_dk
          inputObj_mnp.loai_kh = inputObj.loai_kh
          inputObj_mnp.loaidb_id = inputObj.loaidb_id
          inputObj_mnp.loaitb_id = inputObj.loaitb_id
          inputObj_mnp.ma_bao_cuoc = inputObj.ma_bao_cuoc
          inputObj_mnp.ma_bc = inputObj.ma_bc
          inputObj_mnp.ma_hd = inputObj.ma_hd
          inputObj_mnp.ma_tinh = inputObj.ma_tinh
          inputObj_mnp.month_live = inputObj.month_live
          inputObj_mnp.ngay_cap = inputObj.ngay_cap
          inputObj_mnp.ngay_sinh = inputObj.ngay_sinh
          inputObj_mnp.nhom_mb_vnn = inputObj.nhom_mb_vnn
          inputObj_mnp.noi_cap = inputObj.noi_cap
          inputObj_mnp.pho_id = inputObj.pho_id
          inputObj_mnp.phuong_id = inputObj.phuong_id
          inputObj_mnp.quan_id = inputObj.quan_id
          inputObj_mnp.quoc_tich = inputObj.quoc_tich
          inputObj_mnp.serial = inputObj.serial
          inputObj_mnp.so_giay_to = inputObj.so_giay_to
          inputObj_mnp.so_nha = inputObj.so_nha
          inputObj_mnp.so_sim = inputObj.so_sim
          inputObj_mnp.so_tb = inputObj.so_tb
          inputObj_mnp.tbnhantk = inputObj.tbnhantk
          inputObj_mnp.ten_tb = inputObj.ten_tb
          inputObj_mnp.thangcamket = inputObj.thangcamket
          inputObj_mnp.thuebao_id = inputObj.thuebao_id
          inputObj_mnp.thutu_in = inputObj.thutu_in
          inputObj_mnp.tien_km = inputObj.tien_km
          inputObj_mnp.tienmay = inputObj.tienmay
          inputObj_mnp.tra_cuu_trong_db_0_1 = inputObj.tra_cuu_trong_db_0_1
          inputObj_mnp.upload = inputObj.upload
          inputObj_mnp.userid = inputObj.userid
          inputObj_mnp.vat_dv = inputObj.vat_dv
          inputObj_mnp.vat_ld = '0'
          inputObj_mnp.vat_may = inputObj.vat_may
          inputObj_mnp.tach_ma = inputObj.tach_ma
          var rs = {} //new CCBSFacade().ts_laphd_hoamangmoi_themtb_mnp(inputObj_mnp);
          await API.ts_laphd_hoamangmoi_themtb_mnp(this.axios, inputObj_mnp).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code == 'BSS-00000000' && response.data.data != 1) {
              rs = response.data.data
              if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;
            }
            rs.Message = response.data.message;
          })
          if (!rs.IssSuccessed) return rs.Message
        } else {
          var rs = {} //new CCBSFacade().TS_LAPHD_HOAMANGMOI_THEMTHUEBAO(inputObj);
          //FIXME api nay chua co, dang trao doi voi Ngoc
          await API.ts_laphd_hoamangmoi_themthuebao(this.axios, inputObj).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code == 'BSS-00000000' && response.data.data != 1) {
              rs = response.data.data
              if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;
            }
            rs.Message = response.data.message;
          })
          // #region log api trả về từ ccbs
          var log_action = 'frmDatMoi.TS_LAPHD_HOAMANGMOI_THEMTHUEBAO '
          var log_param = `ma_hd_neo=${inputObj.ma_hd};so_tb=${inputObj.so_tb};user_neo=${inputObj.userid}`
          var log_note = `giá trị trả về từ api: result.IsSucceed=${rs.IssSuccessed}; result.Message=${rs.Message}`
          try {
            await API.post_log_action(this.axios, {
              vphanvung_id: this.$root.token.getPhanVungID(),
              vuser_name: this.$root.token.getUserName(),
              vcomputer_name: this.$root.token.getIP(),
              vaction_name: log_action,
              vkey_parameter: log_param,
              vserver_name: this.$root.token.getMachine(),
              vnote: log_note,
              PROCEDURE_NAME: 'ADMIN.QUANTRI_HETHONG.Log_Action'
            }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              }
            })
            // DataAccess.LogActions.LogAction(log_action, log_param, log_note);
          } catch (ex) {
            this.$toast.error('Ghi log lên server that bai, log len local log/logfile: ' + log_action + ' ' + log_param + ' ' + log_note)
          }
          // #endregion

          if (!rs.IssSuccessed) return rs.Message
        }
        ////////////////////end tuanla thêm MNP/////////////////////
      } catch (ex) {
        //FIXME 2 cai nay tam thoi chua dung den, comment lai
        // status = false;
        // strError_VinaPhone = ex;
        return 'Tạo hợp đồng CCBS thất bại: ' + ex // Khải nhờ Hoàng thêm dòng này 10/11/2020
      }
      this.$toast.success(`Thêm thuê bao ${this.dsHDTB[0]['ma_tb']} trên VinaPhone thành công!`)
      return 'OK'
    },
    async LayTienSoDepDDTraSau(somay) {
      try {
        var dtTienCcbs = [] //new CCBSFacade().ts_laphd_hoamangmoi_layds_cuocld(tt_nd.tentat_ccbs, "1", somay, tt_nd.USER_NEO);
        await API.post_ts_laphd_hoamangmoi_layds_cuocld(this.axios, {
          ma_tinh: this.tt_nd.tentat_ccbs,
          kieuld_id: '1',
          so_tb: somay,
          userid: this.tt_nd.user_neo
        }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            dtTienCcbs = response.data.data
            dtTienCcbs = this.LowerCasePropertyList(dtTienCcbs)
          }
        })
        if (dtTienCcbs == null || dtTienCcbs.length == 0 || !dtTienCcbs[0]['tiendv'] || !dtTienCcbs[0]['tiendvvat']) {
          throw 'Có lỗi lấy tiến số đẹp từ ccbs: ts_laphd_hoamangmoi_layds_cuocld'
        }
        return dtTienCcbs
      } catch (ex) {
        this.$toast.error('Có lỗi lấy tiến số đẹp từ ccbs: ts_laphd_hoamangmoi_layds_cuocld')
        throw ex
      }
    },
    async Delete_HDLD_VinaPhone(ma_gd) {
      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      try {
        if (!this.tt_nd.user_neo) return 'Thông tin người dùng chưa đồng bộ với dữ liệu VinaPhone. Bạn không thể tiếp tục cập nhật dữ liệu.'

        var rs = {} //new CCBSFacade().TS_LAPHD_HOAMANGMOI_XOA(this.tt_nd.tentat_ccbs.toUpperCase(), ma_gd, this.tt_nd.user_neo, "");
        await API.post_ts_laphd_hoamangmoi_xoa(this.axios, {
          ma_tinh: this.tt_nd.tentat_ccbs,
          ma_hd: ma_gd,
          rowid: '',
          userid: this.tt_nd.user_neo
        }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            rs = response.data.data
            if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;
          }
          rs.Message = response.data.message;
        })
        if (!rs.IssSuccessed) return 'Có lỗi xảy ra trong quá trình xóa hợp đồng thuê bao di động trên VinaPhone.\n' + rs.Message
      } catch (ex) {
        return ex + ''
      }
      this.$toast.success(`Xóa hợp đồng ${ma_gd} trên VinaPhone thành công!`)
      return 'OK'
    },
    async Update_HDLD_VinaPhone() {
      var kt_dulieu_vina = 0 // FIXME de tam, day la bien global
      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      var defNull = 'Phải chọn loại thuê bao di động trả sau'
      if (!this.listbox.dichvu_vt.value || this.listbox.dichvu_vt.value != DichVuVienThong.DI_DONG) return defNull
      if (!this.listbox.loaihinh_tb.value || this.listbox.loaihinh_tb.value != LoaiHinhTB.DIDONGTRASAU) return defNull

      var pdata = {
        MA_TT: this.dsHDTT[0]['ma_tt'],
        QUANKH_ID: this.diachiKH.QUAN_ID,
        PHUONGKH_ID: this.diachiKH.PHUONG_ID,
        PHOKH_ID: this.diachiKH.PHO_ID,
        DONVI_TT_ID: this.dsHDTT[0]['donvi_id'],
        QUANTT_ID: this.diachiTT.QUAN_ID,
        PHUONGTT_ID: this.diachiTT.PHUONG_ID,
        PHOTT_ID: this.diachiTT.PHO_ID,
        LOAIKH_ID: this.dsHDKH[0]['loaikh_id'],
        TNC2_ID: this.dsHDKH[0]['tnc2_id'],
        LOAIGT_ID: this.dsHDKH[0]['loaigt_id'],
        HTTT_ID: this.dsHDTT[0]['httt_id'],
        NGANHANG_ID: this.dsHDTT[0]['nganhang_id']
      }
      var apidata = {}
      await API.post_fn_lay_tt_update_hdld_vnp(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            defNull = apidata['MESSAGE']
            kt_dulieu_vina = 1
            return
          }
          apidata = apidata['RESULT']
        }
      })
      if (kt_dulieu_vina == 1) return defNull

      try {
        if (!(this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG && this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRASAU)) {
          return 'Thuê bao không phải là di động trả sau. Không được phép đồng bộ lên CCBS.'
        }

        var inputObj = {}

        inputObj.ma_tinh = this.tt_nd.tentat_ccbs
        inputObj.userid = this.tt_nd.user_neo
        inputObj.ma_hd = this.dsHDKH[0]['ma_gd']
        // vuth update 1405
        inputObj.ma_kh = apidata['MA_KH']
        inputObj.ma_cq = ''

        inputObj.chuc_danh = this.HDKH[0]['chucdanh_dd']
        inputObj.nguoi_dai_dien = this.HDKH[0]['nguoi_dd']
        inputObj.sonha_tt = sonhatt
        inputObj.may_cn = this.tt_nd.may_cn
        inputObj.uutien_id = '0'
        inputObj.mst = this.HDTT[0]['mst']
        inputObj.tai_khoan = this.HDTT[0]['stk']
        inputObj.dichvuvt_id = '2'
        inputObj.phai = this.HDKH[0]['gioitinh'] == '0' ? '0' : '1'
        inputObj.ghi_chu = this.HDTT[0]['ghichu']

        inputObj.quan_id = apidata['QUAN_ID']

        //Lấy id đơn vị quản lý map với CCBS. Ưu tiên lấy id ttkd, nếu ko có thì lấy id của đơn vị ql địa chỉ tt
        inputObj.donviql_id = apidata['DONVI_QL_ID']
        if (inputObj.donviql_id == '-1') inputObj.donviql_id = ''

        inputObj.tttuyen = this.thanhtoan.matuyen

        inputObj.quantt_id = apidata['QUANTT_ID']
        inputObj.sonha_tt = this.diachiTT.SONHA

        inputObj.so_gt_1 = ''

        inputObj.phott_id = apidata['PHOTT_ID']

        inputObj.noicap_gt = this.HDKH[0]['noicap']

        if (!this.HDTT[0]['matb_dd']) inputObj.so_daidien = this.HDTB[0]['ma_tb']
        else inputObj.so_daidien = this.HDTT[0]['matb_dd']

        inputObj.so_gt = this.HDKH[0]['so_gt']
        inputObj.ma_t = ''

        inputObj.coquan = this.HDKH[0]['ten_kh']
        inputObj.nguoi_dai_dien = this.HDKH[0]['nguoi_dd']
        inputObj.dienthoai_ld = this.HDKH[0]['so_dt']
        inputObj.quan_id = apidata['QUAN_ID'] // dang thieu o DB, da nho bo sung.
        inputObj.phuong_id = apidata['PHUONG_ID']
        inputObj.pho_id = apidata['PHO_ID'] // dang bi sai ten o DB la PHOTT_ID
        inputObj.so_nha = this.diachiKH.SONHA
        inputObj.diachi_ct = this.HDKH[0]['diachi_kh']
        inputObj.so_gt = this.HDKH[0]['so_gt']

        inputObj.ngaycap_gt = this.dsHDKH[0]['ngaycap']
        inputObj.noicap_gt = this.HDKH[0]['noicap']
        inputObj.loaigt_id = apidata['LOAIGT_ID']
        inputObj.ngay_sinh = this.dsHDKH[0]['ngay_sn']
        inputObj.dichvuvt_id = '2'
        inputObj.kieu_ld = ''
        if (!this.HDTT[0]['matb_dd']) inputObj.so_daidien = this.HDTB[0]['ma_tb']
        else inputObj.so_daidien = this.HDTT[0]['matb_dd']
        inputObj.loaikh_id = apidata['LOAIKH_ID']
        inputObj.khlon_id = this.HDKH[0]['khlon_id']
        inputObj.nganhnghe_id = apidata['NGANHNGHE']
        inputObj.uutien_id = '0'
        inputObj.dangky_db = '0'

        for (var i = 0; i < this.dsDK_DVKHAC.length; i++) {
          if (this.dsDK_DVKHAC[0]['dvkhac_id'] == 1 || this.dsDK_DVKHAC[0]['dvkhac_id'] == 7) {
            inputObj.dangky_db = '1'
            break
          }
        }
        inputObj.dangky_tv = '0'
        inputObj.diadiemtt_id = apidata['DIADIEM_TT_ID']

        inputObj.ma_bc = apidata['MA_BC']

        inputObj.ten_tt = this.HDTT[0]['ten_tt']

        inputObj.diachi_tt = this.HDTT[0]['diachi_tt']
        inputObj.quantt_id = apidata['QUANTT_ID']
        inputObj.phuongtt_id = apidata['PHUONGTT_ID']
        inputObj.phott_id = apidata['PHOTT_ID']
        inputObj.sonha_tt = this.diachiTT.SONHA
        inputObj.mst = this.HDTT[0]['mst']
        inputObj.nganhang_id = ''
        if (this.dsHDTT[0]['nganhang_id'])
          // vuth update 1405
          inputObj.nganhang_id = apidata['NGAN_HANG_ID']
        inputObj.tai_khoan = this.HDTT[0]['stk']
        inputObj.ngay_laphd = this.dsHDKH[0]['ngay_yc']
        inputObj.ghi_chu = this.HDTT[0]['ghichu']
        inputObj.nguoi_cn = this.$root.token.getNguoiDungID()
        inputObj.may_cn = this.tt_nd.may_cn

        var rs = {} //new CCBSFacade().TS_LAPHD_HOAMANGMOI_CAPNHAT(inputObj);
        await API.post_ts_laphd_hoamangmoi_capnhat(this.axios, inputObj).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            rs = response.data.data
            if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;
          }
          rs.Message = response.data.message;
        })
        if (!rs.IssSuccessed) return 'Có lỗi xảy ra trong quá trình kết nối với Sercvice VinaPhone!\n' + rs.Message
      } catch (ex) {
        return 'Có lỗi xảy ra trong quá trình kết nối với Sercvice VinaPhone!\n' + ex
      }
      this.$toast.success(`Cập nhật hợp đồng hòa mạng mới ${this.dsHDKH[0]['ma_gd']} lên VinaPhone thành công!`)
      return 'OK'
    },
    async Update_TBLD_VinaPhone() {
      var defNull = ''
      var apidata = {}

      var pdata = {
        DONVI_TT_ID: this.dsHDTT[0]['donvi_id'],
        GOICUOC_ID: this.dsHDTB_DD[0]['goicuoc_id'],
        QUANTB_ID: this.diachiTB.QUAN_ID,
        PHUONGTB_ID: this.diachiTB.PHUONG_ID,
        PHOTB_ID: this.diachiTB.PHO_ID,
        KIEULD_ID: this.listbox.kieu_ld.value,
        LOAIKH_ID: this.dsHDKH[0]['loaikh_id'],
        HDKH_ID: this.khachhang.hdkh_id,
        QUOCTICH_ID: this.listbox.quoctich.value
      }
      API.post_fn_lay_tt_update_tbld_vnp(this.axios, {
        ds_para: JSON.stringify(pdata)
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code == 'BSS-00000000' && response.data.data != 1) {
          apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            defNull = apidata['MESSAGE']
            return
          }
          apidata = apidata['RESULT']
        }
      })
      if (defNull && defNull != '') return defNull

      var thangcamket = this.thuebao.thangck
      if (!thangcamket) return 'Số tháng cam kết không được để trống'
      if (!([12, 24].indexOf(thangcamket * 1) >= 0)) return 'Số tháng cam kết phải là 12 hoặc 24 tháng'

      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      var status = false
      try {
        var inputObj = {}

        if (!this.tt_nd.user_neo) return 'Thông tin người dùng chưa đồng bộ với dữ liệu VinaPhone. Bạn không thể tiếp tục cập nhật dữ liệu.'

        inputObj.ma_tinh = this.tt_nd.tentat_ccbs
        inputObj.userid = this.tt_nd.user_neo
        inputObj.ma_hd = this.HDKH[0]['ma_gd']

        //Lấy id đơn vị quản lý map với CCBS. Ưu tiên lấy id ttkd, nếu ko có thì lấy id của đơn vị ql địa chỉ tt
        inputObj.donv_ql_id = apidata['DONVI_QL_ID']
        if (inputObj.donv_ql_id == '-1') inputObj.donv_ql_id = ''

        inputObj.so_nha = this.diachiTB.SONHA
        inputObj.thutu_in = '1'
        inputObj.so_sim = this.HDTB_DD[0]['simcard']
        inputObj.so_tb = '84' + this.HDTB[0]['ma_tb']

        inputObj.ma_bc = apidata['MA_BC']

        inputObj.tra_cuu_trong_db_0_1 = '1'
        var PICUOCNH_ID = '0'
        inputObj.khuyenmai_id = '0'
        inputObj.dangky_db_0_1 = '0'
        for (var i = 0; i < this.dsDK_DVKHAC.length; i++) {
          if (this.dsDK_DVKHAC[0]['dvkhac_id'] == 1 || this.dsDK_DVKHAC[0]['dvkhac_id'] == 7) {
            inputObj.dangky_db_0_1 = '1'
            break
          }
        }
        inputObj.ten_tb = this.HDTB[0]['ten_tb']
        inputObj.tramvt = '1'

        var rsTb = '' //new CCBSFacade().LAY_THUEBAO_ID_NEO(tt_nd.tentat_ccbs, inputObj.ma_hd, inputObj.so_tb);
        rsTb = await API.post_ts_laphd_hoamangmoi_lay_ds_thuebao(this.axios, {
          ma_tinh: this.tt_nd.tentat_ccbs,
          ma_hd: inputObj.ma_hd
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code == 'BSS-00000000' && response.data.data != 1) {
            var ds = response.data.data
            for (var item of ds) if (item['MA_TB'] == inputObj.so_tb) return item['THUEBAO_ID']
            return ''
          }
        })
        //if (!rsTb.IsLong())
        if (!rsTb) {
          // FIXME cho nay can kiem tra kieu du lieu = long, nhung chua biet data CCBS tra ve nhu the nao???
          return rsTb
        } else {
          inputObj.thuebao_id = rsTb
        }

        inputObj.dia_chi = this.HDTB[0]['diachi_tb']
        inputObj.loaitb_id = apidata['LOAITB_ID']

        inputObj.doituong_id = ''
        // bien doituong_vinaphone thay o code cu co khai bao private nhung ko dung, bo qua
        // if (doituong_vinaphone)
        //     inputObj.doituong_id = doituong_vinaphone;
        // else
        // {
        if (this.thuebao.didong.cboDTVinaPhone.length > 0) {
          inputObj.doituong_id = this.thuebao.didong.cboDTVinaPhone.value
        }
        // }
        if (!inputObj.doituong_id) inputObj.doituong_id = '1'

        for (var dr of this.ds_tien_khoanmuc) {
          if (dr['khoanmuctt_id'] == KHOANMUC_TT.KMTT_HOAMANG_DD_TRASAU) {
            inputObj.cuoc_ld = dr['tien']
            inputObj.vat_ld = dr['vat']
            break
          }
        }
        // vuth update 23/12 them cuoc_ld, vat_ld
        if (!inputObj.cuoc_ld) inputObj.cuoc_ld = '0'
        if (!inputObj.vat_ld) inputObj.vat_ld = '0'
        inputObj.cuoc_dv = '0'
        inputObj.vat_dv = inputObj.cuoc_dv * 0.1 //==10%*tiendv

        inputObj.inchitiet = '0' //
        for (var i = 0; i < this.dsDK_DVKHAC.length; i++) {
          if (this.dsDK_DVKHAC[0]['dvkhac_id'] == 2 || this.dsDK_DVKHAC[0]['dvkhac_id'] == 3 || this.dsDK_DVKHAC[0]['dvkhac_id'] == 5) {
            inputObj.inchitiet = '1'
            break
          }
        }
        inputObj.chungloai_id = '0'
        inputObj.tienmay = '0'
        inputObj.vat_may = '0'
        inputObj.ghichu = this.HDTB[0]['ghichu']

        inputObj.quan_id = apidata['QUAN_ID']
        inputObj.phuong_id = apidata['PHUONG_ID']
        inputObj.pho_id = apidata['PHO_ID']

        inputObj.kieu_ld_id = apidata['KIEULD_ID']
        inputObj.dsdichvu = ''
        inputObj.loai_kh = apidata['LOAIKH_ID']
        inputObj.donvild_id = '' // vuth update 0912

        inputObj.khuyenmai_id = ''
        if (this.dsKM_HDTB.length > 0) inputObj.khuyenmai_id = this.dsKM_HDTB[0]['khuyenmai_id_neo']
        inputObj.tien_km = '0'
        inputObj.loai_dc_bao_cuoc = '0'
        inputObj.kieu_bao_cuoc = '0'
        inputObj.ma_bao_cuoc = '0'
        inputObj.matb_cu = ''
        //#region vuth update 0912
        inputObj.ThangCamKet = this.thuebao.thangck
        inputObj.KH_DoanhNghiep = ''
        inputObj.quoctich = apidata['QUOC_TICH']
        //#endregion
        var rs = {} //new CCBSFacade().TS_LAPHD_HOAMANGMOI_CAPNHATTHUEBAO(inputObj);
        await API.post_ts_laphd_hoamangmoi_capnhatthuebao(this.axios, inputObj).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            rs = response.data.data
            if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;
          }
          rs.Message = response.data.message;
        })
        if (!rs.IssSuccessed) return 'Lỗi xảy ra khi cập nhật thuê bao lên Vinaphone.' + rs.Message
      } catch (ex) {
        //Comment 2 thong tin nay lai vi chua thay can dung den!
        // status = false;
        // strError_VinaPhone = ex.Message;
        return 'Lỗi xảy ra khi cập nhật thuê bao lên Vinaphone.' + ex
      }
      this.$toast.success(`Cập nhật thuê bao ${this.ma_tb} lên VinaPhone thành công!`)
      return 'OK'
    },
    async Update_HD_ChuyenTinh_Vinaphone() {
      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      var defNull = 'Phải chọn loại thuê bao di động trả sau'
      if (!this.listbox.dichvu_vt.value || this.listbox.dichvu_vt.value != DichVuVienThong.DI_DONG) return defNull
      if (!this.listbox.loaihinh_tb.value || this.listbox.loaihinh_tb.value != LoaiHinhTB.DIDONGTRASAU) return defNull
      var pdata = {
        QUANTT_ID: this.diachiTT.QUAN_ID,
        PHUONGTT_ID: this.diachiTT.PHUONG_ID,
        PHOTT_ID: this.diachiTT.PHO_ID,
        QUANLD_ID: this.diachiLD.QUAN_ID,
        PHUONGLD_ID: this.diachiLD.PHUONG_ID,
        DONVI_TT_ID: 1,
        NGANHANG_ID: 1,
        GOICUOC_ID: 1,
        HTTT_ID: 1,
        LOAIGT_ID: 1,
        QUOCTICH_ID: 1,
        MA_NVTC: 'ABC',
        GOICUOC_ID: 1
      }
      var apidata = {}
      await API.post_fn_lay_tt_update_hd_chuyentinh_vnp(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            defNull = apidata['MESSAGE']
            kt_dulieu_vina = 1
            return
          }
          apidata = apidata['RESULT']
        }
      })
      try {
        var thuebao_id_neo = ''
        var dt = [] //new CCBSFacade().ts_laphd_chuyentinh_laytt_tb("1", tt_nd.tentat_ccbs, "84" + CommonFunction.ChuanHoa_XML(dsHDTB.Tables[0].Rows[0]["ma_tb"].ToString()));
        await API.post_ts_laphd_chuyentinh_laytt_tb(this.axios, {
          tracuu_hd: '1',
          ma_tinh: this.tt_nd.tentat_ccbs,
          so_tb: '84' + this.dsHDTB[0]['ma_tb']
        }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            dt = response.data.data
          }
        })
        if (dt != null && dt.length > 0 && dt[0]['TRANG_THAI'] && dt[0]['THUEBAO_ID']) {
          if (dt[0]['TRANG_THAI'] != '1') {
            return 'Hợp đồng chuyển tỉnh trên vinaphone trạng thái <> 1 , không thể xóa'
          }
          thuebao_id_neo = dt[0]['THUEBAO_ID']
        } else {
          return 'Có lỗi trong khi lấy thông tin thuê bao từ vinaphone ts_laphd_chuyentinh_laytt_tb '
        }
        var inputObj = {}
        inputObj.thuebao_id = thuebao_id_neo
        inputObj.userid = this.tt_nd.user_neo
        inputObj.dia_chi_bc = this.diachiBC.DIACHI

        inputObj.quanct_id = apidata['QUANCT_ID']
        inputObj.phuongct_id = apidata['PHUONGCT_ID']
        inputObj.phoct_id = apidata['PHOCT_ID']

        inputObj.quanld = apidata['QUANLD_ID']
        inputObj.phuongld = apidata['PHUONGLD_ID']
        inputObj.phold = apidata['PHOLD_ID']

        inputObj.diachi_ct = this.HDTT[0]['diachi_tt']
        inputObj.sonhact_id = this.diachiCT.SONHA

        inputObj.quantt_id = inputObj.quanct_id
        inputObj.phuongtt_id = inputObj.phuongct_id
        inputObj.phott_id = inputObj.phoct_id
        inputObj.dia_chi_tt = inputObj.diachi_ct
        inputObj.so_nha_tt = inputObj.sonhact_id

        inputObj.mst = this.HDTT[0]['mst']
        inputObj.noi_cap = this.HDKH[0]['noicap']
        inputObj.inchitiet = '0'
        inputObj.nv_hd = ''
        inputObj.ghi_chu = ''
        inputObj.email_bc = this.thuebao.didong.txtEmailDD
        inputObj.email_hd = this.thuebao.didong.txtEmailDD

        inputObj.loai_dc_bao_cuoc = '0'
        inputObj.kieu_bao_cuoc = '0'
        inputObj.ma_bc = apidata['MA_BC']
        // vuth update tra sau 27/11/2019 fix ma_bc va nganhang
        //inputObj.ngan_hang_id = "0";
        //04/05/2020 fix giup Vu-HTH
        if (this.dsHDTT[0]['nganhang_id']) inputObj.ngan_hang_id = apidata['NGANHANG_ID']
        inputObj.so_tb = '84' + this.HDTB[0]['ma_tb']
        inputObj.ma_t = ''
        inputObj.sonhald = this.diachiLD.SONHA
        inputObj.nguoi_gt = ''
        inputObj.dia_chi_hd = ''
        inputObj.ma_tinh = this.tt_nd.tentat_ccbs // vuth update tra sau 27/11/2019
        inputObj.taikhoan = ''

        inputObj.so_giay_to = this.HDKH[0]['so_gt']
        if (this.thuebao.didong.cboDTVinaPhone.list.length > 0) {
          inputObj.doi_tuong_su_dung = this.thuebao.didong.cboDTVinaPhone.value
        }
        if (!inputObj.doi_tuong_su_dung) inputObj.doi_tuong_su_dung = '1'
        inputObj.loaitb_id = apidata['LOAITB_ID']

        inputObj.ten_tt = this.HDTT[0]['ten_tt']
        inputObj.dienthoai_ld = this.khachhang.dienthoai //txtTelKH.Text;

        inputObj.diadiem_tt_id = apidata['DIADIEM_TT_ID']

        inputObj.ten_tb = this.HDTB[0]['ten_tb']
        inputObj.chuyenkhoan_id = '0' // vuth update 28/11/2019
        inputObj.inhd_id = '0'

        inputObj.loaigt_id = apidata['LOAIGT_ID']

        inputObj.ngay_cap = this.dsHDKH[0]['ngaycap']

        inputObj.so_sim = this.HDTB_DD[0]['simcard']

        inputObj.ngay_sinh = this.dsHDKH[0]['ngay_sn']
        inputObj.doi_tuong_id = inputObj.doi_tuong_su_dung
        inputObj.quoc_tich = apidata['QUOC_TICH'] // vuth update 21.11
        inputObj.ma_nv = apidata['MANV_VNP']
        var rs = {} //new CCBSFacade().TS_LAPHD_CHUYENTINH_EDIT_THUEBAO_CTS(inputObj);
        await API.post_ts_laphd_chuyentinh_edit_thuebao_cts(this.axios, inputObj).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            rs = response.data.data
            if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;
          }
          rs.Message = response.data.message;
        })
        if (!rs.IssSuccessed) return 'Lỗi xảy ra trong quá trình thêm mới hợp đồng hòa mạng chuyển tỉnh lên Vinaphone.' + rs.Message
      } catch (ex) {
        return 'Lỗi xảy ra trong quá trình cập nhật hợp đồng hòa mạng chuyển tỉnh lên Vinaphone.' + ex
      }
      this.$toast.success(`Cập nhật hợp đồng hòa mạng chuyển tỉnh ${'84' + this.dsHDTB[0]['ma_tb']} trên VinaPhone thành công!`)

      return 'OK'
    },
    async LoadThongTin_DV_CNTT(vloaitb_id) {
      try {
        var ItemList = await this.Init_Properties(vloaitb_id, 'HDTB_CNTT', '00000')
        // var ItemList = await API.post_lay_danhsach_thuoctinh_datmoi(this.axios, { "ds_para": JSON.stringify(pdata) }).then(async (response) => {
        //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
        //     return response.data.data;
        //   }
        //   else return [];
        // });
        this.gridEditors = []
        for (var index1 = 0; index1 < ItemList.length; ++index1) {
          if (ItemList[index1].iAtt == 0) {
            var repositoryItemTextEdit = { Type: 'TextEdit' }
            repositoryItemTextEdit.Tag = ItemList[index1].sFieldName
            repositoryItemTextEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            repositoryItemTextEdit.EditValueChanged = this.repositoryItemTextEdit_EditValueChanged
            repositoryItemTextEdit.EditValueChanging += this.repositoryItemTextEdit_EditValueChanging
            repositoryItemTextEdit.Leave += this.repositoryItemTextEdit_Leave

            if (CAConstanst.isCADev) {
              if (this.listbox.loaihinh_tb.value == 116) {
                if (ItemList[index1].sFieldName == 'SO_THANG') {
                  repositoryItemTextEdit.ReadOnly = true
                }
              }

              var default_serial_value = ItemList[index1].sValue
              if (ItemList[index1].sFieldName != 'SERIAL') {
                default_serial_value = ItemList[index1].sValue
              } else {
                default_serial_value = this.generateUUID()
              }
              repositoryItemTextEdit.Value = default_serial_value
            } else {
              repositoryItemTextEdit.Value = ItemList[index1].sValue
            }
            repositoryItemTextEdit.Name = ItemList[index1].sCaption
            repositoryItemTextEdit.Group = 'Tham số báo cáo'
            repositoryItemTextEdit.ID = ItemList[index1].sFieldName
            repositoryItemTextEdit.RepositoryItem = repositoryItemTextEdit
            this.gridEditors.push(repositoryItemTextEdit)
          }
          if (ItemList[index1].iAtt == 1) {
            var repositoryItemCalcEdit = { Type: 'CalcEdit' }
            repositoryItemCalcEdit.Tag = ItemList[index1].sFieldName
            repositoryItemCalcEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            repositoryItemCalcEdit.Name = ItemList[index1].sCaption
            repositoryItemCalcEdit.Group = 'Tham số báo cáo'
            repositoryItemCalcEdit.ID = ItemList[index1].sFieldName
            repositoryItemCalcEdit.Value = ItemList[index1].sValue
            repositoryItemCalcEdit.RepositoryItem = repositoryItemCalcEdit
            this.gridEditors.push(repositoryItemCalcEdit)
            //this.gridEditors.Add((RepositoryItem)this.repositoryItemCalcEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
          }
          if (ItemList[index1].iAtt == 2) {
            ItemList[index1].sValue = moment(new Date()).format('DD/MM/YYYY')
            var repositoryItemDateEdit = { Type: 'DateEdit' }
            repositoryItemDateEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            repositoryItemDateEdit.Tag = ItemList[index1].sFieldName
            ItemList[index1].sValue = moment(new Date()).format('DD/MM/YYYY')
            // repositoryItemDateEdit.DisplayFormat.FormatString = "DD/MM/YYYY";
            // repositoryItemDateEdit.EditFormat.FormatString = "DD/MM/YYYY";
            repositoryItemDateEdit.FormatString = 'DD/MM/YYYY'
            repositoryItemDateEdit.EditMask = 'DD/MM/YYYY'
            // repositoryItemDateEdit.Mask.UseMaskAsDisplayFormat = true;
            repositoryItemDateEdit.EditValueChanged = this.repositoryItemDateEdit_EditValueChanged
            repositoryItemDateEdit.Name = ItemList[index1].sCaption
            repositoryItemDateEdit.Group = 'Tham số báo cáo'
            repositoryItemDateEdit.ID = ItemList[index1].sFieldName
            repositoryItemDateEdit.Value = moment(new Date()).format('DD/MM/YYYY')
            repositoryItemDateEdit.RepositoryItem = repositoryItemDateEdit
            this.gridEditors.push(repositoryItemDateEdit)
            // this.gridEditors.Add((RepositoryItem)repositoryItemDateEdit, ItemList[index1].sCaption, DateTime.Now, "Tham số báo cáo", ItemList[index1].sFieldName);
          }

          if (ItemList[index1].iAtt == 9) {
            ItemList[index1].sValue = moment(new Date()).format('DD/MM/YYYY HH:mm:ss')
            var repositoryItemDateEdit = { Type: 'DateEdit' }
            repositoryItemDateEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            repositoryItemDateEdit.Tag = ItemList[index1].sFieldName
            ItemList[index1].sValue = moment(new Date()).format('DD/MM/YYYY HH:mm:ss')
            // repositoryItemDateEdit.DisplayFormat.FormatString = "DD/MM/YYYY HH:mm:ss";
            // repositoryItemDateEdit.EditFormat.FormatString = "DD/MM/YYYY HH:mm:ss";
            repositoryItemDateEdit.FormatString = 'DD/MM/YYYY HH:mm:ss'
            repositoryItemDateEdit.EditMask = 'DD/MM/YYYY HH:mm:ss'
            // repositoryItemDateEdit.Mask.UseMaskAsDisplayFormat = true;
            repositoryItemDateEdit.EditValueChanged = this.repositoryItemDateEdit_EditValueChanged
            repositoryItemDateEdit.Name = ItemList[index1].sCaption
            repositoryItemDateEdit.Group = 'Tham số báo cáo'
            repositoryItemDateEdit.ID = ItemList[index1].sFieldName
            repositoryItemDateEdit.Value = moment(new Date()).format('DD/MM/YYYY')
            repositoryItemDateEdit.RepositoryItem = repositoryItemDateEdit
            this.gridEditors.push(repositoryItemDateEdit)
            // this.gridEditors.Add((RepositoryItem)repositoryItemDateEdit, ItemList[index1].sCaption, DateTime.Now, "Tham số báo cáo", ItemList[index1].sFieldName);
          }

          // var str1;
          // var dataSet;
          if (ItemList[index1].iAtt == 4) {
            var repositoryItemLookUpEdit = { Type: 'LookUpEdit' }
            repositoryItemLookUpEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            // repositoryItemLookUpEdit.View.OptionsView.ShowAutoFilterRow = true;
            repositoryItemLookUpEdit.Tag = ItemList[index1].sFieldName
            // str1 = "";
            var SQL = ItemList[index1].StrSql
            if (SQL && SQL != '' && SQL.indexOf('{') < 0) {
              // dataSet = new DataSet();
              var data = ItemList[index1].SqlData
              // await API.post_sp_huonggiao_runsql(this.axios, { "command": SQL }).then((response) => {
              //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //     return response.data.data.data_json;
              //   }
              //   else return [];
              // }); //this.bangts.GetSQL(SQL, "");
              repositoryItemLookUpEdit.ValueMember = ItemList[index1].sLookUpKeyField
              repositoryItemLookUpEdit.DisplayMember = ItemList[index1].sLookUpValueField
              if (this.DS_CHUQUAN_THEO_QUYEN != null && this.DS_CHUQUAN_THEO_QUYEN != '' && ItemList[index1].sLookUpKeyField.toUpperCase() == 'CHUQUAN_ID') repositoryItemLookUpEdit.DataSource = data.filter((x) => this.DS_CHUQUAN_THEO_QUYEN.indexOf(x.CHUQUAN_ID) >= 0)
              //(object)data.Tables[0].Select("CHUQUAN_ID in " + this.DS_CHUQUAN_THEO_QUYEN).CopyToDataTable();
              // #region cuongpq them load lai cbo huyen ivan
              else if (ItemList[index1].sLookUpKeyField.toUpperCase() == 'CAPDO_ID' && this.listbox.loaihinh_tb.value == LoaiHinhTB.IVAN) {
                let tinh_ivan = await API.post_getivan_tinh(this.axios, { tinh_id: this.diachiTB.TINH_ID }).then((response) => {
                    //.post_sp_huonggiao_runsql(this.axios, { "command": this.ReplaceSQL(`select tinh_ivan_id from ${DatabaseConstants.DB2}.tinh where tinh_id = ${this.diachiTB.TINH_ID}`) }).then((response) => {
                    if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                        return response.data.data //.data_json;
                    } else return []
                }) //bangts.getDataFromSQL(ReplaceSQL("select tinh_ivan_id from {?DB2}.tinh where tinh_id = " + tinhtb_id), "tinh_ivan").Tables[0];
                if (tinh_ivan.length > 0) {
                      if (tinh_ivan[0].tinh_ivan_id != null) {
                        let vtinh_ivan = tinh_ivan[0].tinh_ivan_id
                        repositoryItemLookUpEdit.DataSource = data.filter((x) => x.MAP_ID == vtinh_ivan) //(object)data.Tables[0].Select("MAP_ID = " + vtinh_ivan).CopyToDataTable();
                      } else throw 'Địa chỉ thuê bao tỉnh chưa có trên danh mục dịch vụ IVAN. Liên hệ admin để được hỗ trợ' //this.$toast.error("Địa chỉ thuê bao tỉnh chưa có trên danh mục dịch vụ IVAN. Liên hệ admin để được hỗ trợ");
                    } else throw 'Hãy chọn địa chỉ thuê bao' //this.$toast.error("Hãy chọn địa chỉ thuê bao");
              }
              // #endregion
              else repositoryItemLookUpEdit.DataSource = data
              // repositoryItemLookUpEdit.View.OptionsView.ShowColumnHeaders = false;
              //if (repositoryItemLookUpEdit.View.Columns.Count > 1)
              // if(Object.keys(data).length > 1) //Doan nay khong can vi combobox da hoat dong dung nhu the nay roi!!!
              // {
              //     for (var ic = 0; ic < Object.keys(data).length; ic++)
              //     {
              //         repositoryItemLookUpEdit.View.Columns[ic].Visible = false;
              //     }
              //     repositoryItemLookUpEdit.View.Columns[1].Visible = true;
              // }

              repositoryItemLookUpEdit.NullText = ''
            } else {
              SQL = await this.ReturnSqlStr(ItemList, index1)
              // dataSet = new DataSet();
              // DataSet data = this.bangts.GetSQL(SQL, "");
              var data = ItemList[index1].SqlData
              // await API.post_sp_huonggiao_runsql(this.axios, { "command": SQL }).then(async (response) => {
              //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //     return response.data.data.data_json;
              //   }
              //   else return [];
              // });
              repositoryItemLookUpEdit.ValueMember = ItemList[index1].sLookUpKeyField
              repositoryItemLookUpEdit.DisplayMember = ItemList[index1].sLookUpValueField
              if (this.DS_CHUQUAN_THEO_QUYEN != null && this.DS_CHUQUAN_THEO_QUYEN != '' && ItemList[index1].sLookUpKeyField.toUpperCase() == 'CHUQUAN_ID') repositoryItemLookUpEdit.DataSource = data.filter((x) => this.DS_CHUQUAN_THEO_QUYEN.indexOf(x.CHUQUAN_ID) >= 0)
              //(object)data.Tables[0].Select("CHUQUAN_ID in " + this.DS_CHUQUAN_THEO_QUYEN).CopyToDataTable();
              else repositoryItemLookUpEdit.DataSource = data //(object)data.Tables[0];
              // repositoryItemLookUpEdit.View.OptionsView.ShowColumnHeaders = false;
              // if (Object.keys(data).length > 1)
              // {
              //     for (var ic = 0; ic < Object.keys(data).length; ic++)
              //     {
              //         repositoryItemLookUpEdit.View.Columns[ic].Visible = false;
              //     }
              //     repositoryItemLookUpEdit.View.Columns[1].Visible = true;
              // }

              repositoryItemLookUpEdit.NullText = ''
            }
            repositoryItemLookUpEdit.EditValueChanged = this.repositoryItemLookUpEdit_EditValueChanged
            repositoryItemLookUpEdit.Leave = this.repositoryItemLookUpEdit_leave
            repositoryItemLookUpEdit.EditValueChanging = this.repositoryItemLookUpEdit_EditValueChanging
            //  this.gridEditors.Add((RepositoryItem)repositoryItemLookUpEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
            repositoryItemLookUpEdit.Name = ItemList[index1].sCaption
            repositoryItemLookUpEdit.Group = 'Tham số báo cáo'
            repositoryItemLookUpEdit.ID = ItemList[index1].sFieldName
            repositoryItemLookUpEdit.Value = ItemList[index1].sValue
            repositoryItemLookUpEdit.RepositoryItem = repositoryItemLookUpEdit
            this.gridEditors.push(repositoryItemLookUpEdit)
          }
          if (ItemList[index1].iAtt == 5) {
            //Button Edit
            var repositoryItemButtonEdit = { Type: 'ButtonEdit' }
            repositoryItemButtonEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            repositoryItemButtonEdit.Tag = ItemList[index1].sFieldName
            if (ItemList[index1].sFieldName == 'MATB_TN') {
              repositoryItemButtonEdit.ReadOnly = true
            }

            // repositoryItemButtonEdit.ButtonClick -= new DevExpress.XtraEditors.Controls.ButtonPressedEventHandler(this.repositoryItemButtonEdit_ButtonClick);
            repositoryItemButtonEdit.ButtonClick = this.repositoryItemButtonEdit_ButtonClick
            repositoryItemButtonEdit.Name = ItemList[index1].sCaption
            repositoryItemButtonEdit.Group = 'Tham số báo cáo'
            repositoryItemButtonEdit.ID = ItemList[index1].sFieldName
            repositoryItemButtonEdit.Value = ItemList[index1].sValue
            repositoryItemButtonEdit.RepositoryItem = repositoryItemButtonEdit
            this.gridEditors.push(repositoryItemButtonEdit)
            // this.gridEditors.Add((RepositoryItem)repositoryItemButtonEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
          }
          if (ItemList[index1].iAtt == 7) {
            var repositoryItemCheckEdit = { Type: 'CheckEdit' }
            repositoryItemCheckEdit.Tag = ItemList[index1].sFieldName
            repositoryItemCheckEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            repositoryItemCheckEdit.ValueChecked = 1
            repositoryItemCheckEdit.ValueUnchecked = 0
            repositoryItemCheckEdit.Name = ItemList[index1].sCaption
            repositoryItemCheckEdit.Group = 'Tham số báo cáo'
            repositoryItemCheckEdit.ID = ItemList[index1].sFieldName
            repositoryItemCheckEdit.Value = ItemList[index1].sValue
            repositoryItemCheckEdit.RepositoryItem = repositoryItemButtonEdit
            this.gridEditors.push(repositoryItemCheckEdit)
            // this.gridEditors.Add((RepositoryItem)this.repositoryItemCheckEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
          }
          if (ItemList[index1].iAtt == 10) {
            //InitialItemCheckedRepository();// Thay bang doan code ben duoi
            var repositoryItemCheckedComboBoxEdit1 = { Type: 'CheckedComboBoxEdit1' }
            repositoryItemCheckedComboBoxEdit1.AutoHeight = false
            repositoryItemCheckedComboBoxEdit1.Name = 'repositoryItemCheckedComboBoxEdit1'

            repositoryItemCheckedComboBoxEdit1.ReadOnly = ItemList[index1].sReadOnly == 1
            var SQL_CheckListBox = ItemList[index1].StrSql
            var data = ItemList[index1].SqlData
            // await API.post_sp_huonggiao_runsql(this.axios, { "command": SQL_CheckListBox }).then(async (response) => {
            //     if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            //       return response.data.data.data_json;
            //     }
            //     else return [];
            //   });//this.objCheckData.GET_DATA_SQL(SQL_CheckListBox, "");

            repositoryItemCheckedComboBoxEdit1.ValueMember = ItemList[index1].sLookUpKeyField
            repositoryItemCheckedComboBoxEdit1.DisplayMember = ItemList[index1].sLookUpValueField
            repositoryItemCheckedComboBoxEdit1.DataSource = data

            repositoryItemCheckedComboBoxEdit1.Name = ItemList[index1].sCaption
            repositoryItemCheckedComboBoxEdit1.Group = 'Tham số báo cáo'
            repositoryItemCheckedComboBoxEdit1.ID = ItemList[index1].sFieldName
            repositoryItemCheckedComboBoxEdit1.Value = ItemList[index1].sValue
            repositoryItemCheckedComboBoxEdit1.RepositoryItem = repositoryItemButtonEdit
            this.gridEditors.push(repositoryItemCheckedComboBoxEdit1)

            // this.gridEditors.Add((RepositoryItem)repositoryItemCheckedComboBoxEdit1, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
          }
        }
        // this.grcMacdinh.DataSource = this.gridEditors;
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    //BUG tu doan nay tro xuong, ItemList dang dung bien global, can xem & khai bao lai!!!
    async repositoryItemTextEdit_EditValueChanged(repositoryItemTextEdit) {
      // FIXME Can xem lai cho tham so nay xem nen truyen o code khoi tao doi tuong hay tu form????
      //RepositoryItemTextEdit repositoryItemTextEdit = !(sender is TextEdit) ? sender as RepositoryItemTextEdit : (sender as TextEdit).Properties;
      var ItemList = this.ItemList
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.Voice_Brandname && this.listbox.kieu_ld.value == 793 && repositoryItemTextEdit.Tag == 'MA_PL' && repositoryItemTextEdit.Value) {
        let columns = ['MA_PL', 'NGAY_KY_HD', 'MA_CHUAN', 'LOAICTS_ID', 'CHUQUAN_ID', 'MST', 'PHANLOAI_ID', 'DONVIKG_ID', 'TOCDO_ID', 'TEN_CH', 'SO_DT', 'EMAIL', 'DOMAIN', 'USERNAME']
        let vma_pl = repositoryItemTextEdit.Value
        let dt = await this.axios.get(`/web-hopdong/vbn/lay_thongtin_hopdong_cu?vma_pl=${vma_pl}`)

        if (dt && dt.data && dt.data.data && dt.data.data.length > 0) {
          for (var i = ItemList.length - 1; i >= 0; i--) {
            if (columns.includes(ItemList[i].sFieldName)) {
              ItemList[i].sValue = dt.data.data[0][ItemList[i].sFieldName.toLowerCase()]
              this.gridEditors[i].Value = dt.data.data[0][ItemList[i].sFieldName.toLowerCase()]
              //sothang = Convert.ToInt32(textValue);
            }
          }
        }
        else {
          this.$toast.error('Không tồn tại hợp đồng hoặc hợp đồng đã bị hủy. Hãy kiểm tra lại.')
        }
      }

      else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.Voice_Brandname && repositoryItemTextEdit.Tag == 'MA_CHUAN' && repositoryItemTextEdit.Value) {
        let so_tb = repositoryItemTextEdit.Value
        let source_hotline = "";
        for (var i = ItemList.length - 1; i >= 0; i--) {
          if (ItemList[i].sFieldName == "DONVIKG_ID") {
            source_hotline = this.gridEditors[i].Value;
          }
        }

        if (source_hotline == "") this.$toast.error('Chưa nhập Source hotline.');
        if (source_hotline == "12" /*meg*/) {
          let response_kt_meg = await this.axios.post('/ccbs/executor/meg_laytt_tb', { so_tb });
          if (response_kt_meg.data.data.length == 0) {
            this.$toast.error('Số thuê bao chủ nhóm không phải là số chính (số hotline) của dịch vụ MEG, đề nghị kiểm tra lại');
            repositoryItemTextEdit.Value = "";
            return;
          }
          let kt_meg = response_kt_meg.data.data;
        }
        else if (source_hotline == "11" /*VCC*/) {
          let response_kt_vcc = await this.axios.post('/ccbs/executor/ts_vcc_lay_tttb', { so_tb });
          if (response_kt_vcc.data.data.length == 0) {
            this.$toast.error('Số thuê bao chủ nhóm không phải là số chính (số hotline) của dịch vụ VCC, đề nghị kiểm tra lại');
            repositoryItemTextEdit.Value = "";
            return;
          }
          let kt_meg = response_kt_vcc.data.data;
        }
      }
      //thêm code  load thông tin hiện hữu sms brandname
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.BRANDNAME && this.listbox.kieu_ld.value == 13224 && repositoryItemTextEdit.Tag == 'LABEL_ID' && repositoryItemTextEdit.Value) {
        let label_id = repositoryItemTextEdit.Value
        let phanloai_id = -1
        for (var i = ItemList.length - 1; i >= 0; i--) {
          if (ItemList[i].sFieldName == 'PHANLOAI_ID') {
            phanloai_id = this.gridEditors[i].Value
            //sothang = Convert.ToInt32(textValue);
          }
        }
        var vphanvung_id = Number(this.$root.token.getPhanVungID())
        let response = await this.axios.post(`/tichhop/brandname/load_thongtin_brandname`, { vphanvung_id, vlabel_id: label_id + '', vphanloai_id: phanloai_id + '' })
        if (response.data.data && response.data.data.status == 200) {
          let columns_brn = ['LABEL_ID', 'AGENT_ID', 'CONTRACT_ID', 'LINHVUC_ID', 'LINHVUC_VMS_ID', 'LINHVUC_VTL_ID', 'LINHVUC_GTEL_ID', 'LINHVUC_VNM_ID', 'LINHVUC_ITEL_ID', 'LINHVUC_MOBICAST_ID']
          var label_data = response.data.data.data.items[0]
          for (var i = ItemList.length - 1; i >= 0; i--) {
            if (columns_brn.includes(ItemList[i].sFieldName)) {
              ItemList[i].sValue = label_data[ItemList[i].sFieldName.toLowerCase()]
              this.gridEditors[i].Value = label_data[ItemList[i].sFieldName.toLowerCase()]
            } else if (ItemList[i].sFieldName == 'THUONGHIEU') {
              ItemList[i].sValue = label_data['label']
              this.gridEditors[i].Value = label_data['label']
            } else if (ItemList[i].sFieldName == 'NGAY_BD') {
              ItemList[i].sValue = label_data['created_date']
              this.gridEditors[i].Value = label_data['created_date']
            } else if (ItemList[i].sFieldName == 'MST') {
              ItemList[i].sValue = label_data['tax_code']
              this.gridEditors[i].Value = label_data['tax_code']
            } else if (ItemList[i].sFieldName == 'ADSER_ID') {
              ItemList[i].sValue = '0'
              this.gridEditors[i].Value = '0'
            }
          }
        } else {
          this.$toast.error(response.data.data.message)
          return
        }
      }

      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.ELEARNING) {
        if (repositoryItemTextEdit.Tag == 'SOLUONG') {
          var textValue = repositoryItemTextEdit.Value
          for (var i = ItemList.length - 1; i >= 0; i--) {
            if (ItemList[i].sFieldName == 'SOLUONG') {
              ItemList[i].sValue = textValue
              //sothang = Convert.ToInt32(textValue);
              break
            }
          }
        }

        if (repositoryItemTextEdit.Tag == 'DOMAIN') {
          var textValue = repositoryItemTextEdit.Value
          for (var i = ItemList.length - 1; i >= 0; i--) {
            if (ItemList[i].sFieldName == 'DOMAIN') {
              ItemList[i].sValue = textValue
              //sothang = Convert.ToInt32(textValue);
              break
            }
          }
        }

        if (repositoryItemTextEdit.Tag == 'MA_PHU') {
          var textValue = repositoryItemTextEdit.Value
          for (var i = ItemList.length - 1; i >= 0; i--) {
            if (ItemList[i].sFieldName == 'MA_PHU') {
              ItemList[i].sValue = textValue
              //sothang = Convert.ToInt32(textValue);
              break
            }
          }
        }
      }

      if (repositoryItemTextEdit.Tag == 'SO_THANG') {
        var b_ngay_bd = false
        var b_ngay_kt = false
        var sothang = 0
        var ngay_bd = new Date() //tt_nd.ngay_cn;
        var ngay_kt = new Date() //tt_nd.ngay_cn;

        var textValue = repositoryItemTextEdit.Value
        sothang = textValue * 1

        if (!textValue || textValue == '' || isNaN(textValue)) return
        // Da chay o duoi > khong can chay lai o day!!!
        // for (var i = ItemList.length - 1; i >= 0; i--)
        // {
        //     if (ItemList[i].sFieldName == "SO_THANG")
        //     {
        //         ItemList[i].sValue = textValue;
        //         sothang = textValue;
        //         break;
        //     }
        // }
        for (var i = 0; i < ItemList.length; i++) {
          if (ItemList[i].sFieldName == 'SO_THANG') {
            ItemList[i].sValue = textValue
            sothang = textValue * 1
          }
          if (ItemList[i].sFieldName == 'NGAY_BD') {
            b_ngay_bd = true
            ItemList[i].sValue = this.gridEditors[i].Value
            ngay_bd = this.gridEditors[i].Value
            try {
              ngay_bd = moment(ngay_bd, ngay_bd.length > 10 ? 'DD/MM/YYYY HH:mm:ss' : 'DD/MM/YYYY').toDate()
            } catch (ex) {}
          }
          if (ItemList[i].sFieldName == 'NGAY_KT') {
            b_ngay_kt = true
            ItemList[i].sValue = this.gridEditors[i].Value
            ngay_kt = this.gridEditors[i].Value
            if (ngay_kt && (ngay_kt + '').indexOf('/') > 0)
            try {
              ngay_kt = moment(ngay_kt, ngay_kt.length > 10 ? 'DD/MM/YYYY HH:mm:ss' : 'DD/MM/YYYY').toDate()
            } catch (ex) {}
            if (ngay_kt)
              try {
                ngay_kt = moment(ngay_kt).toDate()
              } catch (ex) {}
          }
          if (ItemList[i].sFieldName == 'THOIGIAN_BD') {
            b_ngay_bd = true
            ItemList[i].sValue = this.gridEditors[i].Value
            ngay_bd = this.gridEditors[i].Value
            try {
              ngay_bd = moment(ngay_bd, ngay_bd.length > 10 ? 'DD/MM/YYYY HH:mm:ss' : 'DD/MM/YYYY').toDate()
            } catch (ex) {}
          }
          if (ItemList[i].sFieldName == 'THOIGIAN_KT') {
            b_ngay_kt = true
            ItemList[i].sValue = this.gridEditors[i].Value
            ngay_kt = this.gridEditors[i].Value
            if (ngay_kt && (ngay_kt + '').indexOf('/') > 0)
            try {
              ngay_kt = moment(ngay_kt, ngay_kt.length > 10 ? 'DD/MM/YYYY HH:mm:ss' : 'DD/MM/YYYY').toDate()
            } catch (ex) {}
            if (ngay_kt)
              try {
                ngay_kt = moment(ngay_kt).toDate()
              } catch (ex) {}
          }
          if (b_ngay_bd == true && b_ngay_kt == true) break
        }
        //moment(new Date()).format("DD/MM/YYYY")
        if (b_ngay_bd == true && b_ngay_kt == true) {
          ngay_kt = new Date(ngay_bd)
          ngay_kt = ngay_kt.setMonth(ngay_kt.getMonth() + sothang * 1) //ngay_bd.AddMonths(sothang);
          ngay_kt = new Date(ngay_kt)
          //ngay_kt = moment(ngay_bd).add(sothang*1,'M').toDate();
          for (var index_1 = 0; index_1 < ItemList.length; ++index_1) {
            if (ItemList[index_1].sFieldName == 'NGAY_KT') {
              try {
                ItemList[index_1].sValue = moment(ngay_kt).format('DD/MM/YYYY')
              } catch (ex) {
                ItemList[index_1].sValue = ngay_kt
              }
              this.gridEditors[index_1].Value = moment(ngay_kt).format('DD/MM/YYYY')
            }

            if (ItemList[index_1].sFieldName == 'THOIGIAN_KT') {
              try {
                ItemList[index_1].sValue = moment(ngay_kt).format('DD/MM/YYYY HH:mm:ss')
              } catch (ex) {
                ItemList[index_1].sValue = ngay_kt
              }
              this.gridEditors[index_1].Value = moment(ngay_kt).format('DD/MM/YYYY HH:mm:ss')
            }
          }
        }
      }

      if (repositoryItemTextEdit.Tag == 'TONGSO_ND') {
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IOFFICE) {
          var textValue = repositoryItemTextEdit.Value

          if (!textValue || textValue == '' || isNaN(textValue)) return

          this._sl_cha = textValue
          this.HT_ThietBi()
          this._sl_cha = -1
        }
      }
      if (repositoryItemTextEdit.Tag == 'SL_MAILING') {
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING || this.listbox.loaihinh_tb.value == LoaiHinhTB.HNTH_NGN) {
          var textValue = repositoryItemTextEdit.Value

          if (textValue == '' || isNaN(textValue)) return

          this._sl_cha = textValue
          this.HT_ThietBi()
          this._sl_cha = -1
        }
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MCAP) {
          var textValue = repositoryItemTextEdit.Value

          if (textValue == '' || isNaN(textValue)) return
          var sothang_mcap = 0
          for (var k = 0; k < this.gridEditors.length; k++) {
            if (ItemList[k].sFieldName == 'SO_THANG') {
              sothang_mcap = this.gridEditors[k].Value == '' ? 0 : this.gridEditors[k].Value
            }
          }
          if (sothang_mcap == 0) {
            sothang_mcap = 12
          }
          var tyle_thoigian = sothang_mcap / 12

          this._sl_cha = textValue * tyle_thoigian
          this.HT_ThietBi()
          this._sl_cha = -1
        }
      }

      if (repositoryItemTextEdit.Tag == 'SO_THANG') {
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MCAP) {
          var textValue = repositoryItemTextEdit.Value

          if (!textValue || textValue == '' || isNaN(textValue)) return
          var soluong_mcap = 0
          for (var k = 0; k < this.gridEditors.length; k++) {
            if (ItemList[k].sFieldName == 'SL_MAILING') {
              soluong_mcap = !this.gridEditors[k].Value || this.gridEditors[k].Value == '' ? 0 : this.gridEditors[k].Value
            }
          }
          if (soluong_mcap == 0) {
            soluong_mcap = 1
          }

          var so_thang_mcap = 0
          if (textValue % 12 != 0) {
            so_thang_mcap = 12
          } else {
            so_thang_mcap = textValue
          }
          this._sl_cha = (so_thang_mcap / 12) * soluong_mcap
          this.HT_ThietBi()
          this._sl_cha = -1
        }
      }
    },
    repositoryItemTextEdit_EditValueChanging(repoTextEdit) {
      // TextEdit repoTextEdit = (sender as TextEdit);
      var textValue = repoTextEdit.Value //repoTextEdit.EditValue.ToString();
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.ELEARNING) {
        var phanloai_dv = ''
        for (var item of this.ItemList) {
          if (item.sFieldName == 'PHANLOAI_ID') {
            phanloai_dv = item.sValue
            break
          }
        }
        if (phanloai_dv == '97') {
          if (repoTextEdit.Tag == 'TONGSO_ND') {
            if (repoTextEdit.Value != '0') {
              this.$toast.error('Bạn không cần nhập số lượng giáo viên cho gói doanh nghiệp')
              repoTextEdit.Cancel = true //FIXME can tim cach cancel thay doi
              repoTextEdit.Value = 0 //FIXME fix tam cho van de o dong tren, thay vi cancel thay doi thi cho ve gia tri dung mac dinh.
            }
          }
          if (repoTextEdit.Tag == 'SOLUONG') {
            if (repoTextEdit.NewValue != '0') {
              this.$toast.error('Bạn không cần nhập số lượng giáo viên cho gói doanh nghiệp')
              repoTextEdit.Cancel = true //FIXME can tim cach cancel thay doi
              repoTextEdit.Value = 0 //FIXME fix tam cho van de o dong tren, thay vi cancel thay doi thi cho ve gia tri dung mac dinh.
            }
          }
        }
      }
    },
    repositoryItemTextEdit_Leave() {
      //Cho nay kha nang khong can vi binding 2 chieu nen data update san roi. Neu van can thi bo comment dong duoi, check lai xem co this.$ hay this.gr....$
      //this.grvMacdinh.$forceUpdate();
    },
    repositoryItemDateEdit_EditValueChanged(repositoryItemDateEdit) {
      try {
        //DateEdit repositoryItemDateEdit = (sender as DateEdit);
        // this.tlstpTop.Focus();
        // this.grvMacdinh.Focus();
        // RepositoryItemDateEdit repositoryItemDateEdit = !(sender is DateEdit) ? sender as RepositoryItemDateEdit : (sender as DateEdit).Properties;
        var ItemList = this.ItemList
        if (repositoryItemDateEdit.Tag == 'NGAY_BD') {
          var b_ngay_bd = false
          var b_ngay_kt = false
          var b_sothang = false
          var d_ngay_bd = new Date() //tt_nd.ngay_cn;
          var d_ngay_kt = new Date() //tt_nd.ngay_cn;
          var sothang = 0
          //int thanghuong_dc = Convert.ToInt32(dsDC_HDTB.Tables[0].Rows[0]["thang_huongdc"].ToString());

          for (var i = 0; i < ItemList.length; i++) {
            if (ItemList[i].sValue && ItemList[i].sValue != '' && ItemList[i].sFieldName == 'SO_THANG') {
              b_sothang = true
              sothang = this.gridEditors[i].Value
            }
            if (ItemList[i].sFieldName == 'NGAY_BD' && this.gridEditors[i].Value != null) {
              b_ngay_bd = true
              ItemList[i].sValue = this.gridEditors[i].Value
              d_ngay_bd = this.gridEditors[i].Value
              try {
                d_ngay_bd = moment(d_ngay_bd, d_ngay_bd.length > 10 ? 'DD/MM/YYYY HH:mm:ss' : 'DD/MM/YYYY').toDate()
              } catch (ex) {}
            }
            if (ItemList[i].sFieldName == 'NGAY_KT') b_ngay_kt = true

            if (b_ngay_bd == true && b_ngay_kt == true && b_sothang == true) break
          }
          if (b_ngay_bd == true && b_ngay_kt == true && b_sothang == true) {
            d_ngay_kt = new Date(d_ngay_bd)
            d_ngay_kt = new Date(d_ngay_kt.setMonth(d_ngay_kt.getMonth() + sothang * 1)) //d_ngay_bd.AddMonths(sothang);
            for (var index_1 = 0; index_1 < ItemList.length; ++index_1) {
              if (ItemList[index_1].sFieldName == 'NGAY_KT') {
                // ItemList[index_1].sValue = d_ngay_kt.ToString("dd/MM/yyyy");
                try {
                  ItemList[index_1].sValue = moment(d_ngay_kt).format('DD/MM/YYYY')
                } catch (ex) {
                  ItemList[index_1].sValue = d_ngay_kt
                }
                this.gridEditors[index_1].Value = moment(d_ngay_kt).format('DD/MM/YYYY')
              }
              if (ItemList[index_1].sFieldName == 'NGAY_DUYTRI' && this.listbox.loaihinh_tb.value == LoaiHinhTB.VEDU_LIB) {
                // ItemList[index_1].sValue = d_ngay_kt.ToString("dd/MM/yyyy");
                try {
                  ItemList[index_1].sValue = moment(d_ngay_kt).format('DD/MM/YYYY')
                } catch (ex) {
                  ItemList[index_1].sValue = d_ngay_kt
                }
                d_ngay_kt = new Date(d_ngay_bd)
                this.gridEditors[index_1].Value = moment(new Date(d_ngay_kt.setMonth(d_ngay_kt.getMonth() + 12))).format('DD/MM/YYYY') //d_ngay_bd.AddMonths(12);
              }
            }
          }
          // grcMacdinh.RefreshDataSource();
          //Cho nay kha nang khong can vi binding 2 chieu nen data update san roi. Neu van can thi bo comment dong duoi, check lai xem co this.$ hay this.gr....$
          //this.grvMacdinh.$forceUpdate();
        }
      } catch (ex) {
        this.$toast.error('Có lỗi: ' + ex)
      }
    },
    async repositoryItemLookUpEdit_EditValueChanged(repositoryItemLookUpEdit) {
      //Neu la linhvuc_id thi reset lai thong tin dich vu gia tang dang ky (Neu co) Do DVGT phu thuoc linh vuc
      try {
        var ItemList = this.ItemList
        // RepositoryItemGridLookUpEdit repositoryItemLookUpEdit = !(sender is GridLookUpEdit) ? sender as RepositoryItemGridLookUpEdit : (sender as GridLookUpEdit).Properties;
        this.PhanLoai_ID = ',' + repositoryItemLookUpEdit.Value + ',' //PhanLoai_ID = "," + ((GridLookUpEdit)sender).EditValue.ToString() + ",";
        //if (repositoryItemLookUpEdit.ValueMember == "LINHVUC_ID")
        if (repositoryItemLookUpEdit.ID == 'LINHVUC_ID') {
          //FIXME can test ky lai cho nay, ValueMember co kha nang ~ ID, neu khong phai tim cach khac xu ly!!!
          await this.LAY_DS_DVGT_MACDINH(this.listbox.loaihinh_tb.value)
        }
        if (repositoryItemLookUpEdit.ID == 'THOIHAN_ID') {
          //FIXME can test ky lai cho nay, ValueMember co kha nang ~ ID, neu khong phai tim cach khac xu ly!!!
          var thoihan = repositoryItemLookUpEdit.Value //((GridLookUpEdit)sender).EditValue.ToString();
          if (thoihan == '2') {
            for (var ii = 0; ii < this.ItemList.length; ii++) {
              if (this.ItemList[ii].sFieldName == 'SO_THANG') {
                this.ItemList[ii].sValue = '1200'
                this.gridEditors[ii].Value = 1200
              }
              if (this.ItemList[ii].sFieldName == 'NGAY_KT') {
                var ngaycn = new Date()
                ngaycn = new Date(ngaycn.setMonth(ngaycn.getMonth() + 1200))
                this.ItemList[ii].sValue = moment(ngaycn).format('DD/MM/YYYY')
                this.gridEditors[ii].Value = moment(ngaycn).format('DD/MM/YYYY')
              }
            }
          } else {
            for (var ii = 0; ii < this.ItemList.length; ii++) {
              if (this.ItemList[ii].sFieldName == 'SO_THANG' && (!this.ItemList[ii].sValue || this.ItemList[ii].sValue <= 0)) {
                this.ItemList[ii].sValue = '0'
                this.gridEditors[ii].Value = 0
              }
              if (this.ItemList[ii].sFieldName == 'NGAY_KT' && !this.ItemList[ii].sValue) {
                var ngaycn = new Date()
                this.ItemList[ii].sValue = moment(ngaycn).format('DD/MM/YYYY')
                this.gridEditors[ii].Value = moment(ngaycn).format('DD/MM/YYYY')
                // this.ItemList[ii].sValue = tt_nd.ngay_cn.ToString("dd/MM/yyyy");
                // this.gridEditors[ii].Value = tt_nd.ngay_cn;
              }
            }
          }
        }
        if (repositoryItemLookUpEdit.ID == 'PHANLOAI_ID' || (repositoryItemLookUpEdit.ID == 'LOAICTS_ID' && this.listbox.loaihinh_tb.value == LoaiHinhTB.SMART_CA)) {
          ////FIXME can test ky lai cho nay, ValueMember co kha nang ~ ID, neu khong phai tim cach khac xu ly!!!
          //Nếu dịch vụ là 5002 thì lấy lại thông tin combo box tốc độ
          for (var i = 0; i < ItemList.length; i++) {
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.BRANDNAME && repositoryItemLookUpEdit.Value && repositoryItemLookUpEdit.Value != '0')
              if (ItemList[i].sFieldName.indexOf('LINHVUC_') == 0 && ItemList[i].sFieldName.indexOf('_ID') == ItemList[i].sFieldName.length - 3)
                if (ItemList[i].SqlData && ItemList[i].SqlData.length > 0) {
                  let newds = ItemList[i].SqlData.filter((x) => x.PHANLOAI_ID == repositoryItemLookUpEdit.Value)
                  if (newds && newds.length > 0) {
                    newds.unshift({ LINHVUC_ID: 0, LABEL_TYPE_NAME: '', PHANLOAI_ID: 0 })
                    this.gridEditors[i].DataSource = newds.map((x) => ({ text: x[ItemList[i].sLookUpValueField], id: x[ItemList[i].sLookUpKeyField] }))
                    if (!this.gridEditors[i].DataSource.find((x) => x.id == this.gridEditors[i].Value)) {
                      this.gridEditors[i].Value = this.gridEditors[i].DataSource[0].id
                      ItemList[i].sValue = this.gridEditors[i].DataSource[0].id
                      ItemList[i].Value = this.gridEditors[i].DataSource[0].id
                    }
                  } else {
                    this.gridEditors[i].DataSource = [{ text: 'Không áp dụng', id: 0 }]
                    this.gridEditors[i].Value = 0
                    ItemList[i].sValue = 0
                    ItemList[i].Value = 0
                  }
                }
            if (ItemList[i].sFieldName == 'PHANLOAI_ID' || ItemList[i].sFieldName == 'LOAICTS_ID') {
              ItemList[i].sValue = repositoryItemLookUpEdit.Value
            }
            if (ItemList[i].strDepandField == 'DAILY' || (ItemList[i].sFieldName == 'LINHVUC_ID' && this.listbox.loaihinh_tb.value != LoaiHinhTB.BRANDNAME)) {
              var SQL = await this.ReturnSqlStr(ItemList, i)
              if (this.gridEditors[i]) this.gridEditors[i].DataSource = data.map((x) => ({ text: x[ItemList[i].sLookUpValueField], id: x[ItemList[i].sLookUpKeyField] }))
              // await API.post_sp_huonggiao_runsql(this.axios, { "command": SQL }).then(async (response) => {
              //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //     return response.data.data.data_json;
              //   }
              //   else return [];
              // });//this.bangts.GetSQL(SQL, "");
              //((RepositoryItemGridLookUpEdit)gridEditors[i].RepositoryItem).DataSource = (object)data.Tables[0];
              // break
            }
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.ELEARNING) {
              var phanloai_id_elearning = repositoryItemLookUpEdit.Value //((GridLookUpEdit)sender).EditValue.ToString();
              if (phanloai_id_elearning == '97') {
                // gói doanh nghiệp
                for (var ii = 0; ii < ItemList.length; ii++) {
                  if (ItemList[ii].sFieldName == 'TONGSO_ND') {
                    ItemList[ii].sValue = '0'
                    this.gridEditors[ii].Value = '0'
                  }
                  if (ItemList[ii].sFieldName == 'SOLUONG') {
                    ItemList[ii].sValue = '0'
                    this.gridEditors[ii].Value = '0'
                  }
                }
              }
            }
          }
        }
        if (repositoryItemLookUpEdit.ID == 'TOCDO_ID') {
          //FIXME can test ky lai cho nay, ValueMember co kha nang ~ ID, neu khong phai tim cach khac xu ly!!!
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.TTDL_HDDT) {
            // VNPT Invoice
            var invoiceTocdo_id = repositoryItemLookUpEdit.Value
            API.get_tocdo_adsl(this.axios, {})
              .then((response) => {
                //.post_sp_huonggiao_runsql(this.axios, { "command": `select ${DatabaseConstants.DB2}.TUDONG_TINHSOTHANG_SD_THEO_GOICUOC(${this.listbox.loaihinh_tb.value}) kq from dual` }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  let datalist = response.data.data //.data_json;
                  if (!datalist) datalist = []
                  let currentData = datalist.find((x) => x.tocdo_id == invoiceTocdo_id)
                  for (var i = 0; i < ItemList.length; i++)
                    if (ItemList[i].sFieldName == 'SL_MAILING') {
                      if (currentData && currentData.ca_key_length && currentData.ca_key_length > 0) {
                        ItemList[i].sValue = currentData.ca_key_length + ''
                        ItemList[i].Value = currentData.ca_key_length
                        this.gridEditors[i].Value = currentData.ca_key_length
                      } else {
                        ItemList[i].sValue = ''
                        ItemList[i].Value = ''
                        this.gridEditors[i].Value = ''
                      }
                    }
                }
              })
              .catch(() => {})
          }
          var vtocdo_id = 0
          var vmuccuoc_id = 0
          for (var i = 0; i < ItemList.length; i++) {
            if (ItemList[i].sFieldName == 'TOCDO_ID') {
              ItemList[i].sValue = repositoryItemLookUpEdit.Value //((GridLookUpEdit)sender).EditValue.ToString();
              vtocdo_id = ItemList[i].sValue

              this.tocdo_id = vtocdo_id
              this.listbox.cboGoiCuocAdsl.value = vtocdo_id
              await this.HT_GIAODIEN_DONVI();
              await this.HT_DS_KhuyenMai_Combobox()
              try {
                let checkTD = await API.post_tudong_tinhsothang_sd_theo_goicuoc(this.axios, { vloaitb_id: this.listbox.loaihinh_tb.value }).then((response) => {
                  //.post_sp_huonggiao_runsql(this.axios, { "command": `select ${DatabaseConstants.DB2}.TUDONG_TINHSOTHANG_SD_THEO_GOICUOC(${this.listbox.loaihinh_tb.value}) kq from dual` }).then(async (response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    return response.data.data //.data_json;
                  } else return []
                })
                // if (tdan.GET_VALUE_FUNC("{?DB2}.TUDONG_TINHSOTHANG_SD_THEO_GOICUOC", "vloaitb_id", this.listbox.loaihinh_tb.value).ToString() == "ok")
                // if (checkTD && checkTD.length>0 && checkTD[0].kq && checkTD[0].kq == "ok")
                if (checkTD && checkTD == 'ok') {
                  let dt_tocdo_goicuoc = await API.post_dt_tocdo_goicuoc(this.axios, { id: vtocdo_id }).then(async (response) => {
                    //.post_sp_huonggiao_runsql(this.axios, { "command": `Select sothang_sd, rc_id from ${DatabaseConstants.DB2}.tocdo_adsl where tocdo_id = ${vtocdo_id}` }).then(async (response) => {
                    if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                      return response.data.data //.data_json;
                    } else return []
                  })
                  var so_thang_sd = dt_tocdo_goicuoc[0]['SOTHANG_SD']
                  var index_so_thang = -1
                  var index_ngay_bd = -1
                  var index_ngay_kt = -1
                  for (var index_1 = 0; index_1 < ItemList.length; ++index_1) {
                    if (ItemList[index_1].sFieldName == 'SO_THANG') {
                      index_so_thang = index_1
                    }
                    if (ItemList[index_1].sFieldName == 'NGAY_BD') {
                      index_ngay_bd = index_1
                    }
                    if (ItemList[index_1].sFieldName == 'NGAY_KT') {
                      index_ngay_kt = index_1
                    }
                  }
                  this.gridEditors[index_so_thang].Value = so_thang_sd
                  ItemList[index_so_thang].sValue = so_thang_sd
                  var tmpdate = moment(ItemList[index_ngay_bd].sValue, 'DD/MM/YYYY').toDate()
                  tmpdate = tmpdate.setMonth(tmpdate.getMonth() + so_thang_sd)
                  var ngay_kt_orm = moment(tmpdate).format('DD/MM/YYYY') //(DateTime.ParseExact(ItemList[index_ngay_bd].sValue, "dd/MM/yyyy", CultureInfo.InvariantCulture).AddMonths(Convert.ToInt32(so_thang_sd))).ToString("dd/MM/yyyy");
                  gridEditors[index_ngay_kt].Value = ngay_kt_orm
                  ItemList[index_ngay_kt].sValue = ngay_kt_orm
                }
                // var kq_kt_tt_tocdo = await API.post_sp_huonggiao_runsql(this.axios, { "command": `select ${DatabaseConstants.DB2}.TUDONG_TINHTHUOCTINH_TOCDO_ADSL(${this.listbox.loaihinh_tb.value,vtocdo_id}) kq from dual` }).then(async (response) => {
                //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000' && response.data.data.data_json && response.data.data.data_json.kq) {
                //     return response.data.data.data_json.kq;
                //   }
                //   else return -1;
                // });//tdan.GET_VALUE_FUNC("{?DB2}.TUDONG_TINHTHUOCTINH_TOCDO_ADSL", "vloaitb_id", this.listbox.loaihinh_tb.value, "vtocdo_id", vtocdo_id).ToString();
                let kq_kt_tt_tocdo = await API.post_tudong_tinhthuoctinh_tocdo_adsl(this.axios, { id: this.listbox.loaihinh_tb.value, id1: vtocdo_id }).then((response) => {
                  //.post_sp_huonggiao_runsql(this.axios, { "command": `select ${DatabaseConstants.DB2}.TUDONG_TINHTHUOCTINH_TOCDO_ADSL(${this.listbox.loaihinh_tb.value,vtocdo_id}) kq from dual` }).then(async (response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000' && response.data.data.data_json && response.data.data.data_json.kq) {
                    return response.data.data.kq ? response.data.data.kq : -1 //.data_json.kq;
                  } else return -1
                })
                if (kq_kt_tt_tocdo != '-1') {
                  // DataTable dt_tocdo_goicuoc = objCheckData.GET_DATA_SQL(@"Select sothang_sd, rc_id from {?DB2}.tocdo_adsl where tocdo_id = :tocdo_id", "tocdo_id", vtocdo_id);
                  var thuoctinh = kq_kt_tt_tocdo.Split(';')[0]
                  var giatri = kq_kt_tt_tocdo.Split(';')[1]
                  var index_thuoctinh = -1
                  for (var index_1 = 0; index_1 < ItemList.length; ++index_1) {
                    if (ItemList[index_1].sFieldName == thuoctinh) {
                      if (kq_kt_tt_tocdo.Split(';')[2] == '1') {
                        this.gridEditors[index_1].Value = giatri
                      } else {
                        this.gridEditors[index_1].Value = giatri
                      }
                      ItemList[index_1].sValue = giatri
                    }
                  }
                }

                checkTD = await API.post_kiemtra_dichvu_tudong_thuoctinh_goicuoc(this.axios, { vloaitb_id: this.listbox.loaihinh_tb.value }).then(async (response) => {
                  //.post_sp_huonggiao_runsql(this.axios, { "command": `select ${DatabaseConstants.DB2}.KIEMTRA_DICHVU_TUDONG_THUOCTINH_GOICUOC(${this.listbox.loaihinh_tb.value}) kq from dual` }).then(async (response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    return response.data.data //.data_json;
                  } else return []
                })
                //if (tdan.GET_VALUE_FUNC("{?DB2}.KIEMTRA_DICHVU_TUDONG_THUOCTINH_GOICUOC", "vloaitb_id", this.listbox.loaihinh_tb.value).ToString() == "ok")
                // if (checkTD && checkTD.length>0 && checkTD[0].kq && checkTD[0].kq == "ok")
                if (checkTD && checkTD == 'ok') {
                  var dt_tskt_goicuoc = await API.post_lay_thongso_kt_goicuoc(this.axios, { vtocdo_id: this.tocdo_id }).then(async (response) => {
                    if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                      return this.UpperCasePropertyList(response.data.data)
                    } else return []
                  }) //tdan.GET_DATA_PROC("{?DB2}.LAY_THONGSO_KT_GOICUOC", "vtocdo_id", tocdo_id);
                  if (dt_tskt_goicuoc && dt_tskt_goicuoc.length > 0) {
                    for (var r of dt_tskt_goicuoc) {
                      for (var i_ts = 0; i_ts < ItemList.length; i_ts++) {
                        if (ItemList[i_ts].sFieldName == r['FIELD_NAME']) {
                          if (r['DATA_TYPE'] == '0') {
                            ItemList[i_ts].sValue = r['FIELD_VALUE']
                            this.gridEditors[i_ts].Value = r['FIELD_VALUE']
                          }

                          if (r['DATA_TYPE'] == '1') {
                            ItemList[i_ts].sValue = r['FIELD_VALUE']
                            this.gridEditors[i_ts].Value = r['FIELD_VALUE']
                            if (r['FIELD_NAME'] == 'SO_THANG') {
                              let vt_ngaybd = -1,
                                vt_ngaykt = -1
                              for (var i_gr = 0; i_gr < ItemList.length; i_gr++) {
                                if (ItemList[i_gr].sFieldName == 'NGAY_BD') {
                                  vt_ngaybd = i_gr
                                }
                                if (ItemList[i_gr].sFieldName == 'NGAY_KT') {
                                  vt_ngaykt = i_gr
                                  //break;
                                }
                              }
                              if (vt_ngaybd != -1 || vt_ngaykt != -1) {
                                var tmpdate = moment(ItemList[vt_ngaybd].sValue, 'DD/MM/YYYY').toDate()
                                tmpdate = tmpdate.setMonth(tmpdate.getMonth() + r['FIELD_VALUE'] * 1)
                                var ngay_kt = moment(tmpdate).format('DD/MM/YYYY')
                                // DateTime ngay_kt = DateTime.ParseExact(ItemList[vt_ngaybd].sValue, "dd/MM/yyyy", CultureInfo.InvariantCulture).AddMonths(Convert.ToInt32(r["FIELD_VALUE"].ToString()));
                                ItemList[vt_ngaykt].sValue = ngay_kt
                                this.gridEditors[vt_ngaykt].Value = ngay_kt
                              }
                            }
                          }

                          if (r['DATA_TYPE'] == 2) {
                            if (r['FIELD_VALUE'].indexOf('NOW') >= 0) {
                              var gt_ngay = r['FIELD_VALUE'].split('+')
                              if (gt_ngay.length == 1) {
                                ItemList[i_ts].sValue = moment(new Date()).format('DD/MM/YYYY') //tt_nd.ngay_cn.ToString("dd/MM/yyyy");
                                this.gridEditors[i_ts].Value = new Date() //tt_nd.ngay_cn;
                              } else {
                                var add = gt_ngay[1] * 1
                                var gt_ngay_gc = moment()
                                  .add(1, gt_ngay[2] ? gt_ngay[2] : 'D')
                                  .toDate()
                                // if (gt_ngay[2] == "Y")
                                // {
                                //     gt_ngay_gc = moment().add(1, 'Y');//tt_nd.ngay_cn.AddYears(add);
                                // }
                                // else if (gt_ngay[2] == "M")
                                // {
                                //     gt_ngay_gc = tt_nd.ngay_cn.AddMonths(add);
                                // }
                                // else
                                // {
                                //     gt_ngay_gc = tt_nd.ngay_cn.AddDays(add);
                                // }
                                ItemList[i_ts].sValue = moment(gt_ngay_gc).format('DD/MM/YYYY')
                                this.gridEditors[i_ts].Value = gt_ngay_gc
                              }
                            } else {
                              ItemList[i_ts].sValue = r['FIELD_VALUE']
                              this.gridEditors[i_ts].Value = moment(r['FIELD_VALUE'], 'DD/MM/YYYY').toDate() //DateTime.ParseExact(r["FIELD_VALUE"].ToString(), "dd/MM/yyyy", CultureInfo.InvariantCulture);
                            }
                          }
                        }
                      }
                    }
                  }
                }

                this.listbox.cboGoiCuocAdsl.value = vtocdo_id
                //FIXME 2 dong nay chi de thong bao gia tri combobox da thay doi, tam bo qua
                // if (this.listbox.cboGoiCuocAdsl.value == 0)
                //     cboGoiCuocAdsl.Properties.GetKeyValue(0);
                repositoryItemLookUpEdit.Value = vtocdo_id
                this.HT_GIAODIEN_DONVI();
                this.HT_DS_KhuyenMai_Combobox()
              } catch (ex) {
                if (this.debug) console.error(ex)
                // Message_Box.Show(ex.Message);
              }
            }
            if (ItemList[i].sFieldName == 'MUCCUOC_ID') {
              vmuccuoc_id = ItemList[i].sValue
              this.muccuoc_id = vmuccuoc_id
              try {
                this.listbox.muccuoc.value = vmuccuoc_id ? vmuccuoc_id : 0 //cboMucCuoc.SelectedValue = vmuccuoc_id;
                //if (this.listbox.muccuoc.list.filter((x) => x.muccuoc_id == this.listbox.muccuoc.value).length <= 0) this.listbox.muccuoc.value = this.listbox.muccuoc.list.length > 0 ? this.listbox.muccuoc.list[0].muccuoc_id : 0 //cboMucCuoc.SelectedIndex = 0;
              } catch (ex) {
                if (this.debug) console.error(ex)
              }
            }
            if (ItemList[i].sFieldName == 'HEDIEUHANH_ID') {
              var SQL = this.ReturnSqlStr(ItemList, i)
              let data = ItemList[i].SqlData
              if (this.gridEditors[i]) {
                if (data && data.length > 0) {
                  data = data.map((x) => ({ text: x[this.gridEditors[i].DisplayMember], id: x[this.gridEditors[i].ValueMember] }))
                }
                this.gridEditors[i].DataSource = data
              }
              // await API.post_sp_huonggiao_runsql(this.axios, { "command": SQL }).then(async (response) => {
              //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //     return response.data.data.data_json;
              //   }
              //   else return [];
              // });
              // DataSet data = this.bangts.GetSQL(SQL, "");
              // ((RepositoryItemGridLookUpEdit)gridEditors[i].RepositoryItem).DataSource = (object)data.Tables[0];
              //break
            }
          }
          var pdata = {
            vapld_id: this.diachiLD.AP_ID ? this.diachiLD.AP_ID : 0,
            vdoituong_id: this.listbox.doituong.value ? this.listbox.doituong.value : this.listbox.doituong.list && this.listbox.doituong.list[0] ? this.listbox.doituong.list[0].doituong_id : 0,
            vkhuld_id: this.diachiLD.KHU_ID ? this.diachiLD.KHU_ID : 0,
            vloaitb_id: this.listbox.loaihinh_tb.value,
            vmuccuoc_id: vmuccuoc_id,
            vngay: this.NgayYeuCau.indexOf(' ') > 0 ? this.NgayYeuCau.substring(0, this.NgayYeuCau.indexOf(' ')) : this.NgayYeuCau,
            vphold_id: this.diachiLD.PHO_ID ? this.diachiLD.PHO_ID : 0,
            vphuongld_id: this.diachiLD.PHUONG_ID ? this.diachiLD.PHUONG_ID : 0,
            vtocdo_id: vtocdo_id
          }
          var ds = await API.post_lay_ds_mucuoc_tb(this.axios, pdata).then(async (response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          }) //tcdanhba.LAY_DS_MUCUOC_TB(khuld_id, apld_id, phold_id, phuongld_id, this.listbox.loaihinh_tb.value, Convert.ToInt32(cboDoituongTB.EditValue), vtocdo_id, vmuccuoc_id, dtpNgayYeuCau.Value.ToString("dd/MM/yyyy"));
          if (ds.length > 0) {
            this.listbox.muccuoc_tb.list = ds
            if (!this.listbox.muccuoc_tb.value || !this.listbox.muccuoc_tb.list.find((x) => (x.muccuoctb_id ? x.muccuoctb_id : x.mucuoctb_id) == this.listbox.muccuoc_tb.value)) this.listbox.muccuoc_tb.value = ds[0].mucuoctb_id
            // cboMucCuocTB.ValueMember = "mucuoctb_id";
            // cboMucCuocTB.DisplayMember = "tenmuccuoc";
          } else this.listbox.muccuoc_tb.list = []
          this.LayTienTheoKhoanMuc()
          await this.LAY_DS_DVGT_MACDINH(this.listbox.loaihinh_tb.value)
        }
        if (repositoryItemLookUpEdit.ID == 'MUCCUOC_ID') {
          // FIXME thay ValueMember = ID, can test lai
          var vtocdo_id = 0
          var vmuccuoc_id = 0
          for (var i = 0; i < ItemList.length; i++) {
            if (ItemList[i].sFieldName == 'MUCCUOC_ID') {
              ItemList[i].sValue = repositoryItemLookUpEdit.Value //((GridLookUpEdit)sender).EditValue.ToString();
              vmuccuoc_id = ItemList[i].sValue * 1
              this.muccuoc_id = vmuccuoc_id
              try {
                this.listbox.muccuoc.value = vmuccuoc_id //cboMucCuoc.SelectedValue = vmuccuoc_id;
                if (this.listbox.muccuoc.list.filter((x) => x.muccuoc_id == this.listbox.muccuoc.value).length <= 0) this.listbox.muccuoc.value = this.listbox.muccuoc.list.length > 0 ? this.listbox.muccuoc.list[0].muccuoc_id : 0 //cboMucCuoc.SelectedIndex = 0;
              } catch (ex) {}
            }
            if (ItemList[i].sFieldName == 'TOCDO_ID') {
              vtocdo_id = ItemList[i].sValue * 1
              this.tocdo_id = vtocdo_id
              try {
                this.listbox.cboGoiCuocAdsl.value = vtocdo_id
                await this.HT_GIAODIEN_DONVI();
                // if (this.listbox.cboGoiCuocAdsl.value == 0) //Bo qua doan nay vi chi co chuc nang raise event thay doi gia tri
                //     cboGoiCuocAdsl.Properties.GetKeyValue(0);
              } catch (ex) {}
            }
          }

          var pdata = {
            vapld_id: this.diachiLD.AP_ID ? this.diachiLD.AP_ID : 0,
            vdoituong_id: this.listbox.doituong.value ? this.listbox.doituong.value : this.listbox.doituong.list && this.listbox.doituong.list ? this.listbox.doituong.list[0].doituong_id : 0,
            vkhuld_id: this.diachiLD.KHU_ID ? this.diachiLD.KHU_ID : 0,
            vloaitb_id: this.listbox.loaihinh_tb.value,
            vmuccuoc_id: vmuccuoc_id,
            vngay: this.NgayYeuCau.indexOf(' ') > 0 ? this.NgayYeuCau.substring(0, this.NgayYeuCau.indexOf(' ')) : this.NgayYeuCau,
            vphold_id: this.diachiLD.PHO_ID ? this.diachiLD.PHO_ID : 0,
            vphuongld_id: this.diachiLD.PHUONG_ID ? this.diachiLD.PHUONG_ID : 0,
            vtocdo_id: vtocdo_id
          }
          var ds = await API.post_lay_ds_mucuoc_tb(this.axios, pdata).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          // var ds = tcdanhba.LAY_DS_MUCUOC_TB(khuld_id, apld_id, phold_id, phuongld_id, this.listbox.loaihinh_tb.value, Convert.ToInt32(cboDoituongTB.EditValue), vtocdo_id, vmuccuoc_id, dtpNgayYeuCau.Value.ToString("dd/MM/yyyy"));
          if (ds.length > 0) {
            this.listbox.muccuoc_tb.list = ds
            // cboMucCuocTB.ValueMember = "mucuoctb_id";
            // cboMucCuocTB.DisplayMember = "tenmuccuoc";
          } else this.listbox.muccuoc_tb.list = [] //cboMucCuocTB.DataSource = null;
        }
      } catch (ex) {
        this.$toast.error('Có lỗi: ' + ex)
      }
    },
    repositoryItemLookUpEdit_leave() {
      //Cho nay kha nang khong can vi binding 2 chieu nen data update san roi. Neu van can thi bo comment dong duoi, check lai xem co this.$ hay this.gr....$
      //this.grvMacdinh.$forceUpdate();
    },
    async repositoryItemLookUpEdit_EditValueChanging(repositoryItemLookUpEdit) {
      var ItemList = this.ItemList
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.CA) {
        // RepositoryItemGridLookUpEdit repositoryItemLookUpEdit = !(sender is GridLookUpEdit) ? sender as RepositoryItemGridLookUpEdit : (sender as GridLookUpEdit).Properties;
        if (repositoryItemLookUpEdit.ID == 'LOAICTS_ID') {
          if (this.vkieukh_id_ == 0) {
            if (repositoryItemLookUpEdit.Value != 1) {
              repositoryItemLookUpEdit.Cancel = false
              this.$toast.error('Bạn chỉ được chọn loại khách hàng cá nhân!')
            }
          } else {
            if (repositoryItemLookUpEdit.Value == 1) {
              repositoryItemLookUpEdit.Cancel = true
              this.$toast.error('Bạn chỉ được chọn loại khách hàng doanh nghiệp hoặc cá nhân thuộc tổ chức/doanh nghiệp!')
            }
          }
        }

        if (repositoryItemLookUpEdit.ID == 'TOCDO_ID') {
          var vtocdo_id = repositoryItemLookUpEdit.Value
          var dt_tocdo_goicuoc = await API.post_sp_huonggiao_runsql(this.axios, { command: `Select sothang_sd, rc_id from ${DatabaseConstants.DB2}.tocdo_adsl where tocdo_id = ${vtocdo_id}` }).then(async (response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data.data_json
            } else return []
          }) //objCheckData.GET_DATA_SQL(@"Select sothang_sd, rc_id from {?DB2}.tocdo_adsl where tocdo_id = :tocdo_id", "tocdo_id", vtocdo_id);

          var rc_id = dt_tocdo_goicuoc[0]['RC_ID'] * 1
          var vloaicts_id = 0
          for (var index_1 = 0; index_1 < ItemList.length; index_1++) {
            if (ItemList[index_1].sFieldName == 'LOAICTS_ID') {
              if (!this.gridEditors[index_1].Value) {
                vloaicts_id = 0
              } else {
                vloaicts_id = this.gridEditors[index_1].Value * 1
              }
              break
            }
          }
          let kt_chon_goicuoc_ca = await API.post_kt_chon_goicuoc_ca(this.axios, { id: rc_id, id1: vloaicts_id }).then((response) => {
            //.post_sp_huonggiao_runsql(this.axios, { "command": `Select ${DatabaseConstants.DB2}.KT_CHON_GOICUOC_CA(${rc_id},${vloaicts_id}) kq from dual` }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data //.data_json;
            } else return response.data.message_detail
          }) //tdan.GET_VALUE_FUNC("{?DB2}.KT_CHON_GOICUOC_CA", "vrc_id", rc_id, "vloaicts_id", vloaicts_id).ToString();
          if (!kt_chon_goicuoc_ca || kt_chon_goicuoc_ca != 'ok') {
            repositoryItemLookUpEdit.Cancel = true //FIXME can xem cach cancel phan xu ly nay!
            this.$toast.error(kt_chon_goicuoc_ca)
            // return false; // FIXME Ham check nay dang loi nen comment tam lai de chay, sua xong bo comment sau.
          }
        }
      }
      return true
    },
    async repositoryItemButtonEdit_ButtonClick(repositoryItemButtonEdit) {
      try {
        var ItemList = this.ItemList
        // ButtonEdit repositoryItemButtonEdit = (sender as ButtonEdit);
        // if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_SMCC) // bo do khong co chuc nang gi
        // {

        // }
        let kt_api = await API.post_loaihinh_tb_edu_api(this.axios, { id: this.listbox.loaihinh_tb.value }).then((response) => {
          //.post_sp_huonggiao_runsql(this.axios, { "command": `Select ${DatabaseConstants.DB2}.LOAHINH_TB_EDU_API(${this.listbox.loaihinh_tb.value}) kq from dual` }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data[0] && response.data.data[0].kq ? response.data.data[0].kq : 'no' //.data_json.kq;
          } else return 'no'
        }) //tdan.GET_VALUE_FUNC("{?DB2}.LOAHINH_TB_EDU_API", "vloaitb_id", this.listbox.loaihinh_tb.value).ToString();
        if (kt_api == 'ok') {
          if (repositoryItemButtonEdit.Tag == 'SL_MAILING') {
            for (var i = 0; i < ItemList.length; i++) {
              if (ItemList[i].sFieldName == 'SL_MAILING') {
                if (this.listbox.loaihinh_tb.value == LoaiHinhTB.TTDL_HDDT) {
                  this.popupComponentData = { dsHDTB_CT: this.dsHDTB_CT, soluong: this.gridEditors[i].Value || this.gridEditors[i].Value == '' ? 0 : this.gridEditors[i].Value }
                  this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonMauHDDT')
                  this.popupComponentName = 'popupChonMauHDDT'
                  this.Popup('popupComponents')
                  break
                }
              }
            }
          }
          if (repositoryItemButtonEdit.Tag == 'MA_PHU') {
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.Voice_Brandname) {
              this.popup.DSThanhVien = true;
              if (this.buttonSet != 1)
                this.$refs.frmNhapDSThanhVien.hdtb_id = this.hdtb_id
              else
                this.$toast.error('Chưa ghi lại hợp đồng. Hãy ghi lại hợp đồng trước');
              this.$refs.frmNhapDSThanhVien._ds_hdtbct = this.dsHDTB_CT;
              this.$refs.frmNhapDSThanhVien.ShowDialog()

              // this.popupComponentData = {"hdtb_id":this.hdtb_id, _ds_hdtbct: this.dsHDTB_CT};
              // this.popupComponentData.Text = "Nhập danh sách số hiển thị";
              // this.popupComponent = ()=>import('@/modules/contract/setup/ChangeContractOwner/popup/frmNhapDSThanhVien.vue');
              // this.popupComponentName = "frmNhapDSThanhVien";
              // this.Popup('popupComponents');
            } else
              for (var i = 0; i < ItemList.length; i++) {
                if (ItemList[i].sFieldName == 'MA_PHU') {
                  if (ItemList[i].sLookupApi != '') {
                    this.popupComponentData = {
                      loaihinh_tb: this.listbox.loaihinh_tb.value,
                      field_name: ItemList[i].sFieldName,
                      api_url: ItemList[i].sLookupApi,
                      method: ItemList[i].sAPIMethod,
                      hienthi_bang: ItemList[i].sAPIHienThiBang,
                      giatri_trave: ItemList[i].sAPIValueMember,
                      ItemList: ItemList,
                      idx: i
                    }
                    if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_SLL) {
                      this.popupComponentData.Text = 'Lấy thông tin ID trường'
                    }
                    this.popupComponent = () => import('../InstallNewSubs/Popups/popupLayDuLieuTuAPI')
                    this.popupComponentName = 'popupLayDuLieuTuAPI'
                    this.Popup('popupComponents')
                  }
                  break
                }
              }
          }

          if (repositoryItemButtonEdit.Tag == 'SOLUONG') {
            for (var i = 0; i < ItemList.length; i++) {
              if (ItemList[i].sFieldName == 'SOLUONG') {
                var id_truong = ItemList.filter((x) => x.sFieldName == 'MA_PHU')[0].sValue
                var tocdo_id = ItemList.filter((x) => x.sFieldName == 'TOCDO_ID')[0].sValue
                this.popupComponentData = { id_truong: id_truong, dsHDTB_CT: this.dsHDTB_CT, tocdo_id: tocdo_id }
                this.popupComponent = () => import('../InstallNewSubs/Popups/popupDangKySoLienLac')
                this.popupComponentName = 'popupDangKySoLienLac'
                this.Popup('popupComponents')
              }
            }
          }
        }

        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNEDU_SMARTID) {
          if (repositoryItemButtonEdit.Tag == 'SL_MAILING') {
            for (var i = 0; i < ItemList.length; i++) {
              if (ItemList[i].sFieldName == 'SL_MAILING') {
                this.popupComponentData = { loaitb_id: this.listbox.loaihinh_tb.value, append_name: 'SL_MAILING', saveList: this.dsHDTB_CT, ItemList: ItemList }
                this.popupComponent = () => import('../InstallNewSubs/Popups/popupChiTietHDTB')
                this.popupComponentName = 'popupChiTietHDTB'
                this.Popup('popupComponents')
              }
            }
          }
        }

        if (repositoryItemButtonEdit.Tag == 'MATB_TN') {
          var kieu = await API.post_fn_tt_kieu_ld(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, param: this.thongso_tc.kieuld_id })
            .then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data
              } else return 0
            })
            .catch(() => {
              return 0
            }) //this.kieu_ld_kieu;
          var dulieu = {}
          switch (kieu * 1) {
            case 2:
              if (this.khachhang.khachhang_id && this.khachhang.khachhang_id > 0) {
                dulieu.khachhang_id = this.khachhang.khachhang_id
                dulieu.kieuld_id = this.listbox.kieu_ld.value
                dulieu.loaitb_id = this.listbox.loaihinh_tb.value
                dulieu.dichvuvt_id = this.listbox.dichvu_vt.value
                this.popupComponentData = dulieu
                this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBCungDoiCap')
                this.popupComponentName = 'popupDSTBCungDoiCapCNTT'
                this.popupRetVal = null
                this.Popup('popupComponents')
                let xlykq = setInterval(() => {
                  if (this.popupRetVal) {
                    clearInterval(xlykq)
                    for (var i = 0; i < ItemList.length; i++) {
                      if (ItemList[i].sFieldName == 'MATB_TN') {
                        ItemList[i].sValue = this.popupRetVal.MA_TB
                        this.gridEditors[i].Value = this.popupRetVal.MA_TB
                        repositoryItemButtonEdit.Text = this.popupRetVal.MA_TB
                      }
                      if (ItemList[i].sFieldName == 'MADOICAP') {
                        ItemList[i].sValue = this.popupRetVal.MADOICAP
                        this.gridEditors[i].Value = this.popupRetVal.MADOICAP
                      }
                    }
                    // grcMacdinh.RefreshDataSource();
                  }
                }, 1000)
              } else {
                this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp trên đường có sẵn !')
                return
              }
              break
            case 1:
            case 3:
              if (this.khachhang.hdkh_id && this.khachhang.hdkh_id > 0) {
                dulieu.hdkh_id = this.khachhang.hdkh_id
                dulieu.vkhachhang_id = this.khachhang.khachhang_id
                dulieu.vkieuld_id = this.listbox.kieu_ld.value
                dulieu.loaitb_id = this.listbox.loaihinh_tb.value
                this.popupComponentData = dulieu
                this.popupComponent = () => import('../InstallNewSubs/Popups/popupDSTBLapKem')
                this.popupComponentName = 'popupDSTBLapKemCNTT'
                this.popupRetVal = null
                this.Popup('popupComponents')
                let xlykq = setInterval(() => {
                  if (this.popupRetVal) {
                    clearInterval(xlykq)
                    if (this.popupRetVal.MA_TB)
                      for (var i = 0; i < ItemList.length; i++) {
                        if (ItemList[i].sFieldName == 'MATB_TN') {
                          ItemList[i].sValue = this.popupRetVal.MA_TB
                          this.gridEditors[i].Value = this.popupRetVal.MA_TB
                          repositoryItemButtonEdit.Text = this.popupRetVal.MA_TB
                        }
                        if (ItemList[i].sFieldName == 'MADOICAP') {
                          ItemList[i].sValue = this.popupRetVal.MADOICAP
                          this.gridEditors[i].Value = this.popupRetVal.MADOICAP
                        }
                      }
                    else if (kieu * 1 == 3) {
                      for (var i = 0; i < ItemList.length; i++) {
                        if (ItemList[i].sFieldName == 'MATB_TN') {
                          ItemList[i].sValue = ''
                          this.gridEditors[i].Value = ''
                          repositoryItemButtonEdit.Text = ''
                        }
                        if (ItemList[i].sFieldName == 'MADOICAP') {
                          ItemList[i].sValue = '0'
                          this.gridEditors[i].Value = '0'
                        }
                      }
                      // grcMacdinh.RefreshDataSource();
                    }
                    // grcMacdinh.RefreshDataSource();
                  }
                }, 1000)
              } else {
                this.$toast.error('Chưa có thông tin thuê  bao để lấy danh sách mã truy nhập lắp kèm !')
                return
              }
              break
          }
        }

        if (repositoryItemButtonEdit.Tag == 'THONGTIN_CT' && this.listbox.loaihinh_tb.value == LoaiHinhTB.IT_CARE) {
          this.popupComponentData = { vloaitb_id: this.listbox.loaihinh_tb.value, vhdtb_id: this.hdtb_id, vappend_name: repositoryItemButtonEdit.Tag }
          this.popupComponent = () => import('../InstallNewSubs/Popups/popupHDTB_CNTT_SUB')
          this.popupComponentName = 'popupHDTB_CNTT_SUB'
          this.Popup('popupComponents')
        }

        if (repositoryItemButtonEdit.Tag == 'DONGIA' || repositoryItemButtonEdit.Tag == 'DINHMUC_SMS' || repositoryItemButtonEdit.Tag == 'DOITAC' || repositoryItemButtonEdit.Tag == 'DINHMUC_LL' || repositoryItemButtonEdit.Tag == 'DINHTUYEN') {
          if (this.hdtb_id != 0) {
            // && loaihinh_tb == this.listbox.loaihinh_tb.value) // dieu kien 2 nay luon dung, khong xu ly
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_SMCC) {
              if (repositoryItemButtonEdit.Tag == 'DOITAC') {
                this.popupComponentData = { loaitb_id: this.listbox.loaihinh_tb.value, append_name: 'DOITAC', saveList: this.dsHDTB_CT, ItemList: ItemList }
                this.popupComponent = () => import('../InstallNewSubs/Popups/popupChiTietHDTB')
                this.popupComponentName = 'popupChiTietHDTB' // Chung code xu ly voi ham phia tren do do khong can code doan nay.
                this.Popup('popupComponents')
              }
            } else {
              this.popupRetVal = null
              this.popupComponentData = { vloaitb_id: this.listbox.loaihinh_tb.value, vhdtb_id: this.hdtb_id, vappend_name: repositoryItemButtonEdit.Tag }
              this.popupComponent = () => import('../InstallNewSubs/Popups/popupHDTB_CNTT_SUB')
              this.popupComponentName = 'popupHDTB_CNTT_SUB'
              this.Popup('popupComponents')
              let xlykq = setInterval(() => {
                if (this.popupRetVal) {
                  clearInterval(xlykq)
                  if ((this.listbox.loaihinh_tb.value == LoaiHinhTB.TD_1800 || this.listbox.loaihinh_tb.value == LoaiHinhTB.TD_1900) && this.thamsomacdinh['TRIENKHAI_1800_1900'] == 1) {
                    let tien_ld = this.popupRetVal.tien_ld
                    for (var item of this.ds_tien_khoanmuc) {
                      if (item['khoanmuctt_id'] == 142) {
                        //Cước Cài Đặt Đầu Số 1800 - 1900
                        if (tien_ld != '-1') {
                          item['tien'] = tien_ld
                          item['vat'] = tien_ld * 0.1
                          //HienThiTienKhuyenMaiLapDat(dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt);
                          this.HienThiTienKhuyenMaiLapDat()
                          this.LayTongTien_HDTB()
                        }
                      }
                    }
                  }
                }
              }, 1000)
            }
          }
        }
        if (repositoryItemButtonEdit.Tag == 'CT_DIEMCAU') {
          if (this.hdtb_id != 0) {
            this.popupComponentData = { vhdtb_id: this.hdtb_id, vhdkh_id: this.khachhang.hdkh_id, ma_gd: this.khachhang.magd, vloaitb_id: this.listbox.loaihinh_tb.value }
            this.popupComponent = () => import('../InstallNewSubs/Popups/popupDanhSach_DiemCau')
            this.popupComponentName = 'popupDanhSach_DiemCau'
            this.Popup('popupComponents')
            //khong thay xu ly sau khi dong popup -> chua lam gi!
          }
        }

        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.TD_1800 || this.listbox.loaihinh_tb.value == LoaiHinhTB.TD_1900) {
          if (repositoryItemButtonEdit.Tag == 'MA_TB') {
            var vsomay = ''
            for (var i = 0; i < ItemList.length; i++) {
              if (ItemList[i].sFieldName == 'MA_TB') {
                vsomay = ItemList[i].sValue
              }
            }

            this.popupComponentData = {
              vloaitb_id: Number(this.listbox.loaihinh_tb.value),
              vdichvuvt_id: Number(this.listbox.dichvu_vt.value),
              vsomay: vsomay
            }
            this.popupComponent = () => import('@/modules/contract/setup/InstallNewSubs/Popups/popupChonSo_CNTT')
            this.popupComponentName = 'popupChonSo_CNTT'
            this.popupComponentHeader = ''
            this.Popup('popupComponents')
          }
        }
      } catch (ex) {
        this.$toast.error('Có lỗi: ' + ex)
      }
    },
    async Init_Properties(vloaitb_id, table_name, opt_list) {
      return await API.post_lay_danhsach_thuoctinh_datmoi(this.axios, {
        vloaitb_id: vloaitb_id,
        vopt_list: opt_list,
        vten_bang: table_name
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          var ds = response.data.data
          this.ItemList = []
          for (var row of ds) {
            var item = {}
            item.sFieldName = row['field_name']
            item.sCaption = row['ten_hienthi']
            item.iAtt = row['att']
            item.iDataType = row['data_type']
            item.sMaxValue = row['max_value']
            item.sMinvalue = row['min_value']
            item.sLookupApi = row['lookup_api'] ? row['lookup_api'] : ''
            item.sAPIDisplayMember = row['api_display_member'] ? row['api_display_member'] : ''
            item.sAPIValueMember = row['api_value_member'] ? row['api_value_member'] : ''
            item.sAPIHienThiBang = row['api_hienthi_bang'] ? row['api_hienthi_bang'] : ''
            item.sAPIMethod = row['api_method'] ? row['api_method'] : ''
            item.sReadOnly = row['read_only']
            item.sValue = row['field_value']
            item.nFieldLength = row['field_length'] ? row['field_length'] : 0
            item.bIsNotNull = row['field_nullable'] && row['field_nullable'] == 0 ? true : false
            item.bIsUnique = row['field_unique'] && row['field_unique'] == 0 ? true : false
            item.sLookUpTableName = row['parent_table']
            item.sLookUpKeyField = row['parent_keyfield']
            item.sLookUpValueField = row['parent_descfield']
            item.strDepandField = row['depend_field']
            item.StrSql = row['lookup_sql']
            if (row['lookup_sql_response']) item.SqlData = this.UpperCasePropertyList(row['lookup_sql_response'])
            this.ItemList.push(item)
          }
          return this.ItemList //response.data.data;
        } else return []
      })
    },
    ReplaceSQL(sql) {
      sql = sql.Replace('{?DB4}', DatabaseConstants.DB4)
      sql = sql.Replace('{?DB3}', DatabaseConstants.DB3)
      sql = sql.Replace('{?DB2}', DatabaseConstants.DB2)
      sql = sql.Replace('{?DB1}', DatabaseConstants.DB1)
      sql = sql.Replace('\n', ' ')
      sql = sql.Replace('\r', ' ')
      sql = sql.Replace('\t', ' ')

      return sql
    },
    async ReturnSqlStr(ListItem, index) {
      var s = ''
      switch (ListItem[index].sLookUpTableName) {
        case 'PHANLOAI_DV':
          s = 'select ' + ListItem[index].sLookUpKeyField + ',' + ListItem[index].sLookUpValueField + ' from ' + DatabaseConstants.DB2 + '.' + ListItem[index].sLookUpTableName + ' WHERE LOAITB_ID = ' + this.listbox.loaihinh_tb.value + ' ORDER BY ' + ListItem[index].sLookUpKeyField
          break
        case 'TOCDO_ADSL':
          s = 'Select TOCDO_ID, THUONGHIEU FROM ' + DatabaseConstants.DB2 + '.' + ListItem[index].sLookUpTableName
          s += ' WHERE SUDUNG = 1 and LOAITB_ID = ' + this.listbox.loaihinh_tb.value
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.Web_Hosting || this.listbox.loaihinh_tb.value == LoaiHinhTB.CA || this.listbox.loaihinh_tb.value == LoaiHinhTB.CA_IVAN || this.listbox.loaihinh_tb.value == LoaiHinhTB.IVAN || this.listbox.loaihinh_tb.value == LoaiHinhTB.IOFFICE)
            for (var type of ListItem) if (type.sFieldName == 'DAILY') s += ' and kieu_mega in (2,' + type.sValue + ')'
          let pdata = { loaitb_id: this.listbox.loaihinh_tb.value }
          let checkTD = await API.post_dvcntt_tocdo_adsl(this.axios, pdata).then((response) => {
            //.post_sp_huonggiao_runsql(this.axios, { "command": `select ${DatabaseConstants.DB2}.TOCDO_LOADTHEO_PHANLOAI(${this.listbox.loaihinh_tb.value}) kq from dual` }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data //.data_json;
            } else return []
          })
          if (checkTD && checkTD.length > 0 && checkTD[0].kq && checkTD[0].kq == 'ok')
          for (let type of ListItem)
              if (type.sFieldName == 'PHANLOAI_ID' || (type.sFieldName == 'LOAICTS_ID' && this.listbox.loaihinh_tb.value == LoaiHinhTB.SMART_CA)) {
                pdata.kieu_mega = !type.sValue || type.sValue == '' ? -10 : type.sValue
                s += ' and kieu_mega = ' + (!type.sValue || type.sValue == '' ? -10 : type.sValue)
              }
          s += ' ORDER BY TOCDO_ID'
          let checkData = await API.post_lay_tt_tocdo_adsl(this.axios, pdata).then((response) => {
            //.post_sp_huonggiao_runsql(this.axios, { "command": `select ${DatabaseConstants.DB2}.TOCDO_LOADTHEO_PHANLOAI(${this.listbox.loaihinh_tb.value}) kq from dual` }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data //.data_json;
            } else return []
          })
          if (checkData && checkData.length > 0) {
            ListItem[index].SqlData = this.UpperCasePropertyList(checkData)
            if (!ListItem[index].sValue || ListItem[index].sValue == '' || !ListItem[index].SqlData.find((x) => x[ListItem[index].sLookUpKeyField] == ListItem[index].sValue)) ListItem[index].sValue = ListItem[index].SqlData[0][ListItem[index].sLookUpKeyField]
            if (this.gridEditors[index]) {
              let valuechanged = this.gridEditors[index].Value != ListItem[index].sValue
              this.gridEditors[index].Value = ListItem[index].sValue //ListItem[index].SqlData[0][ListItem[index].sLookUpKeyField]; // Chỗ này có lẽ sau xử lý theo datasource thì hay hơn, nhưng tạm thời chưa lỗi thì cứ để vậy đã
              if (valuechanged && this.gridEditors[index].EditValueChanged) this.gridEditors[index].EditValueChanged(this.gridEditors[index])
            }
          }

          break
        case 'HE_DIEU_HANH':
          for (var type of ListItem) {
            if (type.sFieldName == 'TOCDO_ID') {
              if (!type.sValue || type.sValue == '') {
                s = 'select ' + ListItem[index].sLookUpKeyField + ',' + ListItem[index].sLookUpValueField + ' from ' + DatabaseConstants.DB2 + '.' + ListItem[index].sLookUpTableName + ' ORDER BY ' + ListItem[index].sLookUpKeyField
              } else {
                s = 'select a.hedieuhanh_id, a.he_dieu_hanh  '
                s += ' from ' + DatabaseConstants.DB2 + '.he_dieu_hanh a, ' + DatabaseConstants.DB2 + '.hdh_tocdo b '
                s += ' where a.hedieuhanh_id = b.hedieuhanh_id '
                s += ' and b.tocdo_id = ' + type.sValue
                s += ' order by a.hedieuhanh_id '
              }
            }
          }
          break
        case 'ABC':
          s = 'Select vungpv_id, tenvung_pv FROM ' + DatabaseConstants.DB5 + ".vungphucvu WHERE trangthai='1' order by tenvung_pv"
          break
        case 'DUNGLUONG':
          s = 'Select DUNGLUONG AS MA_SO,DUNGLUONG AS TEN from ' + DatabaseConstants.DB5 + '.DUNGLUONG order by to_number(ten)'
          break
        case 'TUYEN_CAP':
          s = 'Select tuyencap_id, tuyen_cap from ' + DatabaseConstants.DB5 + '.' + ListItem[index].sLookUpTableName
          break
        case 'TUYEN_CB':
          s = 'Select tuyencb_id, tuyen_cb from ' + DatabaseConstants.DB5 + '.' + ListItem[index].sLookUpTableName
          break
        case 'TUYEN_COT':
          s = 'Select tuyencot_id, tuyen_cot from ' + DatabaseConstants.DB5 + '.' + ListItem[index].sLookUpTableName
          break
        case '{?CSS}.LINHVUC':
          s = 'Select linhvuc_id, linhvuc from ' + DatabaseConstants.DB2 + ".LINHVUC where phanloai_sms is null or phanloai_sms like '%" + this.PhanLoai_ID + "%'" //PhanLoai_ID
          break
        default:
          s = 'select ' + ListItem[index].sLookUpKeyField + ',' + ListItem[index].sLookUpValueField + ' from ' + ListItem[index].sLookUpTableName
          break
      }
      s = s.replace('{?ADMIN}', DatabaseConstants.DB1)
      s = s.replace('{?CSS}', DatabaseConstants.DB2)
      return s
    },
    async LAY_DS_DVGT_MACDINH() {
      var i_tocdo_id = 0
      var linhvuc_id = 0
      this.m_dsThueBao_DichVu = [];
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.BRANDNAME) {
        //SMS Brandname
        if (this.gridEditors == null) return
        // grvMacdinh.CloseEditor();
        for (var index = 0; index < this.gridEditors.length; ++index) {
          if (this.gridEditors[index].ID == 'LINHVUC_ID')
            if (this.gridEditors[index].Value && this.gridEditors[index].Value != '') {
              linhvuc_id = this.gridEditors[index].Value * 1
              break
            }
        }
        this.m_dsThueBao_DichVu = await API.post_sp_lay_ds_thuebao_dichvu_linhvuc(this.axios, {
          hdtb_id: this.hdtb_id,
          thuebao_id: 0,
          loaitb_id: this.listbox.loaihinh_tb.value,
          linhvuc_id: linhvuc_id,
          kieu_id: 1
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data //.data_json;
          } else return []
        });
        // m_dsThueBao_DichVu = tchopdong.LAY_DS_THUEBAO_DICHVU_LINHVUC_V2(hdtb_id, 0, this.listbox.loaihinh_tb.value, linhvuc_id, 1);
      } else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VN_EDU || this.listbox.loaihinh_tb.value == LoaiHinhTB.VCC) {
        if (this.gridEditors == null) return
        // grvMacdinh.CloseEditor();
        for (var index = 0; index < this.gridEditors.length; ++index) {
          if (this.gridEditors[index].ID == 'TOCDO_ID')
            if (this.gridEditors[index].Value && this.gridEditors[index].Value != '') {
              i_tocdo_id = this.gridEditors[index].Value * 1
              this.tocdo_id = i_tocdo_id
              break
            }
        }
        this.m_dsThueBao_DichVu = await API.post_lay_ds_thuebao_dichvu_tocdo(this.axios, {
          vhdtb_id: this.hdtb_id,
          vthuebao_id: 0,
          vloaitb_id: this.listbox.loaihinh_tb.value,
          vtocdo_id: i_tocdo_id,
          vkieu_id: 1
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data //.data_json;
          } else return []
        });
        // m_dsThueBao_DichVu = tchopdong.LAY_DS_THUEBAO_DICHVU_TOCDO(hdtb_id, 0, this.listbox.loaihinh_tb.value, i_tocdo_id, 1);
      } else {
        var tbdv = await API.post_lay_ds_thuebao_dichvu(this.axios, {
          // tinhthicong_id: this.$root.token.getPhanVungID(),
          hdtbId: 0,
          thueBaoId: 0,
          loaiTbId: this.listbox.loaihinh_tb.value,
          vkieu_id: 1
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data //.data_json;
          } else return []
        });
        var temp = await API.post_lay_ds_thuebao_dichvu_bc(this.axios, {
          tinhthicong_id: this.tinh.tinhthicong_id,
          vhdtb_id: 0,
          vthuebao_id: 0,
          vloaitb_id: this.listbox.loaihinh_tb.value,
          vkieu_id: 1
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data //.data_json;
          } else return []
        });
        for(var i=0; i<temp.length; i++)
        {
          temp[i].bancheo = 1;
          // this.m_dsThueBao_DichVu.push(temp[i]);
        }
        this.m_dsThueBao_DichVu = [...tbdv,...temp];
        //m_dsThueBao_DichVu = tchopdong.LAY_DS_THUEBAO_DICHVU(hdtb_id, 0, loaitb_id, 1);
        // m_dsThueBao_DichVu = tchopdong.LAY_DS_THUEBAO_DICHVU(0, 0, loaitb_id, 1);
      }
      this.m_dsThueBao_DichVu = this.LowerCasePropertyList(this.m_dsThueBao_DichVu);
      // this.m_dsThueBao_DichVu = await API.post_fn_lay_ds_dvgt_macdinh_bc(this.axios, { ds_para: JSON.stringify({ LOAITB_ID: this.listbox.loaihinh_tb.value, HDTB_ID: this.hdtb_id, LINHVUC_ID: linhvuc_id, I_TOCDO_ID: i_tocdo_id }) }).then(async (response) => {
      //   if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //     var apidata = JSON.parse(response.data.data)
      //     if (apidata['ERROR_CODE'] == 1) return apidata['RESULT']['DS_TB_DICHVU']
      //     else {
      //       this.$toast.error(apidata['MESSAGE'])
      //       return []
      //     }
      //   } else return []
      // })
      await this.HT_DichVuGT()
    },
    async LAY_DS_DVK_MACDINH_TB() {
      API.post_lay_ds_dvk_macdinh(this.axios, { vloaiid: 1, vloaitb_id: this.listbox.loaihinh_tb.value }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.dsDK_DVK_TB = []
          let ds = response.data.data
          for (var i = 0; i < ds.length; i++) {
            let row = {}
            row.DVKHAC_ID = ds[i]['dvkhac_id'] * 1
            row.KIEU_YC = ds[i]['caidat_md'] * 1
            row.TTTH = TrangThaiCaiDat.MOI
            row.HD_ID = this.hdtb_id
            row.NGAY_YC = this.NgayYeuCau
            row.LOAIID = ds[i]['loaiid'] * 1
            this.dsDK_DVK_TB.push(row)
          }
          this.HT_DichVuKhac(this.dsDK_DVK_TB, 1)
        }
      })
    },
    async Delete_HD_ChuyenTinh_VinaPhone(so_tb) {
      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      var status = false
      try {
        if (!this.tt_nd.user_neo) {
          return 'Thông tin người dùng chưa đồng bộ với dữ liệu VinaPhone. Bạn không thể tiếp tục cập nhật dữ liệu.'
        }

        var thuebao_id_neo = ''
        var dt = []
        await API.post_ts_laphd_chuyentinh_laytt_tb(this.axios, {
          tracuu_hd: '1',
          ma_tinh: this.tt_nd.tentat_ccbs,
          so_tb: so_tb
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            dt = response.data.data
          }
        }) //new CCBSFacade().ts_laphd_chuyentinh_laytt_tb("1", tt_nd.tentat_ccbs, so_tb);
        if (dt != null && dt.length > 0 && Object.keys(dt[0]).indexOf('TRANG_THAI') >= 0 && Object.keys(dt[0]).indexOf('THUEBAO_ID') >= 0) {
          thuebao_id_neo = dt[0]['THUEBAO_ID']
        } else {
          return 'Có lỗi trong khi lấy thông tin thuê bao từ vinaphone ts_laphd_chuyentinh_laytt_tb '
        }

        var rs = []
        await API.post_ts_laphd_chuyentinh_del_thuebao_cts(this.axios, {
          ma_tinh: this.tt_nd.tentat_ccbs,
          thuebao_id: thuebao_id_neo,
          userip: await this.$root.token.getIP(),
          userid: this.tt_nd.user_neo
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            rs = response.data.data
            if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;
          }
          rs.Message = response.data.message;
        }) //new CCBSFacade().ts_laphd_chuyentinh_del_thuebao_cts(tt_nd.tentat_ccbs, thuebao_id_neo, tt_nd.ip, tt_nd.USER_NEO);
        if (!rs.IssSuccessed) return 'Lỗi xảy ra khi xóa thuê bao lên Vinaphone.' + rs.Message
      } catch (ex) {
        // status = false;
        // strError_VinaPhone = ex.Message;
        return 'Lỗi xảy ra khi cập nhật thuê bao lên Vinaphone.' + ex
      }
      this.$toast.success('Thành công', `Xóa hợp đồng chuyển tỉnh của thuê bao ${so_tb} trên VinaPhone thành công!`)
      return 'OK'
    },
    async btnHoSo_Click() {
      this.popupInBienBan_Param.hdkh_id = this.khachhang.hdkh_id
      this.popupInBienBan_Param.ma_gd = this.khachhang.magd
      this.popupInBienBan_Param.ngay_yc = this.NgayYeuCau
      this.popupInBienBan_Param.ngay_lhd = this.NgayLapHD
      this.$refs.popupInBienBan.showModal()
    },
    async LoadTuHopDongB2A() {
      // if(this.$route.query.phieucskh_id && this.$route.query.phieucskh_id.trim()!='') this.VPHIEUCSKH_ID = this.$route.query.phieucskh_id;
      // if(this.$route.query.phieucskhdv_id && this.$route.query.phieucskhdv_id.trim()!='') this.phieucskhdv_id = this.$route.query.phieucskhdv_id;
      var VPHIEUCSKH_ID = this.VPHIEUCSKH_ID
      var VPHIEUCSKHDV_ID = this.phieucskhdv_id
      try {
        this.buttonSet = 1
        // Lấy thông tin từ B2A
        var d = await API.post_fn_lay_tt_tu_hd_b2a(this.axios, {
          ds_para: JSON.stringify({ PHIEUCSKH_ID: VPHIEUCSKH_ID })
        }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            var apidata = response.data.data
            if (apidata['ERROR_CODE'] != 1) {
              this.$toast.error(apidata['MESSAGE'])
              return {}
            } else return apidata['RESULT']
          }
        }) //bangts.GetDataSql("select * from " + DatabaseConstants.DB2 + ".phieu_cskh where phieucskh_id =" + phieucskh_id);
        if (d.KHACHHANG_ID && d.KHACHHANG_ID != 0 && d.KHACHHANG_ID != '' && d.KHACHHANG_ID != -1) {
          this.khachhang.khachhang_id = d.KHACHHANG_ID
          this.khachhang.makh = d.MA_KH
          this.MaKHChanged()
        } else {
          if (d.TEN_KH) {
            this.khachhang.tenkh = d.TEN_KH
            this.tenKHChanged()
          }
          if (d.DIENTHOAI) this.khachhang.dienthoai = d.DIENTHOAI
          var diachi = {} // this.getDiaChiKH({'diachimoi':d.DIACHI_KH});
          if (d.DIACHI_KH) diachi.diachimoi = d.DIACHI_KH
          else diachi.diachimoi = ''
          if (d.TINH_ID) diachi.tinh_id = d.TINH_ID
          else diachi.tinh_id = 0
          if (d.QUAN_ID) diachi.quan_id = d.QUAN_ID
          else diachi.quan_id = 0
          if (d.PHUONG_ID) diachi.phuong_id = d.PHUONG_ID
          else diachi.phuong_id = 0
          if (d.PHO_ID) diachi.pho_id = d.PHO_ID
          else diachi.pho_id = 0
          if (d.KHU_ID) diachi.khu_id = d.KHU_ID
          else diachi.khu_id = 0
          if (d.AP_ID) diachi.ap_id = d.AP_ID
          else diachi.ap_id = 0
          if (d.SONHA) diachi.so_nha = d.SONHA
          else diachi.so_nha = ''
          if (d.BLOCK) diachi.block = d.BLOCK
          if (d.TANG) diachi.tang = d.TANG
          if (d.PHONG) diachi.sophong = d.PHONG
          if (d.MOTA) diachi.motathem = d.MOTA
          if (d.VIDO) diachi.lat = d.VIDO
          else diachi.lat = 0
          if (d.KINHDO) diachi.lng = d.KINHDO
          else diachi.lng = 0
          if (diachi.tinh_id > 0 && diachi.quan_id > 0) this.getDiaChiKH(diachi)
          // Load thông tin theo số giấy tờ
          if (d.LOAIGT_ID) this.listbox.loai_gt.value = d.LOAIGT_ID
          if (d.SO_GT) this.khachhang.sogt = d.SO_GT
          if (d.NGAYCAP) this.NgayCap = moment(d.NGAYCAP).format('DD/MM/YYYY')
          if (d.NOICAP) this.khachhang.noicap = d.NOICAP
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async tsbtnSuaKM_Click() {
      if (this.hdtb_id == 0) {
        this.$toast.error('Bạn phải lấy thông tin hợp đồng trước khi sửa khuyến mại!')
        return
      }

      if (this.hc_hdtb_id != 0 && this.hc_hdtb_id != this.hdtb_id) {
        this.$toast.error('Không đúng thuê bao cần hiệu chỉnh. Bạn hãy kiểm tra lại!')
        return
      }

      if (!(await this.KIEMTRA_SUAKM())) return

      // //tien tra gop luu 1 lan thoi
      var blKiemTraTraGop = false
      // //longdx: bo sung thong tin hdtb_id vao bang khuyenmai, dat coc
      //FIXME doan nay co ve sai vi prop phan lon la lowercase!!!
      for (var row of this.dsDC_HDTB) {
        row.HDTB_ID = this.hdtb_id
        row.TIEN_TG = this.TongTien_TG(row.CHITIETKM_ID)
        if (row.TIEN_TG > 0) blKiemTraTraGop = true
      }
      for (var row of this.dsKM_HDTB) {
        row.HDTB_ID = this.hdtb_id
        if (!blKiemTraTraGop) row.TIEN_TG = this.TongTien_TG(row.CHITIETKM_ID)
      }
      try {
        //nếu tiền thay đổi thì phải update tiền
        var update_tien = false
        var vphieutt_id = -1
        if (!this.kiemtra_khoanmuc_tien()) {
          var cfr = await this.$bvModal
            .msgBoxConfirm('Tiền hợp đồng đã thay đổi, bạn có muốn tiếp tục cập nhật?', {
              title: 'Xác nhận hành động',
              size: 'sm',
              okTitle: 'Đồng ý',
              cancelTitle: 'Hủy'
            })
            .then(async (v) => {
              return v
            })

          if (!cfr) {
            return
          }
          var ds = await API.post_lay_ds_phieu_chuatt(this.axios, {
            vhdtb_id: this.hdtb_id
          }).then(async (response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            }
          }) //new TCHopDongFacade().lay_ds_phieu_chuatt(hdtb_id);
          if (ds > 0) {
            if (ds.length == 0) {
              this.$toast.error('Hợp đồng đã thoái trả, không thể sửa tiền!')
              return
            }
            if (ds[0]['trangthai'] == 1) {
              cfr = await this.$bvModal
                .msgBoxConfirm('Phiếu thanh toán đã thu tiền sẽ chuyển thành trạng thái chưa thu tiền và hủy hóa đơn cũ, bạn có muốn sửa?', {
                  title: 'Xác nhận hành động',
                  size: 'sm',
                  okTitle: 'Đồng ý',
                  cancelTitle: 'Hủy'
                })
                .then(async (v) => {
                  return v
                })
              if (!cfr) return
            }
            vphieutt_id = ds[0]['phieutt_id'] ? ds[0]['phieutt_id'] : -1
          } else {
            this.$toast.error('Không thể lấy thông tin phiếu thanh toán, xin thử lại sau!')
            return
          }
          update_tien = true
          await this.TaoDuLieu_CT_TIENHD(true)
        }

        if (this.thamsomacdinh['KIEMTRA_KHOP_TIEN_DATCOC'] == 1) {
          var tien_tratruoc = 0
          var tien_datcoc = 0
          for (var i = 0; i < this.ds_tien_khoanmuc.length; i++) {
            if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC) {
              tien_tratruoc = this.ds_tien_khoanmuc[i]['tien'] * 1 + this.ds_tien_khoanmuc[i]['vat'] * 1
            }
          }

          for (var dc1 = 0; dc1 < this.dsKM_HDTB.length; dc1++) {
            tien_datcoc += this.dsKM_HDTB[dc1]['datcoc_csd'] * 1
          }

          for (var dc2 = 0; dc2 < this.dsDC_HDTB.length; dc2++) {
            tien_datcoc += this.dsDC_HDTB[dc2]['datcoc_csd'] * 1
          }

          if (tien_tratruoc != tien_datcoc) {
            this.$toast.error('Tiền đặt cọc và tiền khoản mục không khớp. Liên hệ admin để kiểm tra lại! ')
            return
          }
        }
        var ds_tb_hddt_1 = null
        var ds_tb_hddt_2 = null
        var sErr = ''
        await API.post_fn_sua_tt_khuyenmai(this.axios, {
          ds_para: JSON.stringify({
            HC_HDTB_ID: this.hc_hdtb_id,
            HC_TDTT_HDTB_ID: this.hc_tdtt_hdtb_id,
            NGUOIDUNG_ID: this.$root.token.getNguoiDungID(),
            MAY_CN: this.tt_nd.may_cn,
            NGUOI_CN: this.$root.token.getUserName(),
            HDKH_ID: this.khachhang.hdkh_id,
            HDTB_ID: this.hdtb_id,
            JS_KHUYENMAI_HDTB: this.dsKM_HDTB && this.dsKM_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsKM_HDTB) : this.dsKM_HDTB,//this.dsKM_HDTB,
            JS_DATCOC_HDTB: this.dsDC_HDTB && this.dsDC_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsDC_HDTB) : this.dsDC_HDTB,//this.dsDC_HDTB,
            JS_CT_TIENHD: this.dsCTTHD,
            PHIEUTT_ID: vphieutt_id,
            SUA_TIEN: update_tien ? 1 : 0,
            MA_ND: this.$root.token.getMaNhanVien()
          })
        }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            var apidata = response.data.data
            if (apidata['ERROR_CODE'] != 1) {
              sErr = this.$toast.error(apidata['MESSAGE'])
            } else apidata = apidata['RESULT']

            if (apidata && apidata['DS_HDDT_OLD']) ds_tb_hddt_1 = apidata['DS_HDDT_OLD']
            if (apidata && apidata['DS_HDDT_NEW']) ds_tb_hddt_2 = apidata['DS_HDDT_NEW']
          }
        })
        var shddt = this.phathanh_hddt_dieuchinh_td(ds_tb_hddt_1, ds_tb_hddt_2)
        if (shddt != 'OK') {
          throw (shddt)
        } else if (sErr == '') {
          this.$toast.success('Cập nhật thành công')

          if (this.hc_hdtb_id != 0 && this.hc_tdtt_hdtb_id != 0) {
            API.post_sp_capnhat_tdtt_hd_thuebao(this.axios, {
              hdtb_id: this.hc_hdtb_id,
              kq_th: 1,
              ma_nd: this.$root.token.getMaNhanVien(),
              may_cn: this.tt_nd.may_cn,
              nd_thuchien: 'Thực hiện xong',
              tthc_id: 6
            }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.$emit('form-close', null)
              } else this.$toast.error(response.data.message + response.data.message_detail)
            })
            return
          }

          this.MaGDChanged() //txtMaGD_KeyPress(txtMaGD, new KeyPressEventArgs(Convert.ToChar(Keys.Enter)));
        } else {
          throw (sErr)
        }

        if (this.hc_hdtb_id != 0 && this.hc_tdtt_hdtb_id != 0) {
          API.post_sp_capnhat_tdtt_hd_thuebao(this.axios, {
            hdtb_id: this.hc_hdtb_id,
            kq_th: 1,
            ma_nd: this.$root.token.getMaNhanVien(),
            may_cn: this.tt_nd.may_cn,
            nd_thuchien: 'Thực hiện xong',
            tthc_id: 6
          }).then(async (response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              this.$emit('form-close', null)
            } else this.$toast.error(response.data.message + response.data.message_detail)
          })
        }
      } catch (ex) {
        this.$toast.error('Cập nhật thất bại!' + ex)
      }
    },
    async KIEMTRA_SUAKM() {
      try {
        tdan = {}
        var tt_stb = -1
        var km_stb = -1
        var list_ctkm_id = '-1'
        try {
          if (this.filterbox.tratruoc.ischecked)
            //chkTraTruoc.Checked)
            tt_stb = this.filterbox.tratruoc.value ? this.filterbox.tratruoc.value : -1
        } catch (ex) {
          tt_stb = -1
        }

        try {
          if (this.filterbox.khuyenmai.ischecked)
            //chkKhuyenMai.Checked)
            km_stb = this.filterbox.khuyenmai.value ? this.filterbox.khuyenmai.value : -1
        } catch (ex) {
          km_stb = -1
        }
        if ((this.dsDC_HDTB && this.dsDC_HDTB.length > 0) || (this.dsKM_HDTB && this.dsKM_HDTB.length > 0))
          //(dsDC_HDTB.KHUYENMAI_HDTB.Rows.Count > 0 || dsKM_HDTB.KHUYENMAI_HDTB.Rows.Count > 0)
          list_ctkm_id = []

        // var xdoc = new XmlDocument();
        // var ds = xdoc.CreateElement("ds");
        // xdoc.AppendChild(ds);

        for (var row of this.dsDC_HDTB) {
          list_ctkm_id.push({ CHITIETKM_ID: row.chitietkm_id })
          // var vt = xdoc.CreateElement("vt");
          // ds.AppendChild(vt);

          // var a = xdoc.CreateAttribute("ctkm_id");
          // a.Value = row.CHITIETKM_ID.ToString();
          // vt.Attributes.Append(a);
        }
        for (var row of this.dsKM_HDTB) {
          list_ctkm_id.push({ CHITIETKM_ID: row.chitietkm_id })
          // var vt = xdoc.CreateElement("vt");
          // ds.AppendChild(vt);

          // var a = xdoc.CreateAttribute("ctkm_id");
          // a.Value = row.CHITIETKM_ID.ToString();
          // vt.Attributes.Append(a);
        }
        var temp = ''
        if (list_ctkm_id != -1 && list_ctkm_id.length > 0) temp = JSON.stringify(list_ctkm_id)
        var kq = await API.post_kiemtra_thaydoi_km(this.axios, {
          list_ctkm: temp,
          vhdtb_id: this.hdtb_id,
          vkhuyenmai_id_new: km_stb,
          vma_nd: this.tt_nd.ma_nd,
          vtt_km_id_new: tt_stb
        }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          }
        }) //tdan.GET_VALUE_FUNC("{?DB2}.kiemtra_thaydoi_km", "vhdtb_id", hdtb_id, "vkhuyenmai_id_new", km_stb, "vtt_km_id_new", tt_stb, "list_ctkm", temp, "vma_nd", tt_nd.ma_nd);
        if (!kq) {
          this.$toast.error('Không lấy được thông tin trả ra')
          return false
        }
        if (kq != 1) {
          this.$toast.error(kq)
          return false
        }
        return true
      } catch (ex) {
        this.$toast.error('Có lỗi hàm kiểm sửa khuyến mại ' + ex)
        return false
      }
    },
    kiemtra_khoanmuc_tien() {
      var drs_cu = this.ds_tien_khoanmuc_bd.filter((x) => x.tien != 0 && x.vat != 0) //.Tables[0].Select("tien<>0 and vat<>0");
      var drs_moi = this.ds_tien_khoanmuc.filter((x) => x.tien != 0 && x.vat != 0) //.Tables[0].Select("tien<>0 and vat<>0");
      //kiểm tra số bản ghi có tiền có = nhau không
      if (drs_cu.length != drs_moi.length) {
        return false
      }
      var vtien_bd, vvat_bd, vtien_moi, vvat_moi
      //Kiểm tra các khoản mục của 2 bên có khớp nhau không
      var kt = false
      //Duyệt toàn bộ bảng mới
      //Kiểm tra các khoản mục của bảng mới có tồn tại bên bảng cũ không?
      for (var drmoi of drs_moi) {
        kt = false
        for (var drcu of drs_cu) {
          vtien_bd = 0
          vvat_bd = 0
          vtien_moi = 0
          vvat_moi = 0
          if (drmoi['khoanmuctt_id'] == drcu['khoanmuctt_id']) {
            vtien_moi = drmoi['tien'] ? drmoi['tien'] * 1 : 0
            vvat_moi = drmoi['vat'] ? drmoi['vat'] * 1 : 0
            vtien_bd = drcu['tien'] ? drcu['tien'] * 1 : 0
            vvat_bd = drcu['vat'] ? drcu['vat'] * 1 : 0

            if (vtien_bd == vtien_moi && vvat_bd == vvat_moi) {
              kt = true
              break
            }
          }
        }
        //không tìm thấy khoản mục tương ứng trong bảng cũ trùng với khoản mục đang xét trong bảng mới
        if (kt == false) return false
      }
      //Kiểm tra ngược lại
      //Kiểm tra các khoản mục của bảng cũ có tồn tại bên bảng mới không?
      for (var drcu of drs_cu) {
        kt = false
        for (var drmoi of drs_moi) {
          vtien_bd = 0
          vvat_bd = 0
          vtien_moi = 0
          vvat_moi = 0
          if (drmoi['khoanmuctt_id'] == drcu['khoanmuctt_id']) {
            vtien_moi = drmoi['tien'] ? drmoi['tien'] * 1 : 0
            vvat_moi = drmoi['vat'] ? drmoi['vat'] * 1 : 0
            vtien_bd = drcu['tien'] ? drcu['tien'] * 1 : 0
            vvat_bd = drcu['vat'] ? drcu['vat'] * 1 : 0

            if (vtien_bd == vtien_moi && vvat_bd == vvat_moi) {
              kt = true
              break
            }
          }
        }
        //không tìm thấy khoản mục tương ứng trong bảng mới trùng với khoản mục đang xét trong bảng cũ
        if (kt == false) return false
      }
      return kt
    },
    async phathanh_hddt_dieuchinh_td(dt_khoanmuc_cu, dt_khoanmuc_moi) {
      var sKq = ''
      var sql = ''
      var dtProduct = [...dt_khoanmuc_cu]
      //so sánh khoản mục cũ và mới
      //PRODNAME, TONGTIEN,PRODPRICE,TIEN,VAT,AMOUNT
      var i1, i2 //row bảng cũ, bảng mới trùng nhau
      var bl1 = false //kiểm tra có row trùng nhau không
      var tongtien_cu = 0,
        tongtien_moi = 0
      var dtCu = [...dt_khoanmuc_cu]
      var dtMoi = [...dt_khoanmuc_moi]
      for (var i = 0; i < dt_khoanmuc_cu.length; i++) {
        bl1 = false
        var tongtien, prodprice, tien, vat, amount
        tongtien_cu += dt_khoanmuc_cu[i]['TONGTIEN'] * 1
        for (var j = 0; j < dt_khoanmuc_moi.length; j++) {
          if (dt_khoanmuc_cu[i]['PRODNAME'] == dt_khoanmuc_moi[j]['PRODNAME']) {
            //Cũ mới đều có, so sánh tiền
            tongtien = dt_khoanmuc_moi[j]['TONGTIEN'] * 1 - dt_khoanmuc_cu[i]['TONGTIEN'] * 1
            prodprice = dt_khoanmuc_moi[j]['PRODPRICE'] * 1 - dt_khoanmuc_cu[i]['PRODPRICE'] * 1
            tien = dt_khoanmuc_moi[j]['TIEN'] * 1 - dt_khoanmuc_cu[i]['TIEN'] * 1
            vat = dt_khoanmuc_moi[j]['VAT'] * 1 - dt_khoanmuc_cu[i]['VAT'] * 1
            amount = dt_khoanmuc_moi[j]['AMOUNT'] * 1 - dt_khoanmuc_cu[i]['AMOUNT'] * 1
            if (tongtien != 0) {
              var dr = dtCu[i]
              if (tongtien < 0) {
                dr['PRODNAME'] = 'Giảm doanh thu ' + dr['PRODNAME']
              } else {
                dr['PRODNAME'] = 'Tăng doanh thu ' + dr['PRODNAME']
              }
              //sửa lại tiền
              dr['TONGTIEN'] = tongtien
              dr['PRODPRICE'] = prodprice
              dr['TIEN'] = tien
              dr['VAT'] = vat
              dr['AMOUNT'] = amount
              dtProduct.push(dr)
            }
            bl1 = true
            break
          }
        }
        if (!bl1) {
          //Cũ có mới không có, điều chỉnh tăng hoặc giảm tùy theo tiền âm hay dương
          var dr = dtCu[i]

          tongtien = dtCu[i]['TONGTIEN'] * 1
          prodprice = dtCu[i]['PRODPRICE'] * 1
          tien = dtCu[i]['TIEN'] * 1
          vat = dtCu[i]['VAT'] * 1
          amount = dtCu[i]['AMOUNT'] * 1
          if (tongtien < 0)
            //Nếu cũ âm, mới ko có, ĐC tăng
            dr['PRODNAME'] = 'Tăng doanh thu ' + dr['PRODNAME']
          else dr['PRODNAME'] = 'Giảm doanh thu ' + dr['PRODNAME']
          dr['TONGTIEN'] = -tongtien
          dr['PRODPRICE'] = -prodprice
          dr['TIEN'] = -tien
          dr['VAT'] = -vat
          dr['AMOUNT'] = -amount
          dtProduct.push(dr)
        }
      }
      for (var i = 0; i < dt_khoanmuc_moi.length; i++) {
        bl1 = false
        var tongtien, prodprice, tien, vat, amount
        tongtien_moi += dt_khoanmuc_moi[i]['TONGTIEN'] * 1
        for (var j = 0; j < dt_khoanmuc_cu.length; j++) {
          if (dt_khoanmuc_cu[j]['PRODNAME'] == dt_khoanmuc_moi.Rows[i]['PRODNAME']) {
            bl1 = true
            break
          }
        }
        if (!bl1) {
          //Mới có cũ không có, điều chỉnh tăng giảm tùy thuộc dấu của khoản mục
          var dr = dtMoi[i]
          tongtien = dtMoi[i]['tongtien'] * 1
          if (tongtien < 0)
            //Cũ ko có, mới âm -> DC giảm
            dr['PRODNAME'] = 'Giảm doanh thu ' + dr['PRODNAME']
          dtProduct.push(dr)
        }
      }
      if (dtProduct.length > 0) {
        var ds = []
        var msg = ''
        await API.post_fn_lay_tt_capnhat_hddt_dc(this.axios, { ds_para: JSON.stringify({ HDKH_ID: this.khachhang.hdkh_id, TONGTIEN_CU: tongtien_cu, TONGTIEN_MOI: tongtien_moi }) }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            var apidata = response.data.data
            if (apidata['ERROR_CODE'] != 1) {
              sErr = this.$toast.error(apidata['MESSAGE'])
            } else apidata = apidata['RESULT']

            if (apidata['SKQ']) sKq = apidata['SKQ']
            if (apidata['DS_HDDT']) ds = apidata['DS_HDDT']
          }
        }) //new HDTB_DATCOC_Facade().lay_tt_hddt_dc(hdkh_id);
        var dtThongTin = ds
        if (sKq == 'OK') return sKq

        var vthaotac = 2
        var vkieu = 2
        if (tongtien_cu == tongtien_moi) {
          return 'OK'
        } else if (tongtien_cu < tongtien_moi) {
          vkieu = 1
        }
        var vifkey = dtThongTin[0]['hddt_fkey']
        if (!vifkey) {
          sKq = 'OK'
          return sKq
        }

        var vdc_tt = 1 //1: Điều chỉnh, 2 thay thế

        if (!sKq && msg == 'View Frm chọn điều chỉnh or thay thế') {
          //         #region view form chọn Điều chỉnh or Thay thế
          vdc_tt = 2
          await this.$bvModal
            .msgBoxConfirm(`Bạn muốn thay thế hay điều chỉnh hóa đơn?`, {
              title: 'Xác nhận hành động',
              size: 'sm',
              okTitle: 'Điều chỉnh',
              cancelTitle: 'Thay thế'
            })
            .then((v) => {
              if (v) vdc_tt = 1
              else vdc_tt = 2
            })
          //         using (Form frm = new Form())
          //         {
          //             frm.Width = 350;
          //             frm.Height = 150;
          //             frm.StartPosition = FormStartPosition.CenterScreen;
          //             frm.ShowIcon = false;
          //             frm.MinimizeBox = false;
          //             frm.MaximizeBox = false;
          //             frm.ShowInTaskbar = false;
          //             var lbl = new Label()
          //             {
          //                 Text = "Bạn muốn thay thế hay điều chỉnh hóa đơn?",
          //                 Font = new Font(Font.Name, 12),
          //                 Dock = DockStyle.Top,
          //                 AutoSize = true
          //             };
          //             var chkDieuChinh = new RadioButton()
          //             {
          //                 Text = "Điều chỉnh",
          //                 Dock = DockStyle.Top,
          //                 Font = new Font(Font.Name, 12),
          //                 Checked = false,
          //                 Padding = new Padding(20, 0, 0, 0)
          //             };
          //             var chkThayThe = new RadioButton()
          //             {
          //                 Text = "Thay thế",
          //                 Dock = DockStyle.Top,
          //                 Checked = true,
          //                 Font = new Font(Font.Name, 12),
          //                 Padding = new Padding(20, 0, 0, 0)
          //             };
          //             var btnOk = new Button()
          //             {
          //                 Text = "Chọn",
          //                 Size = new Size(80, 30),
          //                 Location = new Point(135, 80)
          //             };
          //             btnOk.Click += BtnOkOnClick;
          //             frm.Controls.Add(lbl);
          //             frm.Controls.Add(chkDieuChinh);
          //             frm.Controls.Add(chkThayThe);
          //             frm.Controls.Add(btnOk);
          //             frm.FormBorderStyle = FormBorderStyle.FixedDialog;
          //             frm.FormClosing += new FormClosingEventHandler(frm_FormClosing);
          //             chkDieuChinh.BringToFront();
          //             chkThayThe.BringToFront();
          //             chkThayThe.Checked = true;
          //             frm.Padding = new Padding(10, 0, 10, 0);
          //             frm.Shown += FrmOnShown;
          //             if (frm.ShowDialog() != DialogResult.OK)
          //             {
          //                 vdc_tt = 2;
          //             }
          //             try
          //             {
          //                 if (chkDieuChinh.Checked)
          //                 {
          //                     vdc_tt = 1;
          //                 }
          //                 else
          //                 {
          //                     vdc_tt = 2;
          //                 }
          //             }
          //             catch (Exception ex)
          //             {
          //                 new LogError().GetError(new log4net.Core.LoggingEvent(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType, log.Logger.Repository, log.Logger.Name, log4net.Core.Level.Info, ex.Message, ex), true);
          //                 this.Cursor = Cursors.Default;
          //             }
          //         }
          //         #endregion
        }
        var vphieutt_id = dtThongTin[0]['phieutt_id'] * 1
        var vhdkh_id = dtThongTin[0]['hdkh_id'] * 1
        var vma_gd = dtThongTin[0]['ma_gd']
        var vten_kh = dtThongTin[0]['ten_kh']
        var vdiachi_kh = dtThongTin[0]['diachi_kh']
        var vmst = dtThongTin[0]['mst']
        var vten_nh = dtThongTin[0]['ten_nh']
        var vstk = dtThongTin[0]['stk']
        var vemail = dtThongTin[0]['email']
        var vfax = dtThongTin[0]['so_fax']
        var vsodt = dtThongTin[0]['so_dt']
        var vndd = dtThongTin[0]['nguoi_dd']
        var vloai_kh = dtThongTin[0]['loai_kh']
        var vhttt = dtThongTin[0]['httt']
        //Xuất hóa đơn điều chỉnh giảm hoặc thay thế
        if (vdc_tt == 1) {
          //Điều chỉnh
          vthaotac = 2
        } //thay thế
        else {
          vthaotac = 3
          dtProduct = dt_khoanmuc_moi
        }
        //TODO chua lam, cho API
        // cl_hoadon_dientu hddt = new cl_hoadon_dientu();
        // sKq = hddt.dongbo_hddt_tudong(vthaotac, vkieu, vifkey, vphieutt_id, hdkh_id, vma_gd, vten_kh, vdiachi_kh, vmst, vten_nh, vstk, vemail, vfax, vsodt, vndd, vloai_kh, vhttt, dtProduct);
        sKq = 'OK' // Gan tam trong luc cho API.
        if (sKq != 'OK') {
          if (vdc_tt == 1) sKq = 'Phát hành hóa đơn điều chỉnh thất bại!' + sKq
          else sKq = 'Phát hành hóa đơn thay thế thất bại!' + sKq
        }
      } else {
        sKq = 'OK'
        return sKq
      }
      sKq = 'OK'
      return sKq
    },
    btnChonSoDD_Click() {
      this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonSoKH')
      this.popupComponentName = 'frmChonSMPhuongDiDong'
      this.popupComponentData = {
        vkieuform: this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRATRUOC ? 0 : 1
      }
      this.Popup('popupComponents')
      // var frm = new frmChonSoKH();
      // frm.vkieuform = cboLoaihinhTB.SelectedValue.ToString() == LoaiHinhTB.DIDONGTRATRUOC + "" ? 0 : 1;
      // frm.ShowDialog();
      // if (frm.xacnhan)
      // {
      //     txtSoMayDD.Text = frm.so_tb_chon;
      //     txtSimDD.Text = frm.so_sim_chon;
      //     txtSoMayNTK.Text = txtSoMayDD.Text;
      //     cboGoiCuocDD.SelectedValue = frm.goicuoc_id_chon;
      //     CHON_KIEULD_THEO_TB("84" + txtSoMayDD.Text);
      //     CHON_LOAITB_TS_THEO_TB("84" + txtSoMayDD.Text); // vuth update 0912
      //     if (frm.vkieuform == 0) cboGoiCuocDD.Enabled = false; // vuth update fix 1109
      // }
    },
    async CHON_KIEULD_THEO_TB(so_tb) {
      // //Nếu đang chọn loại tb là di động trả sau thì kiểm tra và lấy ra kiểu lắp đặt tương ứng với số máy nhập vào.
      if (this.listbox.loaihinh_tb.value != LoaiHinhTB.DIDONGTRASAU) {
        return
      }
      // let service = new CCBSFacade();
      // //Lấy số sim
      try {
        this.thuebao.didong.txtSimDD = await API.post_ts_laphd_hoamangmoi_laytt_sosim(this.axios, { so_tb: so_tb })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data.result ? response.data.data.result : response.data.data
            } else return ''
          })
          .catch((e) => {
            return ''
          }) //service.TS_LAPHD_HOAMANGMOI_LAYTT_SOSIM(tt_nd.tentat, so_tb);
        if (!this.thuebao.didong.cboGoiCuocDD.value && this.thuebao.didong.cboGoiCuocDD.list && this.thuebao.didong.cboGoiCuocDD.list.length > 0) this.thuebao.didong.cboGoiCuocDD.value = this.thuebao.didong.cboGoiCuocDD.list[0].goicuoc_id
      } catch (ex) {
        this.thuebao.didong.txtSimDD = ''
      }

      try {
        var IsChuyenTinh = this.listbox.kieu_ld.value && this.listbox.kieu_ld.value == KieuLapDat.DM_DIDONG_CHUYEN_TINH
        if (!IsChuyenTinh) return

        //Nếu đang chọn kiểu lđ hòa mạng chuyển tỉnh thì tra cứu thêm thông tin của số máy trên CCBS để đảm
        //Nếu
        let dtThongTin = await API.post_ts_tracuu_laytt_tb(this.axios, { so_tb: so_tb })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          .catch((e) => {
            return []
          }) //service.ts_tracuu_laytt_tb(so_tb, tt_nd.USER_NEO, tt_nd.ip, tt_nd.tentat_ccbs, dichvuvt_id == DichVuVienThong.GPHONE ? "0" : "1");
        if (dtThongTin && dtThongTin.length > 0) {
          //Nếu đang chọn kiểu lđ hòa mạng chuyển tỉnh mà số nhập vào là số trả trước thì return.
          if (IsChuyenTinh && dtThongTin[0]['TRA_SAU'] == '0') {
            this.listbox.kieu_ld.value = null
            return
          }

          let dtThongTinTBCu = await API.get_ts_tracuu_laytt_tb_ts(this.axios, { params: { sotb: so_tb } })
            .then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return this.UpperCasePropertyList(response.data.data);
              } else return []
            })
            .catch((e) => {
              return []
            }) //service.ts_tracuu_laytt_tb_ts(so_tb, dtThongTin.Rows[0]["MA_TINH"].ToString()); // vuth update 0912
          this.thuebao.didong.txtTenTBDD_Cu = ''
          this.thuebao.didong.txtNgaySinhDD_Cu = ''
          this.thuebao.didong.txtSoGTDD_Cu = ''
          this.thuebao.didong.txtNgayCapGTDD_Cu = ''
          this.thuebao.didong.txtDiaChiDD_Cu = ''
          this.thuebao.didong.txtHoKhauDD_Cu = ''
          if (dtThongTinTBCu && dtThongTinTBCu.length > 0) {
            this.thuebao.didong.txtTenTBDD_Cu = dtThongTinTBCu[0]['TEN_TB'] ? dtThongTinTBCu[0]['TEN_TB'] : ''
            this.thuebao.didong.txtNgaySinhDD_Cu = dtThongTinTBCu[0]['NGAY_SINH'] ? dtThongTinTBCu[0]['NGAY_SINH'] : ''
            this.thuebao.didong.txtSoGTDD_Cu = dtThongTinTBCu[0]['SO_GT'] ? dtThongTinTBCu[0]['SO_GT'] : ''
            this.thuebao.didong.txtNgayCapGTDD_Cu = dtThongTinTBCu[0]['NGAYCAP_GT'] ? dtThongTinTBCu[0]['NGAYCAP_GT'] : ''
            this.thuebao.didong.txtDiaChiDD_Cu = dtThongTinTBCu[0]['DIACHI'] ? dtThongTinTBCu[0]['DIACHI'] : ''
            this.thuebao.didong.txtHoKhauDD_Cu = dtThongTinTBCu[0]['DIACHI_THUONGTRU'] ? dtThongTinTBCu[0]['DIACHI_THUONGTRU'] : ''
          }
        } else {
          //Tra cứu không thấy thông tin thuê bao thì return.
          if (IsChuyenTinh) {
            //cboKieuLD.SelectedIndex = -1; // vuth update 0912
            //Message_Box.ShowWarning("Số thuê bao không chính xác");
            return
          }
        }
      } catch (ex) {
        this.listbox.kieu_ld.value = null
      }
    },
    async CHON_LOAITB_TS_THEO_TB(so_tb) {
      // //Nếu đang chọn loại tb là di động trả sau thì kiểm tra và lấy ra loaitb neo co the lap hd tương ứng với số máy nhập vào.
      if (this.listbox.loaihinh_tb.value != LoaiHinhTB.DIDONGTRASAU) {
        return
      }

      let dt = await API.post_ts_laphd_hoamangmoi_layds_loaitb(this.axios, { so_tb: so_tb })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return []
        })
        .catch((e) => {
          return []
        })

      if (dt && dt.length > 0 && dt[0].hasOwnProperty('TENLOAI') && dt[0].hasOwnProperty('LOAITB_ID')) {
        let ds_goicuoc_id_neo = [0]
        for (let gc of dt) ds_goicuoc_id_neo.push(gc.LOAITB_ID)
        let dt_goicuoc = await API.post_sp_tt_goicuoc_dd(this.axios, { type: 4, param: ds_goicuoc_id_neo.join(',') })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          .catch(() => {
            return []
          })
        this.thuebao.didong.cboGoiCuocDD.list = dt_goicuoc
        if (this.thuebao.didong.cboGoiCuocDD.list && this.thuebao.didong.cboGoiCuocDD.list.length > 0 && (!this.thuebao.didong.cboGoiCuocDD.value || !this.thuebao.didong.cboGoiCuocDD.list.find((x) => x.goicuoc_id == this.thuebao.didong.cboGoiCuocDD.value)))
          this.thuebao.didong.cboGoiCuocDD.value = this.thuebao.didong.cboGoiCuocDD.list[0].goicuoc_id
      }
    },
    async TAO_DULIEU_HDTB_SUB(themmoi) {
      if (this.dsHDTB_SUB.length == 1) {
        var temp = [...this.dsHDTB_SUB]
        this.dsHDTB_SUB = []
        var row = {}
        row.HDTB_ID = this.hdtb_id
        row.SO_GT = temp[0]['SO_GT']
        try {
          row.LOAIGT_ID = temp[0]['LOAIGT_ID'] * 1
        } catch (ex) {
          //row.LOAIGT_ID = null;
        }
        row.CHUCDANH = temp[0]['CHUCDANH']
        try {
          row.NGAYHETHAN_GT = temp[0]['NGAYHETHAN_GT']
        } catch (ex) {
          //row.NGAYHETHAN_GT = null;
        }

        if(temp[0]["CAMKET_CLG"]) row.CAMKET_CLG = temp[0]["CAMKET_CLG"];
        row.KENH_TOANTRINH = this.vkenh_toantrinh;

        if (temp[0]["DOANHTHU_CQKH"])
            row.DOANHTHU_CQKH = temp[0]["DOANHTHU_CQKH"]*1;
        if (temp[0]["DOANHTHU_CQTB"])
            row.DOANHTHU_CQTB = temp[0]["DOANHTHU_CQTB"]*1;
        if (temp[0]["DOANHTHU_CQTC"])
            row.DOANHTHU_CQTC = temp[0]["DOANHTHU_CQTC"]*1;
        if (temp[0]["DOANHTHU_PS"])
            row.DOANHTHU_PS = temp[0]["DOANHTHU_PS"]*1;
        if (temp[0]["SOTHANG_TT"])
            row.SOTHANG_TT = temp[0]["SOTHANG_TT"]*1;
        if(temp[0]["SO_VB_KHDN"]) row.SO_VB_KHDN = temp[0]["SO_VB_KHDN"];
        if (this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH && !temp[0]["MA_NHOM"].ToString())
        {
          if (this.buttonSet==1)
              manhom = await API.post_sinh_ma_nhom_hdtb_sub(this.axios, {
                tinhthicong_id:100,
                vdichvuvt_id:this.listbox.dichvu_vt.value,
                vloaihinh_tb:this.listbox.loaihinh_tb.value
              }).then(response=>{
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000')
                  return response.data.data;
                else return null;
              }).catch(ex=>{return null;});
          else
              manhom =  await API.post_sinh_ma_nhom_hdtb_sub(this.axios, {
                tinhthicong_id:100,
                vhdtb_id: this.hdtb_id
              }).then(response=>{
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000')
                  return response.data.data;
                else return null;
              }).catch(ex=>{return null;});//bancheo.GET_STRING_FUNCTION(bancheo.tinh_thicong(100), "{?DB2}.lay_ma_nhom_hnth", "vhdtb_id", hdtb_id);
          if(!manhom) {
            this.$toast.error("Lỗi lấy thông tin mã nhóm, vui lòng xem lại!");
            throw "Lỗi lấy thông tin mã nhóm, vui lòng xem lại!";
          }
          row.MA_NHOM = manhom;
        }
        else
          row.MA_NHOM = null;

        row.NGUOI_KY_HOSO = temp[0]['NGUOI_KY_HOSO']
        this.dsHDTB_SUB.push(row)
      }
      else if (dsHDTB_SUB._HDTB_SUB.Rows.Count == 0 && dichvuvt_id == DichVuVienThong.HOINGHI_TRUYENHINH)
      {
        var temp = [...this.dsHDTB_SUB]
        this.dsHDTB_SUB = []
        var row = {}
          row.HDTB_ID = this.hdtb_id;
          if (this.buttonSet==1)
              manhom = await API.post_sinh_ma_nhom_hdtb_sub(this.axios, {
                tinhthicong_id:100,
                vdichvuvt_id:this.listbox.dichvu_vt.value,
                vloaihinh_tb:this.listbox.loaihinh_tb.value
              }).then(response=>{
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000')
                  return response.data.data;
                else return null;
              }).catch(ex=>{return null;});
          else
              manhom =  await API.post_sinh_ma_nhom_hdtb_sub(this.axios, {
                tinhthicong_id:100,
                vhdtb_id: this.hdtb_id
              }).then(response=>{
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000')
                  return response.data.data;
                else return null;
              }).catch(ex=>{return null;});//bancheo.GET_STRING_FUNCTION(bancheo.tinh_thicong(100), "{?DB2}.lay_ma_nhom_hnth", "vhdtb_id", hdtb_id);
          if(!manhom) {
            this.$toast.error("Lỗi lấy thông tin mã nhóm, vui lòng xem lại!");
            throw "Lỗi lấy thông tin mã nhóm, vui lòng xem lại!";
          }
          row.MA_NHOM = manhom;
          this.dsHDTB_SUB.push(row);
      }
      else this.dsHDTB_SUB = []
    },
    async cboTinh_EditValueChanged(val) {
      if (val) this.listbox.cboTinh.value = val
      try {
        this.header.title = "Lắp đặt mới " + (this.listbox.cboTinh.list.find(x=>x.tinh_id==this.listbox.cboTinh.value).tentinh.substring(0,3));
      } catch (ex) {

      } finally {}
      this.thongso_tc = newThongSoThueBao()
      // if(!this.diachiLD || !this.diachiLD.TINH_ID)
      this.diachiLD = {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      }
      // if(!this.diachiTB || !this.diachiTB.TINH_ID)
      this.diachiTB = {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      }
      // if (this.listbox.cboTinh.value) {
      //   this.tinh = await bancheo.tinh_thicong(this.listbox.cboTinh.value)
      //   if (!this.tinh.tinhthicong_id) this.$toast.error('Không lấy được thông tin tỉnh thi công! Vui lòng chọn lại tỉnh thi công.')
      // }
      // console.log('cboTinh_EditValueChanged', this.tinh)
      // if(!this.diachiKH.TINH_ID || !this.diachiKH.DIACHI || this.diachiKH.TINH_ID<=0) this.diachiKH.TINH_ID = val;
      // if(!this.diachiTT.TINH_ID || !this.diachiTT.DIACHI || this.diachiTT.TINH_ID<=0) this.diachiTT.TINH_ID = val;
      // if(!this.diachiCT.TINH_ID || !this.diachiCT.DIACHI || this.diachiCT.TINH_ID<=0) this.diachiCT.TINH_ID = val;
      if (!this.diachiLD.TINH_ID || !this.diachiLD.DIACHI || this.diachiLD.TINH_ID <= 0) this.diachiLD.TINH_ID = val
      if (!this.diachiTB.TINH_ID || !this.diachiTB.DIACHI || this.diachiTB.TINH_ID <= 0) this.diachiTB.TINH_ID = val
      // if(!this.diachiHK.TINH_ID || !this.diachiHK.DIACHI || this.diachiHK.TINH_ID<=0) this.diachiHK.TINH_ID = val;
      // if(!this.diachiNDD.TINH_ID || !this.diachiNDD.DIACHI || this.diachiNDD.TINH_ID<=0) this.diachiNDD.TINH_ID = val;
    },
    async cboTinhDau_EditValueChanged(val) {
      if (!val) val = this.diachiDau.TINH_ID
      // if(!this.diachiLD || !this.diachiLD.TINH_ID)
      this.diachiDau = {
        DIACHI: null,
        TINH_ID: val,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      }
      this.thuebao.tsl.tinh_dau = {}
      this.thuebao.tsl.tinh_dau.tinhthicong_id = val
    },
    async cboTinhCuoi_EditValueChanged(val) {
      if (!val) val = this.diachiDau.TINH_ID
      // if(!this.diachiLD || !this.diachiLD.TINH_ID)
      this.diachiCuoi = {
        DIACHI: null,
        TINH_ID: val,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      }
      this.thuebao.tsl.tinh_cuoi = {}
      this.thuebao.tsl.tinh_cuoi.tinhthicong_id = val
    },
    async TaoDuLieu_HDBANCHEO_TSL(themmoi, vdaucuoi_id) {
      // 1 : điểm đầu, 2 : điểm cuối
      var rowHDBBC = {}

      rowHDBBC.HDTB_BAN = this.hdtb_id
      if (vdaucuoi_id == 1) rowHDBBC.TINH_THICONG = this.thuebao.tsl.tinh_dau.tinhthicong_id
      else rowHDBBC.TINH_THICONG = this.thuebao.tsl.tinh_cuoi.tinhthicong_id

      rowHDBBC.DAUCUOI_ID = vdaucuoi_id
      rowHDBBC.TINH_BAN = this.$root.token.getPhanVungID() //tt_nd.tinh_id;
      rowHDBBC.THUEBAO_ID_BAN = this.thuebao.thuebao_id
      if (this.vkenh_toantrinh == 1)
      {
          rowHDBBC.TRANG_THAI = 1;
          rowHDBBC.THUEBAO_ID_THICONG = -1;
          rowHDBBC.HDTB_THICONG = -1;
      }
      else
        rowHDBBC.TRANG_THAI = 0
      rowHDBBC.LOAIHD_BANCHEO = 1
      if (this.khachhang.khachhang_id == 0) {
        rowHDBBC.KHACHHANG_ID_BAN = null
        rowHDBBC.KHACHHANG_ID_TC = null
      } else {
        rowHDBBC.KHACHHANG_ID_BAN = this.khachhang.khachhang_id
        var khachhangtc_id = await bancheo.LAY_KHACHHANGID_THICONG(this.thuebao.tsl.tinh_dau, this.khachhang.khachhang_id) // tcbancheo.LAY_KHACHHANGID_THICONG(tinh_dau, khachhang_id);
        if (khachhangtc_id == 0) rowHDBBC.KHACHHANG_ID_TC = null
        else rowHDBBC.KHACHHANG_ID_TC = khachhangtc_id
      }
      this.dsHDBANCHEO.push(rowHDBBC)

      // hdtb_bancheo
      //dsHDTBBANCHEO = new HDTB_BANCHEO_DATA();
      var rowHDTBBC = Object.assign({}, this.dsHDTB[0])

      if (vdaucuoi_id == 1) {
        rowHDTBBC.KIEULD_ID = this.thuebao.tsl.thongso_tc_dau.kieuld_id
        rowHDTBBC.QUAN_ID = this.diachiDau.QUAN_ID //quandau_id;
        rowHDTBBC.PHUONG_ID = this.diachiDau.PHUONG_ID //phuongdau_id;
        rowHDTBBC.PHO_ID = this.diachiDau.PHO_ID //phodau_id;
        rowHDTBBC.AP_ID = this.diachiDau.AP_ID //apdau_id;
        rowHDTBBC.KHU_ID = this.diachiDau.KHU_ID //khudau_id;
        //rowHDTBBC.DACDIEM_ID = dacdiemd_id;
        rowHDTBBC.DOITUONG_ID = this.thuebao.tsl.thongso_tc_dau.doituong_id
        rowHDTBBC.MUCUOCTB_ID = this.thuebao.tsl.thongso_tc_dau.muccuoctb_id
        rowHDTBBC.QUYTRINH_ID = this.thuebao.tsl.quytrinh_tc_tn_dau
        rowHDTBBC.HUONGGIAO_TN_ID = this.thuebao.tsl.huonggiao_tc_tn_dau
        rowHDTBBC.TINH_ID = this.thuebao.tsl.tinh_dau.tinhthicong_id
        rowHDTBBC.TINH_DC_ID = 1
        if (this.kt_thuenganhan == true) {
          rowHDTBBC.TG_THUE_TU = this.TGThueTuNgay
          rowHDTBBC.TG_THUE_DEN = this.TGThueDenNgay
        } else {
          rowHDTBBC.TG_THUE_TU = null
          rowHDTBBC.TG_THUE_DEN = null
        }
      } else {
        rowHDTBBC.KIEULD_ID = this.thuebao.tsl.thongso_tc_cuoi.kieuld_id
        rowHDTBBC.QUAN_ID = this.diachiCuoi.QUAN_ID //quancuoi_id;
        rowHDTBBC.PHUONG_ID = this.diachiCuoi.PHUONG_ID //phuongcuoi_id;
        rowHDTBBC.PHO_ID = this.diachiCuoi.PHO_ID //phocuoi_id;
        rowHDTBBC.AP_ID = this.diachiCuoi.AP_ID //apcuoi_id;
        rowHDTBBC.KHU_ID = this.diachiCuoi.KHU_ID //khucuoi_id;
        //rowHDTBBC.DACDIEM_ID = dacdiemld_id;
        rowHDTBBC.DOITUONG_ID = this.thuebao.tsl.thongso_tc_cuoi.doituong_id
        rowHDTBBC.MUCUOCTB_ID = this.thuebao.tsl.thongso_tc_cuoi.muccuoctb_id
        rowHDTBBC.QUYTRINH_ID = this.thuebao.tsl.quytrinh_tc_tn_cuoi
        rowHDTBBC.HUONGGIAO_TN_ID = this.thuebao.tsl.huonggiao_tc_tn_cuoi
        rowHDTBBC.TINH_ID = this.thuebao.tsl.tinh_cuoi.tinhthicong_id
        rowHDTBBC.TINH_DC_ID = 2
        if (this.kt_thuenganhan == true) {
          rowHDTBBC.TG_THUE_TU = this.TGThueTuNgay
          rowHDTBBC.TG_THUE_DEN = this.TGThueDenNgay
        } else {
          rowHDTBBC.TG_THUE_TU = null
          rowHDTBBC.TG_THUE_DEN = null
        }
      }

      this.dsHDTBBANCHEO.push(rowHDTBBC)
    },
    async TaoDuLieu_HDBANCHEO(themmoi) {
      this.dsHDBANCHEO = []
      var rowHDBBC = {}

      rowHDBBC.HDTB_BAN = this.hdtb_id
      rowHDBBC.TINH_THICONG = this.tinh.tinhthicong_id
      rowHDBBC.TINH_BAN = this.$root.token.getPhanVungID() //tt_nd.tinh_id;
      rowHDBBC.THUEBAO_ID_BAN = this.thuebao.thuebao_id
      rowHDBBC.TRANG_THAI = 0
      rowHDBBC.LOAIHD_BANCHEO = 1
      if (this.khachhang.khachhang_id == 0) {
        rowHDBBC.KHACHHANG_ID_BAN = null
        rowHDBBC.KHACHHANG_ID_TC = null
      } else {
        rowHDBBC.KHACHHANG_ID_BAN = this.khachhang.khachhang_id
        var khachhangtc_id = await bancheo.LAY_KHACHHANGID_THICONG(this.tinh, this.khachhang.khachhang_id)
        if (khachhangtc_id == 0) rowHDBBC.KHACHHANG_ID_TC = null
        else rowHDBBC.KHACHHANG_ID_TC = khachhangtc_id
      }
      this.dsHDBANCHEO.push(rowHDBBC)
      // hop dong thue bao ban cheo
      this.dsHDTBBANCHEO = []
      var rowHDTBBC = Object.assign({}, this.dsHDTB[0])
      rowHDTBBC.KIEULD_ID = this.thongso_tc.kieuld_id // Convert.ToInt32(cboKieuLD.SelectedValue.ToString());
      rowHDTBBC.QUAN_ID = this.diachiLD.QUAN_ID // quanld_id;
      rowHDTBBC.PHUONG_ID = this.diachiLD.PHUONG_ID //phuongld_id;
      rowHDTBBC.PHO_ID = this.diachiLD.PHO_ID //phold_id;
      rowHDTBBC.AP_ID = this.diachiLD.AP_ID //apld_id;
      rowHDTBBC.KHU_ID = this.diachiLD.KHU_ID //khuld_id;
      rowHDTBBC.DACDIEM_ID = this.diachiLD.DACDIEM_ID //dacdiemld_id;
      rowHDTBBC.DOITUONG_ID = this.thongso_tc.doituong_id
      rowHDTBBC.MUCUOCTB_ID = this.thongso_tc.muccuoctb_id
      if (this.kt_thuenganhan == true) {
        rowHDTBBC.TG_THUE_TU = this.TGThueTuNgay //tg_thue_tu;
        rowHDTBBC.TG_THUE_DEN = this.TGThueDenNgay //tg_thue_den;
      } else {
        rowHDTBBC.TG_THUE_TU = null
        rowHDTBBC.TG_THUE_DEN = null
      }
      rowHDTBBC.QUYTRINH_ID = this.quytrinh_tc_tn
      rowHDTBBC.HUONGGIAO_TN_ID = this.huonggiao_tc_tn
      this.dsHDTBBANCHEO.push(rowHDTBBC)
    },
    async TaoDuLieu_HDBC_CD(themmoi) {
      this.dsHDBCCD = []
      var rowHDBC_CD = {}

      rowHDBC_CD.HDTB_ID = this.hdtb_id
      if (this.chkVSVX) rowHDBC_CD.MC_TBCD_ID = 1
      else rowHDBC_CD.MC_TBCD_ID = 0

      if (this.chkMienCuocTB) rowHDBC_CD.MIENCUOC_TB = 1
      else rowHDBC_CD.MIENCUOC_TB = 0

      if (this.KetCuoi_ID > 0) rowHDBC_CD.KETCUOI_ID = this.KetCuoi_ID

      if (this.listbox.congnghe.value > 0) rowHDBC_CD.CONGNGHE_ID = this.listbox.congnghe.value * 1
      else rowHDBC_CD.CONGNGHE_ID = null

      //HungHM - Bổ xung thêm mã truy nhập + mã đôi cáp
      rowHDBC_CD.MATB_TN = this.thongso_tc.ma_tn ? this.thongso_tc.ma_tn.trim() : ''
      rowHDBC_CD.THOIHAN_ID = this.listbox.thoihan.valuecd //Convert.ToInt16(cboThoiHan_CD.SelectedValue);

      if (this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_DC || this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_TL || this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_MOI) {
        rowHDBC_CD.TG_THUESO = this.thuebaocd.sothang_thueso
        if (this.thuebaocd.kieu_thueso == THUESO.TRUOTSO) {
          rowHDBC_CD.SOTRUOT = this.thuebaocd.noidung_thueso
          rowHDBC_CD.NOIDUNG_TB = ''
        }
        if (this.thuebaocd.kieu_thueso == THUESO.THONGBAO) {
          rowHDBC_CD.SOTRUOT = ''
          rowHDBC_CD.NOIDUNG_TB = this.thuebaocd.noidung_thueso
        }
      }

      var kieu = await API.post_fn_tt_kieu_ld(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, param: this.thongso_tc.kieuld_id })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return 0
        })
        .catch(() => {
          return 0
        }) //this.kieu_ld_kieu;//Convert.ToInt32(bc_checkdata.MAP_ID(tinh, "kieu", "CSS_" + tinh.matinh + ".kieu_ld", "where kieuld_id =" + thongso_tc.kieuld_id));
      //Nếu lắp trên đường có sẵn hoặc lắp kèm thì lấy mã đôi cáp từ form chọn xuống
      if (kieu == 1 || kieu == 2 || kieu == 4) {
        if (!this.thongso_tc.ma_doicap || (this.thongso_tc.ma_doicap + '').trim().length == 0) {
          this.$toast.error('Đối kiểu lắp đặt là lắp kèm hoặc trên đường có sẵn thì mã đôi cáp không được trống.')
          return
        }
        rowHDBC_CD.MADOICAP = this.thongso_tc.ma_doicap ? (this.thongso_tc.ma_doicap + '').trim() : ''
      } //TH còn lại sinh mã đôi cáp
      else {
        if (themmoi == true) {
          rowHDBC_CD.MADOICAP = await bancheo.GetKey(this.tinh, 'MADOICAP') //bancheo.GetKey(tinh, "MADOICAP");
        } else {
          if (this.thongso_tc.ma_doicap && (this.thongso_tc.ma_doicap + '').trim().length > 0) {
            // Trong trường hợp : thêm mới kiểu lắp trên đường có sẵn hoặc lắp kèm, sau đó ấn ghi lại chọn trên đường ko số
            // => kiểm tra xem đã có thuê bao nào ăn vào mã đôi cáp này hay chưa
            // Nếu có thuê bao ăn vào rồi thì pải sinh mã đôi cáp mới

            if ((await bancheo.kiemtra_thuebao_sd_madoicap(this.tinh, this.thongso_tc.ma_doicap)) != 0) rowHDBC_CD.MADOICAP = await bancheo.GetKey(this.tinh, 'MADOICAP')
            //bancheo.GetKey(tinh, "MADOICAP");
            else rowHDBC_CD.MADOICAP = this.thongso_tc.ma_doicap + ''
          } // Trường hợp trên text chưa có mã đôi cáp thì sinh mã đôi cáp khác
          else {
            rowHDBC_CD.MADOICAP = await bancheo.GetKey(this.tinh, 'MADOICAP') //bancheo.GetKey(tinh, "MADOICAP");
          }
        }
      }
      rowHDBC_CD.TRANGBI_ID = this.thongso_tc.trangbi_id
      rowHDBC_CD.CHUQUAN_ID = this.thongso_tc.chuquan_id
      rowHDBC_CD.CHUQUANLD_ID = this.thongso_tc.chuquanld_id
      if (this.ma_vnpt != '-1') rowHDBC_CD.MA_VNPT = this.ma_vnpt
      this.dsHDBCCD.push(rowHDBC_CD)
    },
    async TaoDuLieu_HDBC_ADSL(themmoi) {
      this.dsHDBC_ADSL = []
      var rowHDBC_ADSL = {}

      rowHDBC_ADSL.HDTB_ID = this.hdtb_id
      rowHDBC_ADSL.EMAIL = this.thuebao.adsl.txtEmailAdsl
      if (this.thuebao.adsl.ckTuCaiADSL) rowHDBC_ADSL.KH_CD = 1
      else rowHDBC_ADSL.KH_CD = 0
      rowHDBC_ADSL.TOCDO_ID = this.thongso_tc.tocdo_id

      if (this.thongso_tc.tocdothuc_id > 0) rowHDBC_ADSL.TOCDOTHUC_ID = this.thongso_tc.tocdothuc_id
      else rowHDBC_ADSL.TOCDOTHUC_ID = rowHDBC_ADSL.TOCDO_ID

      if (this.KetCuoi_ID > 0) rowHDBC_ADSL.KETCUOI_ID = this.KetCuoi_ID
      rowHDBC_ADSL.THIETBIDC_ID = this.thongso_tc.thietbidc_id
      rowHDBC_ADSL.MUCCUOC_ID = this.thongso_tc.muccuoc_id
      rowHDBC_ADSL.CHUQUAN_ID = this.thongso_tc.chuquan_id
      rowHDBC_ADSL.CHUQUANLD_ID = this.thongso_tc.chuquanld_id

      rowHDBC_ADSL.THOIHAN_ID = this.listbox.thoihan.valueadsl
      rowHDBC_ADSL.MA_LT = this.bc_ma_tb_ao_ht
      //HungHM - 31/08/2010 bổ xung thêm ngày đặt chỗ cho Accont ADSL, FTTH
      var loaitb_id = this.listbox.loaihinh_tb.value
      if (loaitb_id == LoaiHinhTB.INTERNET_1260 || loaitb_id == LoaiHinhTB.INTERNET_ADSL || loaitb_id == LoaiHinhTB.INTERNET_FTTH || loaitb_id == LoaiHinhTB.WIFI_FIBER) rowHDBC_ADSL.HANDATCHO = this.thuebao.adsl.dtpHanDatCho
      if (loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_ANALOG || loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL || loaitb_id == LoaiHinhTB.MEGACAMERA) rowHDBC_ADSL.SLTV_HTVC = this.thuebao.adsl.txtSL_Tivi

      if (loaitb_id == LoaiHinhTB.FSECURE) rowHDBC_ADSL.SO_DT = this.thuebao.adsl.txtDienThoai_Fsecure

      if (loaitb_id == LoaiHinhTB.COSO_HATANG) {
        rowHDBC_ADSL.DOITAC_ID = this.listbox.cboDoiTac_CSHT.value
        rowHDBC_ADSL.LOAI_CSHT_ID = this.listbox.cboLoai_CSHT.value
      }

      var profiledsl_id = await bancheo.map_id(this.tinh, 'profiledsl_id', 'CSS.tocdo_adsl', ' where tocdo_id =' + this.thongso_tc.tocdo_id) //Convert.ToInt32(new CheckData().MAP_ID(tinh, "profiledsl_id", "CSS_" + tinh.matinh + ".tocdo_adsl", " where tocdo_id =" + thongso_tc.tocdo_id));
      if (profiledsl_id != -1) rowHDBC_ADSL.PROFILEDSL_ID = profiledsl_id
      else rowHDBC_ADSL.PROFILEDSL_ID = null

      if (this.thongso_tc.congnghe_id > 0) rowHDBC_ADSL.CONGNGHE_ID = this.thongso_tc.congnghe_id
      else rowHDBC_ADSL.CONGNGHE_ID = null

      rowHDBC_ADSL.VMP = this.cbvmp ? 1 : 0
      //HungHM - Bổ xung thêm mã truy nhập + mã đôi cáp
      rowHDBC_ADSL.MATB_TN = this.thuebao.adsl.txtMaTN_ADSL
      var kieu = await API.post_fn_tt_kieu_ld(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, param: this.thongso_tc.kieuld_id })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return 0
        })
        .catch(() => {
          return 0
        }) //this.kieu_ld_kieu;//Convert.ToInt32(new CheckData().MAP_ID(tinh, "kieu", "CSS_" + tinh.matinh + ".kieu_ld", "where kieuld_id =" + thongso_tc.kieuld_id));
      //Nếu lắp trên đường có sẵn hoặc lắp kèm thì lấy mã đôi cáp từ form chọn xuống
      if (kieu == 1 || kieu == 2 || kieu == 3 || kieu == 4) {
        if (!this.thongso_tc.ma_doicap || (this.thongso_tc.ma_doicap + '').trim().length == 0) {
          throw ('Đối với kiểu lắp đặt là lắp kèm hoặc trên đường có sẵn thì mã đôi cáp không được trống.')
          //return
        }
        rowHDBC_ADSL.MADOICAP = this.thongso_tc.ma_doicap * 1
      } //TH còn lại sinh mã đôi cáp
      else {
        if (themmoi == true) {
          rowHDBC_ADSL.MADOICAP = await bancheo.GetKey(this.tinh, 'MADOICAP') //new SinhMoi().GetKey(tinh, "MADOICAP");
        } else {
          if (this.thongso_tc.ma_doicap && (this.thongso_tc.ma_doicap + '').trim().length > 0) {
            // Trong trường hợp : thêm mới kiểu lắp trên đường có sẵn hoặc lắp kèm, sau đó ấn ghi lại chọn trên đường ko số
            // => kiểm tra xem đã có thuê bao nào ăn vào mã đôi cáp này hay chưa
            // Nếu có thuê bao ăn vào rồi thì pải sinh mã đôi cáp mới
            if ((await bancheo.kiemtra_thuebao_sd_madoicap(this.tinh, this.thuebao.adsl.txtMaDoiCap_ADSL)) != 0) {
              //new HopDong().Kiemtra_thuebao_sd_madoicap(tinh, Convert.ToDecimal(txtMaDoiCap_ADSL.Text)) != 0)
              rowHDBC_ADSL.MADOICAP = await bancheo.GetKey(this.tinh, 'MADOICAP') //new SinhMoi().GetKey(tinh, "MADOICAP");
            } else rowHDBC_ADSL.MADOICAP = this.thongso_tc.ma_doicap * 1
          } // Trường hợp trên text chưa có mã đôi cáp thì sinh mã đôi cáp khác
          else {
            rowHDBC_ADSL.MADOICAP = await bancheo.GetKey(this.tinh, 'MADOICAP') //new SinhMoi().GetKey(tinh, "MADOICAP");
          }
        }
      }
      rowHDBC_ADSL.TRANGBI_ID = this.thongso_tc.trangbi_id
      rowHDBC_ADSL.KIEUTRA_ID = this.thongso_tc.kieutra_id
      if (rowHDBC_ADSL.KIEUTRA_ID == 1) {
        rowHDBC_ADSL.THANG_ID = this.listbox.cboThangTra.value * 1
        rowHDBC_ADSL.NGAYTRA = this.thuebao.adsl.dtpNgayTra
      }

      if (themmoi == true) {
        var pass_adsl = ''
        var matkhau_md_adsl = this.thamsomacdinh['MACDINH_MATKHAU_ADSL']
        if (matkhau_md_adsl != '') {
          if (matkhau_md_adsl == 'random_sql') {
            pass_adsl = await bancheo.sinh_pass_random(1) //new TCHopDongFacade2().sinh_pass_random(1);
            if (!pass_adsl) pass_adsl = matkhau_md_adsl
          } else pass_adsl = matkhau_md_adsl
        } else {
          var sinh_TD_matkhau_adsl = this.thamsomacdinh['TUDONG_SINH_MATKHAU_TB'] == 1 ? 1 : 0
          if (sinh_TD_matkhau_adsl == 1) {
            pass_adsl = this.thuebao.adsl.txtAccountADSL.indexOf('.') >= 0 ? this.thuebao.adsl.txtAccountADSL.split('.')[this.thuebao.adsl.txtAccountADSL.split('.').length - 1] : ''
            if (pass_adsl == '') pass_adsl = this.thuebao.adsl.txtAccountADSL.indexOf('-') >= 0 ? this.thuebao.adsl.txtAccountADSL.split('-')[this.thuebao.adsl.txtAccountADSL.split('-').length - 1] : ''
          } else pass_adsl = this.GetRandomText(8)
        }
      }

      rowHDBC_ADSL.PASSWORD = pass_adsl
      if (this.listbox.doitac.ischeckedadsl) {
        //chkDoiTac_Internet.Checked)
        rowHDBC_ADSL.DOITAC_ID = this.listbox.doitac.valueinternet //Convert.ToInt32(cboDoiTac_Internet.EditValue);

        rowHDBC_ADSL.USERNAME = this.thuebao.adsl.txtAccountADSL.trim()
        if (this.listbox.doitac.valueinternet) {
          rowHDBC_ADSL.USERNAME = (this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.trim() : '') + this.listbox.doitac.list.filter((x) => x.doitac_id == this.listbox.doitac.valueinternet)[0]['username_sub'].trim() //this.thuebao.adsl.txtAccountADSL.trim() + dsDanhMuc.Tables["DOITAC"].Select("doitac_id = " + Convert.ToInt32(cboDoiTac_Internet.EditValue)).CopyToDataTable().Rows[0]["username_sub"].ToString().trim();
        }
      } else {
        rowHDBC_ADSL.DOITAC_ID = null
        rowHDBC_ADSL.USERNAME = this.thuebao.adsl.txtAccountADSL.trim()
      }

      // if (!this.thuebao.adsl.txtTTCuoc || (this.thuebao.adsl.txtTTCuoc + '').trim() == '') {
      //   var _dt = await API.post_lay_thongtin_sl_ip_mp(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, tocdo_id: this.thongso_tc.tocdo_id }).then((response) => {
      //     if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //       return response.data.data
      //     } else return []
      //   }) //bancheo.getDataFromSQL_BC(tinh, "select sl_ip_mp from CSS_" + tinh.matinh + ".tocdo_adsl where tocdo_id = " + thongso_tc.tocdo_id + " and sl_ip_mp is not null", "ds").Tables[0];
      //   if (_dt && _dt.length > 0 && _dt[0]['sl_ip_mp'] > 0) {
      //     this.thuebao.adsl.txtTTCuoc = 'mienip:' + _dt[0]['sl_ip_mp']
      //   }
      // }
      // rowHDBC_ADSL.THONGTIN_TC = this.thuebao.adsl.txtTTCuoc
      rowHDBC_ADSL.THONGTIN_TC = null;

      if (loaitb_id == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC || loaitb_id == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC) {
        rowHDBC_ADSL.CUOC_SD = this.thuebao.adsl.txtCSD_FIBER_TK * 1
        rowHDBC_ADSL.CUOC_TBI = this.thuebao.adsl.txtCTB_FIBER_TK * 1
      }
      if (this.ma_vnpt != '-1') rowHDBC_ADSL.MA_VNPT = this.ma_vnpt
      this.dsHDBC_ADSL.push(rowHDBC_ADSL)
    },
    async TaoDuLieu_HDBC_MGWAN(themmoi) {
      this.dsHDBCMGWAN = []
      var rowHDBC_MGWAN = {}
      rowHDBC_MGWAN.HDTB_ID = this.hdtb_id
      rowHDBC_MGWAN.TOCDO_ID = this.thongso_tc.tocdo_id
      rowHDBC_MGWAN.TOCDO_PIR_ID = this.thongso_tc.tocdo_pir_id
      rowHDBC_MGWAN.CONGNGHE_ID = this.thongso_tc.congnghe_id
      rowHDBC_MGWAN.LOAIMD_ID = this.thongso_tc.loaimd_id
      rowHDBC_MGWAN.LOAIKENH_ID = this.thongso_tc.loaikenh_id
      rowHDBC_MGWAN.THIETBIDC_ID = this.thongso_tc.thietbidc_id
      rowHDBC_MGWAN.MA_LT = this.bc_ma_tb_ao_ht
      if (this.thuebao.mgwan.chkNgayHT_MGWAN) rowHDBC_MGWAN.NGAY_YCHT = this.thuebao.mgwan.dtpNgayHT_MGWAN
      rowHDBC_MGWAN.LAN_IP = this.thuebao.mgwan.lanip ? this.thuebao.mgwan.lanip.trim() : this.thuebao.mgwan.lanip
      rowHDBC_MGWAN.WAN_IP = this.thuebao.mgwan.wanip ? this.thuebao.mgwan.wanip.trim() : this.thuebao.mgwan.wanip

      if (this.dsHDTB_MEWAN && this.dsHDTB_MEWAN.length > 0) rowHDBC_MGWAN.VRF = this.dsHDTB_MEWAN[0]['VRF']

      //HungHM - 07/09/2010 bổ xung thêm tham số cho wan
      //rowHDTB_MGWAN.HUONG_KN = txtHuongKNWan.Text;
      rowHDBC_MGWAN.HUONG_KN = this.thuebao.mgwan.vhuongkn
      if (this.listbox.tinh_kn.value != 0) rowHDBC_MGWAN.TINH_KN_ID = this.listbox.tinh_kn.value

      if (this.KetCuoi_ID > 0) rowHDBC_MGWAN.KETCUOI_ID = this.KetCuoi_ID

      rowHDBC_MGWAN.THOIHAN_ID = this.listbox.thoihan.valuewan
      rowHDBC_MGWAN.TRANGBI_ID = this.thongso_tc.trangbi_id
      rowHDBC_MGWAN.CHUQUAN_ID = this.thongso_tc.chuquan_id
      rowHDBC_MGWAN.CHUQUANLD_ID = this.thongso_tc.chuquanld_id
      rowHDBC_MGWAN.MA_PL = this.thuebao.mgwan.txtMaHD_TTKD_MGWAN ? this.thuebao.mgwan.txtMaHD_TTKD_MGWAN.trim() : ''
      rowHDBC_MGWAN.SITE_ID = this.thuebao.mgwan.siteid ? this.thuebao.mgwan.siteid.trim() : this.thuebao.mgwan.siteid
      rowHDBC_MGWAN.LOAINODE_ID = this.loaisowan
      rowHDBC_MGWAN.LOAICAP_ID = this.listbox.loaicap.value

      if (this.diachiKN.DIACHI && this.diachiKN.DIACHI.trim() != '') rowHDBC_MGWAN.DIACHI_KN = this.diachiKN.DIACHI

      if (this.thuebao.mgwan.chkLuongGiuKenh) rowHDBC_MGWAN.GIUKENH = 1
      else rowHDBC_MGWAN.GIUKENH = 0
      if (this.thongso_tc.mhkn_id != -1) rowHDBC_MGWAN.MHKN_ID = this.thongso_tc.mhkn_id
      if (this.thongso_tc.tocdo_pop != -1) rowHDBC_MGWAN.TOCDO_POP = this.thongso_tc.tocdo_pop
      if (this.thongso_tc.gdkn_pop_id != -1) rowHDBC_MGWAN.GDKN_POP_ID = this.thongso_tc.gdkn_pop_id
      if (this.thongso_tc.gdkn_kh_id != -1) rowHDBC_MGWAN.GDKN_KH_ID = this.thongso_tc.gdkn_kh_id
      if (this.thongso_tc.cauhinh_dt_id != -1) rowHDBC_MGWAN.CAUHINH_DT_ID = this.thongso_tc.cauhinh_dt_id
      if (this.thongso_tc.kieu_duplex_id != -1) rowHDBC_MGWAN.KIEU_DUPLEX_ID = this.thongso_tc.kieu_duplex_id
      if (this.thongso_tc.kieukn_id != -1) rowHDBC_MGWAN.KIEUKN_ID = this.thongso_tc.kieukn_id

      rowHDBC_MGWAN.WAN_IP = this.thongso_tc.wan_ip
      rowHDBC_MGWAN.MTU_SIZE = this.thongso_tc.mtu_size
      rowHDBC_MGWAN.DIEM_POP = this.thongso_tc.diem_pop
      rowHDBC_MGWAN.LAN_IP = this.thongso_tc.lan_ip
      rowHDBC_MGWAN.CE_IP = this.thongso_tc.ce_ip
      rowHDBC_MGWAN.SL_IP = this.thongso_tc.sl_ip
      rowHDBC_MGWAN.IP_POP = this.thongso_tc.tt_ip
      rowHDBC_MGWAN.TEN_TRUNK_NNI = this.thongso_tc.ten_trunk_nni
      rowHDBC_MGWAN.SO_AS = this.thongso_tc.so_as
      rowHDBC_MGWAN.HQOS = this.thongso_tc.hqos
      rowHDBC_MGWAN.COS = this.thongso_tc.cos
      rowHDBC_MGWAN.VLAN_TRANSPARENT = this.thongso_tc.vlan_transparent

      if (this.listbox.doitacwan.isenabled) {
        rowHDBC_MGWAN.DOITAC_ID = this.listbox.doitacwan.value
        if (this.thuebao.mgwan.cuoctk_dt) rowHDBC_MGWAN.CUOC_TKDT = this.thuebao.mgwan.cuoctk_dt
        else rowHDBC_MGWAN.CUOC_TKDT = 0
        if (this.thuebao.mgwan.cuoctc_dt) rowHDBC_MGWAN.CUOC_TCDT = this.thuebao.mgwan.cuoctc_dt
        else rowHDBC_MGWAN.CUOC_TCDT = 0

        rowHDBC_MGWAN.MAHD_DT = this.thuebao.mgwan.hopdong_dt ? this.thuebao.mgwan.hopdong_dt.trim() : this.thuebao.mgwan.hopdong_dt
      } else {
        rowHDBC_MGWAN.DOITAC_ID = null
        rowHDBC_MGWAN.CUOC_TKDT = null
        rowHDBC_MGWAN.CUOC_TCDT = null
        rowHDBC_MGWAN.MAHD_DT = null
      }

      ///TuanNA: Bổ sung tham số cước thuê kênh, thuê cổng cho wan
      ///Ngày 08.05.2012
      ///
      if (this.thuebao.mgwan.cuocht) rowHDBC_MGWAN.CUOC_HT = this.thuebao.mgwan.cuocht
      else rowHDBC_MGWAN.CUOC_HT = 0
      if (this.thuebao.mgwan.cuoctbi) rowHDBC_MGWAN.CUOC_TBI = this.thuebao.mgwan.cuoctbi
      else rowHDBC_MGWAN.CUOC_TBI = 0
      if (this.thuebao.mgwan.cuoctc) rowHDBC_MGWAN.CUOC_TC = this.thuebao.mgwan.cuoctc
      else rowHDBC_MGWAN.CUOC_TC = 0
      if (this.thuebao.mgwan.cuoctk) rowHDBC_MGWAN.CUOC_TK = this.thuebao.mgwan.cuoctk
      else rowHDBC_MGWAN.CUOC_TK = 0
      //HungHM - Bổ xung thêm mã truy nhập + mã đôi cáp
      if (this.thongso_tc.ma_tn != null) rowHDBC_MGWAN.MATB_TN = this.thongso_tc.ma_tn
      else rowHDBC_MGWAN.MATB_TN = null
      var kieu = await API.post_fn_tt_kieu_ld(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, param: this.thongso_tc.kieuld_id })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return 0
        })
        .catch(() => {
          return 0
        }) //this.kieu_ld_kieu;
      //Nếu lắp trên đường có sẵn hoặc lắp kèm thì lấy mã đôi cáp từ form chọn xuống
      if (kieu == KIEULAP.LAP_KEM || kieu == KIEULAP.LAP_LINE_SAN) {
        if (this.thongso_tc.ma_doicap && (this.thongso_tc.ma_doicap + '').trim().length == 0) {
          this.$toast.error('Đối kiểu lắp đặt là lắp kèm hoặc trên đường có sẵn thì mã đôi cáp không được trống.')
          return
        }
        rowHDBC_MGWAN.MADOICAP = this.thongso_tc.ma_doicap
      } //TH còn lại sinh mã đôi cáp
      else {
        if (themmoi == true) {
          rowHDBC_MGWAN.MADOICAP = await bancheo.GetKey(this.tinh, 'MADOICAP') //new SinhMoi().GetKey(tinh, "MADOICAP");
        } else {
          if (this.thongso_tc.ma_doicap && (this.thongso_tc.ma_doicap + '').trim().length > 0) {
            // Trong trường hợp : thêm mới kiểu lắp trên đường có sẵn hoặc lắp kèm, sau đó ấn ghi lại chọn trên đường ko số
            // => kiểm tra xem đã có thuê bao nào ăn vào mã đôi cáp này hay chưa
            // Nếu có thuê bao ăn vào rồi thì pải sinh mã đôi cáp mới
            if ((await bancheo.kiemtra_thuebao_sd_madoicap(this.tinh, this.thongso_tc.ma_doicap)) != 0) {
              //(new HopDong().Kiemtra_thuebao_sd_madoicap(tinh, Convert.ToDecimal(thongso_tc.ma_doicap.trim())) != 0)
              rowHDBC_MGWAN.MADOICAP = await bancheo.GetKey(this.tinh, 'MADOICAP') //new SinhMoi().GetKey(tinh, "MADOICAP");
            } else rowHDBC_MGWAN.MADOICAP = this.thongso_tc.ma_doicap
          } // Trường hợp trên text chưa có mã đôi cáp thì sinh mã đôi cáp khác
          else {
            rowHDBC_MGWAN.MADOICAP = await bancheo.GetKey(this.tinh, 'MADOICAP') //new SinhMoi().GetKey(tinh, "MADOICAP");
          }
        }
      }

      if (this.thongso_tc.kieuld_id == KieuLapDat.TACH_VLAN) {
        //todoing
        // var tb_tn_id = await bancheo.map_id(this.tinh, "thuebao_id","CSS.db_thuebao","where ma_tb = '" + rowHDBC_MGWAN.MADOICAP + "'");//Convert.ToInt64(new CheckData().MAP_ID(tinh, "thuebao_id", "CSS_" + tinh.matinh + ".db_thuebao", "where ma_tb = '" + rowHDBC_MGWAN.MADOICAP + "'"));
        const resTBTN = bancheo.lay_id_thuebao_chia_vlan(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, vma_tb: this.ma_tb_ht })
        let tb_tn_id
        if (resTBTN && resTBTN.data) {
          tb_tn_id = resTBTN.data.data
        }
        if (tb_tn_id != -1) {
          var ds_mg = []
          ds_mg = (await bancheo.LAY_DS_DB_MEGAWAN_THEO_TBID(this.tinh, tb_tn_id)) || []
          if (ds_mg.length > 0) {
            if (ds_mg[0]['port_id']) rowHDBC_MGWAN.PORT_ID = ds_mg[0]['port_id'] * 1
            if (ds_mg[0]['vci_vpi_id']) rowHDBC_MGWAN.VCI_VPI_ID = ds_mg[0]['vci_vpi_id'] * 1
            rowHDBC_MGWAN.SLOT_PE = ds_mg[0]['slot_pe']
            rowHDBC_MGWAN.PORT_PE = ds_mg[0]['port_pe']
            rowHDBC_MGWAN.LAN_IP = ds_mg[0]['lan_ip']
            rowHDBC_MGWAN.WAN_IP = ds_mg[0]['wan_ip']
            rowHDBC_MGWAN.ROUTE = ds_mg[0]['route']
            rowHDBC_MGWAN.LINK = ds_mg[0]['link']
            rowHDBC_MGWAN.VRF = ds_mg[0]['vrf']
            rowHDBC_MGWAN.SVLAN = ds_mg[0]['svlan']
            rowHDBC_MGWAN.CVLAN = ds_mg[0]['cvlan']
          }
        }
      }
      if (this.thongso_tc.kieuld_id == KieuLapDat.DATMOI_KENHPHU_AO) rowHDBC_MGWAN.KP_AO = 1
      else rowHDBC_MGWAN.KP_AO = 0

      if (this.thuebao.cvlct) {
        rowHDBC_MGWAN.MA_CV = this.thuebao.congvan ? this.thuebao.congvan.trim() : this.thuebao.congvan
        rowHDBC_MGWAN.NGAY_CV = this.thuebao.NgayCV
      }
      rowHDBC_MGWAN.MA_CRM = this.thuebao.crm ? this.thuebao.crm.trim() : ''
      rowHDBC_MGWAN.ID_ERP = this.thuebao.erp ? this.thuebao.erp.trim() : ''
      rowHDBC_MGWAN.MAKENH_VTN = this.thuebao.vtn ? this.thuebao.vtn.trim() : ''

      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MGW_INTERNET_TRUCTIEP || this.listbox.loaihinh_tb.value == LoaiHinhTB.NB_INTERNETTT) {
        if (this.thuebao.mgwan.soluongip) rowHDBC_MGWAN.SL_IP = this.thuebao.mgwan.soluongip
        else rowHDBC_MGWAN.SL_IP = 0

        if (this.thuebao.mgwan.cuocip) rowHDBC_MGWAN.CUOC_IP = this.thuebao.mgwan.cuocip
        else rowHDBC_MGWAN.CUOC_IP = 0

        if (this.listbox.phanloai_dv.list && this.listbox.phanloai_dv.list.length > 0 && this.listbox.phanloai_dv.value) rowHDBC_MGWAN.PHANLOAI_ID = this.listbox.phanloai_dv.value
        if (this.listbox.ht_phantach_tocdo.list && this.listbox.ht_phantach_tocdo.list.length > 0 && this.listbox.ht_phantach_tocdo.value) rowHDBC_MGWAN.PHANTACH_TD = this.listbox.ht_phantach_tocdo.value

        if (this.thongso_tc.tocdo_nix > 0) {
          rowHDBC_MGWAN.TOCDO_NIX = this.thongso_tc.tocdo_nix
          if (this.thuebao.mgwan.cuocnix) rowHDBC_MGWAN.CUOC_NIX = this.thuebao.mgwan.cuocnix
          else rowHDBC_MGWAN.CUOC_NIX = 0
        } else {
          rowHDBC_MGWAN.TOCDO_NIX = null
          rowHDBC_MGWAN.CUOC_NIX = null
        }

        if (this.thongso_tc.tocdo_isp > 0) {
          rowHDBC_MGWAN.TOCDO_ISP = this.thongso_tc.tocdo_isp
          if (this.thuebao.mgwan.cuocisp) rowHDBC_MGWAN.CUOC_ISP = this.thuebao.mgwan.cuocisp
          else rowHDBC_MGWAN.CUOC_ISP = 0
        } else {
          rowHDBC_MGWAN.TOCDO_ISP = null
          rowHDBC_MGWAN.CUOC_ISP = null
        }
        rowHDBC_MGWAN.TINHCUOC = this.listbox.cboTinhCuoc.value ? this.listbox.cboTinhCuoc.value * 1 : 1
      } else {
        rowHDBC_MGWAN.SL_IP = null
        rowHDBC_MGWAN.CUOC_IP = null
        rowHDBC_MGWAN.TOCDO_NIX = null
        rowHDBC_MGWAN.TOCDO_ISP = null
        rowHDBC_MGWAN.CUOC_NIX = null
        rowHDBC_MGWAN.CUOC_ISP = null
      }
      if (this.ma_vnpt != '-1') rowHDBC_MGWAN.MA_VNPT = this.ma_vnpt

      this.dsHDBCMGWAN.push(rowHDBC_MGWAN)
      //Tạo cho bảng hdtb_dv
      //End
    },
    async TaoDuLieu_HDBC_IMS(themmoi) {
      this.dsHDBCIMS = []
      var rowHDBCIMS = {}
      // rowHDBCIMS.Table = {};
      // rowHDBCIMS.Table.TableName = "HDBC_IMS";

      rowHDBCIMS.HDTB_ID = this.hdtb_id
      var kieu = await API.post_fn_tt_kieu_ld(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, param: this.thongso_tc.kieuld_id })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return 0
        })
        .catch(() => {
          return 0
        }) //this.kieu_ld_kieu;
      //Nếu lắp trên đường có sẵn hoặc lắp kèm thì lấy mã đôi cáp từ form chọn xuống
      if (kieu == 1 || kieu == 2 || kieu == 4) {
        rowHDBCIMS.MADOICAP = this.thongso_tc.ma_doicap
      } //TH còn lại sinh mã đôi cáp
      else {
        if (themmoi) {
          rowHDBCIMS.MADOICAP = await bancheo.GetKey(this.tinh, 'MADOICAP') //new SinhMoi().GetKey(tinh, "MADOICAP");
        } else {
          if (this.thongso_tc.ma_doicap && (this.thongso_tc.ma_doicap + '').trim().length > 0) {
            // Trong trường hợp : thêm mới kiểu lắp trên đường có sẵn hoặc lắp kèm, sau đó ấn ghi lại chọn trên đường ko số
            // => kiểm tra xem đã có thuê bao nào ăn vào mã đôi cáp này hay chưa
            // Nếu có thuê bao ăn vào rồi thì pải sinh mã đôi cáp thong
            if ((await bancheo.kiemtra_thuebao_sd_madoicap(this.tinh, this.thongso_tc.ma_doicap)) != 0)
              //(new HopDong().Kiemtra_thuebao_sd_madoicap(tinh, Convert.ToDecimal(thongso_tc.ma_doicap)) != 0)
              rowHDBCIMS.MADOICAP = await bancheo.GetKey(this.tinh, 'MADOICAP')
            //new SinhMoi().GetKey(tinh, "MADOICAP");
            else rowHDBCIMS.MADOICAP = this.thongso_tc.ma_doicap
          } // Trường hợp trên text chưa có mã đôi cáp thì sinh mã đôi cáp khác
          else rowHDBCIMS.MADOICAP = await bancheo.GetKey(this.tinh, 'MADOICAP') //new SinhMoi().GetKey(tinh, "MADOICAP");
        }
      }
      rowHDBCIMS.THOIHAN_ID = this.listbox.thoihan.valueims //Convert.ToInt16(cboThoiHan_IMS.SelectedValue);

      if (this.thongso_tc.congnghe_id > 0) rowHDBCIMS.CONGNGHE_ID = this.thongso_tc.congnghe_id
      else rowHDBCIMS.CONGNGHE_ID = null

      rowHDBCIMS.MATB_TN = this.thongso_tc.ma_tn
      rowHDBCIMS.TRANGBI_ID = this.thongso_tc.trangbi_id
      // BangThamSo bts = new BangThamSo();

      rowHDBCIMS.USERNAME = this.ma_tb_ht.toLowerCase()
      var tusinh_pass_ims = this.thamsomacdinh['TUSINH_PASS_IMS'] ? this.thamsomacdinh['TUSINH_PASS_IMS'] * 1 : 0
      var matkhau_md_ims = this.thamsomacdinh['MACDINH_MATKHAU_IMS'] ? this.thamsomacdinh['MACDINH_MATKHAU_IMS'].trim() : ''
      if (themmoi == true) {
        //this.thuebao.ims.
        this.thuebao.ims.pass_ims = ''
        if (tusinh_pass_ims == 100) {
          if (matkhau_md_ims != '') this.thuebao.ims.pass_ims = matkhau_md_ims + this.ma_tb_ht.toLowerCase()
          else {
            if (tusinh_pass_ims == 0) this.thuebao.ims.pass_ims = this.ma_tb_ht.toLowerCase()
            else this.thuebao.ims.pass_ims = this.GetRandomText(11)
          }
        } else if (tusinh_pass_ims == 50) {
          this.thuebao.ims.pass_ims = await bancheo.sinh_pass_random(1) //new TCHopDongFacade2().sinh_pass_random(1);
        } else {
          if (matkhau_md_ims != '') this.thuebao.ims.pass_ims = matkhau_md_ims
          else {
            if (tusinh_pass_ims == 0) this.thuebao.ims.pass_ims = this.ma_tb_ht.toLowerCase()
            else this.thuebao.ims.pass_ims = this.GetRandomText(11)
          }
        }
      }
      rowHDBCIMS.PASSWORD = this.thuebao.ims.pass_ims
      rowHDBCIMS.CHUQUAN_ID = this.thongso_tc.chuquan_id
      rowHDBCIMS.CHUQUANLD_ID = this.thongso_tc.chuquanld_id
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IMS_SIPTRUNKING) {
        rowHDBCIMS.SL_CUOCGOI = this.thuebao.ims.txtCuocGoiDT
        rowHDBCIMS.CTDV_ID = this.listbox.ht_chitietdv_ims.value
        if (this.listbox.ht_chitietdv_ims.value == ChiTietDV_IMS.internet) rowHDBCIMS.IP = this.thuebao.ims.txtIp_IMS ? this.thuebao.ims.txtIp_IMS.trim() : this.thuebao.ims.txtIp_IMS
        if (this.thuebao.ims.cbkTrunk) rowHDBCIMS.TRUNKID = this.thuebao.ims.cboTrunk
        rowHDBCIMS.HTTC_ID = this.listbox.hinhthuc_tc.valueims
      }

      if (this.ma_vnpt != '-1') rowHDBCIMS.MA_VNPT = this.ma_vnpt
      this.dsHDBCIMS.push(rowHDBCIMS)
    },
    TaoDuLieu_DiaChi_BanCheo(themmoi, kieu) {
      this.dsDiaChi_BanCheo = []

      if (kieu == 1 || kieu == 4) {
        var rowDiaChiKH_BC = {}
        var diachi = this.diachiKH
        if (!diachi.TINH_ID || !diachi.QUAN_ID || !diachi.PHUONG_ID) {
          this.$toast.error('Thiếú dữ liệu mã tỉnh / quận huyện / phường xã của địa chỉ KH. Vui lòng chọn lại địa chỉ KH!')
          throw 'Thiếú dữ liệu mã tỉnh / quận huyện / phường xã của địa chỉ KH. Vui lòng chọn lại địa chỉ KH!'
        }
        rowDiaChiKH_BC.DIACHI_ID = diachi.DIACHI_ID
        rowDiaChiKH_BC.TINH_ID = diachi.TINH_ID
        rowDiaChiKH_BC.QUAN_ID = diachi.QUAN_ID
        rowDiaChiKH_BC.PHUONG_ID = diachi.PHUONG_ID
        if (diachi.PHO_ID && diachi.PHO_ID != 0) rowDiaChiKH_BC.PHO_ID = diachi.PHO_ID
        if (diachi.AP_ID && diachi.AP_ID != 0) rowDiaChiKH_BC.AP_ID = diachi.AP_ID
        if (diachi.KHU_ID && diachi.KHU_ID != 0) rowDiaChiKH_BC.KHU_ID = diachi.KHU_ID
        if (diachi.DACDIEM_ID && diachi.DACDIEM_ID != 0) rowDiaChiKH_BC.DACDIEM_ID = diachi.DACDIEM_ID
        rowDiaChiKH_BC.SONHA = diachi.SONHA
        if (diachi.BLOCK) rowDiaChiKH_BC.BLOCK = diachi.BLOCK
        if (diachi.TANG) rowDiaChiKH_BC.TANG = diachi.TANG
        if (diachi.PHONG) rowDiaChiKH_BC.PHONG = diachi.PHONG
        if (diachi.MOTA) rowDiaChiKH_BC.BLOCK = diachi.MOTA

        rowDiaChiKH_BC.DIACHI = diachi.DIACHI
        rowDiaChiKH_BC.LOAI_DC = 1
        this.dsDiaChi_BanCheo.push(rowDiaChiKH_BC)
      }

      if (kieu == 2 || kieu == 4) {
        var rowDiaChiTT_BC = {}
        //DiachiTT
        var diachi = this.diachiTT
        if (!diachi.TINH_ID || !diachi.QUAN_ID || !diachi.PHUONG_ID) {
          this.$toast.error('Thiếú dữ liệu mã tỉnh / quận huyện / phường xã của địa chỉ TT. Vui lòng chọn lại địa chỉ TT!')
          throw 'Thiếú dữ liệu mã tỉnh / quận huyện / phường xã của địa chỉ TT. Vui lòng chọn lại địa chỉ TT!'
        }
        rowDiaChiTT_BC.DIACHI_ID = diachi.DIACHI_ID
        rowDiaChiTT_BC.TINH_ID = diachi.TINH_ID
        rowDiaChiTT_BC.QUAN_ID = diachi.QUAN_ID
        rowDiaChiTT_BC.PHUONG_ID = diachi.PHUONG_ID
        if (diachi.PHO_ID && diachi.PHO_ID != 0) rowDiaChiTT_BC.PHO_ID = diachi.PHO_ID
        if (diachi.AP_ID && diachi.AP_ID != 0) rowDiaChiTT_BC.AP_ID = diachi.AP_ID
        if (diachi.KHU_ID && diachi.KHU_ID != 0) rowDiaChiTT_BC.KHU_ID = diachi.KHU_ID
        if (diachi.DACDIEM_ID && diachi.DACDIEM_ID != 0) rowDiaChiTT_BC.DACDIEM_ID = diachi.DACDIEM_ID
        rowDiaChiTT_BC.SONHA = diachi.SONHA

        if (diachi.BLOCK) rowDiaChiTT_BC.BLOCK = diachi.BLOCK
        if (diachi.TANG) rowDiaChiTT_BC.TANG = diachi.TANG
        if (diachi.PHONG) rowDiaChiTT_BC.PHONG = diachi.PHONG
        if (diachi.MOTA) rowDiaChiTT_BC.BLOCK = diachi.MOTA

        rowDiaChiTT_BC.DIACHI = diachi.DIACHI
        rowDiaChiTT_BC.LOAI_DC = 2
        this.dsDiaChi_BanCheo.push(rowDiaChiTT_BC)
      }

      if (kieu == 3 || kieu == 4) {
        var rowDiaChiTB_BC = {}
        var rowDiachiLD_BC = {}
        //Địa chỉ lắp đặt --> dataset dsdiachi
        var diachi = this.diachiLD
        if (!diachi.TINH_ID || !diachi.QUAN_ID || !diachi.PHUONG_ID) {
          this.$toast.error('Thiếú dữ liệu mã tỉnh / quận huyện / phường xã của địa chỉ LD. Vui lòng chọn lại địa chỉ LD!')
          throw 'Thiếú dữ liệu mã tỉnh / quận huyện / phường xã của địa chỉ LD. Vui lòng chọn lại địa chỉ LD!'
        }
        rowDiachiLD_BC.DIACHI_ID = diachi.DIACHI_ID
        rowDiachiLD_BC.TINH_ID = diachi.TINH_ID
        rowDiachiLD_BC.QUAN_ID = diachi.QUAN_ID
        rowDiachiLD_BC.PHUONG_ID = diachi.PHUONG_ID
        if (diachi.PHO_ID && diachi.PHO_ID != 0) rowDiachiLD_BC.PHO_ID = diachi.PHO_ID
        if (diachi.AP_ID && diachi.AP_ID != 0) rowDiachiLD_BC.AP_ID = diachi.AP_ID
        if (diachi.KHU_ID && diachi.KHU_ID != 0) rowDiachiLD_BC.KHU_ID = diachi.KHU_ID
        if (diachi.DACDIEM_ID && diachi.DACDIEM_ID != 0) rowDiachiLD_BC.DACDIEM_ID = diachi.DACDIEM_ID
        rowDiachiLD_BC.SONHA = diachi.SONHA

        if (diachi.BLOCK) rowDiachiLD_BC.BLOCK = diachi.BLOCK
        if (diachi.TANG) rowDiachiLD_BC.TANG = diachi.TANG
        if (diachi.PHONG) rowDiachiLD_BC.PHONG = diachi.PHONG
        if (diachi.MOTA) rowDiachiLD_BC.BLOCK = diachi.MOTA

        rowDiachiLD_BC.DIACHI = diachi.DIACHI
        rowDiachiLD_BC.LOAI_DC = 4
        this.dsDiaChi_BanCheo.push(rowDiachiLD_BC)

        //Địa chỉ thuê bao --> dataset dsdiachi
        diachi = this.diachiTB
        if (!diachi.TINH_ID || !diachi.QUAN_ID || !diachi.PHUONG_ID) {
          this.$toast.error('Thiếú dữ liệu mã tỉnh / quận huyện / phường xã của địa chỉ TB. Vui lòng chọn lại địa chỉ TB!')
          throw 'Thiếú dữ liệu mã tỉnh / quận huyện / phường xã của địa chỉ TB. Vui lòng chọn lại địa chỉ TB!'
        }
        rowDiaChiTB_BC.DIACHI_ID = diachi.DIACHI_ID
        rowDiaChiTB_BC.TINH_ID = diachi.TINH_ID
        rowDiaChiTB_BC.QUAN_ID = diachi.QUAN_ID
        rowDiaChiTB_BC.PHUONG_ID = diachi.PHUONG_ID
        if (diachi.PHO_ID && diachi.PHO_ID != 0) rowDiaChiTB_BC.PHO_ID = diachi.PHO_ID
        if (diachi.AP_ID && diachi.AP_ID != 0) rowDiaChiTB_BC.AP_ID = diachi.AP_ID
        if (diachi.KHU_ID && diachi.KHU_ID != 0) rowDiaChiTB_BC.KHU_ID = diachi.KHU_ID
        if (diachi.DACDIEM_ID && diachi.DACDIEM_ID != 0) rowDiaChiTB_BC.DACDIEM_ID = diachi.DACDIEM_ID
        rowDiaChiTB_BC.SONHA = diachi.SONHA

        if (diachi.BLOCK) rowDiaChiTB_BC.BLOCK = diachi.BLOCK
        if (diachi.TANG) rowDiaChiTB_BC.TANG = diachi.TANG
        if (diachi.PHONG) rowDiaChiTB_BC.PHONG = diachi.PHONG
        if (diachi.MOTA) rowDiaChiTB_BC.BLOCK = diachi.MOTA

        rowDiaChiTB_BC.DIACHI = diachi.DIACHI
        rowDiaChiTB_BC.LOAI_DC = 3
        this.dsDiaChi_BanCheo.push(rowDiaChiTB_BC)

        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          var rowDiaChiDau_BC = {}
          diachi = this.diachiDau
          if (!diachi.TINH_ID || !diachi.QUAN_ID || !diachi.PHUONG_ID) {
            this.$toast.error('Thiếú dữ liệu mã tỉnh / quận huyện / phường xã của địa chỉ TSL đầu. Vui lòng chọn lại địa chỉ TSL đầu!')
            throw 'Thiếú dữ liệu mã tỉnh / quận huyện / phường xã của địa chỉ TSL đầu. Vui lòng chọn lại địa chỉ TSL đầu!'
          }
          rowDiaChiDau_BC.DIACHI_ID = diachi.DIACHI_ID
          rowDiaChiDau_BC.TINH_ID = diachi.TINH_ID
          rowDiaChiDau_BC.QUAN_ID = diachi.QUAN_ID
          rowDiaChiDau_BC.PHUONG_ID = diachi.PHUONG_ID
          if (diachi.PHO_ID && diachi.PHO_ID != 0) rowDiaChiDau_BC.PHO_ID = diachi.PHO_ID
          if (diachi.AP_ID && diachi.AP_ID != 0) rowDiaChiDau_BC.AP_ID = diachi.AP_ID
          if (diachi.KHU_ID && diachi.KHU_ID != 0) rowDiaChiDau_BC.KHU_ID = diachi.KHU_ID
          if (diachi.DACDIEM_ID && diachi.DACDIEM_ID != 0) rowDiaChiDau_BC.DACDIEM_ID = diachi.DACDIEM_ID
          rowDiaChiDau_BC.SONHA = diachi.SONHA

        if (diachi.BLOCK) rowDiaChiDau_BC.BLOCK = diachi.BLOCK
        if (diachi.TANG) rowDiaChiDau_BC.TANG = diachi.TANG
        if (diachi.PHONG) rowDiaChiDau_BC.PHONG = diachi.PHONG
        if (diachi.MOTA) rowDiaChiDau_BC.BLOCK = diachi.MOTA

          rowDiaChiDau_BC.DIACHI = diachi.DIACHI
          rowDiaChiDau_BC.LOAI_DC = 5
          this.dsDiaChi_BanCheo.push(rowDiaChiDau_BC)

          var rowDiaChiCuoi_BC = {}
          diachi = this.diachiCuoi
          if (!diachi.TINH_ID || !diachi.QUAN_ID || !diachi.PHUONG_ID) {
            this.$toast.error('Thiếú dữ liệu mã tỉnh / quận huyện / phường xã của địa chỉ TSL cuối. Vui lòng chọn lại địa chỉ TSL cuối!')
            throw 'Thiếú dữ liệu mã tỉnh / quận huyện / phường xã của địa chỉ TSL cuối. Vui lòng chọn lại địa chỉ TSL cuối!'
          }
          rowDiaChiCuoi_BC.DIACHI_ID = diachi.DIACHI_ID
          rowDiaChiCuoi_BC.TINH_ID = diachi.TINH_ID
          rowDiaChiCuoi_BC.QUAN_ID = diachi.QUAN_ID
          rowDiaChiCuoi_BC.PHUONG_ID = diachi.PHUONG_ID
          if (diachi.PHO_ID && diachi.PHO_ID != 0) rowDiaChiCuoi_BC.PHO_ID = diachi.PHO_ID
          if (diachi.AP_ID && diachi.AP_ID != 0) rowDiaChiCuoi_BC.AP_ID = diachi.AP_ID
          if (diachi.KHU_ID && diachi.KHU_ID != 0) rowDiaChiCuoi_BC.KHU_ID = diachi.KHU_ID
          if (diachi.DACDIEM_ID && diachi.DACDIEM_ID != 0) rowDiaChiCuoi_BC.DACDIEM_ID = diachi.DACDIEM_ID
          rowDiaChiCuoi_BC.SONHA = diachi.SONHA

        if (diachi.BLOCK) rowDiaChiCuoi_BC.BLOCK = diachi.BLOCK
        if (diachi.TANG) rowDiaChiCuoi_BC.TANG = diachi.TANG
        if (diachi.PHONG) rowDiaChiCuoi_BC.PHONG = diachi.PHONG
        if (diachi.MOTA) rowDiaChiCuoi_BC.BLOCK = diachi.MOTA

          rowDiaChiCuoi_BC.DIACHI = diachi.DIACHI
          rowDiaChiCuoi_BC.LOAI_DC = 6
          this.dsDiaChi_BanCheo.push(rowDiaChiCuoi_BC)
        }
      }

      // if (!themmoi)
      // {
      //     dsDiaChi_BanCheo.AcceptChanges();
      //     if (kieu == 1 || kieu == 2 || kieu == 3)
      //     {
      //         dsDiaChi_BanCheo.DIACHI_BANCHEO.Rows[0].SetModified();

      //         if (kieu == 3)
      //         {
      //             dsDiaChi_BanCheo.DIACHI_BANCHEO.Rows[1].SetModified();
      //             if (dichvuvt_id == DichVuVienThong.TSL)
      //             {
      //                 dsDiaChi_BanCheo.DIACHI_BANCHEO.Rows[2].SetModified();
      //             }
      //         }
      //     }
      //     else
      //     {
      //         dsDiaChi_BanCheo.DIACHI_BANCHEO.Rows[0].SetModified();
      //         dsDiaChi_BanCheo.DIACHI_BANCHEO.Rows[1].SetModified();
      //         dsDiaChi_BanCheo.DIACHI_BANCHEO.Rows[2].SetModified();
      //         dsDiaChi_BanCheo.DIACHI_BANCHEO.Rows[3].SetModified();
      //         if (dichvuvt_id == DichVuVienThong.TSL)
      //         {
      //             dsDiaChi_BanCheo.DIACHI_BANCHEO.Rows[4].SetModified();
      //             dsDiaChi_BanCheo.DIACHI_BANCHEO.Rows[5].SetModified();
      //         }
      //     }
      // }
    },
    TaoDuLieu_DKDV_BC() {
      this.dsDK_DVGT_BC = []

      // dsDK_DVGT_BC.TableName = "DANGKY_DVGT_BC";
      var kieu_dk_dvgt
      if(this.m_dsThueBao_DichVu && this.m_dsThueBao_DichVu.length>0)
      for (var dr of this.m_dsThueBao_DichVu.filter(x=>x.bancheo==1)) {
        if (dr['dangky'] == '1') kieu_dk_dvgt = KieuCaiDatDVGT.KIEU_CD_THEM_MOI_DVGT
        else if (dr['huy'] == '1') kieu_dk_dvgt = KieuCaiDatDVGT.KIEU_CD_HUY_DVGT
        else {
          continue
        }

        var rowHDTDDVBC = {}
        rowHDTDDVBC.HDTB_ID = this.hdtb_id
        rowHDTDDVBC.NGAY_YC = this.NgayYeuCau
        rowHDTDDVBC.DICHVUGT_ID = dr['DICHVUGT_ID'.toLowerCase()]
        rowHDTDDVBC.NOIDUNG = dr['NOIDUNG'.toLowerCase()]
        rowHDTDDVBC.KIEU_YC = kieu_dk_dvgt
        if (dr['CUOC_SD'.toLowerCase()]) rowHDTDDVBC.CUOC_SD = dr['CUOC_SD'.toLowerCase()] * 1
        else rowHDTDDVBC.CUOC_SD = 0
        if (dr['VAT_SD'.toLowerCase()]) rowHDTDDVBC.VAT_SD = dr['VAT_SD'.toLowerCase()] * 1
        else rowHDTDDVBC.VAT_SD = 0
        rowHDTDDVBC.TTTH = 1

        this.dsDK_DVGT_BC.push(rowHDTDDVBC)
      }
    },
    TaoDuLieu_HDTB_LOAIIP_MGWAN() {
      try {
        this.dsHDTB_LoaiIp = []
        if (this.thongso_ban.loai_ip != null && this.thongso_ban.loai_ip.length > 0) {
          for (var i = 0; i < this.thongso_ban.loai_ip.length; i++) {
            var rowHDTB_LIP = {}
            rowHDTB_LIP.HDTB_ID = this.hdtb_id
            rowHDTB_LIP.LOAIIP_ID = this.thongso_ban.loai_ip[i]['LOAIIP_ID'] * 1
            this.dsHDTB_LoaiIp.push(rowHDTB_LIP)
          }
        }
      } catch (ex) {}
    },
    TaoDuLieu_HDTB_KIEU_NT() {
      try {
        this.dsHDTB_Kieu_NT = []
        if (this.thongso_ban.kieu_nghiemthu != null && this.thongso_ban.kieu_nghiemthu.length > 0) {
          for (var i = 0; i < this.thongso_ban.kieu_nghiemthu.length; i++) {
            var rowHDTB_KNT = {}
            rowHDTB_KNT.HDTB_ID = this.hdtb_id
            rowHDTB_KNT.KIEUNT_ID = this.thongso_ban.kieu_nghiemthu[i] * 1
            this.dsHDTB_Kieu_NT.push(rowHDTB_KNT)
          }
        }
      } catch (ex) {}
    },
    TaoDuLieu_HDBC_TSL(themmoi, vdaucuoi_id) {
      // vdaucuoi_id = 1: tỉnh đầu, 2 : tỉnh cuối
      var rowHDBC_TSL = {}

      if (vdaucuoi_id == 1) {
        // Thực hiện tạo dữ liệu cho tỉnh đầu
        for (var i = 0; i < 2; i++) {
          rowHDBC_TSL = {}
          rowHDBC_TSL.HDTB_ID = this.hdtb_id
          rowHDBC_TSL.DAUCUOI_ID = i + 1
          rowHDBC_TSL.MA_PL = this.thuebao.tsl.txtMaHD_TTKD_TSL ? this.thuebao.tsl.txtMaHD_TTKD_TSL.trim() : this.thuebao.tsl.txtMaHD_TTKD_TSL
          rowHDBC_TSL.TOCDO_ID = this.thuebao.tsl.thongso_tc_dau.tocdo_id
          rowHDBC_TSL.LOAIKENH_ID = this.thuebao.tsl.thongso_tc_dau.loaikenh_id
          rowHDBC_TSL.THOIHAN_ID = this.listbox.thoihan.valuetsl * 1
          rowHDBC_TSL.TRANGBI_ID = this.thuebao.tsl.thongso_tc_dau.trangbi_id
          rowHDBC_TSL.CHUQUAN_ID = this.thuebao.tsl.thongso_tc_dau.chuquan_id
          rowHDBC_TSL.CHUQUANLD_ID = this.thuebao.tsl.thongso_tc_dau.chuquanld_id
          rowHDBC_TSL.TINH_DC_ID = 1

          if (this.thuebao.tsl.thongso_tc_dau.congnghe_id * 1 > 0) rowHDBC_TSL.CONGNGHE_ID = this.thuebao.tsl.thongso_tc_dau.congnghe_id * 1
          else rowHDBC_TSL.CONGNGHE_ID = null

          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.CAPQUANG_TRANG_TSL) {
            if (this.thuebao.tsl.txtSoSoiQuang) rowHDBC_TSL.SL_SOIQUANG = this.thuebao.tsl.txtSoSoiQuang * 1
            else rowHDBC_TSL.SL_SOIQUANG = null
          } else rowHDBC_TSL.SL_SOIQUANG = null

          if (this.thuebao.cvlct) {
            rowHDBC_TSL.MA_CV = this.thuebao.congvan ? this.thuebao.congvan.trim() : this.thuebao.congvan
            rowHDBC_TSL.NGAY_CV = this.thuebao.NgayCV
          }

          rowHDBC_TSL.MA_CRM = this.thuebao.crm ? this.thuebao.crm.trim() : this.thuebao.crm
          rowHDBC_TSL.ID_ERP = this.thuebao.erp ? this.thuebao.erp.trim() : this.thuebao.erp
          rowHDBC_TSL.MAKENH_VTN = this.thuebao.vtn ? this.thuebao.vtn.trim() : this.thuebao.vtn

          if (this.thuebao.tsl.txtCuocHT_TSL) rowHDBC_TSL.CUOC_HT = this.thuebao.tsl.txtCuocHT_TSL * 1
          else rowHDBC_TSL.CUOC_HT = 0

          if (this.thuebao.tsl.txtCuocTBI_TSL) rowHDBC_TSL.CUOC_TBI = this.thuebao.tsl.txtCuocTBI_TSL * 1
          else rowHDBC_TSL.CUOC_TBI = 0

          if (this.thuebao.tsl.txtCuocTC_TSL) rowHDBC_TSL.CUOC_TC = this.thuebao.tsl.txtCuocTC_TSL * 1
          else rowHDBC_TSL.CUOC_TC = 0

          if (this.thuebao.tsl.txtCuocTK_TSL) rowHDBC_TSL.CUOC_TK = this.thuebao.tsl.txtCuocTK_TSL * 1
          else rowHDBC_TSL.CUOC_TK = 0

          if (i == 0) {
            //Nếu là điểm đầu
            rowHDBC_TSL.TINH_ID = this.thuebao.tsl.tinh_dau.tinhthicong_id
            rowHDBC_TSL.DIACHI = this.diachiDau.DIACHI
            rowHDBC_TSL.DIACHI_ID = this.diachiDau.DIACHI_ID
            rowHDBC_TSL.KINHDO_LD = this.diachiDau.Lng
            rowHDBC_TSL.VIDO_LD = this.diachiDau.Lat
            rowHDBC_TSL.MA_TB_SUB = this.thuebao.tsl.txtMaTSL.Text ? this.thuebao.tsl.txtMaTSL.Text.trim() + '_01' : '_01'
            rowHDBC_TSL.MA_LT = this.bc_ma_tb_ao_ht

            rowHDBC_TSL.THIETBIDC_ID = this.thuebao.tsl.thongso_tc_dau.thietbidc_id
            rowHDBC_TSL.LOAICAP_ID = this.listbox.loaicap.valuedau
            rowHDBC_TSL.SITE_ID = this.thuebao.tsl.txtSiteIDTSL_Dau ? this.thuebao.tsl.txtSiteIDTSL_Dau.trim() : this.thuebao.tsl.txtSiteIDTSL_Dau
            rowHDBC_TSL.VRF = this.thuebao.tsl.txtVrf_Dau ? this.thuebao.tsl.txtVrf_Dau.trim() : this.thuebao.tsl.txtVrf_Dau
            //rowHDTB_TSL.SO_DT = txtSoDTDau.Text;
          } else {
            rowHDBC_TSL.TINH_ID = this.thuebao.tsl.tinh_cuoi.tinhthicong_id
            rowHDBC_TSL.DIACHI = this.diachiCuoi.DIACHI
            rowHDBC_TSL.DIACHI_ID = this.diachiDau.DIACHI_ID //NOTE thangdm1 2023-06-07 chỗ này kiểu nó vầy!
            rowHDBC_TSL.KINHDO_LD = this.diachiCuoi.Lng
            rowHDBC_TSL.VIDO_LD = this.diachiCuoiLat
            rowHDBC_TSL.MA_TB_SUB = this.thuebao.tsl.txtMaTSL.Text ? this.thuebao.tsl.txtMaTSL.Text.trim() + '_02' : '_02'
            rowHDBC_TSL.MA_LT = this.bc_ma_tb_ao_ht_cuoi

            rowHDBC_TSL.THIETBIDC_ID = this.thuebao.tsl.thongso_tc_dau.thietbidc_id_cuoi
            rowHDBC_TSL.LOAICAP_ID = this.listbox.loaicap.valuecuoi
            rowHDBC_TSL.SITE_ID = this.thuebao.tsl.txtSiteIDTSL_Cuoi ? this.thuebao.tsl.txtSiteIDTSL_Cuoi.trim() : this.thuebao.tsl.txtSiteIDTSL_Cuoi
            rowHDBC_TSL.VRF = this.thuebao.tsl.txtVrf_Cuoi ? this.thuebao.tsl.txtVrf_Cuoi.trim() : this.thuebao.tsl.txtVrf_Cuoi
            //rowHDTB_TSL.SO_DT = txtSoDTCuoi.Text;
          }
          if (this.ma_vnpt != '-1') rowHDBC_TSL.MA_VNPT = this.ma_vnpt
          this.dsHDBC_TSL.push(rowHDBC_TSL)
        }
      } // Thực hiện tại dữ liệu cho tỉnh cuối
      else {
        for (var i = 0; i < 2; i++) {
          rowHDBC_TSL = {}
          rowHDBC_TSL.HDTB_ID = this.hdtb_id
          rowHDBC_TSL.DAUCUOI_ID = i + 1
          rowHDBC_TSL.MA_PL = this.thuebao.tsl.txtMaHD_TTKD_TSL ? this.thuebao.tsl.txtMaHD_TTKD_TSL.trim() : this.thuebao.tsl.txtMaHD_TTKD_TSL
          rowHDBC_TSL.TOCDO_ID = this.thuebao.tsl.thongso_tc_cuoi.tocdo_id
          rowHDBC_TSL.LOAIKENH_ID = this.thuebao.tsl.thongso_tc_cuoi.loaikenh_id
          rowHDBC_TSL.THOIHAN_ID = this.listbox.thoihan.valuetsl
          rowHDBC_TSL.TRANGBI_ID = this.thuebao.tsl.thongso_tc_cuoi.trangbi_id
          rowHDBC_TSL.CHUQUAN_ID = this.thuebao.tsl.thongso_tc_cuoi.chuquan_id
          rowHDBC_TSL.CHUQUANLD_ID = this.thuebao.tsl.thongso_tc_cuoi.chuquanld_id
          rowHDBC_TSL.TINH_DC_ID = 2

          if (this.thongso_tc.congnghe_id > 0) rowHDBC_TSL.CONGNGHE_ID = this.thongso_tc.congnghe_id * 1
          else rowHDBC_TSL.CONGNGHE_ID = null

          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.CAPQUANG_TRANG_TSL) {
            if (this.thuebao.tsl.txtSoSoiQuang) rowHDBC_TSL.SL_SOIQUANG = this.thuebao.tsl.txtSoSoiQuang * 1
            else rowHDBC_TSL.SL_SOIQUANG = null
          } else rowHDBC_TSL.SL_SOIQUANG = null

          if (this.thuebao.cvlct) {
            rowHDBC_TSL.MA_CV = this.thuebao.congvan ? this.thuebao.congvan.trim() : this.thuebao.congvan
            rowHDBC_TSL.NGAY_CV = this.thuebao.NgayCV
          }

          rowHDBC_TSL.MA_CRM = this.thuebao.crm ? this.thuebao.crm.trim() : this.thuebao.crm
          rowHDBC_TSL.ID_ERP = this.thuebao.erp ? this.thuebao.erp.trim() : this.thuebao.erp
          rowHDBC_TSL.MAKENH_VTN = this.thuebao.vtn ? this.thuebao.vtn.trim() : this.thuebao.vtn

          if (this.thuebao.tsl.txtCuocHT_TSL) rowHDBC_TSL.CUOC_HT = this.thuebao.tsl.txtCuocHT_TSL * 1
          else rowHDBC_TSL.CUOC_HT = 0

          if (this.thuebao.tsl.txtCuocTBI_TSL) rowHDBC_TSL.CUOC_TBI = this.thuebao.tsl.txtCuocTBI_TSL * 1
          else rowHDBC_TSL.CUOC_TBI = 0

          if (this.thuebao.tsl.txtCuocTC_TSL) rowHDBC_TSL.CUOC_TC = this.thuebao.tsl.txtCuocTC_TSL * 1
          else rowHDBC_TSL.CUOC_TC = 0

          if (this.thuebao.tsl.txtCuocTK_TSL) rowHDBC_TSL.CUOC_TK = this.thuebao.tsl.txtCuocTK_TSL * 1
          else rowHDBC_TSL.CUOC_TK = 0

          if (i == 0) {
            //Nếu là điểm đầu
            rowHDBC_TSL.TINH_ID = this.thuebao.tsl.tinh_dau.tinhthicong_id
            rowHDBC_TSL.DIACHI = this.diachiDau.DIACHI
            rowHDBC_TSL.DIACHI_ID = this.diachiCuoi.DIACHI_ID //NOTE thangdm1 2023-06-07 chỗ này kiểu nó vầy!
            rowHDBC_TSL.KINHDO_LD = this.diachiDau.Lng
            rowHDBC_TSL.VIDO_LD = this.diachiDau.Lat
            rowHDBC_TSL.MA_TB_SUB = this.thuebao.tsl.txtMaTSL.Text ? this.thuebao.tsl.txtMaTSL.Text.trim() + '_01' : '_01'
            rowHDBC_TSL.MA_LT = this.bc_ma_tb_ao_ht

            rowHDBC_TSL.THIETBIDC_ID = this.thuebao.tsl.thongso_tc_cuoi.thietbidc_id
            rowHDBC_TSL.LOAICAP_ID = this.listbox.loaicap.valuedau
            rowHDBC_TSL.SITE_ID = this.thuebao.tsl.txtSiteIDTSL_Dau ? this.thuebao.tsl.txtSiteIDTSL_Dau.trim() : this.thuebao.tsl.txtSiteIDTSL_Dau
            rowHDBC_TSL.VRF = this.thuebao.tsl.txtVrf_Dau ? this.thuebao.tsl.txtVrf_Dau.trim() : this.thuebao.tsl.txtVrf_Dau
            //rowHDTB_TSL.SO_DT = txtSoDTDau.Text;
          } else {
            rowHDBC_TSL.TINH_ID = this.thuebao.tsl.tinh_cuoi.tinhthicong_id
            rowHDBC_TSL.DIACHI = this.diachiCuoi.DIACHI
            rowHDBC_TSL.DIACHI_ID = this.diachiCuoi.DIACHI_ID
            rowHDBC_TSL.KINHDO_LD = this.diachiCuoi.Lng
            rowHDBC_TSL.VIDO_LD = this.diachiCuoiLat
            rowHDBC_TSL.MA_TB_SUB = this.thuebao.tsl.txtMaTSL.Text ? this.thuebao.tsl.txtMaTSL.Text.trim() + '_02' : '_02'
            rowHDBC_TSL.MA_LT = this.bc_ma_tb_ao_ht_cuoi

            rowHDBC_TSL.THIETBIDC_ID = this.thuebao.tsl.thongso_tc_cuoi.thietbidc_id_cuoi
            rowHDBC_TSL.LOAICAP_ID = this.listbox.loaicap.valuecuoi
            rowHDBC_TSL.SITE_ID = this.thuebao.tsl.txtSiteIDTSL_Cuoi ? this.thuebao.tsl.txtSiteIDTSL_Cuoi.trim() : this.thuebao.tsl.txtSiteIDTSL_Cuoi
            rowHDBC_TSL.VRF = this.thuebao.tsl.txtVrf_Cuoi ? this.thuebao.tsl.txtVrf_Cuoi.trim() : this.thuebao.tsl.txtVrf_Cuoi
            //rowHDTB_TSL.SO_DT = txtSoDTCuoi.Text;
          }
          if (this.ma_vnpt != '-1') rowHDBC_TSL.MA_VNPT = this.ma_vnpt
          this.dsHDBC_TSL.push(rowHDBC_TSL)
        }
      }
    },
    async KiemTraMSTTB() {
      if (this.thuebao.txtMSTThueBao && (this.thuebao.txtMSTThueBao+'').trim() != '') {
          await this.Laythongtin_kh_tiemnang(this.thuebao.txtMSTThueBao);
        }
    },
    async Laythongtin_kh_tiemnang(mst) {
      //https://cntt.vnpt.vn/browse/VNPSR-10681
      //Với KHDN, lấy ra thông tin khách hàng trên hệ thống KHDN để auto điền vào form
      try
      {
          //Nếu là KHDN thì mới xử lý
          if (!mst || (mst+'').trim()=="") return;
          //Nếu là KH doanh nghiệp thì sẽ lấy thông tin từ hệ thống KHDN
          if (this.vkieukh_id_ != KIEU_KH.DOANH_NGHIEP) return; //Khách hàng doanh nghiệp
          // var client = new RestClient();
          await API.post_search_khtn(this.axios,{mst:mst}).then(async (response) => {
            if (response && response.data && response.data.data && response.data.errorCode*1 === 0) {
              var rss = JSON.parse(response.data.data);
              if(rss && rss['result'] && rss.result.length>0) {
                let cfr = await this.$bvModal
                  .msgBoxConfirm(`Tìm thấy thông tin khách hàng từ hệ thống KHDN, bạn có muốn sử dụng các thông tin này ?`, {
                    title: 'Thông báo',
                    size: 'sm',
                    okTitle: 'Đồng ý',
                    cancelTitle: 'Hủy'
                })
                .then((v) => {
                  return v
                })
                if(cfr) {
                  this.khachhang.tenkh = rss["result"][0]["FULL_NAME"];
                  this.diachiKH.DIACHI = rss["result"][0]["ADDR"];
                  this.khachhang.nguoidd = rss["result"][0]["DD_NAME"];
                  this.khachhang.dienthoai = rss["result"][0]["PHONE"];
                }
              }
            } else if (response.data.faultString) this.$toast.error(response.data.faultString);
          })
      }
      catch (ex)
      {
          this.$toast.error("Không lấy được thông tin từ hệ thống Khách hàng tiềm năng !");
          if(this.debug) console.error(ex);
      }
    },
    async HienThiTT_DanhBa_KHDN(ds) {
      try {
        if (ds.length > 0) {
          this.khachhang.makh = ds[0]['ma_kh']+''
          this.khachhang.khachhang_id = 0
          this.thuebao.tentb = this.ChuanHoaTen(ds[0]['full_name'])
          this.thanhtoan.tentt = this.ChuanHoaTen(ds[0]['full_name'])
          this.khachhang.tenkh = this.ChuanHoaTen(ds[0]['full_name'])

          this.diachiKH.DIACHI = this.ChuanHoaTen(ds[0]['addr'])
          this.diachiNDD.DIACHI = this.ChuanHoaTen(ds[0]['addr'])
          this.diachiTT.DIACHI = this.ChuanHoaTen(ds[0]['addr'])
          this.diachiCT.DIACHI = this.ChuanHoaTen(ds[0]['addr'])
          this.diachiBC.DIACHI = this.ChuanHoaTen(ds[0]['addr'])
          this.diachiHK.DIACHI = this.ChuanHoaTen(ds[0]['addr'])
          if (ds[0]['ngay_thanh_lap']) {
            // ngày thành lập = ngày sinh nhật
            this.NgaySinh = ds[0]['ngay_thanh_lap']
            this.NgaySinhTB = ds[0]['ngay_thanh_lap']
          } else {
            this.NgaySinh = ''
          }

          this.NgayYeuCau = moment(new Date()).format('DD/MM/YYYY HH:mm:ss') //tt_nd.ngay_cn;
          if (ds[0]['diachi_id']) {
            var diachi_web = await API.post_lay_diachi_theo_diachi_id(this.axios, { vdiachi_id: ds[0]['diachi_id'] })
              .then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  return response.data.data
                } else return []
              })
              .catch(() => {
                return []
              })
            this.HienThiTTDiaChi(diachi_web, 1)
            this.HienThiTTDiaChi(diachi_web, 2)
            this.HienThiTTDiaChi(diachi_web, 3)
          }
          // rdoGTNone.Checked = true

          if (ds[0]['phone']) this.khachhang.dienthoai = ds[0]['phone']
          //txtTelKH.Text = ds[0]["phone"];
          else if (ds[0]['dd_phone']) this.khachhang.dienthoai = ds[0]['dd_phone'] //txtTelKH.Text = ds[0]["dd_phone"];

          this.khachhang.nguoidd = ds[0]['dd_name']

          if (ds[0]['tnc1_id']) {
            this.tieunganh.TNC1_ID = ds[0]['tnc1_id']
          }
          if (ds[0]['tnc2_id']) {
            this.tieunganh.TNC2_ID = ds[0]['tnc2_id']
          }
          if (ds[0]['tnc3_id']) {
            this.tieunganh.TNC3_ID = ds[0]['tnc3_id']
          }

          if (ds[0]['nganh_nghe']) {
            try {
              this.listbox.nganhngheloc.value = ds[0]['nganh_nghe'] //cboNganhNghe.SelectedValue = ds[0]["nganh_nghe"];
              this.nganhnghe_id = ds[0]['nganh_nghe']
            } catch (ex) {
              this.nganhnghe_id = 999
              this.listbox.nganhngheloc.value = 999 //cboNganhNghe.SelectedValue = 999;
              TNC1_ID = 9991
              TNC2_ID = 99911
              TNC3_ID = 999111
            }
          }

          //cboNganhNghe.SelectedValue = 999;
          //nganhnghe_id = 999;

          this.listbox.nganhang.sotaikhoankh = ds[0]['so_tk'] //txtSoTKKH.Text

          this.NgayHH = null //txtNgayHetHan.Text = "";

          this.khachhang.masothue = ds[0]['mst']

          this.khachhang.sogt = ds[0]['so_gt']
          if (ds[0]['ngan_hang']) {
            this.listbox.nganhang.ischeckedkh = true
            this.listbox.nganhang.valuekh = ds[0]['ngan_hang']
          } else this.listbox.nganhang.ischeckedkh = false
          if (ds[0]['loai_gt'] == '2' || ds[0]['loai_gt'] == '1') {
            this.listbox.loai_gt.value = 54 //quyết định thành lập
            if (ds[0]['ngay_thanh_lap'] != '') {
              // ngày thành lập = ngày sinh nhật
              this.NgayCap = ds[0]['ngay_thanh_lap']
            } else {
              this.NgayCap = null
            }
          } //else if (ds[0]["loai_gt"].ToString() == "1")
          //    cboGiayToKH.SelectedValue = 130; //đăng ký kinh doanh
        } else {
          this.buttonSet = 0 //SetButton(0);
        }
      } catch (exp) {
        this.$toast.error(exp)
        if (this.debug) console.error(exp)
        //new LogError().GetError(new log4net.Core.LoggingEvent(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType, log.Logger.Repository, log.Logger.Name, log4net.Core.Level.Info, exp.Message, exp), true);
      }
    },
    async cboLoaiKenh_SelectedValueChanged() {
      if (!this.kt_load) {
        this.loading(true)
        if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
          await this.HienThi_CTK_CTC()
          this.HienThi_CTK_NIX_ISP(2)
          this.HienThi_CTK_NIX_ISP(3)
        }
        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) await this.HienThi_CTK_CTC()
        await this.HT_GIAODIEN_DONVI()
        this.loading(false)
      }
    },
    async HienThi_CTK_CTC() {
      var int_loaitb_id = 0
      var int_tocdo_id = 0
      var int_doituong_id = 0
      var int_loaikenh_id = 0
      int_loaitb_id = this.listbox.loaihinh_tb.value * 1
      int_doituong_id = this.listbox.doituong.value * 1
      if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
        if (this.listbox.tocdokenh.valuetsl) int_tocdo_id = this.listbox.tocdokenh.valuetsl * 1
        else return

        int_loaikenh_id = this.listbox.loaikenh.valuetsl * 1
      }
      if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
        if (this.listbox.tocdokenh.valuecir) int_tocdo_id = this.listbox.tocdokenh.valuecir * 1
        //Convert.ToInt32(cboTocDo.EditValue);
        else return
        int_loaikenh_id = this.listbox.loaikenh.value * 1
      }

      let ds_ctk_ctc = []
      ds_ctk_ctc = await API.post_sp_lay_cuoctk_cuoctc(this.axios, {
        vloaitb_id: int_loaitb_id,
        vtocdo_id: int_tocdo_id,
        vdoituong_id: int_doituong_id,
        vloaikenh_id: int_loaikenh_id,
        vkieu: 1
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          return response.data.data
        }
      }) // ds_ctk_ctc = bangts.Lay_CUOCTK_CUOCTC(int_loaitb_id, int_tocdo_id, int_doituong_id, int_loaikenh_id, 1);
      if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
        if (ds_ctk_ctc && ds_ctk_ctc.length > 0 && ds_ctk_ctc[0]['cuoc_tk']) {
          this.thuebao.mgwan.cuoctk = ds_ctk_ctc[0]['cuoc_tk'] ? ds_ctk_ctc[0]['cuoc_tk'] * 1 : 0
          this.thuebao.mgwan.cuoctc = ds_ctk_ctc[0]['cuoc_tc'] ? ds_ctk_ctc[0]['cuoc_tc'] * 1 : 0
        } else {
          this.thuebao.mgwan.cuoctk = 0
          this.thuebao.mgwan.cuoctc = 0
        }
      }
      if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
        if (ds_ctk_ctc && ds_ctk_ctc.length > 0 && ds_ctk_ctc[0]['cuoc_tk']) {
          this.thuebao.tsl.txtCuocTK_TSL = ds_ctk_ctc[0]['cuoc_tk'] ? ds_ctk_ctc[0]['cuoc_tk'] * 1 : 0
          this.thuebao.tsl.txtCuocTC_TSL = ds_ctk_ctc[0]['cuoc_tc'] ? ds_ctk_ctc[0]['cuoc_tc'] * 1 : 0
        } else {
          this.thuebao.tsl.txtCuocTK_TSL = 0
          this.thuebao.tsl.txtCuocTC_TSL = 0
        }
      }
    },

    async HienThi_CTK_NIX_ISP(vloai) {
      if (this.kt_load) return
      var int_loaitb_id = 0
      var int_tocdo_id = 0
      var int_doituong_id = 0
      var int_loaikenh_id = 0
      int_loaitb_id = this.listbox.loaihinh_tb.value * 1
      int_doituong_id = this.listbox.doituong.value * 1
      int_loaikenh_id = this.listbox.loaikenh.value * 1
      let ds_ctk_ctc = []

      if (vloai == 2) {
        if (this.listbox.tocdokenh.valuenix) int_tocdo_id = this.listbox.tocdokenh.valuenix * 1
        ds_ctk_ctc = await API.post_sp_lay_cuoctk_cuoctc(this.axios, {
          vloaitb_id: int_loaitb_id,
          vtocdo_id: int_tocdo_id,
          vdoituong_id: int_doituong_id,
          vloaikenh_id: int_loaikenh_id,
          vkieu: 2
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          }
        }) //bangts.Lay_CUOCTK_CUOCTC(int_loaitb_id, int_tocdo_id, int_doituong_id, int_loaikenh_id, 2);
        if (ds_ctk_ctc && ds_ctk_ctc.length > 0 && ds_ctk_ctc[0]['cuoc_tk']) this.thuebao.mgwan.cuocnix = ds_ctk_ctc[0]['cuoc_tk'] ? ds_ctk_ctc[0]['cuoc_tk'] * 1 : 0
        else this.thuebao.mgwan.cuocnix = 0
      }
      if (vloai == 3) {
        if (this.listbox.tocdokenh.valueisp) int_tocdo_id = this.listbox.tocdokenh.valueisp * 1
        ds_ctk_ctc = await API.post_sp_lay_cuoctk_cuoctc(this.axios, {
          vloaitb_id: int_loaitb_id,
          vtocdo_id: int_tocdo_id,
          vdoituong_id: int_doituong_id,
          vloaikenh_id: int_loaikenh_id,
          vkieu: 3
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          }
        }) //bangts.Lay_CUOCTK_CUOCTC(int_loaitb_id, int_tocdo_id, int_doituong_id, int_loaikenh_id, 3);
        if (ds_ctk_ctc && ds_ctk_ctc.length > 0 && ds_ctk_ctc[0]['cuoc_tk']) this.thuebao.mgwan.cuocisp = ds_ctk_ctc[0]['cuoc_tk'] ? ds_ctk_ctc[0]['cuoc_tk'] * 1 : 0
        else this.thuebao.mgwan.cuocisp = 0
      }
    },
    async HienThiTT_HopDong_ChuaHT(dt) {
      try {
        //DataSet ds = tcdanhba.LAY_DB_THEO_MATB(ma_tb);
        if (dt.length > 0) {
          this.khachhang.hdkh_id = dt[0]['hdkh_id']
          this.dsHDKH_Sub = []

          if (dt[0]['nhanvien_id']) {
            this.thanhtoan.nhanvientc_id = dt[0]['nhanvien_id']
            // this.thanhtoan.manvtc = objCheckData.MAP_ID("ma_nv", DatabaseConstants.DB1 + ".nhanvien", "where nhanvien_id =" + nhanvientc_id.ToString());
          } else {
            this.thanhtoan.nhanvientc_id = 0
            this.thanhtoan.manvtc = ''
          }

          if (dt[0]['tuyenthu_id']) {
            this.thanhtoan.tuyenthu_id = dt[0]['tuyenthu_id']
            // this.thanhtoan.matuyen = objCheckData.MAP_ID("ma_tuyen", DatabaseConstants.DB2 + ".tuyenthu", "where tuyenthu_id =" + tuyenthu_id.ToString());
          } else {
            this.thanhtoan.tuyenthu_id = 0
            this.thanhtoan.matuyen = ''
          }

          var vetinh_id = ''
          var hdttid_temp = ''
          var hdtbid_t = ''
          var apidata = {}
          var dthdkh_sub = await API.post_fn_lay_tt_hopdong_chuaht(this.axios, { ds_para: JSON.stringify({ HDKH_ID: this.khachhang.hdkh_id, NHANVIEN_ID: this.thanhtoan.nhanvientc_id, TUYENTHU_ID: this.thanhtoan.tuyenthu_id, BANCHEO: 1 }) })
            .then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                apidata = JSON.parse(response.data.data)
                if (apidata['ERROR_CODE'] != 1) {
                  this.$toast.error(apidata['MESSAGE'])
                  return []
                }
                apidata = apidata['RESULT']
                if (apidata['MA_NV']) this.thanhtoan.manvtc = apidata['MA_NV']
                if (apidata['MA_TUYEN']) this.thanhtoan.matuyen = apidata['MA_TUYEN']
                if (apidata['NVTC_ID']) this.thanhtoan.nhanvientc_id = apidata['NVTC_ID']
                if (apidata['TUYENTHU_ID']) this.thanhtoan.tuyenthu_id = apidata['TUYENTHU_ID']
                if (apidata['VETINH_ID']) vetinh_id = apidata['VETINH_ID']
                if (apidata['HDTT_ID']) hdttid_temp = apidata['HDTT_ID']
                if (apidata['HDTB_ID']) hdtbid_t = apidata['HDTB_ID']

                return apidata['HDKH_SUB']
              } else return []
            })
            .catch(() => {
              return []
            }) //bangts.Laythongtin_table(Common.CommonConstants.DatabaseConstants.DB2 + ".hdkh_sub", "hdkh_id = " + hdkh_id.ToString(), "*", "").Tables[0];
          if (dthdkh_sub && dthdkh_sub.length > 0) {
            this.TAO_DULIEU_HDKH_SUB(dthdkh_sub, this.khachhang.hdkh_id)
          }
          //Tuan them bien TBHD_PL = 0 --> khach hang đặt mới la khach hang cu -- Ngay 24/08/2010
          this.thuebao.tbhd_pl = 0 //In Phu Luc
          //Thông tin khách hàng
          this.NgayYeuCau = moment(new Date()).format('DD/MM/YYYY HH:mm:ss') //tt_nd.ngay_cn;
          if (dt[0]['ngaylap_hd']) {
            this.NgayLapHD = dt[0]['ngaylap_hd']
          }
          this.khachhang.makh = dt[0]['ma_kh']
          this.khachhang.mahd = dt[0]['ma_hd']
          if (dt[0]['khachhang_id']) this.khachhang.khachhang_id = dt[0]['khachhang_id']
          this.khachhang.tenkh = this.ChuanHoaTen(dt[0]['ten_kh'])
          this.diachiKH.DIACHI = this.ChuanHoaTen(dt[0]['diachi_kh'])
          if (dt[0]['loaikh_id']) this.listbox.loai_kh.value = dt[0]['loaikh_id']
          if (dt[0]['diachi_ndd']) this.diachiNDD.DIACHI = this.ChuanHoaTen(dt[0]['diachi_kh'])
          else this.diachiNDD.DIACHI = this.ChuanHoaTen(dt[0]['diachi_ndd'])
          if (this.listbox.loai_kh.value == Loai_KH.CANHAN_HOGIADINH && dt[0]['nguoi_dd']) this.khachhang.nguoidd = this.khachhang.tenkh
          else this.khachhang.nguoidd = this.ChuanHoaTen(dt[0]['nguoi_dd'])

          if (dt[0]['nganhnghe_id']) {
            this.listbox.nganhngheloc.value = dt[0]['nganhnghe_id']
            this.nganhnghe_id = dt[0]['nganhnghe_id']
          }

          //TuấnNA thêm code hiển thị thông tin id tiểu ngành c1,c2,c3 -- Ngày 03/12/2010
          if (dt[0]['tnc1_id']) this.TNC1_ID = dt[0]['tnc1_id']
          if (dt[0]['tnc2_id']) this.TNC2_ID = dt[0]['tnc2_id']
          if (dt[0]['tnc3_id']) this.TNC3_ID = dt[0]['tnc3_id']
          //
          if (apidata['DS_DIACHI_HDKH']) this.HienThiTTDiaChi(apidata['DS_DIACHI_HDKH'], 1)
          this.khachhang.dienthoai = dt[0]['so_dt']
          this.khachhang.fax = dt[0]['so_fax']

          if (dt[0]['ngay_sn']) this.NgaySinh = dt[0]['ngay_sn']
          else this.NgaySinh = ''

          this.khachhang.sogt = dt[0]['so_gt']

          if (dt[0]['ngaycap']) this.NgayCap = dt[0]['ngaycap']
          else this.NgayCap = ''

          //Hiếu bổ sung 1 số thông tin thiếu 27.09.2010
          if (dt[0]['ngayhethan_gt']) this.NgayHH = dt[0]['ngayhethan_gt']
          else this.NgayHH = ''

          this.diachiHK.DIACHI = this.ChuanHoaTen(dt[0]['hokhau'])
          this.khachhang.noicap = this.ChuanHoaTen(dt[0]['noicap_hk'])
          if (dt[0]['ngaycap']) this.NgayCapHK = dt[0]['ngaycap']
          else this.NgayCapHK = ''

          this.khachhang.masothue = dt[0]['mst']
          this.listbox.nganhang.sotaikhoankh = dt[0]['stk']
          if (dt[0]['nganhang_id']) this.listbox.nganhang.ischeckedkh = true
          else this.listbox.nganhang.ischeckedkh = false
          this.khachhang.dactrung = dt[0]['dactrung']
          this.khachhang.ghichu = dt[0]['ghichu']
          if (dt[0]['loaigt_id']) this.listbox.loai_gt.value = dt[0]['loaigt_id']
          this.khachhang.noicap = this.ChuanHoaTen(dt[0]['noicap'])
          this.listbox.loai_khl.value = dt[0]['khlon_id']
          //HungHm-07/07/2010: Bổ xung thêm các trường mới từ bảng DB_ThanhToan

          this.diachiCT.DIACHI = this.ChuanHoaTen(dt[0]['diachi_ct'])
          //end edit
          this.nganhang.DV_QHNS = dt[0]['DV_QHNS']
          this.nganhang.MACHUONG = dt[0]['MACHUONG']
          this.nganhang.MN_KT = dt[0]['MN_KT']
          this.nganhang.MA_NDKT = dt[0]['MA_NDKT']
          this.nganhang.MN_NSNN = dt[0]['MN_NSNN']

          this.thanhtoan.tentt = this.ChuanHoaTen(dt[0]['ten_tt'])
          this.diachiTT.DIACHI = this.ChuanHoaTen(dt[0]['diachi_tt'])
          //địa chỉ báo cước
          this.diachiBC.DIACHI = this.ChuanHoaTen(dt[0]['diachi_bc'])
          //var hdttid_temp = Convert.ToInt64(tchopdong.LAY_DS_HOPDONG_TT_THEO_HDKH_ID(hdkh_id).Tables[0].Rows[0]["hdtt_id"].ToString()); //chuyen len tren!!!

          if (apidata['DS_DIACHI_HDTT']) this.HienThiTTDiaChi(apidata['DS_DIACHI_HDTT'], 2)
          //
          if (!dt[0]['diachi_ct']) this.diachiCT.DIACHI = this.ChuanHoaTen(dt[0]['diachi_tt'])
          else this.diachiCT.DIACHI = this.ChuanHoaTen(dt[0]['diachi_ct'])

          this.thanhtoan.masothue = dt[0]['mst_tt']
          this.listbox.nganhang.sotaikhoan = dt[0]['stk_tt']
          this.thanhtoan.chutk = dt[0]['chu_tk_tt']
          if (dt[0]['nganhang_id_tt']) this.listbox.nganhang.value = dt[0]['nganhang_id_tt']
          this.listbox.hinhthuc_tthi.value = dt[0]['httt_id']
          if (dt[0]['donvi_id']) this.listbox.donvi_ql.valueql = dt[0]['donvi_id'] //cboDonViQL.SelectedValue = dt[0]["donvi_id"];

          this.thanhtoan.matb_dd = dt[0]['matb_dd']

          //HIếu bổ sung thêm một số thông tin 1.10.2010
          this.thuebao.tentb = this.ChuanHoaTen(dt[0]['ten_tb'])
          this.diachiTB.DIACHI = this.ChuanHoaTen(dt[0]['diachi_tb'])

          // long hdtbid_t = Convert.ToInt64(tchopdong.LAY_DS_HOPDONG_TB_THEO_HDKH_ID_BC(hdkh_id).Tables[0].Rows[0]["hdtb_id"]); // lay ra khong dung -> bo
          if (apidata['DS_DIACHI_HDTB']) this.HienThiTTDiaChi(apidata['DS_DIACHI_HDTB'], 3) //truoc ham nay dang comment, mo lai vi thay co du lieu

          if (dt[0]['donviql_id']) this.listbox.donvi_ql.value = dt[0]['donviql_id']

          //
          this.listbox.doituong.value = dt[0]['doituong_id']

          if (!this.listbox.doituong.value) {
            this.listbox.doituong.value = this.listbox.doituong.value[0].doituong_id
          }
          //Lấy ds mức cước thuê bao
          //Index trạm thi công theo phường
          // Chuyen phan khai bao ve tinh len tren
          // string vetinh_id = "";
          // vetinh_id = objCheckData.MAP_ID("donvi_id", DatabaseConstants.DB2 + ".donvi_px",
          //             "where phuong_id =" + phuongld_id + " and decode(" + phold_id + ",0, 0, pho_id) = " + phold_id + " and loaidv_id = " + LOAI_DV.TRAM_VT);
          if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) {
            if (vetinh_id != '-1') this.buttons.btnChonSM = true
            else this.buttons.btnChonSM = false
          } else if (this.listbox.dichvu_vt.value == DichVuVienThong.IMS) {
            if (vetinh_id != '-1') this.buttons.btnChonSoIMS = true
            else this.buttons.btnChonSoIMS = false
          } else if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL) {
          } else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
          }
          this.Lay_DS_MucCuoc_TB(0, 0, 0, 0, this.listbox.loaihinh_tb.value, this.listbox.doituong.value, this.NgayYeuCau)
          //
          if (dt[0]['diachi_ld']) this.diachiLD.DIACHI = this.ChuanHoaTen(dt[0]['diachi_tb'])
          else this.diachiLD.DIACHI = this.ChuanHoaTen(dt[0]['diachi_ld'])

          if (dt[0]['ngay_sn']) this.NgaySinhTB = dt[0]['ngay_sn']
          else this.NgaySinhTB = ''

          // chkLapDatBS.Checked = true;// khong biet o dau!
          this.HienThiDS_HDTT_CBO(this.khachhang.hdkh_id)
          this.HienThiTTHopDongTT(apidata['DS_HD'])
          this.HienThiDanhSacHDTT(apidata['DS_HD'])

          //SendKeys.Send("{TAB}");
        } else {
          //Tuan them bien TBHD_PL = 1 --> khach hang đặt mới la khach hang Moi -- Ngay 24/08/2010
          this.thuebao.tbhd_pl = 1 // In HD
          // chkLapDatBS.Checked = false;
          // SendKeys.Send("{TAB}");
        }
      } catch (exp) {
        //new LogError().GetError(new log4net.Core.LoggingEvent(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType, log.Logger.Repository, log.Logger.Name, log4net.Core.Level.Info, exp.Message, exp), true);
      }
    },
    async KiemTraDL_KhachHang() {
      //TODO chua lam
      // if (!KT_NgayYC(dtpNgayYeuCau.Value.ToString("dd/MM/yyyy"), dtpNgayLapHD.Value.ToString("dd/MM/yyyy"))) return false;

      // if (ts_kt_hdkh_sub == 1 && dsHDKH_Sub._HDKH_Sub.Rows.Count == 0)
      // {
      //     Message_Box.ShowTB("Hãy nhập thông tin  hợp đồng trong tab khách hàng!");
      //     return false;
      // }

      if (!this.khachhang.tenkh) {
        // if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
        this.$toast.error('Hãy nhập tên khách hàng !')
        // txtTenKH.Focus();
        return false
      }

      if (!this.listbox.loai_kh.value || this.listbox.loai_kh.value == -1) {
        //cboLoaiKH.SelectedIndex < 0 ||
        // if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
        this.$toast.error('Hãy chọn loại khách hàng')
        // cboLoaiKH.Focus();
        return false
      }

      // if (string.IsNullOrEmpty(PHANLOAIKH_ID.ToString()) || PHANLOAIKH_ID == -1
      //     || string.IsNullOrEmpty(txtPhanLoaiKH.Text))
      // {
      //     cboLoaiKH.EditValue = -1;
      //     Message_Box.ShowWarning("Hãy chọn loại khách hàng");
      //     return false;
      // }

      // if (txtNgaySN.Text != "  /  /")
      // {
      //     //try
      //     //{
      //     //    int kieukh_id = -1;
      //     //    string kieukh = cboLoaiKH.Properties.View.GetRowCellValue(cboLoaiKH.Properties.View.FocusedRowHandle, "LOAI").ToString();
      //     //    if (kieukh != "")
      //     //        kieukh_id = Convert.ToInt32(kieukh);
      //     //    if (kieukh_id != -1 && kieukh_id == KIEU_KH.CA_NHAN)//Nếu là khách hàng tư nhân thì kiểm tra đã đủ 18 tuổi chưa
      //     //    {
      //     //        CheckDataFacade checkdata = new CheckDataFacade();
      //     //        if (checkdata.KIEMTRA_NGAYSINH(txtNgaySN.Text) == 0)
      //     //        {
      //     //            if (tabctlThongTin.SelectedIndex == 1)
      //     //                tabctlThongTin.SelectedIndex = 0;
      //     //            Message_Box.ShowWarning("Khách hàng chưa đủ 18 tuổi để làm hợp đồng!");
      //     //            txtNgaySN.Focus();
      //     //            return false;
      //     //        }
      //     //    }
      //     //}
      //     //catch (Exception)
      //     //{
      //     //}

      //     if (Convert.ToInt32(cboGiayToKH.SelectedValue) == LoaiGiayTo.CHUNG_MINH_THU)
      //     {
      //         CheckDataFacade checkdata = new CheckDataFacade();
      //         if (checkdata.KIEMTRA_NGAYSINH(txtNgaySN.Text) == 0)
      //         {
      //             if (tabctlThongTin.SelectedIndex == 1)
      //                 tabctlThongTin.SelectedIndex = 0;
      //             Message_Box.ShowWarning("Khách hàng chưa đủ 18 tuổi để làm hợp đồng!");
      //             txtNgaySN.Focus();
      //             return false;
      //         }
      //     }
      // }

      // if (txtDiaChiKH.Text == "" || quankh_id == 0 || phuongkh_id == 0 || txtDiaChiKH.Text == "")
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowWarning("Hãy nhập địa chỉ khách hàng !");
      //     txtDiaChiKH.Focus();
      //     return false;
      // }
      // if (txtNguoiDD.Text.trim() == "")
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowWarning("Hãy nhập tên người đại diện !");
      //     txtNguoiDD.Focus();
      //     return false;
      // }
      // if (tracuuchung.KIEMTRA_MAKH(txtMaKH.Text, khachhang_id))
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowWarning("Kiểm tra lại mã khách hàng !");
      //     txtMaKH.Focus();
      //     return false;
      // }

      // if (cboGiayToKH.SelectedValue == null || cboGiayToKH.Text == "")
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowTB("Hãy chọn loại giấy tờ !");
      //     cboGiayToKH.Focus();
      //     return false;
      // }

      // if (txtSoGT.Text == "" && cboGiayToKH.SelectedIndex != 7)
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowWarning("Hãy nhập số giấy tờ !");
      //     txtSoGT.Focus();
      //     return false;
      // }
      // //if (Convert.ToInt32(cboGiayToKH.SelectedValue) == 1 && txtSoGT.Text != "")
      // //{
      // //    if (!Common.Utilities.CommonFunction.CheckIsNumber(txtSoGT.Text.trim()))
      // //    {
      // //        Message_Box.ShowWarning("Bạn đang chọn loại giấy tờ: " + cboGiayToKH.Text + "\nDữ liệu nhập phải là kiểu số!");
      // //        if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      // //        txtSoGT.SelectAll();
      // //        txtSoGT.Focus();
      // //        return false;
      // //    }
      // //}

      // if (txtHoKhau.Text == "" && txtSoGT.Text == "")
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowWarning("Hãy nhập hộ khẩu hoặc loại giấy tờ khác !");
      //     txtHoKhau.Focus();
      //     return false;
      // }

      // if (txtNgayCap.Text == "  /  /")
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowWarning("Hãy nhập ngày cấp giấy tờ !");
      //     txtNgayCap.Focus();
      //     return false;
      // }
      // if (txtNgaySN.Text == "  /  /")
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowWarning("Hãy nhập ngày sinh khách hàng !");
      //     txtNgaySN.Focus();
      //     return false;
      // }

      // if (TNC1_ID == 0 || TNC2_ID == 0 || TNC3_ID == 0)
      // {
      //     Message_Box.ShowWarning("Bạn chưa chọn chi tiết ngành nghề.Hãy kiểm tra lại !");
      //     if (tabctlThongTin.SelectedIndex == 1)
      //         tabctlThongTin.SelectedIndex = 0;
      //     cboNganhNghe.Focus();
      //     return false;
      // }
      // if (txtTelKH.Text.trim() == "")
      // {
      //     Message_Box.ShowWarning("Hãy nhập số điện thoại liên hệ của khách hàng.");
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     txtTelKH.Focus();
      //     return false;
      // }
      // if (txtTelKH.Text.trim().Length > 10)
      // {
      //     Message_Box.ShowWarning("Số điện thoại liên hệ của khách hàng không được quá 10 ký tự.\nBạn hãy bỏ số 0 ở đầu (nếu có)!");
      //     if (tabctlThongTin.SelectedIndex == 1)
      //         tabctlThongTin.SelectedIndex = 0;
      //     txtTelKH.Focus();
      //     return false;
      // }
      // if (txtTelKH.Text.trim().Length < 7)
      // {
      //     Message_Box.ShowWarning("Số điện thoại liên hệ của khách hàng không được ít hơn 7 ký tự.");
      //     if (tabctlThongTin.SelectedIndex == 1)
      //         tabctlThongTin.SelectedIndex = 0;
      //     txtTelKH.Focus();
      //     return false;
      // }
      // if (!IsNumber(txtTelKH.Text.trim()))
      // {
      //     Message_Box.ShowWarning("Số điện thoại liên hệ của khách hàng phải là số!");
      //     txtTelKH.Focus();
      //     return false;
      // }
      // //Hieutc: 11.10.2011: Kiểm tra mã khách hàng đã theo đúng chuẩn chưa
      // if (txtMaKH.Text.trim() != "")
      // {
      //     if (laphd.Kiemtra_makh_mtt(txtMaKH.Text.trim(), 1, LoaiHopDong.DAT_MOI) == 0)
      //     {
      //         Message_Box.ShowWarning("Mã khách hàng không đúng chuẩn quy định của Viễn thông tỉnh.\nBạn hãy kiểm tra lại!");
      //         txtMaKH.Focus();
      //         return false;
      //     }
      // }
      // if (txtMaGD.Text.trim() != "")
      // {
      //     if (laphd.Kiemtra_makh_mtt(txtMaGD.Text.trim(), 3, LoaiHopDong.DAT_MOI) == 0)
      //     {
      //         Message_Box.ShowWarning("Mã giao dịch không đúng chuẩn quy định của Viễn thông tỉnh.\nBạn hãy kiểm tra lại!");
      //         txtMaGD.Focus();
      //         return false;
      //     }
      // }

      if (this.thamsomacdinh['KHONGBATBUOC_CTV'] != 1 || this.filterbox.ctv.ischecked) {
        if (!this.filterbox.ctv.ischecked || !this.filterbox.ctv.value || !this.ctv_id || this.ctv_id == 0) {
          this.$toast.error('Bạn chưa chọn nhân viên phát triển / cộng tác viên!')
          // txtCTV.Focus();
          return false
        }

        if (!this.listbox.hinhthuc_tthi.value || this.listbox.hinhthuc_tthi.value <= 0) {
          // if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
          this.$toast.error('Hãy chọn hình thức tiếp thị')
          // cboHinhThucTThi.Focus();
          return false
        }
      }
      if (this.thamsomacdinh['BATBUOC_GIOITHIEU_LAPMOI'] == 1 || this.filterbox.nguoigt.ischecked) {
        if (!this.filterbox.nguoigt.ischecked || !this.filterbox.nguoigt.value || !this.filterbox.nguoigt.nguoigt_id || this.filterbox.nguoigt.nguoigt_id == 0) {
          this.$toast.error('Bạn chưa chọn người giới thiệu hợp đồng/phụ lục')
          // txtNguoiGT.Focus();
          return false
        }
      }
      // if (khong_batbuoc_ctv == 0)
      // {
      //     if (!chkCTV.Checked || string.IsNullOrEmpty(txtCTV.Text) || ctv_id == 0)
      //     {
      //         Message_Box.ShowTB("Bạn chưa chọn nhân viên phát triển!");
      //         txtCTV.Focus();
      //         return false;
      //     }

      //     if (cboHinhThucTThi.SelectedIndex == 0)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //         Message_Box.ShowWarning("Hãy chọn hình thức tiếp thị");
      //         cboHinhThucTThi.Focus();
      //         return false;
      //     }
      // }
      // if (batbuoc_gioithieu_lapmoi == 1)
      // {
      //     if (!chkNguoiGT.Checked || string.IsNullOrEmpty(txtNguoiGT.Text) || nguoigt_id == 0)
      //     {
      //         Message_Box.ShowTB("Bạn chưa chọn người giới thiệu hợp đồng/phụ lục");
      //         txtNguoiGT.Focus();
      //         return false;
      //     }
      // }
      // if (chkCTV.Checked && string.IsNullOrEmpty(txtCTV.Text) && ctv_id == 0)
      // {
      //     Message_Box.ShowTB("Bạn chưa chọn cộng tác viên !");
      //     txtCTV.Focus();
      //     return false;
      // }

      // if (chkNguoiGT.Checked && string.IsNullOrEmpty(txtNguoiGT.Text) && nguoigt_id == 0)
      // {
      //     Message_Box.ShowTB("Bạn chưa chọn người giới thiệu hợp đồng !");
      //     txtNguoiGT.Focus();
      //     return false;
      // }
      // // anhnt: 22/05/2020 bỏ kiem tra ghi chu
      // //if (txtGhiChuKH.Text.trim().Length > 240)
      // //{
      // //    Message_Box.ShowWarning("Ghi chú khách hàng không được lớn hơn 240 ký tự !");
      // //    return false;
      // //}

      // //Kiểm tra MST Khách hàng
      if (this.vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) {
        //Khách hàng doanh nghiệp
        if (this.listbox.loaihinh_tb.value != LoaiHinhTB.BaoHieuQuocTe && this.listbox.loaihinh_tb.value != LoaiHinhTB.THOAIQT) {
          if (!this.dsHDKH_Sub || this.dsHDKH_Sub.length == 0 || (this.dsHDKH_Sub.length > 0 && !this.dsHDKH_Sub[0]['KHOI_ID'])) {
            this.$toast.error('Bạn phải chọn khối trong thông tin khách hàng bổ sung')
            return false
          }
        }

        // if (dsHDKH_Sub.Tables[0].Rows.Count > 0 && dsHDKH_Sub.Tables[0].Rows[0]["KHOI_ID"].ToString() != "")
        // {
        //     string vkhoi = dsHDKH_Sub.Tables[0].Rows[0]["KHOI_ID"].ToString();

        //     var kq = new LapHopDongFacade2().GET_VALUE_FUNC("{?DB2}.kiemtra_khoi_loaikh", "vkhoi_id", vkhoi, "vloaikh_id", cboLoaiKH.EditValue);
        //     if (kq.ToString() != "OK")
        //     {
        //         Message_Box.ShowTB("Có lỗi khi kiểm tra: " + kq.ToString());
        //         return false;
        //     }
        // }

        if (this.listbox.loai_gt.value == LoaiGiayTo.MA_NGANSACH) {
          if (!(this.khachhang.sogt + '').match(/^[123789]\d{6}$/g)) {
            this.$toast.error('Mã ngân sách phải là số có 7 chữ số và bắt đầu bằng 1 trong các số 1/2/3/7/8/9. Vui lòng kiểm tra lại!')
            return false
          }
        }
        var mst_ = this.thanhtoan.masothue
        // string mst_ = "";
        // if (ts_kt_mst_kh == 1)
        // {
        //     mst_ = txtMaSTKH2.Text.Trim();
        // }
        // else
        // {
        //     mst_ = txtMaSTKH.Text.Trim();
        // }
        if (this.thamsomacdinh['KIEMTRA_MSTMNS_KHDN'] == 1) {
          // if (!mst_ && (this.dsHDKH_Sub.length == 0 || (this.dsHDKH_Sub.length > 0 && !this.dsHDKH_Sub[0]['MA_NS'])) && !this.is_nv_vnpti) {
          //   this.$toast.error('Bạn phải nhập mã số thuế hoặc mã ngân sách')
          //   return false
          // } // bo check theo thong bao cua Cikimelog
          // if (mst_) // Thuc hien o FN_KIEMTRA_DL_KHACHHANG
          // {
          //     var kq_kt = new LapHopDongFacade2().GET_VALUE_FUNC("{?DB2}.KiemTra_MST".ReplaceSchema(), "vmst", mst_.ToString());
          //     if (kq_kt.ToString() != "OK")
          //     {
          //         Message_Box.ShowTB(kq_kt.ToString());
          //         return false;
          //     }
          // }

          if (this.dsHDKH_Sub.length > 0 && this.dsHDKH_Sub[0]['MA_NS']) {
            var mans = this.dsHDKH_Sub[0]['MA_NS'] + ''
            if (!(mans + '').match(/^[123789]\d{6}$/g)) {
              this.$toast.error('Mã ngân sách phải là số có 7 chữ số và bắt đầu bằng 1 trong các số 1/2/3/7/8/9. Vui lòng kiểm tra lại!')
              return false
            }
          }
        }
      }
        if (this.vkieukh_id_ == KIEU_KH.DOANH_NGHIEP)
          if (!this.dsHDKH_Sub || this.dsHDKH_Sub.length == 0 || (this.dsHDKH_Sub.length > 0 && !this.dsHDKH_Sub[0]['KHOI_ID'])) {
            this.$toast.error('Bạn phải chọn khối trong thông tin khách hàng bổ sung')
            return false;
          }
      if (this.thamsomacdinh['KIEMTRA_MST_KH'] && this.thamsomacdinh['KIEMTRA_MST_KH'] == 1) {
        //(ts_kt_mst_kh == 1)
        if (this.vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) {
          //Khách hàng doanh nghiệp
          if (!this.dsHDKH_Sub || this.dsHDKH_Sub.length == 0 || (this.dsHDKH_Sub.length > 0 && !this.dsHDKH_Sub[0]['KHOI_ID'])) {
            this.$toast.error('Bạn phải chọn khối trong thông tin khách hàng bổ sung')
            return false;
          }

          // if (string.IsNullOrEmpty(txtMaSTKH.Text.trim()))
          // {
          //     Message_Box.ShowTB("Mã số thuế phải từ 10 -> 13 ký tự");
          //     return false;
          // }
          // if (txtMaSTKH.Text.Length < 10 || txtMaSTKH.Text.Length > 13)
          // {
          //     Message_Box.ShowTB("Mã số thuế phải từ 10 -> 13 ký tự");
          //     return false;
          // }
          // //Kiểm tra check sum
          // long vSum = 0;
          // string vMST = txtMaSTKH.Text;
          // vSum = Convert.ToInt32(vMST[0].ToString()) * 31;
          // vSum += Convert.ToInt32(vMST[1].ToString()) * 29;
          // vSum += Convert.ToInt32(vMST[2].ToString()) * 23;
          // vSum += Convert.ToInt32(vMST[3].ToString()) * 19;
          // vSum += Convert.ToInt32(vMST[4].ToString()) * 17;
          // vSum += Convert.ToInt32(vMST[5].ToString()) * 13;
          // vSum += Convert.ToInt32(vMST[6].ToString()) * 7;
          // vSum += Convert.ToInt32(vMST[7].ToString()) * 5;
          // vSum += Convert.ToInt32(vMST[8].ToString()) * 3;
          // if (Convert.ToInt32(vMST[9].ToString()) != (10 - (vSum % 11)))
          // {
          //     Message_Box.ShowTB("Mã số thuế không đúng cấu trúc !");
          //     return false;
          // }
        }
      }
      // //region Kiểm tra mã ngân sách
      // if (vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) //Khách hàng doanh nghiệp
      // {
      //     if ((dsHDKH_Sub.Tables[0].Rows.Count == 0 ||
      //                             (dsHDKH_Sub.Tables[0].Rows.Count > 0 && dsHDKH_Sub.Tables[0].Rows[0]["KHOI_ID"].ToString() == "")))
      //     {
      //         Message_Box.ShowTB("Bạn phải chọn khối trong thông tin khách hàng bổ sung");
      //         return false;
      //     }

      //     if (dsHDKH_Sub.Tables[0].Rows.Count > 0 && dsHDKH_Sub.Tables[0].Rows[0]["KHOI_ID"].ToString() != "")
      //     {
      //         string vkhoi = dsHDKH_Sub.Tables[0].Rows[0]["KHOI_ID"].ToString();

      //         var kq = new LapHopDongFacade2().GET_VALUE_FUNC("{?DB2}.kiemtra_khoi_loaikh", "vkhoi_id", vkhoi, "vloaikh_id", cboLoaiKH.EditValue);
      //         if (kq.ToString() != "OK")
      //         {
      //             Message_Box.ShowTB("Có lỗi khi kiểm tra: " + kq.ToString());
      //             return false;
      //         }
      //     }
      //     if (Convert.ToInt32(cboGiayToKH.SelectedValue) == LoaiGiayTo.MA_NGANSACH)
      //     {
      //         string mans = "";
      //         mans = txtSoGT.Text.trim();
      //         if (!CommonFunction.CheckIsNumber(mans))
      //         {
      //             Message_Box.ShowTB("Mã ngân sách phải là dạng số.\nBạn hãy kiểm tra lại!");
      //             return false;
      //         }

      //         if (mans.Length != 7)
      //         {
      //             Message_Box.ShowTB("Mã ngân sách phải đủ 7 ký tự số. \nBạn hãy kiểm tra lại!");
      //             return false;
      //         }
      //         int[] ArrCheck = { 1, 2, 3, 7, 8, 9 };
      //         if (mans.Substring(0, 1) != "1" && mans.Substring(0, 1) != "2" && mans.Substring(0, 1) != "3" && mans.Substring(0, 1) != "7" && mans.Substring(0, 1) != "8" && mans.Substring(0, 1) != "9")
      //         {
      //             Message_Box.ShowTB("Mã ngân sách phải bắt đầu là 1/2/3/7/8/9. \nBạn hãy kiểm tra lại!");
      //             return false;
      //         }
      //     }

      //     if (ts_kt_mstmns_kh == 1)
      //     {

      //         string mst_ = "";
      //         mst_ = txtMaSTKH.Text.trim();
      //         if (string.IsNullOrEmpty(mst_) && (dsHDKH_Sub.Tables[0].Rows.Count == 0 ||
      //             (dsHDKH_Sub.Tables[0].Rows.Count > 0 && dsHDKH_Sub.Tables[0].Rows[0]["MA_NS"].ToString() == "")))
      //         {
      //             Message_Box.ShowTB("Bạn phải nhập mã số thuế hoặc mã ngân sách");
      //             return false;
      //         }
      //         if (dsHDKH_Sub.Tables[0].Rows.Count > 0 && dsHDKH_Sub.Tables[0].Rows[0]["MA_NS"].ToString() != "")
      //         {
      //             string mans = "";
      //             mans = dsHDKH_Sub.Tables[0].Rows[0]["MA_NS"].ToString();
      //             if (!CommonFunction.CheckIsNumber(mans))
      //             {
      //                 Message_Box.ShowTB("Mã ngân sách phải là dạng số.\nBạn hãy kiểm tra lại!");
      //                 return false;
      //             }

      //             if (mans.Length != 7)
      //             {
      //                 Message_Box.ShowTB("Mã ngân sách phải đủ 7 ký tự số. \nBạn hãy kiểm tra lại!");
      //                 return false;
      //             }
      //             int[] ArrCheck = { 1, 2, 3, 7, 8, 9 };
      //             if (mans.Substring(0, 1) != "1" && mans.Substring(0, 1) != "2" && mans.Substring(0, 1) != "3" && mans.Substring(0, 1) != "7" && mans.Substring(0, 1) != "8" && mans.Substring(0, 1) != "9")
      //             {
      //                 Message_Box.ShowTB("Mã ngân sách phải bắt đầu là 1/2/3/7/8/9. \nBạn hãy kiểm tra lại!");
      //                 return false;
      //             }
      //         }

      //     }
      // }
      return true
    },
    async KiemTraDL_ThanhToan() {
      //TODO chua lam
      // if (txtTenTT.Text == "")
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowTB("Hãy nhập tên thanh toán !");
      //     txtTenTT.Focus();
      //     return false;
      // }
      // // anhnt: 22/05/2020 bỏ kiem tra ghi chu
      // //if (txtGhiChuTT.Text.Length > 240)
      // //{
      // //    Message_Box.ShowWarning("Ghi chú thanh toán không được lớn hơn 240 ký tự");
      // //    txtGhiChuTT.Focus();
      // //    return false;
      // //}

      // if (txtMaTT.Text != "" && thanhtoan_id != 0)
      // {
      //     if (cboMaDD.Text == "")
      //     {
      //         if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //         Message_Box.ShowTB("Hãy chọn mã dại diện !");
      //         cboMaDD.Focus();
      //         return false;
      //     }

      //     if (cboMaDD.Properties.Items.Count > 0)
      //     {
      //         if (cboMaDD.SelectedIndex < 0)
      //         {
      //             if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //             Message_Box.ShowTB("Hãy chọn mã đại diện");
      //             cboMaDD.Focus();
      //             return false;
      //         }
      //     }
      // }
      // if (txtDiaChiTT.Text.trim() == "" || quantt_id == 0 || phuongtt_id == 0)
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowTB("Hãy nhập địa chỉ thanh toán !");
      //     txtDiaChiTT.Focus();
      //     return false;
      // }

      // if (batbuoc_chon_dacdiem == 1 && (quantt_id != 0 || phuongtt_id != 0) &&
      //     (phott_id != 0 || aptt_id != 0 || khutt_id != 0))
      // {
      //     string strKtraDD = "select 1 from " + DatabaseConstants.DB2
      //         + ".dacdiem_dd where phuong_id=" + phuongtt_id + " and pho_id=" + phott_id + " and dacdiem_id<>0";
      //     DataSet dsDD = bangts.GetSQL(strKtraDD, "");
      //     if (dsDD != null && dsDD.Tables[0].Rows.Count > 0)
      //     {
      //         if (dacdiemtt_id == 0)
      //         {
      //             Message_Box.ShowTB("Địa chỉ thanh toán này có đặc điểm. Yêu cầu chọn đặc điểm!");
      //             txtDiaChiTT.Focus();
      //             return false;
      //         }
      //     }
      // }

      // if (txtDiaChiCT.Text.trim() == "")
      // {
      //     if (tabctlThongTin.SelectedIndex == 1)
      //         tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowTB("Hãy nhập địa chỉ chứng từ !");
      //     txtDiaChiCT.Focus();
      //     return false;
      // }

      // if (Convert.ToInt32(cboHTTT.SelectedValue) == HinhThucThanhToan.UYNHIEM_THU
      //     || Convert.ToInt32(cboHTTT.SelectedValue) == HinhThucThanhToan.UYNHIEM_CHI)
      // {
      //     if (khongnhap_stk_uynhiemthu == 0)
      //     {
      //         if (txtSTK_TT.Text == "")
      //         {
      //             if (tabctlThongTin.SelectedIndex == 1)
      //                 tabctlThongTin.SelectedIndex = 0;
      //             Message_Box.ShowTB("Hãy nhập Tài khoản  !");
      //             txtSTK_TT.Focus();
      //             return false;
      //         }
      //         if (txtChu_TK.Text == "")
      //         {
      //             if (tabctlThongTin.SelectedIndex == 1)
      //                 tabctlThongTin.SelectedIndex = 0;
      //             Message_Box.ShowTB("Hãy nhập Chủ tài khoản  !");
      //             txtChu_TK.Focus();
      //             return false;
      //         }
      //     }
      //     //HCM: Ủy nhiệm thu, chi không cần mã số thuế
      //     //if (txtMST_TT.Text == "")
      //     //{
      //     //    if (tabctlThongTin.SelectedIndex == 1)
      //     //        tabctlThongTin.SelectedIndex = 0;
      //     //    Message_Box.ShowTB("Hãy nhập Mã số thuế  !");
      //     //    txtMST_TT.Focus();
      //     //    return false;
      //     //}
      // }

      // if (cboDonViQL.Items.Count <= 0)
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowTB("Địa chỉ thanh toán này chưa được thiết lập đơn vị quản lý !");
      //     btnDiaChiTT.Focus();
      //     return false;
      // }
      // else
      // {
      //     if (cboDonViQL.SelectedValue == null)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //         Message_Box.ShowTB("Bạn chưa chọn đơn vị quản lý thanh toán !");
      //         btnDiaChiTT.Focus();
      //         return false;
      //     }
      //     if (cboDonViQL.Text == "")
      //     {
      //         if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //         Message_Box.ShowTB("Bạn chưa chọn đơn vị quản lý thanh toán !");
      //         btnDiaChiTT.Focus();
      //         return false;
      //     }
      // }
      // if (txtMaNVTC.Text.trim() == "")
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowTB("Hãy nhập mã nhân viên thu cước !");
      //     txtMaNVTC.Focus();
      //     return false;
      // }
      // if (tuyenthu_id == 0)
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowTB("Không tìm thấy thông tin tuyến thu");
      //     txtMaNVTC.Focus();
      //     return false;
      // }
      // if (tracuuchung.KIEMTRA_MATT(txtMaTT.Text, thanhtoan_id))
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowTB("Kiểm tra lại mã thanh toán !");
      //     txtMaTT.Focus();
      //     return false;
      // }

      // //Hieutc: 11.10.2011: Kiểm tra mã thanh toán đã theo đúng chuẩn chưa
      // if (txtMaTT.Text.trim() != "")
      // {
      //     if (laphd.Kiemtra_makh_mtt(txtMaTT.Text.trim(), 2, LoaiHopDong.DAT_MOI) == 0)
      //     {
      //         Message_Box.ShowWarning("Mã thanh toán không đúng chuẩn quy định của Viễn thông tỉnh.\nBạn hãy kiểm tra lại!");
      //         txtMaTT.Focus();
      //         return false;
      //     }
      // }
      // //KhaiVK: 12/06/2018: Kiểm tra mã số thuế theo chuẩn
      // string maSoThue = txtMST_TT.Text.trim();
      // if (maSoThue != string.Empty && ts_kt_mst == 1)
      // {
      //     string ketQua = CommonUtilities.KiemTraDinhDangMaSoThue(maSoThue);
      //     if (ketQua != "OK")
      //     {
      //         Message_Box.ShowWarning(ketQua);
      //         txtMST_TT.Focus();
      //         return false;
      //     }
      //     else
      //     {
      //         DataSet ds_maKH = new DataSet();
      //         ds_maKH = tcdanhba.LAY_DS_MAKH_THEO_MST(maSoThue, hdkh_id, khachhang_id);
      //         if (ds_maKH.Tables[0].Rows.Count == 1)
      //         {
      //             Message_Box.ShowTB("Mã số thuế " + maSoThue + " đang được sử dụng bởi mã khách hàng: " +
      //                             ds_maKH.Tables[0].Rows[0]["ma_kh"].ToString() + ".");
      //             txtMST_TT.Focus();
      //             return false;
      //         }
      //         else if (ds_maKH.Tables[0].Rows.Count > 1)
      //         {
      //             string str = "";
      //             for (int i = 0; i < ds_maKH.Tables[0].Rows.Count; i++)
      //             {
      //                 str = str + ds_maKH.Tables[0].Rows[i]["ma_kh"].ToString() + ",";
      //             }
      //             Message_Box.ShowTB("Mã số thuế " + maSoThue + " đang được sử dụng bởi các mã khách hàng: " +
      //                             str.Substring(0, str.Length - 1) + ".");
      //             txtMST_TT.Focus();
      //             return false;
      //         }
      //     }
      // }
      return true
    },
    async KiemTraDL_ThueBao(themmoi) {
      if (this.ckieu_ld.length <= 0) {
        this.$toast.error(`Loại hình thuê bao đã chọn chưa được cấu hình triển khai cho khu vực. Vui lòng liên hệ admin!`)
        return false
      } else if (this.listbox.kieu_ld.value <= 0) {
        this.$toast.error(`Cần chọn kiểu yêu cầu để tiếp tục!`)
        return false
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC)
        //if (this.listbox.cboGoiCuocAdsl.value && this.listbox.cboGoiCuocAdsl.value * 1 >= 44710 && this.listbox.cboGoiCuocAdsl.value * 1 <= 44715)
        if((await API.get_fn_ktra_tocdo_dk_greennet(this.axios,{params:{tocdo_id:this.listbox.cboGoiCuocAdsl.value}}).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return 0
        })
        .catch(() => {
          return 0
        }))==1) {
          if (!this.m_dsThueBao_DichVu.find((x) => x.dangky && !x.huy && x.dichvugt_id == 8939)) {
            this.$toast.error('Gói cước có bao gồm dịch vụ GreenNet. Đề nghị khai báo Dịch vụ GTGT Green Net trước khi khởi tạo gói cước')
            return false
          }
        } else
          if (this.m_dsThueBao_DichVu.find((x) => x.dangky && !x.huy && x.dichvugt_id == 8939)) {
            this.$toast.error('Gói cước không bao gồm dịch vụ GreenNet. Đề nghị bỏ khai báo Dịch vụ GTGT Green Net trước khi khởi tạo gói cước')
            return false
          }

      //TODO KiemTraDL_ThueBao chua lam

      // if (ts_kt_accountvisa == 1)
      // {
      //     if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_FTTH)
      //     {
              // Bỏ do ATTT
      //     }
      // }
      // //string kt = Kiemtra_dungthu_mytv(vgoicuocasdl);

      // string strmatd = "";
      // strmatd = objCheckData.MAP_ID("matocdo", DatabaseConstants.DB2 + ".tocdo_adsl",
      //     "where tocdo_id = " + vgoicuocasdl);

      // if (txtTenTB.Text == "")
      // {
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     Message_Box.ShowTB("Hãy nhập tên thuê bao !");
      //     txtTenTB.Focus();
      //     return false;
      // }
      // //nhapt: thêm phần bắt nhập đối tượng đối với khách hàng mới.y/C TGG
      // if (cboDoituongTB.Text.trim() == "" || cboDoituongTB.EditValue == null || cboDoituongTB.EditValue == DBNull.Value)
      // {
      //     Message_Box.ShowTB("Hãy chọn đối tượng thuê bao!");
      //     cboDoituongTB.Focus();
      //     return false;
      // }
      // if (themmoi)
      // {
      //     if (!Kiemtra_dungthu_mytv())
      //     {
      //         var q = KIEM_TRA_DK(Convert.ToInt32(cboDoituongTB.EditValue), Convert.ToInt32(cboLoaihinhTB.SelectedValue), tt_nd.ngay_cn.ToString("MM/yyyy"), 0);
      //         if (q != "1" && q != "-2")
      //         {
      //             Message_Box.ShowWarning(q);
      //             return false;
      //         }
      //     }
      // }

      // if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.MGW_INTERNET_TRUCTIEP)
      // {
      //     if (Convert.ToInt32(cboPhanTachTD.SelectedValue) == 1) // Có phân tách
      //     {
      //         int k_tocdo_id = 0;
      //         int k_tocdo_nix = 0;
      //         int k_tocdo_isp = 0;
      //         k_tocdo_id = Convert.ToInt32(cboTocDo.SelectedValue);
      //         if (k_tocdo_id == 0)
      //         {
      //             Message_Box.ShowWarning("Tốc độ Tổng phải khác 0 !");
      //             cboTocDo.Focus();
      //             return false;
      //         }

      //         if (chkTocDo_NIX.Checked == false && chkTocDo_ISP.Checked == false)
      //         {
      //             Message_Box.ShowWarning("Bạn phải chọn tốc độ Nix hoặc Isp (Trường hợp phân tách tốc độ).");
      //             return false;
      //         }

      //         if (chkTocDo_NIX.Checked == true)
      //         {
      //             k_tocdo_nix = Convert.ToInt32(cboTocDo_NIX.SelectedValue);
      //             if (k_tocdo_nix == 0)
      //             {
      //                 Message_Box.ShowWarning("Tốc độ NIX phải khác 0 !");
      //                 cboTocDo_NIX.Focus();
      //                 return false;
      //             }
      //         }

      //         if (chkTocDo_ISP.Checked == true)
      //         {
      //             k_tocdo_isp = Convert.ToInt32(cboTocDo_ISP.SelectedValue);
      //             if (k_tocdo_isp == 0)
      //             {
      //                 Message_Box.ShowWarning("Tốc độ ISP phải khác 0 !");
      //                 cboTocDo_NIX.Focus();
      //                 return false;
      //             }
      //         }

      //         // kiểm tra tốc độ tổng
      //         string kq = laphd2.kiemtra_tocdo_internet_tt(k_tocdo_id, k_tocdo_nix, k_tocdo_isp);
      //         if (kq != "OK")
      //         {
      //             Message_Box.ShowWarning(kq);
      //             return false;
      //         }
      //     }
      //     else
      //     {
      //         if (Convert.ToInt32(cboTocDo.SelectedValue) == 0)
      //         {
      //             Message_Box.ShowWarning("Tốc độ Tổng phải khác 0 !");
      //             cboTocDo.Focus();
      //             return false;
      //         }

      //         if (chkTocDo_NIX.Checked == true || chkTocDo_ISP.Checked == true)
      //         {
      //             Message_Box.ShowWarning("Bạn không được chọn tốc độ Nix và Isp (Trường hợp không phân tách tốc độ).");
      //             return false;
      //         }
      //     }

      //     //if (chkTocDo_NIX.Checked == false && chkTocDo_ISP.Checked == false)
      //     //{
      //     //    Message_Box.ShowWarning("Bạn phải chọn tốc độ NIX hoặc ISP với loại hình Internet trực tiếp");
      //     //    return false;
      //     //}
      //     //if (chkTocDo_NIX.Checked == true && Convert.ToInt32(cboTocDo_NIX.SelectedValue) == 0)
      //     //{
      //     //    Message_Box.ShowWarning("Tốc độ NIX phải khác 0 !");
      //     //    cboTocDo_NIX.Focus();
      //     //    return false;
      //     //}

      //     //if (chkTocDo_ISP.Checked == true && Convert.ToInt32(cboTocDo_ISP.SelectedValue) == 0)
      //     //{
      //     //    Message_Box.ShowWarning("Tốc độ ISP phải khác 0 !");
      //     //    cboTocDo_NIX.Focus();
      //     //    return false;
      //     //}
      // }

      // //if (Convert.ToInt32(cboDoituongTB.EditValue) == DUNG_THU.DOITUONG_TB
      // //    && Convert.ToInt32(cboLoaihinhTB.SelectedValue) != LoaiHinhTB.INTERNET_FTTH
      // //    && Convert.ToInt32(cboLoaihinhTB.SelectedValue) != LoaiHinhTB.INTERNET_MYTV)
      // //{
      // //    Message_Box.ShowTB("Đối tượng \"Thuê bao dùng thử\" chỉ áp dụng cho Fiber hoặc MyTV!");
      // //    cboLoaihinhTB.Focus();
      // //    cboLoaihinhTB.SelectedValue = LoaiHinhTB.INTERNET_FTTH;
      // //    return false;
      // //}

      // if (Convert.ToInt32(cboDoituongTB.EditValue) == DUNG_THU.DOITUONG_TB)
      // {
      //     string kiemtra_dt = tdan.GET_VALUE_FUNC("{?DB2}.KIEMTRA_DICHVU_CHOPHEP_DUNGTHU", "vdichvuvt_id", Convert.ToInt32(cboDichVuVT.SelectedValue), "vloaitb_id", Convert.ToInt32(cboLoaihinhTB.SelectedValue)).ToString();
      //     if (kiemtra_dt != "ok")
      //     {
      //         Message_Box.ShowTB("Đối tượng \"Thuê bao dùng thử\" không áp dụng với dịch vụ này!");
      //         cboLoaihinhTB.Focus();
      //         cboLoaihinhTB.SelectedValue = LoaiHinhTB.INTERNET_FTTH;
      //         return false;
      //     }
      // }

      // if (Convert.ToInt32(cboDoituongTB.EditValue) == DUNG_THU.DOITUONG_TB)
      // {
      //     if (txtTGDungThu.Text == "")
      //     {
      //         Message_Box.ShowTB("Hãy nhập Thời gian dùng thử");
      //         txtTGDungThu.Focus();
      //         return false;
      //     }

      //     if (!Regex.IsMatch(txtTGDungThu.Text, @"^\d+$"))
      //     {
      //         Message_Box.ShowWarning("Thời gian dùng thử: " + txtTGDungThu.Text + " không phải là kiểu số!");
      //         return false;
      //     }

      //     if (Kiemtra_dungthu_mytv())
      //     {
      //         if ((trangbi_id == TRANGBI.MUA_THIETBI || trangbi_id == TRANGBI.THUE_THIETBI || trangbi_id == TRANGBI.KHACHHANG_TU_TRANGBI
      //             || trangbi_id == TRANGBI.VIENTHONG_TRANGBI || trangbi_id == TRANGBI.TTKD_TRANGBI)
      //             && (Convert.ToInt32(txtTGDungThu.Text) <= 0 || Convert.ToInt32(txtTGDungThu.Text) > 30))
      //         {
      //             Message_Box.ShowTB("Hãy nhập Thời gian dùng thử lớn hơn 0 và tối đa 30 (ngày)");
      //             txtTGDungThu.Focus();
      //             return false;
      //         }

      //         if (trangbi_id == TRANGBI.KHONG_SUDUNG_STB
      //             && (Convert.ToInt32(txtTGDungThu.Text) <= 0 || Convert.ToInt32(txtTGDungThu.Text) > 90))
      //         {
      //             Message_Box.ShowTB("Hãy nhập Thời gian dùng thử lớn hơn 0 và tối đa 90 (ngày)");
      //             txtTGDungThu.Focus();
      //             return false;
      //         }
      //     }
      //     else if (Convert.ToInt32(txtTGDungThu.Text) <= 0 || Convert.ToInt32(txtTGDungThu.Text) > 30)
      //     {
      //         Message_Box.ShowTB("Hãy nhập Thời gian dùng thử lớn hơn 0 và nhỏ hơn 30 (ngày)");
      //         txtTGDungThu.Focus();
      //         return false;
      //     }
      // }

      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.ADSL ||
      //     Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.MEGA_EYES)
      // {
      //     if (Convert.ToInt32(cboLoaiTB.SelectedValue) == 0)
      //     {
      //         if (trangbi_id != TRANGBI.KHONG_SUDUNG_STB)
      //         {
      //             Message_Box.ShowWarning("Bạn chưa chọn loại thiết bị cho thuê bao !");
      //             cboLoaiTB.Focus();
      //             return false;
      //         }
      //     }
      // }

      // // Honagpkn : 25/05/2018. Thêm rằng buộc trường hợp người dùng bỏ qua thông báo.( Mã thuê bao có dấu cách)
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.ADSL)
      // {
      //     if (!CommonFunction.KiemTraGoTV(txtAccountADSL))
      //     {
      //         Message_Box.ShowWarning("Account không đúng quy ước:\r\n- Chỉ bao gồm các ký tự chữ cái viết thường, các chữ số từ 0-9, dấu "
      //                                     + "_"
      //                                     + ", dấu .\r\n- Bắt đầu bằng một chữ cái");
      //         txtAccountADSL.Focus();
      //         txtAccountADSL.SelectAll();
      //         return false;
      //     }
      // }
      // // end hoàng

      // if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC
      //     || Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC)
      // {
      //     if (txtDiaChiTB.Text == "" || quantb_id == 0 || phuongtb_id == 0)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowTB("Hãy nhập địa chỉ thuê bao !");
      //         txtDiaChiTB.Focus();
      //         return false;
      //     }

      //     if (txtDiaChiLD.Text == "" || quanld_id == 0 || phuongld_id == 0)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowTB("Hãy nhập địa chỉ lắp đặt!");
      //         txtDiaChiLD.Focus();
      //         return false;
      //     }
      //     if (tinhld_id == tt_nd.tinh_id)
      //     {
      //         Message_Box.ShowTB("Tỉnh lắp đặt trùng tỉnh người dùng. Không được chọn loại hình Tỉnh khác !");
      //         txtDiaChiLD.Focus();
      //         return false;
      //     }
      // }
      // else
      // {
      //     if ((txtDiaChiTB.Text == "" || quantb_id == 0 || phuongtb_id == 0 || photb_id == 0 && khutb_id == 0 && aptb_id == 0) && tinh.tinhthicong_id != 98)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowTB("Hãy nhập địa chỉ thuê bao !");
      //         txtDiaChiTB.Focus();
      //         return false;
      //     }

      //     if ((txtDiaChiLD.Text == "" || quanld_id == 0 || phuongld_id == 0 || phold_id == 0 && khuld_id == 0 && apld_id == 0) && tinh.tinhthicong_id != 98)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowTB("Hãy nhập địa chỉ lắp đặt!");
      //         txtDiaChiLD.Focus();
      //         return false;
      //     }
      // }

      // //if (txtDiaChiTB.Text == "" || quantb_id == 0 || phuongtb_id == 0 || (photb_id == 0 && khutb_id == 0 && aptb_id == 0) || tinhtb_id != tt_nd.tinh_id)
      // //{
      // //    if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) != LoaiHinhTB.INTERNET_ADSL_TINH_KHAC
      // //    && Convert.ToInt32(cboLoaihinhTB.SelectedValue) != LoaiHinhTB.INTERNET_FIBER_TINH_KHAC)
      // //    {
      // //        if (tabctlThongTin.SelectedIndex == 0)
      // //            tabctlThongTin.SelectedIndex = 1;
      // //        Message_Box.ShowTB("Phải nhập địa chỉ thuê bao cho loại hình " + cboLoaihinhTB.Text);
      // //        txtDiaChiTB.Focus();
      // //        return false;
      // //    }
      // //}

      // //if (txtDiaChiLD.Text == "" || quanld_id == 0 || phuongld_id == 0 || (phold_id == 0 && khuld_id == 0 && apld_id == 0) || tinhld_id != tt_nd.tinh_id)
      // //{
      // //    if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) != LoaiHinhTB.INTERNET_ADSL_TINH_KHAC
      // //    && Convert.ToInt32(cboLoaihinhTB.SelectedValue) != LoaiHinhTB.INTERNET_FIBER_TINH_KHAC)
      // //    {
      // //        if (tabctlThongTin.SelectedIndex == 0)
      // //            tabctlThongTin.SelectedIndex = 1;
      // //        Message_Box.ShowTB("Phải nhập địa chỉ lắp đặt cho loại hình " + cboLoaihinhTB.Text);
      // //        txtDiaChiLD.Focus();
      // //        return false;
      // //    }
      // //}

      // if (cboDaiVT.Items.Count <= 0)
      // {
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     Message_Box.ShowTB("Địa chỉ lắp đặt này chưa được thiết lập đơn vị quản lý !");
      //     btnDiaChiLD.Focus();
      //     return false;
      // }
      // else
      // {
      //     if (cboDaiVT.SelectedValue == null)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowTB("Địa chỉ lắp đặt này chưa được thiết lập đơn vị quản lý !");
      //         btnDiaChiLD.Focus();
      //         return false;
      //     }
      //     if (cboDaiVT.Text == "")
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowTB("Địa chỉ lắp đặt này chưa được thiết lập đơn vị quản lý !");
      //         btnDiaChiLD.Focus();
      //         return false;
      //     }
      // }
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.MEGAWAN || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.METRONET)
      // {
      //     if (cboLoaiTBiWan.SelectedValue == null)
      //     {
      //         Message_Box.ShowWarning("Chưa chọn loại thiết bị !");
      //         cboLoaiTBiWan.Focus();
      //         return false;
      //     }
      //     if (Convert.ToInt32(cboLoaiSoWan.SelectedValue) == LOAINODE_MGWAN.NODE_PHU)
      //     {
      //         //if (string.IsNullOrEmpty(txtHuongKNWan.Text.trim()) && txtDiaChi_KN.Text.trim() == "")
      //         if (string.IsNullOrEmpty(txtHuongKNWan.Text.trim()))
      //         {
      //             Message_Box.ShowWarning("Chưa chọn hướng kết nối  Wan !");
      //             btnHuongKNWan.Focus();
      //             return false;
      //         }
      //         long id_sochinh = 0;
      //         if (string.IsNullOrEmpty(txtHuongKNWan.Text.trim()))
      //         {
      //             if (loaisochinh == 1)
      //                 id_sochinh = thuebao_id_cha;
      //             else
      //                 id_sochinh = hdtb_id_cha;
      //         }
      //     }

      //     if (Convert.ToInt32(cboLoaiSoWan.SelectedValue) == LOAINODE_MGWAN.NODE_DUPHONG_CONG_TOCDO
      //             || Convert.ToInt32(cboLoaiSoWan.SelectedValue) == LOAINODE_MGWAN.NODE_DUPHONG_TOCDO)
      //     {
      //         if (string.IsNullOrEmpty(txtHuongKNWan.Text.trim()))
      //         {
      //             Message_Box.ShowWarning("Chưa chọn Node chính !");
      //             btnHuongKNWan.Focus();
      //             return false;
      //         }
      //         long id_sochinh = 0;
      //         if (loaisochinh == 1)
      //             id_sochinh = thuebao_id_cha;
      //         else
      //             id_sochinh = hdtb_id_cha;
      //     }

      //     if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) != LoaiHinhTB.MGW_INTERNET_TRUCTIEP)
      //     {
      //         if (Convert.ToInt32(cboTocDo.SelectedValue) == 0)
      //         {
      //             Message_Box.ShowWarning("Tốc độ CIR phải khác 0 !");
      //             cboTocDo.Focus();
      //             return false;
      //         }
      //     }
      // }

      // if (Convert.ToInt32(cboKieuLD.SelectedValue) == KieuLapDat.THUESO_DT_CU_SAU_DC
      //     || Convert.ToInt32(cboKieuLD.SelectedValue) == KieuLapDat.THUESO_DT_CU_SAU_TL
      //     || Convert.ToInt32(cboKieuLD.SelectedValue) == KieuLapDat.THUESO_DT_MOI)
      // {
      //     if (noidung_thueso == "")
      //     {
      //         Message_Box.ShowWarning("Bạn chưa nhập đầy đủ thông tin thuê số !");
      //         return false;
      //     }

      // }
      // //longdx:km không có chi tiết không cho cập nhật
      // if (chkKhuyenMai.Checked && dsKM_HDTB.Tables[0].Rows.Count == 0)
      // {
      //     Message_Box.ShowWarning("Bạn chưa chọn chi tiết khuyến mại!");
      //     return false;
      // }
      // if (chkTraTruoc.Checked && dsDC_HDTB.Tables[0].Rows.Count == 0)
      // {
      //     Message_Box.ShowWarning("Bạn chưa chọn chi tiết trả trước!");
      //     return false;
      // }
      // if (batbuoc_chon_nhacc == 1 && chkNCCK.Checked)
      // {
      //     if (CboNhaCC_Cu.SelectedValue == null)
      //     {
      //         Message_Box.ShowWarning("Bạn chưa chọn nhà cung cấp!");
      //         CboNhaCC_Cu.Focus();
      //         return false;
      //     }
      //     if (cboHinhThucCM.SelectedValue == null)
      //     {
      //         Message_Box.ShowWarning("Bạn chưa chọn hình thức chuyển mạng!");
      //         cboHinhThucCM.Focus();
      //         return false;
      //     }
      // }
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.CO_DINH
      //     || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.GPHONE)
      // {
      //     if (cboMucCuocTB.Items.Count == 0)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowWarning("Chưa có mức cước thuê bao !");
      //         cboMucCuocTB.Focus();
      //         return false;
      //     }

      //     if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.PABX || Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.ISDN2B_CD
      //         || Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.ISDN2B_CQ || Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.ISDN30B_CD
      //         || Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.ISDN30B_CQ)
      //     {
      //         if (Convert.ToInt32(cboLoaiSo.SelectedValue) == LOAISO_ISDN.SOPHU)
      //         {
      //             if (string.IsNullOrEmpty(txtSoChinh.Text.trim()))
      //             {
      //                 Message_Box.ShowWarning("Chưa chọn số chính !");
      //                 btnChonSoChinh.Focus();
      //                 return false;
      //             }
      //             long id_sochinh = 0;
      //             if (loaisochinh == 1)
      //                 id_sochinh = thuebao_id_cha;
      //             else
      //                 id_sochinh = hdtb_id_cha;
      //             if (!laphd.KIEMTRA_TB_DATMOI_PABX(id_sochinh, Convert.ToInt32(cboLoaihinhTB.SelectedValue), loaisochinh))
      //             {
      //                 Message_Box.ShowWarning("Thuê bao đặt mới không cùng loại hình với số chính !");
      //                 cboLoaihinhTB.Focus();
      //                 return false;
      //             }
      //         }

      //         // hoangpkn : 25/02/2019.
      //         // trường hợp thêm số vào luồng có sẵn. ( áp dụng cho HNI ). --> quy trình GDV -> PSTN -> HTHS
      //         // rằng buộc phải chọn kiểu LĐ có nhomkieu_ld = 2. kiểu số = số phụ. Số chính phải là số trong danh bạ
      //         if (kt_themso_vaoluong_isdn)
      //         {
      //             int i_nhomkieuld = Convert.ToInt32(objCheckData.MAP_ID("nhomkieu_ld", DatabaseConstants.DB2 + ".kieu_ld", "where kieuld_id = " + Convert.ToInt32(cboKieuLD.SelectedValue)));
      //             if (i_nhomkieuld == 2)  // Kiểu lắp đặt : thêm số vào luồng
      //             {
      //                 if (Convert.ToInt32(cboLoaiSo.SelectedValue) == LOAISO_ISDN.SOCHINH)
      //                 {
      //                     Message_Box.ShowWarning("Bạn phải chọn loại số : Số phụ !");
      //                     cboLoaiSo.Focus();
      //                     return false;
      //                 }
      //                 if (txtSoChinh.Text.trim() == "")
      //                 {
      //                     Message_Box.ShowWarning("Bạn phải chọn số chính !");
      //                     txtSoChinh.Focus();
      //                     return false;
      //                 }

      //                 string str_kt_isdn = "";
      //                 str_kt_isdn += " Select * ";
      //                 str_kt_isdn += " From " + DatabaseConstants.DB2 + ".db_thuebao ";
      //                 str_kt_isdn += " Where ma_tb = '" + txtSoChinh.Text.trim() + "'";
      //                 str_kt_isdn += "    and loaitb_id = " + Convert.ToInt32(cboLoaihinhTB.SelectedValue);
      //                 DataSet ds_kt_isdn = new DataSet();
      //                 ds_kt_isdn = bangts.getDataFromSQL(str_kt_isdn, "kt_isdn");
      //                 if (ds_kt_isdn.Tables[0].Rows.Count <= 0)
      //                 {
      //                     Message_Box.ShowWarning("Số chính không phải là luồng ISDN có sẵn !");
      //                     txtSoChinh.Focus();
      //                     return false;
      //                 }
      //             }
      //             else
      //             {
      //                 string str_kt_isdn = "";
      //                 str_kt_isdn += " Select * ";
      //                 str_kt_isdn += " From " + DatabaseConstants.DB2 + ".db_thuebao ";
      //                 str_kt_isdn += " Where ma_tb = '" + txtSoChinh.Text.trim() + "'";
      //                 str_kt_isdn += "    and loaitb_id = " + Convert.ToInt32(cboLoaihinhTB.SelectedValue);
      //                 DataSet ds_kt_isdn = new DataSet();
      //                 ds_kt_isdn = bangts.getDataFromSQL(str_kt_isdn, "kt_isdn");
      //                 if (ds_kt_isdn.Tables[0].Rows.Count > 0)
      //                 {
      //                     Message_Box.ShowWarning("Số chính là luồng ISDN có sẵn. Bạn hãy chọn lại kiểu yêu cầu !");
      //                     return false;
      //                 }
      //             }
      //         }

      //     }
      //     if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.GPHONE && tsbtnNhapMoi.Enabled == false)
      //     {
      //         //Kiểm tra số máy gphone có trong kho số của CCBS hay không
      //         if (DONGBO_GPHONE.DONGBO)
      //         {
      //             string mavung = objCheckData.MAP_ID("mavung_cd", DatabaseConstants.DB2 + ".tinh", "where tinh_id = " + tt_nd.tinh_id);
      //             string userid = objCheckData.MAP_ID("user_gphone", DatabaseConstants.DB1 + ".nguoidung", "where nguoidung_id = " + tt_nd.nguoidung_id);
      //             if (userid == "-1")
      //             {
      //                 Message_Box.Show("Người dùng chưa được gán user kết nối hệ thống gphone. Liên hệ Admin để gán quyền.");
      //                 return false;
      //             }

      //             var dtCheck = new CCBSFacade().gphone_khoitao_khoso_search(mavung + txtSoMayGP.Text, DatabaseConstants.DB2.Substring(4).ToUpper(), userid);
      //             if (dtCheck == null)
      //             {
      //                 Message_Box.Show("Số máy không có trong kho số của hệ thống CCBS Gphone. Đề nghị kiểm tra lại.");
      //                 return false;
      //             }
      //             if (dtCheck.Rows.Count <= 0)
      //             {
      //                 Message_Box.Show("Số máy không có trong kho số của hệ thống CCBS Gphone. Đề nghị kiểm tra lại.");
      //                 return false;
      //             }
      //         }
      //     }
      // }

      if ((!this.thuebao.didong.txtSoMayDD || this.thuebao.didong.txtSoMayDD.trim().length == 0) && this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG) {
        // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
        this.$toast.error('Hãy nhập số máy di động !')
        // txtSoMayDD.Focus();
        return false
      }

      if ((!this.thuebao.didong.txtSimDD || this.thuebao.didong.txtSimDD.trim().length == 0) && this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG) {
        // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
        this.$toast.error('Hãy nhập số SimCard !')
        // txtSimDD.Focus();
        return false
      }

      if ((!this.thuebao.codinh.somay || this.thuebao.codinh.somay.trim().length == 0) && this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) {
        // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
        this.$toast.error('Hãy nhập số máy cố định !')
        // btnChonSM.Focus();
        return false
      }

      if ((!this.thuebao.mgwan.txtMaTBWan.Text || this.thuebao.mgwan.txtMaTBWan.Text.trim().length == 0) && (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM)) {
        // if (tabctlThongTin.SelectedIndex == 0)
        //     tabctlThongTin.SelectedIndex = 1;
        this.$toast.error(`Hãy nhập mã thuê bao ${this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN ? 'Megawan' : (this.listbox.dichvu_vt.value == DichVuVienThong.METRONET?'Metronet':'')} !`)
        // txtMaTBWan.Focus();
        return false
      }
      // if (dichvuvt_id == DichVuVienThong.MEGAWAN || dichvuvt_id == DichVuVienThong.METRONET)
      // {
      //     if (phainhap_vrf)
      //     {
      //         if (txtVrf_Mgwan.Text.trim() == "")
      //         {
      //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //             Message_Box.ShowWarning("Bạn chưa nhập VRF/VFI !");
      //             txtVrf_Mgwan.Focus();
      //             return false;
      //         }
      //     }

      //     if (batbuoc_nhap_lan_wan_ip)
      //     {
      //         if (txtLanIP.Text.trim() == "")
      //         {
      //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //             Message_Box.ShowWarning("Bạn chưa nhập Lan IP !");
      //             txtLanIP.Focus();
      //             return false;
      //         }

      //         if (txtWanIP.Text.trim() == "")
      //         {
      //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //             Message_Box.ShowWarning("Bạn chưa nhập Wan IP !");
      //             txtWanIP.Focus();
      //             return false;
      //         }
      //     }

      //     if (txtSoAoWan.Text == "" && !TUDONG_SINH_SOAO)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowWarning("Bạn chưa chọn số ảo !");
      //         txtSoAoWan.Focus();
      //         return false;
      //     }
      // }
      // if (dichvuvt_id == DichVuVienThong.ADSL || dichvuvt_id == DichVuVienThong.MEGA_EYES)
      // {
      //     if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) != LoaiHinhTB.INTERNET_ADSL_TINH_KHAC
      //         && Convert.ToInt32(cboLoaihinhTB.SelectedValue) != LoaiHinhTB.INTERNET_FIBER_TINH_KHAC)
      //         if (txtSoAoAdsl.Text == "" && !TUDONG_SINH_SOAO)
      //         {
      //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //             txtSoAoAdsl.Focus();
      //             Message_Box.ShowWarning("Bạn chưa chọn số ảo !");
      //             return false;
      //         }
      // }

      // if (txtMaTSL.Text.trim().Length == 0 && dichvuvt_id == DichVuVienThong.TSL)
      // {
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     Message_Box.ShowTB("Hãy nhập mã thuê bao Truyền số liệu !");
      //     txtMaTSL.Focus();
      //     return false;
      // }
      // if (dichvuvt_id == DichVuVienThong.TSL)
      // {
      //     if (phainhap_vrf)
      //     {
      //         if (txtVrf_Dau.Text.trim() == "")
      //         {
      //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //             Message_Box.ShowWarning("Bạn chưa nhập VRF/VFI điểm đầu !");
      //             txtVrf_Dau.Focus();
      //             return false;
      //         }
      //         if (txtVrf_Cuoi.Text.trim() == "")
      //         {
      //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //             Message_Box.ShowWarning("Bạn chưa nhập VRF/VFI điểm cuối !");
      //             txtVrf_Cuoi.Focus();
      //             return false;
      //         }
      //     }

      //     if (txtSoAoTSL_Dau.Text == "" && !TUDONG_SINH_SOAO)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowWarning("Bạn chưa chọn số ảo cho điểm đầu !");
      //         btnSoAoTSL_Dau.Focus();
      //         return false;
      //     }
      //     if (txtSoAoTSL_Cuoi.Text == "" && !TUDONG_SINH_SOAO)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowWarning("Bạn chưa chọn số ảo cho điểm cuối !");
      //         btnSoAoTSL_Cuoi.Focus();
      //         return false;
      //     }

      //     if (cboVetinhTSL_Dau.Text == "" && tt_nd.tinh_id == tinh_dau.tinhthicong_id)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowTB("Hãy chọn đơn vị đầu cho thuê bao truyền số liệu !");
      //         cboVetinhTSL_Dau.Focus();
      //         return false;
      //     }
      //     if (cboVetinhTSL_Cuoi.Text == "" && tt_nd.tinh_id == tinh_cuoi.tinhthicong_id)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0)
      //             tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowTB("Hãy chọn đơn vị cuối cho thuê bao truyền số liệu ");
      //         cboVetinhTSL_Cuoi.Focus();
      //         return false;
      //     }
      // }

      // if (txtSoMayGP.Text.trim().Length == 0 && dichvuvt_id == DichVuVienThong.GPHONE)
      // {
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     Message_Box.ShowTB("Hãy nhập số máy Gphone !");
      //     txtSoMayGP.Focus();
      //     return false;
      // }
      // if (nhap_simgp == 1)
      // {
      //     if (txtSoSimGphone.Text.trim().Length == 0 && dichvuvt_id == DichVuVienThong.GPHONE)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowTB("Hãy nhập số sim Gphone !");
      //         txtSoSimGphone.Focus();
      //         return false;
      //     }
      // }

      // if (txtAccountADSL.Text.trim().Length == 0 &&
      //     (dichvuvt_id == DichVuVienThong.ADSL || dichvuvt_id == DichVuVienThong.MEGA_EYES))
      // {
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     Message_Box.ShowTB("Hãy nhập Account " + cboLoaihinhTB.Text + " !");
      //     txtAccountADSL.Focus();
      //     return false;
      // }

      // if (txtMaTBIMS.Text.trim().Length == 0 && dichvuvt_id == DichVuVienThong.IMS)
      // {
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     Message_Box.ShowTB("Hãy nhập Số máy IMS !");
      //     txtMaTBIMS.Focus();
      //     return false;
      // }

      // if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.IMS_SIPTRUNKING)
      // {
      //     if (txtCuocGoiDT.Text.trim() == "")
      //     {
      //         Message_Box.ShowTB("Hãy nhập Số cuộc gọi đồng thời !");
      //         txtCuocGoiDT.Focus();
      //         return false;
      //     }
      //     if (Convert.ToInt32(cboChiTietDV.SelectedValue) == ChiTietDV_IMS.internet)
      //     {
      //         if (phainhap_ip_siptrunking == true && txtIp_IMS.Text.trim() == "")
      //         {
      //             Message_Box.ShowTB("Hãy nhập địa chỉ IP !");
      //             txtIp_IMS.Focus();
      //             return false;
      //         }
      //     }
      // }

      // //Kiểm tra thuê bao MYTV phải có ký tự hyn ở đầu
      // if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_MYTV)
      // {
      //     if (txtAccountADSL.Text.trim().Length <= 3)
      //     {
      //         Message_Box.ShowWarning("Account Mytv phải có 3 ký tự trở lên");
      //         return false;
      //     }

      //     if (txtAccountADSL.Text.ToString().Length > 18)
      //     {
      //         Message_Box.ShowWarning("Account MyTV không được vượt quá 18 ký tự!");
      //         txtAccountADSL.Focus();
      //         return false;
      //     }

      //     if (txtAccountADSL.Text.trim().Substring(0, 3).ToLower() != tinh.matinh.ToLower())
      //     {
      //         Message_Box.ShowWarning("3 ký tự đầu tiên phải là mã tỉnh '" + tinh.matinh.ToLower() + "'. Bạn hãy kiểm tra lại");
      //         return false;
      //     }

      //     // hoangpkn : 22/03/2017 . Đăng ký combo Fafilm chỉ dành cho 4 gói Mytv cơ bản VASC005/VASC006/VASC007/VASC008
      //     if (m_dsThueBao_DichVu.Tables[0].Rows.Count > 0)
      //     {
      //         int lth = m_dsThueBao_DichVu.Tables[0].Select("ma_dvgt in ('CB_FF_12','CB_FF_24') and dangky = 1").Length;
      //         if (lth >= 1)
      //         {
      //             //string strmatd = "";
      //             //strmatd = objCheckData.MAP_ID("matocdo", DatabaseConstants.DB2 + ".tocdo_adsl", "where tocdo_id = " + vgoicuocasdl);
      //             if (strmatd != "VASC005" && strmatd != "VASC006" && strmatd != "VASC007" && strmatd != "VASC008")
      //             {
      //                 Message_Box.ShowWarning("Bạn không được đăng ký combo Fafilm cho gói cước " + cboGoiCuocAdsl.Text);
      //                 return false;
      //             }
      //         }
      //     }
      // }

      // //
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.ADSL && (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_ADSL ||
      //     Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_FTTH
      //     || Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.WIFI_FIBER))
      // {
      //     if (nhap_tttc == 1)
      //     {
      //         if (txtTTCuoc.Text.trim() == "")
      //         {
      //             Message_Box.ShowTB("Hãy nhập thông tin tính cước");
      //             return false;
      //         }
      //     }
      // }
      // #region copy của anh cường bên form đặt mới thêm kiểm tra với IP Tĩnh và FIBER phải chọn loại IP
      // if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_FTTH && ts_kt_loaiip == 1)
      // {
      //     var dt_cuoc_adsl = cboGoiCuocAdsl.Properties.DataSource as DataTable;
      //     if (dt_cuoc_adsl != null && dt_cuoc_adsl.Rows.Count > 0)
      //     {
      //         var t = dt_cuoc_adsl.Select("IPTINH is not null and IPTINH>0 and tocdo_id=" + cboGoiCuocAdsl.EditValue);
      //         if (t.Length > 0)
      //         {
      //             if (cboLoaiIP.Properties.Items.Count == 0)
      //             {
      //                 Message_Box.ShowWarning("Không lấy được dữ liệu loại IP. Bạn hãy kiểm tra lại!");
      //                 return false;
      //             }
      //             bool kt_loaiip = false;
      //             for (int i = 0; i < cboLoaiIP.Properties.Items.Count; i++)
      //             {
      //                 if (cboLoaiIP.Properties.Items[i].CheckState == CheckState.Checked)
      //                 {
      //                     kt_loaiip = true;
      //                     break;
      //                 }
      //             }
      //             if (kt_loaiip == false)
      //             {
      //                 Message_Box.ShowWarning("Hãy chọn loại ip đối với ip tĩnh!");
      //                 return false;
      //             }
      //         }
      //     }
      // }
      // #endregion
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.ADSL &&
      //     (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.HTVC_FIBERVNN_ANALOG ||
      //     Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL))
      // {
      //     if (txtSL_Tivi.Text == "" || txtSL_Tivi.Text == "0")
      //     {
      //         Message_Box.ShowWarning("Bạn chưa nhập số lượng tivi đăng ký !");
      //         txtSL_Tivi.Focus();
      //         return false;
      //     }
      //     if (!Common.Utilities.CommonFunction.CheckIsNumber(Common.Utilities.CommonFunction.Unformat_tien(txtSL_Tivi.Text)))
      //     {
      //         Message_Box.ShowWarning("Dữ liệu số lượng tivi phải là kiểu số !");
      //         txtSL_Tivi.Focus();
      //         return false;
      //     }
      // }

      // if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC ||
      //     Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC)
      // {
      //     if (txtCSD_FIBER_TK.Text == "")
      //     {
      //         Message_Box.ShowWarning("Bạn chưa nhập cước sử dụng !");
      //         txtCSD_FIBER_TK.Focus();
      //         return false;
      //     }
      //     if (!Common.Utilities.CommonFunction.CheckIsNumber(Common.Utilities.CommonFunction.Unformat_tien(txtCSD_FIBER_TK.Text)))
      //     {
      //         Message_Box.ShowWarning("Dữ liệu cước sử dụng phải là kiểu số !");
      //         txtCSD_FIBER_TK.Focus();
      //         return false;
      //     }

      //     if (txtCTB_FIBER_TK.Text == "")
      //     {
      //         Message_Box.ShowWarning("Bạn chưa nhập cước thiết bị !");
      //         txtCTB_FIBER_TK.Focus();
      //         return false;
      //     }
      //     if (!Common.Utilities.CommonFunction.CheckIsNumber(Common.Utilities.CommonFunction.Unformat_tien(txtCTB_FIBER_TK.Text)))
      //     {
      //         Message_Box.ShowWarning("Dữ liệu cước thiết bị phải là kiểu số !");
      //         txtCTB_FIBER_TK.Focus();
      //         return false;
      //     }
      // }

      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.MEGA_EYES &&
      //     (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.MEGACAMERA))
      // {
      //     if (txtSL_Tivi.Text == "" || txtSL_Tivi.Text == "0")
      //     {
      //         Message_Box.ShowWarning("Bạn chưa nhập số lượng camera đăng ký !");
      //         txtSL_Tivi.Focus();
      //         return false;
      //     }
      //     if (!Common.Utilities.CommonFunction.CheckIsNumber(Common.Utilities.CommonFunction.Unformat_tien(txtSL_Tivi.Text)))
      //     {
      //         Message_Box.ShowWarning("Dữ liệu số lượng camera phải là kiểu số !");
      //         txtSL_Tivi.Focus();
      //         return false;
      //     }
      // }

      // if (txtNgaySNTB.Text == "  /  /")
      // {
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     Message_Box.ShowTB("Hãy nhập ngày sinh thuê bao !");
      //     txtNgaySNTB.Focus();
      //     return false;
      // }
      // if (cboKieuLD.SelectedValue == null)
      // {
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     Message_Box.ShowTB("Hãy chọn kiểu yêu cầu cho thuê bao này !");
      //     return false;
      // }
      // //HungHM - 20/09/2010 Kiểm tra khi kiểu lắp đặt trên đường có sẵn => mã truy nhập không đc trống.
      // CheckDataFacade obj = new CheckDataFacade();
      // int kieu = Convert.ToInt32(obj.MAP_ID("kieu", DatabaseConstants.DB2 + ".kieu_ld", "where kieuld_id =" + cboKieuLD.SelectedValue));

      // //minhnt
      // //Nếu là MyTV dùng thử -> phải là lắp kèm hoặc trên đường có sẵn fiber
      // if (Convert.ToInt32(cboDoituongTB.EditValue) == DUNG_THU.DOITUONG_TB
      //     && Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_MYTV)
      // {
      //     //try
      //     //{
      //     if (kieu != 1 && kieu != 2 && kieu != 3)//kèm, có sẵn, hoặc trên đường mega -> fiber
      //     {
      //         Message_Box.ShowWarning("MyTV dùng thử phải lắp đặt trên đường có sẵn (hoặc lắp kèm) với Fiber!");
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         cboKieuLD.Focus();
      //         return false;
      //     }
      //     //else
      //     //{
      //     //    if (txtMaTN_ADSL.Text.trim().Length != 0)
      //     //    {
      //     //        if (kieu == 1)//lắp kèm
      //     //        {
      //     //            int dt_dungthu = Convert.ToInt32(obj.MAP_ID("doituong_id", DatabaseConstants.DB2 + ".hd_thuebao", "where ma_tb ='" + txtMaTN_ADSL.Text.trim() + "' and loaitb_id=" + LoaiHinhTB.INTERNET_FTTH));
      //     //            if (dt_dungthu != DUNG_THU.DOITUONG_TB)
      //     //            {
      //     //                Message_Box.ShowWarning("MyTV dùng thử phải lắp đặt trên đường có sẵn (hoặc lắp kèm) với Fiber dùng thử!");
      //     //                if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     //                txtMaTN_ADSL.Focus();
      //     //                return false;
      //     //            }
      //     //        }
      //     //        if (kieu == 2)//lắp trên đường có sẵn
      //     //        {
      //     //            int dt_dungthu = Convert.ToInt32(obj.MAP_ID("doituong_id", DatabaseConstants.DB2 + ".db_thuebao", "where ma_tb ='" + txtMaTN_ADSL.Text.trim() + "' and loaitb_id=" + LoaiHinhTB.INTERNET_FTTH));
      //     //            if (dt_dungthu != DUNG_THU.DOITUONG_TB)
      //     //            {
      //     //                Message_Box.ShowWarning("MyTV dùng thử phải lắp đặt trên đường có sẵn (hoặc lắp kèm) với Fiber dùng thử!");
      //     //                if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     //                txtMaTN_ADSL.Focus();
      //     //                return false;
      //     //            }
      //     //        }
      //     //    }
      //     //}
      //     //}
      //     //catch (Exception)
      //     //{
      //     //}
      // }

      // if ((kieu == 1 || kieu == 2 || kieu == 4) && Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.CO_DINH && txtMaTN_CD.Text.trim().Length == 0)
      // {
      //     Message_Box.ShowWarning("Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!");
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     txtMaTN_CD.Focus();
      //     return false;
      // }
      // if ((kieu == 1 || kieu == 2 || kieu == 4) && Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.IMS && txtMaTN_IMS.Text.trim().Length == 0)
      // {
      //     Message_Box.ShowWarning("Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!");
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     txtMaTN_IMS.Focus();
      //     return false;
      // }
      // if ((kieu == 1 || kieu == 2 || kieu == 4) && txtMaTN_ADSL.Text.trim().Length == 0 && Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.ADSL)
      // {
      //     Message_Box.ShowWarning("Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!");
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     txtMaTN_ADSL.Focus();
      //     return false;
      // }

      // if ((kieu == 1 || kieu == 2) && txtMaTN_ADSL.Text.trim().Length != 0
      //     && Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_MYTV
      //     && Convert.ToInt32(cboDoituongTB.EditValue) != DUNG_THU.DOITUONG_TB)
      // {
      //     if (kieu == 1)//lắp kèm
      //     {
      //         int dt_dungthu = Convert.ToInt32(obj.MAP_ID("doituong_id", DatabaseConstants.DB2 + ".hd_thuebao", "where ma_tb ='" + txtMaTN_ADSL.Text.trim() + "'"));
      //         if (dt_dungthu == DUNG_THU.DOITUONG_TB)
      //         {
      //             Message_Box.ShowWarning("MyTV đối tượng \"không dùng thử\" không thể lắp đặt trên đường có sẵn (hoặc lắp kèm) với đối tượng dùng thử!");
      //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //             txtMaTN_ADSL.Focus();
      //             return false;
      //         }
      //     }
      //     if (kieu == 2)//lắp trên đường có sẵn
      //     {
      //         int dt_dungthu = Convert.ToInt32(obj.MAP_ID("doituong_id", DatabaseConstants.DB2 + ".db_thuebao", "where ma_tb ='" + txtMaTN_ADSL.Text.trim() + "'"));
      //         if (dt_dungthu == DUNG_THU.DOITUONG_TB)
      //         {
      //             Message_Box.ShowWarning("MyTV đối tượng \"không dùng thử\" không thể lắp đặt trên đường có sẵn (hoặc lắp kèm) với đối tượng dùng thử!");
      //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //             txtMaTN_ADSL.Focus();
      //             return false;
      //         }
      //     }
      // }

      // if ((kieu == 1 || kieu == 2 || kieu == 4)
      //     && (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.MEGAWAN || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.METRONET)
      //     && txtMaTN_Wan.Text.trim().Length == 0)
      // {
      //     Message_Box.ShowWarning("Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!");
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     txtMaTN_Wan.Focus();
      //     return false;
      // }

      // int kieu2 = Convert.ToInt32(objCheckData.MAP_ID("kieu", DatabaseConstants.DB2 + ".kieu_ld", "where kieuld_id =" + cboKieuLD.SelectedValue));
      // //Nếu lắp trên đường có sẵn hoặc lắp kèm thì lấy mã đôi cáp từ form chọn xuống
      // if (kieu2 == 1 || kieu2 == 2 || kieu2 == 4)
      // {
      //     if (txtMaDoiCap_CD.Text.trim().Length == 0)
      //     {
      //         Message_Box.ShowWarning("Đối kiểu lắp đặt là lắp kèm hoặc trên đường có sẵn thì mã đôi cáp không được trống.");
      //         return false;
      //     }
      // }
      // #region Kiểm tra kiểu lắp đặt bán chéo bán
      // int kieu1 = Convert.ToInt32(obj.MAP_ID("kieu", DatabaseConstants.DB2 + ".kieu_ld", "where kieuld_id =" + thongso_ban.kieuld_id));

      // //minhnt
      // //Nếu là MyTV dùng thử -> phải là lắp kèm hoặc trên đường có sẵn fiber
      // if (Convert.ToInt32(cboDoituongTB.EditValue) == DUNG_THU.DOITUONG_TB
      //     && Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_MYTV)
      // {
      //     //try
      //     //{
      //     if (kieu1 != 1 && kieu1 != 2 && kieu1 != 3)//kèm, có sẵn, hoặc trên đường mega -> fiber
      //     {
      //         Message_Box.ShowWarning("MyTV dùng thử phải lắp đặt trên đường có sẵn (hoặc lắp kèm) với Fiber!");
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         cboKieuLD.Focus();
      //         return false;
      //     }
      //     //else
      //     //{
      //     //    if (txtMaTN_ADSL.Text.trim().Length != 0)
      //     //    {
      //     //        if (kieu == 1)//lắp kèm
      //     //        {
      //     //            int dt_dungthu = Convert.ToInt32(obj.MAP_ID("doituong_id", DatabaseConstants.DB2 + ".hd_thuebao", "where ma_tb ='" + txtMaTN_ADSL.Text.trim() + "' and loaitb_id=" + LoaiHinhTB.INTERNET_FTTH));
      //     //            if (dt_dungthu != DUNG_THU.DOITUONG_TB)
      //     //            {
      //     //                Message_Box.ShowWarning("MyTV dùng thử phải lắp đặt trên đường có sẵn (hoặc lắp kèm) với Fiber dùng thử!");
      //     //                if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     //                txtMaTN_ADSL.Focus();
      //     //                return false;
      //     //            }
      //     //        }
      //     //        if (kieu == 2)//lắp trên đường có sẵn
      //     //        {
      //     //            int dt_dungthu = Convert.ToInt32(obj.MAP_ID("doituong_id", DatabaseConstants.DB2 + ".db_thuebao", "where ma_tb ='" + txtMaTN_ADSL.Text.trim() + "' and loaitb_id=" + LoaiHinhTB.INTERNET_FTTH));
      //     //            if (dt_dungthu != DUNG_THU.DOITUONG_TB)
      //     //            {
      //     //                Message_Box.ShowWarning("MyTV dùng thử phải lắp đặt trên đường có sẵn (hoặc lắp kèm) với Fiber dùng thử!");
      //     //                if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     //                txtMaTN_ADSL.Focus();
      //     //                return false;
      //     //            }
      //     //        }
      //     //    }
      //     //}
      //     //}
      //     //catch (Exception)
      //     //{
      //     //}
      // }

      // if ((kieu1 == 1 || kieu1 == 2 || kieu1 == 4) && Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.CO_DINH && txtMaTN_CD.Text.trim().Length == 0)
      // {
      //     Message_Box.ShowWarning("Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!");
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     txtMaTN_CD.Focus();
      //     return false;
      // }
      // if ((kieu1 == 1 || kieu1 == 2 || kieu1 == 4) && Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.IMS && txtMaTN_IMS.Text.trim().Length == 0)
      // {
      //     Message_Box.ShowWarning("Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!");
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     txtMaTN_IMS.Focus();
      //     return false;
      // }
      // if ((kieu1 == 1 || kieu1 == 2 || kieu1 == 4) && txtMaTN_ADSL.Text.trim().Length == 0 && Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.ADSL)
      // {
      //     Message_Box.ShowWarning("Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!");
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     txtMaTN_ADSL.Focus();
      //     return false;
      // }

      // if ((kieu1 == 1 || kieu1 == 2) && txtMaTN_ADSL.Text.trim().Length != 0
      //     && thongso_ban.kieuld_id == LoaiHinhTB.INTERNET_MYTV
      //     && thongso_ban.kieuld_id != DUNG_THU.DOITUONG_TB)
      // {
      //     if (kieu1 == 1)//lắp kèm
      //     {
      //         int dt_dungthu = Convert.ToInt32(obj.MAP_ID("doituong_id", DatabaseConstants.DB2 + ".hd_thuebao", "where ma_tb ='" + txtMaTN_ADSL.Text.trim() + "'"));
      //         if (dt_dungthu == DUNG_THU.DOITUONG_TB)
      //         {
      //             Message_Box.ShowWarning("MyTV đối tượng \"không dùng thử\" không thể lắp đặt trên đường có sẵn (hoặc lắp kèm) với đối tượng dùng thử!");
      //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //             txtMaTN_ADSL.Focus();
      //             return false;
      //         }
      //     }
      //     if (kieu1 == 2)//lắp trên đường có sẵn
      //     {
      //         int dt_dungthu = Convert.ToInt32(obj.MAP_ID("doituong_id", DatabaseConstants.DB2 + ".db_thuebao", "where ma_tb ='" + txtMaTN_ADSL.Text.trim() + "'"));
      //         if (dt_dungthu == DUNG_THU.DOITUONG_TB)
      //         {
      //             Message_Box.ShowWarning("MyTV đối tượng \"không dùng thử\" không thể lắp đặt trên đường có sẵn (hoặc lắp kèm) với đối tượng dùng thử!");
      //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //             txtMaTN_ADSL.Focus();
      //             return false;
      //         }
      //     }
      // }

      // if ((kieu1 == 1 || kieu1 == 2 || kieu1 == 4)
      //     && (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.MEGAWAN || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.METRONET)
      //     && txtMaTN_Wan.Text.trim().Length == 0)
      // {
      //     Message_Box.ShowWarning("Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!");
      //     if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //     txtMaTN_Wan.Focus();
      //     return false;
      // }
      // #endregion
      try {
        // #region Kiểm tra kiểu lắp đặt bán chéo tc
        var kieu_tc = await API.post_fn_tt_kieu_ld(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, param: this.thongso_tc.kieuld_id })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return 0
          })
          .catch(() => {
            return 0
          }) //this.listbox.kieu_ld.list.filter(x=>x.kieuld_id==this.thongso_tc.kieuld_id)[0]['kieu']*1;
        // int kieu_tc = Convert.ToInt32(new CheckData().MAP_ID(tinh, "kieu", DatabaseConstants.DB2 + ".kieu_ld", "where kieuld_id =" + thongso_tc.kieuld_id));

        // //minhnt
        // //Nếu là MyTV dùng thử -> phải là lắp kèm hoặc trên đường có sẵn fiber
        if (this.listbox.doituong.value == DUNG_THU.DOITUONG_TB && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
          //try
          //{
          if (kieu_tc != 1 && kieu_tc != 2 && kieu_tc != 3) {
            //kèm, có sẵn, hoặc trên đường mega -> fiber
            this.$toast.error('MyTV dùng thử phải lắp đặt trên đường có sẵn (hoặc lắp kèm) với Fiber!')
            // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
            // cboKieuLD.Focus();
            return false
          }
        }

        if ((kieu_tc == 1 || kieu_tc == 2 || kieu_tc == 4) && this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH && (!this.thuebaocd.matn || (this.thuebaocd.matn + '').trim().length == 0)) {
          if (this.thongso_tc.ma_tn) {
            this.thuebaocd.matn = this.thongso_tc.ma_tn
          } else {
            this.$toast.error('Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!')
            // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
            // txtMaTN_CD.Focus();
            return false
          }
        }
        if ((kieu_tc == 1 || kieu_tc == 2 || kieu_tc == 4) && this.listbox.dichvu_vt.value == DichVuVienThong.IMS && (!this.thuebao.ims.txtMaTN_IMS || (this.thuebao.ims.txtMaTN_IMS + '').trim().length == 0)) {
          if (this.thongso_tc.ma_tn) {
            this.thuebao.ims.txtMaTN_IMS = this.thongso_tc.ma_tn
          } else {
            this.$toast.error('Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!')
            // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
            // txtMaTN_IMS.Focus();
            return false
          }
        }
        if ((kieu_tc == 1 || kieu_tc == 2 || kieu_tc == 4) && (!this.thuebao.adsl.txtMaTN_ADSL || (this.thuebao.adsl.txtMaTN_ADSL + '').trim().length == 0) && this.listbox.dichvu_vt.value == DichVuVienThong.ADSL) {
          if (this.thongso_tc.ma_tn != '') {
            this.thuebao.adsl.txtMaTN_ADSL = this.thongso_tc.ma_tn
          } else {
            this.$toast.error('Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!')
            // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
            // txtMaTN_ADSL.Focus();
            return false
          }
        }

        // if ((kieu_tc == 1 || kieu_tc == 2) && this.thuebao.adsl.txtMaTN_ADSL
        //     && this.thongso_tc.kieuld_id == LoaiHinhTB.INTERNET_MYTV
        //     && this.thongso_tc.doituong_id != DUNG_THU.DOITUONG_TB)
        // {
        //     if (kieu_tc == 1)//lắp kèm
        //     {
        //         int dt_dungthu = Convert.ToInt32(obj.MAP_ID("doituong_id", DatabaseConstants.DB2 + ".hd_thuebao", "where ma_tb ='" + txtMaTN_ADSL.Text.trim() + "'"));
        //         if (this.listbox.doituong.value == DUNG_THU.DOITUONG_TB)
        //         {
        //             Message_Box.ShowWarning("MyTV đối tượng \"không dùng thử\" không thể lắp đặt trên đường có sẵn (hoặc lắp kèm) với đối tượng dùng thử!");
        //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
        //             txtMaTN_ADSL.Focus();
        //             return false;
        //         }
        //     }
        //     if (kieu_tc == 2)//lắp trên đường có sẵn
        //     {
        //         int dt_dungthu = Convert.ToInt32(obj.MAP_ID("doituong_id", DatabaseConstants.DB2 + ".db_thuebao", "where ma_tb ='" + txtMaTN_ADSL.Text.trim() + "'"));
        //         if (dt_dungthu == DUNG_THU.DOITUONG_TB)
        //         {
        //             Message_Box.ShowWarning("MyTV đối tượng \"không dùng thử\" không thể lắp đặt trên đường có sẵn (hoặc lắp kèm) với đối tượng dùng thử!");
        //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
        //             txtMaTN_ADSL.Focus();
        //             return false;
        //         }
        //     }
        // }

        if ((kieu_tc == 1 || kieu_tc == 2 || kieu_tc == 4) && (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) && (!this.thuebao.mgwan.matn || (this.thuebao.mgwan.matn + '').trim().length == 0)) {
          if (this.thongso_tc.ma_tn) {
            this.thuebao.mgwan.matn = this.thongso_tc.ma_tn
          } else {
            this.$toast.error('Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!')
            // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
            // txtMaTN_Wan.Focus();
            return false
          }
        }
        // #endregion
      } catch (ex) {
        console.error('kieu_tc', this.thongso_tc.kieuld_id, this.listbox.kieu_ld.list)
      }
      // #region Kiểm tra dịch vụ truyền số liệu
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.TSL)
      // {
      //     if (tinhdau_id == 0 && quandau_id == 0 && phuongdau_id == 0)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowWarning("Hãy chọn địa chỉ đầu truyền số liệu !");
      //         txtDiaChiDau.Focus();
      //         return false;
      //     }

      //     if (tinhcuoi_id == 0 && quancuoi_id == 0 && phuongcuoi_id == 0)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowWarning("Hãy chọn địa chỉ cuối truyền số liệu !");
      //         txtDiaChiCuoi.Focus();
      //         return false;
      //     }

      //     if (cboVetinhTSL_Dau.Items.Count == 0 && tinh_dau.tinhthicong_id != 98)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowWarning("Địa chỉ đầu chưa có dữ liệu !");
      //         cboVetinhTSL_Dau.Focus();
      //         return false;
      //     }
      //     if (cboVetinhTSL_Cuoi.Items.Count == 0 && tinh_cuoi.tinhthicong_id != 98)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowWarning("Địa chỉ cuối chưa có dữ liệu !");
      //         cboVetinhTSL_Cuoi.Focus();
      //         return false;
      //     }
      // }
      // #endregion

      // #region Kiểm tra dịch vụ di động
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.DI_DONG)
      // {
      //     if (txtSoMayDD.Text.trim().Length == 0)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         txtSoMayDD.SelectAll();
      //         txtSoMayDD.Focus();
      //         Message_Box.ShowWarning("Số máy di động không được trống !");
      //         return false;
      //     }
      //     if (txtSimDD.Text.trim().Length == 0)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         txtSimDD.SelectAll();
      //         txtSimDD.Focus();
      //         Message_Box.ShowWarning("Số SimCard di động không được trống !");
      //         return false;
      //     }
      //     if (CommonFunction.KTSoMayDiDong(txtSoMayDD.Text.trim()) == false)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         txtSoMayDD.SelectAll();
      //         txtSoMayDD.Focus();
      //         return false;
      //     }
      //     if (cboDTVinaPhone.Items.Count == 0)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //         Message_Box.ShowWarning("Không có dữ liệu đối tượng VinaPhone. Bạn hãy chọn lại loại khách hàng !");
      //         cboLoaiKH.Focus();
      //         return false;
      //     }
      // }
      // #endregion

      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.CO_DINH || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.GPHONE)
      // {
      //     if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.DIENTHOAI_CD || Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.GPHONE)
      //     {
      //         if (cboMucCuocTB.Items.Count == 0)
      //         {
      //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //             Message_Box.ShowWarning("Chưa có mức cước thuê bao tháng cho dịch vụ cố định/Gphone. Bạn hãy kiểm tra lại thông tin !");
      //             cboMucCuocTB.Focus();
      //             return false;
      //         }
      //     }
      // }
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.DICHVU_CNTT
      //     || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.ANTOAN_BAOMAT_TT
      //     || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.TRUNGTAM_DULIEU
      //     || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.HOINGHI_TRUYENHINH)
      // {
      //     //if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.BRANDNAME)
      //     //{
      //     if (cboMucCuocTB.Items.Count == 0)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0)
      //             tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowWarning("Chưa có mức cước thuê bao tháng. Bạn hãy kiểm tra lại thông tin !");
      //         cboMucCuocTB.Focus();
      //         return false;
      //     }
      //     //}
      // }

      // #region Kiểm tra dịch vụ IMS
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.IMS)
      // {
      //     if (cboMucCuocTB.Items.Count == 0)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowWarning("Chưa có mức cước thuê bao tháng cho dịch vụ IMS. Bạn hãy kiểm tra lại thông tin !");
      //         cboMucCuocTB.Focus();
      //         return false;
      //     }
      // }
      // #endregion

      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.CO_DINH ||
      //     Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.GPHONE ||
      //     Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.ADSL ||
      //     Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.IMS ||
      //     Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.HOINGHI_TRUYENHINH)
      // {
      //     if (cboMucCuocTB.Items.Count == 0)
      //     {
      //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //         Message_Box.ShowTB("Chưa có mức cước thuê bao !");
      //         cboMucCuocTB.Focus();
      //         return false;
      //     }
      // }

      // for (int i = 0; i < dtControl.Rows.Count; i++)
      // {
      //     if (cbo[i].Text == "")
      //     {
      //         Message_Box.ShowTB("Chưa có dữ liệu về đơn vị, Loại ĐV ID: " + dtControl.Rows[i]["loaidv_dich_id"].ToString() + ". Bạn hãy kiểm tra lại!");
      //         return false;
      //     }
      //     if (Convert.ToInt32(cbo[i].SelectedValue) == 0)
      //     {
      //         Message_Box.ShowTB("Chưa có dữ liệu về đơn vị, Loại ĐV ID: " + dtControl.Rows[i]["loaidv_dich_id"].ToString() + ". Bạn hãy kiểm tra lại!");
      //         return false;
      //     }
      // }

      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.MEGAWAN || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.METRONET)
      // {
      //     if (Convert.ToInt32(cboThoiHanWan.SelectedValue) == ThoiHan.Ngan_Han && kt_thuenganhan == false)
      //     {
      //         Message_Box.ShowWarning("Bạn chưa chọn thời gian thuê ngắn hạn !");
      //         return false;
      //     }
      // }
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.TSL)
      // {
      //     if (Convert.ToInt32(cboThoiHan_TSL.SelectedValue) == ThoiHan.Ngan_Han && kt_thuenganhan == false)
      //     {
      //         Message_Box.ShowWarning("Bạn chưa chọn thời gian thuê ngắn hạn !");
      //         return false;
      //     }
      // }
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.CO_DINH)
      // {
      //     if (Convert.ToInt32(cboThoiHan_CD.SelectedValue) == ThoiHan.Ngan_Han && kt_thuenganhan == false)
      //     {
      //         Message_Box.ShowWarning("Bạn chưa chọn thời gian thuê ngắn hạn !");
      //         return false;
      //     }
      // }
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.ADSL)
      // {
      //     if (Convert.ToInt32(cboThoiHan_ADSL.SelectedValue) == ThoiHan.Ngan_Han && kt_thuenganhan == false)
      //     {
      //         Message_Box.ShowWarning("Bạn chưa chọn thời gian thuê ngắn hạn !");
      //         return false;
      //     }
      // }
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.IMS)
      // {
      //     if (Convert.ToInt32(cboThoiHan_IMS.SelectedValue) == ThoiHan.Ngan_Han && kt_thuenganhan == false)
      //     {
      //         Message_Box.ShowWarning("Bạn chưa chọn thời gian thuê ngắn hạn !");
      //         return false;
      //     }
      // }
      // //dsCTM_TBI

      // int int_trangbi = 0;
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.CO_DINH)
      //     int_trangbi = Convert.ToInt32(cboTrangBiCD.SelectedValue);
      // else if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.MEGAWAN
      //     || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.METRONET)
      //     int_trangbi = Convert.ToInt32(cboTrangBiWan.SelectedValue);
      // else if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.TSL)
      //     int_trangbi = Convert.ToInt32(cboTrangBi.SelectedValue);
      // else if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.GPHONE)
      //     int_trangbi = Convert.ToInt32(cboTrangBiGphone.SelectedValue);
      // else if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.IMS)
      //     int_trangbi = Convert.ToInt32(cboTrangBiIMS.SelectedValue);
      // else if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.MEGA_EYES
      //     || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.ADSL)
      //     int_trangbi = Convert.ToInt32(cboTrangBiADSL.SelectedValue);

      // if (int_trangbi == TRANGBI.MUA_THIETBI)
      // {
      //     if (Convert.ToInt32(cboDichVuVT.SelectedValue) != DichVuVienThong.ANTOAN_BAOMAT_TT
      //         && Convert.ToInt32(cboDichVuVT.SelectedValue) != DichVuVienThong.DICHVU_CNTT
      //         && Convert.ToInt32(cboDichVuVT.SelectedValue) != DichVuVienThong.TRUNGTAM_DULIEU
      //         && Convert.ToInt32(cboDichVuVT.SelectedValue) != DichVuVienThong.HOINGHI_TRUYENHINH)
      //     {
      //         if (dsCTM_TBI.Tables[0].Rows.Count <= 0)
      //         {
      //             Message_Box.ShowWarning("Bạn chưa chọn thiết bị để mua!");
      //             if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
      //             return false;
      //         }
      //     }
      // }
      // if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.ANTOAN_BAOMAT_TT
      //         || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.DICHVU_CNTT
      //         || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.TRUNGTAM_DULIEU
      //         || Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.HOINGHI_TRUYENHINH)
      // {
      //     //Bind và kiểm tra dữ liệu dịch vụ CNTT
      //     grvMacdinh.CloseEditor();
      //     if (this.gridEditors.Count <= 0)
      //     {
      //         Message_Box.ShowWarning("Chưa được thiết lập tham số dịch vụ. Liên hệ admin để kiểm tra");
      //         return false;
      //     }

      //     if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.TTDL_HDDT)
      //     {
      //         for (int index = 0; index < this.gridEditors.Count; ++index)
      //         {
      //             ItemList[index].sValue = this.gridEditors[index].Value.ToString().trim();

      //             if (this.gridEditors[index].ID == "TOCDO_ID")
      //             {
      //                 if (this.gridEditors[index].Value.ToString() != "")
      //                 {
      //                     if (Convert.ToInt32(this.gridEditors[index].Value.ToString()) == TOCDO.HDDT_GOI_TREN_10000
      //                         || Convert.ToInt32(this.gridEditors[index].Value.ToString()) == TOCDO.HDDT_GOI_GIAIPHAP)
      //                     {
      //                         if (dsCTM_TBI.Tables[0].Rows.Count <= 0)
      //                         {
      //                             Message_Box.ShowWarning("Bạn chưa chọn thiết bị để mua!");
      //                             return false;
      //                         }
      //                     }
      //                 }
      //             }
      //         }
      //     }
      //     else
      //     {
      //         for (int index = 0; index < this.gridEditors.Count; ++index)
      //         {
      //             ItemList[index].sValue = this.gridEditors[index].Value.ToString().trim();
      //         }
      //     }

      //     if (themmoi == true)
      //     {
      //         loaitb_sinhmatb_td = laphd.Lay_lhtb_sinh_ma_tb_tudong(Convert.ToInt32(cboLoaihinhTB.SelectedValue));
      //         if (loaitb_sinhmatb_td == 1)
      //         {
      //             vma_tb_cntt = laphd2.SINH_MATB_CNTT(Convert.ToInt32(cboLoaihinhTB.SelectedValue));
      //             if (vma_tb_cntt == "-1" || vma_tb_cntt == "")
      //             {
      //                 Message_Box.ShowWarning("Liên hệ admin để kiểm tra lại mã thuê bao !");
      //                 return false;
      //             }
      //             else
      //             {
      //                 if (themmoi == true)
      //                 {
      //                     string _strMatb = "select 1 from " + DatabaseConstants.DB2 + ".db_thuebao where loaitb_id = " + cboLoaihinhTB.SelectedValue.ToString();
      //                     _strMatb += " and ma_tb = '" + vma_tb_cntt + "'";
      //                     _strMatb += " union all select 1 from " + DatabaseConstants.DB2 + ".hd_thuebao a, " + DatabaseConstants.DB2 + ".hd_khachhang b ";
      //                     _strMatb += "where a.hdkh_id = b.hdkh_id and b.loaihd_id = 1 and a.tthd_id not in (6, 7) and a.loaitb_id = " + cboLoaihinhTB.SelectedValue.ToString() + " and a.ma_tb = '" + vma_tb_cntt + "'";
      //                     DataTable _dtMatb = bangts.GetDataSql(_strMatb);
      //                     if (_dtMatb != null && _dtMatb.Rows.Count > 0)
      //                     {
      //                         Message_Box.ShowTB("Account " + cboLoaihinhTB.Text + " đã tồn tại trên hệ thống. Bạn hãy chọn account khác!");
      //                         return false;
      //                     }
      //                 }
      //                 //else
      //                 //{
      //                 //    string _strMatb = "select 1 from " + DatabaseConstants.DB2 + ".db_thuebao where loaitb_id = " + cboLoaihinhTB.SelectedValue.ToString();
      //                 //    _strMatb += " and ma_tb = '" + vma_tb_cntt + "'";
      //                 //    _strMatb += " union all select 1 from " + DatabaseConstants.DB2 + ".hd_thuebao a, " + DatabaseConstants.DB2 + ".hd_khachhang b ";
      //                 //    _strMatb += " where a.hdkh_id = b.hdkh_id and b.loaihd_id = 1 and a.tthd_id not in (6, 7) and a.loaitb_id = " + cboLoaihinhTB.SelectedValue.ToString() + " and a.ma_tb = '" + vma_tb_cntt + "'";
      //                 //    _strMatb += " and a.hdtb_id<>" + hdtb_id;
      //                 //    DataTable _dtMatb = bangts.GetDataSql(_strMatb);
      //                 //    if (_dtMatb != null && _dtMatb.Rows.Count > 0)
      //                 //    {
      //                 //        Message_Box.ShowTB("Account " + cboLoaihinhTB.Text + " đã tồn tại trên hệ thống. Bạn hãy chọn account khác!");
      //                 //        txtAccountADSL.Focus();
      //                 //        return false;
      //                 //    }
      //                 //}
      //             }

      //             grvMacdinh.CloseEditor();
      //             for (int index = 0; index < this.gridEditors.Count; ++index)
      //             {
      //                 if (this.gridEditors[index].ID == "MA_TB")
      //                 {
      //                     this.gridEditors[index].Value = vma_tb_cntt;
      //                 }
      //             }
      //         }
      //         else
      //             vma_tb_cntt = "";
      //     }

      //     if (CheckDataError(ItemList, ItemList.Length, "HD_CNTT", "HDTB_ID", hdtb_id.ToString(), kieu))
      //     {
      //         return false;
      //     }

      //     if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.FSECURE)
      //     {
      //         string sodt = "";
      //         string matbtn = "";
      //         for (int i = 0; i < ItemList.Length; i++)
      //         {
      //             if (ItemList[i].sFieldName == "SO_DT")
      //             {
      //                 sodt = ItemList[i].sValue;
      //             }
      //             if (ItemList[i].sFieldName == "MATB_TN")
      //             {
      //                 matbtn = ItemList[i].sValue;
      //             }
      //         }
      //         if ((kieu == 1 || kieu == 2) && matbtn.Length == 0)
      //         {
      //             Message_Box.ShowWarning("Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!");
      //             return false;
      //         }
      //         if (sodt.trim() == "")
      //         {
      //             Message_Box.ShowWarning("Hãy nhập Số điện thoại !");
      //             return false;
      //         }

      //         if (sodt.StartsWith("0") == true)
      //         {
      //             Message_Box.ShowWarning("Bạn hãy bỏ số '0' ở đầu số điện thoại Fsecure !");
      //             return false;
      //         }

      //         if (sodt.trim().Length < 9 || sodt.trim().Length > 10)
      //         {
      //             Message_Box.ShowWarning("Bạn phải nhập số di động vào (9 ký tự số <= Số điện thoại <= 10 ký tự số) !");
      //             return false;
      //         }

      //         if (!Common.Utilities.CommonFunction.CheckIsNumber(Common.Utilities.CommonFunction.Unformat_tien(sodt)))
      //         {
      //             Message_Box.ShowWarning("Số điện thoại phải là kiểu số) !");
      //             return false;
      //         }

      //         try
      //         {
      //             if (new TraCuuDanhBaFacade2().Kiemtra_sodt(sodt.trim()) == 0)
      //             {
      //                 Message_Box.ShowWarning("Số điện thoại không chính xác. Bạn hãy nhập lại!");
      //                 return false;
      //             }
      //         }
      //         catch (Exception)
      //         {
      //         }

      //         //Kiểm tra trên hệ thống Fsecure
      //         try
      //         {
      //             if (themmoi == true)
      //             {
      //                 FSecureService secure = new FSecureService();
      //                 string message = "";

      //                 int _status = secure.UserStatus(sodt.trim(), ref message);
      //                 if (_status == 1)
      //                 {
      //                     Message_Box.ShowTB("Số điện thoại này đã được sử dụng để đăng ký Fsecure. Bạn hãy nhập SĐT khác!");
      //                     return false;
      //                 }

      //                 DataSet dsKtra = new TraCuuDanhBaFacade2().KiemTra_sodt_fsecure(sodt.trim(), 0);//bangts.GetSQL(strKtra, "");
      //                 if (dsKtra != null && dsKtra.Tables[0].Rows.Count > 0)
      //                 {
      //                     Message_Box.ShowWarning("Số điện thoại này đã được sử dụng để đăng ký Fsecure. Bạn hãy nhập SĐT khác!");
      //                     return false;
      //                 }
      //             }
      //             else
      //             {
      //                 FSecureService secure = new FSecureService();
      //                 string message = "";

      //                 int _status = secure.UserStatus(sodt.trim(), ref message);
      //                 if (_status == 1)
      //                 {
      //                     Message_Box.ShowTB("Số điện thoại này đã được sử dụng để đăng ký Fsecure. Bạn hãy nhập SĐT khác!");
      //                     return false;
      //                 }

      //                 DataSet dsKtra = new TraCuuDanhBaFacade2().KiemTra_sodt_fsecure(sodt.trim(), hdtb_id);//bangts.GetSQL(strKtra, "");
      //                 if (dsKtra != null && dsKtra.Tables[0].Rows.Count > 0)
      //                 {
      //                     Message_Box.ShowWarning("Số điện thoại này đã được sử dụng để đăng ký Fsecure. Bạn hãy nhập SĐT khác!");
      //                     return false;
      //                 }
      //             }
      //         }
      //         catch (Exception)
      //         {
      //         }
      //     }
      // }
      // try
      // {
      //     if (txtSoThangCK.Text != "" && txtSoThangCK.Text != "0")
      //     {
      //         if (!CommonFunction.CheckIsNumber(CommonFunction.Unformat_tien(txtSoThangCK.Text)))
      //         {
      //             Message_Box.ShowWarning("Số tháng cam kết phải là kiểu số!");
      //             txtSoThangCK.Focus();
      //             return false;
      //         }

      //         if (Convert.ToInt32(txtSoThangCK.Text.trim()) < 0 || Convert.ToInt32(txtSoThangCK.Text.trim()) > 36)
      //         {
      //             Message_Box.ShowWarning("Số tháng cam kết phải >=0 và <=36!");
      //             txtSoThangCK.Focus();
      //             return false;
      //         }
      //     }
      // }
      // catch (Exception)
      // {
      //     return false;
      // }

      // if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.INTERNET_MYTV)
      // {
      //     if (m_dsThueBao_DichVu != null && m_dsThueBao_DichVu.Tables.Count > 0
      //         && m_dsThueBao_DichVu.Tables[0].Rows.Count > 0)
      //     {
      //         IEnumerable<DataRow> _q = from DataRow _r in m_dsThueBao_DichVu.Tables[0].Rows
      //                                   where _r["DANGKY"].ToString() == "1" && _r["MA_DVGT"].ToString() == "PAYTV"
      //                                   select _r;
      //         if (_q.Count() > 0)
      //         {
      //             int _a;

      //             if ((vgoicuocasdl != 45 && vgoicuocasdl != 46)
      //                 || !int.TryParse(_q.First()["NOIDUNG"].ToString(), out _a) || _a < 3)
      //             {
      //                 Message_Box.ShowWarning("Dịch vụ PAYTV trọn gói 20.000 đăng ý chưa hợp lệ");
      //                 return false;
      //             }
      //         }
      //     }
      // }
      // Bo do ban cheo khong can check cai nay 2023-04-25 THANGDM1
      // if(!this.thuebao.khuvuc || !this.thuebao.khuvuc_id)
      // {
      //   this.$toast.error(`Chưa có mã khu vực thuê bao. Vui lòng chọn khu vực!`);
      //   return false;
      // }
      // //if (nhap_nvkd == 1)
      // //{
      // //    if (khuvuc_id == 0 || txtKhuVuc.Text == "")
      // //    {
      // //        Message_Box.ShowTB("Bạn chưa chọn khu vực quản lý địa bàn cho thuê bao!");
      // //        return false;
      // //    }
      // //}
      // //bắt buộc trọn trả trước khi thực hiện lắp mới hyn - mail
      // if (_dk_tratruoc == 1 && tt_nd.nguoidung_id != _nguoidung_boqua_tratruoc)
      // {
      //     //thực hiện bổ sung đối tượng loại trừ đối với thực hiện trả trước trong đặt mới
      //     int _nhomDT = Convert.ToInt32(objCheckData.MAP_ID("NHOMDT_ID", DatabaseConstants.DB2 + ".doituong", "where doituong_id =" + cboDoituongTB.EditValue.ToString()));
      //     if (_nhomDT == 200) //la nhom doi tuong loai tru
      //         if (Convert.ToInt32(cboDichVuVT.SelectedValue) == DichVuVienThong.ADSL && Convert.ToInt32(cboLoaihinhTB.SelectedValue) != LoaiHinhTB.INTERNET_MYTV && !chkTraTruoc.Checked)
      //         {
      //             Message_Box.ShowTB("Bạn phải thực hiện đăng ký trả trước cho thuê bao!");
      //             chkTraTruoc.Focus();
      //             return false;
      //         }
      // }

      // return true;
      return true
    },

    async LAY_DS_TBI_MACDINH() {
      //TODO chua lam
      // let ds = tchopdong.LAY_DS_TBI_MACDINH(loaitb_id);
      // this.dsCTM_TBI = [];
      // for (var i = 0; i < ds.length; i++)
      // {
      //     let row = {};
      //     row.LOAITBI_ID = Convert.ToInt32(ds.Tables[0].Rows[i]["LOAITBI_ID"]);
      //     row.HDTB_ID = hdtb_id;
      //     row.SOLUONG = 1;
      //     //Hiếu bổ sung thêm tiền, vat, tien_km, vat_km ngày  17/09/2010
      //     row.TIEN = Convert.ToDecimal(ds.Tables[0].Rows[i]["tien"]);
      //     row.VAT = Convert.ToDecimal(ds.Tables[0].Rows[i]["vat"]);
      //     row.TIEN_KM = Convert.ToDecimal(ds.Tables[0].Rows[i]["tien_km"]);
      //     row.VAT_KM = Convert.ToDecimal(ds.Tables[0].Rows[i]["vat_km"]);
      //     row.TIEN_THUE = 0;
      //     row.TONG_THUE = 0;
      //     row.TONG_TIEN = 0;
      //     //
      //     this.dsCTM_TBI.push(row);
      // }
      this.HT_ThietBi()
    },
    async KIEM_TRA_DK(doituong_id, loaihinh, thang, hdtb_id) {
      //TODO chua lam
      // try
      // {
      //     var kq = tdan.GET_VALUE_FUNC("{?DB2}.kiemtra_km_dt", "vloaihinh_id", loaihinh, "vthang", thang, "vdoituong", doituong_id, "vhdtb_id", hdtb_id);
      //     if (kq == null || kq == DBNull.Value)
      //         return "Không lấy được thông tin trả ra của hàm kiểm tra điều kiện";
      //     else
      //         return kq.ToString();
      // }
      // catch (Exception ex)
      // {
      //     return "Có lỗi khi kiểm tra điều kiện " + ex;
      // }
    },

    async KiemTraMST() {
      if (this.khachhang.masothue && this.khachhang.masothue.trim() != '') {
        if (this.thamsomacdinh['CHAN_TRUNG_SGT'] && this.thamsomacdinh['CHAN_TRUNG_SGT'] == 1) {
          let checkMST = await API.post_kiemtra_khachhang_theo_mst(this.axios, {
            vmasothue: this.khachhang.masothue,
            vhdkh_id: this.khachhang.hdkh_id,
            vloaihd_id: LoaiHopDong.DAT_MOI,
            vma_kh: this.khachhang.makh
          }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return ''
          })
          if (checkMST && checkMST != 1) {
            this.$toast.error(checkMST)
            this.khachhang.masothue = ''
            return
          }
        }
        this.Laythongtin_kh_tiemnang(this.khachhang.masothue);
      }
    },
    async KiemTraSoGT() {
      if (this.khachhang.sogt && this.khachhang.sogt.trim() != '') {
        // CUONGNM thêm .:\-\/   theo yêu cầu https://cntt.vnpt.vn/browse/IT360-223618
        if (!/^[a-zA-Z0-9.:\-\/]*$/.test(this.khachhang.sogt)) {
          //&& !Char.IsControl(e.KeyChar))
          this.$toast.error('Số giấy tờ không hợp lệ.Số giấy tờ gồm các ký tự từ 0->9a->z . : - /. Hãy kiểm tra lại')
          return
        }
        var ds_maKH = await API.post_lay_ds_makh_theo_sogt(this.axios, {
          hdkh_id: this.khachhang.hdkh_id,
          so_gt: this.khachhang.sogt,
          vhdkh_id: this.khachhang.hdkh_id,
          vloaihd_id: LoaiHopDong.DAT_MOI,
          vso_gt: this.khachhang.sogt
        })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          .catch(() => {
            return []
          }) //tcdanhba.LAY_DS_MAKH_THEO_SOGT(txtSoGT.Text, hdkh_id, LoaiHopDong.DAT_MOI);

        if (ds_maKH && ds_maKH.length == 1) {
          if (this.khachhang.makh != ds_maKH[0]['ma_kh']) {
            if (this.thamsomacdinh['CHAN_TRUNG_SGT'] && this.thamsomacdinh['CHAN_TRUNG_SGT'] == 1) {
              this.$toast.error(`Số giấy tờ ${this.khachhang.sogt} đang được sử dụng bởi các mã khách hàng: ${ds_maKH[0]['ma_kh']} (${ds_maKH[0]['ma_gd']})`)
              this.khachhang.sogt = ''
              return false
            }
            var kq = await this.$bvModal
            .msgBoxConfirm(`Số giấy tờ ${this.khachhang.sogt} đang được sử dụng bởi các mã khách hàng: ${ds_maKH[0]['ma_kh']} (${ds_maKH[0]['ma_gd']})\nBạn có muốn sử dụng thông tin khách hàng cũ không?`, {
                title: 'Thông báo',
                size: 'sm',
                okTitle: 'Đồng ý',
                cancelTitle: 'Không đồng ý'
              })
              .then(async (v) => {
                return v ? 'Y' : 'N'
              })

            if (kq == 'Y') {
              //Lấy thông tin cũ của khách hàng khi chưa lập hợp đồng - Hieutc 21.10.2010
              if (this.khachhang.hdkh_id == 0) {
                this.khachhang.makh = ds_maKH[0]['ma_kh']
                //FIXME tham so goc dang la: this.thanhtoan.matt , code cu lai la makh
                API.post_lay_db_theo_matb(this.axios, { ma_tb: this.khachhang.makh, donvi_dl_id: 0, dichvuvt_id: 0 }).then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    //this.listbox.danhba.list=response.data.data;
                    this.HienThiTT_DanhBa(response.data.data)
                  }
                }) //this.HienThiTT_DanhBa(tcdanhba.LAY_DB_THEO_MATB(txtMaKH.Text, 0, 0));
              } else {
                this.$toast.error('Hợp đồng/phụ lục đã được lập, bạn không được sử dụng số giấy tờ của khách hàng khác!')
                //return;
              }
            } else {
            }
          } //this.HienThiTT_DanhBa(tcdanhba.LAY_DB_THEO_MATB(txtMaKH.Text, 0, 0));
          // } else {
          //   this.$toast.error('Hợp đồng/phụ lục đã được lập, bạn không được sử dụng số giấy tờ của khách hàng khác!')
          //   //return;
          // }
          // } else {
          // }
        } else if (ds_maKH.length > 1) {
          // if (this.thamsomacdinh['CHAN_TRUNG_SGT'] && this.thamsomacdinh['CHAN_TRUNG_SGT'] == 1) {
          //   this.$toast.error('Số giấy tờ ' + this.khachhang.sogt + ' đang được sử dụng bởi các mã khách hàng')
          //   this.khachhang.sogt = ''
          //   return false
          // }
          let str = []
          for (var i = 0; i < ds_maKH.length; i++) {
            str.push(`${ds_maKH[i]['ma_kh']} (${ds_maKH[i]['ma_gd']})`)
          }
          if (this.thamsomacdinh['CHAN_TRUNG_SGT'] && this.thamsomacdinh['CHAN_TRUNG_SGT'] == 1) {
            this.$toast.error('Số giấy tờ ' + this.khachhang.sogt + ' đang được sử dụng bởi các mã khách hàng: ' + str.join(',') + '.')
            this.khachhang.sogt = ''
            return false
          }
          else this.$toast.error('Số giấy tờ ' + this.khachhang.sogt + ' đang được sử dụng bởi các mã khách hàng: ' + str.join(',') + '.') // Đề nghị bạn ký lại hợp đồng gốc trước khi lập phụ lục.

          // if(this.thamsomacdinh['CHAN_TRUNG_SGT'] && this.thamsomacdinh['CHAN_TRUNG_SGT']==1) return false;
        }
        // this.$toast.error('Số giấy tờ ' + this.khachhang.sogt + ' đang được sử dụng bởi các mã khách hàng: ' + str.substring(0, str.length - 1) + '.') // Đề nghị bạn ký lại hợp đồng gốc trước khi lập phụ lục.
        //return;
        // }
      }
    },
    async tsbtnThanhToan_Click() {
      try {
        if (!this.khachhang.hdkh_id || this.khachhang.hdkh_id == 0) {
          this.$toast.error('Hãy ghi lại hợp đồng trước khi thanh toán!')
          return
        }
        var code = await API.kiemtra_thanhtoan_lh(this.axios, { vhdkh_id: this.khachhang.hdkh_id })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return 1
          })
          .catch(() => {
            return 1
          })
        if (code == '0') {
          this.$toast.error('Hợp đồng chưa có thông tin liên hệ, bạn phải bổ sung thông tin liên hệ trước khi thanh toán !')
          return
        } else if (code != '1' && code != '0') {
          this.$toast.error('Phải chọn mục đích sử dụng là Liên Hệ cho tất cả các thuê bao. (' + code + ')')
          return
        }
        if (
          await API.post_fn_kiemtra_truoc_thanhtoan(this.axios, { ds_para: JSON.stringify({ HDKH_ID: this.khachhang.hdkh_id, TS_HEN_LD: this.thamsomacdinh['TS_HEN_LD'] == 1 ? 1 : 0 }) })
            .then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                var api = JSON.parse(response.data.data)
                if (api['ERROR_CODE'] == 1) return false
                this.$toast.error(api['MESSAGE'])
                return true
              } else return false
            })
            .catch(() => {
              return false
            })
        )
          return
        this.ChuyenTrang('Payment', { magd: this.khachhang.magd })
      } catch (ex) {
        this.$toast.error('' + ex)
      }
    },
    async HT_PhanLoaiMGWAN() {
      var dt = await API.post_get_phanloai_dv(this.axios, { loaitb_id: 134 })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return []
        })
        .catch(() => {
          return []
        }) //bancheo.GET_DATA_SQL("select phanloai_id, phanloai from {?DB2}.phanloai_dv where loaitb_id = 134");

      // await Promise.all([dt,]).then((data)=>{
      //   dt = data;
      // });
      return dt
      // this.listbox.phanloai_dv.list = dt;
      // if (this.listbox.phanloai_dv.list.length > 0)
      //     this.listbox.phanloai_dv.value = this.listbox.phanloai_dv.list[0]["phanloai_id"];
    },
    Disable_Thongso() {
      //TODO Xem sau!
      // // thong so chung
      // cboMucCuocTB.Enabled = false;
      // cboDoituongTB.Enabled = false;
      // cboCongNghe.Enabled = false;
      // //thong so co dinh
      // cboChuQuan_CD.Enabled = false;
      // cboTrangBiCD.Enabled = false;
      // //thong so adsl
      // cboTocDo.Enabled = false;
      // cboMucCuoc.Enabled = false;
      // cboTocDoThucADSL.Enabled = false;
      // cboChuQuan_ADSL.Enabled = false;
      // cboTrangBiADSL.Enabled = false;
      // cboLoaiTB.Enabled = true;
    },
    async acceptThongSoCoDinh(data) {
      Object.assign(this.thongso_ban, data.thongso_ban)
      Object.assign(this.thongso_tc, data.thongso_tc)
      this.listbox.doituong.value = this.thongso_ban.doituong_id
      this.listbox.trangbi.valuecd = this.thongso_ban.trangbi_id
      this.listbox.muccuoc_tb.value = this.thongso_ban.muccuoctb_id

      if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) {
        this.listbox.chu_quan.valuecd = this.thongso_ban.chuquan_id
        this.listbox.chu_quan.valueldcd = this.thongso_ban.chuquanld_id

        this.listbox.trangbi.valuecd = this.thongso_ban.trangbi_id
      }
      if (this.listbox.dichvu_vt.value == DichVuVienThong.IMS) {
        this.listbox.chu_quan.valueims = this.thongso_ban.chuquan_id
        this.listbox.chu_quan.valueldims = this.thongso_ban.chuquanld_id

        this.listbox.trangbi.valueims = this.thongso_ban.trangbi_id
      }
      if (this.thongso_tc.ma_tn) {
        if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) this.thuebaocd.matn = this.thongso_tc.ma_tn
        else this.thuebao.ims.txtMaTN_IMS = this.thongso_tc.ma_tn
      }
      var kieu = await API.post_fn_tt_kieu_ld(this.axios, { tinhthicong_id: this.tinh.tinhthicong_id, param: this.thongso_tc.kieuld_id })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return 0
        })
        .catch(() => {
          return 0
        })

      this.HT_GIAODIEN_DONVI()
    },
    acceptTocDoMucCuocADSL(data) {
      console.log('acceptTocDoMucCuocADSL', data)
      //TODO chua xu ly lien quan enable disable form
      // cboTocDoThucADSL.Enabled = false;
      // cboTrangBiADSL.Enabled = false;
      // cboMucCuoc.Enabled = false;
      // cboKieuTra.Enabled = false;
      // cboDoituongTB.Enabled = false;
      // cboCongNghe.Enabled = false;
      // cboMucCuocTB.Enabled = false;
      // cboTocDo.Enabled = false;
      this.LoadMucCuocTB()
      this.listbox.cboGoiCuocAdsl.value = data.thongso_ban.tocdo_id
      this.listbox.cboTocDoThucADSL.value = data.thongso_ban.tocdothuc_id
      this.listbox.trangbi.valueadsl = data.thongso_ban.trangbi_id
      this.listbox.muccuoc.value = data.thongso_ban.muccuoc_id //cboMucCuoc.SelectedValue = frm.thongso_ban.muccuoc_id;
      this.muccuoc_id = data.thongso_ban.muccuoc_id //int.Parse(frm.thongso_ban.muccuoc_id.ToString());
      this.listbox.cboKieuTra.value = data.thongso_ban.kieutra_id
      this.listbox.doituong.value = data.thongso_ban.doituong_id
      this.listbox.congnghe.value = data.thongso_ban.congnghe_id
      this.listbox.muccuoc_tb.value = data.thongso_ban.muccuoctb_id
      this.listbox.cboLoaiTB.value = data.thongso_ban.thietbidc_id

      this.listbox.chu_quan.valueadsl = data.thongso_ban.chuquan_id
      this.listbox.chu_quan.valueldadsl = data.thongso_ban.chuquanld_id

      Object.assign(this.thongso_ban, data.thongso_ban)
      Object.assign(this.thongso_tc, data.thongso_tc)

      if (this.thongso_tc.ma_tn) this.thuebao.adsl.txtMaTN_ADSL = this.thongso_tc.ma_tn

      this.HT_GIAODIEN_DONVI()
      // thongso_ban = data.thongso_ban;
      // thongso_tc = data.thongso_tc;
    },
    closeHienThiChonThongSo(data) {
      console.log('closeHienThiChonThongSo', JSON.stringify(data))
      Object.assign(this.thongso_ban, data.ThongsoBan)
      Object.assign(this.thongso_tc, data.ThongsoTc)
      if (this.thongso_ban.tocdo_id > 0) this.listbox.tocdokenh.valuecir = this.thongso_ban.tocdo_id //cboTocDo.SelectedValue = thongso_ban.tocdo_id;

      if (this.thongso_ban.tocdo_pir_id > 0) {
        this.listbox.tocdokenh.ischeckedpir = true
        this.listbox.tocdokenh.valuepir = this.thongso_ban.tocdo_pir_id
      }

      if (this.thongso_ban.tocdo_nix > 0) {
        this.listbox.tocdokenh.ischeckednix = true
        this.listbox.tocdokenh.valuenix = this.thongso_ban.tocdo_nix
      }

      if (this.thongso_ban.tocdo_isp > 0) {
        this.listbox.tocdokenh.ischeckedisp = true
        this.listbox.tocdokenh.valueisp = this.thongso_ban.tocdo_isp
      }
      if (this.thongso_ban.chuquan_id > 0) this.listbox.chu_quan.valuewan = this.thongso_ban.chuquan_id
      if (this.thongso_ban.loaikenh_id > 0) this.listbox.loaikenh.value = this.thongso_ban.loaikenh_id
      if (this.thongso_ban.loaimd_id > 0) this.listbox.loaimodem.value = this.thongso_ban.loaimd_id
      if (this.thongso_ban.thoihan_id > 0) this.listbox.thoihan.valuewan = this.thongso_ban.thoihan_id
      if (this.thongso_ban.thietbidc_id > 0) this.listbox.loai_tb.valuemgwan = this.thongso_ban.thietbidc_id
      if (this.thongso_ban.trangbi_id > 0) this.listbox.trangbi.valuewan = this.thongso_ban.trangbi_id
      if (this.thongso_ban.doituong_id > 0) this.listbox.doituong.value = this.thongso_ban.doituong_id

      this.listbox.chu_quan.valuewan = this.thongso_ban.chuquan_id
      this.listbox.chu_quan.valueldmgwan = this.thongso_ban.chuquanld_id
      this.listbox.phanloai_dv.value = this.thongso_ban.phanloai_id
      this.listbox.ht_phantach_tocdo.value = this.thongso_ban.phantach_id
      this.thuebao.mgwan.lanip = this.thongso_ban.lan_ip
      this.thuebao.mgwan.wanip = this.thongso_ban.wan_ip
      this.thuebao.mgwan.soluongip = this.thongso_ban.sl_ip ? this.thongso_ban.sl_ip : 0

      if (this.thongso_tc.ma_tn) this.thuebao.mgwan.matn = this.thongso_tc.ma_tn

      this.HT_GIAODIEN_DONVI()
    },
    async btnDiemDau_Click() {
      if (!this.thuebao.tsl.cboTinhDau.value || this.thuebao.tsl.cboTinhDau.value == 0) {
        this.$toast.error('Bạn hãy chọn tỉnh lắp đặt!')
        return
      }
      if (!this.thuebao.tsl.tinh_dau) this.thuebao.tsl.tinh_dau = {}
      if (!this.thuebao.tsl.tinh_dau.tinhthicong_id || this.thuebao.tsl.tinh_dau.tinhthicong_id == 0) this.thuebao.tsl.tinh_dau.tinhthicong_id = this.thuebao.tsl.cboTinhDau.value
      let i_loaitb_id = this.listbox.loaihinh_tb.value //Number(this.$refs.v2_ThongTinPhieuYeuCau.model.v2_loai_hinh)
      if (this.thuebao.tsl.tinh_dau.tinhthicong_id != 98) this.$refs.frmThongSoTSLDau.openDialog(this.thuebao.tsl.tinh_dau, i_loaitb_id, i_loaitb_id, this.listbox.kieu_ld.value, this.thongso_ban, this.thuebao.tsl.thongso_tc_dau, 1, false)
      else {
          let tinh=await bancheo.tinh_thicong(this.$root.token.getPhanVungID())
          this.$refs.frmThongSoTSLDau.openDialog(tinh, i_loaitb_id, i_loaitb_id, this.listbox.kieu_ld.value, this.thongso_ban, this.thuebao.tsl.thongso_tc_dau, 1, false)
      }
    },
    frmThongSoTSLDau_onChapNhan(frm) {
      console.log('frmThongSoTSLDau_onChapNhan', frm)
      this.thongso_ban = frm.thongso_Ban
      this.thuebao.tsl.thongso_tc_dau = frm.thongso_TC
      this.listbox.doituong.value = this.thongso_ban.doituong_id
      this.listbox.trangbi.valuecd = this.thongso_ban.trangbi_id
      this.listbox.tocdokenh.valuetsl = this.thongso_ban.tocdo_id
      this.listbox.muccuoc_tb.value = this.thongso_ban.muccuoctb_id
      this.listbox.loaikenh.valuetsl = this.thongso_ban.loaikenh_id
      this.listbox.loai_tb.valuedau = this.thongso_ban.thietbidc_id
      this.listbox.loai_tb.valuecuoi = this.thongso_ban.thietbidc_id_cuoi
      this.thuebao.tsl.cboChuQuanLD_Dau.value = this.thongso_ban.chuquanld_id
      this.listbox.chu_quan.valuetsl = this.thongso_ban.chuquan_id
      this.HT_GIAODIEN_DONVI();
      // this.$refs.v3_ThongTinThueBao.model.v3_toc_do_moi = this.thongso_ban.tocdo_id
    },
    async btnDiemCuoi_Click() {
      if (!this.thuebao.tsl.cboTinhCuoi.value || this.thuebao.tsl.cboTinhCuoi.value == 0) {
        this.$toast.error('Bạn hãy chọn tỉnh lắp đặt!')
        return
      }
      if (!this.thuebao.tsl.tinh_cuoi) this.thuebao.tsl.tinh_cuoi = {}
      if (!this.thuebao.tsl.tinh_cuoi.tinhthicong_id || this.thuebao.tsl.tinh_cuoi.tinhthicong_id == 0) this.thuebao.tsl.tinh_cuoi.tinhthicong_id = this.thuebao.tsl.cboTinhCuoi.value
      let i_loaitb_id = this.listbox.loaihinh_tb.value //Number(this.$refs.v2_ThongTinPhieuYeuCau.model.v2_loai_hinh)
      if (this.thuebao.tsl.tinh_dau.tinhthicong_id != 98) this.$refs.frmThongSoTSLCuoi.openDialog(this.thuebao.tsl.tinh_cuoi, i_loaitb_id, i_loaitb_id, this.listbox.kieu_ld.value, this.thongso_ban, this.thuebao.tsl.thongso_tc_cuoi, 1, false)
      else this.$refs.frmThongSoTSLCuoi.openDialog(await bancheo.tinh_thicong(this.$root.token.getPhanVungID()), i_loaitb_id, i_loaitb_id, this.listbox.kieu_ld.value, this.thongso_ban, this.thuebao.tsl.thongso_tc_cuoi, 1, false)
    },
    frmThongSoTSLCuoi_onChapNhan(frm) {
      this.thongso_ban = frm.thongso_Ban
      this.thuebao.tsl.thongso_tc_cuoi=frm.thongso_TC
      //this.thongso_tc_cuoi = frm.thongso_TC
      this.listbox.doituong.value = this.thongso_ban.doituong_id
      this.listbox.trangbi.valuecd = this.thongso_ban.trangbi_id
      this.listbox.tocdokenh.valuetsl = this.thongso_ban.tocdo_id
      this.listbox.muccuoc_tb.value = this.thongso_ban.muccuoctb_id
      this.listbox.loaikenh.valuetsl = this.thongso_ban.loaikenh_id
      this.listbox.loai_tb.valuedau = this.thongso_ban.thietbidc_id
      this.listbox.loai_tb.valuecuoi = this.thongso_ban.thietbidc_id_cuoi
      this.thuebao.tsl.cboChuQuanLD_Cuoi.value = this.thongso_ban.chuquanld_id
      this.listbox.chu_quan.valuetsl = this.thongso_ban.chuquan_id
      this.HT_GIAODIEN_DONVI();
      // this.$refs.v3_ThongTinThueBao.model.v3_toc_do_moi = this.thongso_ban.tocdo_id
    },
    closefrmThongSoTSL(data) {
      //TODO chua lam
    },
    PopupThongSo() {
      var loaitb_id = this.listbox.loaihinh_tb.value
      var dichvu_vt = this.listbox.dichvu_vt.value
      if (this.ckieu_ld.length <= 0) {
        return
      }
      if ((dichvu_vt == DichVuVienThong.CO_DINH || dichvu_vt == DichVuVienThong.IMS) && this.Click_kieuld) {
        this.Disable_Thongso()
        // frmThongSoCoDinh frm = new frmThongSoCoDinh(tinh, loaitb_id, loaitb_id, 0, 0, 1);
        this.$refs.thongSoCoDinhModal.showModal(this.tinh.tinhthicong_id, loaitb_id, loaitb_id, 0, 0, 1)
        // frm.thongso_Ban = thongso_ban;
        // frm.thongso_TC = thongso_tc;
        // frm.khachhang_id = khachhangtc_id;
        // frm.hdkh_id = hdkh_id;
        // frm.ShowDialog();
      }

      if (dichvu_vt == DichVuVienThong.ADSL && this.Click_kieuld) {
        this.Disable_Thongso()
        this.$refs.tocDoMucCuocADSLModal.showModal(this.tinh.tinhthicong_id, loaitb_id, loaitb_id, 0, 0, 1)
        //frmTocDoMucCuoc frm = new frmTocDoMucCuoc(tinh, Convert.ToInt32(cboLoaihinhTB.SelectedValue), Convert.ToInt32(cboLoaihinhTB.SelectedValue), 0, 0, 1);
        // frm.thongso_ban = thongso_ban;
        // frm.thongso_tc = thongso_tc;
        // frm.khachhang_id = khachhangtc_id;
        // frm.hdkh_id = hdkh_id;
      }
      if ((dichvu_vt == DichVuVienThong.MEGAWAN || dichvu_vt == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) && this.Click_kieuld) {
        this.Disable_Thongso()
        this.$refs.ref_frmThongSoWan.ThongsoBan = this.thongso_ban
        this.$refs.ref_frmThongSoWan.ThongsoTc = this.thongso_tc
        this.$refs.ref_frmThongSoWan.khachhang_id = this.khachhang.khachhangtc_id
        this.$refs.ref_frmThongSoWan.hdkh_id = this.khachhang.hdkh_id
        this.$refs.ref_frmThongSoWan.openDialog1(this.tinh, loaitb_id, loaitb_id, LoaiHopDong.DAT_MOI, dichvu_vt, this.thongso_ban, this.thongso_tc)
        // frmThongSoWan frm = new frmThongSoWan(tinh, loaitb_id, loaitb_id, LoaiHopDong.DAT_MOI, dichvu_vt);
        // frm.ThongsoBan = thongso_ban;
        // frm.ThongsoTc = thongso_tc;
        // frm.khachhang_id = khachhangtc_id;
        // frm.hdkh_id = hdkh_id;
      }

      if ((dichvu_vt == DichVuVienThong.ANTOAN_BAOMAT_TT ||
            dichvu_vt == DichVuVienThong.DICHVU_CNTT ||
            dichvu_vt == DichVuVienThong.TRUNGTAM_DULIEU ||
            dichvu_vt == DichVuVienThong.HOINGHI_TRUYENHINH) && this.Click_kieuld)
      {
          this.Disable_Thongso();
          var frm = {}; //new frmThongSoCNTT();
          frm.tinh = this.tinh;
          frm.dt_ban = this.dt_ban_cntt;
          frm.dt_thicong = this.dt_tc_cntt;
          frm.vloaitb_id = loaitb_id;
          // frm.ma_tb = ma_tb; // Khong can truyen cung duoc, o form kia chi gan chu khong lay gia tri truyen de xu ly
          frm.thongsotc = this.thongso_tc;
          this.thongso_ban.thongso_cntt = this.ItemList; // Bo sung de dong bo voi du lieu hien tai o day!
          frm.thongsoban = this.thongso_ban;
          frm.dvvt = this.listbox.dichvu_vt.value;
          frm.khachhang = this.khachhang;
          this.popupComponent = () => import('./Popups/frmThongSoCNTT/frmThongSoCNTT')
          this.popupComponentName = 'popupThongSoCNTT'
          this.popupComponentAttr = frm
          this.Popup('popupComponents')
          // frm.ShowDialog();
      }
      //     if (frm.capnhat)
      //     {
      //         thongso_ban = frm.thongsoban;
      //         thongso_tc = frm.thongsotc;
      //         ma_tb = frm.ma_tb;
      //         #region Hiển thị thông tin ra
      //         this.grcMacdinh.DataSource = (object)null;

      //         ItemList = thongso_ban.thongso_cntt;

      //         this.gridEditors = new GridEditorCollection();

      //         for (int index1 = 0; index1 < ItemList.Length; ++index1)
      //         {
      //             //if (ItemList[index1].sFieldName == "MA_TB")
      //             //    ItemList[index1].sValue = ma_tb;
      //             //else
      //             //    ItemList[index1].sValue = ds.Tables[0].Rows[0][ItemList[index1].sFieldName].ToString();

      //             if (ItemList[index1].iAtt == 0)
      //             {
      //                 RepositoryItemTextEdit repositoryItemTextEdit = new RepositoryItemTextEdit();
      //                 repositoryItemTextEdit.Tag = ItemList[index1].sFieldName;
      //                 repositoryItemTextEdit.EditValueChanged += new System.EventHandler(this.repositoryItemTextEdit_EditValueChanged);
      //                 //    repositoryItemTextEdit.Leave += new System.EventHandler(this.repositoryItemTextEdit_Leave);
      //                 this.gridEditors.Add((RepositoryItem)repositoryItemTextEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
      //             }
      //             if (ItemList[index1].iAtt == 1)
      //             {
      //                 repositoryItemCalcEdit.Tag = ItemList[index1].sFieldName;
      //                 this.gridEditors.Add((RepositoryItem)this.repositoryItemCalcEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
      //             }
      //             if (ItemList[index1].iAtt == 2)
      //             {
      //                 RepositoryItemDateEdit repositoryItemDateEdit = new RepositoryItemDateEdit();
      //                 repositoryItemDateEdit.Tag = ItemList[index1].sFieldName;
      //                 repositoryItemDateEdit.DisplayFormat.FormatString = "dd/MM/yyyy";
      //                 repositoryItemDateEdit.EditFormat.FormatString = "dd/MM/yyyy";
      //                 repositoryItemDateEdit.EditMask = "dd/MM/yyyy";
      //                 repositoryItemDateEdit.Mask.UseMaskAsDisplayFormat = true;
      //                 // repositoryItemDateEdit.EditValueChanged += new System.EventHandler(this.repositoryItemDateEdit_EditValueChanged);
      //                 this.gridEditors.Add((RepositoryItem)repositoryItemDateEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
      //             }

      //             if (ItemList[index1].iAtt == 9)
      //             {
      //                 RepositoryItemDateEdit repositoryItemDateEdit = new RepositoryItemDateEdit();
      //                 repositoryItemDateEdit.Tag = ItemList[index1].sFieldName;
      //                 repositoryItemDateEdit.DisplayFormat.FormatString = "dd/MM/yyyy HH:mm:ss";
      //                 repositoryItemDateEdit.EditFormat.FormatString = "dd/MM/yyyy HH:mm:ss";
      //                 repositoryItemDateEdit.EditMask = "dd/MM/yyyy HH:mm:ss";
      //                 repositoryItemDateEdit.Mask.UseMaskAsDisplayFormat = true;
      //                 // repositoryItemDateEdit.EditValueChanged += new System.EventHandler(this.repositoryItemDateEdit_EditValueChanged);
      //                 this.gridEditors.Add((RepositoryItem)repositoryItemDateEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
      //             }
      //             //duong them
      //             if (ItemList[index1].iAtt == 10)
      //             {
      //                 InitialItemCheckedRepository();

      //                 string SQL_CheckListBox = ItemList[index1].StrSql;
      //                 DataTable data = bancheo.GET_DATA_SQL(SQL_CheckListBox);

      //                 repositoryItemCheckedComboBoxEdit1.ValueMember = ItemList[index1].sLookUpKeyField;
      //                 repositoryItemCheckedComboBoxEdit1.DisplayMember = ItemList[index1].sLookUpValueField;
      //                 repositoryItemCheckedComboBoxEdit1.DataSource = (object)data;

      //                 this.gridEditors.Add((RepositoryItem)repositoryItemCheckedComboBoxEdit1, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
      //             }

      //             string str1;
      //             DataSet dataSet;
      //             if (ItemList[index1].iAtt == 4)
      //             {
      //                 RepositoryItemLookUpEdit repositoryItemLookUpEdit = new RepositoryItemLookUpEdit();
      //                 repositoryItemLookUpEdit.Tag = ItemList[index1].sFieldName;
      //                 str1 = "";
      //                 string SQL = ItemList[index1].StrSql;
      //                 if (SQL != "")
      //                 {
      //                     dataSet = new DataSet();
      //                     DataSet data = bancheo.GET_DATA_SQL_DS(SQL);
      //                     repositoryItemLookUpEdit.ValueMember = ItemList[index1].sLookUpKeyField;
      //                     repositoryItemLookUpEdit.DisplayMember = ItemList[index1].sLookUpValueField;
      //                     repositoryItemLookUpEdit.DataSource = (object)data.Tables[0];
      //                     repositoryItemLookUpEdit.ShowHeader = false;
      //                     repositoryItemLookUpEdit.ShowFooter = false;
      //                     repositoryItemLookUpEdit.Columns.Clear();
      //                     repositoryItemLookUpEdit.Columns.Add(new DevExpress.XtraEditors.Controls.LookUpColumnInfo(ItemList[index1].sLookUpKeyField, "", 0, DevExpress.Utils.FormatType.None, "", false, DevExpress.Utils.HorzAlignment.Default));
      //                     repositoryItemLookUpEdit.Columns.Add(new DevExpress.XtraEditors.Controls.LookUpColumnInfo(ItemList[index1].sLookUpValueField, "", 100, DevExpress.Utils.FormatType.None, "", true, DevExpress.Utils.HorzAlignment.Default));

      //                     repositoryItemLookUpEdit.AutoSearchColumnIndex = 1;
      //                     repositoryItemLookUpEdit.NullText = "";
      //                 }
      //                 else
      //                 {
      //                     SQL = ReturnSqlStr(ItemList, index1);
      //                     dataSet = new DataSet();
      //                     DataSet data = bancheo.GET_DATA_SQL_DS(SQL);
      //                     repositoryItemLookUpEdit.ValueMember = ItemList[index1].sLookUpKeyField;
      //                     repositoryItemLookUpEdit.DisplayMember = ItemList[index1].sLookUpValueField;
      //                     repositoryItemLookUpEdit.DataSource = (object)data.Tables[0];
      //                     repositoryItemLookUpEdit.ShowHeader = false;
      //                     repositoryItemLookUpEdit.ShowFooter = false;
      //                     repositoryItemLookUpEdit.Columns.Clear();
      //                     repositoryItemLookUpEdit.Columns.Add(new DevExpress.XtraEditors.Controls.LookUpColumnInfo(ItemList[index1].sLookUpKeyField, "", 0, DevExpress.Utils.FormatType.None, "", false, DevExpress.Utils.HorzAlignment.Default));
      //                     repositoryItemLookUpEdit.Columns.Add(new DevExpress.XtraEditors.Controls.LookUpColumnInfo(ItemList[index1].sLookUpValueField, "", 100, DevExpress.Utils.FormatType.None, "", true, DevExpress.Utils.HorzAlignment.Default));
      //                     repositoryItemLookUpEdit.AutoSearchColumnIndex = 1;
      //                     repositoryItemLookUpEdit.NullText = "";
      //                 }
      //                 repositoryItemLookUpEdit.EditValueChanged += new System.EventHandler(this.repositoryItemLookUpEdit_EditValueChanged);
      //                 this.gridEditors.Add((RepositoryItem)repositoryItemLookUpEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
      //             }
      //             if (ItemList[index1].iAtt == 5) //Button Edit
      //             {
      //                 RepositoryItemButtonEdit repositoryItemButtonEdit = new RepositoryItemButtonEdit();
      //                 repositoryItemButtonEdit.Tag = ItemList[index1].sFieldName;
      //                 repositoryItemButtonEdit.ButtonClick -= new DevExpress.XtraEditors.Controls.ButtonPressedEventHandler(this.repositoryItemButtonEdit_ButtonClick);
      //                 repositoryItemButtonEdit.ButtonClick += new DevExpress.XtraEditors.Controls.ButtonPressedEventHandler(this.repositoryItemButtonEdit_ButtonClick);
      //                 this.gridEditors.Add((RepositoryItem)repositoryItemButtonEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
      //             }
      //             if (ItemList[index1].iAtt == 7)
      //             {
      //                 repositoryItemCheckEdit.Tag = ItemList[index1].sFieldName;
      //                 this.repositoryItemCheckEdit.ValueChecked = (object)"1";
      //                 this.repositoryItemCheckEdit.ValueUnchecked = (object)"0";
      //                 this.gridEditors.Add((RepositoryItem)this.repositoryItemCheckEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
      //             }
      //         }
      //         for (int index = 0; index < gridEditors.Count; ++index)
      //         {
      //             if (gridEditors[index].ID == "MA_TB")
      //             {
      //             }
      //             else
      //             {
      //                 if (gridEditors[index].ID == "TOCDO_ID")
      //                 {
      //                     cboGoiCuocAdsl.EditValue = ItemList[index].sValue;
      //                 }

      //                 if (ItemList[index].sValue is DateTime
      //                     || ItemList[index].sValue is DBNull)
      //                     this.gridEditors[index].Value = ItemList[index].sValue;
      //                 else
      //                     this.gridEditors[index].Value = ItemList[index].sValue.ToString();

      //                 ItemList[index].sValue = ItemList[index].sValue.ToString();
      //             }
      //         }
      //         this.grcMacdinh.DataSource = (object)this.gridEditors;
      //         this.grvMacdinh.BestFitColumns();
      //         // #endregion
      //     }

      // }
      // #endregion
    },
    btnOpenfrmDangKyGoiDaDVLM() {
      this.$refs.frmDangKyGoiDaDVLM.showDialog(this.khachhang.magd)
    },

    tsbtnEmail_Click() {
      if (this.khachhang.hdkh_id != 0) {
        this.$bvModal.show('ThongTinEmail')
      }
    },
    btnHenLD_Click() {
      this.popup.thongTinHenKhachHangModal = true
      this.$refs.thongTinHenKhachHangModal.showModal()
    },
    btnUser_Click() {
      if (!this.khachhang.hdkh_id) {
        this.$toast.error('Chưa có thông tin khách hàng!')
        return
      }
      this.popup.ThongTinUser = true
      this.$refs['ThongTinUser'].showModal = true
    },

    ThuebaoToaNha_OnClick() {
      this.popup.Thuebao_ToaNha = true
      this.isShowThueBaoToaNha = true
      this.$refs.Thuebao_ToaNha.show()
    },

    ThuebaoToaNha_OnClose() {
      this.isShowThueBaoToaNha = false
      // this.popup.Thuebao_ToaNha = false;
      // call api using axios vuejs
    },
    ResetThueBao() {
      let olddata = {}
      Object.assign(olddata, this.$options.data.call(this))

      this.thongso_ban = newThongSoThueBao()
      this.thongso_tc = newThongSoThueBao()
      this.thuebao.codinh.somay = olddata.thuebao.codinh.somay
      this.thuebaocd.matn = olddata.thuebaocd.matn
      this.thuebao.codinh.sochinh = olddata.thuebao.codinh.sochinh
      this.thuebaocd.cuocdoitac = olddata.thuebaocd.cuocdoitac
      this.thuebao.didong.txtSoMayDD = olddata.thuebao.didong.txtSoMayDD
      this.thuebao.didong.txtSimDD = olddata.thuebao.didong.txtSimDD
      this.thuebao.didong.txtSoMayNTK = olddata.thuebao.didong.txtSoMayNTK
      this.thuebao.didong.txtTienDuTK = olddata.thuebao.didong.txtTienDuTK
      this.thuebao.gphone.txtSoMayGP = olddata.thuebao.gphone.txtSoMayGP
      this.thuebao.gphone.txtSoSimGphone = olddata.thuebao.gphone.txtSoSimGphone
      this.thuebao.adsl.txtAccountADSL = olddata.thuebao.adsl.txtAccountADSL
      this.thuebao.adsl.txtSoAoAdsl = olddata.thuebao.adsl.txtSoAoAdsl
      this.thuebao.adsl.txtMaTN_ADSL = olddata.thuebao.adsl.txtMaTN_ADSL
      this.listbox.cboGoiCuocAdsl.value = 0
      this.thuebao.adsl.txtCuocDT_Internet = olddata.thuebao.adsl.txtCuocDT_Internet
      this.thuebao.adsl.txtEmailAdsl = olddata.thuebao.adsl.txtEmailAdsl
      this.thuebao.adsl.txtDienThoai_Fsecure = olddata.thuebao.adsl.txtDienThoai_Fsecure
      this.thuebao.adsl.txtSL_Tivi = olddata.thuebao.adsl.txtSL_Tivi
      this.thuebao.adsl.txtCSD_FIBER_TK = olddata.thuebao.adsl.txtCSD_FIBER_TK
      this.thuebao.adsl.txtCTB_FIBER_TK = olddata.thuebao.adsl.txtCTB_FIBER_TK
      this.thuebao.adsl.txtSerialSTB = olddata.thuebao.adsl.txtSerialSTB
      this.thuebao.adsl.tientra = olddata.thuebao.adsl.tientra
      // this.thuebao.adsl.txtMaTB_KN = olddata.thuebao.adsl.txtMaTB_KN
      // this.thuebao.adsl.megaIOT_vrf = olddata.thuebao.adsl.megaIOT_vrf
      // this.thuebao.adsl.megaIOT_LanIP = olddata.thuebao.adsl.megaIOT_LanIP
      // this.thuebao.adsl.megaIOT_WanIP = olddata.thuebao.adsl.megaIOT_WanIP
      // this.thuebao.adsl.megaIOT_HuongKN = olddata.thuebao.adsl.megaIOT_HuongKN
      this.thuebao.ims.txtMaTBIMS = olddata.thuebao.ims.txtMaTBIMS
      this.thuebao.ims.txtMaTN_IMS = olddata.thuebao.ims.txtMaTN_IMS
      this.thuebao.ims.txtIp_IMS = olddata.thuebao.ims.txtIp_IMS
      this.thuebao.ims.cboTrunk.value = 0
      this.thuebao.mgwan.txtMaTBWan.Text = olddata.thuebao.mgwan.txtMaTBWan.Text
      this.thuebao.mgwan.soao = olddata.thuebao.mgwan.soao
      this.thuebao.mgwan.matn = olddata.thuebao.mgwan.matn
      this.thuebao.mgwan.siteid = olddata.thuebao.mgwan.siteid
      this.thuebao.mgwan.madoicap = olddata.thuebao.mgwan.madoicap
      // this.thuebao.mgwan.mahdttkd = olddata.thuebao.mgwan.mahdttkd
      this.thuebao.mgwan.huongkn = olddata.thuebao.mgwan.huongkn
      this.thuebao.mgwan.vrfvfi = olddata.thuebao.mgwan.vrfvfi
      this.thuebao.mgwan.cuocnix = olddata.thuebao.mgwan.cuocnix
      this.thuebao.mgwan.soluongip = olddata.thuebao.mgwan.soluongip
      this.thuebao.mgwan.cuocisp = olddata.thuebao.mgwan.cuocisp
      this.thuebao.mgwan.cuocip = olddata.thuebao.mgwan.cuocip
      this.thuebao.mgwan.cuoctc_dt = olddata.thuebao.mgwan.cuoctc_dt
      this.thuebao.mgwan.cuoctc = olddata.thuebao.mgwan.cuoctc
      this.thuebao.mgwan.hopdong_dt = olddata.thuebao.mgwan.hopdong_dt
      this.thuebao.mgwan.cuoctk_dt = olddata.thuebao.mgwan.cuoctk_dt
      this.thuebao.mgwan.cuoctk = olddata.thuebao.mgwan.cuoctk
      this.thuebao.mgwan.cuoctbi = olddata.thuebao.mgwan.cuoctbi
      this.thuebao.mgwan.cuocht = olddata.thuebao.mgwan.cuocht
      this.thuebao.mgwan.lanip = olddata.thuebao.mgwan.lanip
      this.thuebao.mgwan.wanip = olddata.thuebao.mgwan.wanip
      this.listbox.doitacwan.value = olddata.listbox.doitacwan.value
      this.listbox.doitacwan.isenabled = olddata.listbox.doitacwan.isenabled
      this.listbox.tocdokenh.ischeckedisp = olddata.listbox.tocdokenh.ischeckedisp
      this.listbox.tocdokenh.valueisp = olddata.listbox.tocdokenh.valueisp
      this.listbox.tocdokenh.ischeckednix = olddata.listbox.tocdokenh.ischeckednix
      this.listbox.tocdokenh.valuenix = olddata.listbox.tocdokenh.valuenix
      this.listbox.loai_tb.valuemgwan = olddata.listbox.loai_tb.valuemgwan
      this.listbox.loaicap.value = olddata.listbox.loaicap.value
      this.listbox.tocdokenh.valuepir = olddata.listbox.tocdokenh.valuepir
      this.listbox.tocdokenh.ischeckedpir = olddata.listbox.tocdokenh.ischeckedpir
      this.listbox.tocdokenh.valuecir = olddata.listbox.tocdokenh.valuecir
      this.thuebao.tsl.txtMaTSL.Text = olddata.thuebao.tsl.txtMaTSL.Text
      this.thuebao.tsl.txtMaHD_TTKD_TSL = olddata.thuebao.tsl.txtMaHD_TTKD_TSL
      this.thuebao.tsl.txtCuocTC_TSL = olddata.thuebao.tsl.txtCuocTC_TSL
      this.thuebao.tsl.txtCuocTK_TSL = olddata.thuebao.tsl.txtCuocTK_TSL
      this.thuebao.tsl.txtCuocTKDT_TSL = olddata.thuebao.tsl.txtCuocTKDT_TSL
      this.thuebao.tsl.txtCuocTBI_TSL = olddata.thuebao.tsl.txtCuocTBI_TSL
      this.thuebao.tsl.txtMaHD_DT_TSL = olddata.thuebao.tsl.txtMaHD_DT_TSL
      this.thuebao.tsl.txtCuocTCDT_TSL = olddata.thuebao.tsl.txtCuocTCDT_TSL
      this.thuebao.tsl.txtCuocHT_TSL = olddata.thuebao.tsl.txtCuocHT_TSL
      this.thuebao.tsl.txtSoAoTSL_Dau = olddata.thuebao.tsl.txtSoAoTSL_Dau
      this.thuebao.tsl.txtSoAoTSL_Cuoi = olddata.thuebao.tsl.txtSoAoTSL_Cuoi
      this.thuebao.tsl.txtSiteIDTSL_Dau = olddata.thuebao.tsl.txtSiteIDTSL_Dau
      this.thuebao.tsl.txtSiteIDTSL_Cuoi = olddata.thuebao.tsl.txtSiteIDTSL_Cuoi
      this.thuebao.tsl.txtVrf_Dau = olddata.thuebao.tsl.txtVrf_Dau
      this.thuebao.tsl.txtVrf_Cuoi = olddata.thuebao.tsl.txtVrf_Cuoi
      this.thuebao.tsl.txtSoSoiQuang = olddata.thuebao.tsl.txtSoSoiQuang

      // Bo sung do loi phat sinh
      this.dsCTM_TBI = []
      this.lvMuaThietbi.list = []
      this.lvDvkhac.list = []
      this.dsDK_DVK_TB = []
      this.dsDC_HDTB = []
      this.dsKM_HDTB = []
      this.ds_tien_khoanmuc = JSON.parse(JSON.stringify(this.listbox.tien_km.list))
      this.dtienld = 0
      this.dvatld = 0
      this.tocdo_id = 0
      this.listbox.cboTocDoThucADSL.value = 0
      this.nhap_tocdo_thuc_adsl = 0
      this.thuebao.tsl.txtMaTSL.ReadOnly = false

      this.kt_thuenganhan = false

      this.filterbox.tratruoc.list = [];
      this.filterbox.tratruoc.value = 0;
      this.filterbox.tratruoc.ischecked = false;

      this.filterbox.khuyenmai.list = [];
      this.filterbox.khuyenmai.value = 0;
      this.filterbox.khuyenmai.ischecked = false;
      // if(this.watcherActive) this.sinhma = true;
      this.LayTienTheoKhoanMuc()
    },
    async cboTraTruoc_SelectedValueChanged() {
      if (this.m_dsTienCTKM) this.m_dsTienCTKM = this.m_dsTienCTKM.filter((x) => x.kieu != 1)
      this.dsDC_HDTB = []
      this.kmld.dtienkmdc = 0
      this.kmld.dvatkmdc = 0
      this.kmld.tyle_kmld_tt = 0
      this.kmld.dtiendatcoc_tt = 0
      this.kmld.dvatdatcoc_tt = 0
      await this.HT_ThietBi()
      await this.HT_DichVuGT()
      await this.HienThiTienKhuyenMaiLapDat() //dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt);
      await this.LayTongTien_HDTB()
    },
    async cboKhuyenMai_SelectedValueChanged() {
      this.dsKM_HDTB = []
      this.kmld.dtienkmld = 0
      this.kmld.dvatkmld = 0
      this.kmld.tyle_kmld = 0
      this.kmld.dtiendatcoc_km
      this.kmld.tong_kmld = 0
      this.kmld.tien_datcoc = 0
      await this.HT_ThietBi()
      await this.HT_DichVuGT()
      await this.HienThiTienKhuyenMaiLapDat()
      await this.LayTongTien_HDTB()
    },

    async btnThongTinTBSub_Click() {
      if (!this.listbox.loaihinh_tb.value || this.listbox.loaihinh_tb.value == 0) {
        this.$toast.warning('Bạn chưa chọn loại hình TB')
        return
      }
      // if(this.listbox.loaihinh_tb.value==LoaiHinhTB.CA || this.listbox.loaihinh_tb.value==LoaiHinhTB.SMART_CA) {
      //   this.popupComponent = ()=>import('./Popups/popupInforAdd');
      //   this.popupComponentName = "popupInforAdd";
      //   this.popupComponentData = {_hdkh_id:this.khachhang.hdkh_id,_nhapmoi:this.buttonSet==1,_vma_kh:this.khachhang.makh,_vkieukh_id:this.vkieukh_id_,_ts_kt_tthdkhdn:this.ts_kt_tthdkhdn, loaikh:this.listbox.loai_kh.value}
      //   this.Popup('popupComponents');
      // }
      // else
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IVAN) {
        //frmHDTB_SUB_V3_Load
        let dt_load = await API.post_lay_tt_thuebao_bosung(this.axios, { vhdtb_id: this.hdtb_id })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          .catch(() => {
            return []
          })
        if (dt_load && dt_load.length > 0) {
          dt_load = this.UpperCasePropertyList(dt_load)
          this.khachhang.txtNguoiKyHoSo = dt_load[0]['NGUOI_KY_HOSO']
          this.khachhang.txtChucDanh = dt_load[0]['CHUCDANH']
        } else {
          this.khachhang.txtNguoiKyHoSo = ''
          this.khachhang.txtChucDanh = ''
        }

        if (this.dsHDTB_SUB && this.dsHDTB_SUB.length > 0) {
          if (this.dsHDTB_SUB[0]['NGUOI_KY_HOSO']) this.khachhang.txtNguoiKyHoSo = this.dsHDTB_SUB[0]['NGUOI_KY_HOSO']
          if (this.dsHDTB_SUB[0]['CHUCDANH']) this.khachhang.txtChucDanh = this.dsHDTB_SUB[0]['CHUCDANH']
        }
        this.popup.frmHDTB_SUB_V3 = true
        this.Popup('frmHDTB_SUB_V3')
        // frmHDTB_SUB_V3 frm = new frmHDTB_SUB_V3((int)hdtb_id, Convert.ToInt32(cboLoaihinhTB.SelectedValue),
        //     Convert.ToInt32(cboKieuLD.SelectedValue), this.dsHDTB_SUB, false, false);
        // frm.ShowDialog();
        // dsHDTB_SUB = frm.ds_hdtb_sub;
        // THANGDM1 Doan nay tu lap moi goi vao isReadonly luôn false -> khong code gi them!
        // if (!isReadonly)
        //   {
        //       txtNguoiDaiDien.Enabled = true;
        //       txtChucDanh.Enabled = true;
        //   }
        //   else
        //   {
        //       string khoaform = tdan.GET_VALUE_FUNC("{?DB2}.IVAN_KHOA_FORM_THONGTIN_BOSUNG", "vkieuld_id", _kieuld_id).ToString();
        //       foreach (string item in khoaform.Split(','))
        //       {
        //           try
        //           {
        //               ((BaseEdit)this.layoutControl3.Controls[item]).Properties.ReadOnly = true;
        //           }
        //           catch { }
        //       }
        //   }
      } else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.Voice_Brandname) {
        //frmHDTB_SUB_V4_Load
        let dt_load = await API.post_lay_tt_thuebao_bosung(this.axios, { vhdtb_id: this.hdtb_id })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          .catch(() => {
            return []
          })
        if (dt_load && dt_load.length > 0) {
          dt_load = this.UpperCasePropertyList(dt_load)
          this.khachhang.txtNguoiKyHoSo = dt_load[0]['NGUOI_KY_HOSO']
          this.khachhang.dtpNgaySinh = dt_load[0]['NGAYSINH']
          this.khachhang.cboGioiTinh = dt_load[0]['GIOITINH']
          this.khachhang.txtSoGT = dt_load[0]['SO_GT']
          this.khachhang.dtpNgayCap = dt_load[0]['NGAYCAP']
          this.khachhang.txtSoGT = dt_load[0]['SO_GT']
          this.khachhang.txtNoiCap = dt_load[0]['NOICAP']
          this.khachhang.txtEmail = dt_load[0]['EMAIL']
          this.khachhang.txtSoDT = dt_load[0]['SO_DT']
        } else {
          this.khachhang.txtNguoiKyHoSo = ''
          this.khachhang.dtpNgaySinh = null
          this.khachhang.cboGioiTinh = ''
          this.khachhang.txtSoGT = ''
          this.khachhang.dtpNgayCap = null
          this.khachhang.txtSoGT = ''
          this.khachhang.txtNoiCap = ''
          this.khachhang.txtEmail = ''
          this.khachhang.txtSoDT = ''
        }

        if (this.dsHDTB_SUB && this.dsHDTB_SUB.length > 0) {
          if (this.dsHDTB_SUB[0]['NGUOI_KY_HOSO']) this.khachhang.txtNguoiKyHoSo = this.dsHDTB_SUB[0]['NGUOI_KY_HOSO']
          if (this.dsHDTB_SUB[0]['NGAYSINH']) this.khachhang.dtpNgaySinh = this.dsHDTB_SUB[0]['NGAYSINH']
          if (this.dsHDTB_SUB[0]['GIOITINH']) this.khachhang.cboGioiTinh = this.dsHDTB_SUB[0]['GIOITINH']
          if (this.dsHDTB_SUB[0]['SO_GT']) this.khachhang.txtSoGT = this.dsHDTB_SUB[0]['SO_GT']
          if (this.dsHDTB_SUB[0]['NGAYCAP']) this.khachhang.dtpNgayCap = this.dsHDTB_SUB[0]['NGAYCAP']
          if (this.dsHDTB_SUB[0]['SO_GT']) this.khachhang.txtSoGT = this.dsHDTB_SUB[0]['SO_GT']
          if (this.dsHDTB_SUB[0]['NOICAP']) this.khachhang.txtNoiCap = this.dsHDTB_SUB[0]['NOICAP']
          if (this.dsHDTB_SUB[0]['EMAIL']) this.khachhang.txtEmail = this.dsHDTB_SUB[0]['EMAIL']
          if (this.dsHDTB_SUB[0]['SO_DT']) this.khachhang.txtSoDT = this.dsHDTB_SUB[0]['SO_DT']
        }
        this.popup.frmHDTB_SUB_V4 = true
        this.Popup('frmHDTB_SUB_V4')
        // frmHDTB_SUB_V4 frm = new frmHDTB_SUB_V4((int)hdtb_id, Convert.ToInt32(cboLoaihinhTB.SelectedValue),
        //     Convert.ToInt32(cboKieuLD.SelectedValue), this.dsHDTB_SUB, false, false);
        // frm.ShowDialog();
        // dsHDTB_SUB = frm.ds_hdtb_sub;
      }
      else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_COLOCATION)
      {
          if (!this.hdtb_id || this.listbox.kieu_ld.value != 13279) // cai tao ha tang IDC
          {
              this.$toast.error("Bạn cần ghi lại hợp đồng trước khi chọn các thuê bao cải tạo hạ tầng");
              return;
          }

          this.popupComponent = ()=>import('../InstallNewSubs/Popups/popupDangKyCaiTaoHaTangIDC');
          this.popupComponentName = "popupDangKyCaiTaoHaTangIDC";
          this.popupComponentData = {hdtb_id:this.hdtb_id}
          this.Popup('popupComponents');
          // frmDangKyCaiTaoHaTangIDC f = new frmDangKyCaiTaoHaTangIDC();
          // f.hdtb_id = hdtb_id;
          // f.ShowDialog();
      }
      else if(this.listbox.loaihinh_tb.value==LoaiHinhTB.SMART_CA || this.listbox.loaihinh_tb.value==LoaiHinhTB.CA) {
        this.popup.dialogHDTB_SUB_V2 = true
        if (this.$refs.dialogHDTB_SUB_V2._data.state.hdtb_sub && this.$refs.dialogHDTB_SUB_V2._data.state.hdtb_sub.SO_GT && (!this.dsHDTB_SUB || this.dsHDTB_SUB.length <= 0)) {
          this.dsHDTB_SUB = [this.$refs.dialogHDTB_SUB_V2._data.state.hdtb_sub]
        }
        if (!this.hdtb_id || this.hdtb_id <= 0 || this.buttonSet == 1) {
          this.$refs.dialogHDTB_SUB_V2.openDialog({ type: 2, hdtb_sub: this.dsHDTB_SUB && this.dsHDTB_SUB.length > 0 ? this.dsHDTB_SUB[0] : {}, kieuld_id: this.listbox.kieu_ld.value, loaitb_id: this.listbox.loaihinh_tb.value, isReadonly: false }) // truyen 2 moi binding duoc du lieu????
          this.$refs.dialogHDTB_SUB_V2._data.state.isRAUpdate = this.dsHDTB_SUB && this.dsHDTB_SUB.length > 0 && this.dsHDTB_SUB[0]['HDTB_ID'] && this.dsHDTB_SUB[0]['HDTB_ID'] != 0 && this.buttonSet != 1 // false;
          this.$refs.dialogHDTB_SUB_V2._data.state.isUpdated = false
        } else {
          this.$refs.dialogHDTB_SUB_V2.openDialog({ type: 3, hdtb_id: this.hdtb_id, isReadonly: false })
          this.$refs.dialogHDTB_SUB_V2._data.state.isUpdated = false
          this.$refs.dialogHDTB_SUB_V2._data.state.hdtb_sub = this.dsHDTB_SUB[0]
        }
      }
      else {
        this.popupComponent = ()=>import('./Popups/popupThongTinTBBoSung');
        this.popupComponentName = "popupThongTinTBBoSung";
        this.popupComponentData = {nhapmoi:this.buttonSet == 1,hdtb_id:this.hdtb_id,ds_hdtb_sub:this.dsHDTB_SUB,kiemtra_nhanvien_vti:this.kiemtra_nhanvien_vti,kiemtra_chuquan_kh:this.kiemtra_chuquan_kh,is_bancheo:true}
        this.Popup('popupComponents');
      }
      // console.log(this.$refs.dialogHDTB_SUB_V2);
      // else if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.VNPT_SLL)
      // {
      //     if (hdtb_id == 0) // cai tao ha tang IDC
      //     {
      //         Message_Box.Show("Bạn cần ghi lại hợp đồng trước giới hạn SMS");
      //         return;
      //     }
      //     frmGioiHanSMS_SLL f = new frmGioiHanSMS_SLL();
      //     f.hdtb_id = hdtb_id;
      //     f.ShowDialog();
      // }
      // else
      // {
      //     if (hdtb_id == 0 || Convert.ToInt32(cboKieuLD.SelectedValue.ToString()) != 13279) // cai tao ha tang IDC
      //     {
      //         Message_Box.Show("Bạn cần ghi lại hợp đồng trước khi chọn các thuê bao cải tạo hạ tầng");
      //         return;
      //     }
      //     frmDangKyCaiTaoHaTangIDC f = new frmDangKyCaiTaoHaTangIDC();
      //     f.hdtb_id = hdtb_id;
      //     f.ShowDialog();
      // }
      // if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IVAN)
      // {
      //     let data = {
      //       hdtb_id: this.hdtb_id,
      //       loaitb_id: this.listbox.loahinh_tb.value,
      //       kieuld_id: this.listbox.kieu_ld.value,
      //       readOnly: false,
      //       isUpdate: true,
      //       ds_hdtb_sub: []
      //     }
      //     this.$refs.dialogHDTB_SUB_V3.openDialog(data);
      //     return;
      // }
      // else
      // {
      //   this.$refs.dialogHDTB_SUB_V2.openDialog({type: 3, hdtb_id: this.state.hdtb_id, isReadonly: false});
      //     // if (await this.PHAILAM(this.state.luong_id, "RA_GUIYC"))
      //     // {
      //     //     this.$refs.dialogHDTB_SUB_V2.openDialog({type: 3, hdtb_id: this.state.hdtb_id, isReadonly: false});
      //     // }
      //     // else
      //     // {
      //     //     this.$refs.dialogHDTB_SUB_V2.openDialog({type: 3, hdtb_id: this.state.hdtb_id, isReadonly: true});
      //     // }
      // }
    },
    round(num) {
        if(this.kiemtra_nhanvien_vti==1)
            return +(Math.round(num + "e+2")  + "e-2");
        else return Math.round(num);
    },
  }
}
</script>
