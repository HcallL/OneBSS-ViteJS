/* eslint-disable space-before-function-paren */
<template src="./InstallNewSubs.html"> </template>

<style scoped src="./InstallNewSubs.scss"></style>

<script>
// import commondata from './mixins/commondata.js'
// import watchdata from './mixins/watchdata.js'
import vdc from '@/modules/EXTS/HOPDONG/DongBoVisaVascUpdate/service/vdcService.js'
import cache from './cache'
import cacheDM from './cacheDM'
import breadcrumb from '@/components/breadcrumb'
import gridview from '@/components/Shared/gridview'
import '@/assets/vendor/jquery/split'
import API from './InstallNewSubsAPI'
import BssErrorMarker from '@/components/BssErrorMarker'
import BssRequiredMarker from '@/components/BssRequiredMarker'
import { required, minValue, maxValue } from '@vuelidate/validators'
import { useVuelidate } from '@vuelidate/core'
// import TimNhanVienThuCuoc from '@/modules/QLTN/GachNo/components/TimNhanVienThuCuoc'
// import PopupTimKiemNhanVienThuCuoc from '@/modules/QLTN/GachNo/components/TimNhanVienThuCuoc'
// import PopupTimKiemNhanVienThuCuoc from './Popups/PopupTimKiemNhanVienThuCuoc'
import moment from 'moment'
import DatePicker from 'vue2-datepicker'
import 'vue2-datepicker/locale/vi.js'
import 'vue2-datepicker/index.css'
import DataGrid2 from '@/components/Controls/DataGrid2'
import ComboboxGrid2 from '@/components/Controls/ComboboxGrid2'
const ThongTinEmail = () => import('@/modules/contract/setup/ChangeContractOwner/popup/ThongTinEmail.vue')
const SearchContractModal = () => import('@/modules/contract/setup/HandoverTicket/components/SearchContractModal.vue')
const ThongTinHenKhachHangModal = () => import('@/modules/contract/setup/SurveyRequest/popups/ThongTinHenKhachHang/ThongTinHenKhachHangModal.vue')
const frmDangKyGoiDaDVLM = () => import('@/modules/admin/category/NiceNumberStyle/popups/frmDangKyGoiDaDVLM.vue')
const popupToaNha = () => import('@/modules/contract/setup/InstallInternet/popups/popup_Toanha.vue')
const HDTB_SUB_V2 = () => import('@/modules/contract/complete_profile/CompleteProfileITVAS/popups/popupHDTB_SUB/HDTB_SUB_V2.vue')
const ModalImportCA = () => import('./Popups/popupImportCA/ModalImportCA.vue')
const PopupThongTinUser = () => import('@/modules/contract/setup/ChangeContractOwner/popup/ThongTinUser/PopupThongTinUser')
const PopupTimKiemNhanVienThuCuoc = () => import('@/modules/EXTS/HOPDONG/ThayDoiThongTinKhuyenMai/TimNhanVienThuCuoc')
const ModalChonDiaChi = () => import('./Popups/popupChonDiaChi')
const Thuebao_ToaNha = () => import('@/modules/search/subscriber/SearchInstallDetail/popup/ThueBao_ToaNha.vue')
//const ChonMegaWanIOTModal =()=>import('./Popups/ChonMegaWanIOTModal');
import ChonMegaWanIOTModal from './Popups/ChonMegaWanIOTModal'
const frmNhapDSThanhVien = () => import('@/modules/contract/setup/ChangeContractOwner/popup/frmNhapDSThanhVien.vue')
const frmTuVanMyTV = () => import('@/modules/CSKH/TuvanMyTv/TuvanMyTv.vue')


const waitUntil = (condition, checkInterval=100) => {
    return new Promise(resolve => {
        let interval = setInterval(() => {
            if (!condition()) return;
            clearInterval(interval);
            resolve();
        }, checkInterval)
    })
}
const delay = ms => new Promise(res => setTimeout(res, ms));
// import HDTB_SUB_V3 from "@/modules/contract/complete_profile/CompleteProfileITVAS/popups/popupHDTB_SUB/HDTB_SUB_V3.vue";

// import  ThongTinLienHe from "@/modules/contract/setup/ChangeContractOwner/popup/ThongTinLienHe.vue"
import {
  DichVuVienThong,
  TRANGBI,
  DUNG_THU,
  LoaiHopDong,
  TrangThaiHD,
  LoaiHinhTB,
  ThoiHan,
  KHOANMUC_TT,
  KieuCaiDatDVGT,
  THUESO,
  TRANGTHAI_DONGBO,
  KieuLapDat,
  LOAI_DV,
  Loai_KH,
  HINHTHUC_TC,
  KIEU_HD,
  KIEU_KH,
  PHANLOAI_KH,
  Loai_NV,
  LOAISO,
  LOAI_KV,
  Loai_KM,
  LOAINODE_MGWAN,
  KIEULAP,
  FSECURE_KM_12_MONTHS,
  MUCCUOC,
  LOAITBI_ADSL,
  ChiTietDV_IMS,
  GOICUOC_DD,
  CAConstanst,
  DatabaseConstants,
  TrangThaiCaiDat,
  LOAISO_ISDN,
  TOCDO,
  LOAIKENH,
  LoaiGiayTo
} from './Enums'
import EventBus from '@/utils/eventBus'
import InHopDong from '@/modules/print/InHopDong/InHopDong.vue'
export default {
  components: {
    breadcrumb,
    gridview,
    BssErrorMarker,
    BssRequiredMarker,
    ModalChonDiaChi,
    ThongTinHenKhachHangModal, //ThongTinLienHe,
    //appTimNhanVienThuCuoc: TimNhanVienThuCuoc,
    frmDangKyGoiDaDVLM,
    popupToaNha,
    HDTB_SUB_V2, //HDTB_SUB_V3,
    PopupTimKiemNhanVienThuCuoc,
    DatePicker,
    DataGrid2,
    ComboboxGrid2,
    SearchContractModal,
    InHopDong,
    ModalImportCA,
    PopupThongTinUser,
    Thuebao_ToaNha,
    ChonMegaWanIOTModal,
    frmNhapDSThanhVien,
    frmTuVanMyTV,
    ThongTinEmail
  },
  //directives: { mask:VueMaskDirective },
  mixins: [
    // commondata,
    // watchdata,
  ],
  name: 'InstallNewSubs',
  created() {
    EventBus.$on('getTTTB', this.getTTTBHandler)
    this.$root.$on('bv::modal::shown', (bvEvent, modalId) => {
      if (this.popupQueueWhiteList.indexOf(modalId) >= 0) this.popupShowing = true
      document.getElementsByClassName('modal-content').forEach(function(v) {
        v.removeAttribute('tabindex')
      })
    })
    this.$root.$on('bv::modal::hidden', (bvEvent, modalId) => {
      if (this.popupQueueWhiteList.indexOf(modalId) >= 0) {
        this.popupShowing = false
        this.ShowPopupQueue()
      }
      this.ValidateModal(bvEvent, modalId)
    })
    $('button, a').click(function() {
      let ctl = $(this)
      ctl.addClass('disabled')
      setTimeout(function() {
        ctl.removeClass('disabled')
      }, 3000)
    })

    //THANGDM1 them 2022-12-07 them de xu ly loading
    let numberOfAjaxCAllPending = 0

    // Add a request interceptor
    this.axios.interceptors.request.use(
      (config) => {
        numberOfAjaxCAllPending++
        // show loader
        this.loading(true)
        return config
      },
      (error) => {
        return Promise.reject(error)
      }
    )

    // Add a response interceptor
    this.axios.interceptors.response.use(
      (response) => {
        numberOfAjaxCAllPending--

        this.loading(true)
        if (numberOfAjaxCAllPending == 0) {
          //hide loader
          this.loading(false)
        }
        return response
      },
      (error) => {
        numberOfAjaxCAllPending--
        if (numberOfAjaxCAllPending == 0) {
          //hide loader
          this.loading(false)
        }
        return Promise.reject(error)
      }
    )
  },
  destroyed() {
    EventBus.$off('getTTTB', this.getTTTBHandler)
  },
  props: ['PHIEUHS_ID', 'frmDatmoi_Shown', 'OnDatMoi', 'itag', 'ihc_hdtb_id', 'ihc_tdtt_hdtb_id'],
  async mounted() {
    //this.FormLoad();

    // window.Bugpilot.saveReport({
    //   source: "InstallNewSubs", // Optional
    //   userProvidedDescription: "Lap Dat Moi", // Optional
    // });
    if (this.frmDatmoi_Shown) this.frmDatmoi_Shown()
    if (this.$route.query.tag && this.$route.query.tag.trim() != '') this.Tag = this.$route.query.tag
    else if (this.itag && this.itag.trim() != '') this.Tag = this.itag
    if (this.$route.query.hc_hdtb_id) this.hc_hdtb_id = this.$route.query.hc_hdtb_id
    else if (this.ihc_hdtb_id) this.hc_hdtb_id = this.ihc_hdtb_id
    if (this.$route.query.hc_tdtt_hdtb_id) this.hc_tdtt_hdtb_id = this.$route.query.hc_tdtt_hdtb_id
    else if (this.ihc_tdtt_hdtb_id) this.hc_tdtt_hdtb_id = this.ihc_tdtt_hdtb_id

    //kieu=${kieuId}&phieucskh_id=${phieucskh_id}&phieucskhdv_id=${phieucskhdv_id}&hdkh_cha_id=${hdkh_cha_id}
    if (this.$route.query.kieu && this.$route.query.kieu.trim() != '') this.iKieu = this.$route.query.kieu
    if (this.$route.query.phieucskh_id && this.$route.query.phieucskh_id.trim() != '') this.VPHIEUCSKH_ID = this.$route.query.phieucskh_id
    if (this.$route.query.phieucskhdv_id && this.$route.query.phieucskhdv_id.trim() != '') this.phieucskhdv_id = this.$route.query.phieucskhdv_id
    if (this.$route.query.hdkh_cha_id && this.$route.query.hdkh_cha_id.trim() != '') this.hdkh_cha_id = this.$route.query.hdkh_cha_id
    if (this.iKieu > 1)
      if (this.iKieu == 5) await this.LoadTuHopDongB2A()
      else await this.LoadTuHopDongTuVan()
    try {
      this.DONGBO_TEST.TEST = await API.post_get_app_config(this.axios, { keyname: 'DONGBO_TEST' }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          return !((response.data.data.keyvalue + '').toLowerCase() == 'false' && response.data.data.dongbo == 1)
        }
      })
    } catch (ex) {}
    this.watcherActive = true
    this.buttonSet = 1
  },
  validations: {
    diachiKH: {
      DIACHI: {
        required
      }
    },
    diachiHK: {
      DIACHI: {
        required
      }
    },
    diachiNDD: {
      DIACHI: {
        required
      }
    },
    diachiTT: {
      DIACHI: {
        required
      }
    },
    diachiCT: {
      DIACHI: {
        required
      }
    },
    diachiBC: {
      DIACHI: {
        required
      }
    },
    diachiTB: {
      DIACHI: {
        required
      }
    },
    diachiLD: {
      DIACHI: {
        required
      }
    },
    diachiKN: {
      DIACHI: {
        required
      }
    },
    diachiDau: {
      DIACHI: {
        required
      }
    },
    diachiCuoi: {
      DIACHI: {
        required
      }
    },
    diachiTBCu: {
      DIACHI: {
        required
      }
    },
    diachiHKTBCu: {
      DIACHI: {
        required
      }
    }
  },
  computed: {
    kiemtra_nhanvien_vti() {
      return this.$root.token.getPhanVungID()==98?1:0
    },
    is_nv_vnpti() {
      return this.$root.token.getPhanVungID()==98
    },
    isEditKH() {
      return (this.thamsomacdinh && this.thamsomacdinh['GUI_YEUCAU_PHEDUYET_TTTT_KH']==1) && this.khachhang.khachhang_id;// (this.khachhang.hdkh_id || this.isLoadKH);// Bo theo yeu cau cua QC
    },
    tienckeditsettings() {
      let KOSUA_CAMKET = false
      if (this.thamsomacdinh && this.thamsomacdinh['KOSUA_CAMKET'] == 1) KOSUA_CAMKET = true
      return { allowEditing: !KOSUA_CAMKET, allowAdding: !KOSUA_CAMKET, allowDeleting: !KOSUA_CAMKET }
    },
    tiencktoolbar() {
      let KOSUA_CAMKET = false
      if (this.thamsomacdinh && this.thamsomacdinh['KOSUA_CAMKET'] == 1) KOSUA_CAMKET = true
      if (KOSUA_CAMKET) return []
      else return ['Add', 'Edit', 'Delete', 'Update', 'Cancel']
    },
    cloaihinh_tb() {
      if (!this.listbox.loaihinh_tb.list || this.listbox.loaihinh_tb.list.length <= 0) return []
      let list = this.listbox.loaihinh_tb.list.filter((lh) => lh.dichvuvt_id == this.listbox.dichvu_vt.value).map((lh) => ({ id: lh.loaitb_id, text: lh.loaihinh_tb }))
      if (!list || list.length <= 0) {
        this.listbox.loaihinh_tb.value = 0
        return []
      }
      var i = 0
      for (; i < list.length; i++) {
        if (list[i].id == this.listbox.loaihinh_tb.value) return list
      }
      if (i >= list.length) this.listbox.loaihinh_tb.value = list[0].id
      return list
    },
    ckieu_ld() {
      let loaihinh = this.listbox.loaihinh_tb.value
      if (!this.listbox.kieu_ld.list || this.listbox.kieu_ld.list.length <= 0) return []
      let list = this.listbox.kieu_ld.list.filter((ld) => ld.loaitb_id == loaihinh && ld.tinhkhac != 2).map((ld) => ({ id: ld.kieuld_id, text: ld.ten_kieuld }))
      if (!list || list.length <= 0) {
        this.listbox.kieu_ld.value = 0
        return []
      }
      var i = 0
      for (; i < list.length; i++) if (list[i].id == this.listbox.kieu_ld.value) return list
      if (i >= list.length) this.listbox.kieu_ld.value = list[0].id
      return list
    },
    ccongnghe() {
      if (!this.listbox.congnghe.list || this.listbox.congnghe.list.length <= 0) return []
      let list = this.listbox.congnghe.list.filter((cn) => cn.kieuld_id == this.listbox.kieu_ld.value).map((cn) => ({ id: cn.congnghe_id, text: cn.congnghe }))
      if (!list || list.length <= 0) {
        this.listbox.congnghe.value = 0
        return []
      }
      var i = 0
      for (; i < list.length; i++) if (list[i].id == this.listbox.congnghe.value) return list
      if (i >= list.length) this.listbox.congnghe.value = list[0].id
      return list
    },
    DiaChiLDCLONE() {
      return JSON.parse(JSON.stringify(this.diachiLD))
    },
    DiaChiTTCLONE() {
      return JSON.parse(JSON.stringify(this.diachiTT))
    },
    ma_lhtb_vdc() {
      try {
        return this.listbox.loaihinh_tb.list.filter((x) => x.loaitb_id == this.listbox.loaihinh_tb.value)[0]['ma_lhtb_vdc'] * 1
      } catch (ex) {
        return 0
      }
    },
    kieu_ld_kieu() {
      try {
        return this.listbox.kieu_ld.list.filter((x) => x.kieuld_id == this.listbox.kieu_ld.value)[0]['kieu'] * 1
      } catch (ex) {
        return 0
      }
    },
    DT_DV() {
      this.DT_CONTROLS.key
      return (idx) => {
        let list = this.DT_CONTROLS.data[idx].map((c) => ({ id: c.DONVI_ID, text: c.TEN_DV }))
        if (list && list.length > 0) {
          if (!this.DT_CONTROLS.value[idx] || this.DT_CONTROLS.value[idx] <= 0) this.DT_CONTROLS.value[idx] = list[0].id && list[0].id > 0 ? list[0].id : list[1] && list[1].id ? list[1].id : 0
          return list
        } else return []
      }
    },
    loai_kh_tree: {
      get() {
        let listkieukh = [...new Set(this.listbox.loai_kh.list.map((x) => x.kieu_kh))].map((x) => ({ label: x, id: x }))
        for (let kieukh of listkieukh) {
          kieukh.children = [...new Set(this.listbox.loai_kh.list.filter((x) => x.kieu_kh == kieukh.label).map((x) => x.ten_nhom))].map((x) => ({ label: x, id: x }))
          for (let nhomkh of kieukh.children) {
            nhomkh.children = this.listbox.loai_kh.list.filter((x) => x.kieu_kh == kieukh.label && x.ten_nhom == nhomkh.label).map((x) => ({ id: x.loaikh_id, label: x.ten_loaikh, cate: kieukh.label, subcate: nhomkh.label }))
          }
        }
        listkieukh = [{ id: -1, label: 'Chọn loại khách hàng', isDisabled: true }].concat(listkieukh)
        return listkieukh
      }
    },
    TinhKhac: {
      get() {
        let tk = this.listbox.loaihinh_tb.list.filter((lh) => lh.dichvuvt_id == this.listbox.dichvu_vt.value && lh.loaitb_id == this.listbox.loaihinh_tb.value)
        if (tk && tk.length > 0 && tk[0] && tk[0]['tinhkhac']) return tk[0]['tinhkhac']
        else return 0 // Mac dinh bien nay la bien global 0
      }
    },
    TinhKhacLD: {
      get() {
        let tk = this.listbox.kieu_ld.list.filter((x) => x.kieuld_id == this.listbox.kieu_ld.value)
        if (tk && tk.length > 0 && tk[0] && tk[0]['tinhkhac']) return tk[0]['tinhkhac']
        else return 0
      }
    },
    nhanvienId() {
      return +this.$root.token.getNhanVienID()
    },
    donViId() {
      return +this.$root.token.getDonViID()
    },

  },
  watch: {
    popupQueue: {
      handler: function() {
        this.ShowPopupQueue()
      },
      deep: true
    },
    trangbi_id: {
      handler: function() {
        this.LayTienTheoKhoanMuc()
      }
    },
    DiaChiLDCLONE: {
      handler: async function(newval, oldval) {
        let watcherActive = this.watcherActive == true
        // if(!this.watcherActive) return;
        if ((!oldval && newval) || newval.QUAN_ID != oldval.QUAN_ID || newval.PHUONG_ID != oldval.PHUONG_ID || newval.PHO_ID != oldval.PHO_ID || newval.AP_ID != oldval.AP_ID || newval.KHU_ID != oldval.KHU_ID || newval.DACDIEM_ID != oldval.DACDIEM_ID || newval.LOAINHA_ID != oldval.LOAINHA_ID) {
          try {
            this.loading(true)
            if (this.TinhKhac == 0 && this.TinhKhacLD == 0) {
              let pdata1 = {
                DT_CONTROLS: this.DT_CONTROLS.list,
                PHIEUHS_ID: this.PHIEUHS_ID ? this.PHIEUHS_ID : 0,
                PHUONG_ID: newval.PHUONG_ID ? newval.PHUONG_ID : 0,
                PHO_ID: newval.PHO_ID ? newval.PHO_ID : 0,
                AP_ID: newval.AP_ID ? newval.AP_ID : 0,
                KHU_ID: newval.KHU_ID ? newval.KHU_ID : 0,
                DACDIEM_ID: newval.DACDIEM_ID ? newval.DACDIEM_ID : 0,
                TTND_DV_ID: this.$root.token.getNguoiDungID(),
                HDKH_ID: this.khachhang.hdkh_id,
                CTV_ID: this.ctv_id,
                NGUOIGT_ID: this.filterbox.nguoigt.value
              }
              let api = cache.getters.getFromCache('post_fn_lay_donvi_theo_loaidv_diachi_ld_v2', pdata1)
              if (!api) api = API.post_fn_lay_donvi_theo_loaidv_diachi_ld_v2(this.axios, { ds_para: JSON.stringify(pdata1) })
              else
                api = new Promise((resolve, reject) => {
                  resolve(api)
                })
              await api.then((response) => {
                cache.dispatch('addToCache', { key: 'post_fn_lay_donvi_theo_loaidv_diachi_ld_v2', subkey: pdata1, data: response })
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  let dulieuapi = JSON.parse(response.data.data)
                  if (dulieuapi['ERROR_CODE'] != 1) {
                    this.$toast.error(dulieuapi['MESSAGE'])
                    return
                  }
                  if (dulieuapi['RESULT']['DS_GT_DVI'] && dulieuapi['RESULT']['DS_GT_DVI'].length > 0 && this.DT_CONTROLS.data.length == dulieuapi['RESULT']['DS_GT_DVI'].length) {
                    let dsValues = dulieuapi['RESULT']['DS_GT_DVI']
                    for (var i = 0; i < this.DT_CONTROLS.data.length; i++) {
                      if (dsValues[i]) this.DT_CONTROLS.value[i] = dsValues[i] //!this.DT_CONTROLS.value[i] &&  <- bo dieu kien nay do ko load.
                      if (this.DT_CONTROLS.data[i] && this.DT_CONTROLS.data[i].length > 0) {
                        if (!this.DT_CONTROLS.value[i]) this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0].DONVI_ID
                        if (this.DT_CONTROLS.data[i][0].LOAIDV_ID) this.DT_CONTROLS.tagvalue[i] = this.DT_CONTROLS.data[i][0].LOAIDV_ID
                      }
                    }
                    this.DT_CONTROLS.dichvu_vt = this.listbox.dichvu_vt.value
                    this.DT_CONTROLS.key += 1
                  }
                }
              })
              if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) this.buttons.btnChonSM = true
            }
            let pdata = {
              KETCUOI_ID: this.KetCuoi_ID,
              TINHKHAC: this.thuebao.tinhkhac,
              KIEULD_ID: this.listbox.kieu_ld.value,
              PHUONG_ID: newval.PHUONG_ID,
              PHO_ID: newval.PHO_ID,
              AP_ID: newval.AP_ID,
              KHU_ID: newval.KHU_ID,
              DACDIEM_ID: newval.DACDIEM_ID,
              KHUVUC_THEO_KETCUOI: this.KHUVUC_THEO_KETCUOI
            }
            if(this.$root.token.getPhanVungID()!=97)
            await API.post_fn_lay_tt_th_diachi_ld(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                let apidata = JSON.parse(response.data.data)
                if (apidata['ERROR_CODE'] != 1) {
                  this.$toast.error(apidata['MESSAGE'])
                  if (watcherActive) this.XuLyDonViLD(apidata['RESULT'] && apidata['RESULT']['DS_DVI'] ? apidata['RESULT']['DS_DVI'] : [])
                  return
                }
                if (apidata['RESULT']) apidata = apidata['RESULT']
                if (watcherActive && apidata['DS_DVI']) this.XuLyDonViLD(apidata['DS_DVI'])
                if (watcherActive)
                  if (apidata['DS_KV'] && apidata['DS_KV'].length > 0) {
                    this.thuebao.khuvuc = apidata['DS_KV'][0]['TEN_KV']
                    this.thuebao.khuvuc_id = apidata['DS_KV'][0]['KHUVUC_ID']
                    this.dsHDTB_KV = [
                      {
                        HDTB_ID: this.hdtb_id ? this.hdtb_id : 0,
                        KHUVUC_ID: this.thuebao.khuvuc_id,
                        LOAIKV_ID: LOAI_KV.KHUVUC_DIABAN,
                        NGAY_CN: new Date().toLocaleDateString('en-GB'),
                        MAY_CN: await this.$root.token.getMachine(),
                        NGUOI_CN: this.$root.token.getNguoiDungID(),
                        IP_CN: await this.$root.token.getIP()
                        // KIEUKV_ID : 0
                      }
                    ]
                  } else {
                    // FIXME THANGDM1 them case else nay de load thong tin khu vuc tu diachiLD neu khong load duoc o buoc tren!
                    let rs = await this.$root.context.post('/web-hopdong/thaydoiloaihinhtbcodinhims/sp_lay_khuvuc_theo_diadanh', {
                      loaikv_id: 4,
                      quan_id: newval.QUAN_ID,
                      phuong_id: newval.PHUONG_ID,
                      pho_id: newval.PHO_ID ? newval.PHO_ID : 0,
                      ap_id: newval.AP_ID ? newval.AP_ID : 0,
                      khu_id: newval.KHU_ID ? newval.KHU_ID : 0,
                      dacdiem_id: newval.DACDIEM_ID ? newval.DACDIEM_ID : 0,
                      tramtc_id: 0
                    })
                    if (rs && rs.data && rs.data.length > 0) {
                      if (rs.data.length > 1 && this.watcherActive) {
                        if(!this.thuebao || !this.thuebao.khuvuc_id || !this.thuebao.khuvuc || !rs.data.find(x=>x.ten_kv==this.thuebao.khuvuc && x.khuvuc_id==this.thuebao.khuvuc_id)) {
                          this.popupChonKhuVuc()
                          this.$toast.success(`Địa chỉ có ${rs.data.length} khu vực quản lý. Vui lòng chọn!`)
                        }
                        else this.$toast.success(`Địa chỉ có ${rs.data.length} khu vực quản lý.`)
                      } else {
                        this.thuebao.khuvuc = rs.data[0].ten_kv
                        this.thuebao.khuvuc_id = rs.data[0].khuvuc_id
                        this.dsHDTB_KV = [
                          {
                            HDTB_ID: this.hdtb_id ? this.hdtb_id : 0,
                            KHUVUC_ID: this.thuebao.khuvuc_id,
                            LOAIKV_ID: LOAI_KV.KHUVUC_DIABAN,
                            NGAY_CN: new Date().toLocaleDateString('en-GB'),
                            MAY_CN: await this.$root.token.getMachine(),
                            NGUOI_CN: this.$root.token.getNguoiDungID(),
                            IP_CN: await this.$root.token.getIP()
                            // KIEUKV_ID : 0
                          }
                        ]
                      }
                    } else {
                      this.thuebao.khuvuc = ''
                      this.thuebao.khuvuc_id = null
                      this.dsHDTB_KV = []
                    }
                  }
              }
            })
            await this.HT_DS_KhuyenMai_Combobox()
            await this.LoadMucCuocTB()
            if (watcherActive)
              await API.post_sp_layds_tb_trung_dcld(this.axios, { diachi_ld: this.diachiLD.DIACHI }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  let dlist = response.data.data
                  if (dlist && dlist.length > (this.buttonSet == 1 ? 0 : 1)) {
                    this.loading(false)
                    this.$bvModal
                      .msgBoxConfirm(`Tìm thấy ${dlist.length} thuê bao trong danh bạ trùng địa chỉ lắp đặt. Bạn có muốn xem thông tin các thuê bao này?`, {
                        title: 'Xác nhận hành động',
                        size: 'sm',
                        okTitle: 'Đồng ý',
                        cancelTitle: 'Không đồng ý'
                      })
                      .then(async (v) => {
                        if (v) {
                          this.popupQueue.push({
                            component: () => import('./Popups/popupChonGrid'),
                            name: 'popupTrungDC',
                            data: {
                              ds: dlist,
                              cols: [
                                { fieldName: 'ma_tb', headerText: 'Số máy/Account', allowFiltering: false, allowSorting: false },
                                { fieldName: 'ten_tb', headerText: 'Tên thuê bao', allowFiltering: false, allowSorting: false },
                                { fieldName: 'loaihinh_tb', headerText: 'Loại hình', allowFiltering: false, allowSorting: false },
                                { fieldName: 'trangthai_tb', headerText: 'Trạng thái', allowFiltering: false, allowSorting: false },
                                { fieldName: 'diachi_ld', headerText: 'Địa chỉ LĐ', allowFiltering: false, allowSorting: false }
                              ],
                              keycol: 'DONVIQL_ID',
                              allowExit: false,
                              tieude: 'Các thuê bao tại địa chỉ ' + this.diachiLD.DIACHI,
                              tieudebang: 'Địa chỉ: ' + this.diachiLD.DIACHI
                            }
                          })
                          this.ShowPopupQueue()
                          // this.popupComponent = ()=>import('./Popups/popupChonGrid');
                          // this.popupComponentName = "popupTrungDC";
                          // this.popupComponentData = {"ds":dlist,cols:[
                          //   {fieldName: 'ma_tb', headerText: 'Số máy/Account', allowFiltering: false, allowSorting: false},
                          //   {fieldName: 'ten_tb', headerText: 'Tên thuê bao', allowFiltering: false, allowSorting: false},
                          //   {fieldName: 'loaihinh_tb', headerText: 'Loại hình', allowFiltering: false, allowSorting: false},
                          //   {fieldName: 'trangthai_tb', headerText: 'Trạng thái', allowFiltering: false, allowSorting: false},
                          //   {fieldName: 'diachi_ld', headerText: 'Địa chỉ LĐ', allowFiltering: false, allowSorting: false},
                          // ],keycol: "DONVIQL_ID",allowExit:false,tieude:"Các thuê bao tại địa chỉ "+this.diachiLD.DIACHI,tieudebang:"Địa chỉ: "+this.diachiLD.DIACHI,}
                          // this.Popup('popupComponents');
                        }
                      })
                  }
                }
              })
          } catch (ex) {
            this.$toast.error(ex + '')
            if (this.debug) console.error(ex)
          } finally {
            this.loading(false)
          }
        }
      },
      deep: true
    },
    'listbox.doituong.value': async function(val, oldval) {
      if (!(val != oldval && val > 0)) return
      if (!this.watcherActive || !val || val <= 0) return
      await this.LoadMucCuocTB()
      await this.HT_DS_KhuyenMai_Combobox()
      this.watchLock = false;
    },
    'listbox.loaihinh_tb.value': async function(val, oldval) {
      if (!(val != oldval && val > 0)) return
      this.ResetThueBao()
      for (var item in this.kmld) {
        this.kmld[item] = 0
      }
      // JSON.stringify(this.kmld),

      if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES || this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC)
      if (!this.listbox.cboLoaiTB.value) this.listbox.cboLoaiTB.value = this.listbox.cboLoaiTB.list.find(x=>x.thietbidc_id==1000)?1000:null
        else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) if (!this.listbox.loai_tb.valuemgwan) this.listbox.loai_tb.valuemgwan = 1000 //bangts.HT_COMBOBOX(cboLoaiTBiWan, new BangTuDienFacade().Lay_ds_thietbi_dc_lhtb(loaitb_id, 2).Tables[0], "ten_tbi", "thietbidc_id");

      // comment lai do khi load du lieu, phan nay de vao du lieu cu!
      this.thuebao.adsl.txtAccountADSL = ''
      this.thuebao.adsl.txtEmailAdsl = ''
      if (this.listbox.dichvu_vt.value == DichVuVienThong.IMS_DOITAC) this.thuebao.ims.txtMaTBIMS = ''
      if (this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC) this.thuebao.mgwan.somay = ''
      if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC) this.thuebao.tsl.txtMaTSL.Text = ''
      await this.HT_GIAODIEN_DONVI()
      // this.LoadMucCuocTB();
      this.chkLuongGiuKenh = false
      this.m_dsTienCTKM = []
      if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES || this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC) {
        this.loading(true)
        try {
          await API.post_sp_lay_ds_thietbi_dc_lhtb(this.axios, { kieu: 1, loaitb_id: val }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              this.listbox.cboLoaiTB.list = response.data.data
              if (!this.listbox.cboLoaiTB.value)
                if (this.listbox.cboLoaiTB.list && this.listbox.cboLoaiTB.list.length > 0 && this.listbox.cboLoaiTB.list.find((x) => x.thietbidc_id == 1000)) this.listbox.cboLoaiTB.value = 1000
                else {
                  //this.listbox.cboLoaiTB.value = null // set mặc định NULL theo yêu cầu của HPG
                  if (this.listbox.cboLoaiTB.list && this.listbox.cboLoaiTB.list.length > 0 && this.listbox.cboLoaiTB.list.filter((x) => x.thietbidc_id > 0).length > 0)
                    if (!this.listbox.cboLoaiTB.value || (this.listbox.cboLoaiTB.value && !this.listbox.cboLoaiTB.list.filter((x) => x.thietbidc_id > 0).find((x) => x.thietbidc_id == this.listbox.cboLoaiTB.value)))
                      this.listbox.cboLoaiTB.value = this.listbox.cboLoaiTB.list.filter((x) => x.thietbidc_id > 0)[0].thietbidc_id
                }
            }
          })
        } catch (ex) {
          this.$toast.error('' + ex)
          if (this.debug) console.error(ex)
        } finally {
          this.loading(false)
        }
      }
      if (!this.watcherActive || !val || val <= 0) return
      // else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC) {
      //   this.loading(true);
      //   try {
      //     await API.post_sp_lay_ds_thietbi_dc_lhtb(this.axios, { "kieu": 2, "loaitb_id": val }).then(
      //     (response) => {
      //       if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //         this.listbox.loai_tb.listmgwan = response.data.data;
      //         if(!this.listbox.loai_tb.valuemgwan)
      //           if(this.listbox.loai_tb.listmgwan && this.listbox.loai_tb.listmgwan.length>0 && this.listbox.loai_tb.listmgwan.find(x=>x.thietbidc_id==1000))
      //           this.listbox.loai_tb.valuemgwan = 1000;
      //           else this.listbox.loai_tb.valuemgwan = null; // set mặc định NULL theo yêu cầu của HPG
      //         // if(this.listbox.cboLoaiTB.list && this.listbox.cboLoaiTB.list.length>0 && this.listbox.cboLoaiTB.list.filter(x=>x.thietbidc_id>0).length>0)
      //         //     this.listbox.cboLoaiTB.value = this.listbox.cboLoaiTB.list.filter(x=>x.thietbidc_id>0)[0].thietbidc_id;
      //       }
      //     });
      //   } catch(ex) { this.$toast.error("" + ex); if(this.debug) console.error(ex); }
      //   finally { this.loading(false); }
      // }
      await this.GiaoDien_DichVuVT(this.listbox.dichvu_vt.value * 1)
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.CAPQUANG_TRANG_TSL) this.thuebao.tsl.txtSoSoiQuang_Enabled = true
      else this.thuebao.tsl.txtSoSoiQuang_Enabled = false
      if (this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG) {
        await API.post_sp_ht_goicuoc_dd(this.axios, { loaitb_id: val }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            this.thuebao.didong.cboGoiCuocDD.list = response.data.data
            if (this.thuebao.didong.cboGoiCuocDD.list && this.thuebao.didong.cboGoiCuocDD.list.length > 0) this.thuebao.didong.cboGoiCuocDD.value = this.thuebao.didong.cboGoiCuocDD.list[0].goicuoc_id
          }
        })
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRATRUOC) {
          // vuth update fix 1509
          //cboGoiCuocDD.Enabled = false;
        } else {
          this.thuebao.didong.cboGoiCuocDD.value = GOICUOC_DD.POSTPAID
        }
      }

      // TODO tam bo qua doan 23132 - 23198, chi bat tat giao dien -> chua xu ly
      if (
        val == LoaiHinhTB.KTR_DOICAP_DONG ||
        val == LoaiHinhTB.KTR_DOICAP_QUANG ||
        val == LoaiHinhTB.KTR_Leasedline_E1 ||
        val == LoaiHinhTB.KTR_Leasedline_FE ||
        val == LoaiHinhTB.KTR_Leasedline_GE ||
        val == LoaiHinhTB.KTR_Leasedline_nx64k ||
        val == LoaiHinhTB.KTR_Leasedline_STM1 ||
        val == LoaiHinhTB.KTR_Nail_up ||
        val == LoaiHinhTB.KTR_TRUCTHONG_DONG ||
        val == LoaiHinhTB.KTR_TRUCTHONG_QUANG
      ) {
        this.chkLuongGiuKenh = true
      }
      this.LoadGoiCuocADSL()

      if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
        await this.SinhMaDVVT()
      }

      // if(!this.watcherActive)
      //HungHM - 31/08/2010 - Bổ xung ngày hết hạn đặt chỗ ( chỉ ADSL, Internet 126x, ADSL mới hiện lên)
      if (val == LoaiHinhTB.INTERNET_1260 || val == LoaiHinhTB.INTERNET_ADSL || val == LoaiHinhTB.INTERNET_FTTH || val == LoaiHinhTB.WIFI_FIBER || val == LoaiHinhTB.MEGA_IOT || val == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC || val == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC) {
        this.thuebao.adsl.dtpHanDatCho_Visible = true
        this.thuebao.adsl.btnKiemTraAccount_visible = true
      } else {
        this.thuebao.adsl.dtpHanDatCho_Visible = false
        this.thuebao.adsl.btnKiemTraAccount_visible = false
      }

      //HungHM - 05/08/2010 - Sinh mã MyTV
      this.thuebao.adsl.txtAccountADSL_ReadOnly = false
      if (
        (this.thuebao.adsl.txtAccountADSL+'').trim().length == 0 &&
        (val == LoaiHinhTB.INTERNET_MYTV || val == LoaiHinhTB.INTERNET_MYTV_B2B || val == LoaiHinhTB.HTVC_FIBERVNN_ANALOG || val == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL || val == LoaiHinhTB.WIFI_MESH || val == LoaiHinhTB.INDOOR_CAM || val == LoaiHinhTB.OUTDOOR_CAM)
      )
        await this.SinhMaDVVT()

      await this.LoadMucCuocTB()

      // ///TuanNA: Thêm code lấy thông tin cước thuê kênh, thuê cổng đối với thuê bao Megawan
      // ///Ngày 07.05.2012
      // if (dichvuvt_id == DichVuVienThong.MEGAWAN || dichvuvt_id == DichVuVienThong.TSL || dichvuvt_id == DichVuVienThong.METRONET
      //     || dichvuvt_id == DichVuVienThong.MGW_DOITAC || dichvuvt_id == DichVuVienThong.TSL_DOITAC)
      // {
      //     txtCuoc_ISP.Text = "0";
      //     txtCuoc_NIX.Text = "0";
      //     txtSoLuong_IP.Text = "0";
      //     txtCuoc_IP.Text = "0";

      //     if (loaitb_id == LoaiHinhTB.MGW_INTERNET_TRUCTIEP)
      //     {
      //         label38.Text = "Tốc độ tổng";
      //         cboPhanLoaiMGW.Enabled = true;
      //         cboPhanLoaiMGW.SelectedIndex = 0;
      //         cboPhanTachTD.Enabled = true;
      //         cboPhanTachTD.SelectedIndex = 0;

      //         cboTocDo.Enabled = true;
      //         cboTocDo.EditValue = 0;
      //         cboTocDo_PIR.Enabled = false;
      //         chkTocDo_PIR.Checked = false;
      //         cboTocDo_PIR.EditValue = 0;
      //         chkTocDo_PIR.Enabled = false;

      //         txtCuoc_ISP.Enabled = true;
      //         txtCuoc_NIX.Enabled = true;
      //         txtSoLuong_IP.Enabled = true;
      //         txtCuoc_IP.Enabled = true;
      //         //chkTocDo_ISP.Enabled = true;
      //         //chkTocDo_NIX.Enabled = true;

      //         if (Convert.ToInt32(cboPhanTachTD.SelectedValue) == 1)
      //         {
      //             chkTocDo_ISP.Enabled = true;
      //             chkTocDo_NIX.Enabled = true;

      //             cboTocDo_ISP.EditValue = 0;
      //             cboTocDo_NIX.EditValue = 0;
      //             cboTocDo_ISP.Text = "";
      //             cboTocDo_NIX.Text = "";

      //             txtCuoc_NIX.Text = "0";
      //             txtCuoc_ISP.Text = "0";
      //         }
      //         else
      //         {
      //             chkTocDo_ISP.Enabled = false;
      //             chkTocDo_NIX.Enabled = false;

      //             cboTocDo_ISP.EditValue = 0;
      //             cboTocDo_NIX.EditValue = 0;
      //             cboTocDo_ISP.Text = "";
      //             cboTocDo_NIX.Text = "";

      //             txtCuoc_NIX.Text = "0";
      //             txtCuoc_ISP.Text = "0";
      //         }

      //         //HienThi_CTK_NIX_ISP(2);
      //         //HienThi_CTK_NIX_ISP(3);
      //     }
      //     else
      //     {
      //         label38.Text = "Tốc độ CIR";
      //         cboPhanLoaiMGW.Enabled = false;
      //         cboPhanLoaiMGW.SelectedIndex = 0;
      //         cboPhanTachTD.Enabled = false;
      //         cboPhanTachTD.SelectedIndex = 0;

      //         cboTocDo.Enabled = true;
      //         cboTocDo.EditValue = 0;
      //         cboTocDo_PIR.Enabled = false;
      //         cboTocDo_PIR.EditValue = 0;
      //         chkTocDo_PIR.Enabled = true;
      //         chkTocDo_PIR.Checked = false;

      //         cboTocDo_ISP.Enabled = false;
      //         cboTocDo_NIX.Enabled = false;
      //         txtCuoc_ISP.Enabled = false;
      //         txtCuoc_NIX.Enabled = false;
      //         txtSoLuong_IP.Enabled = false;
      //         txtCuoc_IP.Enabled = false;
      //         chkTocDo_ISP.Enabled = false;
      //         chkTocDo_NIX.Enabled = false;
      //         chkTocDo_ISP.Checked = false;
      //         chkTocDo_NIX.Checked = false;

      //         cboTocDo_ISP.EditValue = 0;
      //         cboTocDo_NIX.EditValue = 0;
      //         cboTocDo_ISP.Text = "";
      //         cboTocDo_NIX.Text = "";

      //         txtCuoc_NIX.Text = "0";
      //         txtCuoc_ISP.Text = "0";
      //     }
      //     HienThi_CTK_CTC();
      // }

      this.LAY_DS_DVGT_MACDINH(this.listbox.loaihinh_tb.value)
      this.LAY_DS_DVK_MACDINH_TB(this.listbox.loaihinh_tb.value)

      // if (loaitb_id == LoaiHinhTB.INTERNET_MYTV || loaitb_id == LoaiHinhTB.INTERNET_MYTV_B2B)
      // {
      //     pnlMyTV.Visible = true;
      //     txtEmailAdsl.Enabled = false;
      // }
      // else
      // {
      //     pnlMyTV.Visible = false;
      //     txtEmailAdsl.Enabled = true;
      // }

      // if (loaitb_id == LoaiHinhTB.COSO_HATANG)
      //     pnlCSHT.Visible = true;
      // else
      //     pnlCSHT.Visible = false;

      // if (loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_ANALOG || loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL
      //     || loaitb_id == LoaiHinhTB.MEGACAMERA)
      // {
      //     pnlHTVC.Visible = true;
      //     txtEmailAdsl.Enabled = false;
      // }
      // else
      // {
      //     pnlHTVC.Visible = false;
      //     txtEmailAdsl.Enabled = true;
      // }

      // if (loaitb_id == LoaiHinhTB.FSECURE)
      // {
      //     pnlFsecure.Visible = true;
      //     txtEmailAdsl.Enabled = false;
      // }
      // else
      // {
      //     pnlFsecure.Visible = false;
      //     txtEmailAdsl.Enabled = true;
      // }

      // if (loaitb_id == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC || loaitb_id == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC)
      // {
      //     pnlFiber_TK.Visible = true;
      //     txtEmailAdsl.Enabled = false;
      // }
      // else
      // {
      //     pnlFiber_TK.Visible = false;
      //     txtEmailAdsl.Enabled = true;
      // }

      // if (loaitb_id == LoaiHinhTB.INTERNET_SGTV || loaitb_id == LoaiHinhTB.CAMERA_HOCDUONG)
      // {
      //     pnlDynamicInt.Top = pnlFTTH.Top + 5;
      // }
      // else if (loaitb_id == LoaiHinhTB.INTERNET_FTTH || loaitb_id == LoaiHinhTB.WIFI_FIBER || loaitb_id == LoaiHinhTB.INTERNET_ADSL
      //     || loaitb_id == LoaiHinhTB.INTERNET_MYTV || loaitb_id == LoaiHinhTB.INTERNET_MYTV_B2B || loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_ANALOG
      //     || loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL || loaitb_id == LoaiHinhTB.MEGACAMERA || loaitb_id == LoaiHinhTB.COSO_HATANG)
      // {
      //     pnlDynamicInt.Top = pnlMyTV.Top + pnlMyTV.Height + 2;
      // }
      // else if (loaitb_id == LoaiHinhTB.FSECURE || loaitb_id == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC || loaitb_id == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC)
      // {
      //     pnlDynamicInt.Top = pnlFsecure.Bottom + 2;
      // }

      // if (loaitb_id == LoaiHinhTB.INTERNET_FTTH || loaitb_id == LoaiHinhTB.WIFI_FIBER || loaitb_id == LoaiHinhTB.INTERNET_ADSL)
      // {
      //     txtTTCuoc.Enabled = false;
      //     pnlFTTH.Visible = true;
      // }
      // else
      // {
      //     pnlFTTH.Visible = false;
      // }
      if ([DichVuVienThong.ANTOAN_BAOMAT_TT, DichVuVienThong.DICHVU_CNTT, DichVuVienThong.TRUNGTAM_DULIEU, DichVuVienThong.HOINGHI_TRUYENHINH].indexOf(this.listbox.dichvu_vt.value * 1) >= 0) await this.LoadThongTin_DV_CNTT(val)
      // //ds_tien_khoanmuc = bangts.Lay_tienkhoanmuc_loaihd(LoaiHopDong.DAT_MOI);
      // DataTable dt = new DataTable();
      // dt = dsDanhMuc.Tables["TIEN_KM"].Copy();
      // dt.TableName = "danhsach";
      // ds_tien_khoanmuc.Tables.Remove("danhsach");
      // ds_tien_khoanmuc.Tables.Add(dt);
      // dt = null;
      this.m_dsTienCTKM = []
      if (!this.kt_load) this.LayTienTheoKhoanMuc()
      // dsCTM_TBI = new CT_MUA_TBI_DATA();
      // HT_ThietBi();
      // HT_DichVuGT();
      // dtiendatcoc_km = 0;
      // dtiendatcoc_tt = 0;
      // dtienkmld = 0;
      // dtienkmdc = 0;
      // dvatkmld = 0;
      // dvatkmdc = 0;
      // dsHDTB_CT = new List<HD_THUEBAO_CT>();
      // HienThiTienKhuyenMaiLapDat(dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt);

      // KT_GOI_CBO_LOAIHINH = false;

      // //Thực hiện theo SRV https://cntt.vnpt.vn/browse/VNPSR-11947
      this.thuebao.tgdungthu = 30
      //Thực hiện theo SRV https://cntt.vnpt.vn/browse/VNPSR-11947
      if (this.vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) {
        //Khách hàng doanh nghiệp và kiểm tra thời gian lập hợp đồng từ ngày 20/05/2020-30/06/2020
        if (new Date().getTime() >= new Date(2020, 5, 20).getTime() && new Date().getTime() <= new Date(2020, 6, 30).getTime() && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
          this.thuebao.tgdungthu = 60
        }
      }
      // if (dichvuvt_id == DichVuVienThong.ANTOAN_BAOMAT_TT || dichvuvt_id == DichVuVienThong.HOINGHI_TRUYENHINH
      //     || dichvuvt_id == DichVuVienThong.DICHVU_CNTT || dichvuvt_id == DichVuVienThong.TRUNGTAM_DULIEU)
      // {
      //     if ((((DataRow)((cboLoaihinhTB.SelectedItem as DataRowView).Row))["CHOPHEP_DT"] ?? "0").ToString() == "1")
      //     {
      //         txtTGDungThu.Text = ((DataRow)((cboLoaihinhTB.SelectedItem as DataRowView).Row))["SONGAY_DT"].ToString();
      //     }
      // }

      this.watchLock = false;
    },
    'listbox.trangbi.valuecd': function(val, oldval) {
      if (!(val != oldval && val > 0)) return
      if (!this.watcherActive) return
      this.LoadMucCuocTB()
    },
    NgayYeuCau: function() {
      if (!this.watcherActive) return
      this.LoadMucCuocTB()
    },
    'diachiBC.DIACHI': function(newval, oldval) {
      if (!(newval != oldval)) return
      if (newval) this.LoadNVThuCuoc()
    },
    'diachiTT.DIACHI': function(newval, oldval) {
      if (!(newval != oldval)) return
      if (newval) this.LoadNVThuCuoc()
    },
    'diachiKH.DIACHI': function(newval, oldval) {
      if (!(newval != oldval)) return
      if (newval) this.LoadNVThuCuoc()
    },
    // //'listbox.donvi_ql.value': function(oldval, newval) { this.LoadNVThuCuoc(); }, // xem lai vi khong logic, da chuyen data sang dong duoi
    'listbox.donvi_ql.valueql': function(newval, oldval) {
      if (!(newval != oldval && newval > 0)) return
      if (!this.watcherActive) return
      if (newval) this.LoadNVThuCuoc()
    },
    'listbox.donvi_ql.value': async function(newval, oldval) {
      if (!(newval != oldval && newval > 0)) return
      // if(!this.watcherActive) return;
      if (!newval) return
      let pdata = { donvi_ql_id: newval, loaidv_id: LOAI_DV.TRAM_VT }
      let api = cache.getters.getFromCache('post_sp_lay_ds_tram_thicong_theo_donvi', pdata)
      if (!api) api = API.post_sp_lay_ds_tram_thicong_theo_donvi(this.axios, pdata)
      else
        api = new Promise((resolve, reject) => {
          resolve(api)
        })
      await api.then((response) => {
        cache.dispatch('addToCache', { key: 'post_sp_lay_ds_tram_thicong_theo_donvi', subkey: pdata, data: response })
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
            if (this.DT_CONTROLS.list[i].LOAIDV_DICH_ID == LOAI_DV.TRAM_VT || this.DT_CONTROLS.list[i].LOAIDV_DICH_ID == LOAI_DV.TRAM_CAP_PORT) {
              this.DT_CONTROLS.data[i] = this.UpperCasePropertyList(response.data.data).filter((x) => x.DONVI_ID > 0)

              if (this.DT_CONTROLS.data[i] && this.DT_CONTROLS.data[i].length > 0) {
                let fdata = this.DT_CONTROLS.data[i].filter((x) => x.DONVI_ID == this.DT_CONTROLS.value[i] && x.DONVI_ID > 0)
                if (fdata && fdata.length > 0) this.DT_CONTROLS.value[i] = fdata[0]['DONVI_ID'] ? fdata[0]['DONVI_ID'] : fdata[1] ? fdata[1]['DONVI_ID'] : 0
                else this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0]['DONVI_ID'] ? this.DT_CONTROLS.data[i][0]['DONVI_ID'] : 0
                this.DT_CONTROLS.key += 1
              }
            }
            if (this.DT_CONTROLS.list[i].LOAIDV_DICH_ID == LOAI_DV.TTKD_NGHIEMTHU) this.DT_CONTROLS.value[i] = this.$root.token.getDonViID()
          }
        }
      })

      // for(var i=0;i<this.DT_CONTROLS.list.length;i++)
      // {
      //   if(this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID']==LOAI_DV.TRAM_VT ||this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID']==LOAI_DV.TRAM_CAP_PORT)
      //   await API.post_sp_lay_ds_tram_thicong_theo_donvi(this.axios, { "donvi_ql_id": newval, "loaidv_id": LOAI_DV.TRAM_VT }).then(
      //   (response) => {
      //     if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //       this.DT_CONTROLS.data[i] = this.UpperCasePropertyList(response.data.data).filter(x=>x.DONVI_ID>0);
      //       // if(!this.DT_CONTROLS.value[i] || this.DT_CONTROLS.value[i]<=0) {
      //       //   this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0]['DONVI_ID'];
      //       // } else {
      //         if(this.DT_CONTROLS.data[i] && this.DT_CONTROLS.data[i].length>0)
      //         if(this.DT_CONTROLS.value[i]) {
      //           let fdata = this.DT_CONTROLS.data[i].filter(x=>x.DONVI_ID==this.DT_CONTROLS.value[i] && x.DONVI_ID>0);
      //           if(fdata && fdata.length>0)
      //             this.DT_CONTROLS.value[i] = fdata[0]['DONVI_ID'];
      //           else
      //             this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0]['DONVI_ID'];
      //         } else
      //           this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0]['DONVI_ID'];
      //       // }
      //       this.DT_CONTROLS.key += 1;
      //     }
      //   });
      // }
    },

    'filterbox.tratruoc.ischecked': function(val) {
      if (!this.watcherActive) return
      if (this.filterbox.tratruoc.list && this.filterbox.tratruoc.list.length > 0) {
        if (!this.filterbox.tratruoc.value || this.filterbox.tratruoc.value == 0 || !this.filterbox.tratruoc.list.find((x) => x.khuyenmai_id == this.filterbox.tratruoc.value)) this.filterbox.tratruoc.value = this.filterbox.tratruoc.list[0].khuyenmai_id //else this.filterbox.tratruoc.value=0;
      }
      if (this.m_dsTienCTKM) this.m_dsTienCTKM = this.m_dsTienCTKM.filter((x) => x.kieu != 1)
      if (!val) this.cboTraTruoc_SelectedValueChanged()
    },
    'filterbox.khuyenmai.ischecked': function(val) {
      if (!this.watcherActive) return
      if (this.filterbox.khuyenmai.list && this.filterbox.khuyenmai.list.length > 0)
        if (!this.filterbox.khuyenmai.value || this.filterbox.khuyenmai.value == 0 || !this.filterbox.khuyenmai.list.find((x) => x.khuyenmai_id == this.filterbox.khuyenmai.value)) this.filterbox.khuyenmai.value = this.filterbox.khuyenmai.list[0].khuyenmai_id //else this.filterbox.khuyenmai.value=0;
      if (!val) this.cboKhuyenMai_SelectedValueChanged()
    },

    'listbox.hinhthuc_tt.value': function(newval, oldval) {
      if (!(newval != oldval && newval > 0)) return
      if (!this.watcherActive) return
      if (newval) this.LoadNVThuCuoc()
    },

    DiaChiTTCLONE: {
      handler: function(oldval, newval) {
        //Đảo ngược do code bên dưới bị ngược
        // ### recent
        if (!this.watcherActive) return
        let checkOld = oldval
        let checkNew = newval
        delete checkOld.DIACHI
        delete checkNew.DIACHI
        if (JSON.stringify(checkOld) == JSON.stringify(checkNew)) return
        let pdata = {
          DONVIQL_HTTT: this.DONVIQL_HTTT,
          TINH_ID: oldval.TINH_ID,
          DACDIEM_ID: oldval.DACDIEM_ID ? oldval.DACDIEM_ID : 0,
          QUAN_ID: oldval.QUAN_ID,
          PHUONG_ID: oldval.PHUONG_ID,
          PHO_ID: oldval.PHO_ID ? oldval.PHO_ID : 0,
          AP_ID: oldval.AP_ID ? oldval.AP_ID : 0,
          KHU_ID: oldval.KHU_ID ? oldval.KHU_ID : 0,
          LOAIKH_ID: this.listbox.loai_kh.value,
          HTTT_ID: this.listbox.hinhthuc_tt.value,
          PHANTAP_KH: this.PHANTAP_KH,
          TINHTT_ID: newval.TINH_ID,
          QUANTT_ID: newval.QUAN_ID,
          PHUONGTT_ID: newval.PHUONG_ID,
          DACDIEMTT_ID: newval.DACDIEM_ID ? newval.DACDIEM_ID : 0,
          PHOTT_ID: newval.PHO_ID ? newval.PHO_ID : 0,
          APTT_ID: newval.AP_ID ? newval.AP_ID : 0,
          KHUTT_ID: newval.KHU_ID ? newval.KHU_ID : 0,
          KHACHHANG_ID: this.khachhang.khachhang_id,
          NGANHNGHELOC: this.listbox.nganhngheloc.value,
          COUNT_DVI_QL_ID: this.listbox.donvi_ql.list.length
        }
        API.post_fn_lay_tt_diachi_thanhtoan(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] == -2 && apidata['RESULT']['DS_DVI']) {
              // case nay xu ly ben duoi!
            } else if (apidata['ERROR_CODE'] != 1 && apidata['ERROR_CODE'] != -99) {
              this.$toast.error(apidata['MESSAGE'])
              return
            }
            if (apidata['RESULT']) apidata = apidata['RESULT']
            if (apidata['DS_DVI']) this.XuLyDonViQL(apidata['DS_DVI'])
            if (apidata['DONVQL_ID'] && apidata['DONVQL_ID'] * 1 > 0) this.listbox.donvi_ql.valueql = apidata['DONVQL_ID'] * 1
          }
        })
      },
      deep: true
    },

    'listbox.loai_kh.value': async function(newval, oldval) {
      if (!(newval != oldval && newval > 0)) return
      try {
        if (newval == -1) return
        let drPLKH = this.dtPhanLoaiKH.filter((x) => x.loaikh_id == newval)
        if (this.nhomplkh <= 1) {
          //chỉ thay đổi nếu nhóm pl là ko theo doanh thu
          this.PHANLOAIKH_ID = 0
          this.khachhang.plkh = ''
          this.vkieukh_id_ = 0
          let kieukh_id = 0
          let kieukh = ''

          kieukh = this.listbox.loai_kh.list.filter((x) => x.loaikh_id == newval)[0]['loai'] //.Select("LOAIKH_ID=" + cboLoaiKH.EditValue)[0]["LOAI"];
          if (kieukh) {
            this.vkieukh_id_ = kieukh
            kieukh_id = kieukh
          }

          if (drPLKH.length > 0) {
            this.PHANLOAIKH_ID = drPLKH[0]['phanloaikh_id']
            this.khachhang.plkh = drPLKH[0]['ma_plkh']
          } else {
            if (kieukh_id == KIEU_KH.CA_NHAN) {
              let dr_PLKH = this.listbox.phanloai_kh.list.filter((x) => x.hienthi_md == PHANLOAI_KH.CA_NHAN) //dsDanhMuc.Tables["PHANLOAI_KH"].Select("hienthi_md = " + PHANLOAI_KH.CA_NHAN);
              if (dr_PLKH.length > 0) {
                this.PHANLOAIKH_ID = dr_PLKH[0]['phanloaikh_id']
                this.khachhang.plkh = dr_PLKH[0]['ma_plkh']
              }
            } else {
              let dr_PLKH = this.listbox.phanloai_kh.list.filter((x) => x.hienthi_md == PHANLOAI_KH.DOANH_NGHIEP)
              if (dr_PLKH.length > 0) {
                this.PHANLOAIKH_ID = dr_PLKH[0]['phanloaikh_id'] ? dr_PLKH[0]['phanloaikh_id'] * 1 : 0
                this.khachhang.plkh = dr_PLKH[0]['ma_plkh']
              }
            }
          }
        } else {
          //region Kiểm tra mã ngân sách
          let kieukh = this.listbox.loai_kh.list.filter((x) => x.loaikh_id == newval)[0]['loai'] //.Select("LOAIKH_ID=" + cboLoaiKH.EditValue)[0]["LOAI"];
          if (kieukh) this.vkieukh_id_ = kieukh
        }
        this.thuebao.tgdungthu = 30
        //Thực hiện theo SRV https://cntt.vnpt.vn/browse/VNPSR-11947
        if (this.vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) {
          //Khách hàng doanh nghiệp và kiểm tra thời gian lập hợp đồng từ ngày 20/05/2020-30/06/2020
          if (new Date().getTime() >= new Date(2020, 5, 20).getTime() && new Date().getTime() <= new Date(2020, 6, 30).getTime() && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
            this.thuebao.tgdungthu = 60
          }
        }

        if (!this.watcherActive) return

        // hoangpkn : 25/10/2017 Thêm nhân viên quản lý
        let pdata = {
          ds_para: JSON.stringify({
            PHANTAP_KH: this.PHANTAP_KH,
            DICHVUVT_ID: this.listbox.dichvu_vt.value,
            LOAIKH_ID: this.listbox.loai_kh.value,
            PHUONGTT_ID: this.diachiTT.PHUONG_ID ? this.diachiTT.PHUONG_ID : 0,
            PHOTT_ID: this.diachiTT.PHO_ID ? this.diachiTT.PHO_ID : 0,
            APTT_ID: this.diachiTT.AP_ID ? this.diachiTT.AP_ID : 0,
            KHUTT_ID: this.diachiTT.KHU_ID ? this.diachiTT.KHU_ID : 0,
            DONVIQL_HTTT: this.DONVIQL_HTTT,
            HTTT_ID: this.listbox.hinhthuc_tt.value,
            KHACHHANG_ID: this.khachhang.khachhang_id,
            DACDIEMTT_ID: this.diachiTT.DACDIEM_ID ? this.diachiTT.DACDIEM_ID : 0,
            CBO_DVIQL_COUNT: 1,
            NGANHNGHELOC_ID: this.listbox.nganhngheloc.value,
            DOITUONG_ID: this.listbox.doituong.value
          })
        } //CBO_DVIQL_COUNT la dem so luong item con trong combobox, vi so luong luon >0 nen de default 1
        await API.post_fn_lay_tt_combo_loaikh(this.axios, pdata).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let apidata = JSON.parse(response.data.data)
            if (apidata['RESULT']) apidata = apidata['RESULT']
            // Doan nay xu ly cho dong 31562-31567, dieu kien cho DichVuVienThong.DI_DONG
            if (apidata['DOITUONG_NEO'] && apidata['DOITUONG_NEO'].length > 0) {
              this.thuebao.didong.cboDTVinaPhone.list = apidata['DOITUONG_NEO']
              this.thuebao.didong.cboDTVinaPhone.value = this.thuebao.didong.cboDTVinaPhone.list[0]['DOITUONG_ID_NEO']
            }
            if (apidata['DONVQL_ID']) this.listbox.donvi_ql.valueql = apidata['DONVQL_ID']
            if (apidata['DS_CT_KM']) this.dsKM_HDTB = apidata['DS_CT_KM']
            if (apidata['DS_DVI']) this.XuLyDonViQL(apidata['DS_DVI'])
          }
        })
        if (this.diachiTT.PHUONG_ID != 0 && (this.diachiTT.PHO_ID != 0 || this.diachiTT.AP_ID != 0 || this.diachiTT.KHU_ID != 0)) {
          this.LoadNVThuCuoc()
          // HT_NVTC_TheoDC(quantt_id, phuongtt_id, phott_id, aptt_id, khutt_id, Convert.ToInt32(cboDonViQL.SelectedValue), dacdiemtt_id); //Tuong duong ham tren

          if (this.DONVIQL_HTTT == 1) this.HienThi_NVQL_AM_HTTT()
          else this.HienThi_NVQL_AM()
        }

        // #region Lấy chi tiết khuyến mại dùng thử fill vào khuyenmai_hdtb
        if (this.listbox.loai_kh.value != -1) {
          if (this.listbox.doituong.value == DUNG_THU.DOITUONG_TB) {
            let dsTemp = []
            await API.post_lay_chitiet_km_dungthu_v2(this.axios, { vloaikh_id: this.listbox.loai_kh.value }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                dsTemp = response.data.data
              }
            })

            if (dsTemp.length > 0) {
              if (dsTemp[0]['khuyenmai_id']) {
                this.filterbox.khuyenmai.value = dsTemp[0]['khuyenmai_id']
                this.filterbox.khuyenmai.ischecked = true
              } else this.filterbox.khuyenmai.ischecked = false
              // DateTime tmp;
              var ithang_huongdc = 0,
                ithang_huongkm = 0,
                ithang_tg = 0
              let dtiendatcoc_csd = 0,
                dtien_td = 0
              this.dsKM_HDTB = []

              for (var i = 0; i < dsTemp.length; i++) {
                ithang_huongdc = 0
                ithang_huongkm = 0
                ithang_tg = 0
                dtiendatcoc_csd = 0
                dtien_td = 0
                let dr = {}
                if (dsTemp[i]['huong_dc']) ithang_huongdc = dsTemp[i]['huong_dc']
                if (dsTemp[i]['huong_km']) ithang_huongkm = dsTemp[i]['huong_km']
                if (dsTemp[i]['sothang_tg']) ithang_tg = dsTemp[i]['sothang_tg']
                if (dsTemp[i]['datcoc_csd']) dtiendatcoc_csd = dsTemp[i]['datcoc_csd']
                if (dsTemp[i]['tien_td']) dtien_td = dsTemp[i]['tien_td']
                dr.THANG_HUONGDC = ithang_huongdc
                dr.THANG_HUONGKM = ithang_huongkm
                dr.SOTHANG_TG = ithang_tg
                dr.DATCOC_CSD = dtiendatcoc_csd
                dr.TIEN_TD = dtien_td

                if (dsTemp[i]['kieu_bdkm'] == '3') {
                  try {
                    let tmp = moment(dsTemp[i]['thang_bd'], 'YYYYMM')
                      .add(ithang_huongkm, 'M')
                      .format('YYYYMM')
                    dr.THANG_BD = dsTemp[i]['thang_bd']
                    dr.THANG_KT = tmp
                  } catch (ex) {}
                }
                if (dsTemp[i]['kieu_bdtg'] == '3') {
                  try {
                    let tmp = moment(dsTemp[i]['thang_bdtg'], 'YYYYMM')
                      .add(ithang_tg, 'M')
                      .format('YYYYMM')
                    dr.THANG_BDTG = dsTemp[i]['thang_bdtg']
                    dr.THANG_KTTG = tmp
                  } catch (ex) {}
                }
                if (dsTemp[i]['kieu_bddc'] == '3') {
                  try {
                    let tmp = moment(dsTemp[i]['thang_bddc'], 'YYYYMM')
                      .add(ithang_huongkm, 'M')
                      .format('YYYYMM')
                    dr.THANG_BDDC = dsTemp[i]['thang_bddc']
                    dr.THANG_KTDC = tmp
                  } catch (ex) {}
                }
                //longdx: bổ sung thông tin tỷ lệ km
                dr.TYLE_KMLD = dsTemp[i]['tyle_kmld']
                dr.TYLE_SD = dsTemp[i]['tyle_sd']
                dr.TYLE_TB = dsTemp[i]['tyle_tb']
                dr.HDTB_ID = this.hdtb_id //-1;
                dr.CHITIETKM_ID = dsTemp[i]['chitietkm_id']
                dr.KHUYENMAI_ID = dsTemp[i]['khuyenmai_id']
                //dr.KHUYENMAI_ID_NEO = dsTemp[i]["khuyenmai_id_neo"];
                dr.KIEU_YC = 1
                this.dsKM_HDTB.push(dr)

                //Lấy tiền khuyến mại
                if (this.kmld.tien_kmld < dsTemp[i]['tien_kmld']) this.kmld.tien_kmld = dsTemp[i]['tien_kmld']
                if (this.kmld.vat_kmld < dsTemp[i]['vat_kmld']) this.kmld.vat_kmld = dsTemp[i]['vat_kmld']
                if (this.kmld.tyle_kmld < dsTemp[i]['tyle_kmld']) this.kmld.tyle_kmld = dsTemp[i]['tyle_kmld']

                if (this.kmld.tien_datcoc < dsTemp[i]['datcoc_csd']) this.kmld.tien_datcoc = dsTemp[i]['datcoc_csd']
              }
            }
          }
        }
        // #endregion
      } catch (ex) {
        let dsPL = this.listbox.phanloai_kh.list.filter((x) => x.hienthi_md == PHANLOAI_KH.CA_NHAN)
        if (dsPL && dsPL.length > 0) {
          this.PHANLOAIKH_ID = dsPL[0]['phanloaikh_id']
          this.khachhang.plkh = dsPL[0]['ma_plkh']
        }
      }
      finally {
        this.watchLock = false;
      }
    },

    'listbox.kieu_ld.value': function(newval, oldval) {
      if (!(newval != oldval && newval > 0)) return
      this.thuebao.mgwan.madoicap = null;
      this.thuebao.mgwan.matn = null;
      this.HT_GIAODIEN_DONVI()
      if (!this.watcherActive) return
      this.defaultCongNghe(newval)

      //TODO can lam them o function cboKieuLD_SelectedValueChanged

      // tiep tu line 21982
      if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH || this.listbox.dichvu_vt.value == DichVuVienThong.GPHONE || this.listbox.dichvu_vt.value == DichVuVienThong.IMS || this.listbox.dichvu_vt.value == DichVuVienThong.IMS_DOITAC) this.tocdo_id = 0
      if (!this.kt_load) {
        this.LayTienTheoKhoanMuc()
        if (this.listbox.doituong.value != DUNG_THU.DOITUONG_TB) this.HT_DS_KhuyenMai_Combobox()
        // this.HT_GIAODIEN_DONVI();
      }
      if (this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT
          || this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT
          || this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU
          || this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH) {
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.Voice_Brandname) {
          for (var i = this.ItemList.length - 1; i >= 0; i--) {

            if (this.ItemList[i].sFieldName == "TOCDO_ID") {
              var filter_kieuld = this.ItemList[i].SqlData;
              if (newval == 14069 || newval == 14070 || newval == 19543)/*đối tượng 3*/ {
                filter_kieuld = this.ItemList[i].SqlData.filter(x => x["THUONGHIEU"].includes('Đối tượng 3'));
              } else if (newval == 14052)/*đối tượng 2*/ {
                filter_kieuld = this.ItemList[i].SqlData.filter(x => x["THUONGHIEU"].includes('Đối tượng 2'));
              }
              else if (newval == 14051)/*đối tượng 1*/ {
                filter_kieuld = this.ItemList[i].SqlData.filter(x => x["THUONGHIEU"].includes('Đối tượng 1'));
              }
              this.gridEditors[i].DataSource = filter_kieuld.map((x) => ({ text: x[this.ItemList[i].sLookUpValueField], id: x[this.ItemList[i].sLookUpKeyField] }));
            }
            if (this.ItemList[i].sFieldName == "DONVIKG_ID") {
              var filter_kieuld = this.ItemList[i].SqlData;
              if (newval == 14069 || newval == 14070 || newval == 19543)/*đối tượng 3*/ {
                filter_kieuld = this.ItemList[i].SqlData.filter(x => x["TEN_DV"].includes('AArenet') || x["TEN_DV"].includes('vIMS'));
              } else if (newval == 14052)/*đối tượng 2*/ {
                filter_kieuld = this.ItemList[i].SqlData.filter(x => x["TEN_DV"].includes('Voice_brn'));
              }
              else if (newval == 14051)/*đối tượng 1*/ {
                filter_kieuld = this.ItemList[i].SqlData.filter(x => x["TEN_DV"].includes('MEG') || x["TEN_DV"].includes('VCC'));
              }
              this.gridEditors[i].DataSource = filter_kieuld.map((x) => ({ text: x[this.ItemList[i].sLookUpValueField], id: x[this.ItemList[i].sLookUpKeyField] }));
            }

            if (!(this.ItemList[i].sFieldName == "DUNGTHU"
              || this.ItemList[i].sFieldName == "THIETBI"
              || this.ItemList[i].sFieldName == "MA_DV"
              || this.ItemList[i].sFieldName == "DINHTUYEN"))
            {
            } else if (newval == 14052 || newval == 14051)/*đối tượng 1, 2*/ {
              this.gridEditors[i].show = false;
              // this.ItemList[i].hidden = true;
            }
          }
        }
      }

      this.watchLock = false;

    },

    buttonSet: async function(newval, oldval) {
      switch (newval) {
        case -1:
          this.filterbox.ctv.ischecked = false
          this.filterbox.nguoigt.ischecked = false
          this.listbox.madaidien.value = 0
          this.listbox.madaidien.list = []
          this.buttons.tsbtnGhiLai = true
          this.buttons.tsbtnHuyBo = true
          break
        case 0:
          if (!this.watcherActive) return
          var ctab = this.currentTab + ''
          this.watcherActive = false
          Object.assign(this.$data, this.$options.data.call(this))
          this.buttonSet = 0
          await this.FormLoad()
          // this.buttons.tsbtnNhapMoi = true;
          this.loading(true)
          setTimeout(() => {
            this.loading(false)
            this.buttons.tsbtnNhapMoi = true
          }, 3000)
          // this.currentTab = ctab;
          this.$refs[ctab == 'all' ? 'tab1' : ctab].click()
          break
        case 1:
          if (!this.watcherActive) return
          this.buttons.tsbtnNhapMoi = false
          var ctab = this.currentTab + ''
          this.watcherActive = false
          Object.assign(this.$data, this.$options.data.call(this))
          this.buttonSet = 1
          await this.FormLoad()
          this.buttons.tsbtnGhiLai = true
          this.buttons.tsbtnHuyBo = true
          this.buttons.tsbtnThemTT = false
          this.buttons.tsbtnXoaTT = false
          // this.currentTab = ctab;
          this.$refs[ctab == 'all' ? 'tab1' : ctab].click()
          break
        case 2: // Nut huy 18281
          if (!this.watcherActive) return
          this.watcherActive = false
          Object.assign(this.$data, this.$options.data.call(this))
          this.buttonSet = 2
          this.FormLoad()
          this.buttons.tsbtnNhapMoi = true
          this.buttons.tsbtnXoa = true
          break
        case 3: // Nut edit
          this.buttons.tsbtnNhapMoi = true
          this.buttons.tsbtnXoa = true
          this.buttons.tsbtnGhiLai = true
          this.buttons.tsbtnHuyBo = true
          this.buttons.tsbtnXoaTB = true
          this.buttons.tsbtnThemTB = true
          this.buttons.tsbtnThanhToan = true
          this.buttons.inPhụLụcToolStripMenuItem = false
          break
        case 4:
          this.buttons.tsbtnGhiLai = true
          this.buttons.tsbtnHuyBo = true
          break
      }
    },
    'listbox.dichvu_vt.value': async function(newval, oldval) {
      this.dsCTM_TBI = []
      this.lvMuaThietbi.list = []
      this.lvDvkhac.list = []
      this.dsDK_DVK_TB = []
      this.trangbi_id = 0
      // if(!this.watcherActive) return; //FIXME bỏ vì nó gây mất dữ liệu combobox khi load từ mã giao dịch.
      if (!(newval != oldval && newval > 0)) return
      this.loading(true)
      try {
        if ([DichVuVienThong.MEGAWAN, DichVuVienThong.TSL, DichVuVienThong.METRONET, DichVuVienThong.MGW_DOITAC, DichVuVienThong.TSL_DOITAC, DichVuVienThong.NOIBO_DADIEM, DichVuVienThong.NOIBO_2DIEM].indexOf(parseInt(newval)) >= 0) {
          if (!this.kiemtra_dm_mgwan_tsl) {
            let daivt_id = this.listbox.donvi_ql.value
            await API.post_lay_danhmuc_lapmoi_mgw_tsl(this.axios, { vchuoi: 'LOAI_KENH|TOCDO_KENH|LOAI_CAP|THOIHAN|DOITAC|TINH_KN|LOAI_MD|TRAM_VT_DAU-donvi_id = ' + daivt_id + '|TRAM_VT_CUOI-donvi_id = ' + daivt_id }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.listbox.donvi_dau.list = response.data.data['tram_vt_dau']
                if (this.listbox.donvi_dau.list && this.listbox.donvi_dau.list.length > 0) this.listbox.donvi_dau.value = this.listbox.donvi_dau.list[0].donvi_id
                this.listbox.donvi_cuoi.list = response.data.data['tram_vt_cuoi']
                if (this.listbox.donvi_cuoi.list && this.listbox.donvi_cuoi.list.length > 0) this.listbox.donvi_cuoi.value = this.listbox.donvi_cuoi.list[0].donvi_id
                this.listbox.tinh_kn.list = response.data.data['tinh_kn']
                if (this.listbox.tinh_kn.list && this.listbox.tinh_kn.list.filter((x) => x.tinh_id > 0).length > 0) this.listbox.tinh_kn.value = this.listbox.tinh_kn.list.filter((x) => x.tinh_id > 0)[0].tinh_id
                try {
                  this.listbox.tinh_kn.value = this.$root.token.getPhanVungID()
                } catch (ex) {}
                this.listbox.loaikenh.list = response.data.data['loai_kenh']
                if (this.listbox.loaikenh.list && this.listbox.loaikenh.list.length > 0) {
                  this.listbox.loaikenh.value = this.listbox.loaikenh.list[0].loaikenh_id
                  this.listbox.loaikenh.valuetsl = this.listbox.loaikenh.list[0].loaikenh_id
                }
                this.listbox.tocdokenh.list = response.data.data['tocdo_kenh']
                if (this.listbox.tocdokenh.list && this.listbox.tocdokenh.list.length > 0) {
                  this.listbox.tocdokenh.value = this.listbox.tocdokenh.list[0].tocdo_id
                  this.listbox.tocdokenh.valuetsl = this.listbox.tocdokenh.list[0].tocdo_id
                }
                this.listbox.doitactsl.list = response.data.data['doitac']
                if (this.listbox.doitactsl.list && this.listbox.doitactsl.list.length > 0) this.listbox.doitactsl.value = this.listbox.doitactsl.list[0].doitac_id
                this.listbox.doitacwan.list = response.data.data['doitac']
                if (this.listbox.doitacwan.list && this.listbox.doitacwan.list.length > 0) this.listbox.doitacwan.value = this.listbox.doitacwan.list[0].doitac_id
                this.listbox.loaimodem.list = response.data.data['loai_md']
                if (this.listbox.loaimodem.list && this.listbox.loaimodem.list.length > 0) this.listbox.loaimodem.value = this.listbox.loaimodem.list[0].loaimd_id
                this.listbox.loaicap.list = response.data.data['loai_cap']
                if (this.listbox.loaicap.list && this.listbox.loaicap.list.length > 0) this.listbox.loaicap.value = this.listbox.loaicap.list[0].loaicap_id
              }
            })
            if (this.thamso_nguoidung.chuquanmd_id && this.thamso_nguoidung.chuquanmd_id > 0) {
              // Tham so nay khong lay duoc tu DB o thoi diem code do khong co du lieu (select * from admin.ct_tsmd where ma_ts='CHUQUAN_ID' and phanvung_id=26;)
              this.listbox.chu_quan.valuewan = this.thamso_nguoidung.chuquanmd_id
              this.listbox.chu_quan.valuetsl = this.thamso_nguoidung.chuquanmd_id
            }
            this.kiemtra_dm_mgwan_tsl = true

            //FORMLOAD default value
            if (this.listbox.phanloai_dv.list && this.listbox.phanloai_dv.list.filter((pl) => pl.loaitb_id == 134).length > 0) this.listbox.phanloai_dv.value = this.listbox.phanloai_dv.list.filter((pl) => pl.loaitb_id == 134)[0].phanloai_id
            if (this.listbox.loai_tb.list && this.listbox.loai_tb.list.filter((tb) => tb.dichvuvt_id == this.listbox.dichvu_vt.value).length > 0) this.listbox.loai_tb.valuemgwan = this.listbox.loai_tb.list.filter((tb) => tb.dichvuvt_id == this.listbox.dichvu_vt.value)[0].thietbidc_id
            this.loaisowan = 1
            this.buttons.btnHuongKNWan = this.loaisowan * 1 == LOAINODE_MGWAN.NODE_CHINH

            //if([DichVuVienThong.MEGAWAN, DichVuVienThong.METRONET, DichVuVienThong.MGW_DOITAC].indexOf(parseInt(newval))>=0)
          }
          //Default thuebao
          this.listbox.loaihinh_tb.value = LoaiHinhTB.MEGAWAN_ADSL // 23;
          this.listbox.kieu_ld.value = KieuLapDat.DM_MGW_DOCLAP // 42
          this.listbox.trangbi.valuewan = TRANGBI.VIENTHONG_TRANGBI //4
        }
        if (newval == DichVuVienThong.CO_DINH) {
          if (!this.kiemtra_dm_codinh) {
            this.kiemtra_dm_codinh = true
            if (this.thamso_nguoidung.chuquanmd_id && this.thamso_nguoidung.chuquanmd_id > 0) {
              this.listbox.chu_quan.valuecd = this.thamso_nguoidung.chuquanmd_id
              this.listbox.chu_quan.valuedlcd = this.thamso_nguoidung.chuquanmd_id
            }
          }
          //Default thuebao
          this.listbox.loaihinh_tb.value = LoaiHinhTB.DIENTHOAI_CD
          this.listbox.kieu_ld.value = KieuLapDat.DM_CODINH
        }
        if (newval == DichVuVienThong.IMS || newval == DichVuVienThong.IMS_DOITAC) {
          if (!this.kiemtra_dm_ims) {
            this.kiemtra_dm_ims = true
            if (this.thamso_nguoidung.chuquanmd_id && this.thamso_nguoidung.chuquanmd_id > 0) {
              this.listbox.chu_quan.valueims = this.thamso_nguoidung.chuquanmd_id
              this.listbox.chu_quan.valuedlims = this.thamso_nguoidung.chuquanmd_id
            }
          }
          //default thuebao
          this.listbox.loaihinh_tb.value = LoaiHinhTB.IMS_SIP //63
          this.listbox.kieu_ld.value = 224 //KieuLapDat.DM_CODINH;
        }
        if (newval == DichVuVienThong.TSL || newval == DichVuVienThong.NOIBO_2DIEM) {
          if (this.listbox.loai_tb.list && this.listbox.loai_tb.list.filter((tb) => tb.dichvuvt_id == this.listbox.dichvu_vt.value).length > 0) {
            this.listbox.loai_tb.valuedau = this.listbox.loai_tb.list.filter((tb) => tb.dichvuvt_id == this.listbox.dichvu_vt.value)[0].thietbidc_id
            this.listbox.loai_tb.valuecuoi = this.listbox.loai_tb.list.filter((tb) => tb.dichvuvt_id == this.listbox.dichvu_vt.value)[0].thietbidc_id
          }
          if (this.listbox.loaicap.list && this.listbox.loaicap.list.length > 0) {
            this.listbox.loaicap.valuedau = this.listbox.loaicap.list[0].loaicap_id
            this.listbox.loaicap.valuecuoi = this.listbox.loaicap.list[0].loaicap_id
          }
          //Default thuebao
          this.listbox.loaihinh_tb.value = 67
          this.listbox.kieu_ld.value = KieuLapDat.DM_TSL_LUONG // 48
        }
        if ([DichVuVienThong.ADSL, DichVuVienThong.MEGA_EYES, DichVuVienThong.HATANG_VIENTHONG, DichVuVienThong.BRCD_DOITAC].indexOf(parseInt(newval)) >= 0) {
          if (!this.kiemtra_dm_adsl) {
            this.kiemtra_dm_adsl = true
            await API.post_lay_danhmuc_lapmoi_internet(this.axios, { vchuoi: 'KIEUTRA|THANGTRA|MUCCUOC' }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.listbox.cboKieuTra.list = response.data.data['kieutra']
                if (this.listbox.cboKieuTra.list && this.listbox.cboKieuTra.list.length > 0) this.listbox.cboKieuTra.value = this.listbox.cboKieuTra.list[0].kieutra_id
                this.listbox.cboThangTra.list = response.data.data['thangtra']
                if (this.listbox.cboThangTra.list && this.listbox.cboThangTra.list.length > 0) this.listbox.cboThangTra.value = this.listbox.cboThangTra.list[0].thang_id
                this.listbox.muccuoc.list = response.data.data['muccuoc']
                if (this.listbox.muccuoc.list && this.listbox.muccuoc.list.length > 0) this.listbox.muccuoc.value = this.listbox.muccuoc.list[0].muccuoc_id
                if (this.thamso_nguoidung.chuquanmd_id && this.thamso_nguoidung.chuquanmd_id > 0) {
                  this.listbox.chu_quan.valueadsl = this.thamso_nguoidung.chuquanmd_id
                  this.listbox.chu_quan.valuedladsl = this.thamso_nguoidung.chuquanmd_id
                } else if (this.listbox.chu_quan.list && this.listbox.chu_quan.list.length > 0) {
                  this.listbox.chu_quan.valueadsl = this.listbox.chu_quan.list[0].chuquan_id
                  this.listbox.chu_quan.valuedladsl = this.listbox.chu_quan.list[0].chuquan_id
                }
              }
            })
          }
          //Default thuebao
          this.listbox.loaihinh_tb.value = LoaiHinhTB.INTERNET_FTTH // 58;
          this.listbox.kieu_ld.value = KieuLapDat.THUE_BAO_QUANG // 51
        }
        if (newval == DichVuVienThong.DI_DONG) {
          if (!this.kiemtra_dm_didong) {
            this.kiemtra_dm_didong = true
            this.listbox.chu_quan.valuedd = 11
          }
        }
        if (newval == DichVuVienThong.GPHONE) {
          if (!this.kiemtra_dm_gphone) {
            this.kiemtra_dm_gphone = true
            //this.listbox.chu_quan.valuegp = this.thamso_nguoidung.chuquanmd_id;
          }
        }

        switch (newval * 1) {
          case DichVuVienThong.ADSL:
          case DichVuVienThong.BRCD_DOITAC:
            this.tocdo_id = 0
            if (this.thuebao.adsl.ckTuCaiADSL) this.kh_cd = 1
            else this.kh_cd = 0
            if (this.listbox.cboLoaiTB.list && this.listbox.cboLoaiTB.list.length > 0) {
              if (this.listbox.cboLoaiTB.value && this.listbox.cboLoaiTB.value > 0) this.ltb_adsl_id = this.listbox.cboLoaiTB.value
              else this.ltb_adsl_id = 1
            } else this.ltb_adsl_id = 1
            this.trangbi_id = TRANGBI.VIENTHONG_TRANGBI
            this.listbox.trangbi.valueadsl = this.trangbi_id
            //if(this.listbox.loai)
            break
          case DichVuVienThong.IMS:
          case DichVuVienThong.IMS_DOITAC:
          case DichVuVienThong.CO_DINH: // Giong ÍMS nen gop
            this.tocdo_id = 0
            this.ltb_adsl_id = 1
            this.kh_cd = 0
            this.trangbi_id = TRANGBI.KHACHHANG_TU_TRANGBI //Khách hàng tự trang bị
            this.listbox.trangbi.valuecd = this.trangbi_id
            this.listbox.trangbi.valueims = this.trangbi_id
            break
          case DichVuVienThong.DI_DONG:
            {
              // int loaikh_id_neo = Convert.ToInt32(checkdata.MAP_ID("loaikh_id_neo", DatabaseConstants.DB2 + ".loai_kh", " where loaikh_id =" + cboLoaiKH.EditValue));
              // bangts.HT_DT_VinaPhone_Combobox(cboDTVinaPhone, loaikh_id_neo);
              //
              this.tocdo_id = 0
              this.ltb_adsl_id = 1
              this.kh_cd = 0
              this.trangbi_id = TRANGBI.KHACHHANG_TU_TRANGBI //Khách hàng tự trang bị
              this.listbox.trangbi.valuedd = TRANGBI.KHACHHANG_TU_TRANGBI
              //
            }
            break
          case DichVuVienThong.TSL:
          case DichVuVienThong.NOIBO_2DIEM:
            if (this.listbox.trangbi.list && this.listbox.trangbi.list.length > 0) this.listbox.trangbi.valuetsl = TRANGBI.VIENTHONG_TRANGBI

            if (this.listbox.tocdokenh.valuetsl && this.listbox.tocdokenh.valuetsl > 0) {
              this.tocdo_id = this.listbox.tocdokenh.valuetsl
              if (!this.kt_load) this.LayTienTheoKhoanMuc()
            } else this.tocdo_id = 0
            this.ltb_adsl_id = 1
            this.kh_cd = 0
            this.thuebao.cvlct = true
            break
          case DichVuVienThong.TSL_DOITAC:
            if (this.listbox.tocdokenh.valuetsl && this.listbox.tocdokenh.valuetsl > 0) {
              this.tocdo_id = this.listbox.tocdokenh.valuetsl
              if (!this.kt_load) this.LayTienTheoKhoanMuc()
            } else this.tocdo_id = 0
            this.ltb_adsl_id = 1
            this.kh_cd = 0
            this.thuebao.cvlct = false
            break
          case DichVuVienThong.MEGAWAN:
          case DichVuVienThong.METRONET:
          case  DichVuVienThong.NOIBO_DADIEM:
            if (this.listbox.loai_tb.list && this.listbox.loai_tb.list.length > 0) {
              if (this.listbox.loai_tb.valuemgwan && this.listbox.loai_tb.valuemgwan > 0) this.ltb_adsl_id = this.listbox.loai_tb.valuemgwan
              else this.ltb_adsl_id = 1
            } else this.ltb_adsl_id = 1

            this.kh_cd = 0
            if (this.listbox.trangbi.list && this.listbox.trangbi.list.length > 0) {
              this.trangbi_id = TRANGBI.VIENTHONG_TRANGBI
              this.listbox.trangbi.valuewan = this.trangbi_id
            }

            if (this.listbox.tocdokenh.valuecir && this.listbox.tocdokenh.valuecir > 0) {
              this.tocdo_id = this.listbox.tocdokenh.valuecir
              if (!this.kt_load) this.LayTienTheoKhoanMuc()
            } else this.tocdo_id = 0

            this.thuebao.cvlct = true
            break
          case DichVuVienThong.MGW_DOITAC:
            if (this.listbox.loai_tb.list && this.listbox.loai_tb.list.length > 0) {
              if (this.listbox.loai_tb.valuemgwan && this.listbox.loai_tb.valuemgwan > 0) this.ltb_adsl_id = this.listbox.loai_tb.valuemgwan
              else this.ltb_adsl_id = 1
            } else this.ltb_adsl_id = 1

            this.kh_cd = 0

            if (this.listbox.tocdokenh.valuecir && this.listbox.tocdokenh.valuecir > 0) {
              this.tocdo_id = this.listbox.tocdokenh.valuecir
              if (!this.kt_load) this.LayTienTheoKhoanMuc()
            } else this.tocdo_id = 0

            this.thuebao.cvlct = false
            break
        }
        this.LAY_DS_TBI_MACDINH(this.listbox.loaihinh_tb.value)
        let vetinh_id = ''
        let ppdata = { DICHVUVT_ID: this.listbox.dichvu_vt.value, PHOLD_ID: this.diachiLD.PHO_ID, PHUONGLD_ID: this.diachiLD.PHUONG_ID, LOAIKH_ID: this.listbox.loai_kh.value }
        await API.post_sp_lay_tt_theo_dvvt(this.axios, { ds_para: JSON.stringify(ppdata) }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let apid = JSON.parse(response.data.data)

            if (apid['ERROR_CODE'] != 1) {
              this.$toast.error(apid['MESSAGE'])
              return
            }
            apid = apid['RESULT']
            if (!apid) return
            if (apid['VETINH_ID']) vetinh_id = apid['VETINH_ID']
            if (apid['DOITUONG_NEO'] && apid['DOITUONG_NEO'].length > 0) {
              this.thuebao.didong.cboDTVinaPhone.list = apid['DOITUONG_NEO']
            } else this.thuebao.didong.cboDTVinaPhone.list = []
          }
        })
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      } finally {
        await this.HT_GIAODIEN_DONVI()
        await this.HT_DS_KhuyenMai_Combobox()
        this.loading(false)
        this.watchLock = false;
      }
    }
  },
  filters: {
    currency: function(value) {
      let valNum = parseInt((value + '').replaceAll(',', ''))
      if (valNum >= 0) return valNum.toLocaleString('en-En')
      return value
    }
  },
  data() {
    return {
      isLoadKH: false,
      watchLock: false,
      asyncLock: false,
      isTruocBH: false,
      frmTuVanMyTVCom: null,
      frmTuVanMyTVEvents: {
        onUpdate: this.tsbtnThanhToanHT_Click
      },
      popup: {
        popupToaNha: true,
        Thuebao_ToaNha: true,
        chonMegaWanIOTModal: true,
        frmNhapDSThanhVien: true,
        ThongTinUser: true,
        modalImportCA: true,
        dialogHDTB_SUB_V2: true,
        frmHDTB_SUB_V3: true,
        frmHDTB_SUB_V4: true,
        frmDangKyGoiDaDVLM: true,
        thongTinHenKhachHangModal: true,
        popupInBienBan: true
      },
      isShowThueBaoToaNha: false,
      // is_nv_vnpti: false,
      sinhma: false,
      txtStatus: '',
      dskmtt_loaitbi: [],
      PHAINHAP_VRF: false,
      popupQueue: [],
      popupQueueWhiteList: ['dlgTimKiemNVTC', 'popupComponents'],
      popupShowing: false,
      nvtcInput: {},
      dtPhanLoaiKH: [],
      console: console,
      currentTab: 'tab1',
      m_dsTienCTKM: [],
      kieu: 0,
      popupInBienBan_Param: {},
      tt_nd: {},
      debug: true,
      popupRetVal: null,
      IS_HD_TUVAN: false,
      watcherActive: false,
      mgw_mtn_ktr_hoa: false,
      LoaiHinhTB: LoaiHinhTB,
      KieuLapDat: KieuLapDat,
      DS_CHUQUAN_THEO_QUYEN: '',
      ItemList: [],
      ma_tb_ht: '',
      PhanLoai_ID: '0',
      LOAINODE_MGWAN: LOAINODE_MGWAN,
      popupComponent: null,
      popupComponentData: null,
      popupComponentAttr: {},
      popupComponentEvts: {
        'form-close': this.popupClosed,
        acceptChangeCTV: this.popupClosed,
        acceptChangeNGT: this.popupClosed,
        PopUpCongTacVien_Thoat: this.popupClosed
      },
      popupComponentName: '',
      ctv_id: 0,
      ma_tb: '',
      ma_tb_ao_ht_cuoi: '',
      ma_tb_ao_ht: '',
      hdkhtn_id: 0,
      Tag: '',
      iKieu: 0, //0: Lắp mới, 1: Sửa khuyến mại
      header: {
        title: 'Lắp đặt mới',
        list: [
          //{ name: 'Trang chủ', link: { name: 'Ui.cards' } },
          { name: 'Lập hợp đồng', link: { name: 'Ui.cards' } },
          { name: 'Lắp đặt mới', link: { name: 'Ui.cards' } }
        ]
      },
      // datatable: {
      //   dtPhanLoaiKH: [],
      // },
      thamsomacdinh: {},
      thamso_nguoidung: {
        chuquanmd_id: 0
      },
      DONGBO_TEST: { TEST: false },
      PHANTAP_KH: 0,
      DONVIQL_HTTT: 0,
      KHUVUC_THEO_KETCUOI: this.KHUVUC_THEO_KETCUOI,
      CHONSO_MOI: false,
      CHONSO_MOI_V2: false,
      kieuld_fsecure_kem_fiber: 0,
      hc_hdtb_id: 0,
      hc_tdtt_hdtb_id: 0,
      hdtb_id: 0,
      hdtt_id: 0, //TODO tim cach load hdtt_id
      ma_tb_ao: '',
      _sl_cha: 0,
      PHANLOAIKH_ID: -1,
      nhomplkh: 0,
      vkieukh_id_: 0, //biến toàn cục kiểm tra KH cá nhân hay doanh nghiệp
      nhap_tocdo_thuc_adsl: 0,
      ht_loc_cbo_tram: false,
      ht_khl: 0,
      loaisowan: 0,
      loaisoisdn: 1,
      kh_cd: 0,
      ltb_adsl_id: 1,
      kt_load: true,
      tocdo_id: 0,
      trangbi_id: 0,
      tocdo_cu_id: 0,
      tocdo_moi_id: 0,
      muccuoc_id: 0,
      kiemtra_dm_mgwan_tsl: false,
      kiemtra_dm_codinh: false,
      kiemtra_dm_ims: false,
      kiemtra_dm_adsl: false,
      kiemtra_dm_didong: false,
      kiemtra_dm_gphone: false,
      frmthuebao: '',
      DichVuVienThong: DichVuVienThong,
      ThoiHan: ThoiHan,
      buttons: {
        tsbtnXoa: false,
        tsbtnGhiLai: false,
        tsbtnHuyBo: false,
        tsbtnThanhToan: false,
        inPhụLụcToolStripMenuItem: false,
        tsbtnXoaTB: false,
        tsbtnThemTB: false,
        tsbtnThemTT: false,
        tsbtnXoaTT: false,
        btnChonSM: true,
        chkLapDatBS: false,
        btnThongTinKhac: false,
        btnChonSoIMS: true,
        btnHuongKNWan: false,
        tsbtnNhapMoi: false
      },
      diachikh_id: 0,
      diachitt_id: 0,
      diachibc_id: 0,
      diachitb_id: 0,
      diachild_id: 0,
      diachiKH: {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiHK: {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiNDD: {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiTT: {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiCT: {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiBC: {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiTB: {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiTBCu: {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiHKTBCu: {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiLD: {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null,
        LOAINHA_ID: 0,
        SOTANG: 0,
        SOPHONG: 0,
        DIENTICH: 0,
        NHOMLN_ID: 0,
      },
      diachiKN: {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiDau: {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      diachiCuoi: {
        DIACHI: null,
        TINH_ID: 0,
        QUAN_ID: 0,
        PHUONG_ID: 0,
        PHO_ID: 0,
        AP_ID: 0,
        KHU_ID: 0,
        DACDIEM_ID: 0,
        SO_NHA: null,
        Lng: 0,
        Lat: 0,
        BLOCK: null,
        TANG: null,
        PHONG: null,
        MOTA: null
      },
      cbvmp: 0,
      NgayYeuCau: moment(new Date()).format('DD/MM/YYYY HH:mm:ss'),
      NgayLapHD: moment(new Date()).format('DD/MM/YYYY HH:mm:ss'),
      NgayCap: null, //moment(new Date()).format("DD/MM/YYYY"),
      NgayHH: null, //moment(new Date()).format("DD/MM/YYYY"),
      NgaySinh: null, //moment(new Date()).format("DD/MM/YYYY"),
      NgayCapHK: null, //moment(new Date()).format("DD/MM/YYYY"),
      NgaySinhTB: null, //moment(new Date()).format("DD/MM/YYYY"),
      //NgayCV: moment(new Date()).format("DD/MM/YYYY"),
      TGThueTuNgay: null, //moment(new Date()).format(this.datetimeFormat),
      TGThueDenNgay: null, //moment(new Date()).format(this.datetimeFormat),
      kt_thuenganhan: false,
      dateFormat: 'DD/MM/YYYY',
      datetimeFormat: 'DD/MM/YYYY HH:mm',
      datetimeFormatFull: 'DD/MM/YYYY HH:mm:ss',
      iKenhTN: 1,
      _fiberBoSung: '',
      maduan: '',
      VPHIEUCSKH_ID: 0,
      dtienld: 0,
      dvatld: 0,
      dtiencd: 0,
      dvatcd: 0,
      vtyle_vat_id_dnhm: 0,
      vtyle_vat_dnhm: 0,
      nhanvien_ql_am_id: 0,
      m_dsThueBao_DichVu: [],
      vtyle_vat_cd: 10,
      vtyle_vat_id_cd: 1,
      listbox: {
        trangbi: { list: [], valuewan: TRANGBI.VIENTHONG_TRANGBI, valuetsl: 0, valuecd: 3, valueims: 0, valueadsl: 0, valuedd: 0, valuegp: 0 },
        loai_tb: { list: [], listmgwan: [], value: 0, valuedau: 0, valuecuoi: 0, valuemgwan: 0 },
        chu_quan: { list: [], value: 0, valuewan: 0, valueldmgwan: 0, valuetsl: 0, valuecd: 143, valueldcd: 9, valueims: 0, valueldims: 0, valueadsl: 0, valueldadsl: 0, valuedd: 0, valuegp: 0 },
        tien_km: { list: [], value: 0 },
        doituong: { list: [], value: '' },
        dichvu_vt: { list: [], value: DichVuVienThong.CO_DINH },
        loaihinh_tb: { list: [], value: LoaiHinhTB.DIENTHOAI_CD },
        loai_khl: { list: [], value: 0 },
        loai_gt: { list: [], value: 0 },
        phanloai_kh: { list: [], value: 0 },
        loai_kh: { list: [], value: -1 },
        nganhang: { list: [], value: 0, valuekh: 0, sotaikhoankh: '', sotaikhoan: '', ischecked: false, ischeckedkh: false, isnganhangnn: false },
        hinhthuc_tt: { list: [], value: 0 },
        hinhthuc_tc: { list: [], value: 0, valueims: 0 },
        dantoc: { list: [], value: 0 },
        nganhnghe: { list: [], value: 0 },
        nganhngheloc: { list: [], value: 0 },
        quoctich: { list: [], value: 0 },
        hinhthuc_tthi: { list: [], value: 0 },
        kieu_hd: { list: [], value: 0 },
        goi_kt: { list: [], value: 0 },
        donvi_ql: { list: [], value: 0, valueql: 0 },
        kieu_ld: { list: [], value: KieuLapDat.DM_CODINH },
        nhacc_cu: { list: [], value: 0, ischecked: false },
        congnghe: { list: [], value: 0 },
        hinhthuc_cm: { list: [], value: 0 },
        thoihan: { list: [], value: 0, valuetsl: 0, valuewan: 0, valuecd: 0, valueadsl: 0, valueims: 0 },
        loai_csht: { list: [], value: 0 },
        doitac: { list: [], valueims: 0, valuecsht: 0, valueinternet: 0, valuecd: 0, ischeckedcd: false, ischeckedadsl: false },
        cboLoaiIP: { list: [], value: 0, values: [], valueitems: [], orilist: [] },
        phanloai_dv: { list: [], value: 0 },
        ht_chitietdv_ims: { list: [], value: 0 },
        ht_phantach_tocdo: { list: [], value: 0 },
        trangthai_yc: { list: [], value: 0 },
        donvi_dau: { list: [], value: 0 },
        donvi_cuoi: { list: [], value: 0 },
        tinh_kn: { list: [], value: 0 },
        loaikenh: { list: [], value: 0, valuetsl: 0 },
        tocdokenh: { list: [], valuecir: 0, valuepir: 0, valuetsl: 0, valueisp: 0, valuenix: 0, ischeckedpir: false, ischeckedisp: false, ischeckednix: false },
        doitactsl: { list: [], value: 0, chkDoiTacTSL: false },
        doitacwan: { list: [], value: 0, isenabled: false },
        loaimodem: { list: [], value: 0 },
        loaicap: { list: [], value: 0, valuedau: 0, valuecuoi: 0 },
        muccuoc: { list: [], value: 0, isenabled: true },
        muccuoc_tb: { list: [], value: 0 },
        thanhtoan: { list: [], value: '' },
        thanhtoancbo: { list: [], value: '' },
        danhba: { list: [], value: 0 },
        dshopdong_chuaht: { list: [], header: [], value: 0 },
        madaidien: { list: [], value: null },
        cboLoaiTB: { list: [], value: null },
        cboGoiCuocAdsl: {
          list: [],
          value: 0
        },
        cboTocDoThucADSL: { list: [], value: 0 },
        cboHDChinh: { list: [], value: 0 },
        cboDbChinh: { list: [], value: 0 },
        cboDoiTac_CSHT: { list: [], value: 0 },
        cboLoai_CSHT: { list: [], value: 0 },
        cboKieuTra: { list: [], value: 0 },
        cboThangTra: { list: [], value: 0 }
      },
      tieunganh: {
        dsTNC1: [],
        dsTNC2: [],
        dsTNC3: [],
        dsTNC4: [],
        TNC1_ID: 0,
        TNC2_ID: 0,
        TNC3_ID: 0,
        TNC4_ID: 0,
        TNCMOTA: ''
      },
      thanhToanId: 0, //la maTT khi chon 1 phan tu o bang thanh toan
      // searchDate: {
      //   isEnabled: false,
      //   fromDate: new Date(),
      //   toDate: new Date(),
      //   dateconfig: {
      //     altFormat: 'd/m/Y',
      //     altInput: true,
      //     dateFormat: 'd/m/Y',
      //     allowInput:true,
      //   },
      // },
      filterbox: {
        ctv: {
          value: '',
          ischecked: false,
          ma_ctv: ''
        },
        nguoigt: {
          value: '',
          ischecked: false,
          nguoigt_id: ''
        },
        khuyenmai: {
          list: [],
          value: '',
          ischecked: false
        },
        tratruoc: {
          list: [],
          value: '',
          ischecked: false
        }
      },
      dateconfig: {
        altFormat: 'd/m/Y',
        altInput: true,
        dateFormat: 'd/m/Y',
        allowInput: true
      },
      datetimeconfig: {
        altFormat: 'd/m/Y H:i:S',
        altInput: true,
        dateFormat: 'd/m/Y H:i:S',
        allowInput: true,
        enableTime: true
      },
      popupbox: {
        nvtc: 0
      },
      khachhang: {
        makh: '',
        sogt: '',
        magd: '',
        mahd: '',
        khachhang_id: 0,
        tenkh: '',
        nguoidd: '',
        dienthoai: '',
        fax: '',
        chucvu: '',
        noicaphk: '',
        noicap: '',
        gioitinh: -1,
        masothue: '',
        ghichu: '',
        dactrung: '',
        PHANLOAIKH_ID: -1,
        hdkh_id: 0,
        plkh: '',
        nhom_plkh: 0,
        txtNguoiKyHoSo: '',
        txtChucDanh: '',
        dtpNgaySinh: null,
        cboGioiTinh: 1,
        txtSoGT: '',
        dtpNgayCap: null,
        txtNoiCap: '',
        txtEmail: '',
        txtSoDT: ''
      },
      thuebao: {
        //###thuebao
        codinh: {
          somay: '',
          sochinh: '',
          dgvTienCK: {
            list: [],
            headers: [
              { fieldName: 'tuthang', headerText: 'Từ tháng', allowFiltering: true, allowEditing: true },
              { fieldName: 'denthang', headerText: 'Đến tháng', allowFiltering: true, allowEditing: true },
              { fieldName: 'tien_ck', headerText: 'Tiền cam kết', allowFiltering: true, allowHtml: true, allowEditing: true }
            ],
          },
          arraySoMay: []
        },
        mgwan: {
          somay: '',
          soao: '',
          matn: '',
          madoicap: '',
          huongkn: '',
          vhuongkn: '',
          vrfvfi: '',
          lanip: '',
          wanip: '',
          siteid: '',
          mahdttkd: '',
          luonggiukenh: false,
          chkLuongGiuKenh: false,
          cuoctk: 0,
          cuoctk_dt: 0,
          cuoctc: 0,
          cuoctc_dt: 0,
          hopdong_dt: '',
          cuoctbi: 0,
          cuocht: 0,
          soluongip: 0,
          cuocip: 0,
          cuocisp: 0,
          cuocnix: 0
        },
        adsl: {
          tientra: 0,
          btnKiemTraAccount_visible: true,
          txtAccountADSL: '',
          txtSoAoAdsl: '',
          txtMaTN_ADSL: '',
          txtMaDoiCap_ADSL: '',
          validadslacc: false,
          txtEmailAdsl: '',
          chkTocDoThuc: false,
          ckTuCaiADSL: false,
          dtpHanDatCho: moment(new Date()).format('DD/MM/YYYY HH:mm:ss'),
          dtpHanDatCho_Visible: true,
          txtDienThoai_Fsecure: '',
          txtSL_Tivi: 0,
          txtCuocDT_Internet: 0,
          txtSerialSTB: '',
          dtpNgayTra: null,
          txtTTCuoc: '',
          txtCSD_FIBER_TK: 0,
          txtCTB_FIBER_TK: 0,
          pass_adsl: '',
          txtAccountADSL_ReadOnly: false,
          kh_cd_fsecure: false,
          isHopDong: 1,
          //Bổ sung sài cho mega IOT
          txtMaTB_KN: '',
          megaIOT_vrf: '',
          megaIOT_LanIP: '',
          megaIOT_WanIP: '',
          megaIOT_HuongKN: ''
        },
        tsl: {
          txtMaTSL: {
            ReadOnly: false,
            Text: ''
          },
          txtMaHD_TTKD_TSL: '',
          txtSoSoiQuang: 0,
          txtSoSoiQuang_Enabled: true,
          txtCuocTKDT_TSL: 0,
          txtCuocTCDT_TSL: 0,
          txtMaHD_DT_TSL: '',
          txtCuocHT_TSL: 0,
          txtCuocTBI_TSL: 0,
          txtCuocTC_TSL: 0,
          txtCuocTK_TSL: 0,
          diachidau_id: 0,
          diachicuoi_id: 0,
          txtSoAoTSL_Dau: '',
          txtSoAoTSL_Cuoi: '',
          txtVrf_Dau: '',
          txtVrf_Cuoi: '',
          txtSiteIDTSL_Dau: '',
          txtSiteIDTSL_Cuoi: '',
          donvi_dau_id: 0,
          donvi_cuoi_id: 0
        },
        gphone: {
          txtSoSimGphone: '',
          txtSoMayGP: '',
          checkVSVX: false,
          dgvTienCKGP: {
            list: [],
            headers: [
              { fieldName: 'tuthang', headerText: 'Từ tháng', allowFiltering: true, allowEditing: true },
              { fieldName: 'denthang', headerText: 'Đến tháng', allowFiltering: true, allowEditing: true },
              { fieldName: 'tien_ck', headerText: 'Tiền cam kết', allowFiltering: true, allowHtml: true, allowEditing: true }
            ]
          }
        },
        ims: {
          txtMaTBIMS: '',
          cbkTrunk: false,
          cboTrunk: { list: [], value: 0 },
          txtMaDoiCap_IMS: 0,
          chkDoiTac_IMS: false,
          txtCuocDT_IMS: 0,
          txtMaTN_IMS: '',
          txtCuocGoiDT: 0,
          txtIp_IMS: '',
          pass_ims: '',
          dgvTienCKIMS: {
            list: [],
            headers: [
              { fieldName: 'tuthang', headerText: 'Từ tháng', allowFiltering: true, allowEditing: true },
              { fieldName: 'denthang', headerText: 'Đến tháng', allowFiltering: true, allowEditing: true },
              { fieldName: 'tien_ck', headerText: 'Tiền cam kết', allowFiltering: true, allowHtml: true, allowEditing: true }
            ]
          }
        },
        didong: {
          cboGoiCuocDD: { list: [], value: 0, Enabled: true },
          cboDTVinaPhone: { list: [], value: 0 },
          txtSoMayDD: '',
          txtSimDD: '',
          txtTienDuTK: 0,
          txtSoMayNTK: '',
          dgrKhuyenMai: { list: [], value: {}, headers: [] },
          LOAI_TB_DD: '',
          txtEmailDD: '', //Thay co khai bao tren form nhung khong thay co code hien thi.
          txtTenTBDD_Cu: '',
          txtNgaySinhDD_Cu: '',
          txtSoGTDD_Cu: '',
          txtNgayCapGTDD_Cu: '',
          txtDiaChiDD_Cu: '',
          txtHoKhauDD_Cu: ''
        },
        thuebao_id: 0,
        tentb: '',
        ghichu: '',
        tbhd_pl: 0,
        thuebao_id_cha: 0,
        loaisochinh: 0,
        hdtb_id_cha: 0,
        thangck: 0,
        doituong_ct_id: 0,
        tgdungthu: 0,
        tinhkhac: 0,
        khuvuc: '',
        khuvuc_id: 0,
        check_tb_adsl: true,
        statusVdc: true,
        cvlct: false,
        congvan: '',
        NgayCVChecked: false,
        NgayCV: moment(new Date()).format('DD/MM/YYYY HH:mm:ss'),
        crm: '',
        erp: '',
        vtn: ''
      },
      thanhtoan: {
        matt: '',
        tentt: '',
        thanhtoan_id: 0,
        masothue: '',
        sodienthoai: '',
        email: '',
        chutk: '',
        tuyenthu_id: 0,
        matuyen: '',
        manvtc: '',
        tuyenthu_httt: 0,
        nhanvientc_id: 0,
        ghichu: '',
        hdmig_id: 0,
        mig_id: 0,
        mainghep: '',
        matb_dd: 0,
        manvql: ''
      },
      ma_vnpt: -1,
      thuebaocd: {
        matn: '',
        sothang_thueso: 0,
        noidung_thueso: '',
        kieu_thueso: 0,
        madoicap: null,
        cuocdoitac: 0
      },
      nganhang: {
        TIEN_DM: 0,
        DV_QHNS: 0,
        MACHUONG: 0,
        MN_KT: 0,
        MA_NDKT: 0,
        MN_NSNN: 0
      },
      thietbi: {
        tien_tbi: 0,
        vat_tbi: 0,
        tien_kmtbi: 0,
        vat_kmtbi: 0,
        tien_tgtb_tragop: 0,
        vat_tgtb_tragop: 0,
        tien_tgtb_tratruoc: 0,
        vat_tgtb_tratruoc: 0,
        dtien_kmtb: 0,
        dvat_kmtb: 0,
        dtientbi: 0,
        dvattbi: 0
      },
      dsHDTB: [],
      dsHDTBGOI: [],
      dsDvKhacChose: [],
      dsDvMaster: [],
      dsDichVuKhac: [],
      dsDiaChi: [],
      dsDiaChiHDKH: [],
      dsDiaChiHDTT: [],
      dsDiaChiHDTB: [],
      dsDK_DVGT: [],
      dsTien_DatCoc: [],
      dsDK_DVKHAC: [],
      dsDK_DVK_TB: [],
      dsDK_DVK_TT: [],
      dsCTM_TBI: [],
      dsKM_HDTB: [],
      dsDC_HDTB: [],
      dsKM_Neo: [],
      DS_CTKM_LTBI: [],
      dsHDTB_CD: [],
      dsHDTBDV: [],
      dsCAMKET_HDTB: [],
      dsHDTBDV_Fsecure: [],
      dgrKhuyenMai: [],
      //dgvTienCK: [],
      dtControl: [],
      dsHDTB_KV: [],
      // dsHDTB_KV_tmp: [],
      dsHDTB_KV_ThemTB: [],
      dsHDKH_Sub: [],
      dsHDKH: [],
      dsHDTT: [],
      dsCTTHD: [],
      dsHDTT_NV: [],
      dsHDTB_DUNGTHU: [],
      dsTRAGOP_TBI_HDTB: [],
      ds_tien_khoanmuc: [],
      ds_tien_khoanmuc_bd: [],
      dsHDTB_DD: [],
      dsHDTB_INT: [],
      dsHDTB_ADSL: [],
      dsHDTB_MEWAN: [],
      dsHDTB_TSL: [],
      dsHDTB_GP: [],
      dsTTTT: [],
      dsTien_HDTB: [],
      dsHDTB_IMS: [],
      dsHDTB_CNTT: [],
      dsHDTB_SUB: [],
      dsHDTB_CT: [],
      dsHDTB_LoaiIp: [],
      nganhnghe_id: 0,
      lvwThueBao: [],
      lvwThueBao_SelectedItem: {},
      lvwThanhToan: [],
      lvDvkhac: { list: [], value: 0 },
      lvDvkhac_TT: { list: [], value: 0 },
      lvDvgt: { list: [], value: null },
      lvMuaThietbi: { list: [], value: null },
      gridEditors: [],
      DT_CONTROLS: {
        dichvu_vt: 0,
        list: [],
        data: [],
        value: [],
        tagvalue: [],
        key: 0
      },
      kmld: {
        tien_kmld: 0,
        vat_kmld: 0,
        tien_datcoc: 0,
        dtienkmld: 0,
        dvatkmld: 0,
        tong_kmld: 0,
        tyle_kmld: 0,
        dtienkmdc: 0,
        dvatkmdc: 0,
        tyle_kmld_tt: 0,
        dtiendatcoc_tt: 0,
        dvatdatcoc_tt: 0,
        tong_kmld_tt: 0,
        tien_kmld_tt: 0,
        vat_kmld_tt: 0,

        dtiendatcoc_km: 0,
        dvatdatcoc_km: 0
      },
      dvgt: {
        tien_dv: 0,
        vat_dv: 0,
        tien_km_dvgt: 0,
        vat_km_dvgt: 0
      },
      dichvu: {
        dtien_dv: 0,
        dvat_dv: 0
      },
      tongtienhd: 0,
      tongtienkm: 0,
      tongvatkm: 0,
      STATUS_VDC: null,
      buttonSet: null,
      hdkh_cha_id: 0,
      chkMienCuocTB: false,
      chkVSVX: false,
      ts_sinhma_gd_theo_donvi: false,
      TUDONG_SINH_SOAO: false, //false,
      TD_GANTHEM_HDTB_DV: false,
      bDuLieuKS: false, // chi bang true khi lay du lieu tu btnLayDulieuKS_Click
      phieucskhdv_id: 0,
      loi_sinh_magd: false,
      KetCuoi_ID: -1,
      loainv_ctv_hrm: 0,
      loainv_ngt_hrm: 0,
      ts_kt_tthdkhdn: 0,
      ts_kt_ltb_hrm: false,
      huonggiao_tn: 0,
      quytrinh_tn: 0,
      luong_id: 0,
      words: '',
      vkieuhd_id: 0
    }
  },
  methods: {
    ShowSearchAccount() {
      this.popupComponentAttr = { vISKHDN:this.$root.token.getPhanVungID()==97 };
      this.popupComponent = () => import('@/modules/search/subscriber/SearchAccount')
      this.popupComponentName = 'SearchAccount'
      this.Popup('popupComponents')
    },
    ShowContractOwner() {
      try {
        // this.popupComponent.data.isPopup = true;
        this.popupComponentAttr = { hdkh_id: this.khachhang.hdkh_id, khachhang_id: this.khachhang.khachhang_id, ten_kh: this.khachhang.tenkh, diachi: this.diachiKH.DIACHI, txtTenLH: this.khachhang.tenkh, txtDiaChiLH: this.diachiKH.DIACHI }
        this.popupComponent = () => import('@/modules/contract/setup/ChangeContractOwner/popup/ThongTinLienHe')
        this.popupComponentName = 'popupThongTinLienHe'
        this.Popup('popupComponents')
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }

      //this.Popup('popupThongTinLienHe');
    },
    // searchAccountClosed(val){
    //   this.khachhang.makh = val;
    //   this.ClosePopup('popupComponents');
    //   if(this.khachhang.makh && this.khachhang.makh.trim()!="") this.MaKHChanged();
    // },
    LoadMucCuocTB() {
      //if(!this.diachiLD.DIACHI) return;

      let vtocdo_id = 0
      let vmuccuoc_id = 0 //2 Lưu lượng

      if (
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_MESH ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGA_IOT ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_SGTV ||
        this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES ||
        this.listbox.dichvu_vt.value == DichVuVienThong.HATANG_VIENTHONG ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_ANALOG ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL ||
        this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC
      ) {
        vtocdo_id = this.listbox.cboGoiCuocAdsl.value
        if (
          this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH ||
          this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER ||
          this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_MESH ||
          this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGA_IOT ||
          this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL
        )
          vmuccuoc_id = this.listbox.muccuoc.value
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT || this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT || this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU || this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH) {
        if (this.ItemList.length <= 0) {
          vtocdo_id = -2
          vmuccuoc_id = -2
        } else {
          for (var index1 = 0; index1 < this.ItemList.length; ++index1) {
            if (this.ItemList[index1].sFieldName == 'TOCDO_ID') {
              if (this.ItemList[index1].sValue) {
                vtocdo_id = this.ItemList[index1].sValue * 1
                break
              }
            }
          }
        }
      }
      this.listbox.muccuoc_tb.list = []
      let pdata = {
        apld_id: this.diachiLD.AP_ID ? this.diachiLD.AP_ID : 0,
        doituong_id: this.listbox.doituong.value ? this.listbox.doituong.value : this.listbox.doituong.list && this.listbox.doituong.list[0] ? this.listbox.doituong.list[0].doituong_id : 0,
        khuld_id: this.diachiLD.KHU_ID ? this.diachiLD.KHU_ID : 0,
        loaitb_id: this.listbox.loaihinh_tb.value,
        muccuoc_id: vmuccuoc_id, //(this.listbox.muccuoc.value && this.listbox.muccuoc.value>0)?this.listbox.muccuoc.value:0,
        ngay: this.NgayYeuCau.indexOf(' ') > 0 ? this.NgayYeuCau.substring(0, this.NgayYeuCau.indexOf(' ')).trim() : this.NgayYeuCau,
        phold_id: this.diachiLD.PHO_ID ? this.diachiLD.PHO_ID : 0,
        phuongld_id: this.diachiLD.PHUONG_ID ? this.diachiLD.PHUONG_ID : 0,
        tocdo_id: vtocdo_id, //this.tocdo_id?this.tocdo_id:0,
        trangbi_id: this.trangbi_id, //default=3 //BUG cho nay can lay dong theo dichvu_vt????
        loainha_id: this.diachiLD.LOAINHA_ID,
      }
      let api = cache.getters.getFromCache('post_lay_ds_mucuoc_tb_v2', pdata)

      if (!api) api = API.post_lay_ds_mucuoc_tb_v2(this.axios, pdata)
      else
        api = new Promise((resolve, reject) => {
          resolve(api)
        })

      api.then((response) => {
        cache.dispatch('addToCache', { key: 'post_lay_ds_mucuoc_tb_v2', subkey: pdata, data: response })
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.muccuoc_tb.list = response.data.data
          if (this.listbox.muccuoc_tb.list && this.listbox.muccuoc_tb.list.length > 0)
            if (!this.listbox.muccuoc_tb.value || (this.listbox.muccuoc_tb.list.filter((x) => x.muccuoctb_id == this.listbox.muccuoc_tb.value).length <= 0 && this.watcherActive)) this.listbox.muccuoc_tb.value = this.listbox.muccuoc_tb.list[0].muccuoctb_id
        }
      });
      // this.LoadTTKhuyenMai();
    },
    ShowPopupCTV() {
      if (this.filterbox.ctv.ischecked) {
        this.popupComponent = () => import('@/modules/contract/setup/ChangeContractOwner/popup/CongTacVien')
        this.popupComponentName = 'popupCTV'
        // SearchAccount.data.isPopup = true;
        this.Popup('popupComponents')
      }
    },
    ShowPopupNguoiGT() {
      if (this.filterbox.nguoigt.ischecked) {
        this.popupComponent = () => import('@/modules/contract/setup/ChangeContractOwner/popup/NguoiGioiThieu')
        this.popupComponentName = 'popupNGT'
        // SearchAccount.data.isPopup = true;
        this.Popup('popupComponents')
      }
    },
    ShowPopupDVQL() {
      this.popupComponent = () => import('./Popups/popupDonViQL')
      this.popupComponentName = 'popupDonViQL'
      // SearchAccount.data.isPopup = true;
      this.Popup('popupComponents')
    },
    ShowPopupChonSM() {
      // goi frmDSThueSo
      // this.popupComponent = ()=>import('./Popups/popupChonSM');
      // this.popupComponentName = "popupChonSM";
      // this.Popup('popupComponents');

      try {
        if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) {
          if (this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_DC || this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_TL) {
            if (this.khachhang.khachhang_id > 0) {
              this.popupComponent = () => import('./Popups/popupNumberRent')
              this.popupComponentName = 'popupDSThueSo'
              this.popupComponentData = {
                vkhachhang_id: this.khachhang.khachhang_id,
                vma_tb: this.thuebao.codinh.somay,
                vkieuld_id: this.listbox.kieu_ld.value
              }
              this.Popup('popupComponents')
            }
          } else if (this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_MOI) {
            this.popupComponent = () => import('./Popups/popupChonSM')
            this.popupComponentName = 'popupChonSMThue'
            this.popupComponentData = {
              _tinh_id: this.diachiLD.TINH_ID,
              _quan_id: this.diachiLD.QUAN_ID,
              _phuong_id: this.diachiLD.PHUONG_ID,
              _loaiso_id: LOAISO.THUONG,
              _thueso: true,
              loaitb_id: this.listbox.loaihinh_tb.value,
              dichvuvt_id: this.listbox.dichvu_vt.value,
              hdkh_id: this.khachhang.hdkh_id,
              donvi_ql_id: this.listbox.donvi_ql.value //ql (lay field don vi lap dat.)
            }
            this.Popup('popupComponents')
          } else if (this.listbox.kieu_ld.value == KieuLapDat.DM_TINH_KHAC) {
            this.$bvModal.show('frmChonSoMay_TinhKhac')
          } else {
            if (!this.diachiLD.QUAN_ID || this.diachiLD.QUAN_ID == 0 || !this.diachiLD.PHUONG_ID || this.diachiLD.PHUONG_ID == 0) {
              this.$toast.error('Bạn chưa chọn địa chỉ lắp đặt !')
              // txtDiaChiLD.Focus(); //FIXME focus vao o diachiLD
              return
            }

            if (this.CHONSO_MOI) {
              if (this.CHONSO_MOI_V2) {
                this.popupComponent = () => import('./Popups/popupChonSMTheoHost')
                this.popupComponentName = 'popupChonSMTheoHost'
                this.popupComponentData = {
                  _quan_id: this.diachiLD.QUAN_ID,
                  _phuong_id: this.diachiLD.PHUONG_ID,
                  _pho_id: this.diachiLD.PHO_ID,
                  _ap_id: this.diachiLD.AP_ID,
                  _khu_id: this.diachiLD.KHU_ID,
                  _loaiso_id: LOAISO.THUONG,
                  _thueso: false,
                  loaitb_id: this.listbox.loaihinh_tb.value,
                  dichvuvt_id: this.listbox.dichvu_vt.value,
                  hdkh_id: this.khachhang.hdkh_id,
                  donvi_ql_id: this.listbox.donvi_ql.value //ql (lay field don vi lap dat.)
                }
                this.Popup('popupComponents')
              } else {
                this.popupComponent = () => import('./Popups/popupChonSMNew')
                this.popupComponentName = 'popupChonSMNew'
                this.popupComponentData = {
                  _quan_id: this.diachiLD.QUAN_ID,
                  _phuong_id: this.diachiLD.PHUONG_ID,
                  _loaiso_id: LOAISO.THUONG,
                  loaitb_id: this.listbox.loaihinh_tb.value,
                  dichvuvt_id: this.listbox.dichvu_vt.value,
                  hdkh_id: this.khachhang.hdkh_id,
                  donvi_ql_id: this.listbox.donvi_ql.value //ql (lay field don vi lap dat.)
                }
                this.Popup('popupComponents')
              }
            } else {
              //CASE MAC DINH TEST THEM MOI CO DINH
              this.popupComponent = () => import('./Popups/popupChonSM')
              this.popupComponentName = 'popupChonSM'
              this.popupComponentData = {
                _tinh_id: this.diachiLD.TINH_ID,
                _quan_id: this.diachiLD.QUAN_ID,
                _phuong_id: this.diachiLD.PHUONG_ID,
                _loaiso_id: LOAISO.THUONG,
                _thueso: false,
                loaitb_id: this.listbox.loaihinh_tb.value,
                dichvuvt_id: this.listbox.dichvu_vt.value,
                hdkh_id: this.khachhang.hdkh_id,
                donvi_ql_id: this.listbox.donvi_ql.value //ql (lay field don vi lap dat.)
              }
              this.Popup('popupComponents')
            }
          }
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    btnSoAoWan_Click() {
      if (!this.diachiLD.QUAN_ID || this.diachiLD.QUAN_ID == 0 || !this.diachiLD.PHUONG_ID || this.diachiLD.PHUONG_ID == 0) {
        this.$toast.error('Bạn chưa chọn địa chỉ lắp đặt !')
        return
      }
      this.popupComponent = () => import('./Popups/popupChonSM')
      this.popupComponentName = 'popupChonSoAoMGWAN'
      this.popupComponentData = {
        _tinh_id: this.diachiLD.TINH_ID,
        _quan_id: this.diachiLD.QUAN_ID,
        _phuong_id: this.diachiLD.PHUONG_ID,
        _loaiso_id: LOAISO.AO,
        _thueso: false,
        loaitb_id: this.listbox.loaihinh_tb.value,
        dichvuvt_id: this.listbox.dichvu_vt.value,
        hdkh_id: this.khachhang.hdkh_id,
        donvi_ql_id: this.listbox.donvi_ql.value //ql (lay field don vi lap dat.)
      }
      this.Popup('popupComponents')
    },
    ShowPopupChonMaTT() {
      this.popupComponentData = this.khachhang.khachhang_id
      this.popupComponent = () => import('./Popups/popupChonMaTT')
      this.popupComponentName = 'popupChonMaTT'
      this.Popup('popupComponents')
    },
    ShowPopupKhuyenMai(loaikm = Loai_KM.KhuyenMai) {
      let dulieu = {}
      dulieu.loai = loaikm
      dulieu.dt = loaikm == Loai_KM.KhuyenMai ? this.filterbox.khuyenmai.list : this.filterbox.tratruoc.list
      dulieu.loainha_id = this.diachiLD.LOAINHA_ID;
      this.popupComponentData = dulieu
      this.popupComponent = () => import('./Popups/popup-Dangkychitietkhuyenmai')
      this.popupComponentName = 'popup-Dangkychitietkhuyenmai'
      this.Popup('popupComponents')
    },
    ShowPopupChonKhuyenMai(loaikm = Loai_KM.KhuyenMai) {
      let dulieu = {}
      dulieu.loai = loaikm
      dulieu.dt = loaikm == Loai_KM.KhuyenMai ? this.filterbox.khuyenmai.list : this.filterbox.tratruoc.list
      this.popupComponentData = dulieu
      this.popupComponent = () => import('./Popups/popup-ChonKhuyenMai')
      this.popupComponentName = 'popup-ChonKhuyenMai'
      this.Popup('popupComponents')
    },
    popupMaTNMGWAN() {
      let dulieu = {}
      let kieu = this.kieu_ld_kieu
      switch (kieu * 1) {
        case 2:
          if (this.khachhang.khachhang_id && this.khachhang.khachhang_id > 0) {
            dulieu.khachhang_id = this.khachhang.khachhang_id
            dulieu.kieuld_id = this.listbox.kieu_ld.value
            dulieu.loaitb_id = this.listbox.loaihinh_tb.value
            dulieu.dichvuvt_id = this.listbox.dichvu_vt.value
            this.popupComponentData = dulieu
            this.popupComponent = () => import('./Popups/popupDSTBCungDoiCap')
            this.popupComponentName = 'popupDSTBCungDoiCapMGWAN'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp trên đường có sẵn !')
            return
          }
          break
        case 1:
          if (this.khachhang.hdkh_id && this.khachhang.hdkh_id > 0) {
            dulieu.hdkh_id = this.khachhang.hdkh_id
            dulieu.vkhachhang_id = this.khachhang.khachhang_id
            dulieu.vkieuld_id = this.listbox.kieu_ld.value
            dulieu.loaitb_id = this.listbox.loaihinh_tb.value
            this.popupComponentData = dulieu
            this.popupComponent = () => import('./Popups/popupDSTBLapKem')
            this.popupComponentName = 'popupDSTBLapKemMGWAN'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp kèm !')
            return
          }
          break
        case 4:
          dulieu.loaitb_id = this.listbox.loaihinh_tb.value
          dulieu.kieuld_id = this.listbox.kieu_ld.value
          this.popupComponentData = dulieu
          this.popupComponent = () => import('./Popups/popupDSTBCungDoiCap_KH_Khac')
          this.popupComponentName = 'popupDSTBCungDoiCap_KH_KhacMGWAN'
          break
      }
      this.Popup('popupComponents')
    },
    popupMaTNADSL() {
      let dulieu = {}
      let kieu = this.kieu_ld_kieu
      switch (kieu * 1) {
        case 2: //Lắp mới trên đường có sẵn
          if (this.khachhang.khachhang_id && this.khachhang.khachhang_id > 0) {
            dulieu.khachhang_id = this.khachhang.khachhang_id
            dulieu.kieuld_id = this.listbox.kieu_ld.value
            dulieu.loaitb_id = this.listbox.loaihinh_tb.value
            dulieu.dichvuvt_id = this.listbox.dichvu_vt.value
            this.popupComponentData = dulieu
            this.popupComponent = () => import('./Popups/popupDSTBCungDoiCap')
            this.popupComponentName = 'popupDSTBCungDoiCapADSL'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp trên đường có sẵn !')
            return
          }
          break
        case 1: //Lắp kèm
        case 3: //Lắp kèm thuê bao quang đang chuyển đổi
          if (this.khachhang.hdkh_id && this.khachhang.hdkh_id > 0) {
            dulieu.hdkh_id = this.khachhang.hdkh_id
            if (kieu * 1 == 3) dulieu.vkhachhang_id = this.khachhang.khachhang_id
            dulieu.vkieuld_id = this.listbox.kieu_ld.value
            dulieu.loaitb_id = this.listbox.loaihinh_tb.value
            dulieu.kieu = kieu
            this.popupComponentData = dulieu
            this.popupComponent = () => import('./Popups/popupDSTBLapKem')
            this.popupComponentName = 'popupDSTBLapKemADSL'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp kèm !')
            return
          }
          break
        case 4: // Lắp trên đường có sẵn của khách hàng khác
          dulieu.loaitb_id = this.listbox.loaihinh_tb.value
          dulieu.kieuld_id = this.listbox.kieu_ld.value
          this.popupComponentData = dulieu
          this.popupComponent = () => import('./Popups/popupDSTBCungDoiCap_KH_Khac')
          this.popupComponentName = 'popupDSTBCungDoiCap_KH_KhacADSL'
          break
      }
      this.Popup('popupComponents')
    },
    popupMaTN() {
      let dulieu = {}
      let kieu = this.kieu_ld_kieu
      switch (kieu * 1) {
        case 2:
          if (this.khachhang.khachhang_id && this.khachhang.khachhang_id > 0) {
            dulieu.khachhang_id = this.khachhang.khachhang_id
            dulieu.kieuld_id = this.listbox.kieu_ld.value
            dulieu.loaitb_id = this.listbox.loaihinh_tb.value
            dulieu.dichvuvt_id = this.listbox.dichvu_vt.value
            this.popupComponentData = dulieu
            this.popupComponent = () => import('./Popups/popupDSTBCungDoiCap')
            this.popupComponentName = 'popupDSTBCungDoiCap'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp trên đường có sẵn !')
            return
          }
          break
        case 1:
          if (this.khachhang.hdkh_id && this.khachhang.hdkh_id > 0) {
            dulieu.hdkh_id = this.khachhang.hdkh_id
            dulieu.vkhachhang_id = this.khachhang.khachhang_id
            dulieu.vkieuld_id = this.listbox.kieu_ld.value
            dulieu.loaitb_id = this.listbox.loaihinh_tb.value
            this.popupComponentData = dulieu
            this.popupComponent = () => import('./Popups/popupDSTBLapKem')
            this.popupComponentName = 'popupDSTBLapKem'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp kèm !')
            return
          }
          break
        case 4:
          dulieu.loaitb_id = this.listbox.loaihinh_tb.value
          dulieu.kieuld_id = this.listbox.kieu_ld.value
          this.popupComponentData = dulieu
          this.popupComponent = () => import('./Popups/popupDSTBCungDoiCap_KH_Khac')
          this.popupComponentName = 'popupDSTBCungDoiCap_KH_Khac'
          break
      }
      this.Popup('popupComponents')
    },
    Popup(modalId) {
      this.loading(false)
      if (this.$refs[modalId]) this.$refs[modalId].show()
      else this.$bvModal.show(modalId)
    },
    ClosePopup(modalId) {
      this.$bvModal.hide(modalId)
      this.popupComponent = null
    },
    async popupClosed(val) {
      if (!val) {
        this.popupRetVal = {}
        this.ClosePopup('popupComponents')
        return
      }
      this.loading(true)
      try {
        switch (this.popupComponentName) {
          case 'SearchAccount':
            if (val.ma_kh) this.khachhang.makh = val.ma_kh
            if (val.ma_tt) this.thanhtoan.matt = val.ma_tt
            if (this.khachhang.makh && this.khachhang.makh.trim() != '') this.MaKHChanged()
            break
          case 'popupInforAdd':
            //this.dsHDTB_SUB = val && val.length>0?[JSON.parse(val)]:[];
            this.dsHDKH_Sub = val && val.length > 0 ? [JSON.parse(val)] : [] // nham du lieu
            this.TAO_DULIEU_HDKH_SUB(this.dsHDKH_Sub, this.dsHDKH_Sub[0]['HDKH_ID'])
            break
          case 'popupChonMaTT':
            if (val.ma_tt) {
              this.thanhtoan.matt = val.ma_tt
              this.maTTChanged();
            }
            if (val.ma_tb) this.listbox.madaidien.value = val.ma_tb
            break
          case 'popupChonSoAoMGWAN':
            this.thuebao.mgwan.soao = val.somay
            break
          case 'popupChonSM': // Case chon so may them moi CO_DINH
          case 'popupChonSMNew':
          case 'popupChonSMTheoHost': // Chuyen len vi bao trung code
            if (!val.somay) return
            this.thuebao.codinh.somay = val.somay
            this.thuebao.codinh.arraySoMay = val.arraySoMay ? val.arraySoMay : []
            this.loaisoisdn = val.loaiso
            this.thuebao.codinh.dgvTienCK.list = [];
            API.post_sp_lay_danhsach_tiencamket(this.axios, { nhomso_id: val.nhomso }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.thuebao.codinh.dgvTienCK.list = response.data.data
              }
            })
            let vtien_sodep = val.tiensodep ? val.tiensodep : 0
            for (var item of this.ds_tien_khoanmuc)
              if (item['khoanmuctt_id'] == 23) {
                item['tien'] = vtien_sodep * 1
                item['vat'] = vtien_sodep * 0.1
                this.LayTongTien_HDTB()
                break
              }
            break
          case 'frmChonSMPhuongADSL':
            this.thuebao.adsl.txtSoAoAdsl = val.somay
            break
          case 'frmChonSMPhuongDiDong':
            // this.thuebao.adsl.txtSoAoAdsl = val.somay;
            this.thuebao.didong.txtSoMayDD = val.so_tb_chon
            this.thuebao.didong.txtSimDD = val.so_sim_chon
            this.thuebao.didong.txtSoMayNTK = this.thuebao.didong.txtSoMayDD
            this.thuebao.didong.cboGoiCuocDD.value = val.goicuoc_id_chon
            this.CHON_KIEULD_THEO_TB('84' + this.thuebao.didong.txtSoMayDD)
            this.CHON_LOAITB_TS_THEO_TB('84' + this.thuebao.didong.txtSoMayDD) // vuth update 0912
            if (val.kieuform == 0) this.thuebao.didong.cboGoiCuocDD.Enabled = false // vuth update fix 1109
            break
          case 'popupChonDVQL':
            if (val && val.DONVIQL_ID) {
              this.listbox.donvi_ql.valueql = val.DONVIQL_ID
              this.LoadNVThuCuoc()
              break
            } else {
              this.$toast.error('Bắt buộc phải chọn đơn vị quản lý cho khu vực giáp ranh!')
              return
            }
          case 'popupChonDVDau':
            if (val && val.DONVIQL_ID) {
              // this.listbox.donvi_dau.value = val.DONVIQL_ID;
              this.thuebao.tsl.donvi_dau_id = val.DONVIQL_ID
              this.LoadDonViDauCuoiCombobox(1)
              break
            } else {
              this.$toast.error('Bắt buộc phải chọn đơn vị quản lý cho khu vực giáp ranh!')
              return
            }
          case 'popupChonDVDau2':
            if (val && val.DONVI_ID) {
              // this.listbox.donvi_dau.value = val.DONVIQL_ID;

              this.listbox.donvi_dau.value = val.DONVI_ID
              break
            } else {
              this.$toast.error('Bắt buộc phải chọn đơn vị cho khu vực giáp ranh!')
              return
            }
          case 'popupChonDVCuoi2':
            if (val && val.DONVI_ID) {
              // this.listbox.donvi_cuoi.value = val.DONVIQL_ID;
              this.listbox.donvi_cuoi.value = val.DONVI_ID
              break
            } else {
              this.$toast.error('Bắt buộc phải chọn đơn vị quản lý cho khu vực giáp ranh!')
              return
            }
          case 'popupChonDVCuoi':
            if (val && val.DONVIQL_ID) {
              // this.listbox.donvi_cuoi.value = val.DONVIQL_ID;
              this.thuebao.tsl.donvi_cuoi_id = val.DONVIQL_ID
              this.LoadDonViDauCuoiCombobox(2)
              break
            } else {
              this.$toast.error('Bắt buộc phải chọn đơn vị quản lý cho khu vực giáp ranh!')
              return
            }
          case 'popupChonDVLD':
            if (val && val.DONVIQL_ID) {
              this.listbox.donvi_ql.value = val.DONVIQL_ID
              this.HT_GIAODIEN_DONVI()
              break
            } else {
              this.$toast.error('Bắt buộc phải chọn đơn vị lắp đặt cho khu vực giáp ranh!')
              return
            }
          case 'popupServiceAdds':
            this.m_dsThueBao_DichVu = this.LowerCasePropertyList(val)
            this.HT_DichVuGT()
            break
          case 'popupServiceOthers':
            this.dsDK_DVK_TB = val
            this.HT_DichVuKhac(this.LowerCasePropertyList(this.dsDK_DVK_TB), 1) //default 1 tren code cu
            break
          case 'popupServiceOthersTT':
            this.dsDK_DVK_TT = val
            this.HT_DichVuKhac(this.LowerCasePropertyList(this.dsDK_DVK_TT), 2) //default 2 tren code cu
            break
          case 'popupBuyDevices':
            this.dsCTM_TBI = val
            this.HT_ThietBi()
            break
          case 'popupCTV':
            this.filterbox.ctv.value = val.ten_ht
            this.filterbox.ctv.ma_ctv = val.nhanvien_id
            this.ctv_id = val.nhanvien_id
            break
          case 'popupNGT':
            this.filterbox.nguoigt.value = val.ten_ht
            this.filterbox.nguoigt.nguoigt_id = val.nhanvien_id
            break
          case 'popupChonKhuVuc':
            this.thuebao.khuvuc = val.ma_kv
            this.dsHDTB_KV = val.hdtb_kv_data
            this.thuebao.khuvuc_id = val.khuvuc_id
            break
          case 'popupTienKM':
            // let kmtt_id = -1;
            // let tien_kmtt = 0;
            // let tien_vat = 0;
            this.ds_tien_khoanmuc = val
            if (this.ds_tien_khoanmuc.length > 0) {
              for (var item of this.ds_tien_khoanmuc) {
                if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
                  this.dtienld = item['tien']
                  this.dvatld = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
                  this.dtiencd = item['tien']
                  this.dvatcd = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DICHVU) {
                  this.dichvu.dtien_dv = item['tien']
                  this.dichvu.dvat_dv = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_MUATHIETBI) {
                  this.dtientbi = item['tien']
                  this.dvattbi = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT) {
                  this.kmld.dtienkmld = item['tien']
                  this.kmld.dvatkmld = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DATCOC) {
                  this.kmld.dtienkmdc = item['tien']
                  this.kmld.dvatkmdc = item['vat']
                  if (this.kmld.dtienkmdc > this.kmld.dtienkmld) {
                    this.kmld.dtienkmld = this.kmld.dtienkmdc
                    this.kmld.dvatkmld = this.kmld.dvatkmdc
                  }
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI) {
                  this.thietbi.dtien_kmtb = item['tien']
                  this.thietbi.dvat_kmtb = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC) {
                  this.kmld.dtiendatcoc_tt = item['tien']
                  this.kmld.dvatdatcoc_tt = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC_KM) {
                  this.kmld.dtiendatcoc_km = item['tien']
                  this.kmld.dvatdatcoc_km = item['vat']
                }
                // else
                // {
                //     kmtt_id = item["khoanmuctt_id"];
                //     tien_kmtt = item["tien"];
                //     tien_vat = item["vat"];
                // }
                //this.HienThiTienKhuyenMaiLapDat(dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt, kmtt_id, tien_kmtt, tien_vat);
                this.HienThiTienKhuyenMaiLapDat()
                this.LayTongTien_HDTB()
              }
            }
            break
          case 'popupCT_TienKM':
            // let kmtt_id = -1;
            // let tien_kmtt = 0;
            // let tien_vat = 0;
            this.ds_tien_khoanmuc = val
            if (this.ds_tien_khoanmuc.length > 0) {
              for (var item of this.ds_tien_khoanmuc) {
                if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
                  this.dtienld = item['tien']
                  this.dvatld = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
                  this.dtiencd = item['tien']
                  this.dvatcd = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DICHVU) {
                  this.dichvu.dtien_dv = item['tien']
                  this.dichvu.dvat_dv = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_MUATHIETBI) {
                  this.dtientbi = item['tien']
                  this.dvattbi = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT) {
                  this.kmld.dtienkmld = item['tien']
                  this.kmld.dvatkmld = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DATCOC) {
                  this.kmld.dtienkmdc = item['tien']
                  this.kmld.dvatkmdc = item['vat']
                  if (this.kmld.dtienkmdc > this.kmld.dtienkmld) {
                    this.kmld.dtienkmld = this.kmld.dtienkmdc
                    this.kmld.dvatkmld = this.kmld.dvatkmdc
                  }
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI) {
                  this.thietbi.dtien_kmtb = item['tien']
                  this.thietbi.dvat_kmtb = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC) {
                  this.kmld.dtiendatcoc_tt = item['tien']
                  this.kmld.dvatdatcoc_tt = item['vat']
                } else if (item['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC_KM) {
                  this.kmld.dtiendatcoc_km = item['tien']
                  this.kmld.dvatdatcoc_km = item['vat']
                }
                // else
                // {
                //     kmtt_id = item["khoanmuctt_id"];
                //     tien_kmtt = item["tien"];
                //     tien_vat = item["vat"];
                // }
                //this.HienThiTienKhuyenMaiLapDat(dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt, kmtt_id, tien_kmtt, tien_vat);
                this.HienThiTienKhuyenMaiLapDat()
                this.LayTongTien_HDTB()
              }
            }
            break
          case 'popup-ChonKhuyenMai':
            if (val.loaikm == Loai_KM.KhuyenMai) this.filterbox.khuyenmai.value = val.khuyenmai.khuyenmai_id
            else this.filterbox.tratruoc.value = val.khuyenmai.khuyenmai_id
            break
          case 'popup-DangkychitietkhuyenmaiTT':
            await this.LaySothang_SD()
            this.dsDC_HDTB = val.dsDC_HDTB
            this.kmld.dtienkmdc = val.tien_kmld_tt
            this.kmld.dvatkmdc = val.vat_kmld_tt
            this.kmld.tyle_kmld_tt = val.tyle_kmld_tt
            this.kmld.dtiendatcoc_tt = this.round((val.tien_datcoc_tt * 10) / 11)
            this.kmld.dvatdatcoc_tt = val.tien_datcoc_tt - this.kmld.dtiendatcoc_tt

            //Them CT_TienKM
            if (this.thamsomacdinh['HT_KMTT'] != 1) {
              this.kmld.dtiendatcoc_tt = this.round((val.tien_datcoc_tt * 10) / 11)
              this.kmld.dvatdatcoc_tt = val.tien_datcoc_tt - this.kmld.dtiendatcoc_tt
            } else {
              if (val.m_dsTienCTKM && val.m_dsTienCTKM.length > 0) {
                if (!this.m_dsTienCTKM) this.m_dsTienCTKM = []
                this.m_dsTienCTKM = this.m_dsTienCTKM.filter((x) => x.kieu != 1)
                if (this.m_dsTienCTKM) this.m_dsTienCTKM = this.m_dsTienCTKM.concat(val.m_dsTienCTKM)
              }
              this.kmld.dtiendatcoc_tt = val.tien_datcoc_tt
              this.kmld.dvatdatcoc_tt = val.vat_datcoc_tt
            }

            //Kiểm tra xem nếu không có tiền khuyến mại thì ưu tiên khuyến mại theo tỷ lệ
            if (this.kmld.dtienkmdc == 0) {
              if (this.kmld.tyle_kmld_tt > 0) {
                this.kmld.dtienkmdc = this.round((this.dtienld * this.kmld.tyle_kmld_tt) / 100)
                this.kmld.dvatkmdc = ((this.dtienld + this.dvatld) * this.kmld.tyle_kmld_tt) / 100 - this.kmld.dtienkmdc
              }
            }
            this.kmld.tong_kmld_tt = this.kmld.dtienkmdc + this.kmld.dvatkmdc

            //Hiếu bổ sung hàm kiểm tra xem user đã chọn chi tiết khuyến mại nào chưa - 23.09.2010
            if (this.dsDC_HDTB.length == 0) {
              this.kmld.tien_kmld_tt = 0
              this.kmld.vat_kmld_tt = 0
              this.kmld.tyle_kmld = 0
              this.kmld.tong_kmld_tt = 0
              this.kmld.dtiendatcoc_tt = 0
              this.kmld.dvatdatcoc_tt = 0
            }
            await this.HT_ThietBi()
            await this.HT_DichVuGT()
            await this.HienThiTienKhuyenMaiLapDat() //dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt);
            // await this.LayTongTien_HDTB()
            break
          case 'popup-Dangkychitietkhuyenmai':
            this.LaySothang_SD()
            this.dsKM_HDTB = val.dsKM_HDTB
            this.kmld.dtienkmld = val.tien_kmld
            this.kmld.dvatkmld = val.vat_kmld
            this.kmld.tyle_kmld = val.tyle_kmld
            this.kmld.tien_datcoc = val.tien_datcoc

            //Kiểm tra xem nếu không có tiền khuyến mại thì ưu tiên khuyến mại theo tỷ lệ
            if (this.kmld.dtienkmld == 0) {
              if (this.kmld.tyle_kmld > 0) {
                this.kmld.dtienkmld = this.round((this.dtienld * this.kmld.tyle_kmld) / 100)
                this.kmld.dvatkmld = ((this.dtienld + this.dvatld) * this.kmld.tyle_kmld) / 100 - this.kmld.dtienkmld
              }
            }
            this.kmld.tong_kmld = this.kmld.dtienkmld + this.kmld.dvatkmld

            //Hiếu bổ sung hàm kiểm tra xem user đã chọn chi tiết khuyến mại nào chưa - 23.09.2010
            if (this.dsKM_HDTB.length > 0) {
            } else {
              this.kmld.dtienkmld = 0
              this.kmld.dvatkmld = 0
              this.kmld.tong_kmld = 0
              this.kmld.tien_datcoc = 0
              this.kmld.tyle_kmld = 0
            }
            //HienThiTienKhuyenMaiLapDat(dtienkmld, dvatkmld, tien_datcoc);
            this.HT_ThietBi()
            this.HT_DichVuGT()
            this.HienThiTienKhuyenMaiLapDat() //dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt);
            // this.LayTongTien_HDTB()
            break
          case 'popupChonMaInGhep':
            if (val && val.hdmig_id) {
              this.thanhtoan.hdmig_id = val.hdmig_id
              this.thanhtoan.mainghep = val.main_ghep
            } else {
              if (this.hdtt_id && this.hdtt_id > 0)
                await API.post_lay_ds_hopdong_tt_theo_hdtt_id(this.axios, { hdtt_id: this.hdtt_id }).then(async (response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    await this.HienThiTTHopDongTT(response.data.data)
                  }
                })
            }
            break
          case 'popupDSSoChinh':
            this.thuebao.codinh.sochinh = val['ma_tb']
            this.thuebao.loaisochinh = val['loai']
            var iid_sochinh = val['id_sochinh']
            if (this.thuebao.loaisochinh == 1) this.thuebao.thuebao_id_cha = iid_sochinh
            else this.thuebao.hdtb_id_cha = iid_sochinh
            break
          case 'popupDSThueSo': {
            this.thuebao.codinh.sochinh = val['vma_tb']
            this.loaisoisdn = LOAISO.THUONG
            this.thuebaocd.kieu_thueso = val['kieu_thueso']
            this.thuebaocd.noidung_thueso = val['noidung_thueso']
            this.thuebaocd.sothang_thueso = val['sothang_thueso']
            let vtongdai_id = val['vdonvi_id']
            this.thuebao.thuebao_id = val['thuebao_id']
            this.thuebao.codinh.dgvTienCK.list = [];
            await API.post_fn_lay_tt_chon_sm(this.axios, {
              ds_para: JSON.stringify({
                DICHVUVT_ID: this.listbox.dichvu_vt.value,
                KIEULD_ID: this.listbox.kieu_ld.value,
                KHACHHANG_ID: this.khachhang.khachhang_id,
                TONGDAI_ID: vtongdai_id,
                NHOMSO_ID: val['vnhomso_id'],
                CHAPNHAN: 1,
                QUANLD_ID: this.diachiLD.QUAN_ID,
                PHUONGLD_ID: this.diachiLD.PHUONG_ID
              })
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                let apidata = JSON.parse(response.data.data)
                if (apidata['ERROR_CODE'] != 1) {
                  this.$toast.error(apidata['MESSAGE'])
                  return
                }
                this.thuebao.codinh.dgvTienCK.list = this.LowerCasePropertyList(apidata['RESULT']['DS_TIENCK'])
                if (apidata['RESULT']['DONVI_QL_ID'])
                  for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
                    if (this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.TRAM_VT || this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.HOST) {
                      let dl = this.DT_DV(i).filter((x) => x.id == apidata['RESULT']['DONVI_QL_ID'])
                      if (dl && dl.length > 0) this.DT_CONTROLS.value[i] = apidata['RESULT']['DONVI_QL_ID']
                    }
                  }
              }
            })
            break
          }
          case 'popupChonSMThue': {
            this.thuebao.codinh.sochinh = val['somay']
            this.loaisoisdn = LOAISO.THUONG
            this.thuebaocd.kieu_thueso = val['kieu_thueso']
            this.thuebaocd.noidung_thueso = val['noidung_thueso']
            this.thuebaocd.sothang_thueso = val['sothang_thueso']
            let vtongdai_id = val['tongdai_id']
            this.thuebao.codinh.dgvTienCK.list = [];
            await API.post_fn_lay_tt_chon_sm(this.axios, {
              ds_para: JSON.stringify({
                DICHVUVT_ID: this.listbox.dichvu_vt.value,
                KIEULD_ID: this.listbox.kieu_ld.value,
                KHACHHANG_ID: this.khachhang.khachhang_id,
                TONGDAI_ID: vtongdai_id,
                NHOMSO_ID: val['vnhomso_id'],
                CHAPNHAN: 1,
                QUANLD_ID: this.diachiLD.QUAN_ID,
                PHUONGLD_ID: this.diachiLD.PHUONG_ID
              })
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                let apidata = JSON.parse(response.data.data)
                if (apidata['ERROR_CODE'] != 1) {
                  this.$toast.error(apidata['MESSAGE'])
                  return
                }
                this.thuebao.codinh.dgvTienCK.list = this.LowerCasePropertyList(apidata['RESULT']['DS_TIENCK'])
                if (apidata['RESULT']['DONVI_QL_ID'])
                  for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
                    if (this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.TRAM_VT || this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.HOST) {
                      let dl = this.DT_DV(i).filter((x) => x.id == apidata['RESULT']['DONVI_QL_ID'])
                      if (dl && dl.length > 0) this.DT_CONTROLS.value[i] = apidata['RESULT']['DONVI_QL_ID']
                    }
                  }
              }
            })
            break
          }
          case 'popupDSTBCungDoiCapMGWAN':
            if (this.listbox.kieu_ld.value == KieuLapDat.TACH_VLAN) {
              let pdata = { KHACHHANG_ID: this.khachhang.khachhang_id, THUEBAO_ID: this.thuebao.thuebao_id, PHUONGLD_ID: this.diachiLD.PHUONG_ID, PHOLD_ID: this.diachiLD.PHO_ID, APLD_ID: this.diachiLD.AP_ID, KHULD_ID: this.diachiLD.KHU_ID, DACDIEMLD_ID: this.diachiLD.DACDIEM_ID }
              API.post_fn_lay_tt_matn_wan(this.axios, { ds_para: pdata }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  let apidata = JSON.parse(response.data.data)
                  if (apidata['ERROR_CODE'] != 1) {
                    this.$toast.error(apidata['MESSAGE'])
                    return
                  }
                  apidata = apidata['RESULT']
                  if (apidata['DS_DIACHI'] && apidata['DS_DIACHI'].length > 0) this.HienThiTTDiaChi(apidata['DS_DIACHI'], 3)
                  if (apidata['DS_DVI']) this.XuLyDonViLD(apidata['DS_DVI'])
                }
              })
              // TODO check lai cac xu ly tiep theo co ve da xu ly o su kien thay doi diachiLD
              await this.LAY_DONVI_THEO_LOAIDV_DIACHI_LD_V2()

              await this.LoadMucCuocTB() // Thay cho ham Lay_DS_MucCuoc_TB(khuld_id, apld_id, phold_id, phuongld_id, this.listbox.loaihinh_tb.value, this.listbox.doituong.value, dtpNgayYeuCau.Value.ToString("dd/MM/yyyy"));
              //Nếu DichVuVT là TSL  va MyTV thì sinh lại mã
              if (
                this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN ||
                this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM ||
                (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL &&
                  (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B || this.listbox.loaihinh_tb.value == LoaiHinhTB.MAIL_SMD || this.listbox.loaihinh_tb.value == LoaiHinhTB.Web_Hosting))
              )
                await this.SinhMaDVVT()

              // minhnt: hiển thị nv kinh doanh theo địa bàn
              this.HT_NV_KinhDoanh_Theo_DiaBan() //HT_NV_KinhDoanh_Theo_DiaBan(quanld_id, phuongld_id, phold_id, apld_id, khuld_id, Convert.ToInt32(cboDonViQL.SelectedValue), dacdiemld_id); // Loai bo tham so vi dung tham so global
              if ([DichVuVienThong.MEGAWAN, DichVuVienThong.TSL, DichVuVienThong.NOIBO_2DIEM, DichVuVienThong.NOIBO_DADIEM, DichVuVienThong.ADSL, LoaiHinhTB.INTERNET_MYTV, LoaiHinhTB.INTERNET_MYTV_B2B, LoaiHinhTB.MAIL_SMD, LoaiHinhTB.Web_Hosting].indexOf(this.listbox.dichvu_vt.value * 1) >= 0) await this.SinhMaDVVT()
            }
            this.thuebao.mgwan.matn = val.MA_TB
            this.thuebao.mgwan.madoicap = val.MADOICAP
            break
          case 'popupDSTBCungDoiCap':
          case 'popupDSTBLapKem':
          case 'popupDSTBCungDoiCap_KH_Khac':
            this.thuebaocd.matn = val.MA_TB
            this.thuebaocd.madoicap = val.MADOICAP
            break
          case 'popupDSTBLapKemMGWAN':
          case 'popupDSTBCungDoiCap_KH_KhacMGWAN':
            this.thuebao.mgwan.matn = val.MA_TB
            this.thuebao.mgwan.madoicap = val.MADOICAP
            break
          case 'popupDSTBCungDoiCapIMS':
          case 'popupDSTBLapKemIMS':
          case 'popupDSTBCungDoiCap_KH_KhacIMS':
            this.thuebao.ims.txtMaTN_IMS = val.MA_TB
            this.thuebao.ims.txtMaDoiCap_IMS = val.MADOICAP
            break
          case 'popupDSTBCungDoiCapADSL':
          case 'popupDSTBLapKemADSL':
          case 'popupDSTBCungDoiCap_KH_KhacADSL':
            this.thuebao.adsl.txtMaTN_ADSL = val.MA_TB
            this.thuebao.adsl.txtMaDoiCap_ADSL = val.MADOICAP
            break
          case 'popupDSTBCungDoiCapCNTT':
          case 'popupCaptcha':
            if (val) this.popupRetVal = val
            else this.popupRetVal = {}
            // grcMacdinh.RefreshDataSource();
            break
          // case "popupChonSMTheoHost": // Chuyen len tren vi bao trung code
          //   if(!val.somay) return;
          //   this.thuebao.codinh.somay = val.somay;
          //   this.thuebao.codinh.arraySoMay = val.arraySoMay?val.arraySoMay:[];
          //   this.loaisoisdn = val.loaiso;
          //   API.post_sp_lay_danhsach_tiencamket(this.axios, val.nhomso).then(
          //   (response) => {
          //     if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          //       this.thuebao.codinh.dgvTienCK.list=response.data.data;
          //     }
          //   });
          //   let vtien_sodep = val.tiensodep?val.tiensodep:0;
          //   for(var item of this.ds_tien_khoanmuc)
          //     if(item['khoanmuctt_id']==23) {
          //       item['tien'] = vtien_sodep;
          //       item['vat'] = vtien_sodep*0.1;
          //       this.LayTongTien_HDTB();
          //       break;
          //     }

          //   break;
          case 'popupDSHuongKN':
            this.thuebao.mgwan.huongkn = val.vma_tb
            this.thuebao.mgwan.vhuongkn = val.vma_tb
            this.diachiKN.DIACHI = val.diachi_ld
            this.thuebao.loaisochinh = val.iloai // FIXME check lai cho nay xem link vao dau????
            this.listbox.tinh_kn.value = val.itinh_kn_id
            if (val.vrf) this.thuebao.mgwan.vrfvfi = val.vrf
            //TODO 2 phan ben duoi can them API:
            /*
                                    "txtVrf_Mgwan.Text = objCheckData.MAP_ID(""vrf"", DatabaseConstants.DB2 + "".db_mgwan"", ""where thuebao_id = "" + thuebao_id_cha);
                                    -> Đề xuất API viết
                                    select nvl(vrf,'-1') from css.db_mgwan where thuebao_id=p_thuebao_id_cha and phanvung_id=p_phanvung_id
                                    -----------------------------------
                                    txtVrf_Mgwan.Text = objCheckData.MAP_ID(""vrf"", DatabaseConstants.DB2 + "".hdtb_mgwan"", ""where hdtb_id = "" + hdtb_id_cha);
                                    -> Đề xuất API viết
                                    select nvl(vrf,'-1') from css.hdtb_mgwan where hdtb_id=p_hdtb_id_cha and phanvung_id=p_phanvung_id"
                                    */
            //console.log(this.thamsomacdinh,this.thamsomacdinh['TUDONG_LAY_VRF_VFI_THEO_HUONGKN']);
            if (this.thuebao.loaisochinh == 1) {
              this.thuebao.thuebao_id_cha = val.iid_sochinh
              if (this.thamsomacdinh['TUDONG_LAY_VRF_VFI_THEO_HUONGKN'] == 1)
                API.post_ds_huong_kn_vrf1(this.axios, { id: val.iid_sochinh }).then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    if (response.data.data['VRF'] || (response.data.data[0] && response.data.data[0]['VRF'])) this.thuebao.mgwan.vrfvfi = response.data.data['VRF'] ? response.data.data['VRF'] : response.data.data[0]['VRF']
                  }
                })
            } else {
              this.thuebao.hdtb_id_cha = val.iid_sochinh
              if (this.thamsomacdinh['TUDONG_LAY_VRF_VFI_THEO_HUONGKN'] == 1)
                API.post_ds_huong_kn_vrf2(this.axios, { id: val.iid_sochinh }).then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    if (response.data.data['VRF'] || (response.data.data[0] && response.data.data[0]['VRF'])) this.thuebao.mgwan.vrfvfi = response.data.data['VRF'] ? response.data.data['VRF'] : response.data.data[0]['VRF']
                  }
                })
            }
            break
          case 'popupTieuNganh':
            this.tieunganh = val
            break
          case 'popupTT_Fsecure_kem_ftth':
            this.thuebao.adsl.txtDienThoai_Fsecure = val.so_dt // sodt_fsecure_kem
            this.thuebao.adsl.kh_cd_fsecure = val.kh_cd_fsecure
            let _matb_tn = this.thuebao.adsl.txtAccountADSL.trim()
            let _madoicap = this.thuebao.adsl.txtMaDoiCap_ADSL.trim()
            this.listbox.dichvu_vt.value = DichVuVienThong.ANTOAN_BAOMAT_TT
            this.listbox.loaihinh_tb.value = LoaiHinhTB.FSECURE
            this.listbox.kieu_ld.value = this.kieuld_fsecure_kem_fiber
            this.tocdotn_id = FSECURE_KM_12_MONTHS.FreeFSD12M_2018 // TOCDO_ID_CFreeFSD12M;// TOCDO_ID_V2;
            this.muccuoctn_id = 0
            this.listbox.cboGoiCuocAdsl.value = this.tocdotn_id
            try {
              let pdata = {
                kieuLdId: this.listbox.kieu_ld.value,
                loaiHdId: this.buttonSet == 1 ? LoaiHopDong.DAT_MOI : '1',
                loaiTbId: this.listbox.loaihinh_tb.value,
                mucCuocId: this.muccuoctn_id, //(this.listbox.muccuoc.value && this.listbox.muccuoc.value>0)?this.listbox.muccuoc.value:-1,
                tocDoId: 0 //this.tocdo_id?this.tocdo_id:-1
              }
              this.huonggiao_tn = 0
              this.quytrinh_tn = 0
              this.luong_id = 0

              await API.post_lay_huonggiao_tiepnhan(this.axios, pdata).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  let dulieuapi = response.data.data
                  if (dulieuapi['huonggiao_id']) this.huonggiao_tn = dulieuapi['huonggiao_id']
                  if (dulieuapi['quytrinh_id']) this.quytrinh_tn = dulieuapi['quytrinh_id']
                  if (dulieuapi['luong_id']) this.luong_id = dulieuapi['luong_id']
                } else throw 'Nghiệp vụ "Đặt mới Fsecure kèm FTTH" chưa được thiết lập quy trình, bạn hãy liên hệ Admin để xử lý!'
              })

              // #region "Tao du lieu"

              this.dsHDTB_CD = []
              this.dsHDTB_DD = []
              this.dsHDTB_ADSL = []
              this.dsHDTB_TSL = []
              this.dsHDTB_MEWAN = []
              this.dsHDTB_GP = []
              this.dsHDTB_IMS = []
              this.dsCAMKET_HDTB = []
              //dsHDTBDV = new HDTB_DV_DATA();
              this.dsHDTBDV_Fsecure = []
              this.dsTien_HDTB = []
              this.dsDK_DVGT = []

              this.TaoDuLieu_HDTB_Fsecure_kem()
              this.TaoDuLieu_HDTT(false) //TuấnNA thêm code để cập nhật matb_dd trong nút thêm thuê bao -- ngày 18.03.2011
              //Thêm mới thongtintt, cttien 17/09/2010
              //TaoDuLieu_THONGTIN_TT(true);
              this.TaoDuLieu_CT_TIENHD_fsecure_kem(true)
              //
              this.TaoDuLieu_TIEN_DATCOC_Fsecure_kem(true)
              this.TaoDuLieu_DiaChi(true, 3)

              this.CapNhat_HDTB_ID_HDTB_KV_ThemTB()

              this.TaoDuLieu_HDTB_CNTT_Fsecure_kem(_matb_tn, _madoicap)
              // #endregion

              pdata1 = {
                HD_THUEBAO: this.dsHDTB,
                HDTB_DV: this.dsHDTBDV,
                HDTB_CD: this.dsHDTB_CD,
                HDTB_DD: this.dsHDTB_DD,
                HDTB_INT: this.dsHDTB_INT,
                HDTB_ADSL: this.dsHDTB_ADSL,
                DIACHI: this.DIACHI,
                DIACHI_HDTB: this.dsDiaChiHDTB,
                CT_MUA_TBI: this.dsCTM_TBI,
                HDTB_MGWAN: this.dsHDTB_MEWAN, //dsHDTB_MEWAN
                HDTB_TSL: this.dsHDTB_TSL, //dsHDTB_TSL
                HDTB_GP: this.dsHDTB_GP, //dsHDTB_GP
                // KHUYENMAI_HDTB:this.KHUYENMAI_HDTB,
                KHUYENMAI_HDTB: this.dsKM_HDTB && this.dsKM_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsKM_HDTB) : this.dsKM_HDTB,
                DATCOC_HDTB: this.dsDC_HDTB && this.dsDC_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsDC_HDTB) : this.dsDC_HDTB,
                CT_TIENHD: this.dsCTTHD,
                TIEN_HDTB: this.dsTien_HDTB, //this.dsTien_HDTB,
                TIEN_DATCOC: this.dsTien_DatCoc,
                HD_THANHTOAN: this.dsHDTT,
                HDTB_IMS: this.dsHDTB_IMS, //dsHDTB_IMS
                HD_IMS: this.dsHDTB_IMS,
                CAMKET_HDTB: this.dsCAMKET_HDTB,
                HDTB_KV: this.dsHDTB_KV, //this.dsHDTB_KV_tmp?this.dsHDTB_KV_tmp:this.dsHDTB_KV, da bo _tmp
                HDTB_CNTT: this.dsHDTB_CNTT, //dsHDTB_CNTT
                HUONGGIAO_ID: this.huonggiao_tn
              }
              await API.fn_themmoi_tudong_hdtb_fsecure(this.axios, pdata).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  //Khong thay xu ly gi o day!
                  //Gọi hàm cập nhật trạng thái HDTB = 1: Đã đặt chỗ thành công trên VDC
                  // laphd.CAPNHAT_STATUS_HDTB(hdtb_id, TRANGTHAI_DONGBO.CHUADONGBO); // Ham nay da xu ly o API tren cung viec them moi
                }
              })
            } catch (ex) {
              this.$toast.error('' + ex)
              if (this.debug) console.error(ex)
            }
            break
          case 'popupThongTinTC':
            if (val) this.thuebao.adsl.txtTTCuoc = val
            else this.thuebao.adsl.txtTTCuoc = ''
            break
          case 'popupChonSMTSLDau':
            if (this.thuebao.tsl.txtSoAoTSL_Cuoi && this.thuebao.tsl.txtSoAoTSL_Cuoi.trim() != '') {
              if (val.somay == this.thuebao.tsl.txtSoAoTSL_Cuoi.trim()) {
                this.$toast.error('Số ảo điểm đầu phải khác số ảo điểm cuối !')
                // btnSoAoTSL_Dau.Focus();
                return
              }
            }
            this.thuebao.tsl.txtSoAoTSL_Dau = val.somay
            break
          case 'popupChonSMTSLCuoi':
            if (this.thuebao.tsl.txtSoAoTSL_Dau && this.thuebao.tsl.txtSoAoTSL_Dau.trim() != '') {
              if (val.somay == this.thuebao.tsl.txtSoAoTSL_Dau.trim()) {
                this.$toast.error('Số ảo điểm đầu phải khác số ảo điểm cuối !')
                // btnSoAoTSL_Dau.Focus();
                return
              }
            }
            this.thuebao.tsl.txtSoAoTSL_Cuoi = val.somay
            break
          case 'popupChonSoMayGphone':
            this.thuebao.gphone.txtSoMayGP = val.somay
            this.thuebao.gphone.txtSoSimGphone = val.simcard
            this.thuebao.gphone.dgvTienCKGP.list = [];
            API.post_sp_lay_danhsach_tiencamket(this.axios, { nhomso_id: val.nhomso }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.thuebao.gphone.dgvTienCKGP.list = response.data.data
              }
            })
            break
          case 'popupChonSoMayIMS':
            this.thuebao.ims.txtMaTBIMS = val.somay
            this.thuebao.ims.arraySoMay = val.arraySoMay ? val.arraySoMay : []
            this.thuebao.ims.dgvTienCKIMS.list = [];
            API.post_sp_lay_danhsach_tiencamket(this.axios, { nhomso_id: val.nhomso }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.thuebao.ims.dgvTienCKIMS.list = response.data.data
                //Lấy tiền số đẹp vào dataset tiền khoản mục
                let vtien_sodep = val.tiensodep
                for (var item of this.ds_tien_khoanmuc) {
                  if (item['khoanmuctt_id'] == 23) {
                    item['tien'] = vtien_sodep
                    item['vat'] = this.round(vtien_sodep * 0.1)
                    this.LayTongTien_HDTB()
                    break
                  }
                }
              }
            })
            break
          case 'popupChonMauHDDT':
            if (val && val.soluong) {

              for(var i = 0; i < this.ItemList.length; i++)
                if (ItemList[i].sFieldName == 'SL_MAILING') {
                  this.ItemList[i].sValue = val.soluong
                  this.gridEditors[i].Value = val.soluong
                }
              if (val.dsHDTB_CT && val.dsHDTB_CT.length > 0) this.dsHDTB_CT = val.dsHDTB_CT
            }
            break
          case 'popupLayDuLieuTuAPI':
            this.ItemList[val.vitri].sValue = val.giatrichon
            this.gridEditors[val.vitri].Value = val.giatrichon
            const get_loaitb_id = this.listbox.loaihinh_tb.value
            //Hoannc
            const data_api = await API.fn_kiemtra_hienthi_tentruong_edu(this.axios, { loaitb_id: get_loaitb_id })
            if (data_api.data.data == 'OK') {
              const tentruong = val.bangtrave[0].ten_truong
              for (var j = 0; j < this.ItemList.length; j++) {
                if (this.ItemList[j].sFieldName == 'THUONGHIEU') {
                  this.ItemList[j].sValue = tentruong
                  this.gridEditors[j].Value = tentruong
                  break
                }
              }
            }
            break
          case 'popupDangKySoLienLac':
            for (var j = 0; j < this.ItemList.length; j++) {
              if (this.ItemList[j].sFieldName == 'SL_MAILING') {
                this.ItemList[j].sValue = val.tong_tien
                this.gridEditors[j].Value = val.tong_tien
                break
              }
            }
            for (var j = 0; j < this.ItemList.length; j++) {
              if (this.ItemList[j].sFieldName == 'SOLUONG') {
                this.ItemList[j].sValue = val.tongso_hs
                this.gridEditors[j].Value = val.tongso_hs
                break
              }
            }
            break
          case 'popupChiTietHDTB':
            this.dsHDTB_CT = val.dsHDTB_CT
            for (let i = 0; i < this.ItemList.length; i++) {
              if((this.listbox.dichvu_vt.value == LoaiHinhTB.VNEDU_SMARTID && this.ItemList[i].sFieldName == 'SL_MAILING')
                || (this.listbox.dichvu_vt.value == LoaiHinhTB.VNPT_SMCC && this.ItemList[i].sFieldName == 'DOITAC')
              ) {
                this.ItemList[i].sValue = this.dsHDTB_CT.length
                this.gridEditors[i].Value = this.dsHDTB_CT.length
              }
            }
            break

          case 'frmNhapDSThanhVien':
            this.dsHDTB_CT = val._ds_hdtbct
            break

          case 'popupChonSo_CNTT':
            for (let i = 0;i < this.ItemList.length ; i++) {
              if (this.ItemList[i].sFieldName == 'MA_TB') {
                this.ItemList[i].sValue = val.somay
                this.gridEditors[i].Value = val.somay
              }
              if (this.ItemList[i].sFieldName == 'DONVIKG_ID')
              {
                this.ItemList[i].sValue = val.kieuso
                this.gridEditors[i].Value = val.kieuso
              }
              if (this.ItemList[i].sFieldName == 'CUOC_SD') {
                this.ItemList[i].sValue = val.tiensodep
                this.gridEditors[i].Value = val.tiensodep
              }
            }

            break
          case 'popupHDTB_CNTT_SUB':
          case 'frmChonDoiTuong_CT':
          default:
            this.popupRetVal = val
            //Chuc nang popup nay chua thay xu ly gi sau khi dong popup, tam thoi ko code
            break
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      } finally {
        this.ClosePopup('popupComponents')
        this.loading(false)
      }
    },
    HT_NV_KinhDoanh_Theo_DiaBan() {
      let pdata = {
        ap_id: this.diachiLD.AP_ID,
        dacdiem_id: this.diachiLD.DACDIEM_ID,
        donvi_ql_id: this.listbox.donvi_ql.valueql ? this.listbox.donvi_ql.valueql : 0,
        khu_id: this.diachiLD.KHU_ID,
        pho_id: this.diachiLD.PHO_ID,
        phuong_id: this.diachiLD.PHUONG_ID,
        quan_id: this.diachiLD.QUAN_ID
      }
      API.post_sp_ht_kv_cskh_theo_diaban(this.axios, pdata).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let ds = response.data.data
          if (ds.length > 1) {
            if(!this.thuebao || !this.thuebao.khuvuc_id || !this.thuebao.khuvuc || !ds.find(x=>x.ten_kv==this.thuebao.khuvuc && x.khuvuc_id==this.thuebao.khuvuc_id)) {
              this.popupQueue.push({
                component: () => import('./Popups/popupGanKhuVucQuanLyThueBao'),
                name: 'popupChonKhuVuc',
                data: { diachi: this.diachiLD, khuvuc_id: this.thuebao.khuvuc_id, hdtb_id: this.hdtb_id, thuebao_id: this.thuebao.thuebao_id, donvi_id: this.listbox.donvi_ql.value }
              })
              this.ShowPopupQueue()
            }
            // this.popupComponent = ()=>import('./Popups/popupGanKhuVucQuanLyThueBao');
            // this.popupComponentName = "popupChonKhuVuc";
            // this.popupComponentData = {diachi:this.diachiLD, khuvuc_id: this.thuebao.khuvuc_id, hdtb_id: this.hdtb_id,thuebao_id: this.thuebao.thuebao_id, donvi_id: this.listbox.donvi_ql.value }
            // //if(this.dsCTM_TBI && this.dsCTM_TBI.length>0) this.popupComponentData.ds = this.dsCTM_TBI;
            // this.Popup('popupComponents');
          } else if (ds.length > 0) {
            this.thuebao.khuvuc = ds[0]['ten_kv']
            this.thuebao.khuvuc_id = ds[0]['khuvuc_id']
            this.dsHDTB_KV = [
              {
                HDTB_ID: this.hdtb_id,
                KHUVUC_ID: this.thuebao.khuvuc_id,
                LOAIKV_ID: LOAI_KV.KHUVUC_DIABAN,
                NGAY_CN: new Date().toLocaleDateString('en-GB'),
                MAY_CN: this.$root.token.getMaNhanVien(),
                NGUOI_CN: this.$root.token.getNguoiDungID(),
                IP_CN: 'x.x.x.x'
              }
            ]
          } else {
            this.thuebao.khuvuc = ''
            this.dsHDTB_KV = []
            this.thuebao.khuvuc_id = 0
          }
        }
      })
    },
    btnSite_ID_Click() {
      this.loading(true)
      API.post_lay_ds_tram_bts(this.axios, {})
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let ds = response.data.data
            if (ds.length > 0) {
              this.popupComponent = () => import('./Popups/popupChonGrid')
              this.popupComponentName = 'popupChon_Site_ID'
              this.popupComponentData = {
                ds: ds,
                cols: [
                  { fieldName: 'stt', headerText: 'STT', allowFiltering: false, allowSorting: false },
                  { fieldName: 'bts_id', headerText: 'BTS_ID', allowFiltering: true, allowSorting: true },
                  { fieldName: 'ma_bts', headerText: 'Mã BTS', allowFiltering: true, allowSorting: true },
                  { fieldName: 'ten_bts', headerText: 'Tên BTS', allowFiltering: true, allowSorting: true }
                ],
                keycol: 'bts_id',
                allowExit: false,
                tieude: 'Chọn BTS',
                tieudebang: ''
              }
              this.Popup('popupComponents')
            } else {
              this.$toast.error('Không có dữ liệu trạm cho khu vực này!')
            }
          } else if (response.data.error == 204) this.$toast.error('Không có dữ liệu trạm cho khu vực này!')
        })
        .catch()
        .finally(() => {
          this.loading(false)
        })
    },
    getDiaChi: function(data, datatype) {
      if (!this[datatype]) this[datatype] = {}
      this[datatype].DIACHI = data.diachimoi
      this[datatype].TINH_ID = data.tinh_id
      this[datatype].QUAN_ID = data.quan_id
      this[datatype].PHUONG_ID = data.phuong_id
      this[datatype].PHO_ID = data.pho_id
      this[datatype].AP_ID = data.ap_id
      this[datatype].KHU_ID = data.khu_id
      this[datatype].DACDIEM_ID = data.dacdiem_id
      this[datatype].SO_NHA = data.so_nha
      this[datatype].BLOCK = data.block
      this[datatype].TANG = data.tang
      this[datatype].PHONG = data.phong
      this[datatype].MOTA = data.motathem
      this[datatype].Lat = data.lat
      this[datatype].Lng = data.lng
      if(data.sophong) this[datatype].SOPHONG = data.sophong
      if(data.sotang) this[datatype].SOTANG = data.sotang
      if(data.dientich) this[datatype].DIENTICH = data.dientich
      if(data.loainha_id) this[datatype].LOAINHA_ID = data.loainha_id
      if(data.nhomln_id) this[datatype].NHOMLN_ID = data.nhomln_id
      this[datatype] = JSON.parse(JSON.stringify(this[datatype]));
    },
    getDiaChiKH: function(data) {
      this.getDiaChi(data, 'diachiKH')
      //TODO tim don vi quanly cboDonViQL
      //this.listbox.donvi_ql.value="";
      if (!this.diachiTT.DIACHI) this.diachiTT = Object.assign({}, this.diachiKH)
      if (!this.diachiCT.DIACHI) this.diachiCT = Object.assign({}, this.diachiKH)
      if (!this.diachiLD.DIACHI) this.diachiLD = Object.assign({}, this.diachiKH)
      if (!this.diachiTB.DIACHI) this.diachiTB = Object.assign({}, this.diachiKH)
      if (!this.diachiHK.DIACHI) this.diachiHK = Object.assign({}, this.diachiKH)
      if (!this.diachiNDD.DIACHI) this.diachiNDD = Object.assign({}, this.diachiKH)
    },
    getDiaChiHK: function(data) {
      this.getDiaChi(data, 'diachiHK')
    },
    getDiaChiNDD: function(data) {
      this.getDiaChi(data, 'diachiNDD')
    },
    getDiaChiTT: async function(data) {
      this.getDiaChi(data, 'diachiTT')
      // if ([DichVuVienThong.MEGAWAN, DichVuVienThong.TSL, DichVuVienThong.ADSL, LoaiHinhTB.INTERNET_MYTV, LoaiHinhTB.MAIL_SMD, LoaiHinhTB.Web_Hosting].indexOf(this.listbox.dichvu_vt.value * 1) >= 0) await this.SinhMaDVVT()
    },
    getDiaChiCT: function(data) {
      this.getDiaChi(data, 'diachiCT')
    },
    getDiaChiBC: function(data) {
      this.getDiaChi(data, 'diachiBC')
    },
    getDiaChiTB: async function(data) {
      this.getDiaChi(data, 'diachiTB')
      if (!this.diachiLD.DIACHI || (this.diachiLD.DIACHI == this.diachiKH.DIACHI && this.diachiLD.DIACHI != this.diachiTB.DIACHI)) this.diachiLD = Object.assign({}, this.diachiTB)
      // if ([DichVuVienThong.MEGAWAN, DichVuVienThong.TSL, DichVuVienThong.ADSL].indexOf(this.listbox.dichvu_vt.value * 1) >= 0 || [LoaiHinhTB.INTERNET_MYTV, LoaiHinhTB.MAIL_SMD, LoaiHinhTB.Web_Hosting].indexOf(this.listbox.loaihinh_tb.value * 1) >= 0) await this.SinhMaDVVT()
    },
    getDiaChiTBCu: async function(data) {
      this.getDiaChi(data, 'diachiTBCu')
    },
    getDiaChiHKTBCu: async function(data) {
      this.getDiaChi(data, 'diachiHKTBCu')
    },
    getDiaChiLD: function(data) {
      this.getDiaChi(data, 'diachiLD')
    },
    getDiaChiKN: function(data) {
      this.getDiaChi(data, 'diachiKN')
    },
    getDiaChiDau: async function(data) {
      this.getDiaChi(data, 'diachiDau')
      let ds = await API.post_lay_ds_donviql(this.axios, {
        vap_id: this.diachiDau.AP_ID ? this.diachiDau.AP_ID : 0,
        vkieu: 2,
        vkhu_id: this.diachiDau.KHU_ID ? this.diachiDau.KHU_ID : 0,
        vpho_id: this.diachiDau.PHO_ID ? this.diachiDau.PHO_ID : 0,
        vphuong_id: this.diachiDau.PHUONG_ID
      })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return response.data.data ? response.data.data : []
        })
        .catch(() => {
          return []
        })

      // this.listbox.donvi_dau.list = ds && ds.length>0?ds:[];

      if (!ds || ds.length <= 0) {
        if (this.listbox.donvi_dau.list.length != 1) {
          this.$toast.error('Địa danh này chưa được gán Loại đơn vị Trạm thi công điểm đầu. Hãy liên hệ với Admin để xử lý!')
          return
        }
      } else if (ds.length == 1) {
        this.thuebao.tsl.donvi_dau_id = ds[0]['donvi_id']
        this.LoadDonViDauCuoiCombobox(1)
      } else {
        this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonGrid')
        this.popupComponentName = 'popupChonDVDau'
        this.popupComponentData = {
          ds: this.UpperCasePropertyList(ds),
          cols: [
            { fieldName: 'DONVIQL_ID', headerText: 'ID', allowFiltering: false, allowSorting: false },
            { fieldName: 'TEN_DVQL', headerText: 'Đơn vị', allowFiltering: false, allowSorting: false },
            { fieldName: 'TEN_DV', headerText: 'Tổ thi công', allowFiltering: false, allowSorting: false }
          ],
          keycol: 'DONVIQL_ID',
          allowExit: false,
          tieude: 'Chọn đơn vị quản lý',
          tieudebang: 'Danh sách đơn vị'
        }
        this.Popup('popupComponents')
      }
    },
    getDiaChiCuoi: async function(data) {
      this.getDiaChi(data, 'diachiCuoi')
      let ds = await API.post_lay_ds_donviql(this.axios, {
        vap_id: this.diachiCuoi.AP_ID ? this.diachiCuoi.AP_ID : 0,
        vkieu: 2,
        vkhu_id: this.diachiCuoi.KHU_ID ? this.diachiCuoi.KHU_ID : 0,
        vpho_id: this.diachiCuoi.PHO_ID ? this.diachiCuoi.PHO_ID : 0,
        vphuong_id: this.diachiCuoi.PHUONG_ID
      })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return response.data.data ? response.data.data : []
        })
        .catch(() => {
          return []
        })
      // this.listbox.donvi_cuoi.list = ds && ds.length>0?ds:[];
      if (!ds || ds.length <= 0) {
        if (this.listbox.donvi_cuoi.list.length != 1) {
          this.$toast.error('Địa danh này chưa được gán Loại đơn vị Trạm thi công điểm cuối. Hãy liên hệ với Admin để xử lý!')
          return
        }
      } else if (ds.length == 1) {
        this.thuebao.tsl.donvi_cuoi_id = ds[0]['donvi_id']
        this.LoadDonViDauCuoiCombobox(2)
      } else {
        this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonGrid')
        this.popupComponentName = 'popupChonDVCuoi'
        this.popupComponentData = {
          ds: this.UpperCasePropertyList(ds),
          cols: [
            { fieldName: 'DONVIQL_ID', headerText: 'ID', allowFiltering: false, allowSorting: false },
            { fieldName: 'TEN_DVQL', headerText: 'Đơn vị', allowFiltering: false, allowSorting: false },
            { fieldName: 'TEN_DV', headerText: 'Tổ thi công', allowFiltering: false, allowSorting: false }
          ],
          keycol: 'DONVIQL_ID',
          allowExit: false,
          tieude: 'Chọn đơn vị quản lý',
          tieudebang: 'Danh sách đơn vị'
        }
        this.Popup('popupComponents')
      }
    },
    LoadDonViDauCuoiCombobox(loaidv) {
      let diachi = loaidv == 1 ? this.diachiDau : this.diachiCuoi
      let dv_id = loaidv == 1 ? this.thuebao.tsl.donvi_dau_id : this.thuebao.tsl.donvi_cuoi_id
      let donvi = loaidv == 1 ? this.listbox.donvi_dau : this.listbox.donvi_cuoi
      let api1 = API.post_fn_lay_tt_dvi_daucuoi(this.axios, {
        ds_para: JSON.stringify({ QUAN_ID: diachi.QUAN_ID, PHUONG_ID: diachi.PHUONG_ID, PHO_ID: diachi.PHO_ID ? diachi.PHO_ID : 0, AP_ID: diachi.AP_ID ? diachi.AP_ID : 0, KHU_ID: diachi.KHU_ID ? diachi.KHU_ID : 0, TINHKHAC: 0, KIEULD_ID: 2 })
      })
      let api2 = API.post_sp_ht_donvi_ldv(this.axios, { donvi_id: dv_id, loaidvi_id: LOAI_DV.TRAM_VT })
      Promise.all([api1, api2]).then(([resp1, resp2]) => {
        if (resp2 && resp2.data && resp2.data.data && resp2.data.data.length > 0) donvi.list = resp2.data.data
        else donvi.list = []
        if (resp1 && resp1.data && resp1.data.data && resp1.data.data.length > 0) {
          let apidata = JSON.parse(resp1.data.data)
          if (apidata['ERROR_CODE'] == 1) {
            if (apidata['RESULT'] && apidata['RESULT']['VETINH_ID']) donvi.value = apidata['RESULT']['VETINH_ID']
            else this.$toast.error(`Địa danh này chưa được gán Loại đơn vị Trạm thi công điểm ${loaidv == 1 ? 'đầu' : 'cuối'}. Hãy liên hệ với Admin để xử lý!`)
          } else if (apidata['ERROR_CODE'] == -2) {
            let ds = JSON.parse(JSON.stringify(donvi.list))
            this.UpperCasePropertyList(ds)
            this.popupComponent = () => import('../InstallNewSubs/Popups/popupChonGrid')
            this.popupComponentName = loaidv == 1 ? 'popupChonDVDau2' : 'popupChonDVCuoi2'
            this.popupComponentData = {
              ds: ds,
              cols: [
                { fieldName: 'DONVI_ID', headerText: 'ID', allowFiltering: false, allowSorting: false },
                { fieldName: 'TEN_DV', headerText: 'TÊN', allowFiltering: false, allowSorting: false }
              ],
              keycol: 'DONVI_ID',
              allowExit: false,
              tieude: 'Chọn đơn vị',
              tieudebang: 'Danh sách đơn vị'
            }
            this.Popup('popupComponents')
          } else this.$toast.error(`Lỗi lấy đơn vị Trạm thi công điểm ${loaidv == 1 ? 'đầu' : 'cuối'}: ${apidata['MESSAGE']}`)
        }
      })
    },
    popupTimNVThuCuoc: function(diachi) {
      //this.$refs.refTimNVThuCuoc.openDialog()
      this.nvtcInput = Object.assign({}, diachi && diachi.PHUONG_ID && diachi.PHUONG_ID != 0 ? diachi : this.diachiTT)
      if (this.listbox.donvi_ql.valueql) this.nvtcInput.DONVIQL_ID = this.listbox.donvi_ql.valueql
      this.nvtcInput.HTTT_ID = this.listbox.hinhthuc_tt.value
      this.nvtcInput.DisableHTTT = true
      //this.$bvModal.show('dlgTimKiemNVTC')
      let checkexists = false
      for (var item of this.popupQueue)
        if (item.id == 'dlgTimKiemNVTC') {
          checkexists = true
          break
        }
      if (!checkexists) {
        this.popupQueue.push({ id: 'dlgTimKiemNVTC' })
        this.ShowPopupQueue()
      }
      // this.$refs.dlgTimKiemNVTC.openDialog();
      //this.$toast.error('Chức năng chưa được phát triển')
    },
    // getNVTCProcess(value) {
    //   //this.params.quanHuyen_Selected = Number(value.quanId);
    //   //this.params.nhanVienXLMoi_Selected = Number(value.nhanVienTC_Id);
    //   this.thanhtoan.nhanvientc_id = value.rowData.NHANVIEN_ID;
    //   this.thanhtoan.manvtc = value.maNVTC;
    //   this.thanhtoan.tuyenthu_id = value.rowData.TUYENTHU_ID;
    //   this.thanhtoan.matuyen = value.rowData.MA_TUYENTHU;
    // },
    getNVTCProcess(data) {
      this.thanhtoan.nhanvientc_id = data.nhanvientc_id
      this.thanhtoan.manvtc = data.ma_nvtc
      this.thanhtoan.tuyenthu_id = data.tuyenthu_id
      this.thanhtoan.matuyen = data.ma_tuyen
    },
    getTTTBHandler(e) {
      this.popupbox.nvtc = e.MA_TT
    },
    diachiKHChanged() {
      // console.log(this.diachiKH.DIACHI);
      // console.log(this.diachiTT.DIACHI);
    },
    HienThiDS_HDTT_CBO(hdkh_id) {
      API.get_lay_ds_ma_thanhtoan(this.axios, { params: { hdkhId: hdkh_id } }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.thanhtoancbo.list = response.data.data

          if (this.listbox.thanhtoancbo.list && this.listbox.thanhtoancbo.list.length > 0 && (!this.listbox.thanhtoancbo.value || this.listbox.thanhtoancbo.value <= 0))
            if (this.hdtt_id && this.hdtt_id > 0) this.listbox.thanhtoancbo.value = this.hdtt_id
            else this.listbox.thanhtoancbo.value = this.listbox.thanhtoancbo.list[0]['ID']
        }
      })
    },
    LoadTTKhuyenMai(khoanmuctt_id, loaikmid, itrangbi_id, itocdo_id, loaikm) {
      let pdata = {
        vapld_id: this.diachiLD.AP_ID ? this.diachiLD.AP_ID : 0,
        vdoituong_id: this.listbox.doituong.value,
        vhdtb_id: this.hdtb_id,
        vkhoanmuctt_id: khoanmuctt_id ? khoanmuctt_id : 0,
        vkhuld_id: this.diachiLD.KHU_ID ? this.diachiLD.KHU_ID : 0,
        vkieuld_id: this.listbox.kieu_ld.value,
        vloaikm: loaikmid ? loaikmid : 0,
        vloaitb_id: this.listbox.loaihinh_tb.value,
        vmuccuoc_id: this.listbox.muccuoc.value && this.listbox.muccuoc.value > 0 ? this.listbox.muccuoc.value : 0,
        vphold_id: this.diachiLD.PHO_ID ? this.diachiLD.PHO_ID : 0,
        vphuongld_id: this.diachiLD.PHUONG_ID ? this.diachiLD.PHUONG_ID : 0,
        vtocdo_id: itocdo_id ? itocdo_id : 0,
        vtrangbi_id: itrangbi_id ? itrangbi_id : 0, //TODO xac dinh loai trang bi cua CD hay khac?
        vloainha_id: this.diachiLD.LOAINHA_ID,
      }
      let api = cache.getters.getFromCache('post_lay_khuyenmai_hdtb' + (loaikmid ? loaikmid : 0), pdata)
      if (!api) api = API.post_lay_khuyenmai_hdtb(this.axios, pdata)
      else
        api = new Promise((resolve, reject) => {
          resolve(api)
        })
      // API.post_lay_khuyenmai_hdtb(this.axios, pdata).then(
      api.then((response) => {
        cache.dispatch('addToCache', { key: 'post_lay_khuyenmai_hdtb' + (loaikmid ? loaikmid : 0), subkey: pdata, data: response })
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.filterbox[loaikm ? loaikm : 'khuyenmai'].list = response.data.data
        } else {
          this.filterbox[loaikm ? loaikm : 'khuyenmai'].list = [];
          this.filterbox[loaikm ? loaikm : 'khuyenmai'].value = 0;
          this.filterbox[loaikm ? loaikm : 'khuyenmai'].ischecked = false;
        }

        if (this.filterbox[loaikm ? loaikm : 'khuyenmai'].list && this.filterbox[loaikm ? loaikm : 'khuyenmai'].list.length > 0) {
          if (!this.filterbox[loaikm ? loaikm : 'khuyenmai'].value || this.filterbox[loaikm ? loaikm : 'khuyenmai'].value <= 0 || !this.filterbox[loaikm ? loaikm : 'khuyenmai'].list.find((x) => x.khuyenmai_id == this.filterbox[loaikm ? loaikm : 'khuyenmai'].value))
            this.filterbox[loaikm ? loaikm : 'khuyenmai'].value = this.filterbox[loaikm ? loaikm : 'khuyenmai'].list[0].khuyenmai_id //else this.filterbox.tratruoc.value=0;
        } else this.filterbox[loaikm ? loaikm : 'khuyenmai'].ischecked = false
      })
    },
    async MaGDChanged(e) {
      if (e) this.khachhang.magd = e.target.value
      if (this.khachhang.magd) {
        this.loading(true)
        this.watcherActive = false
        let pdata = {
          in_donvi_dl_id: 0,//this.$root.token.getProperty('donvi_dl_id'),
          in_donvi_id: this.$root.token.getDonViID(),
          in_loaihd_id: LoaiHopDong.DAT_MOI, // Test data 1, default code 0
          in_ma_gd: this.khachhang.magd,
          in_nhanvien_id: this.$root.token.getNhanVienID(),
          in_tthd_id: TrangThaiHD.MOI
        }
        if (this.iKieu != 0) {
          if (!this.$root.token.getProperty('donvi_dl_id') || this.$root.token.getProperty('donvi_dl_id') == 0) pdata.in_donvi_id = 0
          pdata.in_tthd_id = 0
          pdata.in_nhanvien_id = 0
        }
        try {
          await API.post_lay_ds_hopdong_theo_ma_gd(this.axios, pdata).then(async (response) => {
            this.loading(false)
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              await this.HienThiTTHopDongKH(response.data.data)
              if (this.lvwThueBao.length > 0) await this.lvwThueBaoChanged(1, this.lvwThueBao[0])
            } else {
              this.$toast.error('Mã giao dịch này không tồn tại hoặc không còn là giao dịch lắp mới!')
            }
          })
        } catch (ex) {
        } finally {
          await delay(1000);
          this.loading(false)
          this.watcherActive = true
        }
      }
    },
    async MaKHChanged(e) {
      if (e) this.khachhang.makh = e.target.value
      if (!this.khachhang.makh) return
      try {
        this.loading(true)
        this.isLoadKH = true;
        this.watcherActive = false
        this.listbox.danhba.list = []
        await API.post_lay_db_theo_matb(this.axios, { ma_tb: this.khachhang.makh, donvi_dl_id: 0, dichvuvt_id: 0 }).then((response) => {

          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {

            this.listbox.danhba.list = response.data.data
            // this.listbox.thanhtoan.list = this.listbox.danhba.list
          }
        })
        if (this.listbox.danhba.list.length > 0) {
          if (this.listbox.danhba.list[0]['ky_hd'] != 1) {
            this.$toast.error('Khách hàng có mã ' + this.khachhang.makh + ' chưa ký hợp đồng gốc. Đề nghị bạn ký hợp đồng gốc trước khi lập phụ lục.')
          } else {
            await this.HienThiTT_DanhBa(this.listbox.danhba.list)
          }
          this.isTruocBH = false
          await API.post_lay_tt_khuvuc_theo_thuebao_id(this.axios, { id: this.listbox.danhba.list[0]['thuebao_id'] }).then((response) => {
            if (response && response.data && response.data.data && response.data.data.length > 0 && response.data.error_code && response.data.error_code === 'BSS-00000000') {

              this.thuebao.khuvuc = response.data.data[0]['TEN_KV']
              this.thuebao.khuvuc_id = response.data.data[0]['KHUVUC_ID']
              this.dsHDTB_KV = []
              let dr = {}
              dr.HDTB_ID = 0
              dr.KHUVUC_ID = this.thuebao.khuvuc_id
              dr.LOAIKV_ID = LOAI_KV.KHUVUC_DIABAN
              dr.NGUOI_CN = this.$root.token.getUserName()
              dr.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
              dr.MAY_CN = null
              dr.IP_CN = null
              dr.KIEUKV_ID = 2
              this.dsHDTB_KV.push(dr)
            }
          })
        } else {
          //TODO lay ds hop dong chua hoan thanh line 12193
          let pdata = {
            in_donvi_dl_id: 0,
            in_donvi_id: this.$root.token.getDonViID(),
            in_loaihd_id: 0, // Test data 1, default code 0
            in_ma_gd: this.khachhang.makh, //BUG "HPG-LD/00744631", ma nay la ma giao dich, tai sao truyen makh o day?????
            in_nhanvien_id: this.$root.token.getNhanVienID(),
            in_tthd_id: 0
            //"vphanvung_id": this.$root.token.getPhanVungID()
          }
          //BUG xem lai cho nay, goi theo UR2.1.004_296
          await API.post_lay_ds_hopdong_theo_ma_gd(this.axios, pdata).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              this.hdtb_id = response.data.data[0].hdtb_id
              this.listbox.dshopdong_chuaht.list = response.data.data.filter((x) => x.tthd_id != 6 && x.tthd_id != 7)
              this.HienThiTT_HopDong_ChuaHT(this.listbox.dshopdong_chuaht.list)
            } else this.listbox.dshopdong_chuaht.list = []
          })
          let hdkh_id = 0
          if (this.listbox.dshopdong_chuaht.list.length > 0) {
            hdkh_id = this.listbox.dshopdong_chuaht.list[0]['hdkh_id']
          } else if (this.listbox.danhba.list && this.listbox.danhba.list.length > 0) {
            hdkh_id = this.listbox.danhba.list[0]['khachhang_id']
          }
          this.khachhang.hdkh_id = hdkh_id
          //TODO load thong tin len form line 16729

          // Hien thi danh sach hd thanh toan line 16994
          this.listbox.thanhtoan.list = []
          await API.post_fn_ht_tt_hd_khachhang(this.axios, { ds_para: '{"HDKH_ID":' + hdkh_id + '}' }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              let apidata = JSON.parse(response.data.data)
              if (apidata['RESULT']) apidata = apidata['RESULT']
              if (apidata['DS_HD_TT']) this.listbox.thanhtoan.list = this.LowerCasePropertyList(apidata['DS_HD_TT'])
            }
          })

          if (this.listbox.danhba.list.length <= 0 && this.listbox.thanhtoan.list.length <= 0) this.$toast.error('Thuê bao chưa có khu vực quản lý, liên hệ với admin để xử lý!!!')
        }
      } catch (ex) {
        throw ex
      } finally {
        await delay(1000);
        this.loading(false)
        this.watcherActive = true
      }
    },
    onAcceptDVKhac(value) {
      this.dsDvKhacChose = []
      this.dsDvMaster.forEach((el) => {
        const isDk = document.getElementById(`DK_${el.DVKHAC_ID}`).checked
        const ishuy = document.getElementById(`H_${el.DVKHAC_ID}`).checked
        let tenDVK = el.TEN_DVKHAC
        if (isDk) tenDVK += '(DK)'
        if (ishuy) tenDVK += '(Hủy)'
        if (isDk || ishuy) {
          this.dsDvKhacChose.push({
            DVKHAC_ID: el.DVKHAC_ID,
            TEN_DVKHAC: tenDVK,
            kieu_yc: isDk ? 1 : 0
          })
        }
      })
      this.$bvModal.hide('modal-dvkhac')
      this.dsDvKhacChose.forEach((item) => {
        this.dsDichVuKhac.push({
          DVKHAC_ID: item.DVKHAC_ID,
          TEN_DVKHAC: item.TEN_DVKHAC,
          kieu_yc: item.kieu_yc
        })
      })
    },
    getDsDVKhac: async function() {
      try {
        // let rs = await this.$root.context.get(
        //   "/web-thuno/api/thu-no/thong-tin-khach-hang/lay-danh-sach-dich-vu-khac-dbid",
        //   {
        //     pDBId: this.thanhToanId || 0,//1453312,
        //     pLoaiId: 2,//1,
        //     pLoaiTBId: 0,//58,
        //     pKieuLDId: 0//39,
        //   }
        // ); //1 theo ma thue bao, 2 theo ma thanh toan
        const dsDvKhacChoseId = this.dsDvKhacChose.map((item) => item.DVKHAC_ID)
        const dvUsing = this.dsDichVuKhac.map((item) => item.DVKHAC_ID)
        this.dsDvMaster = this.dsDK_DVK_TT // Dong bo giua code form nay va form popup
        this.dsDvMaster = this.dsDK_DVK_TT.map((item) => {
          let htmlDangKy = `<div class="check-action">
            <input type="checkbox" id="DK_${item.DVKHAC_ID}" class="check"`
          if (item.DANGKY != 0) htmlDangKy += disabled
          if (dsDvKhacChoseId.includes(item.DVKHAC_ID)) htmlDangKy += checked
          htmlDangKy += `><span class="name"></span></div>`
          return {
            ...item,
            TRANGTHAI: dvUsing.includes(item.DVKHAC_ID) ? 'Su dung' : '',
            HTML_DANGKY: htmlDangKy,
            HTML_HUY: item.DANGKY == 0 ? '<div class="check-action"><input disabled type="checkbox" id="H_${item.DVKHAC_ID}" class="check"><span class="name"></span></div>' : '<div class="check-action"><input type="checkbox" id="H_${item.DVKHAC_ID}" class="check"><span class="name"></span></div> '
          }
        })
        // this.dsDvMaster = rs.data.map(item => {
        //   let htmlDangKy =  `<div class="check-action">
        //     <input type="checkbox" id="DK_${item.DVKHAC_ID}" class="check"`
        //   if(item.DANGKY != 0) htmlDangKy+= disabled;
        //   if(dsDvKhacChoseId.includes(item.DVKHAC_ID)) htmlDangKy+= checked;
        //   htmlDangKy+=`><span class="name"></span></div>`;
        //   return {
        //   ...item,
        //   TRANGTHAI: dvUsing.includes(item.DVKHAC_ID) ? 'Su dung': '',
        //   HTML_DANGKY: htmlDangKy,
        //   HTML_HUY: item.DANGKY == 0 ? '<div class="check-action"><input disabled type="checkbox" id="H_${item.DVKHAC_ID}" class="check"><span class="name"></span></div>' : '<div class="check-action"><input type="checkbox" id="H_${item.DVKHAC_ID}" class="check"><span class="name"></span></div> '
        //   }});
      } catch (error) {
        throw error
      }
    },
    async ValidateMaGDStatus() {
      if (this.khachhang.magd) {
        let pdata = {
          in_donvi_dl_id: 0,
          in_donvi_id: this.$root.token.getDonViID(),
          in_loaihd_id: LoaiHopDong.DAT_MOI, // Test data 1, default code 0
          in_ma_gd: this.khachhang.magd,
          in_nhanvien_id: this.$root.token.getNhanVienID(),
          in_tthd_id: TrangThaiHD.MOI
        }
        if (this.iKieu != 0) {
          if (!this.$root.token.getProperty('donvi_dl_id') || this.$root.token.getProperty('donvi_dl_id') == 0) pdata.in_donvi_id = 0
          pdata.in_tthd_id = 0
          pdata.in_nhanvien_id = 0
        }
        // if (this.iKieu != 0)
        // {
        //   if(!this.$root.token.getDonViID())
        //     pdata.in_donvi_id = 0;
        //   pdata.in_tthd_id = 0;
        //   pdata.in_nhanvien_id = 0;
        // }
        try {
          return await API.post_lay_ds_hopdong_theo_ma_gd(this.axios, pdata)
            .then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                if (response.data.data.length > 0) return true
              }
              this.$toast.error('Mã giao dịch này không tồn tại hoặc không còn là giao dịch lắp mới!')
              return false
            })
            .catch(() => {
              this.$toast.error('Có lỗi khi kiểm tra mã giao dịch, vui lòng thử lại!')
              return false
            })
        } catch (ex) {
          this.$toast.error('Có lỗi khi kiểm tra mã giao dịch, vui lòng thử lại!')
          return false
        }
        return true
      }
      return true
    },
    async SaveClicked() {
      this.loading(true)
      // var tab = this.currentTab+'';
      // this.currentTab='all';
      try {
        if (this.buttonSet != 1) if (!(await this.ValidateMaGDStatus())) return //if(!(await this.ValidateMaGDStatus())) return; // tam comment lai de test, ok thi mo!
        if (this.DT_CONTROLS.list && this.DT_CONTROLS.list.length > 0)
          for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
            if (!this.DT_CONTROLS.value[i] || this.DT_CONTROLS.value[i] <= 0) throw `Chưa chọn thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}`
          }
        if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) {
          //TODO line 17410
          //17406 chọn vị trí trên bản đồ???
        }
        //TODO validate khac line 17432 - 17499
        await this.CapNhat()
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      } finally {
        this.loading(false) //this.currentTab = tab;
      }
    },
    async CapNhat() {
      let async_status = false
      this.thuebao.statusVdc = false
      let tocdotn_id = 0
      this.muccuoctn_id = 0
      let KT_KVNLML = 1
      let KIEMTRA_DK_APDUNG = 'nok'

      if(this.thanhtoan.thanhtoan_id && this.thanhtoan.thanhtoan_id>0) {
        var rpno = await API.get_tracuu_no_thanhtoan(this.axios, { params: { thanhToanId: this.thanhtoan.thanhtoan_id } }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000')
            return response.data.data;
          else return 0;
        }).catch(()=> { return 0; } );
        if(rpno && rpno>0) {
          let cfr = await this.$bvModal
            .msgBoxConfirm(`Mã thanh toán ${this.thanhtoan.matt?this.thanhtoan.matt:this.thanhtoan.thanhtoan_id} còn nợ ${Intl.NumberFormat("vi-VN", {
                style: "currency",
                currency: "VND"
            }).format(rpno)}\r\nBạn có muốn tiếp tục?`, {
              title: 'Thông báo',
              size: 'sm',
              okTitle: 'Đồng ý',
              cancelTitle: 'Hủy'
            })
            .then((v) => {
              return v
            })
          if (!cfr) {
            throw "Dừng xử lý thêm mới để kiểm tra thông tin nợ!"
          }
        }
      }

      if ([DichVuVienThong.ADSL, DichVuVienThong.MEGA_EYES, DichVuVienThong.BRCD_DOITAC, DichVuVienThong.ANTOAN_BAOMAT_TT, DichVuVienThong.TRUNGTAM_DULIEU, DichVuVienThong.DICHVU_CNTT, DichVuVienThong.HOINGHI_TRUYENHINH].indexOf(this.listbox.dichvu_vt.value * 1) >= 0) {
        tocdotn_id = this.listbox.cboGoiCuocAdsl.value
        if (
          this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_MYTV &&
          this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_MYTV_B2B &&
          this.listbox.dichvu_vt.value != DichVuVienThong.HOINGHI_TRUYENHINH &&
          this.listbox.dichvu_vt.value != DichVuVienThong.ANTOAN_BAOMAT_TT &&
          this.listbox.dichvu_vt.value != DichVuVienThong.TRUNGTAM_DULIEU &&
          this.listbox.dichvu_vt.value != DichVuVienThong.DICHVU_CNTT &&
          this.listbox.dichvu_vt.value != DichVuVienThong.BRCD_DOITAC &&
          this.listbox.dichvu_vt.value != DichVuVienThong.MEGA_EYES &&
          this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_SGTV &&
          this.listbox.loaihinh_tb.value != LoaiHinhTB.HTVC_FIBERVNN_ANALOG &&
          this.listbox.loaihinh_tb.value != LoaiHinhTB.HTVC_FIBERVNN_DIGITAL
        ) {
          this.muccuoctn_id = this.listbox.muccuoc.value
        }
      } else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) {
        tocdotn_id = this.listbox.cboGoiCuocAdsl.value
      } else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
        tocdotn_id = this.listbox.tocdokenh.valuetsl //Convert.ToInt32(cboTocDoKenhTSL.EditValue);
      } else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
        tocdotn_id = this.listbox.tocdokenh.valuecir //Convert.ToInt32(cboTocDo.EditValue);
      }

      // TODO validate du lieu line 7625 - 7627
      if (!this.ngaySinhChanged()) return
      if (!(await this.KiemTraDL_KhachHang())) return
      if (!(await this.KiemTraDL_ThanhToan())) return

      //BUG mot so tham so chua co thong tin
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.dichvu_vt.value == DichVuVienThong.HATANG_VIENTHONG) {
        if (this.buttonSet == 1) await this.SinhMaDVVT(true)


        if (this.thamsomacdinh['FIBER_HOA'] == 1) this.thuebao.adsl.txtAccountADSL = this.thuebao.adsl.txtAccountADSL.toUpperCase()
      }


      if (
          (this.thuebao.adsl.txtAccountADSL+'').trim().length == 0 &&
          (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B || this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_ANALOG || this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL || this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_MESH || this.listbox.loaihinh_tb.value == LoaiHinhTB.INDOOR_CAM || this.listbox.loaihinh_tb.value == LoaiHinhTB.OUTDOOR_CAM)
        ) {
          await this.SinhMaDVVT(true)
          if (this.thamsomacdinh['FIBER_HOA'] == 1) this.thuebao.adsl.txtAccountADSL = (this.thuebao.adsl.txtAccountADSL+'').toUpperCase()
        }

      await this.LayMaTB(this.buttonSet == 1) //line 7642
      // if (!KIEMTRA_DL_HRM(1)) return;
      if (!(await this.KiemTraDL_ThueBao(this.buttonSet == 1))) return
      //Hiếu kiểm tra xem, nếu chọn khuyến mại thì dskm_hdtb pải >0 - 23.09.2010
      // if (!KiemTraDL_KhuyenMai()) return;
      await this.CheckGhiLaiDichVubaoHieuQuocTe();

      // #region "KiemTra + LayDL"
      if ((this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B) && this.thamsomacdinh['MYTV_HOA'] == 1) this.thuebao.adsl.txtAccountADSL = this.thuebao.adsl.txtAccountADSL.toUpperCase()
      if ((this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B) && this.thuebao.adsl.txtAccountADSL.length > 18) {
        this.$toast.error('Mã thuê bao MyTV không được vượt quá 18 ký tự')
        return
      }

      var j_loaikenh_id = 0
      if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) j_loaikenh_id = this.listbox.loaikenh.value
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) j_loaikenh_id = this.listbox.loaikenh.valuetsl
      else j_loaikenh_id = 0
      //BATBUOC_GHEP_MATT dong 7956
      let pdata = {
        KHACHHANG_ID: this.khachhang.khachhang_id,
        DOITUONG_ID: this.listbox.doituong.value,
        LOAIKH_ID: this.listbox.loai_kh.value,
        LOAITB_ID: this.listbox.loaihinh_tb.value,
        HDKH_ID: this.khachhang.hdkh_id,
        JS_TRATRUOC: [],
        JS_LIST: [],
        JS_MUA_TBI: [],
        THEMMOI: this.buttonSet == 1,
        KIEULD_ID: this.listbox.kieu_ld.value,
        SOMAY_CD: this.thuebao.codinh.somay,
        DICHVUVT_ID: this.listbox.dichvu_vt.value,
        TINHKHAC: this.thuebao.tinhkhac,
        MA_TB_HT: this.ma_tb_ht, //this.thuebao.codinh.somay, //FIXME khong phai codinh thi xu ly the nao???
        TTND_DVI: 1,
        TUDONG_SINH_SOAO: this.TUDONG_SINH_SOAO ? 1 : 0,
        MA_TB_AO_HT: this.ma_tb_ao_ht,
        MA_TB_AO_HT_CUOI: this.ma_tb_ao_ht_cuoi,
        SOAO_ADSL: this.thuebao.adsl.txtSoAoAdsl, //this.ma_tb_ao
        SOAO_TSL_DAU: this.thuebao.tsl.txtSoAoTSL_Dau,
        SOAO_TSL_CUOI: this.thuebao.tsl.txtSoAoTSL_Cuoi,
        SOAO_WAN: '',
        OPEN_SYNC_VINA_TRASAU: TRANGTHAI_DONGBO.OPEN_SYNC_VINA_TRASAU ? 1 : 0,
        MA_TT: this.thanhtoan.matt ? this.thanhtoan.matt : null,
        BATBUOC_GHEP_MATT: this.thamsomacdinh['BATBUOC_GHEP_MATT'] == 1,
        KIEMTRA_GHEP_MATT_CNTT: this.thamsomacdinh['KIEMTRA_GHEP_MATT_CNTT'] == 1,
        TOCDOTN_ID: tocdotn_id,
        MUCCUOCTN_ID: this.muccuoctn_id,
        HDKH_CHA_ID: this.hdkh_cha_id,
        HDTB_ID: this.hdtb_id,
        TRANGBI_ID: this.listbox.trangbi.valuecd, // FIXME neu khong phai CO_DINH thi cho nay xu ly the nao????
        KETCUOI_ID: this.KetCuoi_ID,
        GOICUOCADSL: this.listbox.cboGoiCuocAdsl.value,
        OPEN_SYNC_VINA: TRANGTHAI_DONGBO.OPEN_SYNC_VINA ? 1 : 0,
        GOICUOCDD_ID: 0, //TODO 2 dong nay chua lam vi chua lam phan di dong
        LOAI_TB_DD: this.thuebao.didong.LOAI_TB_DD,
        QUANLD_ID: this.diachiLD.QUAN_ID ? this.diachiLD.QUAN_ID : 0,
        PHUONGLD_ID: this.diachiLD.PHUONG_ID ? this.diachiLD.PHUONG_ID : 0,
        PHOLD_ID: this.diachiLD.PHO_ID ? this.diachiLD.PHO_ID : 0,
        APLD_ID: this.diachiLD.AP_ID ? this.diachiLD.AP_ID : 0,
        KHULD_ID: this.diachiLD.KHU_ID ? this.diachiLD.KHU_ID : 0,
        DACDIEMLD_ID: this.diachiLD.DACDIEM_ID ? this.diachiLD.DACDIEM_ID : 0,
        LAT_LD: this.diachiLD.Lat ? this.diachiLD.Lat : null, //0 se hien thong bao loi, null de bo qua
        LNG_LD: this.diachiLD.Lng ? this.diachiLD.Lng : null, //0 se hien thong bao loi, null de bo qua
        DONVI_QL_ID: this.listbox.donvi_ql.value ? this.listbox.donvi_ql.value : 0,
        NGAY_YC: this.NgayYeuCau,
        MA_GD: this.khachhang.magd,
        MA_TB: this.ma_tb ? this.ma_tb : this.khachhang.makh, //this.ma_tb?this.ma_tb:this.thuebao.codinh.somay, phia duoi dang gan this.khachhang.makh chay OK nen de o day. Code dung kha nang la phai nhu phan comment nay!
        FIBER_BS: 0,
        CONGNGHE_ID: this.listbox.congnghe.value == 0 ? null : this.listbox.congnghe.value,
        MATB_TN: this.thuebaocd.matn ? this.thuebaocd.matn.trim() : null,
        CBO_TT: this.listbox.thanhtoancbo.value,
        SL_TT: this.lvwThueBao.filter((x) => x.ten_dvvt == DichVuVienThong.DI_DONG).length,
        LOAIKENH_ID: j_loaikenh_id
      }
      let checkloi = false
      let KQ_DB_DL = null
      let dulieuapi = {}
      await API.post_fn_kt_laytt_capnhat_datmoi(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          dulieuapi = JSON.parse(response.data.data)
          if (dulieuapi['ERROR_CODE'] == 0) {
            this.$toast.error(dulieuapi['MESSAGE'])
            checkloi = true
            return
          }
          if (dulieuapi['RESULT']) dulieuapi = dulieuapi['RESULT']
          if (dulieuapi['KT_KV_NLML']) KT_KVNLML = dulieuapi['KT_KV_NLML']
          if (KT_KVNLML && KT_KVNLML != 'ok' && KT_KVNLML != 1) {
            let cfr = await this.$bvModal
              .msgBoxConfirm(`${KT_KVNLML + ''} "\r\nBạn có muốn thay đổi địa chỉ để tiếp tục?`, {
                title: 'Thông báo',
                size: 'sm',
                okTitle: 'Đồng ý',
                cancelTitle: 'Hủy'
              })
              .then((v) => {
                return v
              })
            if (cfr) {
              if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
                // VDCService vdc = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
                // vdc.HuyDatChoMegaVNN(txtAccountADSL.Text);
                await vdc.HuyDatChoMegaVNN(this.thuebao.adsl.txtAccountADSL)
              }

              // this.buttonSet = 0

              // this.$toast.success('Hợp đồng đã được thoái trả. Khách hàng sẽ được đưa vào danh sách Khách hàng tiềm năng!')
              checkloi = true
              return 'err'
            } else KT_KVNLML = 0
          } else KT_KVNLML = 1
          if (dulieuapi['KIEMTRA_DK_APDUNG']) KIEMTRA_DK_APDUNG = dulieuapi['KIEMTRA_DK_APDUNG']
          if (dulieuapi['KQ_DB_DL'] || dulieuapi['KQ_DB_DL']==0) KQ_DB_DL = dulieuapi['KQ_DB_DL']
        }
      })
      if (checkloi) return //FIXME tam dong de test

      //FIXME Move trong IF ra day vi dung chung cho ca case update & insert
      if (dulieuapi['DS_HUONGGIAO_TN'] && dulieuapi['DS_HUONGGIAO_TN'].length > 0 && dulieuapi['DS_HUONGGIAO_TN'][0].QUYTRINH_ID) {
        // Them 16/9, khong hieu sao lai tra ve tu phía trên mà không cần gọi phần bên dưới????
        if (dulieuapi['DS_HUONGGIAO_TN'][0].QUYTRINH_ID) this.quytrinh_tn = dulieuapi['DS_HUONGGIAO_TN'][0].QUYTRINH_ID
        if (dulieuapi['DS_HUONGGIAO_TN'][0].LUONG_ID) this.luong_id = dulieuapi['DS_HUONGGIAO_TN'][0].LUONG_ID
        if (dulieuapi['DS_HUONGGIAO_TN'][0].HUONGGIAO_ID) this.huonggiao_tn = dulieuapi['DS_HUONGGIAO_TN'][0].HUONGGIAO_ID
      } else {
        let pdata = {
          kieuLdId: this.listbox.kieu_ld.value,
          loaiHdId: this.buttonSet == 1 ? LoaiHopDong.DAT_MOI : '1',
          loaiTbId: this.listbox.loaihinh_tb.value,
          mucCuocId: this.muccuoctn_id, //(this.listbox.muccuoc.value && this.listbox.muccuoc.value>0)?this.listbox.muccuoc.value:-1,
          tocDoId: tocdotn_id //0 //this.tocdo_id?this.tocdo_id:-1
        }
        this.huonggiao_tn = 0
        this.quytrinh_tn = 0
        this.luong_id = 0
        await API.post_lay_huonggiao_tiepnhan(this.axios, pdata).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let dlapi = response.data.data
            if (dlapi['huonggiao_id']) this.huonggiao_tn = dlapi['huonggiao_id']
            if (dlapi['quytrinh_id']) this.quytrinh_tn = dlapi['quytrinh_id']
            if (dlapi['luong_id']) this.luong_id = dlapi['luong_id']
          }
        })
      }
      // console.info(dulieuapi['DS_HUONGGIAO_TN'],dulieuapi['DS_HUONGGIAO_TN'].length,dulieuapi['DS_HUONGGIAO_TN'][0].QUYTRINH_ID,this.quytrinh_tn,this.luong_id,this.huonggiao_tn);

      // trien khai luon phan LayMaTB:
      // this.ma_tb_ht = this.thuebao.codinh.somay;
      // switch(this.listbox.dichvu_vt.value) {
      //   case DichVuVienThong.CO_DINH:
      //     this.ma_tb_ht = this.thuebao.codinh.somay;
      //     break;
      // }
      // TODO validate du lieu line 7650 - 7687
      if (DUNG_THU.DOITUONG_TB == this.listbox.doituong.value) {
        var ktraDungThu = await API.kiemtra_tao_hopdong_dungthu_v2(this.axios, {
            vloaitb_id: this.listbox.loaihinh_tb.value,
            vloaikh_id: this.listbox.loai_kh.value,
            vkhachhang_id: this.khachhang.khachhang_id
          }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data
              }
              else return response.data.message + ": "+response.data.message_detail;
            }).catch(()=>{ return "ok"}); //thanhtoan.Kiemtra_tao_hopdong_dungthu_v2(Convert.ToInt32(cboLoaiKH.EditValue), Convert.ToInt32(cboLoaihinhTB.SelectedValue), khachhang_id);
          if (ktraDungThu != 'ok') {
            this.$toast.error(ktraDungThu)
            return
          }
          var thamso_doituong_ct = this.thamsomacdinh['CHON_DOITUONG_CHINHTHUC']
          if (thamso_doituong_ct && thamso_doituong_ct == 1) {
            var dulieu = {}
            dulieu.ds = {}
            dulieu.ds.list = await API.post_sp_lay_doituong_tb(this.axios, { nguoidung_id: this.$root.token.getNhanVienID() }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data
              }
              else return [];
            }).catch(()=>{ return []});
            dulieu.ds.value = this.thuebao.doituong_ct_id
            dulieu.ds.textcol = 'ten_dt'
            dulieu.ds.valuecol = 'doituong_id'
            dulieu.tieudebang = 'Thông tin thuê bao'
            dulieu.tieude = 'CHỌN ĐỐI TƯỢNG CHÍNH THỨC'
            dulieu.allowExit = true
            this.popupComponent = () => import('./Popups/popupChonComboBox')
            this.popupComponentName = 'frmChonDoiTuong_CT'
            this.popupComponentData = dulieu
            this.Popup('popupComponents')
            this.popupRetVal = null
            while(true) {
              await waitUntil(()=>this.popupRetVal!=null)
              if (this.popupRetVal == 0) {
                this.popupRetVal = null
                this.$toast.error('Hãy chọn đối tượng thuê bao sau dùng thử!')
                dulieu.ds.value = this.thuebao.doituong_ct_id
                this.popupComponent = () => import('./Popups/popupChonComboBox')
                this.popupComponentName = 'frmChonDoiTuong_CT'
                this.popupComponentData = dulieu
                this.Popup('popupComponents')
                continue
              }
              if (this.popupRetVal == DUNG_THU.DOITUONG_TB) {
                this.popupRetVal = null
                this.$toast.error('Hãy chọn đối tượng thuê bao khác "Thuê bao dùng thử"')
                dulieu.ds.value = DUNG_THU.DOITUONG_TB
                this.popupComponent = () => import('./Popups/popupChonComboBox')
                this.popupComponentName = 'frmChonDoiTuong_CT'
                this.popupComponentData = dulieu
                this.Popup('popupComponents')
                continue
              }
              if (this.popupRetVal == -1) break
              if (typeof this.popupRetVal == 'object' && Object.keys(this.popupRetVal) && Object.keys(this.popupRetVal).length == 0) break
              this.thuebao.doituong_ct_id = this.popupRetVal
              break
            }
          }
      }

      try {
        await this.TaoDuLieu(this.buttonSet == 1) // move trong if ra day, true neu la insert, false neu la update -> dung buttonSet de phan biet
      } catch (ex) {
        this.$toast.error('Có lỗi trong quá trình khởi tạo dữ liệu thuê bao: ' + ex)
        return
      }
      var isvalid = true
      var ctab = this.currentTab + ''
      // this.currentTab='all';
      this.currentTab = 'tab1'
      document.querySelectorAll('.main-wrapper .page-content #tab1 input').forEach((item) => {
        if (isvalid && !item.validity.valid) {
          isvalid = false
          this.$refs['tab1'].click()
          var thongbaostr = item.getAttribute('title')
          if (!thongbaostr) thongbaostr = 'Lỗi dữ liệu, vui lòng kiểm tra lại!'
          this.$toast.error(thongbaostr)
          if (this.debug) console.error(thongbaostr, item)
          item.focus()
        }
      })
      // this.currentTab = tab;
      if (!isvalid) return
      this.currentTab = 'tab2'
      document.querySelectorAll('.main-wrapper .page-content #tab2 input').forEach((item) => {
        if (isvalid && !item.validity.valid) {
          isvalid = false
          this.$refs['tab2'].click()
          var thongbaostr = item.getAttribute('title')
          if (!thongbaostr) thongbaostr = 'Lỗi dữ liệu, vui lòng kiểm tra lại!'
          this.$toast.error(thongbaostr)
          if (this.debug) console.error(thongbaostr, item)
          item.focus()
        }
      })
      // this.currentTab = tab;
      if (!isvalid) return
      this.$refs[ctab == 'all' ? 'tab2' : ctab].click()

      // THANGDM1 20221124 hot fix, cho nay chua dung vi truong hop sua thong tin thue bao se loi
      if (this.buttonSet == 1 && (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES)) {
        // await this.btnKiemTraAccount_Click(); // Bỏ bớt thông báo ngày 2023-04-11
        this.thuebao.adsl.validadslacc = true
        if (!this.thuebao.adsl.validadslacc) return
        //Bo qua doan Line 8044 - 8072, chac da gop o phan check???
      }

      if ((this.listbox.loaihinh_tb.value == LoaiHinhTB.CA || this.listbox.loaihinh_tb.value == LoaiHinhTB.SMART_CA) && (!this.dsHDTB_SUB || this.dsHDTB_SUB.length <= 0) && this.buttonSet == 1) {
        let c = null
        if (this.hdtb_id)
          c = await API.lay_tt_thuebao_bosung_ca(this.axios, { vhdtb_id: this.hdtb_id })
            .then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data
              }
            })
            .catch(() => {
              return null
            })
        if (!c || c.length <= 0) {
          this.$toast.error('Cần nhập thông tin TB với loại hình thuê bao CA / SMART CA')
          return
        } else this.dsHDTB_SUB = this.UpperCasePropertyList(c);
        for(var item of this.dsHDTB_SUB)
              if(item['NGAYHETHAN_GT']) item['NGAYHETHAN_GT'] = moment(item['NGAYHETHAN_GT']).format('DD/MM/YYYY')
      }
      if (this.buttonSet == 1) {
        // THemmoi
        // Dat cho tren VISA
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL) {
          let loaihinh_tb = this.listbox.loaihinh_tb.value
          if (loaihinh_tb == LoaiHinhTB.INTERNET_1260 || loaihinh_tb == LoaiHinhTB.INTERNET_ADSL || loaihinh_tb == LoaiHinhTB.INTERNET_FTTH || loaihinh_tb == LoaiHinhTB.WIFI_FIBER || loaihinh_tb == LoaiHinhTB.MEGA_IOT) {
            if (this.DONGBO_TEST.TEST == false) {
              // VDCService vdcService = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
              let account = this.dsHDTB[0]['MA_TB']
              let contex = this.ma_lhtb_vdc //objCheckData.MAP_ID("ma_lhtb_vdc", DatabaseConstants.DB2 + ".loaihinh_tb", "where loaitb_id =" + cboLoaihinhTB.SelectedValue.ToString());
              let pdata = {
                accountModel: { accountName: account }
                //"reservemodel": { "context":contex, "reservedTime": "2022-01-11" } //Bỏ do VISA default vào FTTH rồi
              }
              await API.post_reserveRASAccount(this.axios, pdata).then((response) => {
                if (response && response.data && response.data.data && response.data.errorCode != 1) this.thuebao.statusVdc = response.data.data == 'ok'
                else {
                  this.$toast.error(response.data.faultString)
                  this.thuebao.statusVdc = false
                }
              })
              if (!this.thuebao.statusVdc) {
                // Bỏ bớt thông báo ngày 2023-04-11
                // this.$toast.error("Có lỗi xảy ra trong quá trình đặt chỗ Account " + account + " lên Visa.Bạn hãy vui lòng thực hiện lại chức năng này!");
                this.thuebao.check_tb_adsl = false
                return
              }
              this.thuebao.check_tb_adsl = true //Hiếu thêm biến kiểm tra thuê bao ADSL đã được đặt chỗ hay chưa. 5.10.2010
            } else {
              this.thuebao.statusVdc = true
              this.thuebao.check_tb_adsl = true
            }
            if (!this.thuebao.statusVdc || !this.thuebao.check_tb_adsl) return
          }
        }
        // Kich hoat dang ky len he thong Camera
        if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) {
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGACAMERA) {
            if (!this.DONGBO_TEST.TEST) {
              this.$toast.error('Dịch vụ này tạm dừng cung cấp! Vui lòng liên hệ admin.')
              return
              let matinh = this.$root.token.getMaTinh()
              // CameraService camera = new CameraService();
              let city_id = matinh
              let agent_id = matinh
              let customer_id = this.dsHDKH[0]['MA_KH']
              let subscription_id = 0
              var integrated_services
              let message = ''
              let kieu = this.kieu_ld_kieu
              if (kieu == 1 || kieu == 2 || kieu == 3) {
                integrated_services = 0
              } else integrated_services = 1

              let username = this.dsHDTB[0]['MA_TB']
              let password = this.dsHDTB_ADSL[0]['PASSWORD']
              let email = this.dsHDTB_ADSL[0]['EMAIL']
              let pdata =
                '{"city_id":"' + city_id + '","agent_id":"' + agent_id + '","customer_id":"' + customer_id + '","subscription_id":"' + subscription_id + '","integrated_services":"' + integrated_services + '","username":"' + username + '","password":"' + password + '","email":"' + email + '"}'
              // let rs = await this.$root.context.post("http://vnptapi.iveda.com/index.php/api/add",JSON.parse(pdata));
              // message = JSON.parse(rs.data);
              // this.thuebao.statusVdc = (message.indexOf("resultid\":\"0")>=0)
              let rs = await this.$root.context.post('/tichhop/iveda/add', JSON.parse(pdata))
              message = rs.faultString + JSON.parse(rs.data)
              this.thuebao.statusVdc = rs.errorCode == 0 //(message.indexOf("resultid\":\"0")>=0)
              // this.thuebao.statusVdc = camera.ThemMoiKhachHang(city_id, agent_id, customer_id, subscription_id, integrated_services, username, password, email, ref message);
              if (!this.thuebao.statusVdc) {
                this.$toast.error('Có lỗi xảy ra trong quá trình kích hoạt lên hệ thống Camera.\nLỗi: ' + message)
                return
              }
              this.thuebao.check_tb_adsl = true //Hiếu thêm biến kiểm tra thuê bao ADSL đã được đặt chỗ hay chưa. 5.10.2010
            } else {
              this.thuebao.statusVdc = true
              this.thuebao.check_tb_adsl = true
            }
            if (!this.thuebao.statusVdc || !this.thuebao.check_tb_adsl) return
          }
        }
      if ((this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGACAMERA) && this.thuebao.statusVdc == true) {
        //Gọi hàm cập nhật trạng thái HDTB = 1: Đã đặt chỗ thành công trên VDC
        // obj.CAPNHAT_STATUS_HDTB(hdtb_id, TRANGTHAI_DONGBO.DONGBO_LHD);
        this.txtStatus = TRANGTHAI_DONGBO.DONGBO_LHD
        if(this.dsHDTB && this.dsHDTB.length==1)
          this.dsHDTB[0].STATUS = this.txtStatus;
      }

      //Cập nhật trạng thái đồng bộ nếu là thuê bao di động trả sau
      if (this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG && this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRASAU && TRANGTHAI_DONGBO.OPEN_SYNC_VINA) {
        // new LapHopDongFacade().CAPNHAT_STATUS_HDTB(hdtb_id, TRANGTHAI_DONGBO.DONGBO_LHD);
        this.txtStatus = TRANGTHAI_DONGBO.DONGBO_LHD
        if(this.dsHDTB && this.dsHDTB.length==1)
          this.dsHDTB[0].STATUS = this.txtStatus;
      }
        // Dang ky UMP
        //FIXME can chuyen phan nay sang API
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
          if (this.listbox.loai_tb.valuemgwan == 157) {
            //Fix ID loại thiết bị STB UMP
            let rs = await this.$root.context.post('/tichhop/ump/RegisterUMP', { serialNumber: this.thuebao.adsl.txtSerialSTB, mytvUsername: this.dsHDTB[0]['MA_TB'], mytvPassword: this.dsHDTB[0]['PASSWORD'] })
            let kq = JSON.parse(rs.data)
            if (kq['Message']) kq = kq['Message']
            // bool kq = DangkyUMP(txtSerialSTB.Text.Trim(), dsHDTB.Tables[0].Rows[0]["MA_TB"].ToString(), dsHDTB_ADSL.Tables[0].Rows[0]["PASSWORD"].ToString(), ref message);
            if (kq.status != 'success') {
              this.$toast.error('Có lỗi trong quá trình đẩy thông tin thiết bị lên UMP. Lỗi: ' + kq.message)
              return
            }
          }
        }
      } else {
        // #region Đặt chỗ lại cho Account ADSL
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL) {
          let loaihinh_tb = this.listbox.loaihinh_tb.value
          if (loaihinh_tb == LoaiHinhTB.INTERNET_1260 || loaihinh_tb == LoaiHinhTB.INTERNET_ADSL || loaihinh_tb == LoaiHinhTB.INTERNET_FTTH || loaihinh_tb == LoaiHinhTB.WIFI_FIBER || loaihinh_tb == LoaiHinhTB.MEGA_IOT) {
            if (this.DONGBO_TEST.TEST == false) {
              // VDCService vdcService = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
              let account = this.dsHDTB[0]['MA_TB']
              if (account && (account+'').trim().length == 0) {
                this.$toast.error('Account không được trống. Hãy kiểm tra lại!')
                // txtAccountADSL.Focus();
                return
              }
              let pdata = {
                accountModel: { accountName: account }
                //"reservemodel": { "context":contex, "reservedTime": "2022-01-11" } //Bỏ do VISA default vào FTTH rồi
              }
              this.thuebao.statusVdc = false
              await API.post_reReservedAccount(this.axios, pdata).then((response) => {
                if (response && response.data && response.data.data && response.data.errorCode != 1) this.thuebao.statusVdc = response.data.data == 'ok'
                else this.$toast.error(response.data.faultCode + ': ' + response.data.faultString)
              })
              //if (!vdcService.DatChoLaiMegaVNN(account, dtpHanDatCho.Value))
              if (!this.thuebao.statusVdc) {
                this.$toast.error('Có lỗi xảy ra trong quá trình đặt chỗ lại cho Account ' + account + ' lên Visa.Bạn hãy vui lòng thử lại!')
                return
              } else {
                this.$toast.success('Đặt chỗ lại cho Account ' + account + ' lên Visa thành công!')
              }
            }
          }
        }
      if ((this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGACAMERA) && this.thuebao.statusVdc == true) {
        //Gọi hàm cập nhật trạng thái HDTB = 1: Đã đặt chỗ thành công trên VDC
        // obj.CAPNHAT_STATUS_HDTB(hdtb_id, TRANGTHAI_DONGBO.DONGBO_LHD);
        this.txtStatus = TRANGTHAI_DONGBO.DONGBO_LHD
        if(this.dsHDTB && this.dsHDTB.length==1)
          this.dsHDTB[0].STATUS = this.txtStatus;
      }

      //Cập nhật trạng thái đồng bộ nếu là thuê bao di động trả sau
      if (this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG && this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRASAU && TRANGTHAI_DONGBO.OPEN_SYNC_VINA) {
        // new LapHopDongFacade().CAPNHAT_STATUS_HDTB(hdtb_id, TRANGTHAI_DONGBO.DONGBO_LHD);
        this.txtStatus = TRANGTHAI_DONGBO.DONGBO_LHD
        if(this.dsHDTB && this.dsHDTB.length==1)
          this.dsHDTB[0].STATUS = this.txtStatus;
      }
        // #region "Cập nhật UMP"
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
          if (this.listbox.loai_tb.valuemgwan == 157) {
            //Fix ID loại thiết bị STB UMP
            let rs = await this.$root.context.post('/tichhop/ump/UpdateUMP', { serialNumber: this.thuebao.adsl.txtSerialSTB, mytvUsername: this.dsHDTB[0]['MA_TB'], mytvPassword: this.dsHDTB[0]['PASSWORD'] })
            let kq = JSON.parse(rs.data)
            if (kq['Message']) kq = kq['Message']
            // let kq = CapNhatUMP(txtSerialSTB.Text.Trim(), dsHDTB.Tables[0].Rows[0]["MA_TB"].ToString(), dsHDTB_ADSL.Tables[0].Rows[0]["PASSWORD"].ToString(), ref message);
            if (kq.status != 'success') {
              Message_Box.ShowWarning('Có lỗi trong quá trình cập nhật thông tin thiết bị lên UMP. Lỗi: ' + kq.message)
              return
            }
          }
        }
      }
      if (TRANGTHAI_DONGBO.OPEN_SYNC_VINA) {
        // case update thi khong can dieu kien nay????
        // #region Đồng bộ lại dữ liệu lên VinaPhone
        if (this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG && this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRASAU) {
          //if (!KiemTra_HDLD_TBDD_TraTruoc()) return; // Thay bang xu ly API ben duoi
          let checkvnp = true
          await API.post_fn_kiemtra_hdld_tbdd_tratruoc(this.axios, {
            dichvuvt_id: this.listbox.dichvu_vt.value,
            goicuoc_dd: this.thuebao.didong.cboGoiCuocDD.value,
            kieuld_id: this.listbox.kieu_ld.value,
            loai_tb_dd: this.thuebao.didong.LOAI_TB_DD, //"MB - Tra truoc",
            ma_tb: this.ma_tb
          }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code == 'BSS-00000000' && response.data.data != 1) {
              this.$toast.error(response.data.data)
              checkvnp = false
            }
          })
          if (!checkvnp) return

          let matb_neo = this.dsHDTB[0]['ma_tb'.toUpperCase()] //CommonFunction.ChuanHoa_XML(dsHDTB.Tables[0].Rows[0]["ma_tb".toUpperCase()].ToString());

          let ma_hd = this.dsHDKH[0]['ma_gd'.toUpperCase()]
          //Nếu dữ liệu HĐ chưa được đồng bộ với VinaPhone ( status = 0).
          //Thực hiện Insert HD + TB lên VinaPhone và Update DB

          if (this.buttonSet == 1 || (!KQ_DB_DL || KQ_DB_DL == 0)) {
            //Tạo mới hđ khách hàng.
            let rs = await this.Insert_HDLD_VinaPhone()
            if (rs != 'OK') {
              this.$toast.error(rs)
              return
            }
            //Tạo mới hđ thuê bao neu kieu ld la hoa mang moi, chuyen tinh thi ko can -- vuth update 0912
            if (this.dsHDTB[0]['kieuld_id'.toUpperCase()] == KieuLapDat.DM_DIDONG || this.dsHDTB[0]['kieuld_id'.toUpperCase()] == KieuLapDat.DM_DIDONG_C_P || this.dsHDTB[0]['kieuld_id'.toUpperCase()] == KieuLapDat.DM_DIDONG_KHOI_TAO_LAI) {
              rs = await this.Insert_TBLD_VinaPhone()

              if (rs == 'OK') {
                //Doan nay da xu ly o API ins_upd ben duoi, khong can lam gi o day
                // new LapHopDongFacade().CAPNHAT_STATUS_HDTB(hdtb_id, TRANGTHAI_DONGBO.DONGBO_LHD); // da xu ly
                this.txtStatus = TRANGTHAI_DONGBO.DONGBO_LHD // thuoc phan CNTT???
                if(this.dsHDTB && this.dsHDTB.length==1)
                  this.dsHDTB[0].STATUS = this.txtStatus;
              } else {
                this.$toast.error('Có lỗi xảy ra trong quá trình thêm mới hợp đồng thuê bao di động trên VinaPhone.\n' + rs)

                //nếu hđ trên CCBS chưa có thuê bao thì xóa cả HĐ.
                let dsTB_TMP = [] //new CCBSFacade().TS_LAPHD_HOAMANGMOI_LAY_DS_THUEBAO(tt_nd.USER_NEO, ma_hd);
                await API.post_ts_laphd_hoamangmoi_lay_ds_thuebao(this.axios, {
                  ma_tinh: this.tt_nd.tentat_ccbs,
                  ma_hd: ma_hd
                }).then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code == 'BSS-00000000' && response.data.data != 1) {
                    dsTB_TMP = response.data.data
                  }
                })
                if (dsTB_TMP.length == 0) {
                  let rsDel = await this.Delete_HDLD_VinaPhone(this.dsHDKH[0]['ma_gd'.toUpperCase()])
                  if (rsDel != 'OK') this.$toast.error(rsDel)
                }
                return
              }
            }
          } else {
            // Nếu đã có hợp đồng này trên VinaPhone rồi thì gọi hàm UpdateHD + UpdateTB
            //region vuth update 0912 cập nhật tùy theo hòa mạng mới, hay chuyển tỉnh
            if (this.dsHDTB[0]['kieuld_id'.toUpperCase()] == KieuLapDat.DM_DIDONG || this.dsHDTB[0]['kieuld_id'.toUpperCase()] == KieuLapDat.DM_DIDONG_C_P || this.dsHDTB[0]['kieuld_id'.toUpperCase()] == KieuLapDat.DM_DIDONG_KHOI_TAO_LAI) {
              let rs = await this.Update_HDLD_VinaPhone()
              if (rs != 'OK') {
                this.$toast.error(rs)
                return
              }

              if (this.dsHDTB[0]['status'.toUpperCase()] == 1) {
                //Cập nhật hđ thuê bao neu hdtb da dong bo 0306
                rs = await this.Update_TBLD_VinaPhone()

                if (rs != 'OK') {
                  this.$toast.error(rs)
                  return
                }
              } else if (this.dsHDTB[0]['status'.toUpperCase()] == 0) {
                // insert neu hdtb chưa đồng bọ 0306
                rs = await this.Insert_TBLD_VinaPhone()
                if (rs != 'OK') {
                  this.$toast.error(rs)
                  return
                }
                //Khong can xu ly cho nay vi da lam o ins_upd
                // new LapHopDongFacade().CAPNHAT_STATUS_HDTB(hdtb_id, TRANGTHAI_DONGBO.DONGBO_LHD);
                this.txtStatus = TRANGTHAI_DONGBO.DONGBO_LHD // thuoc phan CNTT???
                if(this.dsHDTB && this.dsHDTB.length==1)
                  this.dsHDTB[0].STATUS = this.txtStatus;
              }
            } else if (this.dsHDTB[0]['kieuld_id'.toUpperCase()] == KieuLapDat.DM_DIDONG_CHUYEN_TINH) {
              let rs = await this.Update_HD_ChuyenTinh_Vinaphone()
              if (rs != 'OK') {
                this.$toast.error(rs)
                return
              }
            }
          }
        }
      }
      if (this.buttonSet == 1) {
        //Nhap du lieu moi INSERT

        if (this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_DC || this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_TL) {
          validateValue = await API.post_fn_kiemtra_ma_tb_thueso(this.axios, {
            dichvuvt_id: this.listbox.dichvu_vt.value,
            loaihd_id: LoaiHopDong.DAT_MOI,
            ma_gd: this.khachhang.magd ? this.khachhang.magd : '',
            ma_tb: this.ma_tb ? this.ma_tb : '',
            phanvung_id: this.$root.token.getPhanVungID()
          })
            .then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data
              }
            })
            .catch(() => {
              return null
            })
          if (validateValue != 'OK') return
        }
        //TODO validate so da cap hay chua LINE 7822
        //if (!khoso.KIEMTRA_MATB(ma_tb_ht, 0, dichvuvt_id))

        //Tao du lieu LINE 8082
        if (this.loi_sinh_magd) {
          this.loi_sinh_magd = false
          return
        }
        if (DUNG_THU.DOITUONG_TB == this.listbox.doituong.value) {
          if (1 == 0) {
            // TODO if (!Kiemtra_dungthu_mytv())
            //TODO Lấy chi tiết khuyến mại dùng thử fill vào khuyenmai_hdtb chua lam do nam ngoai pham vi CD
          } else {
            //TODO xem lai, chua xac dinh muc dich xoa du lieu o day!
            this.dsKM_HDTB = this.dsKM_HDTB.filter((x) => !(x.khuyenmai_id == 2999 || x.khuyenmai_id == 2998))
            // let _arrKM_DT = this.dsKM_HDTB.filter(x=>x.khuyenmai_id==2999 || x.khuyenmai_id==2998);
            // if(_arrKM_DT)
            //   for(var item in _arrKM_DT)
            //     item.Delete();
          }
        }
      } else {
        //TODO bo tu dong 8856 - 9014 do khong lien quan phan CO_DINH -> doan nay co ve da xu ly o phia DB phan ins_upd
      }
      // Xu ly insert / update
      {
        if (this.loainv_ctv_hrm > 0 || this.loainv_ngt_hrm > 0) {
          //TODO dong 8353, can xem 2 thong tin nay lay nhu the nao???
          if (this.dsHDKH_Sub && this.dsHDKH_Sub.length > 0) {
            this.TAO_DULIEU_HDKH_SUB(this.dsHDKH_Sub, this.dsHDKH_Sub[0]['HDKH_ID'])
          } else {
            let row_khsub = {}
            row_khsub.HDKH_ID = this.dsHDKH[0]['HDKH_ID']
            if (this.loainv_ctv_hrm > 0) row_khsub.LOAINV_CTV_HRM = this.loainv_ctv_hrm
            if (this.loainv_ngt_hrm > 0) row_khsub.LOAINV_NGT_HRM = this.loainv_ngt_hrm
            this.dsHDKH_Sub = []
            this.dsHDKH_Sub.push(row_khsub)
          }
        } else {
          if (this.ts_kt_ltb_hrm && this.words.indexOf(this.listbox.loaihinh_tb.value) >= 0 && this.dsHDKH_Sub && this.dsHDKH_Sub.length > 0) this.TAO_DULIEU_HDKH_SUB(this.LowerCasePropertyList(this.dsHDKH_Sub), this.dsHDKH[0]['HDKH_ID'])
        }
        //this.CapNhat_DiaChiBC(); // TODO LINE 8413
        //TODO inset du lieu vao DB va hien thi. LINE 8389
        //FIXME array [] la chua lay duoc du lieu o thoi diem hien tai.
        let pdata = {
          HD_KHACHHANG: this.dsHDKH,
          HD_THUEBAO: this.dsHDTB,
          HD_THANHTOAN: this.dsHDTT,
          HDTB_DV: this.dsHDTBDV,
          HDTB_CD: this.dsHDTB_CD,
          HDTB_DD: this.dsHDTB_DD,
          HDTB_INT: this.dsHDTB_INT,
          HDTB_ADSL: this.dsHDTB_ADSL,
          DIACHI: this.dsDiaChi,
          DIACHI_HDKH: this.dsDiaChiHDKH,
          DIACHI_HDTT: this.dsDiaChiHDTT,
          DIACHI_HDTB: this.dsDiaChiHDTB,
          DANGKY_DVGT: this.dsDK_DVGT,
          DANGKY_DVK: this.dsDK_DVKHAC,
          CT_MUA_TBI: this.UpperCasePropertyList(this.dsCTM_TBI),
          HDTB_MGWAN: this.dsHDTB_MEWAN, //dsHDTB_MEWAN
          HDTB_TSL: this.dsHDTB_TSL, //dsHDTB_TSL
          HDTB_GP: this.dsHDTB_GP, //dsHDTB_GP
          KHUYENMAI_HDTB: this.dsKM_HDTB && this.dsKM_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsKM_HDTB) : this.dsKM_HDTB, //this.dsKM_HDTB,
          DATCOC_HDTB: this.dsDC_HDTB && this.dsDC_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsDC_HDTB) : this.dsDC_HDTB,
          THONGTIN_TT: this.dsTTTT, //this.dsTTTT,
          CT_TIENHD: this.dsCTTHD,
          TIEN_HDTB: this.dsTien_HDTB, //this.dsTien_HDTB,
          TIEN_DATCOC: this.dsTien_DatCoc,
          HDTB_IMS: this.dsHDTB_IMS, //dsHDTB_IMS
          CAMKET_HDTB: this.dsCAMKET_HDTB,
          HUONGGIAO_ID: this.huonggiao_tn,
          HDTB_KV: this.dsHDTB_KV, //this.dsHDTB_KV_tmp?this.dsHDTB_KV_tmp:this.dsHDTB_KV, da bo _tmp
          HDTB_CNTT: this.dsHDTB_CNTT, //dsHDTB_CNTT
          HDTT_NV: this.dsHDTT_NV,
          HDTB_DUNGTHU: this.dsHDTB_DUNGTHU,
          TRAGOP_TBI_HDTB: this.dsTRAGOP_TBI_HDTB,
          HDTB_LOAIIP: this.dsHDTB_LoaiIp && this.dsHDTB_LoaiIp.length > 0 ? this.dsHDTB_LoaiIp.filter((x) => x.LOAIIP_ID && x.LOAIIP_ID > 0) : [], //this.dsHDTB_LoaiIp,
          HDKH_SUB: this.dsHDKH_Sub,
          HDTB_SUB: this.dsHDTB_SUB, //this.dsHDTB_SUB,
          HDTB_CT: this.dsHDTB_CT, //this.dsHDTB_CT, //Chi co o phan dich vu CNTT / frmChiTietHDTB
          THEMMOI: this.buttonSet == 1,
          LOAITB_ID: this.listbox.loaihinh_tb.value,
          DICHVUVT_ID: this.listbox.dichvu_vt.value,
          KT_KVNLML: KT_KVNLML, //BUG KT_KVNLML nhung de mac dinh de chay test
          TUDONG_SINH_SOAO: this.TUDONG_SINH_SOAO ? 1 : 0, // Chi dung cho cac case MEGAWAN...

          MAKH_WEB: this.khachhang.makh,
          DS_DIACHI_BC: {
            DIACHIBC_ID: this.diachibc_id,
            HDTT_ID: this.hdtt_id,
            PHOBC_ID: this.diachiBC.PHO_ID,
            PHUONGBC_ID: this.diachiBC.PHUONG_ID,
            QUANBC_ID: this.diachiBC.QUAN_ID,
            SONHA_BC: this.diachiBC.SO_NHA,
            DIACHI_BC: this.diachiBC.DIACHI,
            TINHBC_ID: this.diachiBC.TINH_ID,
            APBC_ID: this.diachiBC.AP_ID,
            KHUBC_ID: this.diachiBC.KHU_ID,
            DACDIEMBC_ID: this.diachiBC.DACDIEM_ID
          },
          LIST_SERIAL: [],
          IS_TRUOCBH: 0,
          KIEMTRA_DK_APDUNG: 'ok', //BUG KIEMTRA_DK_APDUNG nhung de mac dinh de chay test

          TD_GANTHEM_HDTB_DV: this.TD_GANTHEM_HDTB_DV ? 1 : 0,
          STATUS_VDC: this.STATUS_VDC,
          OPEN_SYNC_VINA: TRANGTHAI_DONGBO.OPEN_SYNC_VINA ? 1 : 0,

          MA_TB: this.ma_tb ? this.ma_tb : this.khachhang.makh,
          MA_TB_HT: this.ma_tb_ht,
          MA_TB_AO: this.ma_tb_ao,
          MA_TB_AO_HT: this.ma_tb_ao_ht,
          MA_TB_AO_HT_CUOI: this.ma_tb_ao_ht_cuoi,
          MA_TB_AO_CUOI: '',

          DULIEU_KS: this.bDuLieuKS ? 1 : 0,
          SD_FRMSHUONGKN_V2: this.thamsomacdinh['SD_FRMDSHUONGKN_V2'] == 1 ? 1 : 0,
          LOAISOWAN: this.loaisowan,
          VRF: this.thuebao.mgwan.vrfvfi,
          MA_TB_DIACHILD: null,
          VPHIEUCSKHDV_ID: this.phieucskhdv_id, // TODO chua biet load nhu the nao
          KETCUOI_ID: this.KetCuoi_ID,
          LAT_LD: this.diachiLD.Lat,
          LNG_LD: this.diachiLD.Lng,
          FIBER_BS: 0,
          CONGNGHE_ID: this.listbox.congnghe.value == 0 ? null : this.listbox.congnghe.value,
          MATB_TN: this.thuebaocd.matn ? this.thuebaocd.matn.trim() : null
        }
        checkloi = false;
        await API.post_fn_ins_update_hd_datmoi(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let hdkh_id = this.khachhang.hdkh_id
            let data = JSON.parse(response.data.data)
            if (data['ERROR_CODE'] != 1) {
              this.$toast.error(data['MESSAGE'])
              checkloi = true
              return
            } else {
              if(KT_KVNLML!=1) {
                if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
                  // VDCService vdc = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
                  // vdc.HuyDatChoMegaVNN(txtAccountADSL.Text);
                  await vdc.HuyDatChoMegaVNN(this.thuebao.adsl.txtAccountADSL)
                }

                this.buttonSet = 0

                this.$toast.success('Hợp đồng đã được thoái trả. Khách hàng sẽ được đưa vào danh sách Khách hàng tiềm năng!')
                checkloi = true
                return 'err'
              }
              if (this.buttonSet == 1) {
                this.DatMoi_Fsecure_kem_fiber()
                this.Them_MyTV_vao_goi_giadinh()
              }
              this.$toast.success(data['MESSAGE'])
              // this.buttonSet = 0;
            }
            if (checkloi) return
            try {
              this.kt_load = true;
            await API.post_fn_lay_ds_ht_capnhat_datmoi(this.axios, { ds_para: JSON.stringify({ HDKH_ID: this.khachhang.hdkh_id }) }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                let apidata = JSON.parse(response.data.data)
                if (apidata['ERROR_CODE'] == 1) {
                  let ds_hdkh_tmp = apidata['RESULT']['DS_HDTB']
                  let ds_hdtt_tmp = apidata['RESULT']['DS_HDTT']
                  ds_hdkh_tmp = this.LowerCasePropertyList(ds_hdkh_tmp)
                  ds_hdtt_tmp = this.LowerCasePropertyList(ds_hdtt_tmp)

                  await this.HienThiDanhSacHDTB(ds_hdkh_tmp)
                  await this.HienThiTTHopDongTB(ds_hdkh_tmp)
                  await this.HienThiDanhSacHDTT(ds_hdtt_tmp)
                  await this.HienThiTTHopDongTT(ds_hdtt_tmp)
                } else {
                  this.$toast.error(data['MESSAGE'])
                  checkloi = true
                  return
                }
              }
            })
          } catch(ex) {} finally {this.kt_load = false;}
            if (checkloi) return
            // HienThiDS_HDTB_CBO(this.khachhang.hdkh_id); //  100% la comment
            this.HienThiDS_HDTT_CBO(this.khachhang.hdkh_id) // Da load du lieu san, chi can reset lai gia tri duoc chon la duoc.

            this.buttonSet = 3
            //this.$toast.success("Đã cập nhật dữ liệu lên hệ thống của Viễn thông tỉnh thành công!");
            //Da tich hop vao insert API, chi can truyen dung phieucskhdv_id vao insert API la xong.
            // if (this.phieucskhdv_id > 0)
            // {
            //     new TruyenDanFacade().EXECUTE_PROC("{?DB2}.b2a_ht_phieucskhdv",
            //     "vphieucskhdv_id", this.phieucskhdv_id,
            //     "vnhanvien_id", tt_nd.nhanvien_id,
            //     "vdonvi_id", tt_nd.donvi_id,
            //     "vnguoi_cn", tt_nd.ma_nd,
            //     "vip_cn", tt_nd.ip,
            //     "vmay_cn", tt_nd.may_cn,
            //     "vkieu", 1);
            // }
          }
        })
        if (checkloi) return
        this.buttons.tsbtnXoaTB = !this.lvwThueBao || this.lvwThueBao.length <= 1

        if (this.OnDatMoi) {
          try {
            this.$emit('OnDatMoi', { hdkh_id: this.khachhang.hdkh_id, hdtt_id: this.hdtt_id, hdtb_id: this.hdtb_id, PhieuHs_ID: this.PhieuHs_ID, TenKH: this.khachhang.tenkh })
            //OnDatMoi.Invoke(this, hdkh_id, hdtt_id, hdtb_id, PhieuHs_ID, txtTenKH.Text);
          } catch (ex) {
            this.$toast.error('' + ex)
            if (this.debug) console.error(ex)
          }
        }
        //this.PhieuHs_ID = 0; //FIXME xem lai co can lenh gan nay khong????, tam thoi khong thay code cu xu ly ghi gi den bien nay.
      }
    },
    async TaoDuLieu(themmoi) {
      await this.TaoDuLieu_HDKH(themmoi)
      if (this.loi_sinh_magd) return
      await this.TaoDuLieu_HDTT(themmoi)
      await this.TaoDuLieu_HDTB(themmoi)
      if (DUNG_THU.DOITUONG_TB == this.listbox.doituong.value) {
        await this.TaoDuLieu_HDTB_DUNGTHU(themmoi)
      }
      await this.TaoDuLieu_HDTT_NV(themmoi)
      await this.TaoDuLieu_THONGTIN_TT(themmoi)
      await this.TaoDuLieu_CT_TIENHD(true)
      await this.TaoDuLieu_DiaChi(themmoi, 4)
      await this.TaoDuLieu_DKDV()
      await this.TaoDuLieu_TIEN_DATCOC(themmoi)
      await this.CapNhat_HDTB_ID_DangKyDV()
      await this.CapNhat_HDTB_ID_HDTB_KV()

      if (themmoi) {
        if ((this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) && this.thamsomacdinh['MGW_MTN_KTR_HOA'] && this.thamsomacdinh['MGW_MTN_KTR_HOA'] == 1)
          this.ma_vnpt = this.ma_tb_ht.toUpperCase()
        else this.ma_vnpt = this.ma_tb_ht
      }

      this.dsHDTB_CD = []
      this.dsHDTB_DD = []
      this.dsHDTB_INT = []
      this.dsHDTB_ADSL = []
      this.dsHDTB_TSL = []
      this.dsHDTB_MEWAN = []
      this.dsHDTB_GP = []
      this.dsHDTB_IMS = []
      this.dsCAMKET_HDTB = []
      this.dsHDTBDV = []
      this.dsHDTB_CNTT = []
      this.dsHDTB_LoaiIp = []
      switch (this.listbox.dichvu_vt.value * 1) {
        case DichVuVienThong.CO_DINH:
          await this.TaoDuLieu_HDTB_CD(themmoi)
          await this.TaoDuLieu_CAMKET_HDTB(true)
          break
        case DichVuVienThong.DI_DONG:
          await this.TaoDuLieu_HDTB_DD(themmoi)
          break
        case DichVuVienThong.MEGAWAN:
        case DichVuVienThong.METRONET:
        case DichVuVienThong.MGW_DOITAC:
        case DichVuVienThong.NOIBO_DADIEM:
          await this.TaoDuLieu_HDTB_MGWAN(themmoi)
          break
        case DichVuVienThong.MEGA_EYES:
          await this.TaoDuLieu_HDTB_ADSL(themmoi)
          break
        case DichVuVienThong.ADSL:
        case DichVuVienThong.HATANG_VIENTHONG:
        case DichVuVienThong.BRCD_DOITAC:
          await this.TaoDuLieu_HDTB_ADSL(themmoi)
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
            await this.TaoDuLieu_HDTB_LOAIIP()
          }
          break
        case DichVuVienThong.TSL:
        case DichVuVienThong.TSL_DOITAC:
        case DichVuVienThong.NOIBO_2DIEM:
          await this.TaoDuLieu_HDTB_TSL(themmoi)
          break
        case DichVuVienThong.GPHONE:
          await this.TaoDuLieu_HDTB_GP(true)
          await this.TaoDuLieu_CAMKET_HDTB(true)
          break
        case DichVuVienThong.IMS:
        case DichVuVienThong.IMS_DOITAC:
          await this.TaoDuLieu_HDTB_IMS(true)
          await this.TaoDuLieu_CAMKET_HDTB(true)
          break
        case DichVuVienThong.TRUNGTAM_DULIEU:
        case DichVuVienThong.HOINGHI_TRUYENHINH:
        case DichVuVienThong.ANTOAN_BAOMAT_TT:
        case DichVuVienThong.DICHVU_CNTT:
          // repositoryItemCalcEdit.ID = ItemList[index1].sFieldName;
          // repositoryItemCalcEdit.Value = ItemList[index1].sValue;
          for (var item of this.ItemList) {
            let guiItem = this.gridEditors.filter((x) => x.ID == item.sFieldName)
            if (guiItem && guiItem.length > 0) item.sValue = guiItem[0].Value ? guiItem[0].Value + '' : guiItem[0].Value
          }
          this.dsHDTB_CNTT = this.ItemList
          //Tạo cho bảng hdtb_dv
          for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
            if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
              throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
              return;
            }
            let row = {}
            row.HDTB_ID = this.hdtb_id
            row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
            row.DONVI_ID = this.DT_CONTROLS.value[i]
            row.KIEUDV_ID = 2
            this.dsHDTBDV.push(row)
          }
          //Duong them
          this.TAO_DULIEU_HDTB_SUB(themmoi) //FIXME khi update thi update thang o form v2, khong goi qua duong nay! ThangDM1 2022-12-17
          //End
          break
      }
    },
    async TaoDuLieu_HDKH(themmoi) {
      this.dsHDKH = []
      let rowHDKH = {}
      let vmagd_temp = ''
      let dulieuapi = {}
      await API.post_fn_lay_tt_taodl_hdkh(this.axios, {
        ds_para: JSON.stringify({
          DONVI_ID: this.$root.token.getDonViID(),
          LOAIHD_ID: LoaiHopDong.DAT_MOI,
          DONVI_DL_ID: '0',
          DONVI_QL_ID: this.listbox.donvi_ql.value ? this.listbox.donvi_ql.value : 0,
          TS_SINHMA_GD_THEO_DONVI: this.ts_sinhma_gd_theo_donvi ? 1 : 0,
          MA_HD: this.khachhang.mahd ? this.khachhang.mahd : '',
          MA_KH: this.khachhang.makh ? this.khachhang.makh : '',
          THEMMOI: themmoi
        })
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          dulieuapi = JSON.parse(response.data.data)
        }
      })
      //FIXME check lai cho nay vi mat hdkh_id
      if (!dulieuapi || dulieuapi['ERROR_CODE'] != 1) {
        throw dulieuapi?dulieuapi["MESSAGE"]:"Lỗi tạo dữ liệu hợp đồng khách hàng! "+response.data.message+": "+response.data.message_detail;
      }
      if (dulieuapi && dulieuapi['ERROR_CODE'] == 1) {
        if (dulieuapi['RESULT']) dulieuapi = dulieuapi['RESULT']
        if (dulieuapi['HDKH_ID']) {
          rowHDKH.HDKH_ID = dulieuapi['HDKH_ID']
          if (rowHDKH.HDKH_ID && rowHDKH.HDKH_ID > 0) this.khachhang.hdkh_id = rowHDKH.HDKH_ID
        }
        if (dulieuapi['MA_GD']) rowHDKH.MA_GD = dulieuapi['MA_GD']
        if (dulieuapi['MA_HD']) rowHDKH.MA_HD = dulieuapi['MA_HD']
        if (dulieuapi['MA_KH']) this.khachhang.makh = dulieuapi['MA_KH']
      }
      if (!rowHDKH.HDKH_ID || rowHDKH.HDKH_ID == 0) {
        if (this.khachhang.hdkh_id && this.khachhang.hdkh_id > 0 && !themmoi) rowHDKH.HDKH_ID = this.khachhang.hdkh_id
        else
          await API.post_get_keys(this.axios, { keyname: 'HD_KHACHHANG' }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              rowHDKH.HDKH_ID = response.data.data // 4039
              this.khachhang.hdkh_id = rowHDKH.HDKH_ID
            }
          })
      }

      if (this.hdkh_cha_id > 0) rowHDKH.HDKH_CHA_ID = this.hdkh_cha_id
      if (themmoi) {
        if(rowHDKH.MA_GD) this.khachhang.magd = rowHDKH.MA_GD
        else rowHDKH.MA_GD = this.khachhang.magd
        if(rowHDKH.MA_HD) this.khachhang.mahd = rowHDKH.MA_HD
        else rowHDKH.MA_HD = this.khachhang.mahd;
        rowHDKH.NGAY_YC = moment(new Date()).format('DD/MM/YYYY') //TODO can doi thanh lay sysdate tu server thong qua ngay_cn cua user login, la goi ham sysdate tu server
      } else {
        rowHDKH.MA_GD = this.khachhang.magd
        rowHDKH.MA_HD = this.khachhang.mahd
        rowHDKH.NGAY_YC = moment(new Date()).format('DD/MM/YYYY') //TODO can doi thanh lay sysdate tu server thong qua ngay_cn cua user login, la goi ham sysdate tu server
      }
      if (!this.khachhang.makh) {
        //TODO sinh ma khach hang
        //this.khachhang.makh = new HoanThienHoSoFacade().SINH_MAKH(Convert.ToInt32(cboDonViQL.SelectedValue));
        this.khachhang.khachhang_id = 0
      }
      rowHDKH.MA_KH = this.khachhang.makh
      if (this.khachhang.khachhang_id > 0) {
        rowHDKH.KHACHHANG_ID = this.khachhang.khachhang_id
        rowHDKH.NGAYLAP_HD = this.NgayLapHD ? this.NgayLapHD : moment(new Date()).format(this.datetimeFormatFull)
      } else {
        if (!this.khachhang.hdkh_id || this.khachhang.hdkh_id == 0) rowHDKH.NGAYLAP_HD = moment(new Date()).format(this.datetimeFormatFull)
        else rowHDKH.NGAYLAP_HD = this.NgayLapHD ? this.NgayLapHD : moment(new Date()).format(this.datetimeFormatFull)
        // rowHDKH.NGAYLAP_HD = this.NgayLapHD;
      }
      rowHDKH.TEN_KH = this.khachhang.tenkh
      rowHDKH.DIACHI_KH = this.diachiKH.DIACHI ? this.diachiKH.DIACHI.trim() : null
      rowHDKH.NGUOI_DD = this.khachhang.nguoidd ? this.khachhang.nguoidd.trim() : null
      rowHDKH.SO_DT = this.khachhang.dienthoai
      rowHDKH.CHUCDANH_DD = this.khachhang.chucvu
      rowHDKH.HOKHAU = this.diachiHK.DIACHI ? this.diachiHK.DIACHI.trim() : null
      if (this.NgayCapHK) rowHDKH.NGAY_HK = this.NgayCapHK
      rowHDKH.NOICAP_HK = this.khachhang.noicaphk ? this.khachhang.noicaphk.trim() : null
      if (this.NgaySinh) rowHDKH.NGAY_SN = this.NgaySinh
      rowHDKH.LOAIGT_ID = this.listbox.loai_gt.value
      rowHDKH.SO_GT = this.khachhang.sogt
      if (this.NgayCap) {
        rowHDKH.NGAYCAP = this.NgayCap
      } else rowHDKH.NGAYCAP = '';
      rowHDKH.NOICAP = this.khachhang.noicap ? this.khachhang.noicap.trim() : null
      rowHDKH.SO_FAX = this.khachhang.fax ? this.khachhang.fax.trim() : null
      rowHDKH.DONVI_ID = this.$root.token.getDonViID()
      rowHDKH.NHANVIEN_ID = this.$root.token.getNhanVienID()
      rowHDKH.KHLON_ID = this.listbox.loai_khl.value

      rowHDKH.LOAIKH_ID = this.listbox.loai_kh.value
      //TODO thieu cai checkbox lapdatbosung nam chim duoi checkbox CTV o tren cung cua form
      // if (chkLapDatBS.Checked)
      //     rowHDKH.BOSUNGTB_ID = 1;
      // else
      rowHDKH.BOSUNGTB_ID = 0
      rowHDKH.LOAIHD_ID = LoaiHopDong.DAT_MOI

      //if (chkKHKT3.Checked)
      //    rowHDKH.KH_KT3 = 1;
      //else
      //    rowHDKH.KH_KT3 = 0;

      rowHDKH.NGUOI_CN = this.$root.token.getUserName()
      rowHDKH.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
      rowHDKH.MAY_CN = null
      rowHDKH.IP_CN = null

      rowHDKH.GIOITINH = this.khachhang.gioitinh
      rowHDKH.DANTOC_ID = this.listbox.dantoc.value
      rowHDKH.QUOCTICH_ID = this.listbox.quoctich.value
      rowHDKH.NGANHNGHE_ID = this.listbox.nganhngheloc.value
      rowHDKH.DIACHI_NDD = this.diachiNDD.DIACHI
      if (this.NgayHH) {
        rowHDKH.NGAYHETHAN_GT = this.NgayHH
      }
      rowHDKH.MST = this.khachhang.masothue
      if (this.listbox.nganhang.ischeckedkh) {
        rowHDKH.NGANHANG_ID = this.listbox.nganhang.valuekh
        rowHDKH.STK = this.listbox.nganhang.sotaikhoankh ? this.listbox.nganhang.sotaikhoankh.trim() : null
      }

      //TuấnNA thêm tạo dữ liệu tiểu ngành cấp 1,2,3 --- Ngày 03/12/2010
      rowHDKH.TNC1_ID = this.tieunganh.TNC1_ID ? this.tieunganh.TNC1_ID : 0
      rowHDKH.TNC2_ID = this.tieunganh.TNC2_ID ? this.tieunganh.TNC2_ID : 0
      rowHDKH.TNC3_ID = this.tieunganh.TNC3_ID ? this.tieunganh.TNC3_ID : 0
      rowHDKH.TNC4_ID = this.tieunganh.TNC4_ID ? this.tieunganh.TNC4_ID : 0
      //
      rowHDKH.GHICHU = this.khachhang.ghichu ? this.khachhang.ghichu.trim() : null
      rowHDKH.DACTRUNG = this.khachhang.dactrung ? this.khachhang.dactrung.trim() : null
      //rowHDKH.SO_GT_KEM = CommonFunction.StringToString(txtGiayToKem.Text.trim());

      if (this.filterbox.ctv.ischecked && this.filterbox.ctv.value) {
        rowHDKH.CTV_ID = this.ctv_id ? this.ctv_id : this.$root.token.getNhanVienID() //this.filterbox.ctv.ma_ctv;//ctv_id;
        if (this.listbox.hinhthuc_tthi.list && this.listbox.hinhthuc_tthi.list.length > 0) if (this.listbox.hinhthuc_tthi.value) rowHDKH.HTTTHI_ID = this.listbox.hinhthuc_tthi.value //Convert.ToInt32(cboHinhThucTThi.SelectedValue);
      }
      if (this.filterbox.nguoigt.ischecked && this.filterbox.nguoigt.value) {
        rowHDKH.NHANVIENGT_ID = this.filterbox.nguoigt.nguoigt_id //nguoigt_id;
      }

      rowHDKH.KIEUHD_ID = this.listbox.kieu_hd.value
      //vkieuhd_id = Convert.ToInt32(cboKieu_HD.SelectedValue);
      rowHDKH.PHANLOAIKH_ID = this.khachhang.PHANLOAIKH_ID != -1 ? this.khachhang.PHANLOAIKH_ID : 0
      rowHDKH.KENHTN_ID = this.iKenhTN
      //Bổ sung cho HCM theo y/c chị Tô Thảo - TP DHNV TTKD
      rowHDKH.MA_DUAN = this.maduan
      //PNLINH B2A 02/05/2020
      if (this.VPHIEUCSKH_ID != 0) {
        rowHDKH.PHIEUCSKH_ID = this.VPHIEUCSKH_ID
      }
      this.dsHDKH.push(rowHDKH)
      // TODO chua xu ly phan update
      // if (themmoi == false)
      // {
      //     dsHDKH.AcceptChanges();
      //     dsHDKH.HD_KHACHHANG.Rows[0].SetModified();
      // }
    },
    async TaoDuLieu_HDTT(themmoi) {
      let dulieuapi = ''
      this.dsHDTT = []
      let rowHDTT = {}
      await API.post_fn_lay_tt_taodl_hdtt(this.axios, {
        ds_para: JSON.stringify({
          LOAITB_ID: this.listbox.loaihinh_tb.value,
          KHACHHANG_ID: this.khachhang.khachhang_id,
          HDKH_ID: this.khachhang.hdkh_id,
          OPEN_SYNC_VINA_TRASAU: 0,
          MA_TT: this.thanhtoan.matt ? this.thanhtoan.matt : null,
          THEMMOI: themmoi,
          DONVI_QL_ID: this.listbox.donvi_ql.valueql ? this.listbox.donvi_ql.valueql : 0,
          QUANLD_ID: this.diachiLD.QUAN_ID ? this.diachiLD.QUAN_ID : 0,
          NGANHANG_ID: this.listbox.nganhang.value
        })
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          dulieuapi = JSON.parse(response.data.data)
        }
      })
      if (dulieuapi && dulieuapi['ERROR_CODE'] == 1) {
        if (dulieuapi['RESULT']) dulieuapi = dulieuapi['RESULT']
        if (dulieuapi['HDTT_ID']) {
          rowHDTT.HDTT_ID = dulieuapi['HDTT_ID']
          this.hdtt_id = dulieuapi['HDTT_ID']
        } else if (this.hdtt_id) rowHDTT.HDTT_ID = this.hdtt_id
        if (dulieuapi['MA_TT']) rowHDTT.MA_TT = dulieuapi['MA_TT']
      }
      rowHDTT.HDKH_ID = this.khachhang.hdkh_id
      if (!this.thanhtoan.matt) {
        this.thanhtoan.matt = rowHDTT.MA_TT
        this.thanhtoan.thanhtoan_id = 0
      }
      if (this.thanhtoan.thanhtoan_id > 0) rowHDTT.THANHTOAN_ID = this.thanhtoan.thanhtoan_id

      rowHDTT.MA_TT = this.thanhtoan.matt ? this.thanhtoan.matt.trim() : null
      rowHDTT.TEN_TT = this.thanhtoan.tentt ? this.thanhtoan.tentt.trim() : null
      rowHDTT.DIACHI_TT = this.diachiTT.DIACHI
      rowHDTT.DIACHI_BC = this.diachiBC.DIACHI
      //rowHDTT.MATB_DD = txtMaTT.Text;
      //rowHDTT.MS_NSNN = "";
      //rowHDTT.ML_NSNN = "";
      rowHDTT.MST = this.thanhtoan.masothue ? this.thanhtoan.masothue.trim() : null
      // if (ts_kt_mst_kh == 1)
      //     rowHDTT.MST = txtMST_TT2.Text.trim().Replace(" ", "");
      // else
      //     rowHDTT.MST = txtMST_TT.Text.trim().Replace(" ", "");
      rowHDTT.HTTT_ID = this.listbox.hinhthuc_tt.value
      rowHDTT.STK = this.listbox.nganhang.sotaikhoan ? this.listbox.nganhang.sotaikhoan.trim() : null
      rowHDTT.SO_DT = this.thanhtoan.sodienthoai ? this.thanhtoan.sodienthoai.trim() : null
      rowHDTT.EMAIL = this.thanhtoan.email ? this.thanhtoan.email.trim() : null
      rowHDTT.CHU_TK = this.thanhtoan.chutk ? this.thanhtoan.chutk.trim() : null
      if (dulieuapi['LOAI_NH']) rowHDTT.LOAI_NH = dulieuapi['LOAI_NH']

      if (this.listbox.nganhang.ischecked) {
        rowHDTT.NGANHANG_ID = this.listbox.nganhang.value

        if (rowHDTT.LOAI_NH == '2') {
          rowHDTT.DV_QHNS = this.nganhang.DV_QHNS
          rowHDTT.MACHUONG = this.nganhang.MACHUONG
          rowHDTT.MN_KT = this.nganhang.MN_KT
          rowHDTT.MA_NDKT = this.nganhang.MA_NDKT
          rowHDTT.MN_NSNN = this.nganhang.MN_NSNN
        }
        rowHDTT.TIEN_DM = 0
      }

      rowHDTT.DONVI_ID = this.listbox.donvi_ql.valueql
      if (this.thanhtoan.tuyenthu_id != 0) rowHDTT.TUYENTHU_ID = this.thanhtoan.tuyenthu_id
      rowHDTT.MATB_DD = this.listbox.madaidien.value

      rowHDTT.NGUOI_CN = this.$root.token.getUserName()
      rowHDTT.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
      rowHDTT.MAY_CN = null
      rowHDTT.IP_CN = null

      //rowHDTT.DIACHI_CT = CommonFunction.StringToString(txtDiaChiCT.Text);
      rowHDTT.DIACHI_CT = this.diachiCT.DIACHI
      rowHDTT.GHICHU = this.thanhtoan.ghichu
      rowHDTT.MATB_DD = this.listbox.madaidien.value

      // if(rowHDTT.MA_TT && !rowHDTT.MATB_DD) {
      //   this.$toast.error("Hãy chọn mã đại diện!");
      //   throw "Hãy chọn mã đại diện!";
      // }

      if (this.listbox.hinhthuc_tc.value && this.listbox.hinhthuc_tc.value > 0) rowHDTT.HTTC_ID = this.listbox.hinhthuc_tc.value
      else rowHDTT.HTTC_ID = HINHTHUC_TC.TRONGOI_THEO_HD

      this.dsHDTT.push(rowHDTT)
      //TODO chua xu ly update
      // if (themmoi == false)
      // {
      //     dsHDTT.AcceptChanges();
      //     dsHDTT.HD_THANHTOAN.Rows[0].SetModified();
      // }
    },
    LoadNVThuCuoc() {
      if (!this.watcherActive) return
      let diachi = {}
      if (this.diachiBC.DIACHI && this.diachiBC.PHUONG_ID) diachi = this.diachiBC
      else if (this.diachiTT.DIACHI && this.diachiTT.PHUONG_ID) diachi = this.diachiTT
      else if (this.diachiKH.DIACHI && this.diachiKH.PHUONG_ID) diachi = this.diachiKH
      if (!diachi.DIACHI) return

      let pdata = {
        vap_id: diachi.AP_ID ? diachi.AP_ID : 0,
        vdacdiem_id: 0,
        vdonvi_ql_id: this.listbox.donvi_ql.valueql ? this.listbox.donvi_ql.valueql : 0,
        vkhu_id: diachi.KHU_ID ? diachi.KHU_ID : 0,
        //"vphanvung_id": this.$root.token.getPhanVungID(),
        vpho_id: diachi.PHO_ID ? diachi.PHO_ID : 0,
        vphuong_id: diachi.PHUONG_ID
      }

      // this.$bvModal.show('dlgTimKiemNVTC')
      if (this.listbox.hinhthuc_tt.value && this.listbox.hinhthuc_tt.value > 0 && this.thanhtoan.tuyenthu_httt == 1) {
        API.post_ht_nvtc_theodc_v2(this.axios, pdata)
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //TODO popup chon nhan vien thu cuoc frmTraCuuNVTC
              //Sau do lay du lieu.
              if (response.data.data.length > 1) {
                this.popupTimNVThuCuoc(diachi)
              } else if (response.data.data.length > 0) {
                let obj = response.data.data[0] //BUG lay tam mac dinh nhan vien dau tien

                this.thanhtoan.nhanvientc_id = obj.nhanvien_id
                this.thanhtoan.manvtc = obj.manv_tc
                this.thanhtoan.tuyenthu_id = obj.tuyenthu_id
                this.thanhtoan.matuyen = obj.ma_tuyen
              } else {
                this.thanhtoan.nhanvientc_id = 0
                this.thanhtoan.manvtc = ''
                this.thanhtoan.tuyenthu_id = 0
                this.thanhtoan.matuyen = ''
              }
            }
          })
          .catch(() => {})
      } else {
        API.post_ht_nvtc_theodc(this.axios, pdata)
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //TODO popup chon nhan vien thu cuoc frmTraCuuNVTC
              //Sau do lay du lieu.
              if (response.data.data.length > 1) {
                this.popupTimNVThuCuoc(diachi)
              } else if (response.data.data.length > 0) {
                let obj = response.data.data[0] //BUG lay tam mac dinh nhan vien dau tien

                this.thanhtoan.nhanvientc_id = obj.nhanvien_id
                this.thanhtoan.manvtc = obj.manv_tc
                this.thanhtoan.tuyenthu_id = obj.tuyenthu_id
                this.thanhtoan.matuyen = obj.ma_tuyen
              }
            }
          })
          .catch(() => {})
      }
    },
    async HT_GIAODIEN_DONVI() {
      if (!this.listbox.kieu_ld.value || this.listbox.kieu_ld.value <= 0) return
      let tocdotn_id = 0
      this.muccuoctn_id = 0
      // TODO xu ly cac phan nay theo qua trinh lam
      if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.HATANG_VIENTHONG || this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC) {
        tocdotn_id = this.listbox.cboGoiCuocAdsl.value
        if (this.listbox.muccuoc.isenabled && this.listbox.dichvu_vt.value != DichVuVienThong.BRCD_DOITAC) this.muccuoctn_id = this.listbox.muccuoc.value
      } else if (this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT || this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT || this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU || this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH)
        tocdotn_id = this.listbox.cboGoiCuocAdsl.value
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) tocdotn_id = this.listbox.cboGoiCuocAdsl.value
      else if ((this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) && this.listbox.tocdokenh.valuetsl != null && this.listbox.tocdokenh.valuetsl != '') tocdotn_id = this.listbox.tocdokenh.valuetsl
      //Convert.ToInt32(cboTocDoKenhTSL.EditValue);
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) tocdotn_id = this.listbox.tocdokenh.valuecir
      // if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH){
      let pdata = {
        DICHVUVT_ID: this.listbox.dichvu_vt.value,
        TOCDOTN_ID: tocdotn_id ? tocdotn_id : 0,
        MUCCUOCTN_ID: this.muccuoctn_id,
        LOAITB_ID: this.listbox.loaihinh_tb.value,
        KIEULD_ID: this.listbox.kieu_ld.value,
        DAIVT_ID: this.listbox.donvi_ql.value,
        HT_LOC_CBO_TRAM: this.ht_loc_cbo_tram ? 1 : 0
      }
      pdata.PHUONGLD_ID = this.diachiLD.PHUONG_ID
      pdata.PHOLD_ID = this.diachiLD.PHO_ID
      pdata.APLD_ID = this.diachiLD.AP_ID
      pdata.KHULD_ID = this.diachiLD.KHU_ID
      pdata.DACDIEM_ID = this.diachiLD.DACDIEM_ID
      let api = cache.getters.getFromCache('post_fn_lay_tt_giaodien_dvi', pdata)
      if (!api) api = API.post_fn_lay_tt_giaodien_dvi(this.axios, { ds_para: JSON.stringify(pdata) })
      else
        api = new Promise((resolve, reject) => {
          resolve(api)
        })
      //await API.post_fn_lay_tt_giaodien_dvi(this.axios,{"ds_para":JSON.stringify(pdata)}).then(
      await api.then((response) => {
        cache.dispatch('addToCache', { key: 'post_fn_lay_tt_giaodien_dvi', subkey: pdata, data: response })
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let dulieuapi = JSON.parse(response.data.data)
          if (dulieuapi['ERROR_CODE'] != 1) {
            this.$toast.error(dulieuapi['MESSAGE'])
            return
          }
          if (dulieuapi['RESULT']['DAIVT_ID']) this.listbox.donvi_ql.value = dulieuapi['RESULT']['DAIVT_ID']
          if (dulieuapi['RESULT']['DT_CONTROLS']) this.DT_CONTROLS.list = dulieuapi['RESULT']['DT_CONTROLS']
          if (dulieuapi['RESULT']['DS_DATA']) this.DT_CONTROLS.data = dulieuapi['RESULT']['DS_DATA']
          // if(dulieuapi['RESULT']['DS_GT_DVI']) this.DT_CONTROLS.value = dulieuapi['RESULT']['DS_GT_DVI'];

          let dsValues = dulieuapi['RESULT']['DS_GT_DVI']
          for (var i = 0; i < this.DT_CONTROLS.data.length; i++) {
            if (!this.DT_CONTROLS.value[i] && dsValues && dsValues[i]) this.DT_CONTROLS.value[i] = dsValues[i]
            if (this.DT_CONTROLS.data[i] && this.DT_CONTROLS.data[i].length > 0) {
              if (!this.DT_CONTROLS.value[i] || this.DT_CONTROLS.tagvalue[i] != (this.DT_CONTROLS.data[i][0].LOAIDV_ID ? this.DT_CONTROLS.data[i][0].LOAIDV_ID : this.DT_CONTROLS.list[i].LOAIDV_DICH_ID)) this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0].DONVI_ID
              this.DT_CONTROLS.tagvalue[i] = this.DT_CONTROLS.data[i][0].LOAIDV_ID ? this.DT_CONTROLS.data[i][0].LOAIDV_ID : this.DT_CONTROLS.list[i].LOAIDV_DICH_ID
            }
            if (this.kiemtra_nhanvien_vti == 1 && this.DT_CONTROLS.data[i] && (this.DT_CONTROLS.data[i][0]["loaidv_dich_id".toUpperCase()] == LOAI_DV.TTKD_NGHIEMTHU
                || this.DT_CONTROLS.data[i][0]["loaidv_dich_id".toUpperCase()] == LOAI_DV.HOANTHIEN_HOSO))
                this.DT_CONTROLS.value[i] = 35133;//Phòng Khách hàng doanh nghiệp quốc tê
          }
          // for(var i=0;i<this.DT_CONTROLS.data.length; i++) {
          //   if(this.DT_CONTROLS.data[i] && this.DT_CONTROLS.data[i].length>0 && !this.DT_CONTROLS.value[i]) {
          //     this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0].DONVI_ID;
          //     this.DT_CONTROLS.tagvalue[i] = this.DT_CONTROLS.data[i][0].LOAIDV_ID;
          //   }
          // }
          this.DT_CONTROLS.dichvu_vt = this.listbox.dichvu_vt.value
          this.DT_CONTROLS.key += 1
        }
      })
      // }
      //TODO doan con lai co ve khong lam gi hon ngoai gan gia tri mac dinh (DS_GT_DVI), do do khong can thuc hien gi them.
      await this.LAY_DONVI_THEO_LOAIDV_DIACHI_LD_V2()
      if (this.diachiLD.PHUONG_ID && this.diachiLD.PHUONG_ID > 0) {
        pdata = { donvi_ql_id: this.listbox.donvi_ql.value, loaidv_id: LOAI_DV.TRAM_VT }
        let api = cache.getters.getFromCache('post_sp_lay_ds_tram_thicong_theo_donvi', pdata)
        if (!api) api = API.post_sp_lay_ds_tram_thicong_theo_donvi(this.axios, pdata)
        else
          api = new Promise((resolve, reject) => {
            resolve(api)
          })
        // await API.post_sp_lay_ds_tram_thicong_theo_donvi(this.axios, pdata).then(
        await api.then((response) => {
          cache.dispatch('addToCache', { key: 'post_sp_lay_ds_tram_thicong_theo_donvi', subkey: pdata, data: response })
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
              if (this.DT_CONTROLS.list[i].LOAIDV_DICH_ID == LOAI_DV.TRAM_VT || this.DT_CONTROLS.list[i].LOAIDV_DICH_ID == LOAI_DV.TRAM_CAP_PORT) {
                this.DT_CONTROLS.data[i] = this.UpperCasePropertyList(response.data.data).filter((x) => x.DONVI_ID > 0)

                if (this.DT_CONTROLS.data[i] && this.DT_CONTROLS.data[i].length > 0) {
                  let fdata = this.DT_CONTROLS.data[i].filter((x) => x.DONVI_ID == this.DT_CONTROLS.value[i] && x.DONVI_ID > 0)
                  if (fdata && fdata.length > 0) this.DT_CONTROLS.value[i] = fdata[0]['DONVI_ID'] ? fdata[0]['DONVI_ID'] : fdata[1] ? fdata[1]['DONVI_ID'] : 0
                  else this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0]['DONVI_ID'] ? this.DT_CONTROLS.data[i][0]['DONVI_ID'] : 0
                  this.DT_CONTROLS.key += 1
                }
              }
              if (this.DT_CONTROLS.list[i].LOAIDV_DICH_ID == LOAI_DV.TTKD_NGHIEMTHU) this.DT_CONTROLS.value[i] = this.$root.token.getDonViID()
            }
          }
        })
      }
      this.ReloadTramThiCong()
    },
    async TaoDuLieu_HDTB(themmoi) {
      // #region HD_THUEBAO_DATA
      this.dsHDTB = []

      let rowHDTB = {}
      this.ma_tb_ht = this.thuebao.codinh.somay
      await this.LayMaTB(false) // Xu ly lai this.ma_tb_ht
      let ds_chitiet_km = []
      let thuebao_id = this.thuebao.thuebao_id //TODO tim xem lam the nao de lay duoc ID nay
      let STATUS_TONGDAI_CD = false
      if (themmoi) {
        // let pdata = {
        //   kieuLdId: this.listbox.kieu_ld.value,
        //   loaiHdId: themmoi ? LoaiHopDong.DAT_MOI : '1',
        //   loaiTbId: this.listbox.loaihinh_tb.value,
        //   mucCuocId: this.muccuoctn_id ? this.muccuoctn_id : 0, //(this.listbox.muccuoc.value && this.listbox.muccuoc.value>0)?this.listbox.muccuoc.value:-1,
        //   tocDoId: 0 //this.tocdo_id?this.tocdo_id:-1
        // }

        // this.huonggiao_tn = 0
        // this.quytrinh_tn = 0
        // this.luong_id = 0
        // await API.post_lay_huonggiao_tiepnhan(this.axios, pdata).then((response) => {
        //   if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
        //     let dulieuapi = response.data.data
        //     if (dulieuapi['huonggiao_id']) this.huonggiao_tn = dulieuapi['huonggiao_id']
        //     if (dulieuapi['quytrinh_id']) this.quytrinh_tn = dulieuapi['quytrinh_id']
        //     if (dulieuapi['luong_id']) this.luong_id = dulieuapi['luong_id']
        //   }
        // })
        if ((this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) && (!this.thuebao.tsl.txtMaTSL.Text || this.thuebao.tsl.txtMaTSL.Text.trim().length == 0)) {
          await this.SinhMaDVVT()
        }

        if (
          this.thamsomacdinh['TS_SINH_MATB_DOITAC'] == 1 &&
          (this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.IMS_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC)
        ) {
          this.SINH_MATB_DICHVU_DOITAC()
        }
      }
      await API.post_fn_lay_tt_taodl_hdtb(this.axios, {
        kieu: 1,
        ds_para: JSON.stringify({ THEMMOI: themmoi, MA_TB_HT: this.ma_tb_ht, MUCUOCTB_ID: this.listbox.muccuoc_tb.value, LUONG_ID: this.luong_id, CODE: 'STATUS_TONGDAI_CD', DS_CHITIETKM_ID: ds_chitiet_km && ds_chitiet_km.length > 0 ? ds_chitiet_km : null, KIEULD_ID: this.listbox.kieu_ld.value })
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let dulieuapi = JSON.parse(response.data.data)
          if (dulieuapi && dulieuapi['ERROR_CODE'] == 1) {
            if (dulieuapi['RESULT']) dulieuapi = dulieuapi['RESULT']
            if (dulieuapi['HDTB_ID']) {
              rowHDTB.HDTB_ID = dulieuapi['HDTB_ID']
              this.hdtb_id = dulieuapi['HDTB_ID']
            }
            if (dulieuapi['MUCUOC_TB']) rowHDTB.MUCUOC_TB = dulieuapi['MUCUOC_TB']
            if (dulieuapi['DS_CTKM_LTBI']) {
              rowHDTB.DS_CTKM_LTBI = dulieuapi['DS_CTKM_LTBI']
              this.DS_CTKM_LTBI = rowHDTB.DS_CTKM_LTBI
            }
            if (dulieuapi['STATUS']) STATUS_TONGDAI_CD = true
            if (dulieuapi['THUEBAO_ID']) thuebao_id = dulieuapi['THUEBAO_ID']
          }
          else throw dulieuapi['MESSAGE'];
        }
        else throw `Lỗi tạo dữ liệu HDTB ${response.data.message}: ${response.data.message_detail}`;
      })
      if ((!rowHDTB.HDTB_ID || rowHDTB.HDTB_ID == 0) && this.hdtb_id && this.hdtb_id > 0) rowHDTB.HDTB_ID = this.hdtb_id
      if(!rowHDTB.HDTB_ID) throw "Lỗi sinh dữ liệu HDTB_ID. Vui lòng xem lại."
      if (themmoi) rowHDTB.HDTT_ID = this.hdtt_id
      else rowHDTB.HDTT_ID = this.listbox.thanhtoancbo.value && this.listbox.thanhtoancbo.value > 0 ? this.listbox.thanhtoancbo.value : this.hdtt_id
      rowHDTB.HDKH_ID = this.khachhang.hdkh_id

      if (thuebao_id > 0) rowHDTB.THUEBAO_ID = thuebao_id

      // await this.LayMaTB(false); //Goi truoc o phia tren de xu ly cac API can dung toi o tren.
      rowHDTB.MA_TB = this.ma_tb_ht ? this.ma_tb_ht.toLowerCase().trim() : null
      if (this.listbox.kieu_ld.value == KieuLapDat.DM_DIDONG_C_P) {
        // vuth update 26/12 set thuebao_id
        if (thuebao_id > 0) rowHDTB.THUEBAO_ID = thuebao_id
      }

      if ((this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B) && this.thamsomacdinh['MYTV_HOA'] == 1) rowHDTB.MA_TB = this.ma_tb_ht ? this.ma_tb_ht.toUpperCase().trim() : null
      if ((this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.dichvu_vt.value == DichVuVienThong.HATANG_VIENTHONG) && this.thamsomacdinh['FIBER_HOA'] == 1) rowHDTB.MA_TB = this.ma_tb_ht ? this.ma_tb_ht.toUpperCase().trim() : null

      if ((this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) && this.thamsomacdinh['MGW_MTN_KTR_HOA'] == 1)
        rowHDTB.MA_TB = this.ma_tb_ht ? this.ma_tb_ht.toUpperCase().trim() : null

      if (
        (this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT || this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT || this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU || this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH) &&
        this.thamsomacdinh['CNTT_HOA'] == 1
      )
        rowHDTB.MA_TB = this.ma_tb_ht ? this.ma_tb_ht.toUpperCase().trim() : null

      if (
        (this.listbox.dichvu_vt.value == DichVuVienThong.IMS_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC) &&
        this.thamsomacdinh['DICHVU_DOITAC_HOA'] == 1
      )
        rowHDTB.MA_TB = this.ma_tb_ht ? this.ma_tb_ht.toUpperCase().trim() : null
      if (!rowHDTB.MA_TB) {
        // this.$toast.error("Mã thuê bao / số máy / account không được phép để trống!");
        throw 'Lỗi: Mã thuê bao / số máy / account không được phép để trống!'
      }
      rowHDTB.TEN_TB = this.thuebao.tentb ? this.thuebao.tentb.trim() : null
      rowHDTB.DIACHI_TB = this.diachiTB.DIACHI
      rowHDTB.GHICHU = this.thuebao.ghichu
      rowHDTB.KIEULD_ID = this.listbox.kieu_ld.value
      rowHDTB.LOAITB_ID = this.listbox.loaihinh_tb.value
      rowHDTB.DOITUONG_ID = this.listbox.doituong.value
      rowHDTB.DONVI_ID = this.listbox.donvi_ql.value
      rowHDTB.TTHD_ID = TrangThaiHD.MOI
      rowHDTB.DICHVUVT_ID = this.listbox.dichvu_vt.value
      if (this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG) rowHDTB.NGAY_HT = this.NgayYeuCau //dtpNgayYeuCau.Value;
      rowHDTB.KIEU_TB = '0' //Kiểu thuê bao thường.

      rowHDTB.NGUOI_CN = this.$root.token.getUserName()
      rowHDTB.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
      rowHDTB.MAY_CN = null
      rowHDTB.IP_CN = null

      rowHDTB.CHUYENMANG = this.listbox.nhacc_cu.ischecked ? 1 : 0
      if (this.listbox.nhacc_cu.ischecked) {
        if (this.listbox.nhacc_cu.value && this.listbox.nhacc_cu.value > 0) rowHDTB.NHACC_CU_ID = this.listbox.nhacc_cu.value
        if (this.listbox.hinhthuc_cm.value && this.listbox.hinhthuc_cm.value > 0) rowHDTB.HTCM_ID = this.listbox.hinhthuc_cm.value
      }
      //TODO tim xem load phan TBHD_PL nhu the nao???
      rowHDTB.TBHD_PL = this.thuebao.tbhd_pl ? this.thuebao.tbhd_pl : 1 //TBHD_PL; // Tuan them truong TBHD_PL cho thue bao --> 1 <-> In HD; 0 <-> In PL --- Ngay 24/08/2010
      rowHDTB.DIACHI_LD = this.diachiLD.DIACHI
      if (this.NgaySinhTB) rowHDTB.NGAY_SN = this.NgaySinhTB

      if (this.listbox.muccuoc_tb.value > 0 && this.listbox.kieu_ld.value != 13224) {
        // tổng rà soát 12.2020 duongpd
        rowHDTB.MUCUOCTB_ID = this.listbox.muccuoc_tb.value
        //rowHDTB.MUCUOC_TB da lay o phia tren
        //rowHDTB.MUCUOC_TB = objCheckData.MAP_ID("cuoc_tb", DatabaseConstants.DB2 + ".muccuoc_tb", "where mucuoctb_id = " + Convert.ToInt32(cboMucCuocTB.SelectedValue)));
      }
      if (this.listbox.kieu_ld.value == 13224) {
        rowHDTB.MUCUOCTB_ID = 20000 // mức cước tổng rà soát
        rowHDTB.MUCUOC_TB = 1
      }
      if (
        rowHDTB.DICHVUVT_ID == DichVuVienThong.DI_DONG ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.ADSL ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.IMS ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.DICHVU_CNTT ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.ANTOAN_BAOMAT_TT ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.HOINGHI_TRUYENHINH ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.TRUNGTAM_DULIEU ||
        rowHDTB.DICHVUVT_ID == DichVuVienThong.HATANG_VIENTHONG
      ) {
        if (
          rowHDTB.LOAITB_ID != LoaiHinhTB.INTERNET_MYTV &&
          rowHDTB.LOAITB_ID != LoaiHinhTB.HTVC_FIBERVNN_ANALOG &&
          rowHDTB.LOAITB_ID != LoaiHinhTB.HTVC_FIBERVNN_DIGITAL &&
          rowHDTB.DICHVUVT_ID != DichVuVienThong.DICHVU_CNTT &&
          rowHDTB.DICHVUVT_ID != DichVuVienThong.ANTOAN_BAOMAT_TT &&
          rowHDTB.DICHVUVT_ID != DichVuVienThong.TRUNGTAM_DULIEU &&
          rowHDTB.DICHVUVT_ID != DichVuVienThong.HOINGHI_TRUYENHINH &&
          rowHDTB.DICHVUVT_ID != DichVuVienThong.HATANG_VIENTHONG &&
          rowHDTB.DICHVUVT_ID != DichVuVienThong.IMS
        )
          //Xet doi voi thue bao di dong tra sau hoac adsl, ftth
          rowHDTB.STATUS = themmoi ? '0' : this.txtStatus
        //BUG cho nay chua xu ly//themmoi ? "0" : txtStatus.Text; //HungHM - trạng thái đồng bộ
        else rowHDTB.STATUS = '0' //Doi voi thue bao mytv, IMS
      }

      if (rowHDTB.DICHVUVT_ID == DichVuVienThong.BRCD_DOITAC) rowHDTB.STATUS = '0'

      if (rowHDTB.DICHVUVT_ID == DichVuVienThong.GPHONE) rowHDTB.STATUS = '1'

      if (rowHDTB.DICHVUVT_ID == DichVuVienThong.CO_DINH) {
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.PABX || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN2B_CD || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN2B_CQ || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN30B_CD || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN30B_CQ) {
          if (this.thuebao.loaisochinh == 1) {
            if (this.thuebao.thuebao_id_cha != 0) rowHDTB.THUEBAO_CHA_ID = this.thuebao.thuebao_id_cha
          } else if (this.thuebao.hdtb_id_cha != 0) rowHDTB.HDTB_CHA_ID = this.thuebao.hdtb_id_cha
        } else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.TRUNGKE_THUONG || this.listbox.loaihinh_tb.value == LoaiHinhTB.TRUNGKE_TUONGTU || this.listbox.loaihinh_tb.value == LoaiHinhTB.TRUNGKE_2M) {
          if (this.thuebao.loaisochinh == 1) {
            if (this.thuebao.thuebao_id_cha != 0) rowHDTB.THUEBAO_CHA_ID = this.thuebao.thuebao_id_cha
          } else if (this.thuebao.hdtb_id_cha != 0) rowHDTB.HDTB_CHA_ID = this.thuebao.hdtb_id_cha
        }
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
        if (this.thuebao.loaisochinh == 1) {
          if (this.thuebao.thuebao_id_cha != 0) rowHDTB.THUEBAO_CHA_ID = this.thuebao.thuebao_id_cha
        } else {
          if (this.thuebao.hdtb_id_cha != 0) rowHDTB.HDTB_CHA_ID = this.thuebao.hdtb_id_cha
        }
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.IMS && this.listbox.loaihinh_tb.value == LoaiHinhTB.IMS_SIPTRUNKING) {
        if (this.thuebao.ims.cbkTrunk) {
          //DataTable dt = (DataTable)cboTrunk.Properties.DataSource;
          if (this.thuebao.ims.cboTrunk.value && this.thuebao.ims.cboTrunk.value != 0) {
            //string loai = dt.Select("id = " + cboTrunk.EditValue)[0]["loai"];
            let loai = this.thuebao.ims.cboTrunk.list.filter((x) => x.id == this.thuebao.ims.cboTrunk.value)[0]['loai']
            if (loai == '1') rowHDTB.HDTB_CHA_ID = this.thuebao.ims.cboTrunk.value
            if (loai == '2') rowHDTB.THUEBAO_CHA_ID = this.thuebao.ims.cboTrunk.value
          }
        }
      }

      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
        if (this.thuebao.adsl.isHopDong == 1) {
          if (this.listbox.cboHDChinh.value) rowHDTB.HDTB_CHA_ID = this.listbox.cboHDChinh.value
        } else if (this.thuebao.adsl.isHopDong == 0) {
          if (this.listbox.cboDbChinh.value) rowHDTB.THUEBAO_CHA_ID = this.listbox.cboDbChinh.value
        }
      }

      if (STATUS_TONGDAI_CD) rowHDTB.STATUS = '0'

      //HungHM - 06/09/2010 thêm dvql đầu + cuối
      rowHDTB.DONVI_DAU_ID = this.thuebao.tsl.donvi_dau_id //this.listbox.donvi_dau.value;
      rowHDTB.DONVI_CUOI_ID = this.thuebao.tsl.donvi_cuoi_id //this.listbox.donvi_cuoi.value;

      if (this.kt_thuenganhan) {
        rowHDTB.TG_THUE_TU = this.TGThueTuNgay ? this.TGThueTuNgay : null
        rowHDTB.TG_THUE_DEN = this.TGThueDenNgay ? this.TGThueDenNgay : null
      } else {
        rowHDTB.TG_THUE_TU = null
        rowHDTB.TG_THUE_DEN = null
      }
      rowHDTB.QUYTRINH_ID = this.quytrinh_tn
      if (this.listbox.goi_kt.value > 0) {
        rowHDTB.GOIKT_ID = this.listbox.goi_kt.value
      }
      if (this.thuebao.thangck > 0) rowHDTB.SOTHANG_CK = this.thuebao.thangck

      if (this.thuebao.doituong_ct_id != 0) rowHDTB.DOITUONG_CT_ID = this.thuebao.doituong_ct_id
      //VinhPV thêm lựa chọn trạng thái yêu cầu (KH xây/sửa nhà) 27/02/2019
      if (this.listbox.trangthai_yc.value > 0) {
        //(CAPNHAT_TRANGTHAI_YEUCAU)
        rowHDTB.TRANGTHAIYC_ID = this.listbox.trangthai_yc.value //Convert.ToInt32(cboTrangThaiYC.SelectedValue);
      } else rowHDTB.TRANGTHAIYC_ID = 1
      this.dsHDTB.push(rowHDTB)
      // if (themmoi == false)
      // {
      //     dsHDTB.AcceptChanges();
      //     dsHDTB.HD_THUEBAO.Rows[0].SetModified();
      // }
      // #endregion
      // TODO Chua ro nghiep vu phan cuoi nay, xu ly sau.
      // //tien tra gop luu 1 lan thoi
      let blKiemTraTraGop = false
      // //longdx: bo sung thong tin hdtb_id vao bang khuyenmai, dat coc
      for (let row of this.dsDC_HDTB) {
        row.HDTB_ID = this.hdtb_id
        row.TIEN_TG = this.TongTien_TG(row.CHITIETKM_ID)
        if (row.TIEN_TG > 0) blKiemTraTraGop = true
      }
      for (let row of this.dsKM_HDTB) {
        row.HDTB_ID = this.hdtb_id
        if (!blKiemTraTraGop) row.TIEN_TG = this.TongTien_TG(row.CHITIETKM_ID)
      }
      for (let row of this.dsTRAGOP_TBI_HDTB) {
        row.HDTB_ID = this.hdtb_id
      }
    },
    TaoDuLieu_HDTB_DUNGTHU() {
      this.dsHDTB_DUNGTHU = []
      let rowHDTB = {}
      rowHDTB.HDTB_ID = this.hdtb_id
      rowHDTB.SONGAY = this.thuebao.tgdungthu
      //TODO dung thu cac dich vu khong phai co dinh, chua xay dung
      rowHDTB.NGUOI_CN = this.$root.token.getUserName()
      rowHDTB.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
      rowHDTB.MAY_CN = null
      rowHDTB.IP_CN = null
      this.dsHDTB_DUNGTHU.push(rowHDTB)
    },
    TaoDuLieu_HDTT_NV(themmoi) {
      //TODO can xem cach load nhanvien_ql_am_id
      this.dsHDTT_NV = []
      if (this.nhanvien_ql_am_id != 0) {
        let rowhdtt_nv = {}
        rowhdtt_nv.HDTT_ID = this.hdtt_id
        rowhdtt_nv.NHANVIEN_ID = this.nhanvien_ql_am_id
        rowhdtt_nv.MAY_CN = null
        rowhdtt_nv.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
        rowhdtt_nv.NGUOI_CN = this.$root.token.getUserName()
        this.dsHDTT_NV.push(rowhdtt_nv)
      }
    },
    TaoDuLieu_THONGTIN_TT(themmoi) {
      //Khong co code, 100% comment
    },
    async TaoDuLieu_CT_TIENHD(themmoi) {
      this.dsCTTHD = []
      let rowCTTHD = {}
      var daxuly_dsCTM_TBI = false;
      //this.listbox.tien_km.list = this.ds_tien_khoanmuc.Tables[0] (load o khi load form)
      for (var km of this.ds_tien_khoanmuc) {
        if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_MUATHIETBI || km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_THUETHIETBI || km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_PHI_THUMOTLAN) {
          if(!daxuly_dsCTM_TBI) daxuly_dsCTM_TBI = true;
          else continue;
          for (let tb of this.dsCTM_TBI) {
            let rowCTTHD = {}
            rowCTTHD.HDTB_ID = this.hdtb_id
            if (themmoi) {
              await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                }
              })
            }
            if (this.dskmtt_loaitbi.find((x) => x.khoanmuctt_id == KHOANMUC_TT.KMTT_THUETHIETBI && x.loaitbi_id == tb['loaitbi_id'])) rowCTTHD.KHOANMUCTT_ID = KHOANMUC_TT.KMTT_THUETHIETBI
            else if (this.dskmtt_loaitbi.find((x) => x.khoanmuctt_id == KHOANMUC_TT.KMTT_PHI_THUMOTLAN && x.loaitbi_id == tb['loaitbi_id'])) rowCTTHD.KHOANMUCTT_ID = KHOANMUC_TT.KMTT_PHI_THUMOTLAN
            else rowCTTHD.KHOANMUCTT_ID = KHOANMUC_TT.KMTT_MUATHIETBI
            let tien = 0
            let vat = 0
            let soluong = 1
            if (tb['soluong']) soluong = tb['soluong']
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IOFFICE || this.listbox.loaihinh_tb.value == LoaiHinhTB.HNTH_NGN || this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING) {
              if (tb['sl_cha'] && tb['sl_cha'] != 0) {
                h_sl_cha = tb['sl_cha']
                h_block_dau = tb['block_dau']
                h_block_tiep = tb['block_tiep']
                h_gia_block = tb['gia_block_tiep']
                h_vat_block = tb['vat_block_tiep']
                h_sl_conlai = 0

                if (h_sl_cha >= h_block_dau) {
                  h_sl_conlai = h_sl_cha - h_block_dau

                  let t2 = h_sl_conlai % h_block_tiep
                  h_sl_bl = 0
                  if (t2 > 0) h_sl_bl = h_sl_conlai / tb['block_tiep'] + 1
                  else h_sl_bl = h_sl_conlai / tb['block_tiep']

                  let tien_block = 0
                  let vat_block = 0

                  tien_block = h_sl_bl * tb['gia_block_tiep']
                  vat_block = h_sl_bl * tb['vat_block_tiep']
                  tien = (tb['tien'] + tien_block) * soluong
                  vat = (tb['vat'] + vat_block) * soluong
                }
              } else {
                tien = tb['tien'] * soluong
                vat = tb['vat'] * soluong
              }
            } else {
              tien = tb['tien'] * soluong
              vat = tb['vat'] * soluong
            }
            rowCTTHD.TIEN = tien ? tien * 1 : 0
            rowCTTHD.VAT = vat ? vat * 1 : 0
            rowCTTHD.ID = tb['loaitbi_id']
            rowCTTHD.LOAI_ID = 3
            rowCTTHD.TYLE_VAT = tb['tyle_vat']
            rowCTTHD.TYLE_VAT_ID = tb['tyle_vat_id']
            this.dsCTTHD.push(rowCTTHD)
          }
        } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI) {
          for (let tb of this.dsCTM_TBI) {
            // TODO dsCTM_TBI lay o danh sach mua thiet bi (nut)
            let rowCTTHD = {}
            rowCTTHD.HDTB_ID = this.hdtb_id
            if (themmoi) {
              await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                }
              })
            }
            rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']
            let tien
            let vat
            let soluong = 1
            soluong = tb['soluong']

            tien = tb['tien_km'] * soluong
            vat = tb['vat_km'] * soluong

            rowCTTHD.TIEN = tien && Math.abs(tien) ? Math.abs(tien) * -1 : 0
            rowCTTHD.VAT = vat && Math.abs(vat) ? Math.abs(vat) * -1 : 0
            rowCTTHD.ID = tb['loaitbi_id']
            rowCTTHD.LOAI_ID = 3
            rowCTTHD.TYLE_VAT = tb['tyle_vat']
            rowCTTHD.TYLE_VAT_ID = tb['tyle_vat_id']
            this.dsCTTHD.push(rowCTTHD)
          }
        } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_TRATRUOC_THIETBI) {
          for (let tb of this.dsCTM_TBI) {
            // TODO dsCTM_TBI lay o danh sach mua thiet bi (nut)
            let rowCTTHD = {}
            rowCTTHD.HDTB_ID = this.hdtb_id
            if (themmoi) {
              await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                }
              })
            }
            rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']
            let tien
            let vat
            let soluong = 1
            soluong = tb['soluong']

            tien = tb['tien_tratruoc'] * soluong
            vat = tb['vat_tratruoc'] * soluong

            rowCTTHD.TIEN = tien ? tien * 1 : 0
            rowCTTHD.VAT = vat ? vat * 1 : 0
            rowCTTHD.ID = tb['loaitbi_id']
            rowCTTHD.LOAI_ID = 3
            rowCTTHD.TYLE_VAT = tb['tyle_vat']
            rowCTTHD.TYLE_VAT_ID = tb['tyle_vat_id']
            this.dsCTTHD.push(rowCTTHD)
          }
        } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DICHVU) {
          for (let dv of this.m_dsThueBao_DichVu) {
            // TODO m_dsThueBao_DichVu lay o danh sach dich vu gia tang (nut btnEditDVGT)
            if (dv['dangky'] == 1 && dv['huy'] == 0) {
              let rowCTTHD = {}
              rowCTTHD.HDTB_ID = this.hdtb_id
              if (themmoi) {
                await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                  }
                })
              }
              rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']
              let tien = 0
              let vat = 0

              tien = dv['cuoc_ld']
              vat = dv['vat_ld']

              rowCTTHD.TIEN = tien ? tien * 1 : 0
              rowCTTHD.VAT = vat ? vat * 1 : 0
              rowCTTHD.ID = dv['dichvugt_id']
              rowCTTHD.LOAI_ID = 2
              rowCTTHD.TYLE_VAT = dv['tyle_vat']
              rowCTTHD.TYLE_VAT_ID = dv['tyle_vat_id']
              this.dsCTTHD.push(rowCTTHD)
            }
          }
        } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DVGT) {
          for (let dv of this.m_dsThueBao_DichVu) {
            // TODO m_dsThueBao_DichVu lay o danh sach dich vu gia tang (nut btnEditDVGT)
            if (dv['dangky'] == 1 && dv['huy'] == 0) {
              let tien = 0
              let vat = 0

              tien = dv['cuoc_kmld']
              vat = dv['vat_kmld']
              if (tien != 0 && vat != 0) {
                let rowCTTHD = {}
                rowCTTHD.HDTB_ID = this.hdtb_id
                if (themmoi) {
                  await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                    if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                      rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                    }
                  })
                }
                rowCTTHD.KHOANMUCTT_ID = KHOANMUC_TT.KMTT_KM_DVGT

                rowCTTHD.TIEN = tien && Math.abs(tien) ? Math.abs(tien) * -1 : 0
                rowCTTHD.VAT = vat && Math.abs(vat) ? Math.abs(vat) * -1 : 0
                rowCTTHD.ID = dv['dichvugt_id']
                rowCTTHD.LOAI_ID = 2
                rowCTTHD.TYLE_VAT = dv['tyle_vat']
                rowCTTHD.TYLE_VAT_ID = dv['tyle_vat_id']
                this.dsCTTHD.push(rowCTTHD)
              }
            }
          }
        } else {
          if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT || km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI || km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DATCOC) {
            let rowCTTHD = {}
            rowCTTHD.HDTB_ID = this.hdtb_id
            if (themmoi) {
              await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                }
              })
            }
            rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']

            if (km['tien'] > 0) {
              rowCTTHD.TIEN = km['tien'] ? km['tien'] * -1 : 0
              rowCTTHD.VAT = km['vat'] ? km['vat'] * -1 : 0
            } else {
              rowCTTHD.TIEN = km['tien'] ? km['tien'] * 1 : 0
              rowCTTHD.VAT = km['vat'] ? km['vat'] * 1 : 0
            }
            rowCTTHD.ID = km['khoanmuctt_id']
            rowCTTHD.LOAI_ID = 1

            rowCTTHD.TYLE_VAT = 10
            rowCTTHD.TYLE_VAT_ID = 1
            this.dsCTTHD.push(rowCTTHD)
          } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC) {
            // #region cuonglt.hpg 24/01/2022 - Đặt cọc
            let codl_ctkm = false
            if (this.m_dsTienCTKM != null && this.m_dsTienCTKM.length > 0) {
              for (let dr of this.m_dsTienCTKM) {
                //1 la KMTT DATCOC
                if ((dr['tien'] != 0 || dr['vat'] != 0) && dr['kieu'] == 1) {
                  rowCTTHD = {}
                  rowCTTHD.HDTB_ID = this.hdtb_id
                  if (themmoi == true) {
                    let CT_TIENHD_ID = await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                      if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                        return response.data.data // 4039
                      }
                    }) //new GetKeyFacade().GetKey("CT_TIENHD");
                    rowCTTHD.CT_TIENHD_ID = CT_TIENHD_ID
                  }
                  rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']

                  rowCTTHD.TIEN = dr['tien'] * 1
                  rowCTTHD.VAT = dr['vat'] * 1
                  rowCTTHD.ID = dr['id'] * 1
                  rowCTTHD.LOAI_ID = 4
                  rowCTTHD.TYLE_VAT = dr['tyle_vat'] * 1
                  rowCTTHD.TYLE_VAT_ID = dr['tyle_vat_id'] * 1

                  // end hoàng

                  this.dsCTTHD.push(rowCTTHD)
                  codl_ctkm = true
                }
              }
            }
            if (!codl_ctkm) {
              if (km['tien'] != 0 || km['vat'] != 0) {
                rowCTTHD = {}
                rowCTTHD.HDTB_ID = this.hdtb_id
                if (themmoi == true) {
                  let CT_TIENHD_ID = await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                    if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                      return response.data.data // 4039
                    }
                  }) //new GetKeyFacade().GetKey("CT_TIENHD");
                  rowCTTHD.CT_TIENHD_ID = CT_TIENHD_ID
                }
                rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']

                rowCTTHD.TIEN = km['tien'] * 1
                rowCTTHD.VAT = km['vat'] * 1
                rowCTTHD.ID = km['khoanmuctt_id'] * 1
                rowCTTHD.LOAI_ID = 1

                // hoangpkn : 20/08/2019. Tạm fix
                if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
                  rowCTTHD.TYLE_VAT = this.vtyle_vat_dnhm
                  rowCTTHD.TYLE_VAT_ID = this.vtyle_vat_id_dnhm
                } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
                  rowCTTHD.TYLE_VAT = this.vtyle_vat_cd
                  rowCTTHD.TYLE_VAT_ID = this.vtyle_vat_id_cd
                } else {
                  rowCTTHD.TYLE_VAT = 10
                  rowCTTHD.TYLE_VAT_ID = 1
                }
                // end hoàng

                this.dsCTTHD.push(rowCTTHD)
              }
            }
            // #endregion
          }
          //#region vuth them tien so dep di dong tra sau
          else if (TRANGTHAI_DONGBO.OPEN_SYNC_VINA_TRASAU && this.listbox.kieu_ld.value == KieuLapDat.DM_DIDONG && km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_SODEP) {
            let dtTienCcbs = await this.LayTienSoDepDDTraSau('84' + this.thuebao.didong.txtSoMayDD.trim())

            let rowCTTHD = {}
            rowCTTHD.HDTB_ID = this.hdtb_id
            if (themmoi)
              await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                }
              })
            rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']

            rowCTTHD.TIEN = dtTienCcbs[0]['tiendv'] ? dtTienCcbs[0]['tiendv'] * 1 : 0
            rowCTTHD.VAT = dtTienCcbs[0]['tiendvvat'] ? dtTienCcbs[0]['tiendvvat'] * 1 : 0
            rowCTTHD.ID = km['khoanmuctt_id']
            rowCTTHD.LOAI_ID = 1

            rowCTTHD.TYLE_VAT = 10
            rowCTTHD.TYLE_VAT_ID = 1

            this.dsCTTHD.push(rowCTTHD)
          }
          //#endregion vuth them tien so dep di dong tra sau
          else {
            // #region cuonglt.hpg 24/01/2022 - Còn lại
            let codl_ctkm = false;
            if (this.m_dsTienCTKM != null && this.m_dsTienCTKM.length > 0)
            {
              for (let dr of this.m_dsTienCTKM)
              {
                  //1 la KMTT DATCOC
                  if ((dr["tien"] != 0 || dr["vat"] != 0) && dr["kieu"] == 2 && dr["khoanmuctt_id"] == km["khoanmuctt_id"])
                  {
                      let rowCTTHD = {};
                      rowCTTHD.HDTB_ID = this.hdtb_id;
                      if (themmoi)
                        await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                            rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                          }
                        })
                      rowCTTHD.KHOANMUCTT_ID = rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id'];

                      rowCTTHD.TIEN = dr["tien"]?dr["tien"]*1:0;
                      rowCTTHD.VAT = dr["vat"]?dr["vat"]*1:0;
                      rowCTTHD.ID = dr["id"];
                      rowCTTHD.LOAI_ID = 1;
                      rowCTTHD.TYLE_VAT = dr["tyle_vat"]*1;
                      rowCTTHD.TYLE_VAT_ID = dr["tyle_vat_id"]*1;

                      // end hoàng

                      this.dsCTTHD.push(rowCTTHD)
                      codl_ctkm = true;
                  }
              }
            }
            if (!codl_ctkm)
            {
                // #region Trường hợp còn lại
                ////Lamnt: Bỏ zem đoạn này do khoản mục = 0 không insert vào ct_tienhd -> không thanh toán được.
                ////11/06/2019
                ////Cuonglt mở lại theo yêu cầu anh Hiếu BABA
                if (km["tien"] != 0 || km["vat"] != 0)
                {
                    let rowCTTHD = {};
                    rowCTTHD.HDTB_ID = this.hdtb_id;
                    if (themmoi)
                      await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                          rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
                        }
                      })
                    rowCTTHD.KHOANMUCTT_ID = rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id'];

                    rowCTTHD.TIEN = km['tien']?km['tien'] * 1:0
                    rowCTTHD.VAT = km['vat']?km['vat'] * 1:0
                    rowCTTHD.ID = km['khoanmuctt_id'] * 1
                    rowCTTHD.LOAI_ID = 1;

                    // hoangpkn : 20/08/2019. Tạm fix

                    if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
                      rowCTTHD.TYLE_VAT = this.vtyle_vat_dnhm
                      rowCTTHD.TYLE_VAT_ID = this.vtyle_vat_id_dnhm
                    } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
                      rowCTTHD.TYLE_VAT = this.vtyle_vat_cd
                      rowCTTHD.TYLE_VAT_ID = this.vtyle_vat_id_cd
                    } else {
                      rowCTTHD.TYLE_VAT = 10
                      rowCTTHD.TYLE_VAT_ID = 1
                    }
                    // end hoàng

                    this.dsCTTHD.push(rowCTTHD)
                }
                // #endregion
            }
            // #endregion

          }
          // else {
          //   ////Lamnt: Bỏ zem đoạn này do khoản mục = 0 không insert vào ct_tienhd -> không thanh toán được.
          //   ////11/06/2019
          //   ////Cuonglt mở lại theo yêu cầu anh Hiếu BABA
          //   if (km['tien'] != 0 || km['vat'] != 0) {
          //     let rowCTTHD = {}
          //     rowCTTHD.HDTB_ID = this.hdtb_id
          //     if (themmoi) {
          //       await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
          //         if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          //           rowCTTHD.CT_TIENHD_ID = response.data.data // 4039
          //         }
          //       })
          //     }
          //     rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']

          //     rowCTTHD.TIEN = km['tien'] ? km['tien'] * 1 : 0
          //     rowCTTHD.VAT = km['vat'] ? km['vat'] * 1 : 0
          //     rowCTTHD.ID = km['khoanmuctt_id']
          //     rowCTTHD.LOAI_ID = 1

          //     // hoangpkn : 20/08/2019. Tạm fix
          //     if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
          //       rowCTTHD.TYLE_VAT = this.vtyle_vat_dnhm
          //       rowCTTHD.TYLE_VAT_ID = this.vtyle_vat_id_dnhm
          //     } else if (km['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
          //       rowCTTHD.TYLE_VAT = this.vtyle_vat_cd
          //       rowCTTHD.TYLE_VAT_ID = this.vtyle_vat_id_cd
          //     } else {
          //       rowCTTHD.TYLE_VAT = 10
          //       rowCTTHD.TYLE_VAT_ID = 1
          //     }
          //     // end hoàng
          //     this.dsCTTHD.push(rowCTTHD)
          //   }
          // }
        }
      }
      if (this.dsCTTHD.length == 0) {
        let rowCTTHD = {}
        rowCTTHD.HDTB_ID = this.hdtb_id
        if (themmoi) {
          await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              rowCTTHD.CT_TIENHD_ID = response.data.data
            }
          })
        }
        // rowCTTHD.KHOANMUCTT_ID = km['khoanmuctt_id']
        rowCTTHD.KHOANMUCTT_ID = 1
        rowCTTHD.TIEN = 0
        rowCTTHD.VAT = 0
        rowCTTHD.ID = 1
        rowCTTHD.LOAI_ID = 1
        this.dsCTTHD.push(rowCTTHD)
      }
    },
    async TaoDuLieu_DiaChi(themmoi, kieu) {
      this.dsDiaChi = []
      this.dsDiaChiHDKH = []
      this.dsDiaChiHDTT = []
      this.dsDiaChiHDTB = []
      let diachikh_id = this.diachikh_id
      if (kieu == 1 || kieu == 4) {
        let rowDiaChiKH = {}

        if (themmoi)
          await API.post_fn_lay_tt_taodl_diachi(this.axios, { ds_para: JSON.stringify({ THEMMOI: themmoi, KIEU: kieu ? kieu : 1, DICHVUVT_ID: this.listbox.dichvu_vt.value }) }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //"data": "{\"ERROR_CODE\":1,\"MESSAGE\":\"Thành công\",\"RESULT\":{\"DIACHIKH_ID\":20025699}}"
              let dulieuapi = JSON.parse(response.data.data)
              if (dulieuapi['RESULT']['DIACHIKH_ID']) diachikh_id = dulieuapi['RESULT']['DIACHIKH_ID']
              if (!this.diachikh_id || this.diachikh_id == 0) this.diachikh_id = diachikh_id
            }
          })
        rowDiaChiKH.DIACHI_ID = diachikh_id
        if (this.diachiKH.TINH_ID && this.diachiKH.TINH_ID != 0) rowDiaChiKH.TINH_ID = this.diachiKH.TINH_ID
        if (this.diachiKH.QUAN_ID && this.diachiKH.QUAN_ID != 0) rowDiaChiKH.QUAN_ID = this.diachiKH.QUAN_ID
        if (this.diachiKH.PHUONG_ID && this.diachiKH.PHUONG_ID != 0) rowDiaChiKH.PHUONG_ID = this.diachiKH.PHUONG_ID
        if (this.diachiKH.PHO_ID && this.diachiKH.PHO_ID != 0) rowDiaChiKH.PHO_ID = this.diachiKH.PHO_ID
        if (this.diachiKH.AP_ID && this.diachiKH.AP_ID != 0) rowDiaChiKH.AP_ID = this.diachiKH.AP_ID
        if (this.diachiKH.KHU_ID && this.diachiKH.KHU_ID != 0) rowDiaChiKH.KHU_ID = this.diachiKH.KHU_ID
        if (this.diachiKH.DACDIEM_ID && this.diachiKH.DACDIEM_ID != 0) rowDiaChiKH.DACDIEM_ID = this.diachiKH.DACDIEM_ID
        rowDiaChiKH.SONHA = this.diachiKH.SONHA ? this.diachiKH.SONHA.trim() : ''

        if (this.diachiKH.BLOCK) rowDiaChiKH.BLOCK = this.diachiKH.BLOCK
        if (this.diachiKH.TANG) rowDiaChiKH.TANG = this.diachiKH.TANG
        if (this.diachiKH.PHONG) rowDiaChiKH.PHONG = this.diachiKH.PHONG
        if (this.diachiKH.MOTA) rowDiaChiKH.MOTA = this.diachiKH.MOTA

        rowDiaChiKH.DIACHI = this.diachiKH.DIACHI ? this.diachiKH.DIACHI.trim() : ''
        rowDiaChiKH.LOAIDC = 'DiaChiKH'
        this.dsDiaChi.push(rowDiaChiKH)

        let rowDiaChiHDKH = {}
        rowDiaChiHDKH.DIACHI_ID = diachikh_id
        rowDiaChiHDKH.HDKH_ID = this.khachhang.hdkh_id
        rowDiaChiHDKH.KINHDO = this.diachiKH.Lng
        rowDiaChiHDKH.VIDO = this.diachiKH.Lat
        this.dsDiaChiHDKH.push(rowDiaChiHDKH)
        //TODO xu ly update (chua lam)
        // if (themmoi == false)
        // {
        //     dsDiaChiHDKH.AcceptChanges();
        //     dsDiaChiHDKH.DIACHI_HDKH.Rows[0].SetModified();
        // }
      }

      if (kieu == 2 || kieu == 4) {
        let rowDiaChiTT = {}
        let rowDiaChiBC = {}
        let diachitt_id = this.diachitt_id
        let diachibc_id = this.diachibc_id

        if (themmoi)
          await API.post_fn_lay_tt_taodl_diachi(this.axios, { ds_para: JSON.stringify({ THEMMOI: themmoi, KIEU: kieu ? kieu : 2, DICHVUVT_ID: this.listbox.dichvu_vt.value }) }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //"data": "{\"ERROR_CODE\":1,\"MESSAGE\":\"Thành công\",\"RESULT\":{\"DIACHIKH_ID\":20025699}}"
              let dulieuapi = JSON.parse(response.data.data)
              diachitt_id = dulieuapi['RESULT']['DIACHITT_ID']
            }
          })
        //DiachiTT
        rowDiaChiTT.DIACHI_ID = diachitt_id
        rowDiaChiTT.TINH_ID = this.diachiTT.TINH_ID
        rowDiaChiTT.QUAN_ID = this.diachiTT.QUAN_ID
        rowDiaChiTT.PHUONG_ID = this.diachiTT.PHUONG_ID
        if (this.diachiTT.PHO_ID && this.diachiTT.PHO_ID != 0) rowDiaChiTT.PHO_ID = this.diachiTT.PHO_ID
        if (this.diachiTT.AP_ID && this.diachiTT.AP_ID != 0) rowDiaChiTT.AP_ID = this.diachiTT.AP_ID
        if (this.diachiTT.KHU_ID && this.diachiTT.KHU_ID != 0) rowDiaChiTT.KHU_ID = this.diachiTT.KHU_ID
        if (this.diachiTT.DACDIEM_ID && this.diachiTT.DACDIEM_ID != 0) rowDiaChiTT.DACDIEM_ID = this.diachiTT.DACDIEM_ID
        rowDiaChiTT.SONHA = this.diachiTT.SONHA ? this.diachiTT.SONHA.trim() : ''

        if (this.diachiTT.BLOCK) rowDiaChiTT.BLOCK = this.diachiTT.BLOCK
        if (this.diachiTT.TANG) rowDiaChiTT.TANG = this.diachiTT.TANG
        if (this.diachiTT.PHONG) rowDiaChiTT.PHONG = this.diachiTT.PHONG
        if (this.diachiTT.MOTA) rowDiaChiTT.MOTA = this.diachiTT.MOTA

        rowDiaChiTT.DIACHI = this.diachiTT.DIACHI ? this.diachiTT.DIACHI.trim() : ''
        rowDiaChiTT.LOAIDC = 'DiaChiTT'
        this.dsDiaChi.push(rowDiaChiTT)
        //if (themmoi)
        //{
        let rowDiaChiHDTT = {}
        rowDiaChiHDTT.DIACHI_ID = diachitt_id
        rowDiaChiHDTT.DIACHIBC_ID = diachibc_id //TODO can xem lai cach load diachibc_id
        rowDiaChiHDTT.HDTT_ID = this.hdtt_id
        rowDiaChiHDTT.KINHDO = this.diachiTT.Lng
        rowDiaChiHDTT.VIDO = this.diachiTT.Lat
        rowDiaChiHDTT.KINHDO_BC = this.diachiBC.Lng
        rowDiaChiHDTT.VIDO_BC = this.diachiBC.Lat
        this.dsDiaChiHDTT.push(rowDiaChiHDTT)
        //TODO cap nhat du lieu (chua lam)
        // if (themmoi == false)
        // {
        //     dsDiaChiHDTT.AcceptChanges();
        //     dsDiaChiHDTT.DIACHI_HDTT.Rows[0].SetModified();
        // }
      }

      if (kieu == 3 || kieu == 4) {
        //Create by Hiếu  - 14/7/2010 - Địa chỉ lắp đặt & địa chỉ thuê bao
        let rowDiaChiTB = {}
        let rowDiachiLD = {}
        let diachitb_id = this.diachitb_id
        let diachild_id = this.diachild_id
        if (themmoi) {
          // await API.post_fn_lay_tt_taodl_diachi(this.axios, {"ds_para":JSON.stringify({"THEMMOI":themmoi,"KIEU":kieu?kieu:2,"DICHVUVT_ID":this.listbox.dichvu_vt.value})}).then((response) => {
          //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          //     //"data": "{\"ERROR_CODE\":1,\"MESSAGE\":\"Thành công\",\"RESULT\":{\"DIACHIKH_ID\":20025699}}"
          //     let dulieuapi = JSON.parse(response.data.data);
          //     diachitb_id = dulieuapi['RESULT']['DIACHIKH_ID']
          //   }
          // });
          await API.post_fn_lay_tt_taodl_diachi(this.axios, { ds_para: JSON.stringify({ THEMMOI: themmoi, KIEU: kieu ? kieu : 2, DICHVUVT_ID: this.listbox.dichvu_vt.value }) }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //"data": "{\"ERROR_CODE\":1,\"MESSAGE\":\"Thành công\",\"RESULT\":{\"DIACHIKH_ID\":20025699}}"
              let dulieuapi = JSON.parse(response.data.data)
              diachild_id = dulieuapi['RESULT']['DIACHILD_ID']
              diachitb_id = dulieuapi['RESULT']['DIACHITB_ID']
              if (dulieuapi['RESULT']['DIACHIDAU_ID']) this.thuebao.tsl.diachidau_id = dulieuapi['RESULT']['DIACHIDAU_ID']
              if (dulieuapi['RESULT']['DIACHICUOI_ID']) this.thuebao.tsl.diachicuoi_id = dulieuapi['RESULT']['DIACHICUOI_ID']
            }
          })
        }
        //Địa chỉ lắp đặt --> dataset dsdiachi
        rowDiachiLD.DIACHI_ID = diachild_id
        rowDiachiLD.TINH_ID = this.diachiLD.TINH_ID
        rowDiachiLD.QUAN_ID = this.diachiLD.QUAN_ID
        rowDiachiLD.PHUONG_ID = this.diachiLD.PHUONG_ID
        if (this.diachiLD.PHO_ID && this.diachiLD.PHO_ID != 0) rowDiachiLD.PHO_ID = this.diachiLD.PHO_ID
        if (this.diachiLD.AP_ID && this.diachiLD.AP_ID != 0) rowDiachiLD.AP_ID = this.diachiLD.AP_ID
        if (this.diachiLD.KHU_ID && this.diachiLD.KHU_ID != 0) rowDiachiLD.KHU_ID = this.diachiLD.KHU_ID
        if (this.diachiLD.DACDIEM_ID && this.diachiLD.DACDIEM_ID != 0) rowDiachiLD.DACDIEM_ID = this.diachiLD.DACDIEM_ID
        rowDiachiLD.SONHA = this.diachiLD.SONHA ? this.diachiLD.SONHA.trim() : ''
        // Kieun v
        rowDiachiLD.BLOCK = this.diachiLD.BLOCK ? this.diachiLD.BLOCK.trim() : ''
        rowDiachiLD.TANG = this.diachiLD.TANG ? this.diachiLD.TANG.trim() : ''
        rowDiachiLD.PHONG = this.diachiLD.PHONG ? this.diachiLD.PHONG.trim() : ''
        rowDiachiLD.MOTA = this.diachiLD.MOTA ? this.diachiLD.MOTA.trim() : ''

        rowDiachiLD.DIACHI = this.diachiLD.DIACHI ? this.diachiLD.DIACHI.trim() : ''
        rowDiachiLD.LOAIDC = 'DiaChiLD'
        //this.diachiLD = rowDiachiLD //tuanlv thêm // BUG: chua biet tac dung gi, dang gay loi mat du lieu -> bo!
        this.dsDiaChi.push(rowDiachiLD)
        //Địa chỉ thuê bao --> dataset dsdiachi
        rowDiaChiTB.DIACHI_ID = diachitb_id
        rowDiaChiTB.TINH_ID = this.diachiTB.TINH_ID
        rowDiaChiTB.QUAN_ID = this.diachiTB.QUAN_ID
        rowDiaChiTB.PHUONG_ID = this.diachiTB.PHUONG_ID
        if (this.diachiTB.PHO_ID && this.diachiTB.PHO_ID != 0) rowDiaChiTB.PHO_ID = this.diachiTB.PHO_ID
        if (this.diachiTB.AP_ID && this.diachiTB.AP_ID != 0) rowDiaChiTB.AP_ID = this.diachiTB.AP_ID
        if (this.diachiTB.KHU_ID && this.diachiTB.KHU_ID != 0) rowDiaChiTB.KHU_ID = this.diachiTB.KHU_ID
        if (this.diachiTB.DACDIEM_ID && this.diachiTB.DACDIEM_ID != 0) rowDiaChiTB.DACDIEM_ID = this.diachiTB.DACDIEM_ID
        rowDiaChiTB.SONHA = this.diachiTB.SONHA ? this.diachiTB.SONHA.trim() : ''
        // Kieu nv
        rowDiaChiTB.BLOCK = this.diachiTB.BLOCK ? this.diachiTB.BLOCK.trim() : ''
        rowDiaChiTB.TANG = this.diachiTB.TANG ? this.diachiTB.TANG.trim() : ''
        rowDiaChiTB.PHONG = this.diachiTB.PHONG ? this.diachiTB.PHONG.trim() : ''
        rowDiaChiTB.MOTA = this.diachiTB.MOTA ? this.diachiTB.MOTA.trim() : ''

        rowDiaChiTB.DIACHI = this.diachiTB.DIACHI ? this.diachiTB.DIACHI.trim() : ''
        rowDiaChiTB.LOAIDC = 'DiaChiTB'
        this.dsDiaChi.push(rowDiaChiTB)

        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          let rowDiaChiDau = {}
          // if (themmoi)
          //     diachidau_id = new GetKeyFacade().GetKey("DIACHI");
          rowDiaChiDau.DIACHI_ID = this.thuebao.tsl.diachidau_id
          rowDiaChiDau.TINH_ID = this.diachiDau.TINH_ID
          rowDiaChiDau.QUAN_ID = this.diachiDau.QUAN_ID
          rowDiaChiDau.PHUONG_ID = this.diachiDau.PHUONG_ID
          if (this.diachiDau.PHO_ID && this.diachiDau.PHO_ID != 0) rowDiaChiDau.PHO_ID = this.diachiDau.PHO_ID
          if (this.diachiDau.AP_ID && this.diachiDau.AP_ID != 0) rowDiaChiDau.AP_ID = this.diachiDau.AP_ID
          if (this.diachiDau.KHU_ID && this.diachiDau.KHU_ID != 0) rowDiaChiDau.KHU_ID = this.diachiDau.KHU_ID
          rowDiaChiDau.SONHA = this.diachiDau.SONHA

          rowDiaChiDau.BLOCK = this.diachiDau.BLOCK ? this.diachiDau.BLOCK.trim() : ''
          rowDiaChiDau.TANG = this.diachiDau.TANG ? this.diachiDau.TANG.trim() : ''
          rowDiaChiDau.PHONG = this.diachiDau.PHONG ? this.diachiDau.PHONG.trim() : ''
          rowDiaChiDau.MOTA = this.diachiDau.MOTA ? this.diachiDau.MOTA.trim() : ''

          rowDiaChiDau.DIACHI = this.diachiDau.DIACHI
          rowDiaChiDau.LOAIDC = 'DiaChiDau'
          this.dsDiaChi.push(rowDiaChiDau)

          let rowDiaChiCuoi = {}
          // if (themmoi)
          //     diachicuoi_id = new GetKeyFacade().GetKey("DIACHI");
          rowDiaChiCuoi.DIACHI_ID = this.thuebao.tsl.diachicuoi_id
          rowDiaChiCuoi.TINH_ID = this.diachiCuoi.TINH_ID
          rowDiaChiCuoi.QUAN_ID = this.diachiCuoi.QUAN_ID
          rowDiaChiCuoi.PHUONG_ID = this.diachiCuoi.PHUONG_ID
          if (this.diachiCuoi.PHO_ID && this.diachiCuoi.PHO_ID != 0) rowDiaChiCuoi.PHO_ID = this.diachiCuoi.PHO_ID
          if (this.diachiCuoi.AP_ID && this.diachiCuoi.AP_ID != 0) rowDiaChiCuoi.AP_ID = this.diachiCuoi.AP_ID
          if (this.diachiCuoi.KHU_ID && this.diachiCuoi.KHU_ID != 0) rowDiaChiCuoi.KHU_ID = this.diachiCuoi.KHU_ID
          rowDiaChiCuoi.SONHA = this.diachiCuoi.SONHA

          rowDiaChiCuoi.BLOCK = this.diachiCuoi.BLOCK ? this.diachiCuoi.BLOCK.trim() : ''
          rowDiaChiCuoi.TANG = this.diachiCuoi.TANG ? this.diachiCuoi.TANG.trim() : ''
          rowDiaChiCuoi.PHONG = this.diachiCuoi.PHONG ? this.diachiCuoi.PHONG.trim() : ''
          rowDiaChiCuoi.MOTA = this.diachiCuoi.MOTA ? this.diachiCuoi.MOTA.trim() : ''

          rowDiaChiCuoi.DIACHI = this.diachiCuoi.DIACHI
          rowDiaChiCuoi.LOAIDC = 'DiaChiCuoi'
          this.dsDiaChi.push(rowDiaChiCuoi)
        }

        //if (themmoi)
        //{
        let rowDiaChiHDTB = {}
        rowDiaChiHDTB.DIACHI_ID = diachitb_id
        rowDiaChiHDTB.HDTB_ID = this.hdtb_id
        rowDiaChiHDTB.DIACHILD_ID = diachild_id
        rowDiaChiHDTB.KINHDO = this.diachiTB.Lng
        rowDiaChiHDTB.VIDO = this.diachiTB.Lat
        rowDiaChiHDTB.KINHDO_LD = this.diachiLD.Lng
        rowDiaChiHDTB.VIDO_LD = this.diachiLD.Lat
        if(this.diachiLD.LOAINHA_ID) rowDiaChiHDTB.LOAINHA_ID = this.diachiLD.LOAINHA_ID;
        if(this.diachiLD.DIENTICH) rowDiaChiHDTB.DIENTICH = this.diachiLD.DIENTICH;
        if(this.diachiLD.SOTANG) rowDiaChiHDTB.SOTANG = this.diachiLD.SOTANG;
        if(this.diachiLD.SOPHONG) rowDiaChiHDTB.SOPHONG = this.diachiLD.SOPHONG;
        this.dsDiaChiHDTB.push(rowDiaChiHDTB)
        //}
        //TODO update du lieu (chua lam)
        // if (themmoi == false)
        // {
        //     dsDiaChiHDTB.AcceptChanges();
        //     dsDiaChiHDTB.DIACHI_HDTB.Rows[0].SetModified();
        // }
      }
      //TODO update du lieu (chua lam)
      // if (themmoi == false)
      // {
      //     dsDiaChi.AcceptChanges();
      //     if (kieu == 1 || kieu == 2 || kieu == 3)
      //     {
      //         dsDiaChi.DIACHI.Rows[0].SetModified();

      //         if (kieu == 3)
      //         {
      //             dsDiaChi.DIACHI.Rows[1].SetModified();
      //             if (dichvuvt_id == DichVuVienThong.TSL || dichvuvt_id == DichVuVienThong.TSL_DOITAC)
      //             {
      //                 dsDiaChi.DIACHI.Rows[2].SetModified();
      //             }
      //         }
      //     }
      //     else
      //     {
      //         dsDiaChi.DIACHI.Rows[0].SetModified();
      //         dsDiaChi.DIACHI.Rows[1].SetModified();
      //         dsDiaChi.DIACHI.Rows[2].SetModified();
      //         dsDiaChi.DIACHI.Rows[3].SetModified();
      //         if (dichvuvt_id == DichVuVienThong.TSL || dichvuvt_id == DichVuVienThong.TSL_DOITAC)
      //         {
      //             dsDiaChi.DIACHI.Rows[4].SetModified();
      //             dsDiaChi.DIACHI.Rows[5].SetModified();
      //         }
      //     }
      // }
      //end
    },
    TaoDuLieu_DKDV() {
      this.dsDK_DVGT = []
      let kieu_dk_dvgt = 0
      for (let dr of this.m_dsThueBao_DichVu) {
        if (dr['dangky'] == '1') kieu_dk_dvgt = KieuCaiDatDVGT.KIEU_CD_THEM_MOI_DVGT
        else if (dr['huy'] == '1') kieu_dk_dvgt = KieuCaiDatDVGT.KIEU_CD_HUY_DVGT
        else {
          continue
        }

        let rowHDTDDV = {}
        rowHDTDDV.HDTB_ID = this.hdtb_id
        rowHDTDDV.NGAY_YC = this.NgayYeuCau
        rowHDTDDV.DICHVUGT_ID = dr['dichvugt_id']
        rowHDTDDV.NOIDUNG = dr['noidung']
        rowHDTDDV.KIEU_YC = kieu_dk_dvgt
        if (dr['cuoc_sd']) rowHDTDDV.CUOC_SD = dr['cuoc_sd']
        else rowHDTDDV.CUOC_SD = 0
        if (dr['vat_sd']) rowHDTDDV.VAT_SD = dr['vat_sd']
        else rowHDTDDV.VAT_SD = 0

        //if (dr["sl_cha"].trim() != "")
        //    rowHDTDDV.SL_CHA = Convert.ToInt64(dr["sl_cha"]);
        //else
        rowHDTDDV.SL_CHA = 0

        let jsl_cha = 0
        //TODO chua lam vi khong phai phan codinh
        // if (this.loaihinh_tb.value == LoaiHinhTB.IOFFICE || this.loaihinh_tb.value == LoaiHinhTB.VNPT_HIS)
        // {
        //     if (this.loaihinh_tb.value == LoaiHinhTB.VNPT_HIS)
        //     {
        //         let phanloai_his = "";
        //         for (int index_ = 0; index_ < this.gridEditors.Count; ++index_)
        //         {
        //             if (this.gridEditors[index_].ID == "PHANLOAI_ID" && this.gridEditors[index_].Value != "")
        //             {
        //                 phanloai_his = this.gridEditors[index_].Value;
        //                 break;
        //             }
        //         }
        //         if (phanloai_his == "50")
        //         {
        //             for (int index_ = 0; index_ < this.gridEditors.Count; ++index_)
        //             {
        //                 if (this.gridEditors[index_].ID == "TONGSO_ND" && this.gridEditors[index_].Value != "")
        //                 {
        //                     jsl_cha = Convert.ToInt64(this.gridEditors[index_].Value);
        //                     break;
        //                 }
        //             }
        //         }
        //     }
        //     else
        //     {
        //         for (int index_ = 0; index_ < this.gridEditors.Count; ++index_)
        //         {
        //             if (this.gridEditors[index_].ID == "TONGSO_ND" && this.gridEditors[index_].Value != "")
        //             {
        //                 jsl_cha = Convert.ToInt64(this.gridEditors[index_].Value);
        //                 break;
        //             }
        //         }
        //     }

        // }
        // if (this.loaihinh_tb.value == LoaiHinhTB.HNTH_NGN || this.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING)
        // {
        //     for (int index_ = 0; index_ < this.gridEditors.Count; ++index_)
        //     {
        //         if (this.gridEditors[index_].ID == "SL_MAILING" && this.gridEditors[index_].Value != "")
        //         {
        //             jsl_cha = Convert.ToInt64(this.gridEditors[index_].Value);
        //             break;
        //         }
        //     }
        // }
        if (jsl_cha != 0 && dr['block_tiep'] && dr['block_tiep'] && dr['block_tiep'] != 0) rowHDTDDV.SL_CHA = jsl_cha
        else rowHDTDDV.SL_CHA = 0

        if (dr['block_dau']) rowHDTDDV.BLOCK_DAU = dr['block_dau']
        else rowHDTDDV.BLOCK_DAU = 0

        if (dr['block_tiep']) rowHDTDDV.BLOCK_TIEP = dr['block_tiep']
        else rowHDTDDV.BLOCK_TIEP = 0

        if (dr['gia_block_tiep']) rowHDTDDV.GIA_BLOCK_TIEP = dr['gia_block_tiep']
        else rowHDTDDV.GIA_BLOCK_TIEP = 0

        if (dr['vat_block_tiep']) rowHDTDDV.VAT_BLOCK_TIEP = dr['vat_block_tiep']
        else rowHDTDDV.VAT_BLOCK_TIEP = 0

        if (dr['he_so']) rowHDTDDV.HE_SO = dr['he_so']
        else rowHDTDDV.HE_SO = 0

        rowHDTDDV.TTTH = 1
        this.dsDK_DVGT.push(rowHDTDDV)
      }
    },
    TaoDuLieu_TIEN_DATCOC(themmoi) {
      this.dsTien_DatCoc = []
      let row = {}
      row.HDTB_ID = this.hdtb_id
      row.THUEBAO_ID = 0
      row.LOAITIEN_ID = 1
      //TODO load tien dat coc tu phan khuyen mai
      row.GIATRI = this.kmld.dtiendatcoc_tt + this.kmld.dvatdatcoc_tt + this.kmld.dtiendatcoc_km + this.kmld.dvatdatcoc_km

      this.dsTien_DatCoc.push(row)
      //TODO phan update chua lam
      // if (themmoi == false)
      // {
      //     dsTien_DatCoc.AcceptChanges();
      //     dsTien_DatCoc.TIEN_HDTB_TC.Rows[0].SetModified();
      // }
    },
    CapNhat_HDTB_ID_DangKyDV() {
      this.dsDK_DVKHAC = [] //Object.assign({}, this.dsDK_DVK_TB); // Add du lieu o duoi nen khong copy object
      for (let dv of this.dsDK_DVK_TB) {
        let rowDK_DVK = {}
        rowDK_DVK.DVKHAC_ID = dv['dvkhac_id']
        rowDK_DVK.HD_ID = this.hdtb_id
        rowDK_DVK.LOAIID = dv['loaiid']
        rowDK_DVK.NGAY_YC = dv['ngay_yc'] ? moment(dv['ngay_yc']).format('DD/MM/YYYY') : moment(new Date()).format('DD/MM/YYYY')
        rowDK_DVK.NOIDUNG = dv['noidung'] ? dv['noidung'] : ''
        rowDK_DVK.KIEU_YC = dv['kieu_yc'] ? dv['kieu_yc'] : 0
        rowDK_DVK.TTTH = dv['ttth'] ? dv['ttth'] : 0
        this.dsDK_DVKHAC.push(rowDK_DVK)
      }
      for (let dv of this.dsDK_DVK_TT) {
        let rowDK_DVK = {}
        rowDK_DVK.DVKHAC_ID = dv['dvkhac_id']
        rowDK_DVK.HD_ID = this.hdtt_id
        rowDK_DVK.LOAIID = dv['loaiid']
        rowDK_DVK.NGAY_YC = moment(dv['ngay_yc']).isValid() ? moment(dv['ngay_yc']).format('DD/MM/YYYY') : moment(dv['ngay_yc'], 'DD/MM/YYYY').isValid() ? dv['ngay_yc'] : moment(new Date()).format('DD/MM/YYYY')
        rowDK_DVK.NOIDUNG = dv['noidung'] ? dv['noidung'] : ''
        rowDK_DVK.KIEU_YC = dv['kieu_yc']
        rowDK_DVK.TTTH = dv['ttth']
        rowDK_DVK.USER_TC = dv['user_tc']
        rowDK_DVK.PASS_TC = dv['pass_tc']
        rowDK_DVK.STATUS = 0
        this.dsDK_DVKHAC.push(rowDK_DVK)
      }
      for (var i = 0; i < this.dsCTM_TBI.length; i++) this.dsCTM_TBI[i]['hdtb_id'] = this.hdtb_id
      let khuyenmai_id_neo = ''
      for (var km of this.dgrKhuyenMai) {
        //this.dgrKhuyenMai la grid ben di dong
        if (km['dangky'] == 1) {
          khuyenmai_id_neo = km['khuyenmai_id']
          break
        }
      }
      for (var i = 0; i < this.dsKM_HDTB.length; i++) {
        this.dsKM_HDTB[i]['HDTB_ID'] = this.hdtb_id
        if (khuyenmai_id_neo != '') this.dsKM_HDTB[i]['KHUYENMAI_ID_NEO'] = khuyenmai_id_neo
        this.dsKM_HDTB[i]['TIEN_TG'] = this.TongTien_TG(this.dsKM_HDTB[i]['CHITIETKM_ID'])
      }
    },
    TongTien_TG(chitietkm_id) {
      let dTien_TG = 0
      let dTien = 0
      let dVat = 0
      let dTien_tt = 0
      let dVat_tt = 0
      let dTien_km = 0
      let dVat_km = 0
      let dSoLuong = 0

      let dt = this.DS_CTKM_LTBI
      for (var i = 0; i < dt.length; i++) {
        let ltb = dt[i]['loaitbi_id']
        let drs = this.dsCTM_TBI.filter((x) => x.loaitbi_id == ltb)
        for (let dr of drs) {
          dTien = dr['tien']
          dVat = dr['tien']
          dTien_tt = dr['tien_tratruoc']
          dVat_tt = dr['vat_tratruoc']
          dTien_km = dr['tien_km']
          dVat_km = dr['vat_km']
          dSoLuong = dr['soluong']
          dTien_TG = dTien_TG + (dTien - dTien_tt - dTien_km) * dSoLuong
        }
      }
      return dTien_TG
    },
    CapNhat_HDTB_ID_HDTB_KV() {
      // this.dsHDTB_KV_tmp = [];
      // this.dsHDTB_KV_tmp = [...this.dsHDTB_KV];
      // if(!this.dsHDTB_KV_tmp) this.dsHDTB_KV_tmp = [];
      for (var i = 0; i < this.dsHDTB_KV.length; i++) {
        this.dsHDTB_KV[i]['HDTB_ID'] = this.hdtb_id
      }
    },
    async TaoDuLieu_HDTB_MGWAN(themmoi) {
      this.dsHDTB_MEWAN = []
      let rowHDTB_MGWAN = {}
      let dulieuapi = {}
      let pdata = {
        LOAISOWAN: this.loaisowan,
        SD_FRMSHUONGKN_V2: this.thamsomacdinh['SD_FRMDSHUONGKN_V2'] == 1 ? 1 : 0,
        VRF_MGWAN: this.thuebao.mgwan.vrfvfi,
        DICHVUVT_ID: this.listbox.dichvu_vt.value,
        LOAITB_ID: this.listbox.loaihinh_tb.value,
        KIEULD_ID: this.listbox.kieu_ld.value,
        THEMMOI: themmoi ? 1 : 0,
        MADOICAP_WAN: this.thuebao.mgwan.madoicap ? this.thuebao.mgwan.madoicap : 0,
        MATN_WAN: this.thuebao.mgwan.matn
      }
      await API.post_fn_lay_tt_taodl_hdtb_mgwan(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          //"data": "{\"ERROR_CODE\":1,\"MESSAGE\":\"Thành công\",\"RESULT\":{\"DIACHIKH_ID\":20025699}}"
          dulieuapi = JSON.parse(response.data.data)
          if (dulieuapi['ERROR_CODE'] != 1) {
            this.$toast.error(dulieuapi['MESSAGE'])
            return
          }
          dulieuapi = dulieuapi['RESULT']
        }
      })
      rowHDTB_MGWAN.HDTB_ID = this.hdtb_id
      rowHDTB_MGWAN.TOCDO_ID = this.listbox.tocdokenh.valuecir

      if (this.listbox.tocdokenh.ischeckedpir) rowHDTB_MGWAN.TOCDO_PIR_ID = this.listbox.tocdokenh.valuepir
      else rowHDTB_MGWAN.TOCDO_PIR_ID = null

      if (this.listbox.congnghe.value > 0) rowHDTB_MGWAN.CONGNGHE_ID = this.listbox.congnghe.value
      else rowHDTB_MGWAN.CONGNGHE_ID = null
      rowHDTB_MGWAN.LOAIMD_ID = this.listbox.loaimodem.value
      rowHDTB_MGWAN.LOAIKENH_ID = this.listbox.loaikenh.value
      rowHDTB_MGWAN.THIETBIDC_ID = this.listbox.loai_tb.valuemgwan
      await this.LayMaTB(themmoi)
      rowHDTB_MGWAN.MA_LT = this.ma_tb_ao_ht
      rowHDTB_MGWAN.LAN_IP = this.thuebao.mgwan.lanip ? this.thuebao.mgwan.lanip.trim() : ''
      rowHDTB_MGWAN.WAN_IP = this.thuebao.mgwan.wanip ? this.thuebao.mgwan.wanip.trim() : ''
      if (this.loaisowan != 1 || this.thamsomacdinh['SD_FRMDSHUONGKN_V2'] != 1) rowHDTB_MGWAN.VRF = this.thuebao.mgwan.vrfvfi && this.thuebao.mgwan.vrfvfi.trim() != '-/-' ? this.thuebao.mgwan.vrfvfi.trim() : dulieuapi && dulieuapi['VRF'] ? dulieuapi['VRF'] : ''
      else {
        if (themmoi || !this.thuebao.mgwan.vrfvfi) this.thuebao.mgwan.vrfvfi = dulieuapi && dulieuapi['VRF'] ? dulieuapi['VRF'] : ''
        rowHDTB_MGWAN.VRF = this.thuebao.mgwan.vrfvfi
        if (!rowHDTB_MGWAN.VRF) {
          this.thuebao.mgwan.vrfvfi = await API.post_sinh_vfi_vrf_v2(this.axios, { tinhthicong_id: 100, vdichvuvt_id: this.listbox.dichvu_vt.value, vloaihinh_tb: this.listbox.loaihinh_tb.value }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return ''
          })
          rowHDTB_MGWAN.VRF = this.thuebao.mgwan.vrfvfi ? this.thuebao.mgwan.vrfvfi.trim() : ''
        }
        if (!rowHDTB_MGWAN.VRF) rowHDTB_MGWAN.VRF = ''
      }
      //HungHM - 07/09/2010 bổ xung thêm tham số cho wan
      rowHDTB_MGWAN.HUONG_KN = this.thuebao.mgwan.vhuongkn
      if (this.listbox.tinh_kn.value > 0) rowHDTB_MGWAN.TINH_KN_ID = this.listbox.tinh_kn.value

      if (this.KetCuoi_ID > 0) rowHDTB_MGWAN.KETCUOI_ID = this.KetCuoi_ID

      rowHDTB_MGWAN.THOIHAN_ID = this.listbox.thoihan.valuewan
      rowHDTB_MGWAN.TRANGBI_ID = this.listbox.trangbi.valuewan
      rowHDTB_MGWAN.CHUQUAN_ID = this.listbox.chu_quan.valuewan
      rowHDTB_MGWAN.CHUQUANLD_ID = this.listbox.chu_quan.valueldmgwan
      rowHDTB_MGWAN.MA_PL = this.thuebao.mgwan.mahdttkd ? this.thuebao.mgwan.mahdttkd.trim() : ''
      rowHDTB_MGWAN.SITE_ID = this.thuebao.mgwan.siteid
      rowHDTB_MGWAN.LOAINODE_ID = this.loaisowan
      rowHDTB_MGWAN.LOAICAP_ID = this.listbox.loaicap.value

      //if (txtDiaChi_KN.Text.Trim() != "")
      rowHDTB_MGWAN.DIACHI_KN = this.diachiKN.DIACHI

      if (this.chkLuongGiuKenh) rowHDTB_MGWAN.GIUKENH = this.thuebao.mgwan.luonggiukenh ? 1 : 0

      if (this.listbox.doitacwan.isenabled) {
        rowHDTB_MGWAN.DOITAC_ID = this.listbox.doitacwan.value
        if (this.thuebao.mgwan.cuoctk_dt) rowHDTB_MGWAN.CUOC_TKDT = this.thuebao.mgwan.cuoctk_dt
        else rowHDTB_MGWAN.CUOC_TKDT = 0
        if (this.thuebao.mgwan.cuoctc_dt) rowHDTB_MGWAN.CUOC_TCDT = this.thuebao.mgwan.cuoctc_dt
        else rowHDTB_MGWAN.CUOC_TCDT = 0

        rowHDTB_MGWAN.MAHD_DT = this.thuebao.mgwan.hopdong_dt ? this.thuebao.mgwan.hopdong_dt.trim() : ''
      } else {
        rowHDTB_MGWAN.DOITAC_ID = null
        rowHDTB_MGWAN.CUOC_TKDT = null
        rowHDTB_MGWAN.CUOC_TCDT = null
        rowHDTB_MGWAN.MAHD_DT = null
      }

      ///TuanNA: Bổ sung tham số cước thuê kênh, thuê cổng cho wan
      ///Ngày 08.05.2012
      ///
      if (this.thuebao.mgwan.cuocht) rowHDTB_MGWAN.CUOC_HT = this.thuebao.mgwan.cuocht
      else rowHDTB_MGWAN.CUOC_HT = 0
      if (this.thuebao.mgwan.cuoctbi) rowHDTB_MGWAN.CUOC_TBI = this.thuebao.mgwan.cuoctbi
      else rowHDTB_MGWAN.CUOC_TBI = 0
      if (this.thuebao.mgwan.cuoctc) rowHDTB_MGWAN.CUOC_TC = this.thuebao.mgwan.cuoctc
      else rowHDTB_MGWAN.CUOC_TC = 0
      if (this.thuebao.mgwan.cuoctk) rowHDTB_MGWAN.CUOC_TK = this.thuebao.mgwan.cuoctk
      else rowHDTB_MGWAN.CUOC_TK = 0
      //HungHM - Bổ xung thêm mã truy nhập + mã đôi cáp
      rowHDTB_MGWAN.MATB_TN = this.thuebao.mgwan.matn //txtMaTN_Wan.Text;
      let kieu = 0
      if (dulieuapi['KIEU']) kieu = dulieuapi['KIEU']
      //Nếu lắp trên đường có sẵn hoặc lắp kèm thì lấy mã đôi cáp từ form chọn xuống
      if (kieu == KIEULAP.LAP_KEM || kieu == KIEULAP.LAP_LINE_SAN) {
        if (!this.thuebao.mgwan.madoicap) {
          throw 'Đối với kiểu lắp đặt là lắp kèm hoặc trên đường có sẵn thì mã đôi cáp không được trống.'
          // this.$toast.error("Đối kiểu lắp đặt là lắp kèm hoặc trên đường có sẵn thì mã đôi cáp không được trống.");
          // return;
        }
        rowHDTB_MGWAN.MADOICAP = this.thuebao.mgwan.madoicap
      } //TH còn lại sinh mã đôi cáp
      else {
        if (dulieuapi['MADOICAP']) {
          rowHDTB_MGWAN.MADOICAP = dulieuapi['MADOICAP']
          this.thuebao.mgwan.madoicap = dulieuapi['MADOICAP']
        }
      }

      if (this.listbox.kieu_ld.value == KieuLapDat.TACH_VLAN) {
        if (dulieuapi['DS_MG'] && dulieuapi['DS_MG'].length > 0 && dulieuapi['DS_MG'][0].length > 0) {
          let ds_mg = dulieuapi['DS_MG'][0][0]
          ds_mg = this.LowerCasePropertyList(ds_mg)
          if (ds_mg['port_id']) rowHDTB_MGWAN.PORT_ID = ds_mg['port_id']
          if (ds_mg['vci_vpi_id']) rowHDTB_MGWAN.VCI_VPI_ID = ds_mg['vci_vpi_id']

          rowHDTB_MGWAN.SLOT_PE = ds_mg[0]['slot_pe']
          rowHDTB_MGWAN.PORT_PE = ds_mg[0]['port_pe']
          rowHDTB_MGWAN.LAN_IP = ds_mg[0]['lan_ip']
          rowHDTB_MGWAN.WAN_IP = ds_mg[0]['wan_ip']
          rowHDTB_MGWAN.ROUTE = ds_mg[0]['route']
          rowHDTB_MGWAN.LINK = ds_mg[0]['link']
          rowHDTB_MGWAN.VRF = ds_mg[0]['vrf']
          rowHDTB_MGWAN.SVLAN = ds_mg[0]['svlan']
          rowHDTB_MGWAN.CVLAN = ds_mg[0]['cvlan']
        }
      }
      if (this.listbox.kieu_ld.value == KieuLapDat.DATMOI_KENHPHU_AO) rowHDTB_MGWAN.KP_AO = 1
      else rowHDTB_MGWAN.KP_AO = 0

      if (this.thuebao.cvlct) {
        rowHDTB_MGWAN.MA_CV = this.thuebao.congvan ? this.thuebao.congvan.trim() : ''
        rowHDTB_MGWAN.NGAY_CV = this.thuebao.NgayCV
      }
      rowHDTB_MGWAN.MA_CRM = this.thuebao.crm ? this.thuebao.crm.trim() : ''
      rowHDTB_MGWAN.ID_ERP = this.thuebao.erp ? this.thuebao.erp.trim() : ''
      rowHDTB_MGWAN.MAKENH_VTN = this.thuebao.vtn ? this.thuebao.vtn.trim() : ''

      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MGW_INTERNET_TRUCTIEP || this.listbox.loaihinh_tb.value == LoaiHinhTB.NB_INTERNETTT) {
        rowHDTB_MGWAN.PHANLOAI_ID = this.listbox.phanloai_dv.value
        rowHDTB_MGWAN.PHANTACH_TD = this.listbox.ht_phantach_tocdo.value
        if (this.thuebao.mgwan.soluongip) rowHDTB_MGWAN.SL_IP = this.thuebao.mgwan.soluongip
        else rowHDTB_MGWAN.SL_IP = 0

        if (this.thuebao.mgwan.cuocip) rowHDTB_MGWAN.CUOC_IP = this.thuebao.mgwan.cuocip
        else rowHDTB_MGWAN.CUOC_IP = 0

        if (this.listbox.tocdokenh.ischeckednix) {
          rowHDTB_MGWAN.TOCDO_NIX = this.listbox.tocdokenh.valuenix
          if (this.thuebao.mgwan.cuocnix) rowHDTB_MGWAN.CUOC_NIX = this.thuebao.mgwan.cuocnix
          else rowHDTB_MGWAN.CUOC_NIX = 0
        } else {
          rowHDTB_MGWAN.TOCDO_NIX = null
          rowHDTB_MGWAN.CUOC_NIX = null
        }

        if (this.listbox.tocdokenh.ischeckedisp) {
          rowHDTB_MGWAN.TOCDO_ISP = this.listbox.tocdokenh.valueisp
          if (this.thuebao.mgwan.cuocisp) rowHDTB_MGWAN.CUOC_ISP = this.thuebao.mgwan.cuocisp
          else rowHDTB_MGWAN.CUOC_ISP = 0
        } else {
          rowHDTB_MGWAN.TOCDO_ISP = null
          rowHDTB_MGWAN.CUOC_ISP = null
        }
      } else {
        rowHDTB_MGWAN.PHANLOAI_ID = null
        rowHDTB_MGWAN.PHANTACH_TD = null
        rowHDTB_MGWAN.SL_IP = null
        rowHDTB_MGWAN.CUOC_IP = null
        rowHDTB_MGWAN.TOCDO_NIX = null
        rowHDTB_MGWAN.TOCDO_ISP = null
        rowHDTB_MGWAN.CUOC_NIX = null
        rowHDTB_MGWAN.CUOC_ISP = null
      }
      if (!themmoi) rowHDTB_MGWAN.MA_VNPT = this.ma_vnpt

      this.dsHDTB_MEWAN.push(rowHDTB_MGWAN)
      //if (themmoi == false)
      // {
      //     dsHDTB_MEWAN.AcceptChanges();
      //     dsHDTB_MEWAN.HDTB_MGWAN.Rows[0].SetModified();
      // }

      //Tạo cho bảng hdtb_dv
      for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

        //if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
        if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
          throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
          return;
        }
        let row = {}
        row.HDTB_ID = this.hdtb_id
        row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
        row.DONVI_ID = this.DT_CONTROLS.value[i]
        row.KIEUDV_ID = 2
        this.dsHDTBDV.push(row)
      }
      //End
    },
    async TaoDuLieu_HDTB_CD(themmoi) {
      this.dsHDTB_CD = []
      let rowHDTB_CD = {}
      rowHDTB_CD.HDTB_ID = this.hdtb_id
      if (this.chkVSVX) rowHDTB_CD.MC_TBCD_ID = 1
      else rowHDTB_CD.MC_TBCD_ID = 0

      if (this.chkMienCuocTB) rowHDTB_CD.MIENCUOC_TB = 1
      else rowHDTB_CD.MIENCUOC_TB = 0

      if (this.KetCuoi_ID > 0) rowHDTB_CD.KETCUOI_ID = this.KetCuoi_ID // TODO xem khi nao thi load duoc cai nay KetCuoi_ID khi them moi

      if (this.listbox.congnghe.value > 0) rowHDTB_CD.CONGNGHE_ID = this.listbox.congnghe.value
      else rowHDTB_CD.CONGNGHE_ID = null

      //HungHM - Bổ xung thêm mã truy nhập + mã đôi cáp
      rowHDTB_CD.MATB_TN = this.thuebaocd.matn ? this.thuebaocd.matn.trim() : null
      rowHDTB_CD.THOIHAN_ID = this.listbox.thoihan.valuecd

      if (this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_DC || this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_CU_SAU_TL || this.listbox.kieu_ld.value == KieuLapDat.THUESO_DT_MOI) {
        rowHDTB_CD.TG_THUESO = this.thuebaocd.sothang_thueso
        if (this.thuebaocd.kieu_thueso == THUESO.TRUOTSO) {
          rowHDTB_CD.SOTRUOT = this.thuebaocd.noidung_thueso
          rowHDTB_CD.NOIDUNG_TB = ''
        }
        if (this.thuebaocd.kieu_thueso == THUESO.THONGBAO) {
          rowHDTB_CD.SOTRUOT = ''
          rowHDTB_CD.NOIDUNG_TB = this.thuebaocd.noidung_thueso
        }
      }
      let kieu = this.listbox.kieu_ld.value
      //Nếu lắp trên đường có sẵn hoặc lắp kèm thì lấy mã đôi cáp từ form chọn xuống
      await API.post_fn_lay_tt_taodl_hdtb_cd(this.axios, { ds_para: JSON.stringify({ THEMMOI: themmoi, KIEULD_ID: kieu ? kieu : 2, MADOICAP_CD: this.thuebaocd.madoicap ? this.thuebaocd.madoicap : null }) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let dulieuapi = JSON.parse(response.data.data)

          if (dulieuapi['ERROR_CODE'] == 1) {
            if (dulieuapi['RESULT']['MADOICAP']) {
              this.thuebaocd.madoicap = dulieuapi['RESULT']['MADOICAP']
              rowHDTB_CD.MADOICAP = this.thuebaocd.madoicap
            }
          } else {
            this.$toast.error(dulieuapi['RESULT']['MESSAGE'])
            throw dulieuapi['RESULT']['MESSAGE'];
          }
        }
      })
      rowHDTB_CD.TRANGBI_ID = this.listbox.trangbi.valuecd
      rowHDTB_CD.CHUQUAN_ID = this.listbox.chu_quan.valuecd
      rowHDTB_CD.CHUQUANLD_ID = this.listbox.chu_quan.valueldcd
      if (this.listbox.doitac.ischeckedcd) {
        rowHDTB_CD.DOITAC_ID = this.listbox.doitac.valuecd
        if (this.thuebaocd.cuocdoitac && this.thuebaocd.cuocdoitac > 0) rowHDTB_CD.CUOC_DOITAC = this.thuebaocd.cuocdoitac
        else rowHDTB_CD.CUOC_DOITAC = 0
      } else {
        rowHDTB_CD.DOITAC_ID = null
        rowHDTB_CD.CUOC_DOITAC = null
      }
      if (!themmoi) rowHDTB_CD.MA_VNPT = this.ma_vnpt

      this.dsHDTB_CD.push(rowHDTB_CD)
      //TODO xu ly update???
      // if (themmoi == false)
      // {
      //     dsHDTB_CD.AcceptChanges();
      //     dsHDTB_CD.HDTB_CD.Rows[0].SetModified();
      // }

      //Tạo cho bảng hdtb_dv
      for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

        if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
          throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
          return;
        }
        let row = {}
        row.HDTB_ID = this.hdtb_id
        row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
        row.DONVI_ID = this.DT_CONTROLS.value[i]
        row.KIEUDV_ID = 2
        this.dsHDTBDV.push(row)
      }
      //End
    },
    TaoDuLieu_CAMKET_HDTB(themmoi) {
      this.dsCAMKET_HDTB = []
      if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) {
        //TODO can co load dgvTienCK tu dt = bangts.Lay_danhsach_tiencamket_hdtb(hdtb_id).Tables[0]; o method HienThiTTMoRong(long hdtb_id, int dichvuvt_id)
        for (let ck of this.thuebao.codinh.dgvTienCK.list) {
          if (!ck['tuthang'] || !ck['denthang'] || !ck['tien_ck']) continue
          if (ck['tuthang'] == '' || ck['denthang'] == '' || ck['tien_ck'] == '') continue

          if (!(ck['tuthang'] + '').match(/^\d*$/g)) {
            this.$toast.error('Bạn phải nhập từ tháng là số, không được chứa ký tự khác số.')
            continue
          }
          if (!(ck['denthang'] + '').match(/^\d*$/g)) {
            this.$toast.error('Bạn phải nhập đến tháng là số, không được chứa ký tự khác số.')
            continue
          }
          if (!(ck['tien_ck'] + '').match(/^\d*$/g)) {
            this.$toast.error('Bạn phải nhập tiền là số')
            continue
          }
          let row = {}
          row.HDTB_ID = this.hdtb_id
          row.TUTHANG = ck['tuthang'] * 1
          row.DENTHANG = ck['denthang'] * 1
          row.TIEN_CK = ck['tien_ck'] * 1
          row.NGUOI_CN = this.$root.token.getUserName()
          row.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
          row.MAY_CN = null
          this.dsCAMKET_HDTB.push(row)
        }
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.GPHONE) {
        for (let ds of this.thuebao.gphone.dgvTienCKGP.list) {
          if (!ds['tuthang'] || !ds['denthang'] || !ds['tien_ck']) continue

          if (!(ds['tuthang'] + '').match(/^\d*$/g)) {
            this.$toast.error('Bạn phải nhập từ tháng là số, không được chứa ký tự khác số.')
            continue
          }
          if (!(ds['denthang'] + '').match(/^\d*$/g)) {
            this.$toast.error('Bạn phải nhập đến tháng là số, không được chứa ký tự khác số.')
            continue
          }
          if (!(ds['tien_ck'] + '').match(/^\d*$/g)) {
            this.$toast.error('Bạn phải nhập tiền là số')
            continue
          }
          let row = {}
          row.HDTB_ID = this.hdtb_id
          row.TUTHANG = ds['tuthang'] * 1
          row.DENTHANG = ds['denthang'] * 1
          row.TIEN_CK = ds['tien_ck'] * 1
          row.NGUOI_CN = this.$root.token.getUserName()
          row.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
          row.MAY_CN = null
          this.dsCAMKET_HDTB.push(row)
        }
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.IMS) {
        for (let ds of this.thuebao.ims.dgvTienCKIMS.list) {
          if (!ds['tuthang'] || !ds['denthang'] || !ds['tien_ck']) continue

          if (!(ds['tuthang'] + '').match(/^\d*$/g)) {
            this.$toast.error('Bạn phải nhập từ tháng là số, không được chứa ký tự khác số.')
            continue
          }
          if (!(ds['denthang'] + '').match(/^\d*$/g)) {
            this.$toast.error('Bạn phải nhập đến tháng là số, không được chứa ký tự khác số.')
            continue
          }
          if (!(ds['tien_ck'] + '').match(/^\d*$/g)) {
            this.$toast.error('Bạn phải nhập tiền là số')
            continue
          }
          let row = {}
          row.HDTB_ID = this.hdtb_id
          row.TUTHANG = ds['tuthang'] * 1
          row.DENTHANG = ds['denthang'] * 1
          row.TIEN_CK = ds['tien_ck'] * 1
          row.NGUOI_CN = this.$root.token.getUserName()
          row.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
          row.MAY_CN = null
          this.dsCAMKET_HDTB.push(row)
        }
      }
    },
    TAO_DULIEU_HDKH_SUB(ds_hdkh_sub_p, v_hdkh_id) {
      this.dsHDKH_Sub = []
      let row = {}
      var ds_hdkh_sub = JSON.parse(JSON.stringify(ds_hdkh_sub_p))
      ds_hdkh_sub = this.LowerCasePropertyList(ds_hdkh_sub)
      row.CHUCVU_GT = ds_hdkh_sub[0]['chucvu_gt']
      row.HDKH_ID = v_hdkh_id && v_hdkh_id > 0 ? v_hdkh_id : this.khachhang.hdkh_id
      if (ds_hdkh_sub[0]['ngaycap_gt'])
        // ThangDM1 bo sung trong hop du lieu tra ve tu API xu ly luon ham nay -> format ve cho dung dinh dang!
        row.NGAYCAP_GT = (ds_hdkh_sub[0]['ngaycap_gt'] + '').indexOf('T') >= 0 ? moment(ds_hdkh_sub[0]['ngaycap_gt']).format('DD/MM/YYYY') : ds_hdkh_sub[0]['ngaycap_gt'] // moment(ds_hdkh_sub[0]["ngaycap_gt"]).format("DD/MM/YYYY");
      row.NGUOI_GT = ds_hdkh_sub[0]['nguoi_gt']
      if (ds_hdkh_sub[0]['so_phong']) row.SO_PHONG = ds_hdkh_sub[0]['so_phong']

      row.SOGIAY_GT = ds_hdkh_sub[0]['sogiay_gt']
      row.MA_NS = ds_hdkh_sub[0]['ma_ns']
      if (ds_hdkh_sub[0]['khoi_id']) row.KHOI_ID = ds_hdkh_sub[0]['khoi_id']
      //if (vkieukh_id_ == 1)
      if (this.vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) {
        row.SO_HD_KHDN = ds_hdkh_sub[0]['so_hd_khdn']
        row.SO_PL_KHDN = ds_hdkh_sub[0]['so_pl_khdn']
        if (ds_hdkh_sub[0]['kenh_pt'] == '1') {
          row.KENH_PT = 1
          row.LOAIKENH = null
          if (ds_hdkh_sub[0]['kenh_id']) row.KENH_ID = ds_hdkh_sub[0]['kenh_id']
        } else {
          row.KENH_PT = 2
          if (ds_hdkh_sub[0]['loaikenh']) row.LOAIKENH = ds_hdkh_sub[0]['loaikenh']
          if (ds_hdkh_sub[0]['kenh_id']) row.KENH_ID = ds_hdkh_sub[0]['kenh_id']
        }
      }
      if (this.ts_kt_tthdkhdn == 1) {
        row.SO_HD_KHDN = ds_hdkh_sub[0]['so_hd_khdn']
        row.MA_KHDN = ds_hdkh_sub[0]['ma_khdn']
        if (ds_hdkh_sub[0]['giatri_hd']) {
          row.GIATRI_HD = ds_hdkh_sub[0]['giatri_hd']
        }
        if (ds_hdkh_sub[0]['ngay_ky_hd']) {
          if(moment(ds_hdkh_sub[0]['ngay_ky_hd']).isValid())
            row.NGAY_KY_HD = moment(ds_hdkh_sub[0]['ngay_ky_hd']).format('DD/MM/YYYY')
          else
            row.NGAY_KY_HD = ds_hdkh_sub[0]['ngay_ky_hd'];

          if(row.NGAY_KY_HD && row.NGAY_KY_HD.indexOf(' ')>0) row.NGAY_KY_HD = row.NGAY_KY_HD.substring(0,row.NGAY_KY_HD.indexOf(' ')).trim();
        }
        row.GIAY_UQ = ds_hdkh_sub[0]['giay_uq']
        if (ds_hdkh_sub[0]['loaihdkh_id'] && ds_hdkh_sub[0]['loaihdkh_id'] != '-1') {
          row.LOAIHDKH_ID = ds_hdkh_sub[0]['loaihdkh_id']
        }
        if (ds_hdkh_sub[0]['tinhtranghd_id'] && ds_hdkh_sub[0]['tinhtranghd_id'] != '-1') {
          row.TINHTRANGHD_ID = ds_hdkh_sub[0]['tinhtranghd_id']
        }
      }
      if(ds_hdkh_sub[0]['kenhban_id'])
        row.KENHBAN_ID = ds_hdkh_sub[0]['kenhban_id']
      if(ds_hdkh_sub[0]['chuquan_id'])
        row.CHUQUAN_ID = ds_hdkh_sub[0]['chuquan_id']
      if (this.loainv_ctv_hrm > 0) {
        row.LOAINV_CTV_HRM = this.loainv_ctv_hrm
      }

      if (this.loainv_ngt_hrm > 0) {
        row.LOAINV_NGT_HRM = this.loainv_ngt_hrm
      }
      this.dsHDKH_Sub.push(row)
    },
    HienThiDanhSacHDTB(ds) {
      if (!ds || ds.length <= 0) return
      let tongtienhd = 0
      let tongtientb = 0
      this.lvwThueBao = []
      var i = 1
      for (let myRow of ds) {
        //var item = [i++];
        var item = { stt: i++ }
        tongtientb = myRow['tongtien'] ? myRow['tongtien'] : 0
        item.tongtien = tongtientb //myRow["tongtien"];
        item.hdtb_id = myRow['hdtb_id']
        item.ma_tt = myRow['ma_tt']
        item.ma_tb = myRow['ma_tb']
        item.ten_tb = this.ChuanHoaTen(myRow['ten_tb'])
        item.diachi_ld = this.ChuanHoaTen(myRow['diachi_ld'])
        item.ten_dvvt = myRow['ten_dvvt']
        item.loaihinh_tb = myRow['loaihinh_tb']
        item.manv_tc = myRow['manv_tc']
        item.trangthai_dongbo = myRow['trangthai_dongbo']
        item.dichvuvt_id = myRow['dichvuvt_id']
        item.hdtb_cha_id = myRow['hdtb_cha_id']
        item.loaitb_id = myRow['loaitb_id']
        tongtienhd = tongtienhd + tongtientb
        this.lvwThueBao.push(item)
      }
      this.tongtienhd = tongtienhd ? tongtienhd : 0
      if (i >= 2) {
        this.buttons.tsbtnThemTT = true
        this.buttons.tsbtnXoaTB = i != 2
      } else {
        this.buttons.tsbtnXoaTB = false
        this.buttons.tsbtnThemTB = false
      }
    },
    async HienThiTTHopDongTB(ds) {
      if (!ds || ds.length <= 0) return
      this.listbox.dichvu_vt.value = ds[0]['dichvuvt_id']
      await delay(1000);
      this.listbox.loaihinh_tb.value = ds[0]['loaitb_id']
      await delay(1000);
      await this.cboCongNghe_SelectedValueChanged()
      if (!this.listbox.cboGoiCuocAdsl.list || this.listbox.cboGoiCuocAdsl.list.length <= 0) await this.LoadGoiCuocADSL()
      this.thuebao.hdtb_id_cha = 0
      this.thuebao.thuebao_id_cha = 0
      if (ds.length > 0) {
        this.thuebao.tbhd_pl = ds[0]['tbhd_pl']
        this.hdtb_id = ds[0]['hdtb_id']
        if (ds[0]['thuebao_id']) this.thuebao.thuebao_id = ds[0]['thuebao_id']
        else this.thuebao.thuebao_id = 0
        let dsNV = []
        let pdata = ''
        // if (this.thuebao.thuebao_id && this.thuebao.thuebao_id != 0) pdata = '{"THUEBAO_ID":' + this.thuebao.thuebao_id + ',"LOAITB_ID":2}'
        // // tcDB.LAY_DS_KHUVUC_THEO_HD_DB(thuebao_id, 2);
        // else
        pdata = '{"THUEBAO_ID":' + this.thuebao.thuebao_id + ',"HDTB_ID":' + this.hdtb_id + ',"LOAITB_ID":' + this.listbox.loaihinh_tb.value + '}' // tcDB.LAY_DS_KHUVUC_THEO_HD_DB(hdtb_id, 1);
        let apidata = {}
        await API.post_fn_lay_tt_hdtb(this.axios, { ds_para: pdata }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            apidata = JSON.parse(response.data.data)
            if (apidata['RESULT']) apidata = apidata['RESULT']
          }
        })
        if (apidata['DS_NV']) dsNV = apidata['DS_NV']
        this.thuebao.khuvuc = ''
        if (dsNV && dsNV.length > 0) {
          this.thuebao.khuvuc = dsNV[0]['TEN_KV']
          this.thuebao.khuvuc_id = dsNV[0]['KHUVUC_ID']
        }
        this.listbox.nhacc_cu.ischecked = ds[0]['chuyenmang'] == 1
        if (this.listbox.nhacc_cu.ischecked && ds[0]['nhacc_cu_id']) this.listbox.nhacc_cu.value = ds[0]['nhacc_cu_id']
        if (this.listbox.nhacc_cu.ischecked && ds[0]['htcm_id']) this.listbox.hinhthuc_cm.value = ds[0]['htcm_id']
        this.thuebao.tentb = this.ChuanHoaTen(ds[0]['ten_tb'])
        this.diachiTB.DIACHI = ds[0]['diachi_tb']
        this.diachiLD.DIACHI = ds[0]['diachi_ld']
        await API.get_lay_ds_diachi_theo_hdtbid(this.axios, { params: { hdtbId: this.hdtb_id } }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            this.HienThiTTDiaChi(response.data.data, 3) //LINE 13862
          }
        })
        this.thuebao.ghichu = ds[0]['ghichu']
        this.txtStatus = ds[0]['status'] // TODO chua xu ly cai nay vi khong nam trong muc CO_DINH, thuoc phan CNTT
        if (ds[0]['ngay_sn']) this.NgaySinhTB = moment(ds[0]['ngay_sn']).isValid() ? moment(ds[0]['ngay_sn']).format(this.datetimeFormatFull) : ds[0]['ngay_sn']
        if (!this.NgaySinhTB) this.NgaySinhTB = this.NgaySinh ? this.NgaySinh : null
        for (var i = 0; i < ds.length; i++) {
          if (ds[i]['loaitb_id'] == LoaiHinhTB.INTERNET_ADSL || ds[i]['loaitb_id'] == LoaiHinhTB.INTERNET_FTTH || ds[i]['loaitb_id'] == LoaiHinhTB.WIFI_FIBER || ds[i]['loaitb_id'] == LoaiHinhTB.MEGA_IOT) {
            if (ds[i]['status'] == 1) {
              this.thuebao.check_tb_adsl = true
              break
            }
          }
          if (ds[i]['loaitb_id'] == LoaiHinhTB.FSECURE) {
            if (ds[i]['status'] == 5) {
              this.thuebao.check_tb_adsl = true
              break
            }
          }
        }

        this.listbox.kieu_ld.value = ds[0]['kieuld_id']

        {
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.PABX || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN2B_CD || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN2B_CQ || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN30B_CD || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN30B_CQ) {
            if (!ds[0]['ma_tb_cha']) {
              this.loaisoisdn = LOAISO_ISDN.SOCHINH
              this.thuebao.codinh.sochinh = ''
            } else {
              this.thuebao.codinh.sochinh = ds[0]['ma_tb_cha']
              this.loaisoisdn = LOAISO_ISDN.SOPHU
              if (ds[0]['hdtb_cha_id']) {
                this.thuebao.hdtb_id_cha = ds[0]['hdtb_cha_id']
                this.thuebao.loaisochinh = 0
              } else {
                this.thuebao.thuebao_id_cha = ds[0]['thuebao_cha_id']
                this.thuebao.loaisochinh = 1
              }
            }
          }
        }

        this.listbox.doituong.value = ds[0]['doituong_id']
        if (ds[0]['doituong_ct_id']) this.thuebao.doituong_ct_id = ds[0]['doituong_ct_id']


        if(ds[0]['donvi_id']) this.listbox.donvi_ql.value = ds[0]['donvi_id']
        this.listbox.thanhtoancbo.value = ds[0]['hdtt_id']

        //this.thuebao.codinh.somay = ds[0]["ma_tb"]; // FIXME: cho nay khong dung code cu -> bỏ
        this.ma_tb = ds[0]['ma_tb']
        this.ma_tb_ht = ds[0]['ma_tb']
        if (ds[0]['goikt_id']) this.listbox.goi_kt.value = ds[0]['goikt_id']
        else this.listbox.goi_kt.value = 0

        //HungHM - 07/09/2010 chỉ áp dụng với TSL
        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          // this.listbox.donvi_dau.value = ds[0]["donvi_dau_id"];
          // this.listbox.donvi_cuoi.value = ds[0]["donvi_cuoi_id"];
          this.thuebao.tsl.donvi_dau_id = ds[0]['donvi_dau_id']
          this.thuebao.tsl.donvi_cuoi_id = ds[0]['donvi_cuoi_id']
        }
        //Hiếu 5.10.2010: Lấy ds khuyến mại đã được lập
        let kieu_ld = this.listbox.kieu_ld.value
        try {
          this.asyncLock = true;
          this.watcherActive = false;
          await this.HienThiTTMoRong(this.hdtb_id, this.listbox.dichvu_vt.value)
          await waitUntil(()=>!this.asyncLock);
        } catch (ex) {
          throw ex;
        }
        finally {
          this.asyncLock = false;
          this.watcherActive = true;
        }
        //Move tu 2 dong tren xuong day
        let m_dsThueBao_DichVu = []
        let dsDK_DVK_TB = []
        //let pdata = "{\"THUEBAO_ID\":0,\"HDTB_ID\":"+this.hdtb_id+",\"LOAITB_ID\":"+this.listbox.loaihinh_tb.value+"}"
        // await API.post_fn_lay_tt_hdtb(this.axios, { ds_para: pdata }).then((response) => {
        //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
        //     let apidata = JSON.parse(response.data.data);
        //   }
        // });
        if (apidata['DS_DK_DVK']) dsDK_DVK_TB = apidata['DS_DK_DVK']
        if (apidata['DS_TB_DICHVU']) m_dsThueBao_DichVu = apidata['DS_TB_DICHVU']
        this.m_dsThueBao_DichVu = this.LowerCasePropertyList(m_dsThueBao_DichVu)
        await this.HT_DichVuGT()
        this.dsDK_DVK_TB = this.LowerCasePropertyList(dsDK_DVK_TB)
        await this.HT_DichVuKhac(this.LowerCasePropertyList(dsDK_DVK_TB), 1)
        //Lấy ds mức cước thuê bao
        //this.Lay_DS_MucCuoc_TB(khuld_id, apld_id, phold_id, phuongld_id, this.listbox.loaihinh_tb.value, this.listbox.doituong.value, dtpNgayYeuCau.Value.ToString("dd/MM/yyyy"));
        await this.LoadMucCuocTB() // thay ham tren bang ham nay tuong duong
        //Move tu 2 dong tren xuong day
        //Mức cước thuê bao giờ để trong bảng hd_thuebao - Lamnt: 13/08/2013
        if (ds[0]['mucuoctb_id']) this.listbox.muccuoc_tb.value = ds[0]['mucuoctb_id']

        if (ds[0]['tg_thue_tu']) {
          this.TGThueTuNgay = moment(ds[0]['tg_thue_tu']).format(this.datetimeFormatFull)
          this.TGThueDenNgay = moment(ds[0]['tg_thue_den']).format(this.datetimeFormatFull)
          this.kt_thuenganhan = true
        } else {
          this.TGThueTuNgay = moment(new Date()).format(this.datetimeFormatFull)
          this.TGThueDenNgay = moment(new Date()).format(this.datetimeFormatFull)
          this.kt_thuenganhan = false
        }
        await this.HT_DS_KhuyenMai_Combobox()
        if (apidata['KETCUOI_ID']) this.KetCuoi_ID = apidata['KETCUOI_ID']
        else this.KetCuoi_ID = -1

        //Hieustc: 2.6.2011: Hiển thị chi tiết khuyến mại neo
        if (this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG) {
          if (this.dsKM_HDTB.length > 0) {
            for (var i = 0; i < this.dsKM_Neo.length; i++) {
              if (this.dsKM_HDTB[0]['khuyenmai_id_neo'.toUpperCase()] == this.dsKM_Neo[i]['khuyenmai_id']) {
                this.dsKM_Neo[i]['dangky'] = 1
                break
              }
            }
          }
        }

        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL) {
          this.cbvmp = ds[0]['vmp'] && ds[0]['vmp'] != 0 ? true : false
        }

        //Longdx: bổ sung lấy chi tiết KM
        //DataSet dsTemp = tchopdong.LAY_CHITIET_KM_THEO_HDTB_ID(hdtb_id, 0);
        let dsTemp = []
        let dsTempTT = []
        if (apidata['DS_CTKM']) dsTemp = this.LowerCasePropertyList(apidata['DS_CTKM'])
        this.dsKM_HDTB = []
        if (dsTemp.length > 0) {
          if (dsTemp[0]['khuyenmai_id']) {
            this.filterbox.khuyenmai.value = dsTemp[0]['khuyenmai_id']
            this.filterbox.khuyenmai.ischecked = true
          } else {
            this.filterbox.khuyenmai.ischecked = false
          }
          this.dsKM_HDTB = [...dsTemp] //Object.assign({}, dsTemp)
          //BUG Doan nay kha nang sai, check lai
          // this.filterbox.khuyenmai.list = this.dsKM_HDTB;
          // if(this.filterbox.khuyenmai.list && this.filterbox.khuyenmai.list.length>0) {
          // if(!this.filterbox.khuyenmai.value || this.filterbox.khuyenmai.value<=0 || !this.filterbox.khuyenmai.list.find(x=>x.khuyenmai_id==this.filterbox.khuyenmai.value))
          //   this.filterbox.khuyenmai.value=this.filterbox.khuyenmai.list[0].khuyenmai_id;
          // }
          // else this.filterbox.khuyenmai.ischecked = false;
        } else {
          this.filterbox.khuyenmai.ischecked = false
          this.dsKM_HDTB = []
          //BUG Doan nay kha nang sai, check lai
          // this.dsKM_HDTB = [];
          // this.filterbox.khuyenmai.list = this.dsKM_HDTB;
          // if(this.filterbox.khuyenmai.list && this.filterbox.khuyenmai.list.length>0) {
          // if(!this.filterbox.khuyenmai.value || this.filterbox.khuyenmai.value<=0 || !this.filterbox.khuyenmai.list.find(x=>x.khuyenmai_id==this.filterbox.khuyenmai.value))
          //   this.filterbox.khuyenmai.value=this.filterbox.khuyenmai.list[0].khuyenmai_id;
          // }
          // else this.filterbox.khuyenmai.ischecked = false;
        }

        //Longdx: bổ sung lấy chi tiết KM
        if (apidata['DS_DATCOC']) dsTempTT = this.LowerCasePropertyList(apidata['DS_DATCOC'])
        this.dsDC_HDTB = []
        if (dsTempTT.length > 0) {
          if (dsTempTT[0]['khuyenmai_id']) {
            this.filterbox.tratruoc.value = dsTempTT[0]['khuyenmai_id']
            this.filterbox.tratruoc.ischecked = true
          } else {
            this.filterbox.tratruoc.ischecked = false
          }
          this.dsDC_HDTB = [...dsTempTT]
          for (var item of this.dsDC_HDTB) {
            item['ngay_bd'] = item['ngay_bd'] && (item['ngay_bd'] + '').indexOf('T') > 0 ? moment(item['ngay_bd']).format('DD/MM/YYYY') : item['ngay_bd']
            item['ngay_bddc'] = item['ngay_bddc'] && (item['ngay_bddc'] + '').indexOf('T') > 0 ? moment(item['ngay_bddc']).format('DD/MM/YYYY') : item['ngay_bddc'] //item["ngay_bddc"];
            item['ngay_kt'] = item['ngay_kt'] && (item['ngay_kt'] + '').indexOf('T') > 0 ? moment(item['ngay_kt']).format('DD/MM/YYYY') : item['ngay_kt'] //item["ngay_kt"];
            item['ngay_ktdc'] = item['ngay_ktdc'] && (item['ngay_ktdc'] + '').indexOf('T') > 0 ? moment(item['ngay_ktdc']).format('DD/MM/YYYY') : item['ngay_ktdc'] //item["ngay_ktdc"];
          }
          // this.filterbox.tratruoc.list = this.dsDC_HDTB;
          // if(this.filterbox.tratruoc.list && this.filterbox.tratruoc.list.length>0) {
          // if(!this.filterbox.tratruoc.value || this.filterbox.tratruoc.value<=0 || !this.filterbox.tratruoc.list.find(x=>x.khuyenmai_id==this.filterbox.tratruoc.value))
          //   this.filterbox.tratruoc.value=this.filterbox.tratruoc.list[0].khuyenmai_id; //else this.filterbox.tratruoc.value=0;
          // }
          // else this.filterbox.tratruoc.ischecked = false;
        } else {
          this.filterbox.tratruoc.ischecked = false
          this.dsDC_HDTB = []
          // this.filterbox.tratruoc.list = this.dsDC_HDTB;
          // if(this.filterbox.tratruoc.list && this.filterbox.tratruoc.list.length>0) {
          // if(!this.filterbox.tratruoc.value || this.filterbox.tratruoc.value<=0 || !this.filterbox.tratruoc.list.find(x=>x.khuyenmai_id==this.filterbox.tratruoc.value))
          //   this.filterbox.tratruoc.value=this.filterbox.tratruoc.list[0].khuyenmai_id; //else this.filterbox.tratruoc.value=0;
          // }
          // else this.filterbox.tratruoc.ischecked = false;
        }
        await delay(1000);
        this.dsCTM_TBI = []
        if (apidata['DS_MUA_TBI']) this.dsCTM_TBI = this.LowerCasePropertyList([...apidata['DS_MUA_TBI']])
        if (apidata['DS_TIENHD_KM']) this.ds_tien_khoanmuc = this.LowerCasePropertyList([...apidata['DS_TIENHD_KM']])
        this.m_dsTienCTKM = await API.post_sp_lay_ct_tienhd_km_theo_hdtb(this.axios, { vhdtb_id: this.hdtb_id }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          }
        })
        this.ds_tien_khoanmuc_bd = JSON.parse(JSON.stringify(this.ds_tien_khoanmuc))
        for (var i = 0; i < this.ds_tien_khoanmuc.length; i++) {
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
            this.dtienld = this.ds_tien_khoanmuc[i]['tien']
            this.dvatld = this.ds_tien_khoanmuc[i]['vat']
          }
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
            this.dtiencd = this.ds_tien_khoanmuc[i]['tien']
            this.dvatcd = this.ds_tien_khoanmuc[i]['vat']
          }
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DICHVU) {
            this.dichvu.dtien_dv = this.ds_tien_khoanmuc[i]['tien']
            this.dichvu.dvat_dv = this.ds_tien_khoanmuc[i]['vat']
          }
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT) {
            this.kmld.dtienkmld = this.ds_tien_khoanmuc[i]['tien']
            this.kmld.dvatkmld = this.ds_tien_khoanmuc[i]['vat']
          }
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DATCOC) {
            this.kmld.dtienkmdc = this.ds_tien_khoanmuc[i]['tien']
            this.kmld.dvatkmdc = this.ds_tien_khoanmuc[i]['vat']
          }
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC) {
            this.kmld.dtiendatcoc_tt = this.ds_tien_khoanmuc[i]['tien']
            this.kmld.dvatdatcoc_tt = this.ds_tien_khoanmuc[i]['vat']
          }
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC_KM) {
            this.kmld.dtiendatcoc_km = this.ds_tien_khoanmuc[i]['tien']
            this.kmld.dvatdatcoc_km = this.ds_tien_khoanmuc[i]['vat']
          }
        }
        await this.HT_ThietBi()
        //this.HT_DichVuGT();
        await this.HienThiTienKhuyenMaiLapDat()

        if (apidata['DS_MUA_TBI']) this.dsCTM_TBI = this.LowerCasePropertyList([...apidata['DS_MUA_TBI']])
        if (apidata['DS_TIENHD_KM']) this.ds_tien_khoanmuc = this.LowerCasePropertyList([...apidata['DS_TIENHD_KM']])

        await this.LayTongTien_HDTB()
        if (ds[0]['loaitb_id'] == LoaiHinhTB.INTERNET_MYTV) {
          this.HT_DS_DBCHINH_MYTV()
          this.HT_DS_HDCHINH_MYTV()
          if (ds[0]['hdtb_cha_id'] && ds[0]['hdtb_cha_id'] != 0) {
            this.thuebao.adsl.isHopDong = 1
            this.listbox.cboHDChinh.value = ds[0]['hdtb_cha_id']
          }

          if (ds[0]['thuebao_cha_id'] && ds[0]['thuebao_cha_id'] != 0) {
            this.thuebao.adsl.isHopDong = 0
            this.listbox.cboDbChinh.value = ds[0]['thuebao_cha_id']
          }
        }
        //TODO bo qua vi khong phai CO_DINH

        if (ds[0]['loaitb_id'] == LoaiHinhTB.IMS_SIPTRUNKING) {
          this.HT_DS_TRUNK_IMS()
          if (ds[0]['hdtb_cha_id'] && ds[0]['hdtb_cha_id'] != 0) {
            this.thuebao.ims.cbkTrunk = true
            this.thuebao.ims.cboTrunk.value = ds[0]['hdtb_cha_id']
          }

          if (ds[0]['thuebao_cha_id'] && ds[0]['thuebao_cha_id'] != 0) {
            this.thuebao.ims.cbkTrunk = true
            this.thuebao.ims.cboTrunk.value = ds[0]['thuebao_cha_id'] ? ds[0]['thuebao_cha_id'] * 1 : 0 //Convert.ToInt64(ds[0]["thuebao_cha_id"]);
          }
        }

        this.thuebao.thangck = ds[0]['sothang_ck']

        //Lấy ra các đơn vị được chọn
        {
          let dtTemp = []
          if (apidata['HDTB_DV']) dtTemp = apidata['HDTB_DV']
          if (dtTemp.length > 0) {
            for (var i = 0; i < this.DT_CONTROLS.value.length; i++) {
              // let cbo = this.DT_CONTROLS.value[i];
              let dr = dtTemp.filter((x) => x.LOAIDV_ID == this.DT_CONTROLS.tagvalue[i])
              if (dr.length > 0) {
                if (dr[0]['DONVI_ID']) this.DT_CONTROLS.value[i] = dr[0]['DONVI_ID']
                else {
                  // Them case else nay xu ly khi thay doi du lieu tu chon gia tri moi
                  var j = 0
                  for (; j < this.DT_CONTROLS.data[i].length; j++) if (this.DT_CONTROLS.data[i][j].DONVI_ID == this.DT_CONTROLS.value[i]) break
                  if (j >= this.DT_CONTROLS.data[i].length) this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0].DONVI_ID
                }
                this.DT_CONTROLS.key += 1
                //this.DT_CONTROLS.tagvalue[i] = dr[0]["LOAIDV_ID"];
              }
            }
          }
        }
      }
    },
    HT_DS_TRUNK_IMS() {
      try {
        API.post_ht_ds_tb_chinh_ims(this.axios, {
          hdkh_id: this.khachhang.hdkh_id ? this.khachhang.hdkh_id : 0,
          khachhang_id: this.khachhang.khachhang_id ? this.khachhang.khachhang_id : 0
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            this.thuebao.ims.cboTrunk.list = response.data.data
            if (this.thuebao.ims.cboTrunk.list && this.thuebao.ims.cboTrunk.list.length > 0 && (!this.thuebao.ims.cboTrunk.value || this.thuebao.ims.cboTrunk.value <= 0)) this.thuebao.ims.cboTrunk.value = this.thuebao.ims.cboTrunk.list[0].trunkid
          }
        })
      } catch (ex) {
        this.$toast.error('Lỗi khi lấy thông tin đường trunk ! ' + this.debug ? ex : '')
        if (this.debug) console.error(ex)
      }
    },
    ChuanHoaTen(ten) {
      if (!ten) return ''
      let ten_new = ''
      let str_con = ten.trim()
      let str_xl = ''
      let k = 0
      let found = true
      if (str_con.length < 1) return
      str_con = str_con.replaceAll(/\s+/g, ' ')
      try {
        while (found) {
          k = str_con.indexOf(' ')
          if (k > 0) {
            str_xl = str_con.substring(0, k)
            str_con = str_con.substring(k + 1)
            str_xl = this.ChuyenChuHoa(str_xl)
            if (ten_new != '') ten_new += ' ' + str_xl
            else ten_new = str_xl
            found = true
          } else found = false
        }
        if (str_con != '') {
          str_xl = str_con
          str_xl = this.ChuyenChuHoa(str_xl)
          if (ten_new != '') ten_new = ten_new + ' ' + str_xl
          else ten_new = str_xl
        }
        return ten_new
      } catch (e) {
        return ten
      }
    },
    ChuyenChuHoa(str) {
      let kq = ''
      if (str.ismatch(/[A-Z][A-Z]/g)) kq = str.toUpperCase()
      else {
        if (str[0] == '(') kq = str[0] + str[1].toUpperCase() + str.substring(2).toLowerCase()
        else kq = str[0].toUpperCase() + str.substring(1).toLowerCase()
      }
      return kq
    },
    HienThiTTDiaChi(ds, kieu) {
      ds = this.LowerCasePropertyList(ds)
      if (ds.length > 0) {
        switch (kieu * 1) {
          case 1:
            this.diachikh_id = ds[0]['diachi_id']
            this.diachiKH.DIACHI_ID = ds[0]['diachi_id']
            this.diachiKH.TINH_ID = ds[0]['tinh_id']
            this.diachiKH.QUAN_ID = ds[0]['quan_id']
            this.diachiKH.PHUONG_ID = ds[0]['phuong_id']
            if (ds[0]['pho_id']) this.diachiKH.PHO_ID = ds[0]['pho_id']
            else this.diachiKH.PHO_ID = 0
            if (ds[0]['ap_id']) this.diachiKH.AP_ID = ds[0]['ap_id']
            else this.diachiKH.AP_ID = 0
            if (ds[0]['khu_id']) this.diachiKH.KHU_ID = ds[0]['khu_id']
            else this.diachiKH.KHU_ID = 0
            if (ds[0]['dacdiem_id']) this.diachiKH.DACDIEM_ID = ds[0]['dacdiem_id']
            else this.diachiKH.DACDIEM_ID = 0
            this.diachiKH.SO_NHA = this.ChuanHoaTen(ds[0]['sonha'])

            if (ds[0]['block']) this.diachiKH.BLOCK = ds[0]['block']
            if (ds[0]['tang']) this.diachiKH.TANG = ds[0]['tang']
            if (ds[0]['phong']) this.diachiKH.PHONG = ds[0]['phong']
            if (ds[0]['mota']) this.diachiKH.MOTA = ds[0]['mota']

            if (ds[0]['vido'] && ds[0]['vido']) this.diachiKH.Lat = ds[0]['vido']
            else this.diachiKH.Lat = 0
            if (ds[0]['kinhdo'] && ds[0]['kinhdo']) this.diachiKH.Lng = ds[0]['kinhdo']
            else this.diachiKH.Lng = 0
            break
          case 2:
            this.diachitt_id = ds[0]['diachi_id']
            this.diachiTT.DIACHI_ID = ds[0]['tinh_id']
            this.diachiTT.TINH_ID = ds[0]['tinh_id']
            this.diachiTT.QUAN_ID = ds[0]['quan_id']
            this.diachiTT.PHUONG_ID = ds[0]['phuong_id']
            if (ds[0]['pho_id']) this.diachiTT.PHO_ID = ds[0]['pho_id']
            else this.diachiTT.PHO_ID = 0
            if (ds[0]['ap_id']) this.diachiTT.AP_ID = ds[0]['ap_id']
            else this.diachiTT.AP_ID = 0
            if (ds[0]['khu_id']) this.diachiTT.KHU_ID = ds[0]['khu_id']
            else this.diachiTT.KHU_ID = 0
            if (ds[0]['dacdiem_id']) this.diachiTT.DACDIEM_ID = ds[0]['dacdiem_id']
            else this.diachiTT.DACDIEM_ID = 0
            this.diachiTT.SO_NHA = this.ChuanHoaTen(ds[0]['sonha'])

            if (ds[0]['block']) this.diachiTT.BLOCK = ds[0]['block']
            if (ds[0]['tang']) this.diachiTT.TANG = ds[0]['tang']
            if (ds[0]['phong']) this.diachiTT.PHONG = ds[0]['phong']
            if (ds[0]['mota']) this.diachiTT.MOTA = ds[0]['mota']

            if (ds[0]['vido'] && ds[0]['vido']) this.diachiTT.Lat = ds[0]['vido']
            else this.diachiTT.Lat = 0
            if (ds[0]['kinhdo'] && ds[0]['kinhdo']) this.diachiTT.Lng = ds[0]['kinhdo']
            else this.diachiTT.Lng = 0

            if (ds[0]['diachibc_id']) this.diachibc_id = ds[0]['diachibc_id']
            else this.diachibc_id = 0
            if (ds[0]['tinhbc_id']) this.diachiBC.TINH_ID = ds[0]['tinhbc_id']
            else this.diachiBC.TINH_ID = 0
            if (ds[0]['quanbc_id']) this.diachiBC.QUAN_ID = ds[0]['quanbc_id']
            else this.diachiBC.QUAN_ID = 0
            if (ds[0]['phuongbc_id']) this.diachiBC.PHUONG_ID = ds[0]['phuongbc_id']
            else this.diachiBC.PHUONG_ID = 0
            if (ds[0]['phobc_id']) this.diachiBC.PHO_ID = ds[0]['phobc_id']
            else this.diachiBC.PHO_ID = 0
            if (ds[0]['apbc_id']) this.diachiBC.AP_ID = ds[0]['apbc_id']
            else this.diachiBC.AP_ID = 0
            if (ds[0]['khubc_id']) this.diachiBC.KHU_ID = ds[0]['khubc_id']
            else this.diachiBC.KHU_ID = 0
            if (ds[0]['dacdiembc_id']) this.diachiBC.DACDIEM_ID = ds[0]['dacdiembc_id']
            else this.diachiBC.DACDIEM_ID = 0
            if (ds[0]['sonha_bc']) this.diachiBC.SO_NHA = this.ChuanHoaTen(ds[0]['sonha_bc'])
            else this.diachiBC.SO_NHA = ''

            if (ds[0]['block']) this.diachiBC.BLOCK = ds[0]['block']
            if (ds[0]['tang']) this.diachiBC.TANG = ds[0]['tang']
            if (ds[0]['phong']) this.diachiBC.PHONG = ds[0]['phong']
            if (ds[0]['mota']) this.diachiBC.MOTA = ds[0]['mota']

            if (ds[0]['vido_bc'] && ds[0]['vido_bc']) this.diachiBC.Lat = ds[0]['vido_bc']
            else this.diachiBC.Lat = 0
            if (ds[0]['kinhdo_bc'] && ds[0]['kinhdo_bc']) this.diachiBC.Lng = ds[0]['kinhdo_bc']
            else this.diachiBC.Lng = 0
            break
          case 3:
            this.diachitb_id = ds[0]['diachi_id']
            if (ds[0]['diachild_id']) this.diachild_id = ds[0]['diachild_id']
            this.diachiTB.DIACHI_ID = ds[0]['diachi_id']
            this.diachiLD.DIACHI_ID = ds[0]['diachild_id']
            this.diachiTB.TINH_ID = ds[0]['tinh_id']
            this.diachiTB.QUAN_ID = ds[0]['quan_id']
            this.diachiTB.PHUONG_ID = ds[0]['phuong_id']
            if (ds[0]['pho_id']) this.diachiTB.PHO_ID = ds[0]['pho_id']
            else this.diachiTB.PHO_ID = 0
            if (ds[0]['ap_id']) this.diachiTB.AP_ID = ds[0]['ap_id']
            else this.diachiTB.AP_ID = 0
            if (ds[0]['khu_id']) this.diachiTB.KHU_ID = ds[0]['khu_id']
            else this.diachiTB.KHU_ID = 0
            if (ds[0]['dacdiem_id']) this.diachiTB.DACDIEM_ID = ds[0]['dacdiem_id']
            else this.diachiTB.DACDIEM_ID = 0
            this.diachiTB.SO_NHA = this.ChuanHoaTen(ds[0]['sonha'])

            if (ds[0]['block']) this.diachiTB.BLOCK = ds[0]['block']
            if (ds[0]['tang']) this.diachiTB.TANG = ds[0]['tang']
            if (ds[0]['phong']) this.diachiTB.PHONG = ds[0]['phong']
            if (ds[0]['mota']) this.diachiTB.MOTA = ds[0]['mota']

            if (ds[0]['vido'] && ds[0]['vido']) this.diachiTB.Lat = ds[0]['vido']
            else this.diachiTB.Lat = 0
            if (ds[0]['kinhdo'] && ds[0]['kinhdo']) this.diachiTB.Lng = ds[0]['kinhdo']
            else this.diachiTB.Lng = 0
            if (ds[0]['tinhld_id']) {
              this.diachiLD.TINH_ID = ds[0]['tinhld_id']
            } else this.diachiLD.TINH_ID = 0
            if (ds[0]['quanld_id']) this.diachiLD.QUAN_ID = ds[0]['quanld_id']
            else this.diachiLD.QUAN_ID = 0
            if (ds[0]['phuongld_id']) this.diachiLD.PHUONG_ID = ds[0]['phuongld_id']
            else this.diachiLD.PHUONG_ID = 0
            if (ds[0]['phold_id']) this.diachiLD.PHO_ID = ds[0]['phold_id']
            else this.diachiLD.PHO_ID = 0
            if (ds[0]['apld_id']) this.diachiLD.AP_ID = ds[0]['apld_id']
            else this.diachiLD.AP_ID = 0
            if (ds[0]['khuld_id']) this.diachiLD.KHU_ID = ds[0]['khuld_id']
            else this.diachiLD.KHU_ID = 0
            if (ds[0]['dacdiemld_id']) this.diachiLD.DACDIEM_ID = ds[0]['dacdiemld_id']
            else this.diachiLD.DACDIEM_ID = 0
            if (ds[0]['sonha_ld']) this.diachiLD.SO_NHA = this.ChuanHoaTen(ds[0]['sonha_ld'])
            else this.diachiLD.SO_NHA = ''

            if (ds[0]['block']) this.diachiLD.BLOCK = ds[0]['block']
            if (ds[0]['tang']) this.diachiLD.TANG = ds[0]['tang']
            if (ds[0]['phong']) this.diachiLD.PHONG = ds[0]['phong']
            if (ds[0]['mota']) this.diachiLD.MOTA = ds[0]['mota']

            if (ds[0]['dientich']) this.diachiLD.DIENTICH = ds[0]['dientich']
            if (ds[0]['sotang']) this.diachiLD.SOTANG = ds[0]['sotang']
            if (ds[0]['sophong']) this.diachiLD.SOPHONG = ds[0]['sophong']
            if (ds[0]['loainha_id']) this.diachiLD.LOAINHA_ID = ds[0]['loainha_id']

            if (ds[0]['vido_ld'] && ds[0]['vido_ld']) this.diachiLD.Lat = ds[0]['vido_ld']
            else this.diachiLD.Lat = 0
            if (ds[0]['kinhdo_ld'] && ds[0]['kinhdo_ld']) this.diachiLD.Lng = ds[0]['kinhdo_ld']
            else this.diachiLD.Lng = 0
            //Bo sung 20220715 - API tra ve lay_ds_diachi_theo_hdtbid
            if (ds[0]['diachildid']) this.diachild_id = ds[0]['diachildid']
            if (ds[0]['tinhldid']) this.diachiLD.TINH_ID = ds[0]['tinhldid']
            // else this.diachiLD.TINH_ID = 0;
            if (ds[0]['quanldid']) this.diachiLD.QUAN_ID = ds[0]['quanldid']
            // else this.diachiLD.QUAN_ID = 0;
            if (ds[0]['phuongldid']) this.diachiLD.PHUONG_ID = ds[0]['phuongldid']
            // else this.diachiLD.PHUONG_ID = 0;
            if (ds[0]['pholdid']) this.diachiLD.PHO_ID = ds[0]['pholdid']
            // else
            //     this.diachiLD.PHO_ID = 0;
            if (ds[0]['apldid']) this.diachiLD.AP_ID = ds[0]['apldid']
            // else
            //     this.diachiLD.AP_ID = 0;
            if (ds[0]['khuldid']) this.diachiLD.KHU_ID = ds[0]['khuldid']
            // else
            //     this.diachiLD.KHU_ID = 0;
            if (ds[0]['dacdiemldid']) this.diachiLD.DACDIEM_ID = ds[0]['dacdiemldid']
            // else
            //     this.diachiLD.DACDIEM_ID = 0;
            if (ds[0]['sonhald']) this.diachiLD.SO_NHA = this.ChuanHoaTen(ds[0]['sonhald'])

            if (ds[0]['blockld']) this.diachiLD.BLOCK = ds[0]['blockld']
            if (ds[0]['tangld']) this.diachiLD.TANG = ds[0]['tangld']
            if (ds[0]['phongld']) this.diachiLD.PHONG = ds[0]['phongld']
            if (ds[0]['motald']) this.diachiLD.MOTA = ds[0]['motald']

            if (ds[0]['dientichld']) this.diachiLD.DIENTICH = ds[0]['dientichld']
            if (ds[0]['sotangld']) this.diachiLD.SOTANG = ds[0]['sotangld']
            if (ds[0]['sophongld']) this.diachiLD.SOPHONG = ds[0]['sophongld']
            if (ds[0]['loainhald_id']) this.diachiLD.LOAINHA_ID = ds[0]['loainhald_id']

            // else this.diachiLD.SO_NHA = '';
            if (ds[0]['vidold'] && ds[0]['vidold']) this.diachiLD.Lat = ds[0]['vidold']
            // else
            //     this.diachiLD.Lat = 0;
            if (ds[0]['kinhdold'] && ds[0]['kinhdold']) this.diachiLD.Lng = ds[0]['kinhdold']
            // else
            //     this.diachiLD.Lng = 0;
            if (this.listbox.kieu_ld.value == KieuLapDat.TACH_VLAN) {
              this.diachiTB.DIACHI = ds[0]['diachi']
              this.diachiLD.DIACHI = ds[0]['diachi_ld']
            }

            if (ds[0]['diachiid']) this.diachitb_id = ds[0]['diachiid']
            if (ds[0]['diachildid']) this.diachild_id = ds[0]['diachildid']
            if (ds[0]['tinhid']) this.diachiTB.TINH_ID = ds[0]['tinhid']
            if (ds[0]['quanid']) this.diachiTB.QUAN_ID = ds[0]['quanid']
            if (ds[0]['phuongid']) this.diachiTB.PHUONG_ID = ds[0]['phuongid']
            if (ds[0]['phoid']) this.diachiTB.PHO_ID = ds[0]['phoid']
            // else
            //     this.diachiTB.PHO_ID = 0;
            if (ds[0]['apid']) this.diachiTB.AP_ID = ds[0]['apid']
            // else
            //     this.diachiTB.AP_ID = 0;
            if (ds[0]['khuid']) this.diachiTB.KHU_ID = ds[0]['khuid']
            // else
            //     this.diachiTB.KHU_ID = 0;
            if (ds[0]['dacdiemid']) this.diachiTB.DACDIEM_ID = ds[0]['dacdiemid']
            // else
            //     this.diachiTB.DACDIEM_ID = 0;

            // DOAN NAY DE FIX LOI DU LIEU RA KHONG CO DAU _
            if (ds[0]['tinhldid']) this.diachiLD.TINH_ID = ds[0]['tinhldid']
            // else this.diachiLD.TINH_ID = 0;
            if (ds[0]['quanldid']) this.diachiLD.QUAN_ID = ds[0]['quanldid']
            // else this.diachiLD.QUAN_ID = 0;
            if (ds[0]['phuongldid']) this.diachiLD.PHUONG_ID = ds[0]['phuongldid']
            // else this.diachiLD.PHUONG_ID = 0;
            if (ds[0]['pholdid']) this.diachiLD.PHO_ID = ds[0]['pholdid']
            // else
            //     this.diachiLD.PHO_ID = 0;
            if (ds[0]['apldid']) this.diachiLD.AP_ID = ds[0]['apldid']
            // else
            //     this.diachiLD.AP_ID = 0;
            if (ds[0]['khuldid']) this.diachiLD.KHU_ID = ds[0]['khuldid']
            // else
            //     this.diachiLD.KHU_ID = 0;
            if (ds[0]['dacdiemldid']) this.diachiLD.DACDIEM_ID = ds[0]['dacdiemldid']
            // else
            //     this.diachiLD.DACDIEM_ID = 0;
            if (ds[0]['sonhald']) this.diachiLD.SO_NHA = this.ChuanHoaTen(ds[0]['sonhald'])

            if (ds[0]['block']) this.diachiLD.BLOCK = ds[0]['block']
            if (ds[0]['tang']) this.diachiLD.TANG = ds[0]['tang']
            if (ds[0]['phong']) this.diachiLD.PHONG = ds[0]['phong']
            if (ds[0]['mota']) this.diachiLD.MOTA = ds[0]['mota']

            // else this.diachiLD.SO_NHA = '';
            if (ds[0]['vidold']) this.diachiLD.Lat = ds[0]['vidold']
            // else
            //     this.diachiLD.Lat = 0;
            if (ds[0]['kinhdold']) this.diachiLD.Lng = ds[0]['kinhdold']
            // else
            //     this.diachiLD.Lng = 0;

            if (this.listbox.kieu_ld.value == KieuLapDat.TACH_VLAN && ds[0]['diachild']) {
              this.diachiLD.DIACHI = ds[0]['diachild']
            }
            this.LAY_DONVI_THEO_LOAIDV_DIACHI_LD_V2() //phuongld_id, phold_id, apld_id, khuld_id, dacdiemld_id LINE 15387 -- bo qua tham so vi global san roi
            break
        }
      }
    },
    LAY_DONVI_THEO_LOAIDV_DIACHI_LD_V2() {
      let newval = this.diachiLD
      let pdata1 = {
        DT_CONTROLS: this.DT_CONTROLS.list,
        PHIEUHS_ID: this.PHIEUHS_ID ? this.PHIEUHS_ID : 0,
        PHUONG_ID: newval.PHUONG_ID ? newval.PHUONG_ID : 0,
        PHO_ID: newval.PHO_ID ? newval.PHO_ID : 0,
        AP_ID: newval.AP_ID ? newval.AP_ID : 0,
        KHU_ID: newval.KHU_ID ? newval.KHU_ID : 0,
        DACDIEM_ID: newval.DACDIEM_ID ? newval.DACDIEM_ID : 0,
        TTND_DV_ID: this.$root.token.getNguoiDungID(),
        HDKH_ID: this.khachhang.hdkh_id,
        CTV_ID: this.filterbox.ctv.value,
        NGUOIGT_ID: this.filterbox.nguoigt.value
      }
      let api = cache.getters.getFromCache('post_fn_lay_donvi_theo_loaidv_diachi_ld_v2', pdata1)
      if (!api) api = API.post_fn_lay_donvi_theo_loaidv_diachi_ld_v2(this.axios, { ds_para: JSON.stringify(pdata1) })
      else
        api = new Promise((resolve, reject) => {
          resolve(api)
        })

      //API.post_fn_lay_donvi_theo_loaidv_diachi_ld_v2(this.axios, { "ds_para":JSON.stringify(pdata1) }).then(
      api.then((response) => {
        cache.dispatch('addToCache', { key: 'post_fn_lay_donvi_theo_loaidv_diachi_ld_v2', subkey: pdata1, data: response })
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let dulieuapi = JSON.parse(response.data.data)
          if (dulieuapi['ERROR_CODE'] != 1) {
            this.$toast.error(dulieuapi['MESSAGE'])
            return
          }
          if (dulieuapi['RESULT']['DS_GT_DVI'] && dulieuapi['RESULT']['DS_GT_DVI'].length > 0 && this.DT_CONTROLS.data.length == dulieuapi['RESULT']['DS_GT_DVI'].length) {
            let dsValues = dulieuapi['RESULT']['DS_GT_DVI']
            for (var i = 0; i < this.DT_CONTROLS.data.length; i++) {
              if (dsValues[i]) this.DT_CONTROLS.value[i] = dsValues[i] // !this.DT_CONTROLS.value[i] &&  <- bo dieukien nay do khong load
              if (this.DT_CONTROLS.data[i] && this.DT_CONTROLS.data[i].length > 0) {
                if (!this.DT_CONTROLS.value[i]) this.DT_CONTROLS.value[i] = this.DT_CONTROLS.data[i][0].DONVI_ID
                if (this.DT_CONTROLS.data[i][0].LOAIDV_ID) this.DT_CONTROLS.tagvalue[i] = this.DT_CONTROLS.data[i][0].LOAIDV_ID
              }
            }
            this.DT_CONTROLS.dichvu_vt = this.listbox.dichvu_vt.value
            this.DT_CONTROLS.key += 1
          }
        }
      })
      //HienThi_PBH_KBH() // TODO co 1 dieu kien nao do goi den day, check lai sau.
    },
    LowerCasePropertyList(obj) {
      return obj.map(function(item) {
        for (let key in item) {
          let upper = key.toLowerCase()
          // check if it already wasn't uppercase
          if (upper !== key) {
            item[upper] = item[key]
            delete item[key]
          }
        }
        return item
      })
    },
    UpperCasePropertyList(obj) {
      return obj.map(function(item) {
        for (let key in item) {
          let upper = key.toUpperCase()
          // check if it already wasn't uppercase
          if (upper !== key) {
            item[upper] = item[key]
            delete item[key]
          }
        }
        return item
      })
    },
    async LayTienTheoKhoanMuc() {
      let muccuoc = 0
      if (
        this.listbox.dichvu_vt.value != DichVuVienThong.ADSL &&
        this.listbox.dichvu_vt.value != DichVuVienThong.MEGAWAN &&
        this.listbox.dichvu_vt.value != DichVuVienThong.METRONET &&
        this.listbox.dichvu_vt.value != DichVuVienThong.NOIBO_DADIEM &&
        this.listbox.dichvu_vt.value != DichVuVienThong.BRCD_DOITAC &&
        this.listbox.dichvu_vt.value != DichVuVienThong.MGW_DOITAC
      ) {
        this.kh_cd = 0
        this.ltb_adsl_id = 1
      } else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER) {
        //TODO chua lam do thuoc phan BB
        if (this.listbox.cboLoaiTB.value == LOAITBI_ADSL.ADSL) return
        if (this.listbox.kieu_ld.value == KieuLapDat.DM_ADSL_CO_SAN_DT || this.listbox.kieu_ld.value == KieuLapDat.DM_ADSL_KHONG_SO || this.listbox.kieu_ld.value == KieuLapDat.DM_ADSL_KEM_DT) return
        if (this.listbox.kieu_ld.value == KieuLapDat.MYTV_KHONGSO_CAPDONG) return
      } else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_1260) {
        if (this.listbox.kieu_ld.value == KieuLapDat.DM_CODINH) return
      }

      // let tocdo = this.tocdo_id;
      // muccuoc = this.muccuoc_id;
      if (this.listbox.dichvu_vt.value == 4) {
        //TODO xu ly sau vi khong thuoc phan co dinh
        this.muccuoc_id = this.listbox.muccuoc.value
        this.tocdo_id = this.listbox.cboGoiCuocAdsl.value
      }
      //UR 2.1.4.068
      let pdata = {
        vapld_id: this.diachiLD.AP_ID?this.diachiLD.AP_ID:0,
        vdichvuvt_id: this.listbox.dichvu_vt.value,
        vdoituong_id: this.listbox.doituong.value,
        vkh_cd: this.kh_cd,
        vkhuld_id: this.diachiLD.KHU_ID?this.diachiLD.KHU_ID:0,
        vkieuld_id: this.listbox.kieu_ld.value,
        vloaihd_id: 0,
        vloaitb_id: this.listbox.loaihinh_tb.value,
        vltb_adsl_cu_id: 0,
        vltb_adsl_id: this.ltb_adsl_id,
        vltb_adsl_moi_id: 0,
        vmuccuoc_id: this.muccuoc_id,
        vngay_yc: this.NgayYeuCau && (this.NgayYeuCau + '').trim().length > 10 ? (this.NgayYeuCau + '').trim().substring(0, 10) : this.NgayYeuCau,
        vphanvung_id: this.$root.token.getPhanVungID(),
        vphold_id: this.diachiLD.PHO_ID?this.diachiLD.PHO_ID:0,
        vphuongld_id: this.diachiLD.PHUONG_ID?this.diachiLD.PHUONG_ID:0,
        vtocdo_cu_id: this.tocdo_cu_id,
        vtocdo_id: this.tocdo_id,
        vtocdo_moi_id: this.tocdo_moi_id,
        vtrangbi_id: this.trangbi_id //BUG can xem lai cho nay khi khong dung cho co dinh
      }
      let api = cache.getters.getFromCache('get_lay_tien_khoanmuc_ld_v2', pdata)
      if (!api) api = API.get_lay_tien_khoanmuc_ld_v2(this.axios, { params: pdata })
      else
        api = new Promise((resolve, reject) => {
          resolve(api)
        })
      //await API.get_lay_tien_khoanmuc_ld_v2(this.axios,{"params":pdata}).then((response) => {
      await api.then((response) => {
        cache.dispatch('addToCache', { key: 'get_lay_tien_khoanmuc_ld_v2', subkey: pdata, data: response })
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let ds = response.data.data
          if (ds.length > 0) {
            this.HienThiTienLapDat(ds)
            this.LayTongTien_HDTB()
          } else {
            this.dtienld = 0
            this.dtiencd = 0
          }
        }
      })
    },
    HienThiTienLapDat(ds) {
      let kt_cd = true
      let kt_lm = true
      if (ds && ds.length > 0)
        for (var item of ds) {
          item.tien = item.tien * 1
          item.vat = item.vat * 1
          item.tyle_vat = item.tyle_vat * 1
        }
      if (ds[0]['tien'] != -1) {
        for (var i = 0; i < ds.length; i++) {
          if (ds[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
            this.dtiencd = ds[i]['tien']
            this.dvatcd = ds[i]['vat']
            this.vtyle_vat_id_cd = ds[i]['tyle_vat_id']
            this.vtyle_vat_cd = ds[i]['tyle_vat']

            kt_cd = false
          } else if (ds[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
            this.dtienld = ds[0]['tien']
            this.dvatld = ds[0]['vat']
            this.vtyle_vat_id_dnhm = ds[i]['tyle_vat_id']
            this.vtyle_vat_dnhm = ds[i]['tyle_vat']
            kt_lm = false
          } else if (ds[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_HOAMANG_DD_TRASAU) {
            //TODO hoan thien tu day
            // README thangdm1 chuyen doi this.listbox.tien_km.list -> this.ds_tien_khoanmuc 17/03/2023
            for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
              if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_HOAMANG_DD_TRASAU) {
                this.ds_tien_khoanmuc[j]['tien'] = ds[0]['tien'.toUpperCase()]
                this.ds_tien_khoanmuc[j]['vat'] = ds[0]['vat'.toUpperCase()]
              }
            }
          }
        }
        if (kt_cd == true) {
          this.dtiencd = 0
          this.dvatcd = 0
        }
        if (kt_lm == true) {
          this.dtienld = 0
          this.dvatld = 0
        }
      } else {
        this.dtienld = 0
        this.dvatld = 0
        this.dtiencd = 0
        this.dvatcd = 0
        this.vtyle_vat_id_dnhm = 1
        this.vtyle_vat_dnhm = 10
        this.vtyle_vat_id_cd = 1
        this.vtyle_vat_cd = 10
      }
      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATMOI) {
          this.ds_tien_khoanmuc[j]['tien'] = this.dtienld
          this.ds_tien_khoanmuc[j]['vat'] = this.dvatld
        }
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_CAIDAT) {
          this.ds_tien_khoanmuc[j]['tien'] = this.dtiencd
          this.ds_tien_khoanmuc[j]['vat'] = this.dvatcd
        }
      }
      this.HienThiTienKhuyenMaiLapDat()
    },
    //private void HienThiTienKhuyenMaiLapDat(decimal tien_kmld, decimal vat_kmld, decimal tien_datcoc, decimal tien_kmld_tt, decimal vat_kmld_tt, decimal dtiendatcoc_tt)
    HienThiTienKhuyenMaiLapDat() {
      // NOTE thay doi do tham so lay global, khong can thiet su dung tham so.
      let dtienkmld_tmp = this.kmld.dtienkmld * 1
      let dvatkmld_tmp = this.kmld.dvatkmld * 1
      let dtyle_kmld_tmp = this.kmld.tyle_kmld * 1
      if (Math.abs(dtienkmld_tmp) < Math.abs(this.kmld.dtienkmdc)) {
        dtienkmld_tmp = this.kmld.dtienkmdc*1
        dvatkmld_tmp = this.kmld.dvatkmdc*1
      }
      if (dtyle_kmld_tmp < this.kmld.tyle_kmld_tt) {
        dtyle_kmld_tmp = this.kmld.tyle_kmld_tt*1
      }
      if (dtyle_kmld_tmp > 0) {
        dtienkmld_tmp = this.round((this.dtienld * dtyle_kmld_tmp) / 100)
        dvatkmld_tmp = ((this.dtienld + this.dvatld) * dtyle_kmld_tmp) / 100 - dtienkmld_tmp
      }
      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT) {
          if (this.kmld.dtienkmld < 0) {
            this.ds_tien_khoanmuc[j]['tien'] = dtienkmld_tmp * -1
            this.ds_tien_khoanmuc[j]['vat'] = dvatkmld_tmp * -1
          } else {
            this.ds_tien_khoanmuc[j]['tien'] = dtienkmld_tmp*1
            this.ds_tien_khoanmuc[j]['vat'] = dvatkmld_tmp*1
          }
        }
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC) {
          this.ds_tien_khoanmuc[j]['tien'] = this.round(this.kmld.dtiendatcoc_tt*1)
          this.ds_tien_khoanmuc[j]['vat'] = this.round(this.kmld.dvatdatcoc_tt*1)
        }
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC_KM) {
          this.ds_tien_khoanmuc[j]['tien'] = this.round((this.kmld.dtiendatcoc_km * 10) / 11)
          this.ds_tien_khoanmuc[j]['vat'] = this.round(this.kmld.dtiendatcoc_km*1 / 11)
        }
      }
      this.LayTongTien_HDTB()
    },
    LayTongTien_HDTB() {
      // console.info('LayTongTien_HDTB 1',JSON.stringify(this.ds_tien_khoanmuc),this.tongtienkm,this.tongvatkm);
      // console.trace();
      try {
        let dtongtien = 0
        let dtongvat = 0
        if (this.ds_tien_khoanmuc && this.ds_tien_khoanmuc.length > 0)
          for (var item of this.ds_tien_khoanmuc) {
            item.tien = item.tien * 1
            item.vat = item.vat * 1
            item.tyle_vat = item.tyle_vat * 1
          }
        // console.info('LayTongTien_HDTB 3',JSON.stringify(this.ds_tien_khoanmuc),this.tongtienkm,this.tongvatkm);
        for (var i = 0; i < this.ds_tien_khoanmuc.length; i++) {
          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT || this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DATCOC) {
            if (this.ds_tien_khoanmuc[i]['tien'] < 0) {
              dtongtien += this.ds_tien_khoanmuc[i]['tien'] ? this.ds_tien_khoanmuc[i]['tien']*1 : 0
              dtongvat += this.ds_tien_khoanmuc[i]['vat'] ? this.ds_tien_khoanmuc[i]['vat']*1: 0
            } else {
              dtongtien += this.ds_tien_khoanmuc[i]['tien'] * -1
              dtongvat += this.ds_tien_khoanmuc[i]['vat'] * -1
            }
          }
          else if(this.thamsomacdinh['HT_KMTT']==1 && this.ds_tien_khoanmuc[i]['danhdau']==1) {
            dtongtien += this.ds_tien_khoanmuc[i]['tien'] ? this.ds_tien_khoanmuc[i]['tien']*1 : 0
            dtongvat += this.ds_tien_khoanmuc[i]['vat'] ? this.ds_tien_khoanmuc[i]['vat']*1: 0
          }
          else if (
            this.ds_tien_khoanmuc[i]['khoanmuctt_id'] != KHOANMUC_TT.KMTT_TRAGOP_THIETBI &&
            this.ds_tien_khoanmuc[i]['khoanmuctt_id'] != KHOANMUC_TT.KMTT_KM_THIETBI &&
            this.ds_tien_khoanmuc[i]['khoanmuctt_id'] != KHOANMUC_TT.KMTT_MUATHIETBI &&
            this.ds_tien_khoanmuc[i]['khoanmuctt_id'] != KHOANMUC_TT.KMTT_THUETHIETBI &&
            this.ds_tien_khoanmuc[i]['khoanmuctt_id'] != KHOANMUC_TT.KMTT_PHI_THUMOTLAN
          ) {
            dtongtien += this.ds_tien_khoanmuc[i]['tien'] ? this.ds_tien_khoanmuc[i]['tien']*1 : 0
            dtongvat += this.ds_tien_khoanmuc[i]['vat'] ? this.ds_tien_khoanmuc[i]['vat']*1 : 0
          }
          // console.info('LayTongTien_HDTB 4',JSON.stringify(this.ds_tien_khoanmuc[i]),dtongtien,dtongvat);
        }
        //duongpd them tinh tien cho dich vu SLL
        if (this.listbox.loaihinh_tb.value == 215) {
          for (var item of this.gridEditors) {
            //TODO load gridEditors tu khoang dong 32516 voi su kien bam nut repositoryItemButtonEdit_ButtonClick
            if (item.ID == 'SOLUONG') {
              dtongtien = ((item.Value ? item.Value*1 : '') ? 1 : item.Value * 1) * dtongtien*1
              dtongvat = ((item.Value ? item.Value*1 : '') ? 1 : item.Value * 1) * dtongvat*1
              break
            }
          }
        }
        this.tongtienkm = dtongtien ? dtongtien*1 : 0
        this.tongvatkm = dtongvat ? dtongvat*1 : 0
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
        throw ex
      }
      // console.info('LayTongTien_HDTB 2',JSON.stringify(this.ds_tien_khoanmuc),this.tongtienkm,this.tongvatkm);
      // console.trace();
    },
    HienThiDanhSacHDTT(ds) {
      this.listbox.thanhtoan.list = ds
      if (this.listbox.thanhtoan.list && this.listbox.thanhtoan.list.length > 0) for (var i = 0; i < this.listbox.thanhtoan.list.length; i++) this.listbox.thanhtoan.list[i].stt = i + 1
      this.buttons.tsbtnXoaTT = this.listbox.thanhtoan.list && this.listbox.thanhtoan.list.length > 0
      //THANGDM1 20211201 - Bo phan sau nay vi thay doi co che binding du lieu voi HTML Vue
      // this.lvwThanhToan = [];
      // if(ds.length>0) {
      //   for(var i=0;i<ds.length;i++) {
      //     let lvItem = [i+1];
      //     lvItem.push(ds[i]['hdtt_id']);
      //     lvItem.push(ds[i]['ma_tt']);
      //     lvItem.push(this.ChuanHoaTen(ds[i]['ten_tt']));
      //     lvItem.push(this.ChuanHoaTen(ds[i]['diachi_tt']));
      //     lvItem.push(this.ChuanHoaTen(ds[i]['diachi_ct']));
      //     this.lvwThanhToan.push(lvItem);
      //   }
      // }
      // console.log(this.lvwThanhToan,ds,this.listbox.thanhtoan.list);
      // if(this.lvwThanhToan.length>0) this.buttons.tsbtnXoaTT=true;
      // else this.buttons.tsbtnXoaTT = false;
    },
    async HienThiTTHopDongTT(ds) {
      if (ds && ds.length > 0) {
        this.hdtt_id = ds[0]['hdtt_id']
        this.thanhtoan.matt = ds[0]['ma_tt']
        if (ds[0]['thanhtoan_id']) this.thanhtoan.thanhtoan_id = ds[0]['thanhtoan_id']
        else this.thanhtoan.thanhtoan_id = 0

        this.thanhtoan.tentt = this.ChuanHoaTen(ds[0]['ten_tt'])
        this.diachiTT.DIACHI = ds[0]['diachi_tt']
        this.diachiBC.DIACHI = this.ChuanHoaTen(ds[0]['diachi_bc'])
        //HungHM-16/08/2010 - bổ xung thêm các column mới thêm vào bang hd_thanhtoan
        this.diachiCT.DIACHI = ds[0]['diachi_ct']

        this.thanhtoan.ghichu = ds[0]['ghichu']
        let dsDiaChiTT = []
        let DS_MA_DAIDIEN = []
        let MANVTC = ''
        let MA_TUYEN = ''
        let DS_DK_DVK = []
        await API.post_fn_lay_tt_hdtt(this.axios, { ds_para: JSON.stringify({ HDTT_ID: this.hdtt_id }) }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] == 1) {
              this.thanhtoan.hdmig_id = apidata['RESULT']['HDMIG_ID']
              this.thanhtoan.mainghep = apidata['RESULT']['MA_IG']
              dsDiaChiTT = this.LowerCasePropertyList(apidata['RESULT']['TT_DIACHIA_HDTT'])
              if (apidata['RESULT']['DS_MA_DAIDIEN'] && apidata['RESULT']['DS_MA_DAIDIEN'].length > 0) DS_MA_DAIDIEN = this.LowerCasePropertyList(apidata['RESULT']['DS_MA_DAIDIEN'])
              MANVTC = apidata['RESULT']['MANVTC']
              MA_TUYEN = apidata['RESULT']['MA_TUYEN']
              DS_DK_DVK = apidata['RESULT']['DS_DK_DVK']
            }
          }
        })
        if (!MA_TUYEN && ds[0]['ma_tuyen']) MA_TUYEN = ds[0]['ma_tuyen']
        if (!MANVTC && ds[0]['manv_tc']) MANVTC = ds[0]['manv_tc']

        if (!this.thanhtoan.hdmig_id || this.thanhtoan.hdmig_id == 0) {
          this.thanhtoan.hdmig_id = 0
          this.thanhtoan.mainghep = ''
        }

        this.nganhang.DV_QHNS = ds[0]['dv_qhns']
        this.nganhang.MACHUONG = ds[0]['machuong']
        this.nganhang.MN_KT = ds[0]['mn_kt']
        this.nganhang.MA_NDKT = ds[0]['ma_ndkt']
        this.nganhang.MN_NSNN = ds[0]['mn_nsnn']
        if (ds[0]['tien_dm']) this.nganhang.TIEN_DM = ds[0]['tien_dm']
        else this.nganhang.TIEN_DM = 0
        this.thanhtoan.masothue = ds[0]['mst']
        // if (ts_kt_mst_kh == 1)
        //     txtMST_TT2.Text = ds[0]["mst"];
        // else
        //     txtMST_TT.Text = ds[0]["mst"];
        this.listbox.nganhang.sotaikhoan = ds[0]['stk']
        this.thanhtoan.sodienthoai = ds[0]['so_dt']
        this.thanhtoan.email = ds[0]['email']
        this.thanhtoan.chutk = ds[0]['chu_tk']

        if (ds[0]['nganhang_id']) {
          this.listbox.nganhang.ischecked = true
          this.listbox.nganhang.value = ds[0]['nganhang_id']
        } else {
          this.listbox.nganhang.ischecked = false
        }

        this.HienThiTTDiaChi(dsDiaChiTT, 2) // LINE 13709
        if (DS_MA_DAIDIEN && DS_MA_DAIDIEN.length > 0) this.listbox.madaidien.list = DS_MA_DAIDIEN //Thay cho ca doan if else loang ngoang o day
        if (ds[0]['matb_dd']) this.listbox.madaidien.value = ds[0]['matb_dd']

        // if (ds[0]["nganhang_id"] != "")
        //     cboNganHang.EditValue = ds[0]["nganhang_id"];
        this.listbox.hinhthuc_tt.value = ds[0]['httt_id']
        if (ds[0]['httc_id']) this.listbox.hinhthuc_tc.value = ds[0]['httc_id']

        if (ds[0]['donvi_id']) this.listbox.donvi_ql.valueql = ds[0]['donvi_id']
        if (this.listbox.donvi_ql.valueql < 0) this.listbox.donvi_ql.valueql = 0

        if (ds[0]['nhanvien_id'] != '') {
          this.thanhtoan.nhanvientc_id = ds[0]['nhanvien_id']
          this.thanhtoan.manvtc = MANVTC
        } else {
          this.thanhtoan.nhanvientc_id = 0
          this.thanhtoan.manvtc = ''
        }

        if (ds[0]['tuyenthu_id'] != '') {
          this.thanhtoan.tuyenthu_id = ds[0]['tuyenthu_id']
          this.thanhtoan.matuyen = MA_TUYEN
        } else {
          this.thanhtoan.tuyenthu_id = 0
          this.thanhtoan.matuyen = ''
        }
        if (ds[0]['matb_dd']) this.listbox.madaidien.value = ds[0]['matb_dd']

        this.dsDK_DVK_TT = [...DS_DK_DVK] //Object.assign({}, DS_DK_DVK);
        this.HT_DichVuKhac(this.dsDK_DVK_TT, 2)

        this.HienThi_NVQL_AM_DB_HD(2, this.hdtt_id)
      }
    },
    HT_DichVuKhac(dset, vloaiid) {
      dset = this.LowerCasePropertyList(dset)
      if (vloaiid == 1) {
        this.lvDvkhac.list = dset
      } else {
        this.lvDvkhac_TT.list = dset
      }
    },
    HienThi_NVQL_AM_DB_HD(i_kieu, id) {
      API.post_sp_lay_nhanvien_ql(this.axios, { id: id, kieu: i_kieu }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          if (response.data.data.length <= 0) {
            this.thanhtoan.manvql = ''
            this.nhanvien_ql_am_id = 0
          } else {
            let nvql = response.data.data[0]
            this.thanhtoan.manvql = nvql['ma_nv'] + ' - ' + nvql['ten_nv']
            this.nhanvien_ql_am_id = nvql['nhanvien_id']
          }
        }
      })
    },
    Lay_DS_MucCuoc_TB(vkhuld_id, vapld_id, vphold_id, vphuongld_id, vloaitb_id, vdoituong_id, ngay) {
      this.tocdo_id = 0
      this.muccuoc_id = 0
      //this.listbox.muccuoc.value = 0;
      //let vmuccuoc_id = 0; //2 Lưu lượng // FIXME Thay bang listbox phia tren, can check lai!

      if (
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGA_IOT ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_SGTV ||
        this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES ||
        this.listbox.dichvu_vt.value == DichVuVienThong.HATANG_VIENTHONG ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_ANALOG ||
        this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL ||
        this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC
      ) {
        this.tocdo_id = this.listbox.cboGoiCuocAdsl.value
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER || this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGA_IOT || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL) this.muccuoc_id = this.listbox.muccuoc.value //vmuccuoc_id = Convert.ToInt32(cboMucCuoc.SelectedValue);
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT || this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT || this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU || this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH) {
        if (this.ItemList.length <= 0) {
          this.tocdo_id = -2
          this.muccuoc_id = -2
        } else {
          for (var index1 = 0; index1 < this.ItemList.length; ++index1) {
            if (this.ItemList[index1].sFieldName == 'TOCDO_ID') {
              if (this.ItemList[index1].sValue != '') {
                this.tocdo_id = this.ItemList[index1].sValue
                break
              }
            }
          }
        }
      }
      //TODO chua lam doan nay vi khong thuoc phan CODINH
      // DataSet ds = new DataSet();
      // int vtrangbi_id = 0;
      // if (cboLoaihinhTB.SelectedValue != null && cboLoaihinhTB.SelectedValue == LoaiHinhTB.INTERNET_MYTV
      //     && cboTrangBiADSL.Items.Count > 0)
      //     vtrangbi_id = Convert.ToInt32(cboTrangBiADSL.SelectedValue);
      // ds = tcdanhba.LAY_DS_MUCUOC_TB_V2(vkhuld_id, vapld_id, vphold_id, vphuongld_id, vloaitb_id, vdoituong_id, vtocdo_id, vmuccuoc_id, ngay, vtrangbi_id);
      // API.post_lay_ds_mucuoc_tb_v2(this.axios,pdata).then((response) => {
      //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //     this.listbox.muccuoc_tb.list = response.data.data;
      //   }
      // });
      // if (ds.Count > 0)
      // {
      //     cboMucCuocTB.DataSource = ds.Tables[0];
      //     cboMucCuocTB.ValueMember = "mucuoctb_id";
      //     cboMucCuocTB.DisplayMember = "tenmuccuoc";
      // }
      // else
      // {
      //     cboMucCuocTB.DataSource = null;
      //     txtCSD_FIBER_TK.Text = "0";
      // }
      this.LoadMucCuocTB()
    },
    async HT_DichVuGT() {
      let kt = true // Kiểm tra xem có đăng ký dịch vụ nào không, nếu không trả tiền dv, vatdv về 0
      this.dvgt.tien_dv = 0
      this.dvgt.vat_dv = 0
      this.dvgt.tien_km_dvgt = 0
      this.dvgt.vat_km_dvgt = 0
      let dTyLe_KM_DVGT = 0
      let dtien_kmdvgt_tmp = 0
      let dvat_kmdvgt_tmp = 0
      this.lvDvgt.list = []
      let str = ''
      this.m_dsThueBao_DichVu = this.LowerCasePropertyList(this.m_dsThueBao_DichVu)
      for (var i = 0; i < this.m_dsThueBao_DichVu.length; i++) {
        if (this.m_dsThueBao_DichVu[i]['huy'] == '1' || this.m_dsThueBao_DichVu[i]['dangky'] == '1') {
          str = this.m_dsThueBao_DichVu[i]['ten_dvgt']
          if (this.m_dsThueBao_DichVu[i]['dangky'] == '1' && this.m_dsThueBao_DichVu[i]['huy'] == '0') {
            kt = false
            //Hiếu bổ sung code tính tiền dịch vụ
            if (this.m_dsThueBao_DichVu[i]['cuoc_ld'] != '') {
              this.dvgt.tien_dv = this.dvgt.tien_dv + this.m_dsThueBao_DichVu[i]['cuoc_ld']
            }
            if (this.m_dsThueBao_DichVu[i]['vat_ld'] != '') {
              this.dvgt.vat_dv = this.dvgt.vat_dv + this.m_dsThueBao_DichVu[i]['vat_ld']
            }

            str = str + ' (ĐK)'
            let dtTMP_KMDVGT = []
            await API.post_ctkm_dvgt(this.axios, { dschitietkm_id: this.ds_CTKM(), dichvugt_id: this.m_dsThueBao_DichVu[i]['dichvugt_id'] }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                dtTMP_KMDVGT = response.data.data
              }
            })
            if (dtTMP_KMDVGT.length > 0) {
              dTyLe_KM_DVGT = dtTMP_KMDVGT[0]['tyle_giamcuoc_ld']
            } // hoangpkn : 13/12/2018. Thêm đoạn else
            else {
              dtien_kmdvgt_tmp = 0
              dvat_kmdvgt_tmp = 0
              dTyLe_KM_DVGT = 0
            }

            if (dTyLe_KM_DVGT > 0) {
              dtien_kmdvgt_tmp = this.round((this.m_dsThueBao_DichVu[i]['cuoc_ld'] * dTyLe_KM_DVGT) / 100)
              dvat_kmdvgt_tmp = this.round((this.m_dsThueBao_DichVu[i]['vat_ld'] * dTyLe_KM_DVGT) / 100)
            }
            if (dtTMP_KMDVGT.length > 0) {
              this.m_dsThueBao_DichVu[i]['cuoc_kmld'] = dtien_kmdvgt_tmp
              this.m_dsThueBao_DichVu[i]['vat_kmld'] = dvat_kmdvgt_tmp
              this.dvgt.tien_km_dvgt += dtien_kmdvgt_tmp
              this.dvgt.vat_km_dvgt += dvat_kmdvgt_tmp
            }
          }
          if (this.m_dsThueBao_DichVu[i]['huy'] == '1') str = str + ' (Hủy)'
          this.lvDvgt.list.push(str)
        }
      }
      if (kt == true) {
        this.dvgt.tien_dv = 0
        this.dvgt.vat_dv = 0
      }
      this.HienThiTienDichVu(this.dvgt.tien_dv, this.dvgt.vat_dv)
      this.HienThiTienKhuyenMai_DVGT(this.dvgt.tien_km_dvgt, this.dvgt.vat_km_dvgt)
    },
    HienThiTienDichVu(tien_dv, vat_dv) {
      this.dichvu.dtien_dv = tien_dv
      this.dichvu.dvat_dv = vat_dv
      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DICHVU) {
          this.ds_tien_khoanmuc[j]['tien'] = tien_dv
          this.ds_tien_khoanmuc[j]['vat'] = vat_dv
        }
      }

      this.LayTongTien_HDTB()
    },
    HienThiTienKhuyenMai_DVGT(tien_kmdvgt, vat_kmdvgt) {
      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DVGT) {
          if (tien_kmdvgt > 0) {
            this.ds_tien_khoanmuc[j]['tien'] = tien_kmdvgt * -1
            this.ds_tien_khoanmuc[j]['vat'] = vat_kmdvgt * -1
          } else {
            this.ds_tien_khoanmuc[j]['tien'] = tien_kmdvgt
            this.ds_tien_khoanmuc[j]['vat'] = vat_kmdvgt
          }
        }
      }

      this.LayTongTien_HDTB()
    },
    ds_CTKM() {
      let sDS = '-1'
      for (var km of this.dsKM_HDTB) {
        if (km['chitietkm_id']) sDS = sDS + ',' + km['chitietkm_id']
      }
      for (var km of this.dsDC_HDTB) {
        if (km['chitietkm_id']) sDS = sDS + ',' + km['chitietkm_id']
      }
      return '' + sDS
    },
    async HienThiTTMoRong(hdtb_id, dichvuvt_id) {
      let ds = []
      let dt = []
      if (this.ma_tb_ht && !this.ma_tb) this.ma_tb = this.ma_tb_ht //chua biet tai sao khong co du lieu cho this.ma_tb -> kiem tra thay ma_tb_ht co du lieu can thiet -> gan tam o day!
      switch (dichvuvt_id * 1) {
        case DichVuVienThong.CO_DINH:
          if (this.ma_tb) this.thuebao.codinh.somay = this.ma_tb
          // Ham dung chugn -> bo ra ngoai switch case
          // await API.post_fn_hienthi_tt_morong(this.axios, { "ds_para": JSON.stringify({"HDTB_ID":hdtb_id,"DICHVUVT_ID":dichvuvt_id,"LOAITB_ID":0}) }).then((response) => {
          //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          //     let apidata = JSON.parse(response.data.data);
          //     if(apidata['RESULT']) apidata = apidata['RESULT'];
          //     if(apidata['DS_HDTB']) ds = apidata['DS_HDTB'];
          //     if(apidata['DS_TIEN_CAMKET']) dt = apidata['DS_TIEN_CAMKET'];
          //   }
          // });
          // ds = this.LowerCasePropertyList(ds);
          // dt = this.LowerCasePropertyList(dt);
          break
        case DichVuVienThong.MEGAWAN:
        case DichVuVienThong.METRONET:
        case DichVuVienThong.MGW_DOITAC:
        case DichVuVienThong.NOIBO_DADIEM:
          if (this.ma_tb) this.thuebao.mgwan.somay = this.ma_tb
          break
        case DichVuVienThong.DI_DONG:
          this.thuebao.didong.txtSoMayDD = this.ma_tb
          //ds = tchopdong.LAY_DS_HDTB_DD_THEO_HDTB_ID(hdtb_id);
          break
        case DichVuVienThong.DICHVU_CNTT:
        case DichVuVienThong.HOINGHI_TRUYENHINH:
        case DichVuVienThong.ANTOAN_BAOMAT_TT:
        case DichVuVienThong.TRUNGTAM_DULIEU:
          // ds = new DataSet();
          // ds = tchopdong.LAY_DS_HDTB_CNTT_THEO_HDTB_ID(hdtb_id);
          this.dsHDTB_CT = [] //new List<HD_THUEBAO_CT>();
          break
        case DichVuVienThong.ADSL:
        case DichVuVienThong.HATANG_VIENTHONG:
        case DichVuVienThong.BRCD_DOITAC:
          this.thuebao.adsl.txtAccountADSL = this.ma_tb
          break
        case DichVuVienThong.MEGA_EYES:
          this.thuebao.adsl.txtAccountADSL = this.ma_tb
          break
        case DichVuVienThong.TSL:
        case DichVuVienThong.TSL_DOITAC:
        case DichVuVienThong.NOIBO_2DIEM:
          this.thuebao.tsl.txtMaTSL.Text = this.ma_tb
          break
        case DichVuVienThong.GPHONE:
          this.thuebao.gphone.txtSoMayGP = this.ma_tb
          break
        case DichVuVienThong.IMS:
        case DichVuVienThong.IMS_DOITAC:
          this.thuebao.ims.txtMaTBIMS = this.ma_tb
          break
        default:
          break
      }
      let apidata = {}
      await API.post_fn_hienthi_tt_morong(this.axios, { ds_para: JSON.stringify({ HDTB_ID: hdtb_id, DICHVUVT_ID: dichvuvt_id, LOAITB_ID: this.listbox.loaihinh_tb.value }) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          apidata = JSON.parse(response.data.data)
          if (apidata['RESULT']) apidata = apidata['RESULT']
          if (apidata['DS_HDTB']) ds = apidata['DS_HDTB']
          if (apidata['DS_TIEN_CAMKET']) dt = apidata['DS_TIEN_CAMKET']
        }
      })
      ds = this.LowerCasePropertyList(ds)
      dt = this.LowerCasePropertyList(dt)
      if (ds.length > 0) {
        this.ma_tb_ao = ''
        this.thuebao.cvlct = false
        this.thuebao.congvan = ''
        this.thuebao.NgayCV = moment(new Date()).format('DD/MM/YYYY')
        this.thuebao.crm = ''
        this.thuebao.erp = ''
        this.thuebao.vtn = ''
        if (ds[0]['ma_vnpt']) this.ma_vnpt = ds['ma_vnpt']
        else this.ma_vnpt = -1

        switch (dichvuvt_id * 1) {
          case DichVuVienThong.CO_DINH:
            this.chkVSVX = ds[0]['mc_tbcd_id'] == '1'
            this.chkMienCuocTB = ds[0]['miencuoc_tb'] == '1'
            this.thuebaocd.madoicap = ds[0]['madoicap']
            this.thuebaocd.matn = ds[0]['matb_tn']
            if (ds[0]['sotruot']) {
              this.thuebaocd.kieu_thueso = THUESO.TRUOTSO
              this.thuebaocd.sothang_thueso = ds[0]['tg_thueso']
              this.thuebaocd.noidung_thueso = ds[0]['sotruot']
            }
            if (ds[0]['noidung_tb'] != '') {
              this.thuebaocd.kieu_thueso = THUESO.THONGBAO
              this.thuebaocd.sothang_thueso = ds[0]['tg_thueso']
              this.thuebaocd.noidung_thueso = ds[0]['noidung_tb']
            }
            if (ds[0]['sotruot'] == '' && ds[0]['noidung_tb'] == '') {
              this.thuebaocd.kieu_thueso = 0
              this.thuebaocd.sothang_thueso = 0
              this.thuebaocd.noidung_thueso = ''
            }

            if (ds[0]['doitac_id']) {
              this.listbox.doitac.ischeckedcd = true
              this.listbox.doitac.valuecd = ds[0]['doitac_id']
              this.thuebaocd.cuocdoitac = ds[0]['cuoc_doitac']
            } else {
              this.listbox.doitac.ischeckedcd = false
              this.thuebaocd.cuocdoitac = '0'
            }

            if (ds[0]['congnghe_id']) this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = 0

            if (ds[0]['trangbi_id']) this.listbox.trangbi.valuecd = ds[0]['trangbi_id']
            if (ds[0]['chuquan_id']) this.listbox.chu_quan.valuecd = ds[0]['chuquan_id']
            if (ds[0]['chuquanld_id']) this.listbox.chu_quan.valueldcd = ds[0]['chuquanld_id']
            this.thuebao.codinh.dgvTienCK.list = [];
            this.thuebao.codinh.dgvTienCK.list = dt
            break
          case DichVuVienThong.IMS:
            this.thuebao.ims.txtMaTN_IMS = ds[0]['matb_tn']
            this.thuebao.ims.txtMaDoiCap_IMS = ds[0]['madoicap']
            if (ds[0]['chuquan_id']) this.listbox.chu_quan.valueims = ds[0]['chuquan_id']
            if (ds[0]['chuquanld_id']) this.listbox.chu_quan.valueldims = ds[0]['chuquanld_id']
            if (ds[0]['trangbi_id']) this.listbox.trangbi.valueims = ds[0]['trangbi_id']

            if (ds[0]['doitac_id']) {
              this.thuebao.ims.chkDoiTac_IMS = true
              this.thuebao.ims.cboDoiTac_IMS.value = ds[0]['doitac_id']
              this.thuebao.ims.txtCuocDT_IMS = ds[0]['cuoc_doitac']
            } else {
              this.thuebao.ims.chkDoiTac_IMS = false
              this.thuebao.ims.txtCuocDT_IMS = 0
            }

            if (ds[0]['congnghe_id']) this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = -1

            this.thuebao.ims.txtCuocGoiDT = ds[0]['sl_cuocgoi']
            if (ds[0]['ctdv_id']) this.listbox.ht_chitietdv_ims.value = ds[0]['ctdv_id']
            this.thuebao.ims.txtIp_IMS = ds[0]['ip']

            this.thuebao.ims.pass_ims = ds[0]['password']
            this.thuebao.ims.dgvTienCKIMS.list = [];
            this.thuebao.ims.dgvTienCKIMS.list = dt
            break

          case DichVuVienThong.DI_DONG:
            await API.post_sp_ht_goicuoc_dd(this.axios, { loaitb_id: this.listbox.loaihinh_tb.value }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.thuebao.didong.cboGoiCuocDD.list = response.data.data
                if (this.thuebao.didong.cboGoiCuocDD.list && this.thuebao.didong.cboGoiCuocDD.list.length > 0) this.thuebao.didong.cboGoiCuocDD.value = this.thuebao.didong.cboGoiCuocDD.list[0].goicuoc_id
              }
            })
            this.thuebao.didong.txtSimDD = ds[0]['simcard']
            this.thuebao.didong.txtTienDuTK = ds[0]['tien_dtk'] ? ds[0]['tien_dtk'] : 0
            this.thuebao.didong.cboGoiCuocDD.value = ds[0]['goicuoc_id'] * 1 // HungHM-16/07/2010: bo xung them column GOICUOC_ID.
            this.thuebao.didong.txtSoMayNTK = ds[0]['somay_ntk'] // HungHM-26/07/2010: bo xung them column SOMAY_NTK
            if (ds[0]['trangbi_id']) this.listbox.trangbi.valuedd = ds[0]['trangbi_id']
            if (ds[0]['chuquan_id'])
              // vuth update fix 1509
              this.listbox.chu_quan.valuedd = ds[0]['chuquan_id']
            break

          case DichVuVienThong.MEGAWAN:
          case DichVuVienThong.METRONET:
          case DichVuVienThong.MGW_DOITAC:
          case DichVuVienThong.NOIBO_DADIEM:
            this.listbox.tocdokenh.valuecir = ds[0]['tocdo_id']
            if (ds[0]['tocdo_pir_id']) {
              this.listbox.tocdokenh.ischeckedpir = true
              this.listbox.tocdokenh.valuepir = ds[0]['tocdo_pir_id']
            } else {
              this.listbox.tocdokenh.ischeckedpir = false
              this.listbox.tocdokenh.valuepir = ds[0]['tocdo_id']
            }

            if (ds[0]['congnghe_id']) this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = -1

            if (ds[0]['phanloai_id']) this.listbox.phanloai_dv.value = ds[0]['phanloai_id']
            else this.listbox.phanloai_dv.value = 0

            if (ds[0]['phantach_td']) this.listbox.ht_phantach_tocdo.value = ds[0]['phantach_td']
            else
              try {
                this.listbox.ht_phantach_tocdo.value = this.listbox.ht_phantach_tocdo.list[0].phantach_id
              } catch (ex) {
                this.listbox.ht_phantach_tocdo.value = 0
              }

            if (ds[0]['tinh_kn_id']) this.listbox.tinh_kn.value = ds[0]['tinh_kn_id']
            else this.listbox.tinh_kn.value = 0

            this.thuebao.cvlct = true
            if (ds[0]['ma_cv']) {
              this.thuebao.cvlct = true
              this.thuebao.congvan = ds[0]['ma_cv']
              this.NgayCV = ds[0]['ngay_cv']
            }

            this.thuebao.crm = ds[0]['MA_CRM']
            this.thuebao.erp = ds[0]['ID_ERP']
            this.thuebao.vtn = ds[0]['MAKENH_VTN']

            this.thuebao.mgwan.lanip = ds[0]['lan_ip']
            this.thuebao.mgwan.wanip = ds[0]['wan_ip']
            this.thuebao.mgwan.vrfvfi = ds[0]['vrf']

            this.listbox.loaimodem.value = ds[0]['loaimd_id']
            this.listbox.loaikenh.value = ds[0]['loaikenh_id']
            this.listbox.loai_tb.valuemgwan = ds[0]['thietbidc_id']
            this.loaisowan = ds[0]['loainode_id']
            this.buttons.btnHuongKNWan = this.loaisowan * 1 == LOAINODE_MGWAN.NODE_CHINH
            this.diachiKN.DIACHI = ds[0]['diachi_kn']
            this.thuebao.mgwan.huongkn = ds[0]['huong_kn']
            this.thuebao.mgwan.vhuongkn = ds[0]['huong_kn']
            //HungHM - 07/09/2010
            this.listbox.thoihan.valuewan = ds[0]['thoihan_id']
            this.listbox.trangbi.valuewan = ds[0]['trangbi_id']
            this.listbox.chu_quan.valuewan = ds[0]['chuquan_id']
            if (ds[0]['chuquanld_id']) this.listbox.chu_quan.valueldmgwan = ds[0]['chuquanld_id']

            this.thuebao.mgwan.madoicap = ds[0]['madoicap']
            this.thuebao.mgwan.soao = ds[0]['ma_lt']
            this.ma_tb_ao = ds[0]['ma_lt']
            this.thuebao.mgwan.mahdttkd = ds[0]['ma_pl']
            this.thuebao.mgwan.siteid = ds[0]['site_id']
            this.listbox.loaicap.value = ds[0]['loaicap_id']
            if (ds[0]['giukenh']) {
              this.thuebao.mgwan.luonggiukenh = ds[0]['giukenh'] == '1'
            }
            if (ds[0]['doitac_id']) {
              this.listbox.doitacwan.isenabled = true
              this.listbox.doitacwan.value = ds[0]['doitac_id']
              this.thuebao.mgwan.cuoctk_dt = ds[0]['cuoc_tkdt'] ? ds[0]['cuoc_tkdt'] : 0
              this.thuebao.mgwan.cuoctc_dt = ds[0]['cuoc_tcdt'] ? ds[0]['cuoc_tcdt'] : 0
              this.thuebao.mgwan.hopdong_dt = ds[0]['mahd_dt']
            } else {
              this.listbox.doitacwan.isenabled = false
              this.thuebao.mgwan.cuoctk_dt = 0
              this.thuebao.mgwan.cuoctc_dt = 0
              this.thuebao.mgwan.hopdong_dt = ''
            }

            this.thuebao.mgwan.matn = ds[0]['matb_tn']
            this.thuebao.mgwan.cuoctc = ds[0]['cuoc_tc'] ? ds[0]['cuoc_tc'] : 0
            this.thuebao.mgwan.cuoctk = ds[0]['cuoc_tk'] ? ds[0]['cuoc_tk'] : 0
            this.thuebao.mgwan.cuoctbi = ds[0]['cuoc_tbi'] ? ds[0]['cuoc_tbi'] : 0
            this.thuebao.mgwan.cuocht = ds[0]['cuoc_ht'] ? ds[0]['cuoc_ht'] : 0

            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MGW_INTERNET_TRUCTIEP || this.listbox.loaihinh_tb.value == LoaiHinhTB.NB_INTERNETTT) {
              if (ds[0]['tocdo_nix']) {
                this.listbox.tocdokenh.ischeckednix = true
                this.listbox.tocdokenh.valuenix = ds[0]['tocdo_nix']
              } else {
                this.listbox.tocdokenh.ischeckednix = false
                this.listbox.tocdokenh.valuenix = 0
              }

              if (ds[0]['tocdo_isp']) {
                this.listbox.tocdokenh.ischeckedisp = true
                this.listbox.tocdokenh.valueisp = ds[0]['tocdo_isp']
              } else {
                this.listbox.tocdokenh.ischeckedisp = false
                this.listbox.tocdokenh.valueisp = 0
              }

              if (ds[0]['sl_ip']) this.thuebao.mgwan.soluongip = ds[0]['sl_ip']
              else this.thuebao.mgwan.soluongip = 0

              if (ds[0]['cuoc_ip']) this.thuebao.mgwan.cuocip = ds[0]['cuoc_ip']
              else this.thuebao.mgwan.cuocip = 0

              if (ds[0]['cuoc_nix']) this.thuebao.mgwan.cuocnix = ds[0]['cuoc_nix']
              else this.thuebao.mgwan.cuocnix = 0

              if (ds[0]['cuoc_isp']) this.thuebao.mgwan.cuocisp = ds[0]['cuoc_isp']
              else this.thuebao.mgwan.cuocisp = 0
            } else {
              this.thuebao.mgwan.soluongip = 0
              this.thuebao.mgwan.cuocip = 0
              this.thuebao.mgwan.cuocnix = 0
              this.thuebao.mgwan.cuocisp = 0
              this.listbox.tocdokenh.valueisp = 0
              this.listbox.tocdokenh.valuenix = 0
            }
            break
          case DichVuVienThong.ADSL:
          case DichVuVienThong.HATANG_VIENTHONG:
          case DichVuVienThong.BRCD_DOITAC:
            this.thuebao.adsl.txtEmailAdsl = ds[0]['email']
            this.thuebao.adsl.txtSL_Tivi = ds[0]['sltv_htvc']
            this.thuebao.adsl.txtDienThoai_Fsecure = ds[0]['so_dt'] // số điện thoại Fsecure

            this.listbox.thoihan.valueadsl = ds[0]['thoihan_id']
            //created by kylq.hcm
            //Bổ sung cho megaIOT
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGA_IOT) {
              this.thuebao.adsl.megaIOT_vrf = ds[0]['vrf']
              this.thuebao.adsl.megaIOT_HuongKN = ds[0]['huong_kn']
              this.thuebao.adsl.megaIOT_LanIP = ds[0]['ip']
              this.thuebao.adsl.megaIOT_WanIP = ds[0]['ipv4_wan']
              this.thuebao.adsl.txtMaTB_KN = this.thuebao.adsl.megaIOT_HuongKN
            }

            if (ds[0]['congnghe_id'] != '') this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = 0

            if (ds[0]['kh_cd'] == '1') this.thuebao.adsl.ckTuCaiADSL = true
            else this.thuebao.adsl.ckTuCaiADSL = false

            if (ds[0]['chuquan_id']) this.listbox.chu_quan.valueadsl = ds[0]['chuquan_id']

            if (ds[0]['chuquanld_id']) this.listbox.chu_quan.valueldadsl = ds[0]['chuquanld_id']

            if (ds[0]['doitac_id'] && ds[0]['doitac_id'] != '') {
              this.listbox.doitac.ischeckedadsl = true
              this.listbox.doitac.valueinternet = ds[0]['doitac_id']
              this.thuebao.adsl.txtCuocDT_Internet = ds[0]['cuoc_doitac']
            } else {
              this.listbox.doitac.ischeckedadsl = false
              this.thuebao.adsl.txtCuocDT_Internet = 0
            }

            this.tocdo_id = ds[0]['tocdo_id']
            this.listbox.cboGoiCuocAdsl.value = 0
            this.$nextTick(() => {
              this.listbox.cboGoiCuocAdsl.value = ds[0]['tocdo_id']
              this.HT_GIAODIEN_DONVI();
            })
            //Cuong moi them
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
              this.listbox.cboLoaiIP.values = apidata['DS_LOAIIP'] // xu ly het doan code ben duoi
              if (this.listbox.cboLoaiIP.values && this.listbox.cboLoaiIP.values.length > 0) {
                this.listbox.cboLoaiIP.value = this.listbox.cboLoaiIP.values[0].loaiip_id
                this.listbox.cboLoaiIP.valueitems = []
                for (var item of this.listbox.cboLoaiIP.values) {
                  var item1 = this.listbox.cboLoaiIP.list.find((x) => x.loaiip_id == item.LOAIIP_ID)
                  if (item1 && item1.loaiip_id && item1.loaiip_id > 0) this.listbox.cboLoaiIP.valueitems.push(item1)
                }
                this.listbox.cboLoaiIP.valueitems = this.listbox.cboLoaiIP.valueitems.map((lo) => ({ id: lo.loaiip_id, text: lo.loai_ip }))
                this.listbox.cboLoaiIP.values = this.listbox.cboLoaiIP.valueitems.map((x) => x.id)
              }
              // if (this.listbox.cboLoaiIP.list && this.listbox.cboLoaiIP.list.length > 0)
              // {
              //     let ds_lip = laphd2.GET_DATA_PROC("{?DB2}.lay_ds_loaiip_theo_hdtb_id", "in_hdtb_id", hdtb_id);
              //     if (ds_lip != null && ds_lip.Rows.Count > 0)
              //     {
              //         ds_lip.AcceptChanges();
              //         for (int i = 0; i < cboLoaiIP.Properties.Items.Count; i++)
              //         {
              //             if (ds_lip.Select("LOAIIP_ID=" + cboLoaiIP.Properties.Items[i].Value + "").Length > 0)
              //             {
              //                 cboLoaiIP.Properties.Items[i].CheckState = CheckState.Checked;
              //             }
              //             else
              //                 cboLoaiIP.Properties.Items[i].CheckState = CheckState.Unchecked;
              //         }
              //     }
              // }
            }

            this.listbox.cboTocDoThucADSL.value = -1
            if (ds[0]['tocdothuc_id'] != '') this.listbox.cboTocDoThucADSL.value = ds[0]['tocdothuc_id']
            else this.listbox.cboTocDoThucADSL.value = -1

            if (this.listbox.cboTocDoThucADSL.value != null && this.listbox.cboGoiCuocAdsl.value != this.listbox.cboTocDoThucADSL.value) this.thuebao.adsl.chkTocDoThuc = true

            this.listbox.muccuoc.value = ds[0]['muccuoc_id']
            if (ds[0]['thietbidc_id'] != '') this.listbox.cboLoaiTB.value = ds[0]['thietbidc_id']
            this.thuebao.adsl.txtMaDoiCap_ADSL = ds[0]['madoicap']
            this.thuebao.adsl.txtMaTN_ADSL = ds[0]['matb_tn']
            this.thuebao.adsl.txtSoAoAdsl = ds[0]['ma_lt']
            this.ma_tb_ao = ds[0]['ma_lt']
            //this.ma_tb_ao_ht = ds[0]["ma_lt"]; // FIXME Can xem lai cho nay vi ma_lt o ham ghi lai dung ma_tb_ao_ht, khong phai ma_tb_ao
            this.listbox.cboKieuTra.value = ds[0]['kieutra_id']
            if (ds[0]['kieutra_id'] == 1) this.listbox.cboThangTra.value = ds[0]['thang_id']

            if (ds[0]['trangbi_id']) this.listbox.trangbi.valueadsl = ds[0]['trangbi_id']
            this.thuebao.adsl.txtTTCuoc = ds[0]['thongtin_tc']
            this.thuebao.adsl.pass_adsl = ds[0]['password']

            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC) {
              if (ds[0]['cuoc_sd'] != '') this.thuebao.adsl.txtCSD_FIBER_TK = ds[0]['cuoc_sd']
              else this.thuebao.adsl.txtCSD_FIBER_TK = 0

              if (ds[0]['cuoc_tbi'] != '') this.thuebao.adsl.txtCTB_FIBER_TK = ds[0]['cuoc_tbi']
              else this.thuebao.adsl.txtCTB_FIBER_TK = 0
            } else {
              this.thuebao.adsl.txtCSD_FIBER_TK = 0
              this.thuebao.adsl.txtCTB_FIBER_TK = 0
            }

            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.COSO_HATANG) {
              if (ds[0]['doitac_id'] != '') this.listbox.cboDoiTac_CSHT.value = ds[0]['doitac_id']

              if (ds[0]['loai_csht_id'] != '') this.listbox.cboLoai_CSHT.value = ds[0]['loai_csht_id']
            }
            this.thuebao.adsl.txtSerialSTB = ds[0]['serial_stb']
            break
          case DichVuVienThong.MEGA_EYES:
            //txtMaTN_ADSL.Text = ds.Tables[0].Rows[0]["so_dt"].ToString();
            this.thuebao.adsl.txtEmailAdsl = ds[0]['email']
            if (ds[0]['kh_cd'] == 1) this.thuebao.adsl.ckTuCaiADSL = true
            else this.thuebao.adsl.ckTuCaiADSL = false

            if (ds[0]['congnghe_id']) this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = -1

            this.tocdo_id = ds[0]['tocdo_id']
            this.listbox.cboGoiCuocAdsl.value = ds[0]['tocdo_id']
            await this.HT_GIAODIEN_DONVI();
            this.listbox.muccuoc.value = ds[0]['muccuoc_id']
            this.listbox.cboLoaiTB.value = ds[0]['thietbidc_id']
            this.thuebao.adsl.txtMaDoiCap_ADSL = ds[0]['madoicap']
            this.thuebao.adsl.txtMaTN_ADSL = ds[0]['matb_tn']
            this.thuebao.adsl.txtSoAoAdsl = ds[0]['ma_lt']
            this.ma_tb_ao = ds[0]['ma_lt']
            this.listbox.cboKieuTra.value = ds[0]['kieutra_id']
            if (ds[0]['kieutra_id'] == 1) this.listbox.cboThangTra.value = ds[0]['thang_id']

            if (ds[0]['trangbi_id']) this.listbox.trangbi.valueadsl = ds[0]['trangbi_id']

            this.thuebao.adsl.txtTTCuoc = ds[0]['thongtin_tc']
            this.thuebao.adsl.pass_adsl = ds[0]['password']
            break
          case DichVuVienThong.TSL:
          case DichVuVienThong.TSL_DOITAC:
          case DichVuVienThong.NOIBO_2DIEM:
            this.listbox.tocdokenh.valuetsl = ds[0]['tocdo_id']
            this.listbox.loaikenh.valuetsl = ds[0]['loaikenh_id']
            this.listbox.thoihan.valuetsl = ds[0]['thoihan_id']
            this.listbox.trangbi.valuetsl = ds[0]['trangbi_id']
            this.listbox.chu_quan.valuetsl = ds[0]['chuquan_id']
            this.thuebao.tsl.txtMaHD_TTKD_TSL = ds[0]['ma_pl']
            this.thuebao.tsl.txtSoSoiQuang = ds[0]['sl_soiquang']

            if (ds[0]['congnghe_id'] != '') this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = -1

            // if (ds[0]["doitac_id"] && ds[0]["doitac_id"]>0)
            // {
            //     this.listbox.doitactsl.chkDoiTacTSL = true;
            //     this.listbox.doitactsl.value = ds[0]["doitac_id"];
            // }
            if (ds[0]['doitac_id'] && ds[0]['doitac_id'] > 0) {
              this.listbox.doitactsl.chkDoiTacTSL = true
              this.listbox.doitactsl.value = ds[0]['doitac_id']
              this.thuebao.tsl.txtCuocTKDT_TSL = ds[0]['cuoc_tkdt']
              this.thuebao.tsl.txtCuocTCDT_TSL = ds[0]['cuoc_tcdt']
              this.thuebao.tsl.txtMaHD_DT_TSL = ds[0]['mahd_dt']
            } else {
              this.listbox.doitactsl.chkDoiTacTSL = false
              this.thuebao.tsl.txtCuocTKDT_TSL = 0
              this.thuebao.tsl.txtCuocTCDT_TSL = 0
              this.thuebao.tsl.txtMaHD_DT_TSL = ''
            }
            this.thuebao.cvlct = true //chkCongVan.Enabled = true;
            if (ds[0]['ma_cv']) {
              this.thuebao.cvlct = true
              this.thuebao.congvan = ds[0]['ma_cv'] //txtCongVan.Text = ds[0]["ma_cv"];
              this.thuebao.NgayCVChecked = true
              this.thuebao.NgayCV = ds[0]['ngay_cv'] && (ds[0]['ngay_cv'] + '').indexOf('-') > 0 ? moment(ds[0]['ngay_cv']).format(this.dateFormat) : ds[0]['ngay_cv'] //dtpNgayCV.Value = ds[0]["ngay_cv"];
            }

            this.thuebao.crm = ds[0]['ma_crm']
            this.thuebao.erp = ds[0]['id_erp']
            this.thuebao.vtn = ds[0]['makenh_vtn']

            this.thuebao.tsl.txtCuocTC_TSL = ds[0]['cuoc_tc']
            this.thuebao.tsl.txtCuocTK_TSL = ds[0]['cuoc_tk']
            this.thuebao.tsl.txtCuocTBI_TSL = ds[0]['cuoc_tbi']
            this.thuebao.tsl.txtCuocHT_TSL = ds[0]['cuoc_ht']

            for (var i = 0; i < ds.length; i++) {
              if (ds[i]['daucuoi_id'] == 1) {
                //Nếu là điểm đầu
                this.thuebao.tsl.diachidau_id = ds[i]['diachi_id']
                if (ds[i]['kinhdo_ld'] != '') this.diachiDau.Lng = ds[i]['kinhdo_ld']
                //Lng_DD
                else this.diachiDau.Lng = 0

                if (ds[i]['vido_ld'] != '') this.diachiDau.Lat = ds[i]['vido_ld']
                //Lat_DD
                else this.diachiDau.Lat = 0

                this.thuebao.tsl.txtSoAoTSL_Dau = ds[i]['ma_lt']
                this.ma_tb_ao = ds[i]['ma_lt']
                this.ma_tb_ao_ht = this.ma_tb_ao // Them cho chac, sau nay bo cai ma_tb_ao vi ma_tb_ao doi voi TSL luon gan = ma_tb_ao_ht
                this.listbox.loai_tb.valuedau = ds[i]['thietbidc_id']
                this.listbox.loaicap.valuedau = ds[i]['loaicap_id']
                this.thuebao.tsl.txtSiteIDTSL_Dau = ds[i]['site_id']
                this.thuebao.tsl.txtVrf_Dau = ds[i]['vrf']
              } else {
                this.thuebao.tsl.diachicuoi_id = ds[i]['diachi_id']

                if (ds[i]['kinhdo_ld'] != '') this.diachiCuoi.Lng = ds[i]['kinhdo_ld']
                //Lng_DC
                else this.diachiCuoi.Lng = 0

                if (ds[i]['vido_ld'] != '') this.diachiCuoi.Lat = ds[i]['vido_ld']
                //Lat_DC
                else this.diachiCuoi.Lat = 0

                this.thuebao.tsl.txtSoAoTSL_Cuoi = ds[i]['ma_lt']
                this.ma_tb_ao_ht_cuoi = ds[i]['ma_lt'] //ma_tb_ao_cuoi luon = ma_tb_ao_ht_cuoi nen thay the luon, khong dung bien kia nua
                this.listbox.loai_tb.valuecuoi = ds[i]['thietbidc_id']
                this.listbox.loaicap.valuecuoi = ds[i]['loaicap_id']
                this.thuebao.tsl.txtSiteIDTSL_Cuoi = ds[i]['site_id']
                this.thuebao.tsl.txtVrf_Cuoi = ds[i]['vrf']
              }
            }
            this.HienThiTTDiaChi_TSL()
            for (var i = 0; i < ds.length; i++) {
              if (ds[i]['daucuoi_id'] == 1) {
                //Nếu là điểm đầu
                //this.listbox.donvi_dau.value = apidata['DONVI_DAU_ID'];//donvi_dau_id = Convert.ToInt32(objCheckData.MAP_ID("donvi_dau_id", DatabaseConstants.DB2 + ".hd_thuebao", "where hdtb_id = " + hdtb_id));
                if (apidata['DONVI_DAU_ID']) this.thuebao.tsl.donvi_dau_id = apidata['DONVI_DAU_ID']
                if (apidata['DS_LOAIDV_DAU']) this.listbox.donvi_dau.list = this.LowerCasePropertyList(apidata['DS_LOAIDV_DAU'])
                if (apidata['DONVI_DAUCBO_ID']) this.listbox.donvi_dau.value = apidata['DONVI_DAUCBO_ID']
                this.diachiDau.DIACHI = ds[i]['diachi'] //txtDiaChiDau.Text = CommonFunction.ChuanHoaTen(ds.Tables[0].Rows[i]["diachi"].ToString());
              } else {
                // this.listbox.donvi_cuoi.value = apidata['DONVI_CUOI_ID'];//donvi_cuoi_id = Convert.ToInt32(objCheckData.MAP_ID("donvi_cuoi_id", DatabaseConstants.DB2 + ".hd_thuebao", "where hdtb_id = " + hdtb_id));
                if (apidata['DONVI_CUOI_ID']) this.thuebao.tsl.donvi_cuoi_id = apidata['DONVI_CUOI_ID']
                if (apidata['DS_LOAIDV_CUOI']) this.listbox.donvi_cuoi.list = this.LowerCasePropertyList(apidata['DS_LOAIDV_CUOI'])
                if (apidata['DONVI_CUOICBO_ID']) this.listbox.donvi_cuoi.value = apidata['DONVI_CUOICBO_ID']
                this.diachiCuoi.DIACHI = ds[i]['diachi'] //txtDiaChiCuoi.Text = CommonFunction.ChuanHoaTen(ds.Tables[0].Rows[i]["diachi"].ToString());
              }
            }
            break
          case DichVuVienThong.GPHONE:
            this.thuebao.gphone.txtSoSimGphone = ds[0]['simcard']
            this.thuebao.gphone.checkVSVX = ds[0]['mc_tbgp_id'] == '1'
            if (ds[0]['trangbi_id']) this.listbox.trangbi.valuegp = ds[0]['trangbi_id']
            if (ds[0]['chuquan_id']) this.listbox.chu_quan.valuegp = ds[0]['chuquan_id']

            if (ds[0]['congnghe_id'] != '') this.listbox.congnghe.value = ds[0]['congnghe_id']
            else this.listbox.congnghe.value = -1
            this.thuebao.gphone.dgvTienCKGP.list = [];
            this.thuebao.gphone.dgvTienCKGP.list = dt
            break

          case DichVuVienThong.ANTOAN_BAOMAT_TT:
          case DichVuVienThong.HOINGHI_TRUYENHINH:
          case DichVuVienThong.DICHVU_CNTT:
          case DichVuVienThong.TRUNGTAM_DULIEU:
            // #region Hiển thị thông tin ra
            // this.grcMacdinh.DataSource = (object)null;
            await this.Init_Properties(this.listbox.loaihinh_tb.value, 'HDTB_CNTT', '00000', this.ItemList) //Init_Properties(loaihinh_tb, "HDTB_CNTT", "00000", ref ItemList);

            this.gridEditors = []
            for (var index1 = 0; index1 < this.ItemList.length; ++index1) {
              if (!this.ItemList[index1]) continue
              if (this.ItemList[index1].sFieldName == 'MA_TB') this.ItemList[index1].sValue = this.ma_tb
              else this.ItemList[index1].sValue = ds[0][this.ItemList[index1].sFieldName.toLowerCase()] ? ds[0][this.ItemList[index1].sFieldName.toLowerCase()] : ds[0][this.ItemList[index1].sFieldName]

              if (this.ItemList[index1].iAtt == 0) {
                let repositoryItemTextEdit = { Type: 'TextEdit' }
                repositoryItemTextEdit.Tag = this.ItemList[index1].sFieldName
                repositoryItemTextEdit.ReadOnly = this.ItemList[index1].sReadOnly == 1
                repositoryItemTextEdit.EditValueChanged = this.repositoryItemTextEdit_EditValueChanged
                repositoryItemTextEdit.Leave = this.repositoryItemTextEdit_Leave // chua code nen comment tam lai

                repositoryItemTextEdit.DataType = this.ItemList[index1].iDataType
                repositoryItemTextEdit.MaxValue = this.ItemList[index1].sMaxValue
                repositoryItemTextEdit.MinValue = this.ItemList[index1].sMinValue
                repositoryItemTextEdit.Name = this.ItemList[index1].sCaption
                repositoryItemTextEdit.Value = repositoryItemTextEdit.DataType == 1 ? this.ItemList[index1].sValue * 1 : this.ItemList[index1].sValue
                repositoryItemTextEdit.Group = 'Tham số báo cáo'
                repositoryItemTextEdit.ID = this.ItemList[index1].sFieldName
                // repositoryItemTextEdit.RepositoryItem = repositoryItemTextEdit
                this.gridEditors.push(repositoryItemTextEdit)
                //this.gridEditors.push((RepositoryItem)repositoryItemTextEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
              }
              if (this.ItemList[index1].iAtt == 1) {
                let repositoryItemCalcEdit = { Type: 'CalcEdit' }
                repositoryItemCalcEdit.MaxValue = this.ItemList[index1].sMaxValue
                repositoryItemCalcEdit.MinValue = this.ItemList[index1].sMinValue
                repositoryItemCalcEdit.Tag = this.ItemList[index1].sFieldName
                repositoryItemCalcEdit.ReadOnly = this.ItemList[index1].sReadOnly == 1
                repositoryItemCalcEdit.Name = this.ItemList[index1].sCaption
                repositoryItemCalcEdit.Group = 'Tham số báo cáo'
                repositoryItemCalcEdit.ID = this.ItemList[index1].sFieldName
                repositoryItemCalcEdit.Value = this.ItemList[index1].sValue
                // repositoryItemCalcEdit.RepositoryItem = repositoryItemCalcEdit
                this.gridEditors.push(repositoryItemCalcEdit)
                // repositoryItemCalcEdit.Tag = ItemList[index1].sFieldName;
                // repositoryItemCalcEdit.ReadOnly = (ItemList[index1].sReadOnly == 1);
                // this.gridEditors.Add((RepositoryItem)this.repositoryItemCalcEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
              }
              if (this.ItemList[index1].iAtt == 2) {
                let repositoryItemDateEdit = { Type: 'DateEdit' }
                repositoryItemDateEdit.ReadOnly = this.ItemList[index1].sReadOnly == 1
                repositoryItemDateEdit.Tag = this.ItemList[index1].sFieldName
                repositoryItemDateEdit.FormatString = 'DD/MM/YYYY'
                repositoryItemDateEdit.EditMask = 'DD/MM/YYYY'
                repositoryItemDateEdit.EditValueChanged = this.repositoryItemDateEdit_EditValueChanged
                repositoryItemDateEdit.Name = this.ItemList[index1].sCaption
                repositoryItemDateEdit.Group = 'Tham số báo cáo'
                repositoryItemDateEdit.ID = this.ItemList[index1].sFieldName
                repositoryItemDateEdit.Value = moment(this.ItemList[index1].sValue).format('DD/MM/YYYY') //this.ItemList[index1].sValue;
                // repositoryItemDateEdit.RepositoryItem = repositoryItemDateEdit
                this.gridEditors.push(repositoryItemDateEdit)

                // RepositoryItemDateEdit repositoryItemDateEdit = new RepositoryItemDateEdit();
                // repositoryItemDateEdit.Tag = ItemList[index1].sFieldName;
                // repositoryItemDateEdit.ReadOnly = (ItemList[index1].sReadOnly == 1);
                // repositoryItemDateEdit.DisplayFormat.FormatString = "dd/MM/yyyy";
                // repositoryItemDateEdit.EditFormat.FormatString = "dd/MM/yyyy";
                // repositoryItemDateEdit.EditMask = "dd/MM/yyyy";
                // repositoryItemDateEdit.Mask.UseMaskAsDisplayFormat = true;
                // repositoryItemDateEdit.EditValueChanged += new System.EventHandler(this.repositoryItemDateEdit_EditValueChanged);
                // this.gridEditors.Add((RepositoryItem)repositoryItemDateEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
              }

              if (this.ItemList[index1].iAtt == 9) {
                let repositoryItemDateEdit = { Type: 'DateEdit' }
                repositoryItemDateEdit.ReadOnly = this.ItemList[index1].sReadOnly == 1
                repositoryItemDateEdit.Tag = this.ItemList[index1].sFieldName
                repositoryItemDateEdit.FormatString = 'DD/MM/YYYY HH:mm:ss'
                repositoryItemDateEdit.EditMask = 'DD/MM/YYYY HH:mm:ss'
                repositoryItemDateEdit.EditValueChanged = this.repositoryItemDateEdit_EditValueChanged
                repositoryItemDateEdit.Name = this.ItemList[index1].sCaption
                repositoryItemDateEdit.Group = 'Tham số báo cáo'
                repositoryItemDateEdit.ID = this.ItemList[index1].sFieldName
                repositoryItemDateEdit.Value = moment(this.ItemList[index1].sValue).format('DD/MM/YYYY HH:mm:ss') //this.ItemList[index1].sValue;
                // repositoryItemDateEdit.RepositoryItem = repositoryItemDateEdit
                this.gridEditors.push(repositoryItemDateEdit)

                // RepositoryItemDateEdit repositoryItemDateEdit = new RepositoryItemDateEdit();
                // repositoryItemDateEdit.Tag = ItemList[index1].sFieldName;
                // repositoryItemDateEdit.ReadOnly = (ItemList[index1].sReadOnly == 1);
                // repositoryItemDateEdit.DisplayFormat.FormatString = "dd/MM/yyyy HH:mm:ss";
                // repositoryItemDateEdit.EditFormat.FormatString = "dd/MM/yyyy HH:mm:ss";
                // repositoryItemDateEdit.EditMask = "dd/MM/yyyy HH:mm:ss";
                // repositoryItemDateEdit.Mask.UseMaskAsDisplayFormat = true;
                // repositoryItemDateEdit.EditValueChanged += new System.EventHandler(this.repositoryItemDateEdit_EditValueChanged);
                // this.gridEditors.Add((RepositoryItem)repositoryItemDateEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
              }
              //duong them
              if (this.ItemList[index1].iAtt == 10) {
                let repositoryItemCheckedComboBoxEdit1 = { Type: 'CheckedComboBoxEdit1' }
                repositoryItemCheckedComboBoxEdit1.AutoHeight = false
                repositoryItemCheckedComboBoxEdit1.Name = 'repositoryItemCheckedComboBoxEdit1'

                repositoryItemCheckedComboBoxEdit1.ReadOnly = this.ItemList[index1].sReadOnly == 1
                let SQL_CheckListBox = this.ItemList[index1].StrSql
                let data = this.ItemList[index1].SqlData
                repositoryItemCheckedComboBoxEdit1.ValueMember = this.ItemList[index1].sLookUpKeyField
                repositoryItemCheckedComboBoxEdit1.DisplayMember = this.ItemList[index1].sLookUpValueField
                repositoryItemCheckedComboBoxEdit1.DataSource = data

                repositoryItemCheckedComboBoxEdit1.Name = this.ItemList[index1].sCaption
                repositoryItemCheckedComboBoxEdit1.Group = 'Tham số báo cáo'
                repositoryItemCheckedComboBoxEdit1.ID = this.ItemList[index1].sFieldName
                repositoryItemCheckedComboBoxEdit1.Value = this.ItemList[index1].sValue ? this.ItemList[index1].sValue.split(',') : this.ItemList[index1].sValue

                // repositoryItemCheckedComboBoxEdit1.RepositoryItem = repositoryItemCheckedComboBoxEdit1
                this.gridEditors.push(repositoryItemCheckedComboBoxEdit1)

                // InitialItemCheckedRepository();

                // string SQL_CheckListBox = ItemList[index1].StrSql;
                // DataTable data = this.objCheckData.GET_DATA_SQL(SQL_CheckListBox, "");
                // repositoryItemCheckedComboBoxEdit1.ReadOnly = (ItemList[index1].sReadOnly == 1);
                // repositoryItemCheckedComboBoxEdit1.ValueMember = ItemList[index1].sLookUpKeyField;
                // repositoryItemCheckedComboBoxEdit1.DisplayMember = ItemList[index1].sLookUpValueField;
                // repositoryItemCheckedComboBoxEdit1.DataSource = (object)data;

                // this.gridEditors.Add((RepositoryItem)repositoryItemCheckedComboBoxEdit1, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
              }

              if (this.ItemList[index1].iAtt == 4) {
                let repositoryItemLookUpEdit = { Type: 'LookUpEdit' }
                repositoryItemLookUpEdit.ReadOnly = this.ItemList[index1].sReadOnly == 1
                repositoryItemLookUpEdit.Tag = this.ItemList[index1].sFieldName
                let SQL = this.ItemList[index1].StrSql
                if (SQL && SQL != '' && SQL.indexOf('{') < 0) {
                  let data = this.ItemList[index1].SqlData
                  if (!data || data.length <= 0) {
                    this.$toast.error('Không lấy được dữ liệu cho ' + repositoryItemLookUpEdit.Tag)
                    continue
                  }
                  repositoryItemLookUpEdit.ValueMember = this.ItemList[index1].sLookUpKeyField
                  repositoryItemLookUpEdit.DisplayMember = this.ItemList[index1].sLookUpValueField
                  if (this.DS_CHUQUAN_THEO_QUYEN != null && this.DS_CHUQUAN_THEO_QUYEN != '' && this.ItemList[index1].sLookUpKeyField.toUpperCase() == 'CHUQUAN_ID') {
                    repositoryItemLookUpEdit.DataSource = data.filter((x) => this.DS_CHUQUAN_THEO_QUYEN.indexOf(x.CHUQUAN_ID) >= 0) //(object)data.Tables[0].Select("CHUQUAN_ID in " + this.DS_CHUQUAN_THEO_QUYEN).CopyToDataTable();
                  }
                  // #region cuongpq them load lai cbo huyen ivan
                  else if (this.ItemList[index1].sLookUpKeyField && this.ItemList[index1].sLookUpKeyField.toUpperCase() == 'CAPDO_ID' && this.listbox.loaihinh_tb.value == LoaiHinhTB.IVAN) {
                    let tinh_ivan = await API.post_getivan_tinh(this.axios, { tinh_id: this.diachiTB.TINH_ID }).then((response) => {
                      //.post_sp_huonggiao_runsql(this.axios, { "command": this.ReplaceSQL(`select tinh_ivan_id from ${DatabaseConstants.DB2}.tinh where tinh_id = ${this.diachiTB.TINH_ID}`) }).then((response) => {
                      if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                        return response.data.data //.data_json;
                      } else return []
                    }) //bangts.getDataFromSQL(ReplaceSQL("select tinh_ivan_id from {?DB2}.tinh where tinh_id = " + tinhtb_id), "tinh_ivan").Tables[0];
                    if (tinh_ivan.length > 0) {
                      if (tinh_ivan[0].tinh_ivan_id != null) {
                        let vtinh_ivan = tinh_ivan[0].tinh_ivan_id
                        repositoryItemLookUpEdit.DataSource = data.filter((x) => x.MAP_ID == vtinh_ivan) //(object)data.Tables[0].Select("MAP_ID = " + vtinh_ivan).CopyToDataTable();
                      } else throw 'Địa chỉ thuê bao tỉnh chưa có trên danh mục dịch vụ IVAN. Liên hệ admin để được hỗ trợ' //this.$toast.error("Địa chỉ thuê bao tỉnh chưa có trên danh mục dịch vụ IVAN. Liên hệ admin để được hỗ trợ");
                    } else throw 'Hãy chọn địa chỉ thuê bao' //this.$toast.error("Hãy chọn địa chỉ thuê bao");
                  }
                  // #endregion
                  else repositoryItemLookUpEdit.DataSource = data
                  repositoryItemLookUpEdit.NullText = ''
                } else {
                  SQL = await this.ReturnSqlStr(this.ItemList, index1)
                  let data = this.ItemList[index1].SqlData
                  if (!data || data.length <= 0) {
                    this.$toast.error('Không lấy được dữ liệu cho ' + repositoryItemLookUpEdit.Tag)
                    continue
                  }
                  repositoryItemLookUpEdit.ValueMember = this.ItemList[index1].sLookUpKeyField
                  repositoryItemLookUpEdit.DisplayMember = this.ItemList[index1].sLookUpValueField
                  if (this.DS_CHUQUAN_THEO_QUYEN != null && this.DS_CHUQUAN_THEO_QUYEN != '' && this.ItemList[index1].sLookUpKeyField.toUpperCase() == 'CHUQUAN_ID') {
                    repositoryItemLookUpEdit.DataSource = data.filter((x) => this.DS_CHUQUAN_THEO_QUYEN.indexOf(x.CHUQUAN_ID) >= 0) //(object)data.Tables[0].Select("CHUQUAN_ID in " + this.DS_CHUQUAN_THEO_QUYEN).CopyToDataTable();
                  } else repositoryItemLookUpEdit.DataSource = data //(object)data.Tables[0];

                  repositoryItemLookUpEdit.NullText = ''
                }
                repositoryItemLookUpEdit.EditValueChanged = this.repositoryItemLookUpEdit_EditValueChanged
                repositoryItemLookUpEdit.Leave = this.repositoryItemLookUpEdit_leave
                repositoryItemLookUpEdit.EditValueChanging = this.repositoryItemLookUpEdit_EditValueChanging
                //  this.gridEditors.Add((RepositoryItem)repositoryItemLookUpEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
                repositoryItemLookUpEdit.Name = this.ItemList[index1].sCaption
                repositoryItemLookUpEdit.Group = 'Tham số báo cáo'
                repositoryItemLookUpEdit.ID = this.ItemList[index1].sFieldName
                repositoryItemLookUpEdit.Value = this.ItemList[index1].sValue
                if (!repositoryItemLookUpEdit.Value && repositoryItemLookUpEdit.DataSource && repositoryItemLookUpEdit.DataSource.length > 0) repositoryItemLookUpEdit.Value = repositoryItemLookUpEdit.DataSource[0][repositoryItemLookUpEdit.ValueMember]
                if (repositoryItemLookUpEdit.DataSource && repositoryItemLookUpEdit.DataSource.length > 0) {
                  repositoryItemLookUpEdit.DataSource = repositoryItemLookUpEdit.DataSource.map((x) => ({ text: x[this.ItemList[index1].sLookUpValueField], id: x[this.ItemList[index1].sLookUpKeyField] }))
                }
                // repositoryItemLookUpEdit.RepositoryItem = repositoryItemLookUpEdit
                this.gridEditors.push(repositoryItemLookUpEdit)
                //await this.repositoryItemLookUpEdit_EditValueChanged(repositoryItemLookUpEdit)
              }
              if (this.ItemList[index1].iAtt == 5) {
                //Button Edit
                let repositoryItemButtonEdit = { Type: 'ButtonEdit' }
                repositoryItemButtonEdit.ReadOnly = this.ItemList[index1].sReadOnly == 1
                repositoryItemButtonEdit.Tag = this.ItemList[index1].sFieldName
                repositoryItemButtonEdit.ReadOnly = this.ItemList[index1].sReadOnly == 1

                // repositoryItemButtonEdit.ButtonClick -= new DevExpress.XtraEditors.Controls.ButtonPressedEventHandler(this.repositoryItemButtonEdit_ButtonClick);
                repositoryItemButtonEdit.ButtonClick = this.repositoryItemButtonEdit_ButtonClick
                repositoryItemButtonEdit.Name = this.ItemList[index1].sCaption
                repositoryItemButtonEdit.Group = 'Tham số báo cáo'
                repositoryItemButtonEdit.ID = this.ItemList[index1].sFieldName
                repositoryItemButtonEdit.Value = this.ItemList[index1].sValue
                // repositoryItemButtonEdit.RepositoryItem = repositoryItemButtonEdit
                this.gridEditors.push(repositoryItemButtonEdit)
                // RepositoryItemButtonEdit repositoryItemButtonEdit = new RepositoryItemButtonEdit();
                // repositoryItemButtonEdit.Tag = ItemList[index1].sFieldName;
                // repositoryItemButtonEdit.ReadOnly = (ItemList[index1].sReadOnly == 1);
                // repositoryItemButtonEdit.ButtonClick -= new DevExpress.XtraEditors.Controls.ButtonPressedEventHandler(this.repositoryItemButtonEdit_ButtonClick);
                // repositoryItemButtonEdit.ButtonClick += new DevExpress.XtraEditors.Controls.ButtonPressedEventHandler(this.repositoryItemButtonEdit_ButtonClick);
                // this.gridEditors.Add((RepositoryItem)repositoryItemButtonEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
              }
              if (this.ItemList[index1].iAtt == 7) {
                let repositoryItemCheckEdit = { Type: 'CheckEdit' }
                repositoryItemCheckEdit.Tag = this.ItemList[index1].sFieldName
                repositoryItemCheckEdit.ReadOnly = this.ItemList[index1].sReadOnly == 1
                repositoryItemCheckEdit.ValueChecked = 1
                repositoryItemCheckEdit.ValueUnchecked = 0
                repositoryItemCheckEdit.Name = this.ItemList[index1].sCaption
                repositoryItemCheckEdit.Group = 'Tham số báo cáo'
                repositoryItemCheckEdit.ID = this.ItemList[index1].sFieldName
                repositoryItemCheckEdit.Value = this.ItemList[index1].sValue
                // repositoryItemCheckEdit.RepositoryItem = repositoryItemCheckEdit
                this.gridEditors.push(repositoryItemCheckEdit)

                // repositoryItemCheckEdit.Tag = ItemList[index1].sFieldName;
                // repositoryItemCheckEdit.ReadOnly = (ItemList[index1].sReadOnly == 1);
                // this.repositoryItemCheckEdit.ValueChecked = (object)"1";
                // this.repositoryItemCheckEdit.ValueUnchecked = (object)"0";
                // this.gridEditors.Add((RepositoryItem)this.repositoryItemCheckEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
              }
            }
            for (var index = 0; index < this.gridEditors.length; index++) {
              if (this.gridEditors[index].Type == 'LookUpEdit') {
                await this.repositoryItemLookUpEdit_EditValueChanged(this.gridEditors[index])
              }
              if (this.gridEditors[index].ID == 'MA_TB') {
                this.gridEditors[index].Value = this.ma_tb
                if (this.ItemList[index]) this.ItemList[index].sValue = this.ma_tb
              } else {
                if (this.gridEditors[index].ID == 'TOCDO_ID') {
                  if (this.ItemList[index]) {
                    this.listbox.cboGoiCuocAdsl.value = this.ItemList[index].sValue
                    await this.HT_GIAODIEN_DONVI(); // Them vao vi khong hieu sao no ko trigger su kien nay!
                  }
                }
                if (this.gridEditors[index].Type == 'DateEdit') {
                  //EditMask
                  this.gridEditors[index].Value = moment(ds[0][this.gridEditors[index].ID.toLowerCase()]).format(this.gridEditors[index].EditMask)
                  if (this.ItemList[index]) this.ItemList[index].sValue = moment(ds[0][this.gridEditors[index].ID.toLowerCase()]).format(this.gridEditors[index].EditMask)
                } else if (this.gridEditors[index].Type == 'CheckedComboBoxEdit1') {
                  this.gridEditors[index].Value = ds[0][this.gridEditors[index].ID.toLowerCase()] ? ds[0][this.gridEditors[index].ID.toLowerCase()].split(',') : ds[0][this.gridEditors[index].ID.toLowerCase()]
                  if (this.ItemList[index]) this.ItemList[index].sValue = ds[0][this.gridEditors[index].ID.toLowerCase()] + ''
                } else {
                  this.gridEditors[index].Value = ds[0][this.gridEditors[index].ID.toLowerCase()]
                  if (this.ItemList[index]) this.ItemList[index].sValue = ds[0][this.gridEditors[index].ID.toLowerCase()] + ''
                }
              }
            }

            await this.grvMacdinh_RowCellStyle();
            // this.grcMacdinh.DataSource = (object)this.gridEditors;
            // this.grvMacdinh.BestFitColumns();
            //duongpd lay thong tin HD_THUEBAO_CT
            if (apidata['DS_HDTB_CT']) this.dsHDTB_CT = apidata['DS_HDTB_CT']
            //(tdan.GET_DATA_PROC("{?DB2}.LAY_DS_HD_THUEBAO_CT_COMMON", "vhdtb_id", hdtb_id)).DataTableToList<HD_THUEBAO_CT>();
            else this.dsHDTB_CT = []
            // #endregion
            break
          default:
            break
        }

        for (let i = 0; i < this.gridEditors.length; i++) {
          if (!(this.ItemList[i].sFieldName == "DUNGTHU"
            || this.ItemList[i].sFieldName == "THIETBI"
            || this.ItemList[i].sFieldName == "MA_DV"
            || this.ItemList[i].sFieldName == "DINHTUYEN")) {
          } else if (this.listbox.kieu_ld.value == 14052 || this.listbox.kieu_ld.value  == 14051)/*đối tượng 1, 2*/ {
            this.gridEditors[i].show = false;
            // this.ItemList[i].hidden = true;
          }

        }
      }
      this.asyncLock = false;
    },
    HienThiTTDiaChi_TSL() {
      //{"DIACHI_DAU_ID":1,"DIACHI_CUOI_ID":4}
      API.post_fn_hienthi_tt_diachi_tsl(this.axios, { ds_para: JSON.stringify({ DIACHI_DAU_ID: this.thuebao.tsl.diachidau_id, DIACHI_CUOI_ID: this.thuebao.tsl.diachicuoi_id }) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            this.$toast.error(apidata['MESSAGE'])
            return
          }
          if (apidata['RESULT']) apidata = apidata['RESULT']
          let ds = apidata['DS_DIACHI_DAU']
          if (ds.length > 0) {
            this.diachiDau.TINH_ID = ds[0]['tinh_id'.toUpperCase()]
            this.diachiDau.QUAN_ID = ds[0]['quan_id'.toUpperCase()]
            this.diachiDau.PHUONG_ID = ds[0]['phuong_id'.toUpperCase()]

            if (ds[0]['pho_id'.toUpperCase()]) this.diachiDau.PHO_ID = ds[0]['pho_id'.toUpperCase()]
            else this.diachiDau.AP_ID = 0
            if (ds[0]['ap_id'.toUpperCase()]) this.diachiDau.PHO_ID = ds[0]['ap_id'.toUpperCase()]
            else this.diachiDau.AP_ID = 0
            this.diachiDau.SONHA = ds[0]['sonha'.toUpperCase()]

            if (ds[0]['block'.toUpperCase()]) this.diachiDau.BLOCK = ds[0]['block'.toUpperCase()]
            if (ds[0]['tang'.toUpperCase()]) this.diachiDau.TANG = ds[0]['tang'.toUpperCase()]
            if (ds[0]['phong'.toUpperCase()]) this.diachiDau.PHONG = ds[0]['phong'.toUpperCase()]
            if (ds[0]['mota'.toUpperCase()]) this.diachiDau.MOTA = ds[0]['mota'.toUpperCase()]
          }
          ds = apidata['DS_DIACHI_CUOI']
          if (ds.length > 0) {
            this.diachiCuoi.TINH_ID = ds[0]['tinh_id'.toUpperCase()]
            this.diachiCuoi.QUAN_ID = ds[0]['quan_id'.toUpperCase()]
            this.diachiCuoi.PHUONG_ID = ds[0]['phuong_id'.toUpperCase()]

            if (ds[0]['pho_id'.toUpperCase()]) this.diachiCuoi.PHO_ID = ds[0]['pho_id'.toUpperCase()]
            else this.diachiCuoi.AP_ID = 0
            if (ds[0]['ap_id'.toUpperCase()]) this.diachiCuoi.PHO_ID = ds[0]['ap_id'.toUpperCase()]
            else this.diachiCuoi.AP_ID = 0
            this.diachiCuoi.SONHA = ds[0]['sonha'.toUpperCase()]

            if (ds[0]['block'.toUpperCase()]) this.diachiCuoi.BLOCK = ds[0]['block'.toUpperCase()]
            if (ds[0]['tang'.toUpperCase()]) this.diachiCuoi.TANG = ds[0]['tang'.toUpperCase()]
            if (ds[0]['phong'.toUpperCase()]) this.diachiCuoi.PHONG = ds[0]['phong'.toUpperCase()]
            if (ds[0]['mota'.toUpperCase()]) this.diachiCuoi.MOTA = ds[0]['mota'.toUpperCase()]
          }
        }
      })
    },
    HT_DS_KhuyenMai_Combobox() {
      var itocdo_id = 0
      var itrangbi_id = 3
      if (this.listbox.kieu_ld.list.length <= 0) return
      if (!this.listbox.doituong.value || this.listbox.doituong.value == 0) return
      if (this.listbox.trangbi.list.length <= 0) return

      switch (this.listbox.dichvu_vt.value * 1) {
        case DichVuVienThong.CO_DINH:
          itocdo_id = 0

          if (this.listbox.trangbi.list.length <= 0) itrangbi_id = TRANGBI.VIENTHONG_TRANGBI
          else itrangbi_id = this.listbox.trangbi.valuecd

          break
        case DichVuVienThong.MEGAWAN:
        case DichVuVienThong.MGW_DOITAC:
        case DichVuVienThong.MGW_DOITAC:
        case DichVuVienThong.METRONET:
        case DichVuVienThong.NOIBO_DADIEM:
          itocdo_id = this.listbox.tocdokenh.valuecir
          itrangbi_id = this.listbox.trangbi.valuewan
          break
        case DichVuVienThong.ADSL:
          //Thay return -> break o 3 dong nay vi loi khong load duoc khuyen mai!!!
          if (!this.listbox.cboGoiCuocAdsl.list || this.listbox.cboGoiCuocAdsl.list.length <= 0) break
          if (this.listbox.trangbi.list.length <= 0) break
          if (!this.listbox.muccuoc.list || this.listbox.muccuoc.list.length <= 0) break
          itocdo_id = this.listbox.cboGoiCuocAdsl.value
          itrangbi_id = this.listbox.trangbi.valueadsl
          break
        case DichVuVienThong.ANTOAN_BAOMAT_TT:
        case DichVuVienThong.DICHVU_CNTT:
        case DichVuVienThong.TRUNGTAM_DULIEU:
        case DichVuVienThong.HOINGHI_TRUYENHINH:
        case DichVuVienThong.BRCD_DOITAC:
        case DichVuVienThong.MEGA_EYES:
          // if (!this.listbox.cboGoiCuocAdsl.list || this.listbox.cboGoiCuocAdsl.list.length<=0) return;
          if (this.listbox.trangbi.list.length <= 0) itrangbi_id = TRANGBI.VIENTHONG_TRANGBI
          else itrangbi_id = this.listbox.trangbi.valueadsl
          itocdo_id = this.listbox.cboGoiCuocAdsl.value
          break
        case DichVuVienThong.GPHONE:
          itocdo_id = 0
          if (this.listbox.trangbi.list.length <= 0) return
          itrangbi_id = this.listbox.trangbi.valuegp
          break
        case DichVuVienThong.TSL_DOITAC:
        case DichVuVienThong.TSL:
        case DichVuVienThong.NOIBO_2DIEM:
          itocdo_id = this.listbox.tocdokenh.valuetsl //cboTocDoKenhTSL
          itrangbi_id = this.listbox.trangbi.valuetsl //cboTrangBi
          break
        case DichVuVienThong.DI_DONG:
          itocdo_id = this.thuebao.didong.cboGoiCuocDD.value
          itrangbi_id = this.listbox.trangbi.valuedd
          break
      }
      this.trangbi_id = itrangbi_id
      //TODO else cac case khac truoc LINE 26464
      //dsKhuyenMai = tchopdong.LAY_KHUYENMAI_HDTB(this.listbox.loaihinh_tb.value, this.listbox.kieu_ld.value, phuongld_id, KHOANMUC_TT.KMTT_DATMOI, phold_id, apld_id, khuld_id, itrangbi_id, this.listbox.doituong.value, itocdo_id, muccuoc_id, 0, hdtb_id);
      this.LoadTTKhuyenMai(KHOANMUC_TT.KMTT_DATMOI, 0, itrangbi_id, itocdo_id) // ham tuong duong doan code nay!
      // this.filterbox.khuyenmai.ischecked = false; // disable bang code tren form.
      //longdx: bo sung ham lay thong tin tra truoc
      //dsTraTruoc = tchopdong.LAY_KHUYENMAI_HDTB(this.listbox.loaihinh_tb.value, this.listbox.kieu_ld.value, phuongld_id, KHOANMUC_TT.KMTT_DATMOI, phold_id, apld_id, khuld_id, itrangbi_id, this.listbox.doituong.value, itocdo_id, muccuoc_id, 1, hdtb_id);
      this.LoadTTKhuyenMai(KHOANMUC_TT.KMTT_DATMOI, 1, itrangbi_id, itocdo_id, 'tratruoc')
      //cboTraTruoc.DataSource = dsTraTruoc.Tables[0];
      //cboTraTruoc.ValueMember = "khuyenmai_id";
      //cboTraTruoc.DisplayMember = "ten_km";
      //--------cboTraTruoc-------------
      // this.filterbox.tratruoc.ischecked = false; // disable bang code tren form.
    },
    async HT_ThietBi() {
      try {
        let vsl_cha = -1
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IOFFICE) {
          if (this.gridEditors != null) {
            if (this._sl_cha != -1) vsl_cha = this._sl_cha
            else {
              for (var index_ = 0; index_ < this.gridEditors.length; ++index_) {
                if (this.gridEditors[index_].ID == 'TONGSO_ND' && this.gridEditors[index_].Value != '') {
                  vsl_cha = this.gridEditors[index_].Value
                  break
                }
              }
            }
          }
        }
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING || this.listbox.loaihinh_tb.value == LoaiHinhTB.HNTH_NGN || this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MCAP || this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_LIS) {
          if (this.gridEditors != null) {
            if (this._sl_cha != -1) vsl_cha = this._sl_cha
            else {
              for (var index_ = 0; index_ < this.gridEditors.length; ++index_) {
                if (this.gridEditors[index_].ID == 'SL_MAILING' && this.gridEditors[index_].Value != '') {
                  vsl_cha = this.gridEditors[index_].Value
                  if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MCAP) {
                    for (var index1_ = 0; index1_ < this.gridEditors.length; ++index1_) {
                      if (this.gridEditors[index1_].ID == 'SO_THANG' && this.gridEditors[index1_].Value != '') {
                        if (this.gridEditors[index1_].Value % 12 == 0) {
                          vsl_cha = vsl_cha * (this.gridEditors[index1_].Value / 12)
                        }
                        break
                      }
                    }
                  }
                  break
                }
              }
            }
          }
        }

        this.dsTRAGOP_TBI_HDTB = []
        let kt = true //Kiểm tra xem biến
        this.thietbi.tien_tbi = 0
        this.thietbi.vat_tbi = 0
        let soluong = 1
        this.thietbi.tien_kmtbi = 0
        this.thietbi.vat_kmtbi = 0
        this.thietbi.tien_tgtb_tragop = 0
        this.thietbi.vat_tgtb_tragop = 0
        this.thietbi.tien_tgtb_tratruoc = 0
        this.thietbi.vat_tgtb_tratruoc = 0

        let dTyLe_KMTB = 0
        let dtien_kmtbi_tmp = 0
        let dvat_kmtbi_tmp = 0
        let dtien_tbi_tmp = 0
        let dvat_tbi_tmp = 0
        let dtien_tgtb_tratruoc_tmp = 0
        let dvat_tgtb_tratruoc_tmp = 0
        let dtien_tgtb_tragop_tmp = 0
        let dvat_tgtb_tragop_tmp = 0
        let str = ''
        this.lvMuaThietbi.list = []
        for (var i = 0; i < this.dsCTM_TBI.length; i++) {
          let apidata = {}
          await API.post_fn_lay_cho_ht_thietbi(this.axios, { ds_para: JSON.stringify({ LOAITBI_ID: this.dsCTM_TBI[i]['loaitbi_id'], DS_CT_KM_ID: '' + this.ds_CTKM() }) }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              apidata = JSON.parse(response.data.data)
              if (apidata['RESULT']) apidata = apidata['RESULT']
            }
          })
          if (apidata['LOAI_TBI']) str = apidata['LOAI_TBI']
          this.lvMuaThietbi.list.push(str)
          //Hiếu bổ sung thêm tiền mua thiết bị ngày 14/09/2010
          //Hiếu bổ sung code tính tiền mua thiết bị
          kt = false
          soluong = this.dsCTM_TBI[i]['soluong']
          if (this.dsCTM_TBI[i]['tien'] || this.dsCTM_TBI[i]['tien']==0) {
            dtien_tbi_tmp = this.dsCTM_TBI[i]['tien']
            this.thietbi.tien_tbi = this.thietbi.tien_tbi + dtien_tbi_tmp * soluong
          }
          if (this.dsCTM_TBI[i]['vat'] || this.dsCTM_TBI[i]['vat']==0) {
            dvat_tbi_tmp = this.dsCTM_TBI[i]['vat']
            this.thietbi.vat_tbi = this.thietbi.vat_tbi + dvat_tbi_tmp * soluong
          }

          if (vsl_cha != -1) {
            if (this.dsCTM_TBI[i]['block_tiep'] && this.dsCTM_TBI[i]['gia_block_tiep'] && this.dsCTM_TBI[i]['gia_block_tiep'] != 0) {
              if (
                this.listbox.loaihinh_tb.value == LoaiHinhTB.IOFFICE ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.HNTH_NGN ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MCAP ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_LIS
              ) {
                if (vsl_cha > this.dsCTM_TBI[i]['block_dau']) {
                  let vsl_conlai = vsl_cha - this.dsCTM_TBI[i]['block_dau']

                  let t2 = vsl_conlai % this.dsCTM_TBI[i]['block_tiep']
                  let vsl_bl = 0
                  if (t2 > 0) vsl_bl = vsl_conlai / this.dsCTM_TBI[i]['block_tiep'] + 1
                  else vsl_bl = vsl_conlai / this.dsCTM_TBI[i]['block_tiep']

                  let tien_block = 0
                  tien_block = vsl_bl * this.dsCTM_TBI[i]['gia_block_tiep']
                  dtien_tbi_tmp += tien_block
                  this.thietbi.tien_tbi = this.thietbi.tien_tbi + tien_block * soluong
                }
              }
            }

            if (this.dsCTM_TBI[i]['block_tiep'] && this.dsCTM_TBI[i]['vat_block_tiep'] && this.dsCTM_TBI[i]['vat_block_tiep'] != 0) {
              if (
                this.listbox.loaihinh_tb.value == LoaiHinhTB.IOFFICE ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.HNTH_NGN ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MCAP ||
                this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_LIS
              ) {
                if (vsl_cha > this.dsCTM_TBI[i]['block_dau']) {
                  let vsl_conlai = vsl_cha - this.dsCTM_TBI[i]['block_dau']

                  let t3 = vsl_conlai % this.dsCTM_TBI[i]['block_tiep']
                  let rsl_bl = 0
                  if (t3 > 0) rsl_bl = vsl_conlai / this.dsCTM_TBI[i]['block_tiep'] + 1
                  else rsl_bl = vsl_conlai / this.dsCTM_TBI[i]['block_tiep']

                  let vat_block = 0
                  vat_block = rsl_bl * this.dsCTM_TBI[i]['vat_block_tiep']
                  dvat_tbi_tmp += vat_block
                  this.thietbi.vat_tbi = this.thietbi.vat_tbi + vat_block * soluong
                }
              }
            }
          }

          let dtTMP_KMTBI = []
          if (apidata['TMP_KMTBI']) dtTMP_KMTBI = this.LowerCasePropertyList(apidata['TMP_KMTBI'])
          if (dtTMP_KMTBI.length > 0) {
            dtien_kmtbi_tmp = dtTMP_KMTBI.Rows[0]['tien_km']
            dvat_kmtbi_tmp = dtTMP_KMTBI.Rows[0]['vat_km']
            dTyLe_KMTB = dtTMP_KMTBI.Rows[0]['tyle_km']
          } // hoangpkn : 13/12/2018. Thêm đoạn else
          else {
            dtien_kmtbi_tmp = 0
            dvat_kmtbi_tmp = 0
            dTyLe_KMTB = 0
          }

          if (dTyLe_KMTB > 0) {
            dtien_kmtbi_tmp = this.round((dtien_tbi_tmp * dTyLe_KMTB) / 100)
            dvat_kmtbi_tmp = this.round((dvat_tbi_tmp * dTyLe_KMTB) / 100)
          }
          if (dtTMP_KMTBI.length > 0) {
            this.dsCTM_TBI[i]['tien_km'] = dtien_kmtbi_tmp
            this.dsCTM_TBI[i]['vat_km'] = dvat_kmtbi_tmp
            this.thietbi.tien_kmtbi += dtien_kmtbi_tmp * soluong
            this.thietbi.vat_kmtbi += dvat_kmtbi_tmp * soluong
          }
          let dtTMP = []
          if (apidata['TMP_TRAGOP']) dtTMP = this.LowerCasePropertyList(apidata['TMP_TRAGOP'])
          if (dtTMP.length > 0) {
            //có định nghĩa trả góp
            if (this.dsCTM_TBI[i]['tien_tratruoc'] || this.dsCTM_TBI[i]['tien_tratruoc']==0) dtien_tgtb_tratruoc_tmp = this.dsCTM_TBI[i]['tien_tratruoc']
            if (this.dsCTM_TBI[i]['vat_tratruoc'] || this.dsCTM_TBI[i]['vat_tratruoc']==0) dvat_tgtb_tratruoc_tmp = this.dsCTM_TBI[i]['vat_tratruoc']

            let rowtgtb = {}
            rowtgtb.HDTB_ID = 0
            rowtgtb.CHITIETKM_ID = dtTMP[0]['chitietkm_id']
            rowtgtb.LOAITBI_ID = this.dsCTM_TBI[i]['loaitbi_id']
            rowtgtb.TIEN = dtien_tbi_tmp
            rowtgtb.VAT = dvat_tbi_tmp
            rowtgtb.SOLUONG = soluong
            rowtgtb.TIEN_KM = dtien_kmtbi_tmp
            rowtgtb.VAT_KM = dvat_kmtbi_tmp
            rowtgtb.TYLE_KM = dTyLe_KMTB
            rowtgtb.TIEN_TRATRUOC = dtien_tgtb_tratruoc_tmp
            rowtgtb.VAT_TRATRUOC = dvat_tgtb_tratruoc_tmp
            rowtgtb.TIEN_TRAGOP = (dtien_tbi_tmp - dtien_kmtbi_tmp) * soluong - dtien_tgtb_tratruoc_tmp
            rowtgtb.VAT_TRAGOP = (dvat_tbi_tmp - dvat_kmtbi_tmp) * soluong - dvat_tgtb_tratruoc_tmp
            this.dsTRAGOP_TBI_HDTB.push(rowtgtb)
          } else {
            dtien_tgtb_tratruoc_tmp = dtien_tbi_tmp - dtien_kmtbi_tmp
            dvat_tgtb_tratruoc_tmp = dvat_tbi_tmp - dvat_kmtbi_tmp
            this.dsCTM_TBI[i]['tien_tratruoc'] = dtien_tgtb_tratruoc_tmp
            this.dsCTM_TBI[i]['vat_tratruoc'] = dvat_tgtb_tratruoc_tmp
          }

          this.thietbi.tien_tgtb_tratruoc += dtien_tgtb_tratruoc_tmp * soluong
          this.thietbi.vat_tgtb_tratruoc += dvat_tgtb_tratruoc_tmp * soluong
          this.thietbi.tien_tgtb_tragop += (dtien_tbi_tmp - Math.abs(dtien_kmtbi_tmp) - dtien_tgtb_tratruoc_tmp) * soluong
          this.thietbi.vat_tgtb_tragop += (dvat_tbi_tmp - Math.abs(dvat_kmtbi_tmp) - dvat_tgtb_tratruoc_tmp) * soluong
        }

        if (kt) {
          this.thietbi.tien_tbi = 0
          this.thietbi.vat_tbi = 0
          this.thietbi.tien_kmtbi = 0
          this.thietbi.vat_kmtbi = 0
          this.thietbi.tien_tgtb_tratruoc = 0
          this.thietbi.vat_tgtb_tratruoc = 0
          this.thietbi.tien_tgtb_tragop = 0
          this.thietbi.vat_tgtb_tragop = 0
        }
        this.thietbi.dtien_kmtb = this.thietbi.tien_kmtbi
        this.thietbi.dvat_kmtb = this.thietbi.vat_kmtbi
        this.HienThiTienMuaThietBi()
        this.HienThiTienKhuyenMai_ThietBi()
        this.HienThiTienTraTruocThietBi()
        this.HienThiTienTraGopThietBi()
      } catch (ex) {
        this.$toast.error('' + ex)
        throw ex
      }
    },
    HienThiTienMuaThietBi() {
      this.thietbi.dtientbi = this.thietbi.tien_tbi
      this.thietbi.dvattbi = this.thietbi.vat_tbi

      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_MUATHIETBI) {
          this.ds_tien_khoanmuc[j]['tien'] = this.thietbi.tien_tbi
          this.ds_tien_khoanmuc[j]['vat'] = this.thietbi.vat_tbi
        }
      }

      this.LayTongTien_HDTB()
    },
    HienThiTienKhuyenMai_ThietBi() {
      this.thietbi.dtien_kmtb = this.thietbi.tien_kmtb
      this.thietbi.dvat_kmtb = this.thietbi.vat_kmtbi

      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI) {
          if (this.thietbi.tien_kmtb > 0) {
            this.ds_tien_khoanmuc[j]['tien'] = this.thietbi.tien_kmtb * -1
            this.ds_tien_khoanmuc[j]['vat'] = this.thietbi.vat_kmtbi * -1
          } else {
            this.ds_tien_khoanmuc[j]['tien'] = this.thietbi.tien_kmtb
            this.ds_tien_khoanmuc[j]['vat'] = this.thietbi.vat_kmtbi
          }
        }
      }

      this.LayTongTien_HDTB()
    },
    HienThiTienTraTruocThietBi() {
      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_TRATRUOC_THIETBI) {
          this.ds_tien_khoanmuc[j]['tien'] = this.thietbi.tien_tgtb_tratruoc
          this.ds_tien_khoanmuc[j]['vat'] = this.thietbi.vat_tgtb_tratruoc
        }
      }

      this.LayTongTien_HDTB()
    },
    HienThiTienTraGopThietBi() {
      for (var j = 0; j < this.ds_tien_khoanmuc.length; j++) {
        if (this.ds_tien_khoanmuc[j]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_TRAGOP_THIETBI) {
          this.ds_tien_khoanmuc[j]['tien'] = this.thietbi.tien_tgtb_tragop
          this.ds_tien_khoanmuc[j]['vat'] = this.thietbi.vat_tgtb_tragop
        }
      }

      this.LayTongTien_HDTB()
    },
    async HienThiTT_DanhBa(ds) {
      try {
        if (ds.length > 0) {
          // this.isEditKH = false;
          // if(this.thamsomacdinh['GUI_YEUCAU_PHEDUYET_TTTT_KH']==1)
          //   this.isEditKH = true;
          this.thuebao.tbhd_pl = 0
          this.NgayYeuCau = moment(new Date()).format(this.datetimeFormatFull)
          if (ds[0]['ngaylap_hd']) this.NgayLapHD = (ds[0]['ngaylap_hd'] + '').indexOf('T') > 0 ? moment(ds[0]['ngaylap_hd']).format(this.datetimeFormatFull) : ds[0]['ngaylap_hd']
          if (!this.NgayLapHD) this.NgayLapHD = moment(new Date()).format(this.datetimeFormatFull)
          this.khachhang.makh = ds[0]['ma_kh']
          this.khachhang.mahd = ds[0]['ma_hd']
          this.khachhang.khachhang_id = ds[0]['khachhang_id']
          this.khachhang.tenkh = this.ChuanHoaTen(ds[0]['ten_kh'])
          this.diachiKH.DIACHI = this.ChuanHoaTen(ds[0]['diachi_kh'])
          if (ds[0]['loaikh_id']) {
            this.listbox.loai_kh.value = ds[0]['loaikh_id']
            this.loaikhChanged(this.listbox.loai_kh.list.find((x) => x.loaikh_id == this.listbox.loai_kh.value))
          }
          if (!ds[0]['diachi_ndd'] || ds[0]['diachi_ndd'].length == 0) this.diachiNDD.DIACHI = this.ChuanHoaTen(ds[0]['diachi_kh'])
          else this.diachiNDD.DIACHI = this.ChuanHoaTen(ds[0]['diachi_ndd'])
          if (this.listbox.loai_kh.value == Loai_KH.CANHAN_HOGIADINH && (!ds[0]['nguoi_dd'] || ds[0]['nguoi_dd'].trim() == '')) this.khachhang.nguoidd = this.khachhang.tenkh
          else this.khachhang.nguoidd = this.ChuanHoaTen(ds[0]['nguoi_dd'])

          if (ds[0]['nganhnghe_id']) {
            this.listbox.nganhngheloc.value = ds[0]['nganhnghe_id']
            this.nganhnghe_id = ds[0]['nganhnghe_id']
          }

          //TuấnNA thêm code hiển thị thông tin id tiểu ngành c1,c2,c3 -- Ngày 03/12/2010
          if (ds[0]['tnc1_id'] != '') this.tieunganh.TNC1_ID = ds[0]['tnc1_id']
          else this.tieunganh.TNC1_ID = 0
          if (ds[0]['tnc2_id'] != '') this.tieunganh.TNC2_ID = ds[0]['tnc2_id']
          else this.tieunganh.TNC2_ID = 0
          if (ds[0]['tnc3_id'] != '') this.tieunganh.TNC3_ID = ds[0]['tnc3_id']
          else this.tieunganh.TNC3_ID = 0
          if (ds[0]['tnc4_id'] != '') this.tieunganh.TNC4_ID = ds[0]['tnc4_id']
          else this.tieunganh.TNC4_ID = 0
          //

          this.khachhang.dienthoai = ds[0]['so_dt']
          this.khachhang.fax = ds[0]['so_fax']

          // this.diachiHK.DIACHI = this.ChuanHoaTen(ds[0]["hokhau"]);

          if (ds[0]['ngay_sn']) {
            this.NgaySinh = ds[0]['ngay_sn']
            if (!this.NgaySinhTB) this.NgaySinhTB = this.NgaySinh
          } else this.NgaySinh = null
          this.khachhang.sogt = ds[0]['so_gt']
          if (ds[0]['ngaycap']) this.NgayCap = ds[0]['ngaycap']
          else this.NgayCap = null

          //Hiếu bổ sung 1 số thông tin thiếu 27.09.2010
          if (ds[0]['ngayhethan_gt']) this.NgayHH = ds[0]['ngayhethan_gt']
          else this.NgayHH = null
          this.khachhang.chucvu = ds[0]['chucdanh']
          this.diachiHK.DIACHI = this.ChuanHoaTen(ds[0]['hokhau'])
          this.khachhang.noicaphk = this.ChuanHoaTen(ds[0]['noicap_hk'])
          if (ds[0]['ngaycap'])
            //FIXME ngay_hk moi dung chu nhi????
            this.NgayCapHK = ds[0]['ngaycap']
          else this.NgayCapHK = null
          this.khachhang.masothue = ds[0]['mst']
          this.listbox.nganhang.sotaikhoankh = ds[0]['stk']
          if (ds[0]['nganhang_id']) {
            this.listbox.nganhang.ischeckedkh = true
            this.listbox.nganhang.valuekh = ds[0]['nganhang_id']
          } else this.listbox.nganhang.ischeckedkh = false
          this.khachhang.dactrung = ds[0]['dactrung']
          //txtGiayToKem.Text = ds[0]["so_gt_kem"];
          this.khachhang.ghichu = ds[0]['ghichu']
          if (ds[0]['loaigt_id'] != '') this.listbox.loai_gt.value = ds[0]['loaigt_id']
          this.khachhang.noicap = this.ChuanHoaTen(ds[0]['noicap'])
          this.listbox.loai_khl.value = ds[0]['khlon_id']
          this.diachiCT.DIACHI = this.ChuanHoaTen(ds[0]['diachi_ct'])
          this.nganhang.DV_QHNS = ds[0]['dv_qhns']
          this.nganhang.MACHUONG = ds[0]['machuong']
          this.nganhang.MN_KT = ds[0]['mn_kt']
          this.nganhang.MA_NDKT = ds[0]['ma_ndkt']
          this.nganhang.MN_NSNN = ds[0]['mn_nsnn']
          if (ds[0]['tien_dm']) this.nganhang.TIEN_DM = ds[0]['tien_dm']

          //Thông tin thanh toán
          //HungHM - 20/09/2010 Zem lai : nếu txtMaTT = null thì sẽ tự sinh mã TT mới, hoặc chọn List mã TT
          // this.thanhtoan.matt = ds[0]["ma_tt"];
          this.thanhtoan.thanhtoan_id = ds[0]['thanhtoan_id']
          this.thanhtoan.mainghep = ds[0]['main_ghep']
          if (ds[0]['mig_id']) {
            this.thanhtoan.mig_id = ds[0]['mig_id']
          }
          this.thanhtoan.tentt = this.ChuanHoaTen(ds[0]['ten_tt'])
          this.diachiTT.DIACHI = this.ChuanHoaTen(ds[0]['diachi_tt'])
          //địa chỉ báo cước
          this.diachiBC.DIACHI = this.ChuanHoaTen(ds[0]['diachi_bc'])
          //
          if (!ds[0]['diachi_ct']) this.diachiCT.DIACHI = this.ChuanHoaTen(ds[0]['diachi_tt'])
          else this.diachiCT.DIACHI = this.ChuanHoaTen(ds[0]['diachi_ct'])

          let vetinh_id = ''
          this.thanhtoan.nhanvientc_id = null
          this.thanhtoan.manvtc = null
          this.thanhtoan.tuyenthu_id = null
          await API.post_fn_lay_tt_danhba(this.axios, {
            ds_para: JSON.stringify({
              KHACHHANG_ID: this.khachhang.khachhang_id,
              THANHTOAN_ID: this.thanhtoan.thanhtoan_id,
              THUEBAO_ID: ds[0]['thuebao_id'],
              PHANLOAIKH_ID: ds[0]['phanloaikh_id'] ? ds[0]['phanloaikh_id'] : null,
              NHANVIEN_ID: ds[0]['nhanvien_id'] ? ds[0]['nhanvien_id'] : 0,
              TUYENTHU_ID: ds[0]['tuyenthu_id'] ? ds[0]['tuyenthu_id'] : 0
            })
          }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              let apidata = JSON.parse(response.data.data)
              if (apidata['RESULT']) apidata = apidata['RESULT']
              if (apidata['DS_DIACHI_DBKH']) this.HienThiTTDiaChi(apidata['DS_DIACHI_DBKH'], 1)
              if (apidata['DS_DIACHI_DBTT']) this.HienThiTTDiaChi(apidata['DS_DIACHI_DBTT'], 2)
              if (apidata['DS_DIACHI_TB']) this.HienThiTTDiaChi(apidata['DS_DIACHI_TB'], 3)
              if (apidata['DS_MADD'] && apidata['DS_MADD'].length > 0) this.listbox.madaidien.list = this.LowerCasePropertyList(apidata['DS_MADD'])
              if (apidata['NVTC_ID']) this.thanhtoan.nhanvientc_id = apidata['NVTC_ID']
              if (apidata['TUYENTHU_ID']) this.thanhtoan.tuyenthu_id = apidata['TUYENTHU_ID']
              if (apidata['MA_NV']) this.thanhtoan.manvtc = apidata['MA_NV']
              if (apidata['MA_TUYEN']) this.thanhtoan.matuyen = apidata['MA_TUYEN']
              if (apidata['VETINH_ID']) vetinh_id = apidata['VETINH_ID']
              if (apidata['MA_PLKH']) this.khachhang.plkh = apidata['MA_PLKH']
              if (apidata['NHOM_PLKH'] && apidata['NHOM_PLKH'] != '-1') this.khachhang.nhom_plkh = apidata['NHOM_PLKH']
              //ds1 = response.data.data;
            }
          })

          if (ds[0]['matb_dd']) this.listbox.madaidien.value = ds[0]['matb_dd']

          //txtMaTBDD.Text = ds["matb_dd"];
          this.thanhtoan.masothue = ds[0]['mst_tt']
          // if (ts_kt_mst_kh == 1)
          //     txtMST_TT2.Text = ds["mst_tt"];
          // else
          //     txtMST_TT.Text = ds["mst_tt"];
          this.listbox.nganhang.sotaikhoan = ds[0]['stk_tt']
          this.thanhtoan.sodienthoai = ds[0]['so_dt_tt']
          this.thanhtoan.email = ds[0]['email_tt']
          this.thanhtoan.chutk = ds[0]['chu_tk_tt']
          if (ds[0]['nganhang_id_tt']) this.listbox.nganhang.value = ds[0]['nganhang_id_tt']
          this.listbox.hinhthuc_tt.value = ds[0]['httt_id']
          if (ds[0]['httc_id']) this.listbox.hinhthuc_tc.value = ds[0]['httc_id']
          if (ds[0]['donvi_id']) this.listbox.donvi_ql.valueql = ds[0]['donvi_id']

          if (!ds[0]['nhanvien_id']) {
            this.thanhtoan.nhanvientc_id = this.thanhtoan.nhanvientc_id ? this.thanhtoan.nhanvientc_id : 0
            // this.thanhtoan.manvtc = this.thanhtoan.manvtc?this.thanhtoan.manvtc:'';
          } else {
            this.thanhtoan.nhanvientc_id = ds[0]['nhanvien_id']
          }
          this.thanhtoan.manvtc = ds[0]['ma_nv'] ? ds[0]['ma_nv'] : this.thanhtoan.manvtc ? this.thanhtoan.manvtc : ''

          if (!ds[0]['tuyenthu_id']) {
            this.thanhtoan.tuyenthu_id = this.thanhtoan.tuyenthu_id ? this.thanhtoan.tuyenthu_id : 0
            // this.thanhtoan.matuyen = this.thanhtoan.matuyen?this.thanhtoan.matuyen:'';
          } else {
            this.thanhtoan.tuyenthu_id = ds[0]['tuyenthu_id']
          }
          this.thanhtoan.matuyen = ds[0]['ma_tuyen'] ? ds[0]['ma_tuyen'] : this.thanhtoan.matuyen ? this.thanhtoan.matuyen : ''

          this.thanhtoan.matb_dd = ds[0]['matb_dd']
          this.HienThi_NVQL_AM_DB_HD(1, this.thanhtoan.thanhtoan_id)
          //Thông tin thuê bao
          //HIếu bổ sung thêm một số thông tin 1.10.2010
          this.thuebao.tentb = this.ChuanHoaTen(ds[0]['ten_tb'])
          this.diachiTB.DIACHI = this.ChuanHoaTen(ds[0]['diachi_tb'])
          if (ds[0]['donviql_id']) this.listbox.donvi_ql.value = ds[0]['donviql_id']
          if (this.ht_loc_cbo_tram) this.HT_GIAODIEN_DONVI()

          //
          this.listbox.doituong.value = ds[0]['doituong_id'] ? ds[0]['doituong_id'] : (this.listbox.doituong.list && this.listbox.doituong.list[0] ? this.listbox.doituong.list[0].doituong_id : null)

          //Lấy ds mức cước thuê bao
          //Index trạm thi công theo phường
          // string vetinh_id = ""; // da xu ly o tren
          // vetinh_id = objCheckData.MAP_ID("donvi_id", DatabaseConstants.DB2 + ".donvi_px", "where phuong_id =" + phuongld_id + " and decode(" + phold_id + ",0, 0, pho_id) = " + phold_id + " and loaidv_id = " + LOAI_DV.TRAM_VT);

          if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) {
            if (vetinh_id != '-1') this.buttons.btnChonSM = true
            // else
            //     this.buttons.btnChonSM = false;
          } else if (this.listbox.dichvu_vt.value == DichVuVienThong.IMS) this.buttons.btnChonSoIMS = vetinh_id != '-1'
          //Cac case con lai khong co code -> bo qua
          //Lay_DS_MucCuoc_TB(khuld_id, apld_id, phold_id, phuongld_id, this.listbox.loaihinh_tb.value, this.listbox.doituong.value, dtpNgayYeuCau.Value.ToString("dd/MM/yyyy"));
          await this.LoadMucCuocTB() // Thay ham kia bang ham nay tuong duong
          //
          if (ds[0]['diachi_ld']) this.diachiLD.DIACHI = this.ChuanHoaTen(ds[0]['diachi_tb'])
          else this.diachiLD.DIACHI = this.ChuanHoaTen(ds[0]['diachi_ld'])
          if (ds[0]['ngay_sn']) this.NgaySinhTB = (ds[0]['ngay_sn'] + '').indexOf('T') > 0 ? moment(ds[0]['ngay_sn']).format(this.datetimeFormatFull) : ds[0]['ngay_sn']
          if (!this.NgaySinhTB) this.NgaySinhTB = this.NgaySinh ? this.NgaySinh : null
          this.buttons.chkLapDatBS = true
          //Hien thi thong tin khuyen mai
          this.HT_DS_KhuyenMai_Combobox()
        } else {
          this.thuebao.tbhd_pl = 1
          this.buttons.chkLapDatBS = false
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        //throw ex;
      }
    },
    async HienThiTTHopDongKH(ds) {
      try {
        this.loading(true)
        if (ds && ds.length > 0) {
          this.khachhang.hdkh_id = ds[0]['hdkh_id']
          let dthdkh_sub = []
          let DS_HD_TT = []
          let DS_HD_TB = []
          let vhdkhtn_id = ''
          await API.post_fn_ht_tt_hd_khachhang(this.axios, {
            ds_para: JSON.stringify({
              HDKH_ID: this.khachhang.hdkh_id,
              HDKH_CHA_ID: ds[0]['hdkh_cha_id'] ? ds[0]['hdkh_cha_id'] : null,
              CTV_ID: ds[0]['ctv_id'] ? ds[0]['ctv_id'] : null,
              NVGT_ID: ds[0]['nhanviengt_id'] ? ds[0]['nhanviengt_id'] : null,
              PHANLOAIKH_ID: ds[0]['phanloaikh_id'] ? ds[0]['phanloaikh_id'] : null,
              LOAIHD_ID: ds[0]['loaihd_id'] ? ds[0]['loaihd_id'] : null
            })
          }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              let apidata = JSON.parse(response.data.data)
              if (apidata['RESULT']) apidata = apidata['RESULT']
              if (apidata['HDKH_SUB']) dthdkh_sub = this.LowerCasePropertyList(apidata['HDKH_SUB'])
              if (apidata['IS_HD_TUVAN']) this.IS_HD_TUVAN = apidata['IS_HD_TUVAN']
              if (apidata['DC_HDKH']) this.HienThiTTDiaChi(this.LowerCasePropertyList(apidata['DC_HDKH']), 1)
              if (ds[0]['ctv_id']) {
                if (apidata['TEN_NV_CTV']) this.filterbox.ctv.value = apidata['TEN_NV_CTV']
                if (apidata['MA_NV_CTV']) this.filterbox.ctv.ma_ctv = apidata['MA_NV_CTV']
                this.ctv_id = ds[0]['ctv_id']
                this.filterbox.ctv.ischecked = true
              } else {
                this.filterbox.ctv.value = ''
                this.filterbox.ctv.ma_ctv = ''
                this.filterbox.ctv.ischecked = false
              }
              if (ds[0]['nhanviengt_id']) {
                if (apidata['MA_NVGT']) this.filterbox.nguoigt.nguoigt_id = apidata['MA_NVGT']
                if (apidata['TEN_NVGT']) this.filterbox.nguoigt.value = apidata['TEN_NVGT']
                this.filterbox.nguoigt.nguoigt_id = ds[0]['nhanviengt_id']
                this.filterbox.nguoigt.ischecked = true
              } else {
                this.filterbox.nguoigt.nguoigt_id = ''
                this.filterbox.nguoigt.value = ''
                this.filterbox.nguoigt.ischecked = false
              }
              if (apidata['MA_PLKH']) this.khachhang.plkh = apidata['MA_PLKH']
              if (apidata['NHOM_PLKH']) this.khachhang.nhom_plkh = apidata['NHOM_PLKH']
              if (apidata['DS_HD_TT']) DS_HD_TT = this.LowerCasePropertyList(apidata['DS_HD_TT'])
              if (apidata['DS_HD_TB']) DS_HD_TB = this.LowerCasePropertyList(apidata['DS_HD_TB'])
              if (apidata['HDKHTN_ID']) vhdkhtn_id = apidata['HDKHTN_ID']
              if (apidata['KT_TC_BC']) this.Khoa_HD_BC_Tinh_ThiCong(true)
              else this.Khoa_HD_BC_Tinh_ThiCong(false)
            }
          })
          this.dsHDKH_Sub = []
          if (dthdkh_sub.length > 0) {
            await this.TAO_DULIEU_HDKH_SUB(dthdkh_sub, this.khachhang.hdkh_id)
          }
          // if (ds[0]["hdkh_cha_id"])
          // {
          //     this.hdkh_cha_id = ds[0]["hdkh_cha_id"];

          //     //KieuNV:Kiểm tra xem hợp đồng cha có phải là hợp đồng tư vấn dịch vụ hay không.
          //     //FIXME chưa biết load dữ liệu gì ở đây
          //     let loaihd_cha_id = objCheckData.MAP_ID("loaihd_id", DatabaseConstants.DB2 + ".hd_khachhang", "where hdkh_id =" + hdkh_cha_id);
          //     if (loaihd_cha_id == LoaiHopDong.TUVAN_DV)
          //     {
          //       this.IS_HD_TUVAN = true;
          //     }
          // }
          //if (!string.IsNullOrEmpty(ds[0]["kieuhd_id"]))
          //    cboKieuHD.SelectedValue = Convert.ToInt32(ds[0]["kieuhd_id"]);

          if (ds[0]['ngay_yc']) this.NgayYeuCau = ds[0]['ngay_yc']
          else this.NgayYeuCau = moment(new Date()).format(this.datetimeFormatFull)
          if (ds[0]['ngaylap_hd']) this.NgayLapHD = (ds[0]['ngaylap_hd'] + '').indexOf('T') > 0 ? moment(ds[0]['ngaylap_hd']).format(this.datetimeFormatFull) : ds[0]['ngaylap_hd']
          else this.NgayLapHD = moment(new Date()).format(this.datetimeFormatFull)
          this.khachhang.magd = ds[0]['ma_gd']
          this.khachhang.mahd = ds[0]['ma_hd']
          this.khachhang.makh = ds[0]['ma_kh']
          //if(this.khachhang.makh) this.MaKHChanged(); //THANGDM1 Bo sung them luong de load du lieu khach hang tu dong UPDATED 20211130: thao tac nay sai. Thong tin load o day chi dung cho danh ba
          if (ds[0]['khachhang_id']) this.khachhang.khachhang_id = ds[0]['khachhang_id']
          else this.khachhang.khachhang_id = 0
          if (ds[0]['loaikh_id'] && ds[0]['loaikh_id']) {
            this.listbox.loai_kh.value = ds[0]['loaikh_id']
            this.loaikhChanged(this.listbox.loai_kh.list.find((x) => x.loaikh_id == this.listbox.loai_kh.value))
          }
          if (ds[0]['kieuhd_id']) this.listbox.kieu_hd.value = ds[0]['kieuhd_id']
          else this.listbox.kieu_hd.value = KIEU_HD.TAI_GD
          this.vkieuhd_id = this.listbox.kieu_hd.value

          this.khachhang.tenkh = this.ChuanHoaTen(ds[0]['ten_kh'])

          this.diachiKH.DIACHI = ds[0]['diachi_kh']

          this.khachhang.nguoidd = this.ChuanHoaTen(ds[0]['nguoi_dd'])
          this.khachhang.chucvu = this.ChuanHoaTen(ds[0]['chucdanh_dd'])
          this.khachhang.dienthoai = ds[0]['so_dt']
          this.khachhang.fax = ds[0]['so_fax']

          this.diachiHK.DIACHI = this.ChuanHoaTen(ds[0]['hokhau'])
          this.khachhang.noicaphk = this.ChuanHoaTen(ds[0]['noicap_hk'])

          if (ds[0]['ngay_hk']) {
            this.NgayCapHK = ds[0]['ngay_hk'] //moment(ds[0]["ngay_hk"]).format("DD/MM/YYYY");
          } else {
            this.NgayCapHK = null
          }

          if (ds[0]['ngay_sn']) {
            this.NgaySinh = ds[0]['ngay_sn']
            if (!this.NgaySinhTB) this.NgaySinhTB = this.NgaySinh
          } else {
            this.NgaySinh = null
          }
          this.NgayYeuCau = ds[0]['ngay_yc']

          //HungHM - bổ xung các trường còn thiếu mới thêm vào bảng hd_khachhang
          if (ds[0]['ngaylap_hd']) this.NgayLapHD = (ds[0]['ngaylap_hd'] + '').indexOf('T') > 0 ? moment(ds[0]['ngaylap_hd']).format(this.datetimeFormatFull) : ds[0]['ngaylap_hd']
          else this.NgayLapHD = moment(new Date()).format(this.datetimeFormatFull)
          if (ds[0]['gioitinh']) {
            this.khachhang.gioitinh = ds[0]['gioitinh']
          } else this.khachhang.gioitinh = -1
          if (ds[0]['quoctich_id']) {
            this.listbox.quoctich.value = ds[0]['quoctich_id']
          }
          if (ds[0]['dantoc_id']) {
            this.listbox.dantoc.value = ds[0]['dantoc_id']
          }
          if (ds[0]['nganhnghe_id']) {
            this.listbox.nganhngheloc.value = ds[0]['nganhnghe_id']
            this.nganhnghe_id = ds[0]['nganhnghe_id']
            // cboNganhNgheLoc.Properties.LockEvents();
            // cboNganhNgheLoc.EditValue = ds[0]["nganhnghe_id"];
            // nganhnghe_id = ds[0]["nganhnghe_id"];
            // cboNganhNgheLoc.Properties.UnLockEvents();
          }
          //TuấnNA thêm code hiển thị thông tin id tiểu ngành c1,c2,c3 -- Ngày 03/12/2010
          if (ds[0]['tnc1_id']) this.tieunganh.TNC1_ID = ds[0]['tnc1_id']
          else this.tieunganh.TNC1_ID = 0
          if (ds[0]['tnc2_id']) this.tieunganh.TNC2_ID = ds[0]['tnc2_id']
          else this.tieunganh.TNC2_ID = 0
          if (ds[0]['tnc3_id']) this.tieunganh.TNC3_ID = ds[0]['tnc3_id']
          else this.tieunganh.TNC3_ID = 0
          if (ds[0]['tnc4_id']) this.tieunganh.TNC4_ID = ds[0]['tnc4_id']
          else this.tieunganh.TNC4_ID = 0
          //

          this.diachiNDD.DIACHI = this.ChuanHoaTen(ds[0]['diachi_ndd'])
          if (ds[0]['ngayhethan_gt']) this.NgayHH = moment(ds[0]['ngayhethan_gt']).format('DD/MM/YYYY')
          else this.NgayHH = null
          this.khachhang.masothue = ds[0]['mst']
          this.listbox.nganhang.sotaikhoankh = ds[0]['stk']
          if (ds[0]['nganhang_id']) {
            this.listbox.nganhang.valuekh = ds[0]['nganhang_id']
            this.listbox.nganhang.ischeckedkh = true
          }
          //end edited
          this.khachhang.sogt = ds[0]['so_gt']
          if (ds[0]['ngaycap']) {
            this.NgayCap = ds[0]['ngaycap'] //moment(ds[0]["ngaycap"]).format("DD/MM/YYYY");
          } else {
            this.NgayCap = null
          }

          this.listbox.loai_gt.value = ds[0]['loaigt_id']
          this.khachhang.noicap = this.ChuanHoaTen(ds[0]['noicap'])
          this.buttons.chkLapDatBS = ds[0]['bosungtb_id'] == '1'
          this.listbox.loai_khl.value = ds[0]['khlon_id']
          this.khachhang.ghichu = ds[0]['ghichu']
          this.khachhang.dactrung = ds[0]['dactrung']

          if (ds[0]['httthi_id']) {
            this.listbox.hinhthuc_tthi.value = ds[0]['httthi_id']
          } else this.listbox.hinhthuc_tthi.value = 0

          //PNLINH: B2A 02/05/2020
          if (ds[0]['phieucskh_id'] != '') {
            this.VPHIEUCSKH_ID = ds[0]['phieucskh_id']
          }
          //
          this.maduan = ds[0]['ma_duan']

          if (ds[0]['loaihd_id'] != LoaiHopDong.TIEPNHAN_DATMOI && ds[0]['loaihd_id'] != LoaiHopDong.KHAOSATDATMOI && ds[0]['loaihd_id'] != LoaiHopDong.TIEPNHANHD) {
            //SetButton(3);
            this.buttonSet = 3
            await this.HienThiDS_HDTT_CBO(this.khachhang.hdkh_id)
            await this.HienThiTTHopDongTT(DS_HD_TT)
            //this.HienThiDS_HDTB_CBO(hdkh_id); // 100% comment nen khong code
            await this.HienThiDanhSacHDTT(DS_HD_TT)
            await this.HienThiDanhSacHDTB(DS_HD_TB)
            await this.HienThiTTHopDongTB(DS_HD_TB)

            if (vhdkhtn_id == '-1') this.hdkhtn_id = 0
            else this.hdkhtn_id = vhdkhtn_id
          } else {
            if (ds[0]['loaihd_id'] == LoaiHopDong.TIEPNHAN_DATMOI) this.hdkhtn_id = this.khachhang.hdkh_id
            //SetButton(4);
            this.buttonSet = 4
          }

          //SetButton(3);
          if (this.lvwThueBao.length > 1) this.buttons.tsbtnXoaTB = true
          else this.buttons.tsbtnXoaTB = false

          // SendKeys.Send("{TAB}");

          try {
            //TODO chưa làm vì chưa quan trọng ở phần cố định
            //BusinessFacade.BanCheoFacade.BanCheoBase bc = new BusinessFacade.BanCheoFacade.BanCheoBase();
            // if (bc.Kiem_tra_thi_cong_ban_cheo(hdtb_id))
            //     this.Khoa_HD_BC_Tinh_ThiCong(true);
            // else
            //     this.Khoa_HD_BC_Tinh_ThiCong(false);
          } catch (ex) {
            if (this.debug) console.error(ex)
          }
        } else {
          this.buttonSet = 0
          //  SetButton(0);
        }
      } catch (exp) {
        this.$toast.error('' + exp)
        if (this.debug) console.error(exp)
        throw exp
      } finally {
        this.loading(false)
      }
    },
    Khoa_HD_BC_Tinh_ThiCong(khoa) {
      // TODO chưa làm vì không quan trọng ở phần cố định
      // cboChuQuan_ADSL.Enabled = !khoa;
      // cboChuQuanLD_Internet.Enabled = !khoa;
      // cboTocDoThucADSL.Enabled = !khoa;
      // cboGoiCuocAdsl.Enabled = !khoa;
      // cboTocDo.Enabled = !khoa;
      // cboChuQuanWan.Enabled = !khoa;
      // cboChuQuanLD_Mgwan.Enabled = !khoa;
      // cboChuQuan_TSL.Enabled = !khoa;
      // cboTocDoKenhTSL.Enabled = !khoa;
      // chkKhuyenMai.Enabled = !khoa;
      // chkTraTruoc.Enabled = !khoa;
      // cboChuQuan_CD.Enabled = !khoa;
      // cboChuQuanLD_CD.Enabled = !khoa;
      // cboChuQuan_DD.Enabled = !khoa;
      // cboChuQuan_GP.Enabled = !khoa;
      // cboChuQuan_IMS.Enabled = !khoa;
      // cboChuQuanLD_IMS.Enabled = !khoa;
    },
    showPopupSearchContract() {
      this.$refs.popupSearchContract.showModal()
    },
    acceptSearchContract(item) {
      this.khachhang.magd = item.ma_gd
      if (this.khachhang.magd && this.khachhang.magd.trim() != '') this.MaGDChanged()
    },
    maTTChanged() {
      // this.thanhtoan.matt = e.target.value
      if (this.thanhtoan.matt)
        API.post_lay_db_theo_matb(this.axios, { ma_tb: this.thanhtoan.matt, donvi_dl_id: 0, dichvuvt_id: 0 }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            //this.listbox.danhba.list=response.data.data;
            this.HienThiTT_DanhBa(response.data.data)
          }
        })
      // this.HienThiTT_DanhBa(tcdanhba.LAY_DB_THEO_MATB(txtMaTT.Text, 0, 0));
    },
    defaultCongNghe(newval) {
      if (newval && newval > 0) {
        if ((!this.listbox.congnghe.value || this.listbox.congnghe.value == 0) && this.listbox.kieu_ld.value && this.listbox.kieu_ld.value > 0 && this.listbox.congnghe.list != null && this.listbox.congnghe.list.length > 0) {
          let list = this.listbox.congnghe.list.filter((cn) => cn.kieuld_id == this.listbox.kieu_ld.value)
          if (list && list.length > 0) this.listbox.congnghe.value = list[0].congnghe_id
        }
      }
    },
    HienThi_NVQL_AM_HTTT() {
      //Convert.ToInt32(cboLoaiKH.EditValue), Loai_NV.NHANVIEN_KINHDOANH, phuongtt_id, phott_id, aptt_id, khutt_id, nhanvientc_id, Convert.ToInt32(cboDonViQL.SelectedValue), Convert.ToInt32(cboHTTT.EditValue)
      try {
        if (!this.kt_load) {
          let pdata = {
            vap_id: this.diachiTT.AP_ID,
            vdonviql_id: this.listbox.donvi_ql.valueql,
            vhttt_id: this.listbox.hinhthuc_tt.value,
            vkhu_id: this.diachiTT.KHU_ID,
            vloaikh_id: this.listbox.loai_kh.value,
            vloainv_id: Loai_NV.NHANVIEN_KINHDOANH,
            vnvtc_id: this.thanhtoan.nhanvientc_id,
            vpho_id: this.diachiTT.PHO_ID,
            vphuong_id: this.diachiTT.PHUONG_ID
          }
          API.post_lay_ds_nhanvien_ql_am_v2(this.axios, pdata).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              let rowData = response.data.data
              this.thanhtoan.manvql = rowData['ma_nv'] + ' - ' + rowData['ten_nv']
              this.nhanvien_ql_am_id = rowData['nhanvien_id']
            } else {
              this.thanhtoan.manvql = ''
              this.nhanvien_ql_am_id = 0
            }
          })
        }
      } catch (ex) {
        this.$toast.error('Có lỗi : ' + ex)
      }
    },
    HienThi_NVQL_AM() {
      //Convert.ToInt32(cboLoaiKH.EditValue), Loai_NV.NHANVIEN_KINHDOANH, phuongtt_id, phott_id, aptt_id, khutt_id, dacdiemtt_id, nhanvientc_id, Convert.ToInt32(cboDonViQL.SelectedValue)
      try {
        if (!this.kt_load) {
          let pdata = {
            PHANTAP_KH: this.PHANTAP_KH,
            PHUONG_ID: this.diachiTT.PHUONG_ID,
            PHO_ID: this.diachiTT.PHO_ID,
            AP_ID: this.diachiTT.AP_ID,
            KHU_ID: this.diachiTT.KHU_ID,
            DACDIEM_ID: this.diachiTT.DACDIEM_ID,
            LOAIKH_ID: this.listbox.loai_kh.value,
            NGANHNGHELOC_ID: this.listbox.nganhngheloc.value,
            CBO_DONVIQL_ID: this.listbox.donvi_ql.valueql,
            NVTC_ID: this.thanhtoan.nhanvientc_id,
            DONVIQL_ID: this.listbox.donvi_ql.valueql,
            KHACHHANG_ID: this.khachhang.khachhang_id,
            LOAINV_ID: Loai_NV.NHANVIEN_AM
          }
          API.post_fn_lay_tt_nvql_am(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              let rowData = JSON.parse(response.data.data)
              if (rowData['ERROR_CODE'] != -1) {
                this.thanhtoan.manvql = rowData['RESULT']['TXT_NV_QL']
                this.nhanvien_ql_am_id = rowData['RESULT']['NHANVIEN_QL_AM_ID']
              } else this.$toast.error('' + rowData['MESSAGE'])
            } else {
              this.thanhtoan.manvql = ''
              this.nhanvien_ql_am_id = 0
            }
          })
        }
      } catch (ex) {
        this.$toast.error('Có lỗi : ' + ex)
      }
    },
    ChuyenTrang(page, param) {
      this.$router.push({ name: page, params: param })
    },
    PopupTrang(page, param) {
      const routeData = this.$router.resolve({name: page, query: param});
      window.open(routeData.href, '_blank');
    },
    tsbtnRequestChange_Click() {
      this.PopupTrang('ChangeCustomerInfor',{tag:0,hdkh_id:this.khachhang.hdkh_id});
    },
    tsbtnApproveChange_Click() {
      this.PopupTrang('ChangeCustomerInfor',{tag:1,hdkh_id:this.khachhang.hdkh_id});
    },
    ShowPopupQueue() {
      if (this.popupQueue.length > 0 && !this.popupShowing) {
        let popup = this.popupQueue.pop()
        if (!popup) this.ShowPopupQueue()
        if (popup.id) {
          this.$bvModal.show(popup.id)
          this.popupShowing = true
        } else {
          this.popupComponent = popup.component
          this.popupComponentName = popup.name
          this.popupComponentData = popup.data
          this.Popup('popupComponents')
          this.popupShowing = true
        }
      }
    },
    XuLyDonViQL(ds) {
      if(this.$root.token.getPhanVungID()==97) return;
      if (!ds || ds.length <= 0) {
        if (this.listbox.donvi_ql.list.length != 1) {
          this.$toast.error('Địa danh này chưa được gán đơn vị quản lý địa chỉ thanh toán. Hãy liên hệ với Admin để xử lý!')
          return
        }
      } else if (ds.length == 1) {
        this.listbox.donvi_ql.valueql = ds[0]['DONVI_ID']
        this.LoadNVThuCuoc()
      } else {
        this.popupQueue.push({
          component: () => import('./Popups/popupChonGrid'),
          name: 'popupChonDVQL',
          data: {
            ds: ds,
            cols: [
              { fieldName: 'DONVIQL_ID', headerText: 'ID', allowFiltering: false, allowSorting: false },
              { fieldName: 'TEN_DVQL', headerText: 'Đơn vị', allowFiltering: false, allowSorting: false },
              { fieldName: 'TEN_DV', headerText: 'Tổ thi công', allowFiltering: false, allowSorting: false }
            ],
            keycol: 'DONVIQL_ID',
            allowExit: false,
            tieude: 'Chọn đơn vị quản lý',
            tieudebang: 'Danh sách đơn vị'
          }
        })
        // this.popupComponent = ()=>import('./Popups/popupChonGrid');
        // this.popupComponentName = "popupChonDVQL";
        // this.popupComponentData = {"ds":ds,cols:[
        //   {fieldName: 'DONVIQL_ID', headerText: 'ID', allowFiltering: false, allowSorting: false},
        //   {fieldName: 'TEN_DVQL', headerText: 'Đơn vị', allowFiltering: false, allowSorting: false},
        //   {fieldName: 'TEN_DV', headerText: 'Tổ thi công', allowFiltering: false, allowSorting: false},
        // ],keycol: "DONVIQL_ID",allowExit:false,tieude:"Chọn đơn vị quản lý",tieudebang:"Danh sách đơn vị",}
        // this.Popup('popupComponents');
      }
    },
    XuLyDonViLD(ds) {
      if(this.$root.token.getPhanVungID()==97) return;
      if (!ds || ds.length <= 0) {
        if (this.listbox.donvi_ql.list.length != 1) {
          this.$toast.error('Địa danh này chưa được gán đơn vị quản lý địa chỉ. Hãy liên hệ với Admin để xử lý!')
          if(this.$root.token.getPhanVungID()!=98)
            this.listbox.donvi_ql.value = null
          return
        }
      } else if (ds.length == 1) {
        if (ds[0]['DONVI_ID']) {
          for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
            if (this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.TRAM_VT || this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.TRAM_CAP_PORT) {
              this.DT_CONTROLS.value[i] = ds[0]['DONVI_ID'] ? ds[0]['DONVI_ID'] : 0 //:(ds[1]&&ds[1]['DONVI_ID']?ds[1]['DONVI_ID']:0);
            }
            if (this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.TTKD_NGHIEMTHU) this.DT_CONTROLS.value[i] = this.$root.token.getDonViID()
          }
          this.listbox.donvi_ql.value = ds[0]['DONVIQL_ID']
        }
        // if(!this.listbox.donvi_ql.list.find(x=>x.donvi_id==this.listbox.donvi_ql.value)) {
        //   this.listbox.donvi_ql.list.push({donvi_id:ds[0]['DONVIQL_ID'],ten_dv:ds[0]['TEN_DVQL']});
        //   console.info(this.listbox.donvi_ql.list,{donvi_id:ds[0]['DONVIQL_ID'],ten_dv:ds[0]['TEN_DVQL']})
        // }
        // this.HT_GIAODIEN_DONVI();
      } else {
        if (ds[0]['DONVI_ID']) {
          for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
            if (this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.TRAM_VT || this.DT_CONTROLS.list[i]['LOAIDV_DICH_ID'] == LOAI_DV.TRAM_CAP_PORT) {
              // let dl = this.DT_DV(i).filter(x=>x.id==ds[0]['DONVI_ID']);
              // if(dl && dl.length>0)
              this.DT_CONTROLS.value[i] = ds[0]['DONVI_ID'] ? ds[0]['DONVI_ID'] : ds[1] && ds[1]['DONVI_ID'] ? ds[1]['DONVI_ID'] : 0
            }
          }
          this.listbox.donvi_ql.value = ds[0]['DONVIQL_ID']
        }
        this.popupQueue.push({
          component: () => import('./Popups/popupChonGrid'),
          name: 'popupChonDVLD',
          data: {
            ds: ds,
            cols: [
              { fieldName: 'DONVIQL_ID', headerText: 'ID', allowFiltering: false, allowSorting: false },
              { fieldName: 'TEN_DVQL', headerText: 'Đơn vị', allowFiltering: false, allowSorting: false },
              { fieldName: 'TEN_DV', headerText: 'Tổ thi công', allowFiltering: false, allowSorting: false }
            ],
            keycol: 'DONVIQL_ID',
            allowExit: false,
            tieude: 'Chọn đơn vị lắp đặt',
            tieudebang: 'Danh sách đơn vị'
          }
        })
        this.ShowPopupQueue()
        // this.popupComponent = ()=>import('./Popups/popupChonGrid');
        // this.popupComponentName = "popupChonDVLD";
        // this.popupComponentData = {"ds":ds,cols:[
        //   {fieldName: 'DONVIQL_ID', headerText: 'ID', allowFiltering: false, allowSorting: false},
        //   {fieldName: 'TEN_DVQL', headerText: 'Đơn vị', allowFiltering: false, allowSorting: false},
        //   {fieldName: 'TEN_DV', headerText: 'Tổ thi công', allowFiltering: false, allowSorting: false},
        // ],keycol: "DONVIQL_ID",allowExit:false,tieude:"Chọn đơn vị lắp đặt",tieudebang:"Danh sách đơn vị",}
        // this.Popup('popupComponents');
      }
    },
    nganhangTTChanged(val) {
      if (!val) return
      this.listbox.nganhang.isnganhangnn = this.listbox.nganhang.list.filter((x) => x.nganhang_id == val)[0].loai_nh == 2
      if (this.listbox.nganhang.isnganhangnn) this.$bvModal.show('modal-nganhangnn')
    },
    popupTieuNganh() {
      if (!this.watcherActive) return
      this.popupComponent = () => import('./Popups/popupTieuNganh')
      this.popupComponentName = 'popupTieuNganh'
      this.popupComponentData = { vnganhnghe_id: this.listbox.nganhngheloc.value, tieunganh: this.tieunganh }
      this.Popup('popupComponents')
      // this.$bvModal.show('modal-tieunganh');
      // API.post_lay_ds_tieunganh(this.axios, { "vkieu":1, "vnganhnghe_id": this.listbox.nganhngheloc.value, "vtc_id": 0 }).then((response) => {
      //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //     this.tieunganh.dsTNC1 = response.data.data;
      //     if(this.tieunganh.dsTNC1 && this.tieunganh.dsTNC1.length>0) this.tieunganh.TNC1_ID = this.tieunganh.dsTNC1[0].tnc1_id;
      //   }
      //   else { this.tieunganh.dsTNC1 = []; this.tieunganh.TNC1_ID = 0; }
      // });
    },
    popupDVCongThem() {
      this.popupComponent = () => import('./Popups/popupServiceAdds')
      this.popupComponentName = 'popupServiceAdds'

      let linhvuc_id = 0
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.BRANDNAME) {
        //SMS Brandname
        if (this.gridEditors == null) return
        // grvMacdinh.CloseEditor();
        for (var index = 0; index < this.gridEditors.length; ++index) {
          if (this.gridEditors[index].ID == 'LINHVUC_ID')
            if (this.gridEditors[index].Value && this.gridEditors[index].Value != '') {
              linhvuc_id = this.gridEditors[index].Value * 1
              break
            }
        }
        // m_dsThueBao_DichVu = tchopdong.LAY_DS_THUEBAO_DICHVU_LINHVUC_V2(hdtb_id, 0, this.listbox.loaihinh_tb.value, linhvuc_id, 1);
      }
      this.popupComponentData = { _loaitb_id: this.listbox.loaihinh_tb.value, _hdtb_id: this.hdtb_id, _linhvuc_id: linhvuc_id, _tocdo_id: this.tocdo_id, lvDvgt: this.m_dsThueBao_DichVu }//.filter((x) => x.dangky) }
      this.Popup('popupComponents')
    },
    popupDVKhac() {
      this.popupComponent = () => import('./Popups/popupServiceOthers')
      this.popupComponentName = 'popupServiceOthers'
      this.popupComponentData = { _loaitb_id: this.listbox.loaihinh_tb.value, _loai_id: 1, _thanhtoan_id: this.thanhtoan.thanhtoan_id } //default trong code cu, loai_id=1, thanhtoan_id=0
      if (this.dsDK_DVK_TB && this.dsDK_DVK_TB.length > 0) this.popupComponentData.ds = this.dsDK_DVK_TB
      this.Popup('popupComponents')
    },
    popupDVKhacTT() {
      this.popupComponent = () => import('./Popups/popupServiceOthers')
      this.popupComponentName = 'popupServiceOthersTT'
      this.popupComponentData = { _loaitb_id: this.listbox.loaihinh_tb.value, _loai_id: 2, _thanhtoan_id: this.thanhtoan.thanhtoan_id } //default trong code cu, loai_id=1, thanhtoan_id=0
      if (this.dsDK_DVK_TT && this.dsDK_DVK_TT.length > 0) this.popupComponentData.ds = this.dsDK_DVK_TT
      this.Popup('popupComponents')
    },
    async popupMuaTB() {
      let comdata = { _loaitb_id: this.listbox.loaihinh_tb.value }
      let kq = await API.fn_kiemtra_hienthi_thietbi_theo_loaitb(this.axios, { loaitb_id: this.listbox.loaihinh_tb.value }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          return response.data.data
        } else {
          return -1
        }
      })
      if (kq == 'OK') {
        try {
          comdata.tocdo_id = this.ItemList.find((x) => x.sFieldName == 'TOCDO_ID').sValue * 1 //Convert.ToInt64(ItemList.Where(x => x.sFieldName == "TOCDO_ID").First().sValue);
          if (!comdata.tocdo_id) throw 'Hãy chọn gói cước trước khi chọn mua thiết bị thu phí 1 lần.'
        } catch (ex) {
          if (this.debug) console.error(ex)
          this.$toast.error('Hãy chọn gói cước trước khi chọn mua thiết bị thu phí 1 lần.')
          return
        }
      }
      console.log(comdata)
      if (this.thamsomacdinh['HT_CTMUATBI_V2'] == 1) comdata.formversion = 2
      this.popupComponent = () => import('./Popups/popupBuyDevices')
      this.popupComponentName = 'popupBuyDevices'
      this.popupComponentData = comdata
      if (this.dsCTM_TBI && this.dsCTM_TBI.length > 0) this.popupComponentData.ds = this.dsCTM_TBI
      this.Popup('popupComponents')
    },
    popupChonKhuVuc() {
      if (!this.diachiLD.QUAN_ID || this.diachiLD.QUAN_ID <= 0 || !this.diachiLD.PHUONG_ID || this.diachiLD.PHUONG_ID <= 0) {
        this.$toast.error('Chưa có thông tin về địa chỉ lắp đặt. Bạn hãy kiểm tra lại!')
        return
      }

      this.popupQueue.push({
        component: () => import('./Popups/popupGanKhuVucQuanLyThueBao'),
        name: 'popupChonKhuVuc',
        data: { diachi: this.diachiLD, khuvuc_id: this.thuebao.khuvuc_id, hdtb_id: this.hdtb_id, thuebao_id: this.thuebao.thuebao_id, donvi_id: this.listbox.donvi_ql.value }
      })
      this.ShowPopupQueue()
      // this.popupComponent = ()=>import('./Popups/popupGanKhuVucQuanLyThueBao');
      // this.popupComponentName = "popupChonKhuVuc";
      // this.popupComponentData = {diachi:this.diachiLD, khuvuc_id: this.thuebao.khuvuc_id, hdtb_id: this.hdtb_id,thuebao_id: this.thuebao.thuebao_id, donvi_id: this.listbox.donvi_ql.value }
      // //if(this.dsCTM_TBI && this.dsCTM_TBI.length>0) this.popupComponentData.ds = this.dsCTM_TBI;
      // this.Popup('popupComponents');
    },
    popupDSHuongKN() {
      this.popupComponent = () => import('./Popups/popupDSHuongKN' + (this.thamsomacdinh['SD_FRMDSHUONGKN_V2'] == 1 ? 'V2' : ''))
      this.popupComponentName = 'popupDSHuongKN'
      this.popupComponentData = { kieu: this.listbox.chu_quan.valuewan == 9 ? 0 : 1, dichvuvt_id: this.listbox.dichvu_vt.value, tinhkn_id: this.listbox.tinh_kn.value } // O day dung enums CHUQUAN.VNPT_TINH nhung chi co 1 gia tri duy nhat = 9 nen loai bo enums luon!
      this.Popup('popupComponents')
    },
    async popupTienKM() {
      let ds = []
      if (this.thamsomacdinh['HT_KMTT'] && this.thamsomacdinh['HT_KMTT'] == 1) {
        await API.post_lay_ds_tien_kmtt(this.axios, { vkieuld_id: this.listbox.kieu_ld.value, vloaihd_id: LoaiHopDong.DAT_MOI, vloaitb_id: this.listbox.loaihinh_tb.value }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            ds = response.data.data
            if (this.ds_tien_khoanmuc && this.ds_tien_khoanmuc.length > 0)
              for (var item of ds) {
                var items = this.ds_tien_khoanmuc.filter((x) => x.khoanmuctt_id == item.khoanmuctt_id)
                if (items && items.length > 0) {
                  item.tien = items[0].tien
                  item.vat = items[0].vat
                  item.tongtien = item.tien + item.vat
                }
              }
          }
        })
        this.popupComponentData = {
          ds: ds,
          cols: [
            { fieldName: 'tentat_kmtt', headerText: 'Khoản mục', allowFiltering: false, allowSorting: false, isPrimaryKey: true },
            { fieldName: 'tongtien', textAlign: 'right', allowEditing: true, editType: 'numericedit', format: 'N', customAttributes: { class: 'tongtien' }, headerText: 'Tổng tiền', allowFiltering: false, allowSorting: false, edit: 'tongtienParam' },
            { fieldName: 'tien', textAlign: 'right', allowEditing: true, editType: 'numericedit', format: 'N', customAttributes: { class: 'cuoclapdat' }, headerText: 'Tiền', allowFiltering: false, allowSorting: false, edit: 'tienParam' },
            { fieldName: 'vat', textAlign: 'right', format: 'N', customAttributes: { class: 'vatlapdat' }, headerText: 'Vat', allowFiltering: false, allowSorting: false },
            { fieldName: 'tyle_vat', textAlign: 'right', format: 'N', headerText: 'Tỷ lệ vat', allowFiltering: false, allowSorting: false }
          ],
          keycol: 'khoanmuctt_id',
          allowExit: false,
          tieude: 'Chi tiết tiền khoản mục',
          tieudebang: 'Chi tiết khoản mục thanh toán',
          vkieuld_id: this.listbox.kieu_ld.value,
          vloaihd_id: LoaiHopDong.DAT_MOI,
          vloaitb_id: this.listbox.loaihinh_tb.value,
          ds_tien_caidat: this.ds_tien_khoanmuc,
          m_dsTienCTKM: this.m_dsTienCTKM,
          is_nv_vnpti: this.is_nv_vnpti ? 1 : 0
        }

        this.popupComponentName = 'popupCT_TienKM'
        this.popupComponent = () => import('./Popups/popupCT_TienKM')
        this.Popup('popupComponents')
      } else {
        await API.post_lay_khoanmuc_tt_theo_loaihd(this.axios, { vloaihd_id: LoaiHopDong.DAT_MOI }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            ds = response.data.data
            if (this.ds_tien_khoanmuc && this.ds_tien_khoanmuc.length > 0)
              for (var item of ds) {
                var items = this.ds_tien_khoanmuc.filter((x) => x.khoanmuctt_id == item.khoanmuctt_id)
                if (items && items.length > 0) {
                  item.tien = items[0].tien ? items[0].tien : 0
                  item.vat = items[0].vat ? items[0].vat : 0
                  item.tongtien = item.tien + item.vat
                }
              }
          }
        })
        this.popupComponentData = {
          ds: ds,
          cols: [
            { fieldName: 'tentat_kmtt', headerText: 'Khoản mục', allowFiltering: false, allowSorting: false, isPrimaryKey: true },
            { fieldName: 'tongtien', textAlign: 'right', allowEditing: true, editType: 'numericedit', format: 'N', customAttributes: { class: 'tongtien' }, headerText: 'Tổng tiền', allowFiltering: false, allowSorting: false, edit: 'tongtienParam' },
            { fieldName: 'tien', textAlign: 'right', allowEditing: true, editType: 'numericedit', format: 'N', customAttributes: { class: 'cuoclapdat' }, headerText: 'Tiền', allowFiltering: false, allowSorting: false, edit: 'tienParam' },
            { fieldName: 'vat', textAlign: 'right', format: 'N', customAttributes: { class: 'vatlapdat' }, headerText: 'Vat', allowFiltering: false, allowSorting: false }
          ],
          keycol: 'khoanmuctt_id',
          allowExit: false,
          tieude: 'Chi tiết tiền khoản mục',
          tieudebang: 'Chi tiết khoản mục thanh toán'
        }
        this.popupComponentName = 'popupTienKM'
        this.popupComponent = () => import('./Popups/popupTienKM')
        this.Popup('popupComponents')
      }
    },
    async tsbtnThemTB_Click() {
      this.loading(true)
      try {
        if(this.listbox.dichvu_vt.value==DichVuVienThong.DI_DONG && this.listbox.loaihinh_tb.value==LoaiHinhTB.HoaMangChuyenTinh)
          throw "Không hỗ trợ thêm thuê bao với loại hình di động hoà mạng chuyển tỉnh!";
        if (this.DT_CONTROLS.list && this.DT_CONTROLS.list.length > 0)
          for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
            if (!this.DT_CONTROLS.value[i] || this.DT_CONTROLS.value[i] <= 0) throw `Chưa chọn thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}`
          }
        //TODO bo qua 17528 - 17539 do khong lien quan phan CO_DINH
        if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH && this.thuebao.codinh.arraySoMay && this.thuebao.codinh.arraySoMay.length > 0)
          //for(let sm of this.thuebao.codinh.arraySoMay) {
          while (this.thuebao.codinh.arraySoMay && this.thuebao.codinh.arraySoMay.length > 0) {
            this.thuebao.codinh.somay = this.thuebao.codinh.arraySoMay.pop()
            await this.ThemHDThueBao()
          }
        else if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH && (!this.thuebao.codinh.arraySoMay || this.thuebao.codinh.arraySoMay.length <= 0)) {
          this.$toast.error('Bạn cần chọn danh sách số máy cần thêm thuê bao!')
          this.ShowPopupChonSM()
        } else {
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IMS_SIPTRUNKING && this.thuebao.ims.arraySoMay.length > 0)
            for (let sm of this.thuebao.ims.arraySoMay) {
              this.thuebao.ims.txtMaTBIMS = sm
              this.ThemHDThueBao()
            }
          else this.ThemHDThueBao()
        }
      } catch (ex) {
        this.$toast.error('Có lỗi trong quá trình thêm HĐTB: ' + ex)
      } finally {
        this.loading(false)
      }
    },
    async ThemHDThueBao() {
      try {
        let tocdotn_id = 0
        this.muccuoctn_id = 0
        let KT_KVNLML = 1

        if(this.thanhtoan.thanhtoan_id && this.thanhtoan.thanhtoan_id>0) {
          var rpno = await API.get_tracuu_no_thanhtoan(this.axios, { params: { thanhToanId: this.thanhtoan.thanhtoan_id } }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000')
              return response.data.data;
            else return 0;
          }).catch(()=> { return 0; } );
          if(rpno && rpno>0) {
            let cfr = await this.$bvModal
              .msgBoxConfirm(`Mã thanh toán ${this.thanhtoan.matt?this.thanhtoan.matt:this.thanhtoan.thanhtoan_id} còn nợ ${Intl.NumberFormat("vi-VN", {
                  style: "currency",
                  currency: "VND"
              }).format(rpno)}\r\nBạn có muốn tiếp tục?`, {
                title: 'Thông báo',
                size: 'sm',
                okTitle: 'Đồng ý',
                cancelTitle: 'Hủy'
              })
              .then((v) => {
                return v
              })
            if (!cfr) {
              throw "Dừng xử lý thêm mới để kiểm tra thông tin nợ!"
            }
          }
        }

        //TODO bo qua 10549 - 10593 do khong lien quan phan CO_DINH
        //trien khai luon cua LayMaTB(true)
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
          await this.SinhMaDVVT(true)
          // if (fiber_hoa)
          //     txtAccountADSL.Text = txtAccountADSL.Text.ToUpper();
        }
        else if (
            (this.thuebao.adsl.txtAccountADSL+'').trim().length == 0 &&
            (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B || this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_ANALOG || this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL || this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_MESH || this.listbox.loaihinh_tb.value == LoaiHinhTB.INDOOR_CAM || this.listbox.loaihinh_tb.value == LoaiHinhTB.OUTDOOR_CAM)
        ) {
          await this.SinhMaDVVT(true)
          if (this.thamsomacdinh['FIBER_HOA'] == 1) this.thuebao.adsl.txtAccountADSL = (this.thuebao.adsl.txtAccountADSL+'').toUpperCase()
        }
        if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
          await this.SinhMaDVVT(true)
          tocdotn_id = this.listbox.tocdokenh.valuecir
        } else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) tocdotn_id = this.listbox.tocdokenh.valuetsl
        //Convert.ToInt32(cboTocDoKenhTSL.EditValue);
        else if (
          this.listbox.dichvu_vt.value == DichVuVienThong.ADSL ||
          this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES ||
          this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC ||
          this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT ||
          this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU ||
          this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH ||
          this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT
        ) {
          tocdotn_id = this.listbox.cboGoiCuocAdsl.value
          if (
            this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_MYTV &&
            // ANh Hiếu bảo thêm
            this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_MYTV_B2B &&
            this.listbox.dichvu_vt.value != DichVuVienThong.HOINGHI_TRUYENHINH &&
            this.listbox.dichvu_vt.value != DichVuVienThong.ANTOAN_BAOMAT_TT &&
            this.listbox.dichvu_vt.value != DichVuVienThong.TRUNGTAM_DULIEU &&
            this.listbox.dichvu_vt.value != DichVuVienThong.DICHVU_CNTT &&
            this.listbox.dichvu_vt.value != DichVuVienThong.BRCD_DOITAC &&
            this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_SGTV &&
            this.listbox.loaihinh_tb.value != LoaiHinhTB.HTVC_FIBERVNN_ANALOG &&
            this.listbox.loaihinh_tb.value != LoaiHinhTB.HTVC_FIBERVNN_DIGITAL &&
            this.listbox.loaihinh_tb.value != LoaiHinhTB.TIVI_SAMSUNG
          ) {
            this.muccuoctn_id = this.listbox.muccuoc.value
          }
        }
        await this.LayMaTB(true)
        if (!(await this.KiemTraDL_ThueBao(true))) return
        if (!this.ngaySinhChanged()) return
        // this.ma_tb_ht = this.thuebao.codinh.somay;

        // var pdata = { "KHACHHANG_ID":this.khachhang.khachhang_id,"DOITUONG_ID":this.listbox.doituong.value,"LOAIKH_ID":this.listbox.loai_kh.value,"LOAITB_ID":this.listbox.loaihinh_tb.value,"HDKH_ID":this.khachhang.hdkh_id,"JS_TRATRUOC":[],"JS_LIST":[],"JS_MUA_TBI":[],"THEMMOI":this.buttonSet==1,"KIEULD_ID":this.listbox.kieu_ld.value,"SOMAY_CD":this.thuebao.codinh.somay,"DICHVUVT_ID":this.listbox.dichvu_vt.value,"TINHKHAC":this.thuebao.tinhkhac,"MA_TB_HT":this.ma_tb_ht,"TTND_DVI":1,"TUDONG_SINH_SOAO":this.TUDONG_SINH_SOAO?1:0,"MA_TB_AO_HT":this.ma_tb_ao_ht,"MA_TB_AO_HT_CUOI":this.ma_tb_ao_ht_cuoi,"SOAO_ADSL":this.thuebao.adsl.txtSoAoAdsl,"SOAO_TSL_DAU":this.thuebao.tsl.txtSoAoTSL_Dau,"SOAO_TSL_CUOI":this.thuebao.tsl.txtSoAoTSL_Cuoi,"SOAO_WAN":this.thuebao.mgwan.soao,"OPEN_SYNC_VINA_TRASAU":TRANGTHAI_DONGBO.OPEN_SYNC_VINA_TRASAU?1:0,"MA_TT":this.thanhtoan.matt?this.thanhtoan.matt:null,"BATBUOC_GHEP_MATT":this.thamsomacdinh['BATBUOC_GHEP_MATT'],"KIEMTRA_GHEP_MATT_CNTT":this.thamsomacdinh['KIEMTRA_GHEP_MATT_CNTT'],"TOCDOTN_ID":tocdotn_id,"MUCCUOCTN_ID":muccuoctn_id }

        let pdata = {
          FIBER_BS: this._fiberBoSung,
          KIEULD_ID: this.listbox.kieu_ld.value,
          CONGNGHE_ID: this.listbox.congnghe.value,
          MATB_TN: this.thuebao.adsl.txtMaTN_ADSL,
          TINHKHAC: this.TinhKhac,
          HDKH_ID: this.khachhang.hdkh_id,
          MA_TB_HT: this.ma_tb_ht,
          MA_TB_HT_AO: this.ma_tb_ao_ht,
          MATB_WAN: this.thuebao.mgwan.somay,
          TOCDOTN_ID: tocdotn_id,
          MUCCUOCTN_ID: this.muccuoctn_id,
          LOAITB_ID: this.listbox.loaihinh_tb.value,
          DICHVUVT_ID: this.listbox.dichvu_vt.value,
          TTND_DVI: this.$root.token.getDonViID(),
          SOAO_ADSL: this.thuebao.adsl.txtSoAoAdsl,
          DOITUONG_ID: this.listbox.doituong.value,
          GOICUOCADSL: this.listbox.cboGoiCuocAdsl.value,
          DONVI_QL_ID: this.listbox.donvi_ql.value,
          NGAY_YC: this.NgayYeuCau ? this.NgayYeuCau.substring(3, 10) : this.NgayYeuCau,
          SOAO_TSL_DAU: this.thuebao.tsl.txtSoAoTSL_Dau,
          SOAO_TSL_CUOI: this.thuebao.tsl.txtSoAoTSL_Cuoi,
          SOAO_WAN: this.thuebao.mgwan.soao,
          HDTB_ID: this.hdtb_id ? this.hdtb_id : 0,
          TRANGBI_ID: this.trangbi_id,
          LOAIKH_ID: this.listbox.loai_kh.value,
          KHACHHANG_ID: this.khachhang.khachhang_id,
          DONGBO_TEST: this.DONGBO_TEST.TEST
        }
        let checkloi = false
        let dulieuapi = {}
        let err = await API.post_fn_lay_tt_them_thuebao_datmoi(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            dulieuapi = JSON.parse(response.data.data)
            if (dulieuapi['ERROR_CODE'] == 0) {
              this.$toast.error(dulieuapi['MESSAGE'])
              return 'err'
            }
            if (dulieuapi['RESULT']) dulieuapi = dulieuapi['RESULT']
            if (dulieuapi['KT_KV_NLML']) KT_KVNLML = dulieuapi['KT_KV_NLML']
            if (KT_KVNLML && KT_KVNLML != 'ok' && KT_KVNLML != 1) {
              let cfr = await this.$bvModal
                .msgBoxConfirm(`${KT_KVNLML + ''} "\r\nBạn có muốn thay đổi địa chỉ để tiếp tục?`, {
                  title: 'Thông báo',
                  size: 'sm',
                  okTitle: 'Đồng ý',
                  cancelTitle: 'Hủy'
                })
                .then((v) => {
                  return v
                })
              if (cfr) {
                if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
                  // VDCService vdc = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
                  // vdc.HuyDatChoMegaVNN(txtAccountADSL.Text);
                  await vdc.HuyDatChoMegaVNN(this.thuebao.adsl.txtAccountADSL)
                }

                // this.buttonSet = 0

                // this.$toast.success('Hợp đồng đã được thoái trả. Khách hàng sẽ được đưa vào danh sách Khách hàng tiềm năng!')
                checkloi = true;
                return 'err'
              } else KT_KVNLML = 0
            } else KT_KVNLML = 1
            if (dulieuapi['KIEMTRA_DK_APDUNG']) KIEMTRA_DK_APDUNG = dulieuapi['KIEMTRA_DK_APDUNG']
            return null
          }
        })
        if (err && err == 'err') return
        if ((this.listbox.loaihinh_tb.value == LoaiHinhTB.CA || this.listbox.loaihinh_tb.value == LoaiHinhTB.SMART_CA) && (!this.dsHDTB_SUB || this.dsHDTB_SUB.length <= 0) && this.buttonSet == 1) {
          let c = null
          if (this.hdtb_id)
            c = await API.lay_tt_thuebao_bosung_ca(this.axios, { vhdtb_id: this.hdtb_id })
              .then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  return response.data.data
                }
              })
              .catch(() => {
                return null
              })
          if (!c || c.length <= 0) {
            this.$toast.error('Cần nhập thông tin TB với loại hình thuê bao CA / SMART CA')
            return
          } else {
            this.dsHDTB_SUB = this.UpperCasePropertyList(c)
            for(var item of this.dsHDTB_SUB)
              if(item['NGAYHETHAN_GT']) item['NGAYHETHAN_GT'] = moment(item['NGAYHETHAN_GT']).format('DD/MM/YYYY')
          }
          // this.$toast.error("Cần nhập thông tin TB với loại hình thuê bao CA / SMART CA");
          // return;
        }
        if (dulieuapi['DS_HUONGGIAO_TN'] && dulieuapi['DS_HUONGGIAO_TN'].length > 0 && dulieuapi['DS_HUONGGIAO_TN'][0].QUYTRINH_ID) {
          // Them 16/9, khong hieu sao lai tra ve tu phía trên mà không cần gọi phần bên dưới????
          if (dulieuapi['DS_HUONGGIAO_TN'][0].QUYTRINH_ID) this.quytrinh_tn = dulieuapi['DS_HUONGGIAO_TN'][0].QUYTRINH_ID
          if (dulieuapi['DS_HUONGGIAO_TN'][0].LUONG_ID) this.luong_id = dulieuapi['DS_HUONGGIAO_TN'][0].LUONG_ID
          if (dulieuapi['DS_HUONGGIAO_TN'][0].HUONGGIAO_ID) this.huonggiao_tn = dulieuapi['DS_HUONGGIAO_TN'][0].HUONGGIAO_ID
        } else {
          let pdata = {
            kieuLdId: this.listbox.kieu_ld.value,
            loaiHdId: this.buttonSet == 1 ? LoaiHopDong.DAT_MOI : '1',
            loaiTbId: this.listbox.loaihinh_tb.value,
            mucCuocId: this.muccuoctn_id, //(this.listbox.muccuoc.value && this.listbox.muccuoc.value>0)?this.listbox.muccuoc.value:-1,
            tocDoId: tocdotn_id //0 //this.tocdo_id?this.tocdo_id:-1
          }
          this.huonggiao_tn = 0
          this.quytrinh_tn = 0
          this.luong_id = 0
          await API.post_lay_huonggiao_tiepnhan(this.axios, pdata).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              let dlapi = response.data.data
              if (dlapi['huonggiao_id']) this.huonggiao_tn = dlapi['huonggiao_id']
              if (dlapi['quytrinh_id']) this.quytrinh_tn = dlapi['quytrinh_id']
              if (dlapi['luong_id']) this.luong_id = dlapi['luong_id']
            }
          })
        }

        //await this.TaoDuLieu(true); //??? tai sao truoc lai viet TaoDuLieu o day????
        try {
          await this.TaoDuLieu_HDKH(false) // Them phan nay de xu ly truong hop hop dong di dong can su dung den bien this.dsHDKH, bên dưới khi insert ko dùng cái này vào nên không vấn đề gì!
        } catch(ex) { if(this.debug) console.error(ex); }
        await this.TaoDuLieu_HDTB(true)
        if (this.listbox.doituong.value == DUNG_THU.DOITUONG_TB) await this.TaoDuLieu_HDTB_DUNGTHU(true)
        await this.TaoDuLieu_HDTT(false)
        await this.TaoDuLieu_THONGTIN_TT(true)
        await this.TaoDuLieu_CT_TIENHD(true)
        this.dsTien_HDTB = []
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
          this.TaoDuLieu_TIEN_HDTB_TC(true)
        }
        await this.TaoDuLieu_TIEN_DATCOC(true)
        await this.TaoDuLieu_DiaChi(true, 3)
        await this.TaoDuLieu_DKDV()
        await this.CapNhat_HDTB_ID_DangKyDV()

        await this.CapNhat_HDTB_ID_HDTB_KV_ThemTB() // LINE 10812 ###RECENT

        this.dsHDTB_CD = []
        this.dsHDTB_DD = []
        this.dsHDTB_ADSL = []
        this.dsHDTB_TSL = []
        this.dsHDTB_MEWAN = []
        this.dsHDTB_GP = []
        this.dsHDTB_IMS = []
        this.dsCAMKET_HDTB = []
        this.dsHDTBDV = []
        this.dsHDTB_CNTT = []
        switch (this.listbox.dichvu_vt.value * 1) {
          case DichVuVienThong.CO_DINH:
            await this.TaoDuLieu_HDTB_CD(true)
            await this.TaoDuLieu_CAMKET_HDTB(true)
            break
          case DichVuVienThong.DI_DONG:
            await this.TaoDuLieu_HDTB_DD(true)
            break
          case DichVuVienThong.MEGAWAN:
          case DichVuVienThong.METRONET:
          case DichVuVienThong.MGW_DOITAC:
          case DichVuVienThong.NOIBO_DADIEM:
            await this.TaoDuLieu_HDTB_MGWAN(true)
            break
          case DichVuVienThong.DICHVU_CNTT:
          case DichVuVienThong.ANTOAN_BAOMAT_TT:
          case DichVuVienThong.TRUNGTAM_DULIEU:
          case DichVuVienThong.HOINGHI_TRUYENHINH:
            for (var item of this.ItemList) {
              let guiItem = this.gridEditors.filter((x) => x.ID == item.sFieldName)
              if (guiItem && guiItem.length > 0) item.sValue = guiItem[0].Value ? guiItem[0].Value + '' : guiItem[0].Value
            }
            this.dsHDTB_CNTT = this.ItemList
            //Tạo cho bảng hdtb_dv
            for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

              if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
                throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
                return;
              }
              let row = {}
              row.HDTB_ID = this.hdtb_id
              row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
              row.DONVI_ID = this.DT_CONTROLS.value[i]
              row.KIEUDV_ID = 2
              this.dsHDTBDV.push(row)
            }
            await this.TAO_DULIEU_HDTB_SUB(true)
            break
          case DichVuVienThong.MEGA_EYES:
          case DichVuVienThong.ADSL:
          case DichVuVienThong.BRCD_DOITAC:
            await this.TaoDuLieu_HDTB_ADSL(true)
            break
          case DichVuVienThong.TSL:
          case DichVuVienThong.TSL_DOITAC:
          case DichVuVienThong.NOIBO_2DIEM:
            await this.TaoDuLieu_HDTB_TSL(true)
            break
          case DichVuVienThong.GPHONE:
            await this.TaoDuLieu_HDTB_GP(true)
            await this.TaoDuLieu_CAMKET_HDTB(true)
            break
          case DichVuVienThong.IMS:
          case DichVuVienThong.IMS_DOITAC:
            await this.TaoDuLieu_HDTB_IMS(true)
            await this.TaoDuLieu_CAMKET_HDTB(true)
            break
        }
        var ctab = this.currentTab + ''
        var isvalid = true
        this.currentTab = 'tab1'
        document.querySelectorAll('.main-wrapper .page-content #tab1 input').forEach((item) => {
          if (isvalid && !item.validity.valid) {
            isvalid = false
            this.$refs['tab1'].click()
            var thongbaostr = item.getAttribute('title')
            if (!thongbaostr) thongbaostr = 'Lỗi dữ liệu, vui lòng kiểm tra lại!'
            this.$toast.error(thongbaostr)
            if (this.debug) console.error(thongbaostr, item)
            //this.$toast.error(item.getAttribute('title'));
            item.focus()
          }
        })
        if (!isvalid) return
        this.currentTab = 'tab2'
        document.querySelectorAll('.main-wrapper .page-content #tab2 input').forEach((item) => {
          if (isvalid && !item.validity.valid) {
            isvalid = false
            this.$refs['tab2'].click()
            var thongbaostr = item.getAttribute('title')
            if (!thongbaostr) thongbaostr = 'Lỗi dữ liệu, vui lòng kiểm tra lại!'
            this.$toast.error(thongbaostr)
            if (this.debug) console.error(thongbaostr, item)
            //this.$toast.error(item.getAttribute('title'));
            item.focus()
          }
        })
        if (!isvalid) return
        this.$refs[ctab == 'all' ? 'tab2' : ctab].click()
        //TODO bo qua tu 10913 - 11052
        // Dat cho tren VISA
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL) {
          let loaihinh_tb = this.listbox.loaihinh_tb.value
          if (loaihinh_tb == LoaiHinhTB.INTERNET_1260 || loaihinh_tb == LoaiHinhTB.INTERNET_ADSL || loaihinh_tb == LoaiHinhTB.INTERNET_FTTH || loaihinh_tb == LoaiHinhTB.WIFI_FIBER) {
            if (this.DONGBO_TEST.TEST == false) {
              // VDCService vdcService = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
              let account = this.dsHDTB[0]['MA_TB']
              let contex = this.ma_lhtb_vdc //objCheckData.MAP_ID("ma_lhtb_vdc", DatabaseConstants.DB2 + ".loaihinh_tb", "where loaitb_id =" + cboLoaihinhTB.SelectedValue.ToString());
              let pdata = {
                accountModel: { accountName: account }
                //"reservemodel": { "context":contex, "reservedTime": "2022-01-11" } //Bỏ do VISA default vào FTTH rồi
              }
              await API.post_reserveRASAccount(this.axios, pdata).then((response) => {
                if (response && response.data && response.data.data && response.data.errorCode != 1) this.thuebao.statusVdc = response.data.data == 'ok'
                else {
                  //this.$toast.error(response.data.faultCode+': '+response.data.faultString);
                  throw response.data.faultCode + ': ' + response.data.faultString
                }
              })
              if (!this.thuebao.statusVdc) {
                this.$toast.error('Có lỗi xảy ra trong quá trình đặt chỗ Account ' + account + ' lên Visa.Bạn hãy vui lòng thực hiện lại chức năng này!')
                return
              }
              this.thuebao.check_tb_adsl = true //Hiếu thêm biến kiểm tra thuê bao ADSL đã được đặt chỗ hay chưa. 5.10.2010
            } else {
              this.thuebao.statusVdc = true
              this.thuebao.check_tb_adsl = true
            }
          }
        }
        if ((this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGACAMERA) && this.thuebao.statusVdc == true) {
          //Gọi hàm cập nhật trạng thái HDTB = 1: Đã đặt chỗ thành công trên VDC
          // obj.CAPNHAT_STATUS_HDTB(hdtb_id, TRANGTHAI_DONGBO.DONGBO_LHD);
          this.txtStatus = TRANGTHAI_DONGBO.DONGBO_LHD
          if(this.dsHDTB && this.dsHDTB.length==1)
            this.dsHDTB[0].STATUS = this.txtStatus;
        }

        //Cập nhật trạng thái đồng bộ nếu là thuê bao di động trả sau
        if (this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG && this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRASAU && TRANGTHAI_DONGBO.OPEN_SYNC_VINA) {
          // new LapHopDongFacade().CAPNHAT_STATUS_HDTB(hdtb_id, TRANGTHAI_DONGBO.DONGBO_LHD);
          this.txtStatus = TRANGTHAI_DONGBO.DONGBO_LHD
          if(this.dsHDTB && this.dsHDTB.length==1)
            this.dsHDTB[0].STATUS = this.txtStatus;
        }
        // Kich hoat dang ky len he thong Camera
        if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) {
          let loaihinh_tb = this.listbox.loaihinh_tb.value
          if (loaihinh_tb == LoaiHinhTB.MEGACAMERA) {
            if (this.DONGBO_TEST.TEST == false) {
              this.$toast.error('Dịch vụ này tạm dừng cung cấp! Vui lòng liên hệ admin.')
              return
              let matinh = this.$root.token.getMaTinh()
              // CameraService camera = new CameraService();
              let city_id = matinh
              let agent_id = matinh
              let customer_id = this.dsHDKH[0]['MA_KH']
              let subscription_id = 0
              var integrated_services
              let message = ''
              let kieu = this.kieu_ld_kieu
              if (kieu == 1 || kieu == 2 || kieu == 3) {
                integrated_services = 0
              } else integrated_services = 1

              let username = this.dsHDTB[0]['MA_TB']
              let password = this.dsHDTB_ADSL[0]['PASSWORD']
              let email = this.dsHDTB_ADSL[0]['EMAIL']
              //FIXME can chuyen phan nay len API
              let pdata =
                '{"city_id":"' + city_id + '","agent_id":"' + agent_id + '","customer_id":"' + customer_id + '","subscription_id":"' + subscription_id + '","integrated_services":"' + integrated_services + '","username":"' + username + '","password":"' + password + '","email":"' + email + '"}'
              // let rs = await this.$root.context.post("http://vnptapi.iveda.com/index.php/api/add",JSON.parse(pdata));
              // message = JSON.parse(rs.data);
              // this.thuebao.statusVdc = (message.indexOf("resultid\":\"0")>=0)
              let rs = await this.$root.context.post('/tichhop/iveda/add', JSON.parse(pdata))
              message = rs.faultString + JSON.parse(rs.data)
              this.thuebao.statusVdc = rs.errorCode == 0 //(message.indexOf("resultid\":\"0")>=0)
              // this.thuebao.statusVdc = camera.ThemMoiKhachHang(city_id, agent_id, customer_id, subscription_id, integrated_services, username, password, email, ref message);
              if (!this.thuebao.statusVdc) {
                this.$toast.error('Có lỗi xảy ra trong quá trình kích hoạt lên hệ thống Camera.\nLỗi: ' + message)
                return
              }
              this.thuebao.check_tb_adsl = true //Hiếu thêm biến kiểm tra thuê bao ADSL đã được đặt chỗ hay chưa. 5.10.2010
            } else {
              this.thuebao.statusVdc = true
              this.thuebao.check_tb_adsl = true
            }
          }
        }

        // #region Đồng bộ dữ liệu lên VinaPhone vuth update 0912 :Tạo mới hđ thuê bao nếu là hòa mạng mới, ngược lại nếu hòa mạng chuyển tỉnh thì thêm gọi hàm TS_LAPHD_CHUYENTINH_NEW_THUEBAO_CTS
        if (this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG && this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRASAU) {
          if (this.dsHDTB[0]['kieuld_id'.toUpperCase()] == KieuLapDat.DM_DIDONG || this.dsHDTB[0]['kieuld_id'.toUpperCase()] == KieuLapDat.DM_DIDONG_C_P || this.dsHDTB[0]['kieuld_id'.toUpperCase()] == KieuLapDat.DM_DIDONG_KHOI_TAO_LAI) {
            let rs = await this.Insert_TBLD_VinaPhone()

            if (rs != 'OK') {
              this.$toast.error('Có lỗi xảy ra trong quá trình thêm mới hợp đồng thuê bao di động trên VinaPhone.\n' + rs)
              return
            }
          } else if (this.dsHDTB[0]['kieuld_id'.toUpperCase()] == KieuLapDat.DM_DIDONG_CHUYEN_TINH) {
            let rs = await this.Insert_HDLD_VinaPhone()
            let ma_hd = this.dsHDKH[0]['ma_gd'.toUpperCase()]

            if (rs != 'OK') {
              this.$toast.error(rs)
              return
            }
          }
        }
        // #endregion

        if (this.listbox.doituong.value == DUNG_THU.DOITUONG_TB) {
          if (!(await this.Kiemtra_dungthu_mytv())) {
            // #region Lấy chi tiết khuyến mại dùng thử fill vào khuyenmai_hdtb
            let dsTemp = []
            await API.post_lay_chitiet_km_dungthu_v2(this.axios, { vloaikh_id: this.listbox.loai_kh.value }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                dsTemp = response.data.data
              }
            })

            if (dsTemp.length > 0) {
              // if (dsTemp[0]["khuyenmai_id"])
              // {
              //   this.filterbox.khuyenmai.value = dsTemp[0]["khuyenmai_id"];
              //   this.filterbox.khuyenmai.ischecked = true;
              // }
              // else
              //   this.filterbox.khuyenmai.ischecked = false;

              // DateTime tmp;
              var ithang_huongdc = 0,
                ithang_huongkm = 0,
                ithang_tg = 0
              let dtiendatcoc_csd = 0,
                dtien_td = 0
              this.dsKM_HDTB = []

              for (var i = 0; i < dsTemp.length; i++) {
                ithang_huongdc = 0
                ithang_huongkm = 0
                ithang_tg = 0
                dtiendatcoc_csd = 0
                dtien_td = 0
                let dr = {}
                if (dsTemp[i]['huong_dc']) ithang_huongdc = dsTemp[i]['huong_dc']
                if (dsTemp[i]['huong_km']) ithang_huongkm = dsTemp[i]['huong_km']
                if (dsTemp[i]['sothang_tg']) ithang_tg = dsTemp[i]['sothang_tg']
                if (dsTemp[i]['datcoc_csd']) dtiendatcoc_csd = dsTemp[i]['datcoc_csd']
                if (dsTemp[i]['tien_td']) dtien_td = dsTemp[i]['tien_td']
                dr.THANG_HUONGDC = ithang_huongdc
                dr.THANG_HUONGKM = ithang_huongkm
                dr.SOTHANG_TG = ithang_tg
                dr.DATCOC_CSD = dtiendatcoc_csd
                dr.TIEN_TD = dtien_td

                if (dsTemp[i]['kieu_bdkm'] == '3') {
                  try {
                    let tmp = moment(dsTemp[i]['thang_bd'], 'YYYYMM')
                      .add(ithang_huongkm, 'M')
                      .format('YYYYMM')
                    dr.THANG_BD = dsTemp[i]['thang_bd']
                    dr.THANG_KT = tmp
                  } catch (ex) {}
                }
                if (dsTemp[i]['kieu_bdtg'] == '3') {
                  try {
                    let tmp = moment(dsTemp[i]['thang_bdtg'], 'YYYYMM')
                      .add(ithang_tg, 'M')
                      .format('YYYYMM')
                    dr.THANG_BDTG = dsTemp[i]['thang_bdtg']
                    dr.THANG_KTTG = tmp
                  } catch (ex) {}
                }
                if (dsTemp[i]['kieu_bddc'] == '3') {
                  try {
                    let tmp = moment(dsTemp[i]['thang_bddc'], 'YYYYMM')
                      .add(ithang_huongkm, 'M')
                      .format('YYYYMM')
                    dr.THANG_BDDC = dsTemp[i]['thang_bddc']
                    dr.THANG_KTDC = tmp
                  } catch (ex) {}
                }
                //longdx: bổ sung thông tin tỷ lệ km
                dr.TYLE_KMLD = dsTemp[i]['tyle_kmld']
                dr.TYLE_SD = dsTemp[i]['tyle_sd']
                dr.TYLE_TB = dsTemp[i]['tyle_tb']
                dr.HDTB_ID = this.hdtb_id //-1;
                dr.CHITIETKM_ID = dsTemp[i]['chitietkm_id']
                dr.KHUYENMAI_ID = dsTemp[i]['khuyenmai_id']
                //dr.KHUYENMAI_ID_NEO = dsTemp[i]["khuyenmai_id_neo"];
                dr.KIEU_YC = 1
                this.dsKM_HDTB.push(dr)

                //Lấy tiền khuyến mại
                if (this.kmld.tien_kmld < dsTemp[i]['tien_kmld']) this.kmld.tien_kmld = dsTemp[i]['tien_kmld']
                if (this.kmld.vat_kmld < dsTemp[i]['vat_kmld']) this.kmld.vat_kmld = dsTemp[i]['vat_kmld']
                if (this.kmld.tyle_kmld < dsTemp[i]['tyle_kmld']) this.kmld.tyle_kmld = dsTemp[i]['tyle_kmld']

                if (this.kmld.tien_datcoc < dsTemp[i]['datcoc_csd']) this.kmld.tien_datcoc = dsTemp[i]['datcoc_csd']
              }
            }
            // #endregion
          } else {
            //TODO xem lai, chua xac dinh muc dich xoa du lieu o day!
            this.dsKM_HDTB = this.dsKM_HDTB.filter((x) => !(x.khuyenmai_id == 2999 || x.khuyenmai_id == 2998))
            // let _arrKM_DT = this.dsKM_HDTB.filter(x=>x.khuyenmai_id==2999 || x.khuyenmai_id==2998);
            // if(_arrKM_DT)
            //   for(var item in _arrKM_DT)
            //     item.Delete();
          }
        }
        let them_hrm = false
        if (this.loainv_ctv_hrm > 0 || this.loainv_ngt_hrm > 0) {
          if (this.dsHDKH_Sub && this.dsHDKH_Sub.length > 0) {
            await this.TAO_DULIEU_HDKH_SUB(this.dsHDKH_Sub, this.dsHDKH_Sub[0]['HDKH_ID'])
          } else {
            let row_khsub = {}
            row_khsub.HDKH_ID = this.dsHDKH[0]['HDKH_ID']
            if (this.loainv_ctv_hrm > 0) {
              row_khsub.LOAINV_CTV_HRM = this.loainv_ctv_hrm
            }
            if (this.loainv_ngt_hrm > 0) {
              row_khsub.LOAINV_NGT_HRM = this.loainv_ngt_hrm
            }
            this.dsHDKH_Sub = []
            this.dsHDKH_Sub.push(row_khsub)
          }
          them_hrm = true
        }
        pdata = {
          //HD_KHACHHANG:this.dsHDKH,
          HD_THUEBAO: this.dsHDTB,
          HD_THANHTOAN: this.dsHDTT,
          HDTB_DV: this.dsHDTBDV,
          HDTB_CD: this.dsHDTB_CD,
          HDTB_DD: this.dsHDTB_DD,
          HDTB_INT: this.dsHDTB_INT,
          HDTB_ADSL: this.dsHDTB_ADSL,
          DIACHI: this.dsDiaChi,
          // DIACHI_HDKH:this.dsDiaChiHDKH,
          // DIACHI_HDTT:this.dsDiaChiHDTT,
          DIACHI_HDTB: this.dsDiaChiHDTB,
          DANGKY_DVGT: this.dsDK_DVGT,
          DANGKY_DVK: this.dsDK_DVKHAC,
          CT_MUA_TBI: this.UpperCasePropertyList(this.dsCTM_TBI),
          HDTB_MGWAN: this.dsHDTB_MEWAN, //dsHDTB_MEWAN
          HDTB_TSL: this.dsHDTB_TSL, //dsHDTB_TSL
          HDTB_GP: this.dsHDTB_GP, //dsHDTB_GP
          KHUYENMAI_HDTB: this.dsKM_HDTB && this.dsKM_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsKM_HDTB) : this.dsKM_HDTB, //this.dsKM_HDTB,
          DATCOC_HDTB: this.dsDC_HDTB && this.dsDC_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsDC_HDTB) : this.dsDC_HDTB,
          THONGTIN_TT: this.dsTTTT, //this.dsTTTT,
          CT_TIENHD: this.dsCTTHD,
          TIEN_HDTB: this.dsTien_HDTB, //this.dsTien_HDTB,
          TIEN_DATCOC: this.dsTien_DatCoc,
          HDTB_IMS: this.dsHDTB_IMS, //dsHDTB_IMS
          CAMKET_HDTB: this.dsCAMKET_HDTB,
          HUONGGIAO_ID: this.huonggiao_tn,
          HDTB_KV: this.dsHDTB_KV_ThemTB && this.dsHDTB_KV_ThemTB.length > 0 ? this.dsHDTB_KV_ThemTB : this.dsHDTB_KV,
          HDTB_CNTT: this.dsHDTB_CNTT, //dsHDTB_CNTT
          // HDTT_NV: this.dsHDTT_NV,
          HDTB_DUNGTHU: this.dsHDTB_DUNGTHU,
          // TRAGOP_TBI_HDTB: this.dsTRAGOP_TBI_HDTB,
          // HDTB_LOAIIP: this.dsHDTB_LoaiIp, //this.dsHDTB_LoaiIp,
          HDKH_SUB: this.dsHDKH_Sub,
          HDTB_SUB: this.dsHDTB_SUB, //this.dsHDTB_SUB,
          THEM_HRM: them_hrm,
          // HDTB_CT: this.dsHDTB_CT,//this.dsHDTB_CT, //Chi co o phan dich vu CNTT / frmChiTietHDTB
          // THEMMOI: this.buttonSet==1,
          LOAITB_ID: this.listbox.loaihinh_tb.value,
          DICHVUVT_ID: this.listbox.dichvu_vt.value,
          KT_KVNLML: KT_KVNLML, //BUG KT_KVNLML nhung de mac dinh de chay test
          // TUDONG_SINH_SOAO: this.TUDONG_SINH_SOAO?1:0, // Chi dung cho cac case MEGAWAN...

          // MAKH_WEB: this.khachhang.makh,
          // DS_DIACHI_BC:{
          //   DIACHIBC_ID:this.diachibc_id,
          //   HDTT_ID: this.hdtt_id,
          //   PHOBC_ID: this.diachiBC.PHO_ID,
          //   PHUONGBC_ID: this.diachiBC.PHUONG_ID,
          //   QUANBC_ID: this.diachiBC.QUAN_ID,
          //   SONHA_BC: this.diachiBC.SO_NHA,
          //   DIACHI_BC: this.diachiBC.DIACHI,
          //   TINHBC_ID: this.diachiBC.TINH_ID,
          //   APBC_ID: this.diachiBC.AP_ID,
          //   KHUBC_ID: this.diachiBC.KHU_ID,
          //   DACDIEMBC_ID: this.diachiBC.DACDIEM_ID,
          // },
          // LIST_SERIAL: [],
          // IS_TRUOCBH: 0,
          // KIEMTRA_DK_APDUNG: 'ok',//BUG KIEMTRA_DK_APDUNG nhung de mac dinh de chay test

          TD_GANTHEM_HDTB_DV: this.TD_GANTHEM_HDTB_DV ? 1 : 0,
          STATUS_VDC: this.STATUS_VDC,
          OPEN_SYNC_VINA: TRANGTHAI_DONGBO.OPEN_SYNC_VINA ? 1 : 0,

          // MA_TB: this.khachhang.makh,
          MA_TB_HT: this.ma_tb_ht, //this.thuebao.codinh.somay,
          // MA_TB_AO: "",
          MA_TB_AO_HT: this.ma_tb_ao_ht,
          MA_TB_AO_HT_CUOI: this.ma_tb_ao_ht_cuoi,
          // MA_TB_AO_CUOI: "",

          DULIEU_KS: this.bDuLieuKS ? 1 : 0,
          SD_FRMSHUONGKN_V2: this.thamsomacdinh['SD_FRMDSHUONGKN_V2'] == 1 ? 1 : 0,
          LOAISOWAN: this.loaisowan,
          VRF: this.thuebao.mgwan.vrfvfi,
          MA_TB_DIACHILD: null
          // VPHIEUCSKHDV_ID: this.phieucskhdv_id, // TODO chua biet load nhu the nao
          // KETCUOI_ID:null,
          // LAT_LD:this.diachiLD.Lat,
          // LNG_LD:this.diachiLD.Lng,
          // FIBER_BS:null,
          // CONGNGHE_ID:this.listbox.congnghe.value==0?null:this.listbox.congnghe.value,
          // MATB_TN:this.thuebaocd.matn?this.thuebaocd.matn.trim():null,
        }
        await API.post_fn_them_hopdong_thuebao(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            // let hdkh_id = this.khachhang.hdkh_id;
            let data = JSON.parse(response.data.data)
            if (data['ERROR_CODE'] != 1) {
              this.$toast.error(data['MESSAGE'])
              return
            } else {
              if(KT_KVNLML!=1) {
                if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
                  // VDCService vdc = new VDCService(tt_nd.user_visa, tt_nd.pass_visa);
                  // vdc.HuyDatChoMegaVNN(txtAccountADSL.Text);
                  await vdc.HuyDatChoMegaVNN(this.thuebao.adsl.txtAccountADSL)
                }

                this.buttonSet = 0

                this.$toast.success('Hợp đồng đã được thoái trả. Khách hàng sẽ được đưa vào danh sách Khách hàng tiềm năng!')
                return 'err'
              }
              this.$toast.success(data['MESSAGE'])
            }
            // if(!(this.thuebao.codinh.arraySoMay && this.thuebao.codinh.arraySoMay.length>0))
            await API.post_fn_lay_ds_ht_capnhat_datmoi(this.axios, { ds_para: JSON.stringify({ HDKH_ID: this.khachhang.hdkh_id }) }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                let apidata = JSON.parse(response.data.data)
                if (apidata['ERROR_CODE'] == 1) {
                  this.DatMoi_Fsecure_kem_fiber()
                  this.Them_MyTV_vao_goi_giadinh()
                  // this.HienThiDS_HDTB_CBO(); // 100% comment nen khong code
                  let ds_hdkh_tmp = apidata['RESULT']['DS_HDTB']
                  ds_hdkh_tmp = this.LowerCasePropertyList(ds_hdkh_tmp)
                  this.HienThiDanhSacHDTB(ds_hdkh_tmp)
                  // this.HienThiTTHopDongTB(ds_hdkh_tmp);

                  if (this.lvwThueBao.length <= 1) this.buttons.tsbtnXoaTB = false
                  else this.buttons.tsbtnXoaTB = true
                }
              }
            })
          }
        })
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async KiemTraDL_ThueBao(themmoi) {
      //TODO KiemTraDL_ThueBao chua lam

      if ((!this.thuebao.didong.txtSoMayDD || this.thuebao.didong.txtSoMayDD.trim().length == 0) && this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG) {
        // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
        this.$toast.error('Hãy nhập số máy di động !')
        // txtSoMayDD.Focus();
        return false
      }

      if ((!this.thuebao.didong.txtSimDD || this.thuebao.didong.txtSimDD.trim().length == 0) && this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG) {
        // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
        this.$toast.error('Hãy nhập số SimCard !')
        // txtSimDD.Focus();
        return false
      }

      if ((!this.thuebao.codinh.somay || this.thuebao.codinh.somay.trim().length == 0) && this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) {
        // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
        this.$toast.error('Hãy nhập số máy cố định !')
        // btnChonSM.Focus();
        return false
      }

      if ((!this.thuebao.mgwan.somay || this.thuebao.mgwan.somay.trim().length == 0) && (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM)) {
        // if (tabctlThongTin.SelectedIndex == 0)
        //     tabctlThongTin.SelectedIndex = 1;
        this.$toast.error(`Hãy nhập mã thuê bao ${this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN ? 'Megawan' : (this.listbox.dichvu_vt.value==DichVuVienThong.NOIBO_DADIEM?'':'Metronet')} !`)
        // txtMaTBWan.Focus();
        return false
      }
      if (this.ckieu_ld.length <= 0) {
        this.$toast.error(`Loại hình thuê bao đã chọn chưa được cấu hình triển khai cho khu vực. Vui lòng liên hệ admin!`)
        return false
      } else if (this.listbox.kieu_ld.value <= 0) {
        this.$toast.error(`Cần chọn kiểu yêu cầu để tiếp tục!`)
        return false
      }

      if (!this.thuebao.khuvuc || !this.thuebao.khuvuc_id) {
        this.$toast.error(`Chưa có mã khu vực thuê bao. Vui lòng chọn khu vực!`)
        return false
      }

      if (this.listbox.doituong.value == DUNG_THU.DOITUONG_TB && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
        //try
        //{
        if (this.kieu_ld_kieu != 1 && this.kieu_ld_kieu != 2 && this.kieu_ld_kieu != 3) {
          //kèm, có sẵn, hoặc trên đường mega -> fiber
          this.$toast.error('MyTV dùng thử phải lắp đặt trên đường có sẵn (hoặc lắp kèm) với Fiber!')
          // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
          // cboKieuLD.Focus();
          return false
        }
      }

      if ((this.kieu_ld_kieu == 1 || this.kieu_ld_kieu == 2 || this.kieu_ld_kieu == 4) && this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH && (!this.thuebaocd.matn || this.thuebaocd.matn.trim() == '')) {
        this.$toast.error('Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!')
        // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
        // txtMaTN_CD.Focus();
        return false
      }
      if ((this.kieu_ld_kieu == 1 || this.kieu_ld_kieu == 2 || this.kieu_ld_kieu == 4) && (!this.thuebao.ims.txtMaTN_IMS || this.thuebao.ims.txtMaTN_IMS.trim() == '') && (this.listbox.dichvu_vt.value == DichVuVienThong.IMS || this.listbox.dichvu_vt.value == DichVuVienThong.IMS_DOITAC)) {
        this.$toast.error('Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!')
        // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
        // txtMaTN_IMS.Focus();
        return false
      }
      if ((this.kieu_ld_kieu == 1 || this.kieu_ld_kieu == 2 || this.kieu_ld_kieu == 4) && (!this.thuebao.adsl.txtMaTN_ADSL || this.thuebao.adsl.txtMaTN_ADSL.trim() == '') && (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC)) {
        this.$toast.error('Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!')
        // if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
        // txtMaTN_ADSL.Focus();
        return false
      }

      if ((this.kieu_ld_kieu == 1 || this.kieu_ld_kieu == 2) && (!this.thuebao.adsl.txtMaTN_ADSL || this.thuebao.adsl.txtMaTN_ADSL.trim() == '') && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV && this.listbox.doituong.value != DUNG_THU.DOITUONG_TB) {
        //TODO chua xu ly doan nay!!!
        // if (this.kieu_ld_kieu == 1)//lắp kèm
        // {
        //     int dt_dungthu = Convert.ToInt32(obj.MAP_ID("doituong_id", DatabaseConstants.DB2 + ".hd_thuebao", "where ma_tb ='" + txtMaTN_ADSL.Text.Trim() + "'"));
        //     if (dt_dungthu == DUNG_THU.DOITUONG_TB)
        //     {
        //         this.$toast.error("MyTV đối tượng \"không dùng thử\" không thể lắp đặt trên đường có sẵn (hoặc lắp kèm) với đối tượng dùng thử!");
        //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
        //         txtMaTN_ADSL.Focus();
        //         return false;
        //     }
        // }
        // if (this.kieu_ld_kieu == 2)//lắp trên đường có sẵn
        // {
        //     int dt_dungthu = Convert.ToInt32(obj.MAP_ID("doituong_id", DatabaseConstants.DB2 + ".db_thuebao", "where ma_tb ='" + txtMaTN_ADSL.Text.Trim() + "'"));
        //     if (dt_dungthu == DUNG_THU.DOITUONG_TB)
        //     {
        //         Message_Box.ShowWarning("MyTV đối tượng \"không dùng thử\" không thể lắp đặt trên đường có sẵn (hoặc lắp kèm) với đối tượng dùng thử!");
        //         if (tabctlThongTin.SelectedIndex == 0) tabctlThongTin.SelectedIndex = 1;
        //         txtMaTN_ADSL.Focus();
        //         return false;
        //     }
        // }
      }

      if (
        (this.kieu_ld_kieu == 1 || this.kieu_ld_kieu == 2 || this.kieu_ld_kieu == 4) &&
        (!this.thuebao.mgwan.matn || this.thuebao.mgwan.matn.trim() == '') &&
        (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM)
      ) {
        this.$toast.error('Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!')
        // if (tabctlThongTin.SelectedIndex == 0)
        //     tabctlThongTin.SelectedIndex = 1;
        // txtMaTN_Wan.Focus();
        return false
      }

      //create by kylq.hcm
      //Bổ sung check megaIOT
      //Megawan_iot thì loại kênh phải là kênh liên tỉnh nội vùng
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGAWAN_IOT && this.listbox.loaikenh.value != LOAIKENH.LIENTINH) {
        //lien tinh nội vùng
        this.$toast.error('Kênh MegaWanIOT phải chọn loại kênh liên tỉnh nội vùng.')
        return false
      }
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGA_IOT && (this.thuebao.adsl.megaIOT_HuongKN == '' || this.thuebao.adsl.megaIOT_LanIP == '' || this.thuebao.adsl.megaIOT_vrf == '' || this.thuebao.adsl.megaIOT_WanIP == '')) {
        this.$toast.error('Đối với nhánh MegaIOT phải chọn kênh gom MegaWanIOT')
        return false
      }
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGA_IOT) {
        let mess = await this.kiemtra_ip_megaiot({
          vlan_ip: this.thuebao.adsl.megaIOT_LanIP,
          vwan_ip: this.thuebao.adsl.megaIOT_WanIP,
          vvrf: this.thuebao.adsl.megaIOT_vrf,
          vma_tb: this.thuebao.adsl.megaIOT_HuongKN
        })
        if (mess != 'OK') {
          this.$toast.error(mess)
          return false
        }
      }
      //End Megawan_iot

      let kt_chuquan_id = 0
      if (this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC) kt_chuquan_id = this.listbox.chu_quan.valueadsl
      if (this.listbox.dichvu_vt.value == DichVuVienThong.IMS_DOITAC) kt_chuquan_id = this.listbox.chu_quan.valueims
      if (this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC) kt_chuquan_id = this.listbox.chu_quan.valuewan
      if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC) kt_chuquan_id = this.listbox.chu_quan.valuetsl

      var int_trangbi = 0
      if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) int_trangbi = this.listbox.trangbi.valuecd
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) int_trangbi = this.listbox.trangbi.valuewan
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) int_trangbi = this.listbox.trangbi.valuetsl
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.GPHONE) int_trangbi = this.listbox.trangbi.valuegp
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.IMS || this.listbox.dichvu_vt.value == DichVuVienThong.IMS_DOITAC) int_trangbi = this.listbox.trangbi.valueims
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES || this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC) int_trangbi = this.listbox.trangbi.valueadsl

      var id_sochinh = 0

      if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH || this.listbox.dichvu_vt.value == DichVuVienThong.GPHONE) {
        if (!this.listbox.muccuoc_tb.list || this.listbox.muccuoc_tb.list.length == 0) {
          this.$toast.error('Chưa có mức cước thuê bao !')
          return false
        }

        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.PABX || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN2B_CD || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN2B_CQ || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN30B_CD || this.listbox.loaihinh_tb.value == LoaiHinhTB.ISDN30B_CQ) {
          if (this.loaisoisdn == LOAISO_ISDN.SOPHU) {
            if (!this.thuebao.codinh.sochinh || this.thuebao.codinh.sochinh.trim() == '') {
              this.$toast.error('Chưa chọn số chính !')
              // btnChonSoChinh.Focus();
              return false
            }
            if (this.thuebao.loaisochinh == 1) id_sochinh = this.thuebao.thuebao_id_cha
            else id_sochinh = this.thuebao.hdtb_id_cha
            // if (!laphd.KIEMTRA_TB_DATMOI_PABX(id_sochinh, Convert.ToInt32(cboLoaihinhTB.SelectedValue), loaisochinh))
            // {
            //     Message_Box.ShowWarning("Thuê bao đặt mới không cùng loại hình với số chính !");
            //     cboLoaihinhTB.Focus();
            //     return false;
            // }
          }
        }
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
        if (!this.listbox.loai_tb.valuemgwan || this.listbox.loai_tb.valuemgwan <= 0) {
          this.$toast.error('Chưa chọn loại thiết bị !')
          // cboLoaiTBiWan.Focus();
          return false
        }
        if (this.loaisowan == LOAINODE_MGWAN.NODE_PHU) {
          if ((!this.thuebao.mgwan.huongkn || this.thuebao.mgwan.huongkn.trim() == '') && (!this.diachiKN.DIACHI || this.diachiKN.DIACHI.trim() == '')) {
            this.$toast.error('Chưa chọn hướng kết nối hoặc địa chỉ kết nối Wan !')
            return false
          }
          if (!this.thuebao.mgwan.huongkn || this.thuebao.mgwan.huongkn.trim() == '') {
            if (this.thuebao.loaisochinh == 1) id_sochinh = this.thuebao.thuebao_id_cha
            else id_sochinh = this.thuebao.hdtb_id_cha
          }
        }

        if (this.loaisowan == LOAINODE_MGWAN.NODE_DUPHONG_CONG_TOCDO || this.loaisowan == LOAINODE_MGWAN.NODE_DUPHONG_TOCDO) {
          if (!this.thuebao.mgwan.huongkn || this.thuebao.mgwan.huongkn.trim() == '') {
            this.$toast.error('Chưa chọn Node chính !')
            // btnHuongKNWan.Focus();
            return false
          }
          if (this.thuebao.loaisochinh == 1) id_sochinh = this.thuebao.thuebao_id_cha
          else id_sochinh = this.thuebao.hdtb_id_cha
        }
      }
      // DONGBO_GP cái này là DONGBO_GPHONE.DONGBO luôn = true gán ở class -> khong thay đổi
      let chkdata = await API.post_fn_kiemtra_dl_thuebao(this.axios, {
        ds_para: JSON.stringify({
          THEMMOI: themmoi,
          GOICUOCADSL: this.listbox.cboGoiCuocAdsl.value ? this.listbox.cboGoiCuocAdsl.value : 0,
          DICHVUVT_ID: this.listbox.dichvu_vt.value,
          KT_CHUQUAN_ID: kt_chuquan_id,
          LOAITB_ID: this.listbox.loaihinh_tb.value,
          DOITUONG_ID: this.listbox.doituong.value,
          HDTB_ID: themmoi ? 0 : this.hdtb_id,
          DONVI_QL_ID: this.listbox.donvi_ql.value,
          TRANGBI_ID: this.trangbi_id,
          BB_TRATRUOC: this.thamsomacdinh['BATBUOC_TRATRUOC'] == 1 ? 1 : 0,
          HDKH_ID: this.khachhang.hdkh_id,
          KHACHHANG_ID: this.khachhang.khachhang_id,
          KIEULD_ID: this.listbox.kieu_ld.value,
          CHK_TRATRUOC: this.filterbox.tratruoc.ischecked ? 1 : 0,
          PHANTACH_TD: this.listbox.ht_phantach_tocdo.value,
          K_TOCDO_ID: this.listbox.tocdokenh.valuecir,
          K_TOCDO_NIX: this.listbox.tocdokenh.valuenix,
          K_TOCDO_ISP: this.listbox.tocdokenh.valueisp,
          KT_MST_CNTT: this.thamsomacdinh['KT_MST_DV_CNTT'] == 1 ? 1 : 0,
          MST: this.thuebao.txtMSTThueBao,
          LOAISOCHINH: this.thuebao.loaisochinh ? this.thuebao.loaisochinh : 0,
          ID_SOCHINH: id_sochinh ? id_sochinh : 0,
          LOAISO_ID: this.loaisoisdn,
          KT_THEMSO: this.thamsomacdinh['KT_THEMSO_LUONG_ISDN'] == 1 ? 1 : 0,
          SOCHINH: this.thuebao.codinh.sochinh,
          DONGBO_GP: 1,
          NGUOIDUNG_ID: this.$root.token.getNguoiDungID(),
          KIEU: this.kieu_ld_kieu,
          MATB_TN: this.thuebao.adsl.txtMaTN_ADSL,
          SOMAY_DD: this.thuebao.didong.txtSoMayDD,
          INT_TRANGBI: int_trangbi,
          KT_TBI_MYTV: this.thamsomacdinh['KIEMTRA_TRANGBI_MYTV_T2'] == 1 ? 1 : 0,
          MATN_ADSL: this.thuebao.adsl.txtMaTN_ADSL,
          SODT_FSE: this.thuebao.adsl.txtDienThoai_Fsecure,
          KHUVUC_ID: this.thuebao.khuvuc_id,
          QUANLD_ID: this.diachiLD.QUAN_ID,
          PHUONGLD_ID: this.diachiLD.PHUONG_ID,
          PHOLD_ID: this.diachiLD.PHO_ID,
          APLD_ID: this.diachiLD.AP_ID,
          KHULD_ID: this.diachiLD.KHU_ID,
          KIEUKH_ID: this.vkieukh_id_,
          SO_GT: this.khachhang.sogt,
          TEL_KH: this.khachhang.dienthoai,
          DIACHI_LD: this.diachiLD.DIACHI
        })
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            this.$toast.error(apidata['MESSAGE'] + '')
            return null
          }
          return apidata['RESULT']
        }
      })
      if (!chkdata) return false
      let strmatd = ''
      if (chkdata['STRMATD']) strmatd = chkdata['STRMATD']
      if (chkdata['DS_KT_MST'] && chkdata['DS_KT_MST'].length > 0) {
        this.loading(false)
        let cfr = await this.$bvModal
          .msgBoxConfirm(`MST ${this.thuebao.txtMSTThueBao + ''} đã được tạo hợp đồng cho thuê bao : ${chkdata['DS_KT_MST'][0]['MA_TB'] + ''}\nDo user ${chkdata['DS_KT_MST'][0]['NGUOI_CN'] + ''} thực hiện. Ngày tạo: ${chkdata['DS_KT_MST'][0]['NGAY_YC'] + ''}.\nBạn có muốn thực hiện tiếp không?`, {
            title: 'Thông báo',
            size: 'sm',
            okTitle: 'Đồng ý',
            cancelTitle: 'Hủy'
          })
          .then((v) => {
            return v
          })
        if (!cfr) return false
      }
      //NHOM_KLD đã check ở DB -> không lấy ra nữa
      if (chkdata['MAVUNG_CD'] && chkdata['USER_GPHONE']) {
        if (this.tt_nd.user_neo == '-1') {
          this.$toast.error('Người dùng chưa được gán user kết nối hệ thống gphone. Liên hệ Admin để gán quyền.')
          return false
        }
        // TODO chua lam!!!! Ket noi CCBS
        // let dtCheck = new CCBSFacade().gphone_khoitao_khoso_search(mavung + txtSoMayGP.Text, tt_nd.tentat_ccbs.ToUpper(), userid);
        // if (dtCheck == null)
        // {
        //     Message_Box.Show("Số máy không có trong kho số của hệ thống CCBS Gphone. Đề nghị kiểm tra lại.");
        //     return false;
        // }
      }
      if (chkdata['KHACHHANG_ID_TRATRUOC'] && chkdata['KHACHHANG_ID_TRATRUOC'] != -1 && chkdata['KHACHHANG_ID_TRATRUOC'] != this.khachhang.khachhang_id) {
        this.$toast.error('Số máy thuộc về một khách hàng khác, bạn phải lập hợp đồng với khách hàng tương ứng ')
        return false
      }

      if (chkdata['DS_DINHDANH'] && chkdata['DS_DINHDANH'].length > 0) {
        let question = `Thuê bao lắp mới Trùng ${chkdata['DS_DINHDANH'][0]['LOAI'] == '1' ? 'định danh khách hàng' : chkdata['DS_DINHDANH'][0]['LOAI'] == 2 ? 'địa chỉ lắp đặt' : 'định danh và địa chỉ lắp đặt'} với thuê bao: ${chkdata['DS_DINHDANH'][0]['MA_TB'] +
          ''}\nBạn có muốn tiếp tục lập hợp đồng ?`
        this.loading(false)
        let cfr = await this.$bvModal
          .msgBoxConfirm(question, {
            title: 'Xác nhận thông tin',
            size: 'sm',
            okTitle: 'Đồng ý',
            cancelTitle: 'Hủy'
          })
          .then((v) => {
            return v
          })
        if (!cfr) return false
      }

      if (chkdata['NHOMDT_ID'] && chkdata['NHOMDT_ID'] == 200) {
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL && this.listbox.loaihinh_tb.value != LoaiHinhTB.INTERNET_MYTV && !this.filterbox.tratruoc.ischecked) {
          this.$toast.error('Bạn phải thực hiện đăng ký trả trước cho thuê bao!')
          // chkTraTruoc.Focus();
          return false
        }
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT || this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT || this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU || this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH) {
        if (chkdata['LOAITB_SINHMATB_TD'] && chkdata['LOAITB_SINHMATB_TD'] == 1) {
          let vma_tb_cntt = chkdata['MA_TB_CNTT']
          if (!vma_tb_cntt || vma_tb_cntt == '-1' || vma_tb_cntt == '') {
            this.$toast.error('Liên hệ admin để kiểm tra lại mã thuê bao !')
            return false
          }
          for (var index = 0; index < this.gridEditors.length; ++index) {
            if (this.gridEditors[index].ID == 'MA_TB') {
              this.gridEditors[index].Value = vma_tb_cntt
            }
          }
        }
        //Bind và kiểm tra dữ liệu dịch vụ CNTT
        // grvMacdinh.CloseEditor();
        if (this.gridEditors.length <= 0) {
          this.$toast.error('Chưa được thiết lập tham số dịch vụ. Liên hệ admin để kiểm tra')
          return false
        }

        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.TTDL_HDDT) {
          for (var index = 0; index < this.gridEditors.length; ++index) {
            if (this.gridEditors[index].Value != null) {
              if (this.ItemList[index]) this.ItemList[index].sValue = this.gridEditors[index].Value ? this.gridEditors[index].Value.toString().trim() : this.gridEditors[index].Value
            } else if (this.ItemList[index]) this.ItemList[index].sValue = ''

            if (this.gridEditors[index].ID == 'TOCDO_ID') {
              if (this.gridEditors[index].Value) {
                if (this.gridEditors[index].Value == TOCDO.HDDT_GOI_TREN_10000 || this.gridEditors[index].Value == TOCDO.HDDT_GOI_GIAIPHAP) {
                  if (this.dsCTM_TBI.length <= 0) {
                    this.$toast.error('Bạn chưa chọn thiết bị để mua!')
                    return false
                  }
                }
              }
            }
          }
        } else {
          for (var index = 0; index < this.gridEditors.length; ++index) {
            if (!this.ItemList[index]) continue
            if (this.ItemList[index].iAtt == 2) {
              if (this.gridEditors[index].Value == null) {
                this.$toast.error('Bạn hãy kiểm tra lại dữ liệu ' + this.ItemList[index].sCaption)
                return false
              }
            }

            this.ItemList[index].sValue = this.gridEditors[index].Value ? this.gridEditors[index].Value.toString().trim() : this.gridEditors[index].Value
          }
        }

        // DOAN NAY THAY BANG UR 2.1.004_233
        // if (themmoi == true)
        // {
        //     let loaitb_sinhmatb_td = laphd.Lay_lhtb_sinh_ma_tb_tudong(Convert.ToInt32(cboLoaihinhTB.SelectedValue));
        //     if (loaitb_sinhmatb_td == 1)
        //     {
        //         vma_tb_cntt = laphd2.SINH_MATB_CNTT(Convert.ToInt32(cboLoaihinhTB.SelectedValue));
        //         if (vma_tb_cntt == "-1" || vma_tb_cntt == "")
        //         {
        //             Message_Box.ShowWarning("Liên hệ admin để kiểm tra lại mã thuê bao !");
        //             return false;
        //         }
        //         else
        //         {
        //             if (themmoi == true)
        //             {
        //                 string _strMatb = "select 1 from " + DatabaseConstants.DB2 + ".db_thuebao where loaitb_id = " + cboLoaihinhTB.SelectedValue.ToString();
        //                 _strMatb += " and ma_tb = '" + vma_tb_cntt + "'";
        //                 _strMatb += " union all select 1 from " + DatabaseConstants.DB2 + ".hd_thuebao a, " + DatabaseConstants.DB2 + ".hd_khachhang b ";
        //                 _strMatb += "where a.hdkh_id = b.hdkh_id and b.loaihd_id = 1 and a.tthd_id not in (6, 7) and a.loaitb_id = " + cboLoaihinhTB.SelectedValue.ToString() + " and a.ma_tb = '" + vma_tb_cntt + "'";
        //                 DataTable _dtMatb = bangts.GetDataSql(_strMatb);
        //                 if (_dtMatb != null && _dtMatb.Rows.Count > 0)
        //                 {
        //                     Message_Box.ShowTB("Account " + cboLoaihinhTB.Text + " đã tồn tại trên hệ thống. Bạn hãy chọn account khác!");
        //                     return false;
        //                 }
        //             }
        //         }

        //         // grvMacdinh.CloseEditor();
        //         for (var index = 0; index < this.gridEditors.length; ++index)
        //         {
        //             if (this.gridEditors[index].ID == "MA_TB")
        //             {
        //                 this.gridEditors[index].Value = vma_tb_cntt;
        //             }
        //         }
        //     }
        //     else
        //     {
        //         // grvMacdinh.CloseEditor();
        //         for (var index = 0; index < this.gridEditors.length; ++index)
        //         {
        //             if (this.gridEditors[index].ID == "MA_TB")
        //             {
        //                 if (this.gridEditors[index].Value.toString().indexOf(" ")>=0)
        //                 {
        //                     this.$toast.error("Mã thuê bao không được có ký tự trống !");
        //                     return false;
        //                 }
        //             }
        //         }
        //         vma_tb_cntt = "";
        //     }
        // }

        // if (CheckDataError(ItemList, ItemList.Length, "HD_CNTT", "HDTB_ID", hdtb_id.ToString(), kieu))
        // {
        //     return false;
        // }

        // if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.FSECURE)
        // {
        //     string sodt = "";
        //     string matbtn = "";
        //     for (int i = 0; i < ItemList.Length; i++)
        //     {
        //         if (ItemList[i].sFieldName == "SO_DT")
        //         {
        //             sodt = ItemList[i].sValue;
        //         }
        //         if (ItemList[i].sFieldName == "MATB_TN")
        //         {
        //             matbtn = ItemList[i].sValue;
        //         }
        //     }
        //     if ((kieu == 1 || kieu == 2) && matbtn.Length == 0)
        //     {
        //         Message_Box.ShowWarning("Kiểu lắp đặt trên đường có sẵn(hoặc lắp kèm), mã truy nhập không được trống!");
        //         return false;
        //     }
        //     if (sodt.Trim() == "")
        //     {
        //         Message_Box.ShowWarning("Hãy nhập Số điện thoại !");
        //         return false;
        //     }

        //     if (sodt.StartsWith("0") == true)
        //     {
        //         Message_Box.ShowWarning("Bạn hãy bỏ số '0' ở đầu số điện thoại Fsecure !");
        //         return false;
        //     }

        //     if (sodt.Trim().Length < 9 || sodt.Trim().Length > 10)
        //     {
        //         Message_Box.ShowWarning("Bạn phải nhập số di động vào (9 ký tự số <= Số điện thoại <= 10 ký tự số) !");
        //         return false;
        //     }

        //     if (!Common.Utilities.CommonFunction.CheckIsNumber(Common.Utilities.CommonFunction.Unformat_tien(sodt)))
        //     {
        //         Message_Box.ShowWarning("Số điện thoại phải là kiểu số) !");
        //         return false;
        //     }

        //     try
        //     {
        //         if (new TraCuuDanhBaFacade2().Kiemtra_sodt(sodt.Trim()) == 0)
        //         {
        //             Message_Box.ShowWarning("Số điện thoại không chính xác. Bạn hãy nhập lại!");
        //             return false;
        //         }
        //     }
        //     catch (Exception)
        //     {
        //     }

        //     //Kiểm tra trên hệ thống Fsecure
        //     try
        //     {
        //         if (themmoi == true)
        //         {
        //             FSecureService secure = new FSecureService();
        //             string message = "";

        //             int _status = secure.UserStatus(sodt.Trim(), ref message);
        //             if (_status == 1)
        //             {
        //                 Message_Box.ShowTB("Số điện thoại này đã được sử dụng để đăng ký Fsecure. Bạn hãy nhập SĐT khác!");
        //                 return false;
        //             }

        //             DataSet dsKtra = new TraCuuDanhBaFacade2().KiemTra_sodt_fsecure(sodt.Trim(), 0);//bangts.GetSQL(strKtra, "");
        //             if (dsKtra != null && dsKtra.Tables[0].Rows.Count > 0)
        //             {
        //                 Message_Box.ShowWarning("Số điện thoại này đã được sử dụng để đăng ký Fsecure. Bạn hãy nhập SĐT khác!");
        //                 return false;
        //             }
        //         }
        //         else
        //         {
        //             FSecureService secure = new FSecureService();
        //             string message = "";

        //             int _status = secure.UserStatus(sodt.Trim(), ref message);
        //             if (_status == 1)
        //             {
        //                 Message_Box.ShowTB("Số điện thoại này đã được sử dụng để đăng ký Fsecure. Bạn hãy nhập SĐT khác!");
        //                 return false;
        //             }

        //             DataSet dsKtra = new TraCuuDanhBaFacade2().KiemTra_sodt_fsecure(sodt.Trim(), hdtb_id);//bangts.GetSQL(strKtra, "");
        //             if (dsKtra != null && dsKtra.Tables[0].Rows.Count > 0)
        //             {
        //                 Message_Box.ShowWarning("Số điện thoại này đã được sử dụng để đăng ký Fsecure. Bạn hãy nhập SĐT khác!");
        //                 return false;
        //             }
        //         }
        //     }
        //     catch (Exception)
        //     {
        //     }
        // }
      }

      if (this.listbox.doituong.value == DUNG_THU.DOITUONG_TB) {
        // Da bao gom trong FN_KIEMTRA_DL_THUEBAO UR2.1.004_233
        // string kiemtra_dt = tdan.GET_VALUE_FUNC("{?DB2}.KIEMTRA_DICHVU_CHOPHEP_DUNGTHU", "vdichvuvt_id", Convert.ToInt32(cboDichVuVT.SelectedValue), "vloaitb_id", Convert.ToInt32(cboLoaihinhTB.SelectedValue)).ToString();
        // if (kiemtra_dt != "ok")
        // {
        //     Message_Box.ShowTB("Đối tượng \"Thuê bao dùng thử\" chỉ áp dụng cho Fiber hoặc MyTV!");
        //     cboLoaihinhTB.Focus();
        //     cboLoaihinhTB.SelectedValue = LoaiHinhTB.INTERNET_FTTH;
        //     return false;
        // }
        if (!this.thuebao.tgdungthu) {
          this.$toast.error('Hãy nhập Thời gian dùng thử')
          return false
        }

        if (this.listbox.dichvu_vt.value != DichVuVienThong.HOINGHI_TRUYENHINH && this.listbox.dichvu_vt.value != DichVuVienThong.DICHVU_CNTT && this.listbox.dichvu_vt.value != DichVuVienThong.TRUNGTAM_DULIEU && this.listbox.dichvu_vt.value != DichVuVienThong.ANTOAN_BAOMAT_TT) {
          if (this.vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) {
            //Khách hàng doanh nghiệp và kiểm tra thời gian lập hợp đồng từ ngày 20/05/2020-30/06/2020
            if (new Date().getTime() >= new Date(2020, 5, 20).getTime() && new Date().getTime() <= new Date(2020, 6, 30).getTime() && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
              if (this.thuebao.tgdungthu <= 0 || this.thuebao.tgdungthu > 60) {
                this.$toast.error('Hãy nhập Thời gian dùng thử lớn hơn 0 và nhỏ hơn 60 (ngày)')
                return false
              }
            }
          } else if (await this.Kiemtra_dungthu_mytv()) {
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
              if (this.thamsomacdinh['CHOPHEP_DUNGTHU_90_NGAY'] != 1) {
                let strmatdcps = await API.post_fn_tt_tocdo_adsl(this.axios, { type: 4, param: this.listbox.cboGoiCuocAdsl.value })
                  .then((response) => {
                    if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                      return response.data.data
                    } else return ''
                  })
                  .catch(() => {
                    return ''
                  })
                if (
                  (this.trangbi_id == TRANGBI.MUA_THIETBI ||
                    this.trangbi_id == TRANGBI.THUE_THIETBI ||
                    this.trangbi_id == TRANGBI.KHACHHANG_TU_TRANGBI ||
                    this.trangbi_id == TRANGBI.VIENTHONG_TRANGBI_TSD_VT ||
                    this.trangbi_id == TRANGBI.VIENTHONG_TRANGBI ||
                    this.trangbi_id == TRANGBI.TTKD_TRANGBI) &&
                  (this.thuebao.tgdungthu <= 0 || this.thuebao.tgdungthu > 30)
                )
                  if (strmatdcps != 'MYTV019') {
                    this.$toast.error('Hãy nhập Thời gian dùng thử lớn hơn 0 và tối đa 30 (ngày)')
                    return false
                  }

                if ((this.trangbi_id == TRANGBI.KHONG_SUDUNG_STB || strmatdcps == 'MYTV019') && (this.thuebao.tgdungthu <= 0 || this.thuebao.tgdungthu > 90)) {
                  this.$toast.error('Hãy nhập Thời gian dùng thử lớn hơn 0 và tối đa 90 (ngày)')
                  return false
                }
              } else {
                if (this.thuebao.tgdungthu <= 0 || this.thuebao.tgdungthu > 90) {
                  this.$toast.error('Hãy nhập Thời gian dùng thử lớn hơn 0 và tối đa 90 (ngày)')
                  return false
                }
              }
            }
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
              if (this.thuebao.tgdungthu <= 0 || this.thuebao.tgdungthu > 90) {
                this.$toast.error('Hãy nhập Thời gian dùng thử lớn hơn 0 và tối đa 90 (ngày)')
                return false
              }
            }
          } else if (this.thuebao.tgdungthu <= 0 || this.thuebao.tgdungthu > 30) {
            this.$toast.error('Hãy nhập Thời gian dùng thử lớn hơn 0 và nhỏ hơn 30 (ngày)')
            return false
          }
        }

        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B)
          if (this.listbox.nganhngheloc.value != 888) {
            //NganhNghe.KHACHSAN)
            this.$toast.error('Với thuê bao Mytv B2B, ngành nghề của khách hàng phải chọn là KHÁCH SẠN')
            return false
          }
        //Thực hiện theo SRV https://cntt.vnpt.vn/browse/VNPSR-11947

        ///SD WAN tối đa 3 tháng
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.SD_WAN) {
          if (this.thuebao.tgdungthu <= 0 || this.thuebao.tgdungthu > 90) {
            this.$toast.error('Hãy nhập Thời gian dùng thử lớn hơn 0 và nhỏ hơn 90 (ngày)')
            return false
          }
        }
      }

      if (this.thamsomacdinh['NHANVIEN_DIABAN'] == 1) {
        if (!this.thuebao.khuvuc_id || this.thuebao.khuvuc_id == 0 || !this.thuebao.khuvuc || this.thuebao.khuvuc == '') {
          // || !this.dsHDTB_KV || this.dsHDTB_KV.length == 0)
          // if (TinhKhac == 0 && Convert.ToInt16(dsDanhMuc.Tables["KIEU_LD"].Select("kieuld_id = " + Convert.ToInt32(cboKieuLD.SelectedValue)).CopyToDataTable().Rows[0]["tinhkhac"].ToString()) == 0)
          // {
          this.$toast.error('Bạn chưa chọn khu vực quản lý địa bàn cho thuê bao!')
          return false
          // }
        }
      }

      if (!this.listbox.donvi_ql.list || this.listbox.donvi_ql.list.length <= 0) {
        // if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
        this.$toast.error('Địa chỉ này chưa được thiết lập đơn vị lắp đặt!')
        // btnDiaChiTT.Focus();
        return false
      } else {
        if (!this.listbox.donvi_ql.value || this.listbox.donvi_ql.value == 0) {
          // if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
          this.$toast.error('Địa chỉ này chưa được thiết lập đơn vị lắp đặt !')
          // btnDiaChiTT.Focus();
          return false
        }
      }

      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B) {
        // cuonglt nho them 03-11-2020
        if (!this.thuebao.adsl.txtAccountADSL || (this.thuebao.adsl.txtAccountADSL + '').trim().length <= 3) {
          this.$toast.error('Account Mytv phải có 3 ký tự trở lên')
          return false
        }

        if ((this.thuebao.adsl.txtAccountADSL + '').length > 18) {
          this.$toast.error('Account MyTV không được vượt quá 18 ký tự!')
          return false
        }

        if (
          (this.thuebao.adsl.txtAccountADSL + '')
            .trim()
            .toLowerCase()
            .indexOf(this.tt_nd.tentat_vasc.toLowerCase()) < 0
        ) {
          this.$toast.error("3 ký tự đầu tiên phải là mã tỉnh '" + this.tt_nd.tentat_vasc.toLowerCase() + "'. Bạn hãy kiểm tra lại")
          return false
        }

        // hoangpkn : 22/03/2017 . Đăng ký combo Fafilm chỉ dành cho 4 gói Mytv cơ bản VASC005/VASC006/VASC007/VASC008
        if (this.m_dsThueBao_DichVu.length > 0) {
          let lth = this.m_dsThueBao_DichVu.filter((x) => (x.ma_dvgt == 'CB_FF_12' || x.ma_dvgt == 'CB_FF_24') && x.dangky == 1).length
          if (lth >= 1) {
            //string strmatd = "";
            //strmatd = objCheckData.MAP_ID("matocdo", DatabaseConstants.DB2 + ".tocdo_adsl", "where tocdo_id = " + vgoicuocasdl);
            if (strmatd != 'VASC005' && strmatd != 'VASC006' && strmatd != 'VASC007' && strmatd != 'VASC008') {
              this.$toast.error('Bạn không được đăng ký combo Fafilm cho gói cước ' + this.listbox.cboGoiCuocAdsl.list.find((x) => x.tocdo_id == this.listbox.cboGoiCuocAdsl.value).thuonghieu)
              return false
            }
          }
        }
      }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC)
        //if (this.listbox.cboGoiCuocAdsl.value && this.listbox.cboGoiCuocAdsl.value * 1 >= 44710 && this.listbox.cboGoiCuocAdsl.value * 1 <= 44715)
        if((await API.get_fn_ktra_tocdo_dk_greennet(this.axios,{params:{tocdo_id:this.listbox.cboGoiCuocAdsl.value}}).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return 0
        })
        .catch(() => {
          return 0
        }))==1) {
          if (!this.m_dsThueBao_DichVu.find((x) => x.dangky && !x.huy && x.dichvugt_id == 8939)) {
            this.$toast.error('Gói cước có bao gồm dịch vụ GreenNet. Đề nghị khai báo Dịch vụ GTGT Green Net trước khi khởi tạo gói cước')
            return false
          }
        } else
          if (this.m_dsThueBao_DichVu.find((x) => x.dangky && !x.huy && x.dichvugt_id == 8939)) {
            this.$toast.error('Gói cước không bao gồm dịch vụ GreenNet. Đề nghị bỏ khai báo Dịch vụ GTGT Green Net trước khi khởi tạo gói cước')
            return false
          }

      if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL && (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER)) {
        // if (this.thamsomacdinh['NHAP_THONGTIN_TINHCUOC'] == 1) {
        //   if (!this.thuebao.adsl.txtTTCuoc || this.thuebao.adsl.txtTTCuoc.trim() == '') {
        //     this.$toast.error('Hãy nhập thông tin tính cước')
        //     return false
        //   }
        // }
        //#region Cường LT thêm kiểm tra với IP Tĩnh và FIBER phải chọn loại IP
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
          if (this.listbox.cboGoiCuocAdsl.list && this.listbox.cboGoiCuocAdsl.list.length > 0) {
            // var t = dt_cuoc_adsl.Select("IPTINH is not null and IPTINH>0 and tocdo_id=" + cboGoiCuocAdsl.EditValue);
            var t = this.listbox.cboGoiCuocAdsl.list.filter((x) => x.iptinh && x.iptinh > 0 && x.tocdo_id == this.listbox.cboGoiCuocAdsl.value) //dt_cuoc_adsl.Select("IPTINH is not null and IPTINH>0 and tocdo_id=" + cboGoiCuocAdsl.EditValue);
            if (t && t.length > 0) {
              if (!this.listbox.cboLoaiIP.list || this.listbox.cboLoaiIP.list.length <= 0) {
                this.$toast.error('Không lấy được dữ liệu loại IP. Bạn hãy kiểm tra lại!')
                return false
              }
              if (!this.listbox.cboLoaiIP.values || this.listbox.cboLoaiIP.values.length == 0) {
                this.$toast.error('Hãy chọn loại ip đối với ip tĩnh!')
                return false
              }
            }
          }
        }
        // #endregion
      }

      if (this.dsDC_HDTB && this.dsDC_HDTB.length > 0) {
        let listapis = []
        for (var item of this.dsDC_HDTB.filter((x) => x.NGAY_BDDC && x.NGAY_KTDC)) {
          // let api = API.post_sp_kt_thoigian_datcoc(this.axios, {
          let api = API.post_sp_kt_thoigian_datcoc_v2(this.axios, {
            v_thuebao_id: item.KHUYENMAI_ID,
            v_nhom_datcoc_id: item.NHOM_KM ? item.NHOM_KM : 0, // bo sung line nay cho v2
            v_thang_bddc: item.THANG_BDDC,
            v_thang_ktdc: item.THANG_KTDC,
            v_ngay_bddc: item.NGAY_BDDC,
            v_ngay_ktdc: item.NGAY_KTDC
          })
          listapis.push(api)
        }
        let allok = true
        if (listapis && listapis.length > 0)
          await Promise.all(listapis).then((listres) => {
            if (listres && listres.length > 0) for (let response of listres) if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') if (response.data.data != 'OK') allok = false
          })
        if (!allok) {
          this.$toast.error('Thuê bao đăng ký đặt cọc không hợp lệ, bị trùng với khoảng thời gian của đặt cọc khác đang hiệu lực')
          return false
        }
      }


      if (this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT
          || this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT
          || this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU
          || this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH)
      {
          if ((!this.listbox.muccuoc_tb.list || this.listbox.muccuoc_tb.list.length == 0) && this.listbox.kieu_ld.value != 13224) // tổng rà soat 12/2020 duongpd
          {
              this.$toast.error("Chưa có mức cước thuê bao tháng. Bạn hãy kiểm tra lại thông tin !");
              return false;
          }
          if (this.listbox.kieu_ld.value == 13224)
          {
              this.$toast.success("Mức cước bằng 0, cố định với thuê bao tổng rà soát");
          }
      }

      if (
        this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH ||
        this.listbox.dichvu_vt.value == DichVuVienThong.GPHONE ||
        this.listbox.dichvu_vt.value == DichVuVienThong.ADSL ||
        this.listbox.dichvu_vt.value == DichVuVienThong.IMS ||
        this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH ||
        this.listbox.dichvu_vt.value == DichVuVienThong.IMS_DOITAC ||
        this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC
      ) {
        if (!this.listbox.muccuoc_tb.list || this.listbox.muccuoc_tb.list.length == 0) {
          this.$toast.error('Chưa có mức cước thuê bao !')
          return false
        }
      }

      // #region Kiểm tra dịch vụ truyền số liệu
      if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
        if (this.diachiDau.TINH_ID == 0 && this.diachiDau.QUAN_ID == 0 && this.diachiDau.PHUONG_ID == 0) {
          this.$toast.error('Hãy chọn địa chỉ đầu truyền số liệu !')
          return false
        }

        if (this.diachiCuoi.TINH_ID == 0 && this.diachiCuoi.QUAN_ID == 0 && this.diachiCuoi.PHUONG_ID == 0) {
          this.$toast.error('Hãy chọn địa chỉ cuối truyền số liệu !')
          return false
        }

        if (!this.listbox.donvi_dau.list || this.listbox.donvi_dau.list.length == 0) {
          this.$toast.error('Địa chỉ đầu chưa có dữ liệu !')
          return false
        }
        if (!this.listbox.donvi_cuoi.list || this.listbox.donvi_cuoi.list.length == 0) {
          this.$toast.error('Địa chỉ cuối chưa có dữ liệu !')
          return false
        }
      }
      // #endregion

      return true
    },
    CapNhat_HDTB_ID_HDTB_KV_ThemTB() {
      this.dsHDTB_KV_ThemTB = []
      if (this.dsHDTB_KV && this.dsHDTB_KV.length > 0)
        for (var item of this.dsHDTB_KV) {
          let dr = {}
          dr.HDTB_ID = this.hdtb_id
          dr.KHUVUC_ID = item['KHUVUC_ID']
          dr.LOAIKV_ID = LOAI_KV.KHUVUC_DIABAN
          dr.NGUOI_CN = this.$root.token.getUserName()
          dr.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
          dr.MAY_CN = null
          dr.IP_CN = null
          this.dsHDTB_KV_ThemTB.push(dr)
        }
      else {
        let dr = {}
        dr.HDTB_ID = this.hdtb_id
        dr.KHUVUC_ID = this.thuebao.khuvuc_id
        dr.LOAIKV_ID = LOAI_KV.KHUVUC_DIABAN
        dr.NGUOI_CN = this.$root.token.getUserName()
        dr.NGAY_CN = moment(new Date()).format('DD/MM/YYYY')
        dr.MAY_CN = null
        dr.IP_CN = null
        this.dsHDTB_KV_ThemTB.push(dr)
      }
    },
    async tsbtnXoa_Click() {
      this.$bvModal
        .msgBoxConfirm('Bạn thật sự muốn xóa hợp đồng không ?', {
          title: 'Xác nhận hành động',
          size: 'sm',
          okTitle: 'Đồng ý',
          cancelTitle: 'Hủy'
        })
        .then(async (v) => {
          if (v) {
            try {
              //Them phan check theo yeu cau cua CuongLT 2023-11-08
              var kqapixoa = await API.post_fn_kt_xoa_tt_hd(this.axios,{
                vkieu:0,vid:this.khachhang.hdkh_id
              }).then(response =>{
                if(response.data && response.data.data) return response.data.data
                else return response.data.message + ': ' + response.data.message_detail;
              });
              if(!kqapixoa || kqapixoa!=1) {
                this.$toast.error("Lỗi xoá dữ liệu: "+(kqapixoa?kqapixoa:"Không xác định"));
                return -1;
              }
              // Move tu doan if(CoDiDong) len day vi can tham so cho API
              let CoDiDong = false
              for (var item of this.lvwThueBao) {
                if (item['loaitb_id'] == LoaiHinhTB.DIDONGTRASAU) {
                  CoDiDong = true
                  break
                }
              }
              let DS_HDTB = this.lvwThueBao.map((x) => ({ HDTB_ID: x.hdtb_id, LOAITB_ID: x.loaitb_id }))
              let pdata = { CODIDONG: CoDiDong, DONGBO_TEST: this.DONGBO_TEST.TEST, MA_ND: this.tt_nd && this.tt_nd.ma_nd ? this.tt_nd.ma_nd : null, HDKH_ID: this.khachhang.hdkh_id, DS_HDTB: DS_HDTB }
              API.post_fn_lay_tt_kt_xoa_hopdong(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  let data = JSON.parse(response.data.data)
                  if (data['ERROR_CODE'] != 1) this.$toast.error(data['MESSAGE'])
                  else {
                    data = data['RESULT']
                    if (this.DONGBO_TEST.TEST == false) {
                      for (var i = 0; i < this.lvwThueBao.length; i++) {
                        let l_hdtb_id = this.lvwThueBao[i]['hdtb_id']
                        var in_loaitb_id = this.lvwThueBao[i]['loaitb_id']
                        let str_matb = this.lvwThueBao[i]['ma_tb']

                        if (in_loaitb_id == LoaiHinhTB.INTERNET_ADSL || in_loaitb_id == LoaiHinhTB.INTERNET_FTTH || in_loaitb_id == LoaiHinhTB.WIFI_FIBER) {
                          await API.post_unReservedAccount(this.axios, { accountName: str_matb }).then((response) => {
                            if (response && response.data && response.data.data && response.data.errorCode != 1)
                              if (response.data.data == 'ok') this.$toast.success('Hủy đặt chỗ account ' + str_matb + ' trên Visa thành công!')
                              else this.$toast.error('Có lỗi xảy ra trong quá trình hủy đặt chỗ account ' + str_matb + ' trên Visa!')
                            else this.$toast.error(response.data.faultCode + ': ' + response.data.faultString)
                          })
                        }
                      }
                      //dungpa - xoa thue bao dang ky goi tren ccbs
                      // #region xoa thue bao dang ky goi tren ccbs
                      let dongbo_dadv = await API.post_lay_ds_thamso_md_mats(this.axios, { ma_ts: 'DONGBO_GOI_DA_DV' }).then((response) => {
                        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') return response.data.data.ten_ts ? response.data.data.ten_ts * 1 : -1
                        else {
                          this.$toast.error(response.data.message + ': ' + response.data.message_detail)
                          return -1
                        }
                      })
                      if (dongbo_dadv == 1) {
                        let _dsGoi = await API.post_lay_tt_goi_gdvp(this.axios, { vhdkh_id: this.khachhang.hdkh_id, vhdtb_id: 0, vnguoi_kh: this.tt_nd.ma_nd }).then((response) => {
                          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') return response.data.data
                          else {
                            this.$toast.error(response.data.message + ': ' + response.data.message_detail)
                            return {}
                          }
                        })
                        if (_dsGoi.vreturn_home.length > 0) {
                          for (let gitem of _dsGoi.vreturn_home) {
                            API.post_delete_package_css(this.axios, {
                              account: gitem.acc_fiber,
                              agent: this.tt_nd.tentat_ccbs,
                              channel: '1',
                              msisdn: '84' + gitem.ma_tb,
                              packageid: gitem.goi_neo_id,
                              // "request_id": "string",
                              // "service": "string",
                              // "serviceid": "string",
                              typeid: '1',
                              userid: this.tt_nd.ma_nv,
                              userip: await this.$root.token.getIP()
                            }).then((response) => {
                              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                                let kq = response.data.data
                                if (!kq.result_code) throw 'Có lỗi trong quá trình kích hoạt gói tích hợp trên VNP: ' + kq.errorMessage
                              } else {
                                this.$toast.error(response.data.message + ': ' + response.data.message_detail)
                                return {}
                              }
                            })
                          }
                        }

                        if (_dsGoi.vreturn_gdvp.length > 0) {
                          for (let gitem of _dsGoi.vreturn_gdvp) {
                            API.post_delete_package_css(this.axios, {
                              account: gitem.acc_fiber,
                              agent: this.tt_nd.tentat_ccbs,
                              channel: '1',
                              msisdn: '84' + gitem.ma_tb,
                              packageid: gitem.goi_neo_id,
                              // "request_id": "string",
                              // "service": "string",
                              // "serviceid": "string",
                              typeid: '1',
                              userid: this.tt_nd.ma_nv,
                              userip: await this.$root.token.getIP()
                            }).then((response) => {
                              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                                let kq = response.data.data
                                if (!kq.result_code) throw 'Có lỗi trong quá trình kích hoạt gói tích hợp trên VNP: ' + kq.errorMessage
                              } else {
                                this.$toast.error(response.data.message + ': ' + response.data.message_detail)
                                return {}
                              }
                            })
                          }
                        }
                      }
                      // #endregion
                      //end dungpa
                    }
                    // #region KieuNV:Kiểm tra nếu trong hđ có thuê bao di động trả sau thì gọi hàm xóa hđ trên CCBS. vuth update 0912
                    //Nếu hợp đồng có thuê bao di động thì gọi hàm xóa trên Vinaphone.
                    if (CoDiDong) {
                      let ck = {}
                      let chuaxoa_hopdong_hoamangmoi = true // hop dong hoa mang moi chi phai xoa 1 lan theo ma gd.
                      for (var i = 0; i < this.lvwThueBao.length; i++) {
                        let l_hdtb_id = this.lvwThueBao[i]['hdtb_id']
                        let kieuld_id_current = 0
                        if (data['DS_HD_KLD'])
                          for (var item of data['DS_HD_KLD'])
                            if (item['HDTB_ID'] == l_hdtb_id) {
                              kieuld_id_current = item['KIEULD_ID']
                              break
                            }
                        let str_matb = this.lvwThueBao[i]['ma_tb']
                        if ((kieuld_id_current == KieuLapDat.DM_DIDONG || kieuld_id_current == KieuLapDat.DM_DIDONG_C_P || kieuld_id_current == KieuLapDat.DM_DIDONG_KHOI_TAO_LAI) && chuaxoa_hopdong_hoamangmoi) {
                          let rsDel = await this.Delete_HDLD_VinaPhone(this.khachhang.magd)
                          if (rsDel != 'OK') {
                            this.loading(false)
                            let cfr = await this.$bvModal
                              .msgBoxConfirm(rsDel + '\r\nBạn có chắc muốn tiếp tục xóa HĐ trên dữ liệu viễn thông tỉnh?', {
                                title: 'Xác nhận hành động',
                                size: 'sm',
                                okTitle: 'Đồng ý',
                                cancelTitle: 'Hủy'
                              })
                              .then(async (v) => {
                                return v
                              })
                            if (!cfr) return
                          }
                          chuaxoa_hopdong_hoamangmoi = false // xóa thành công thì thuê bao khác trong hđ ko phải gọi hàm xóa trên vinaphone nữa.
                        } else if (kieuld_id_current == KieuLapDat.DM_DIDONG_CHUYEN_TINH) {
                          let rsDel = this.Delete_HD_ChuyenTinh_VinaPhone('84' + str_matb) // phải xóa từng hợp đồng
                          if (rsDel != 'OK') {
                            this.loading(false)
                            let cfr = await this.$bvModal
                              .msgBoxConfirm(rsDel + '\r\nBạn có chắc muốn tiếp tục xóa HĐ trên dữ liệu viễn thông tỉnh?', {
                                title: 'Xác nhận hành động',
                                size: 'sm',
                                okTitle: 'Đồng ý',
                                cancelTitle: 'Hủy'
                              })
                              .then(async (v) => {
                                return v
                              })
                            if (!cfr) return
                          }
                        }
                      }
                    }
                    // #endregion

                    // #region "Xóa UMP"
                    if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
                      if (this.listbox.loai_tb.valuemgwan == 157) {
                        //Fix ID loại thiết bị STB UMP
                        let rs = await this.$root.context.post('/tichhop/ump/DeleteUMP', { serialNumber: this.thuebao.adsl.txtSerialSTB }) //"mytvUsername":this.dsHDTB[0]["MA_TB"],"mytvPassword":this.dsHDTB[0]["PASSWORD"],
                        let kq = JSON.parse(rs.data)
                        if (kq['Message']) kq = kq['Message']
                        // let kq = CapNhatUMP(txtSerialSTB.Text.Trim(), dsHDTB.Tables[0].Rows[0]["MA_TB"].ToString(), dsHDTB_ADSL.Tables[0].Rows[0]["PASSWORD"].ToString(), ref message);
                        if (kq.status != 'success') {
                          this.$toast.error('Có lỗi trong quá trình xóa thông tin thiết bị trên UMP. Lỗi: ' + kq.message)
                          return
                        }

                        // string message = "";
                        // bool kq = XoaUMP(txtSerialSTB.Text.Trim(), ref message);
                        // if (!kq)
                        // {
                        //     Message_Box.ShowWarning("Có lỗi trong quá trình xóa thông tin thiết bị lên UMP. Lỗi: " + message);
                        //     return;
                        // }
                      }
                    }
                    // #endregion

                    let psubdata = { HDKH_ID: this.khachhang.hdkh_id, DS_HDTB: DS_HDTB, DONGBO_TEST: this.DONGBO_TEST.TEST }
                    API.post_fn_xoa_hopdong_datmoi(this.axios, { ds_para: JSON.stringify(psubdata) }).then((response) => {
                      if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                        let apidata = JSON.parse(response.data.data)
                        if (apidata['ERROR_CODE'] != 1) this.$toast.error(apidata['MESSAGE'])
                        else {
                          this.$toast.success(apidata['MESSAGE'])
                          this.buttonSet = 0
                          //Trong code cu la khong lam gi them o day!!!!
                          // API.post_lay_ds_hopdong_tb_theo_hdkh_id(this.axios, { "ds_para": JSON.stringify(psubdata) }).then((response) => {
                          //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {

                          //   }
                          // });
                          // let ds_hdkh_tmp = apidata['RESULT']['DS_HDTB'];
                          // ds_hdkh_tmp = this.LowerCasePropertyList(ds_hdkh_tmp);

                          // this.HienThiDanhSacHDTB(ds_hdkh_tmp);
                          // // this.HienThiTTHopDongTB(ds_hdkh_tmp);

                          // if(this.lvwThueBao.length<=1) this.buttons.tsbtnXoaTB = false;
                          // else this.buttons.tsbtnXoaTB = true;
                        }
                      }
                    })
                  }
                }
              })
            } catch (ex) {
              this.$toast.error('' + ex)
              if (this.debug) console.error(ex)
            }
          }
        })
    },
    async tsbtnXoaTB_Click() {
      if (this.lvwThueBao.length == 1) {
        this.$toast.error('Hợp đồng này hiện đang có 1 thuê bao, bạn hãy thực hiện chức năng xóa hợp đồng !')
        return
      }
      this.$bvModal
        .msgBoxConfirm('Bạn thật sự muốn xóa thuê bao không ?', {
          title: 'Xác nhận hành động',
          size: 'sm',
          okTitle: 'Đồng ý',
          cancelTitle: 'Hủy'
        })
        .then(async (v) => {
          if (v) {
            try {

              //Them phan check theo yeu cau cua CuongLT 2023-11-08
              var kqapixoa = await API.post_fn_kt_xoa_tt_hd(this.axios,{
                vkieu:1,vid:this.hdtb_id
              }).then(response =>{
                if(response.data && response.data.data) return response.data.data
                else return response.data.message + ': ' + response.data.message_detail;
              });
              if(!kqapixoa || kqapixoa!=1) {
                this.$toast.error("Lỗi xoá dữ liệu: "+(kqapixoa?kqapixoa:"Không xác định"));
                return -1;
              }
              // Het doan check
              let pdata = { HDTB_ID: this.hdtb_id, DONGBO_TEST: this.DONGBO_TEST.TEST }
              API.post_fn_kiemtra_xoa_thuebao(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  let data = JSON.parse(response.data.data)
                  if (data['ERROR_CODE'] != 1) {
                    this.$toast.error(data['MESSAGE'])
                    return
                  } else {
                    data = data['RESULT']
                    if (this.DONGBO_TEST.TEST == false) {
                      // for (var i = 0; i < this.lvwThueBao.length; i++)
                      // {
                      let l_hdtb_id = this.lvwThueBao_SelectedItem['hdtb_id']
                      var in_loaitb_id = this.lvwThueBao_SelectedItem['loaitb_id']
                      let str_matb = this.lvwThueBao_SelectedItem['ma_tb']

                      if (in_loaitb_id == LoaiHinhTB.INTERNET_ADSL || in_loaitb_id == LoaiHinhTB.INTERNET_FTTH || in_loaitb_id == LoaiHinhTB.WIFI_FIBER || in_loaitb_id == LoaiHinhTB.MEGA_IOT) {
                        await API.post_unReservedAccount(this.axios, { accountName: str_matb }).then((response) => {
                          if (response && response.data && response.data.data && response.data.errorCode != 1)
                            if (response.data.data == 'ok') this.$toast.success('Hủy đặt chỗ account ' + str_matb + ' trên Visa thành công!')
                            else this.$toast.error('Có lỗi xảy ra trong quá trình hủy đặt chỗ account ' + str_matb + ' trên Visa!')
                          else this.$toast.error(response.data.faultCode + ': ' + response.data.faultString)
                        })
                      }
                      // }
                      // TODO chua lam phan nay DI_DONG
                      //dungpa - xoa thue bao dang ky goi tren ccbs
                      // #region xoa thue bao dang ky goi tren ccbs
                      // DataSet dsTS = new ThamSo_MDFacade().LAY_DS_THAMSO_MD_MATS("DONGBO_GOI_DA_DV");
                      // int dongbo_dadv = -1;
                      // if (dsTS != null && dsTS.Tables[0].Rows.Count > 0)
                      // {
                      //     dongbo_dadv = Convert.ToInt32(dsTS.Tables[0].Rows[0]["TEN_TS"].ToString());
                      // }
                      // if (dongbo_dadv == 1)
                      // {
                      //     DataSet _dsGoi = new BangTuDienFacade().THUCTHI_PROCEDURE("LAY_TT_GOI_GDVP", DatabaseConstants.DB2, new string[] { "goi_home", "goi_gdvp" }, "vhdkh_id", hdkh_id, "vhdtb_id", 0, "vnguoi_kh", tt_nd.ma_nd);
                      //     if (_dsGoi.Tables["goi_home"].Rows.Count > 0)
                      //     {
                      //         WS_GOITICHHOP_VTN _ws = new WS_GOITICHHOP_VTN();
                      //         string _error = "";
                      //         string _result = "";
                      //         for (int i = 0; i < _dsGoi.Tables["goi_home"].Rows.Count; i++)
                      //         {
                      //             _result = _ws.XOA_GOI_V3(_dsGoi.Tables["goi_home"].Rows[i]["goi_neo_id"].ToString(), "84" + _dsGoi.Tables["goi_home"].Rows[i]["ma_tb"].ToString(), _dsGoi.Tables["goi_home"].Rows[i]["acc_fiber"].ToString(), "1", tt_nd.tentat, ref _error);
                      //             if (_result != "0")
                      //             {
                      //                 Message_Box.ShowWarning("Có lỗi trong quá trình kích hoạt gói tích hợp trên VNP: " + _error);
                      //                 return;
                      //             }
                      //         }
                      //     }

                      //     if (_dsGoi.Tables["goi_gdvp"].Rows.Count > 0)
                      //     {
                      //         WS_GOITICHHOP_VTN _ws = new WS_GOITICHHOP_VTN();
                      //         string _error = "";
                      //         string _result = "";
                      //         for (int i = 0; i < _dsGoi.Tables["goi_gdvp"].Rows.Count; i++)
                      //         {
                      //             _result = _ws.XOA_GOI_V3(_dsGoi.Tables["goi_gdvp"].Rows[i]["goi_neo_id"].ToString(), "84" + _dsGoi.Tables["goi_gdvp"].Rows[i]["ma_tb"].ToString(), _dsGoi.Tables["goi_gdvp"].Rows[i]["acc_fiber"].ToString(), "1", tt_nd.tentat, ref _error);
                      //             if (_result != "0")
                      //             {
                      //                 Message_Box.ShowWarning("Có lỗi trong quá trình kích hoạt gói tích hợp trên VNP: " + _error);
                      //                 return;
                      //             }
                      //         }
                      //     }
                      // }
                      // #endregion
                      //end dungpa
                    }
                    //TODO chua lam phan nay
                    // #region KieuNV:Kiểm tra nếu trong hđ có thuê bao di động trả sau thì gọi hàm xóa hđ trên CCBS. vuth update 0912
                    // let CoDiDong = false;
                    var item = this.lvwThueBao_SelectedItem
                    // for (var item in this.lvwThueBao)
                    // {
                    // if (item['loaitb_id'] == LoaiHinhTB.DIDONGTRASAU)
                    // {
                    //     CoDiDong = true;
                    //     // break;
                    // }
                    // }
                    //Nếu hợp đồng có thuê bao di động thì gọi hàm xóa trên Vinaphone.
                    if (item['loaitb_id'] == LoaiHinhTB.DIDONGTRASAU) {
                      let ck = {}
                      let chuaxoa_hopdong_hoamangmoi = true // hop dong hoa mang moi chi phai xoa 1 lan theo ma gd.
                      // for (var i = 0; i < this.lvwThueBao.length; i++)
                      // {
                      // let l_hdtb_id = item['hdtb_id'];
                      let kieuld_id_current = 0
                      if (data['DS_HD_KLD'])
                        for (var item1 of data['DS_HD_KLD'])
                          if (item1['HDTB_ID'] == l_hdtb_id) {
                            kieuld_id_current = item1['KIEULD_ID']
                            break
                          }
                      // let str_matb = this.lvwThueBao[i]['ma_tb'];
                      if ((kieuld_id_current == KieuLapDat.DM_DIDONG || kieuld_id_current == KieuLapDat.DM_DIDONG_C_P) && chuaxoa_hopdong_hoamangmoi) {
                        let rsDel = await this.Delete_HDLD_VinaPhone(this.khachhang.magd)
                        if (rsDel != 'OK') {
                          this.loading(false)
                          let cfr = await this.$bvModal
                            .msgBoxConfirm(rsDel + '\r\nBạn có chắc muốn tiếp tục xóa HĐ trên dữ liệu viễn thông tỉnh?', {
                              title: 'Xác nhận hành động',
                              size: 'sm',
                              okTitle: 'Đồng ý',
                              cancelTitle: 'Hủy'
                            })
                            .then(async (v) => {
                              return v
                            })

                          if (!cfr) return
                        }
                        chuaxoa_hopdong_hoamangmoi = false // xóa thành công thì thuê bao khác trong hđ ko phải gọi hàm xóa trên vinaphone nữa.
                      } else if (kieuld_id_current == KieuLapDat.DM_DIDONG_CHUYEN_TINH) {
                        let rsDel = this.Delete_HD_ChuyenTinh_VinaPhone('84' + str_matb) // phải xóa từng hợp đồng
                        if (rsDel != 'OK') {
                          this.loading(false)
                          let cfr = await this.$bvModal
                            .msgBoxConfirm(rsDel + '\r\nBạn có chắc muốn tiếp tục xóa HĐ trên dữ liệu viễn thông tỉnh?', {
                              title: 'Xác nhận hành động',
                              size: 'sm',
                              okTitle: 'Đồng ý',
                              cancelTitle: 'Hủy'
                            })
                            .then(async (v) => {
                              return v
                            })

                          if (!cfr) return
                        }
                      }
                      // }
                    }
                    // #endregion

                    //FIXME code xoa thue bao khong thay xoa UMP?????
                    // // #region "Xóa UMP"
                    // if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV)
                    // {
                    //     if (this.listbox.loai_tb.valuemgwan == 157) //Fix ID loại thiết bị STB UMP
                    //     {
                    //       let rs = await this.$root.context.post("http://10.70.52.120:4740/api/DeleteUMP",{"serialNumber":this.thuebao.adsl.txtSerialSTB,});//"mytvUsername":this.dsHDTB[0]["MA_TB"],"mytvPassword":this.dsHDTB[0]["PASSWORD"],
                    //         let kq = JSON.parse(rs.data);
                    //         // let kq = CapNhatUMP(txtSerialSTB.Text.Trim(), dsHDTB.Tables[0].Rows[0]["MA_TB"].ToString(), dsHDTB_ADSL.Tables[0].Rows[0]["PASSWORD"].ToString(), ref message);
                    //         if (kq.status!="success")
                    //         {
                    //             Message_Box.ShowWarning("Có lỗi trong quá trình xóa thông tin thiết bị trên UMP. Lỗi: " + kq.message);
                    //             return;
                    //         }

                    //         // string message = "";
                    //         // bool kq = XoaUMP(txtSerialSTB.Text.Trim(), ref message);
                    //         // if (!kq)
                    //         // {
                    //         //     Message_Box.ShowWarning("Có lỗi trong quá trình xóa thông tin thiết bị lên UMP. Lỗi: " + message);
                    //         //     return;
                    //         // }
                    //     }
                    // }
                    // // #endregion

                    let psubdata = { HDTB_ID: this.hdtb_id, KIEULD_ID: this.listbox.kieu_ld.value }
                    API.post_fn_xoa_thuebao_datmoi(this.axios, { ds_para: JSON.stringify(psubdata) }).then((response) => {
                      if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                        let data = JSON.parse(response.data.data)
                        if (data['ERROR_CODE'] != 1) this.$toast.error(data['MESSAGE'])
                        else {
                          this.$toast.success(data['MESSAGE'])
                          API.post_lay_ds_hopdong_tb_theo_hdkh_id(this.axios, { in_hdkh_id: this.khachhang.hdkh_id }).then(async (response) => {
                            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                              let ds_hdkh_tmp = response.data.data
                              ds_hdkh_tmp = this.LowerCasePropertyList(ds_hdkh_tmp)
                              await this.HienThiDanhSacHDTB(ds_hdkh_tmp)
                              await this.HienThiTTHopDongTB(ds_hdkh_tmp) // FIXME cho nay trong code cu khong co, nhung co ve can de refresh lai hop dong sau khi xoa
                            }
                          })
                          if (this.lvwThueBao.length <= 1) this.buttons.tsbtnXoaTB = false
                          else this.buttons.tsbtnXoaTB = true
                        }
                      }
                    })
                  }
                }
              })
            } catch (ex) {
              this.$toast.error('' + ex)
              if (this.debug) console.error(ex)
            }
          }
        })
    },
    tenKHChanged(v) {
      this.khachhang.tenkh = v.target.value
      if (this.khachhang.tenkh && this.khachhang.tenkh.trim() != '') {
        if (!this.thanhtoan.tentt || this.thanhtoan.tentt.trim() == '') this.thanhtoan.tentt = this.khachhang.tenkh
        if (!this.thuebao.tentb || this.thuebao.tentb.trim() == '') this.thuebao.tentb = this.khachhang.tenkh
        if (!this.khachhang.nguoidd || this.khachhang.nguoidd.trim() == '') this.khachhang.nguoidd = this.khachhang.tenkh
      }
    },
    ngaySinhChanged() {
      if (this.NgaySinh && !this.NgaySinhTB) this.NgaySinhTB = this.NgaySinh
      {
        let kieukh = KIEU_KH.CA_NHAN
        if (this.listbox.loai_kh.value && this.listbox.loai_kh.value > 0) kieukh = this.listbox.loai_kh.list.filter((x) => x.loaikh_id == this.listbox.loai_kh.value)[0]['loai'] //.Select("LOAIKH_ID=" + cboLoaiKH.EditValue)[0]["LOAI"];
        if (kieukh == KIEU_KH.CA_NHAN && moment().diff(moment(this.NgaySinh, this.datetimeFormatFull), 'years') < 18) {
          this.$toast.error('Khách hàng chưa đủ 18 tuổi để làm hợp đồng!')
          return false
        }
      }
      return true
    },
    async btnThongTinKhacClick() {
      let ts_kt_mstmns_kh = this.thamsomacdinh['KIEMTRA_MSTMNS_KHDN']
      if (this.khachhang.hdkh_id <= 0 && ts_kt_mstmns_kh != 1) {
        this.$toast.error('Hãy lập hợp đồng trước')
        return
      }
      if (!this.listbox.loai_kh.value || this.listbox.loai_kh.value == -1) {
        this.$toast.error('Bạn hãy chọn loại khách hàng trước')
        return
      }
      this.popupComponent = () => import('./Popups/popupInforAdd')
      this.popupComponentName = 'popupInforAdd'
      this.popupComponentData = {
        _hdkh_id: this.khachhang.hdkh_id,
        _nhapmoi: this.buttonSet == 1,
        _vma_kh: this.khachhang.makh,
        _vkieukh_id: this.vkieukh_id_,
        _ts_kt_tthdkhdn: this.ts_kt_tthdkhdn,
        ts_kt_mstmns_kh: ts_kt_mstmns_kh,
        loaikh: this.listbox.loai_kh.value,
        mast: this.khachhang.masothue,
        dsHDKH_Sub: this.dsHDKH_Sub && this.dsHDKH_Sub.length > 0 ? this.dsHDKH_Sub : []
      }
      this.Popup('popupComponents')
    },
    async frmHDTB_SUB_V3_tsbtnGhiLai_Click() {
      if (!this.khachhang.txtNguoiKyHoSo || this.khachhang.txtNguoiKyHoSo.trim() == '' || !this.khachhang.txtChucDanh || this.khachhang.txtChucDanh.trim() == '') {
        this.$toast.error('Bạn chưa nhập đủ thông tin')
        return
      }
      let row = {}

      row.NGUOI_KY_HOSO = this.khachhang.txtNguoiKyHoSo
      row.CHUCDANH = this.khachhang.txtChucDanh
      row.HDTB_ID = this.hdtb_id
      // row.MST_KHTN = await API.get_mst_khtn(this.axios,{params:{"hdtb_id":this.hdtb_id}}).then((response) => {
      //     if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //       return (response.data.data);
      //     } else return null;
      //   }).catch(()=>{ return null; });
      // if(!row.MST_KHTN) row.MST_KHTN = this.thuebao.txtMSTThueBao;
      this.dsHDTB_SUB = [row]

      this.$bvModal.hide('frmHDTB_SUB_V3')
      // this.popup.frmHDTB_SUB_V3 = false;
    },
    async frmHDTB_SUB_V4_tsbtnGhiLai_Click() {
      if (!this.khachhang.txtNguoiKyHoSo || this.khachhang.txtNguoiKyHoSo.trim() == '') {
        this.$toast.error('Bạn chưa nhập đủ thông tin')
        return
      }
      let row = {}

      row.NGUOI_KY_HOSO = this.khachhang.txtNguoiKyHoSo
      row.NGAYSINH = this.khachhang.dtpNgaySinh
      row.GIOITINH = this.khachhang.cboGioiTinh
      row.SO_GT = this.khachhang.txtSoGT
      row.NGAYCAP = this.khachhang.dtpNgayCap
      row.NOICAP = this.khachhang.txtNoiCap
      row.EMAIL = this.khachhang.txtEmail
      row.SO_DT = this.khachhang.txtSoDT
      row.HDTB_ID = this.hdtb_id
      // row.MST_KHTN = await API.get_mst_khtn(this.axios,{params:{"hdtb_id":this.hdtb_id}}).then((response) => {
      //     if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //       return (response.data.data);
      //     } else return null;
      //   }).catch(()=>{ return null; });
      // if(!row.MST_KHTN) row.MST_KHTN = this.thuebao.txtMSTThueBao;
      this.dsHDTB_SUB = [row]

      this.$bvModal.hide('frmHDTB_SUB_V4')
      // this.popup.frmHDTB_SUB_V4 = false;
    },
    async ThongBao(msg, title) {
      if (!title) title = 'Lỗi dữ liệu'
      await this.$bvModal.msgBoxOk(msg, {
        title: title,
        size: 'sm',
        okTitle: 'Đồng ý'
      })
    },
    async ValidateModal(bvEvent, modalId) {
      switch (modalId) {
        case 'modal-tieunganh':
          if (
            (this.tieunganh.dsTNC1 && this.tieunganh.dsTNC1.length > 0 && (!this.tieunganh.TNC1_ID || this.tieunganh.TNC1_ID <= 0)) ||
            (this.tieunganh.dsTNC2 && this.tieunganh.dsTNC2.length > 0 && (!this.tieunganh.TNC2_ID || this.tieunganh.TNC2_ID <= 0)) ||
            (this.tieunganh.dsTNC3 && this.tieunganh.dsTNC3.length > 0 && (!this.tieunganh.TNC3_ID || this.tieunganh.TNC3_ID <= 0)) ||
            (this.tieunganh.dsTNC4 && this.tieunganh.dsTNC4.length > 0 && (!this.tieunganh.TNC4_ID || this.tieunganh.TNC4_ID <= 0))
          )
            await this.$toast.error('Bạn chưa chọn chi tiết ngành nghề. Hãy kiểm tra lại!')
          return
        default:
          return
      }
    },
    loaikhChanged(node, insid) {
      if (!node) return
      this.buttons.btnThongTinKhac = node.cate != 'Cá nhân'
      if (!this.buttons.btnThongTinKhac && this.khachhang.gioitinh == -1) this.khachhang.gioitinh = 0
    },
    async btnChiTietTraTruoc_Click() {
      try {
        let vmuccuoctn_id = 0
        let vtocdotn_id = 0
        //TODO bo qua vi khong phai phan co dinh
        if (
          this.listbox.dichvu_vt.value == DichVuVienThong.ADSL ||
          this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT ||
          this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT ||
          this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU ||
          this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH
        ) {
          if (this.listbox.cboGoiCuocAdsl.value != null && this.listbox.cboGoiCuocAdsl.value != '') vtocdotn_id = this.listbox.cboGoiCuocAdsl.value
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER) {
            if (this.listbox.muccuoc.value != null && this.listbox.muccuoc.value >= 0) vmuccuoctn_id = this.listbox.muccuoc.value
          }
        } else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) vtocdotn_id = this.listbox.tocdokenh.valuecir
        //Convert.ToInt32(cboTocDo.EditValue);
        else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) vtocdotn_id = this.listbox.tocdokenh.valuetsl

        //Hiếu bổ sung thêm hàm lấy tiền khuyến mại 23.09.2010

        let khuyenmai_id_tt = this.filterbox.tratruoc.value
        let kt = -1
        await API.get_kiemTraThoiHanKM(this.axios, { params: { khuyenMaiId: this.filterbox.tratruoc.value, ngayYc: this.NgayYeuCau ? (this.NgayYeuCau.length > 10 ? this.NgayYeuCau.substring(0, 10) : this.NgayYeuCau) : null } }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            kt = response.data.data
          }
        })
        if (kt == 0) {
          let ngay_kt_km = ''
          await API.post_lay_ngaykt_km(this.axios, { km_id: this.filterbox.tratruoc.value }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              ngay_kt_km = response.data.data
            }
          })
          let tenkm = this.filterbox.tratruoc.list.filter((x) => x.khuyenmai_id == this.filterbox.tratruoc.value)[0].ten_km
          this.loading(false)
          await this.$bvModal
            .msgBoxConfirm('Khuyến mại ' + tenkm + ' đã hết thời hạn từ ngày ' + ngay_kt_km + '.\nBạn có muốn tiếp tục chọn chi tiết khuyến mại?', {
              title: 'Xác nhận hành động',
              size: 'sm',
              okTitle: 'Đồng ý',
              cancelTitle: 'Hủy'
            })
            .then(async (v) => {
              if (!v) {
                //FIXME khong ro dung lam gi, code cu gan nhu ko co tac dung
                this.kmld.tien_kmld_tt = 0
                this.kmld.vat_kmld_tt = 0
                this.kmld.tyle_kmld = 0
                this.kmld.tong_kmld_tt = 0
                this.kmld.dtiendatcoc_tt = 0
                this.kmld.dvatdatcoc_tt = 0
                await this.HT_ThietBi()
                await this.HT_DichVuGT()
                await this.HienThiTienKhuyenMaiLapDat()
                await this.LayTongTien_HDTB()
              } else kt = 1
            })
          if (kt != 1) return
        }
        // Vinh[v zem lai sualoi anh Long
        this.popupComponent = () => import('./Popups/popup-Dangkychitietkhuyenmai')
        this.popupComponentName = 'popup-DangkychitietkhuyenmaiTT'
        this.popupComponentData = {
          khuyenmai_id: khuyenmai_id_tt,
          vchuyenmang: this.listbox.nhacc_cu.ischecked ? 1 : 0,
          _hdtb_id: this.hdtb_id,
          vdichvuvt_id: this.listbox.dichvu_vt.value,
          m_dsThueBao_DichVu: this.m_dsThueBao_DichVu,
          dsDC_HDTB: this.LowerCasePropertyList(this.dsDC_HDTB),
          vtocdotn_id: vtocdotn_id,
          vmuccuoctn_id: vmuccuoctn_id,
          dichvu_vt: this.listbox.dichvu_vt.value,
          loaihinh_tb: this.listbox.loaihinh_tb.value,
          kieu_km: 1,
          ht_kmtt: this.thamsomacdinh['HT_KMTT'] == 1,
          loainha_id: this.diachiLD.LOAINHA_ID
        } // 0: khuyen mai, 1 tra truoc
        this.Popup('popupComponents')
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async btnChiTietKM_Click() {
      let vmuccuoctn_id = 0
      let vtocdotn_id = 0
      //TODO tam bo qua vi khong lien quan den co dinh
      if (
        this.listbox.dichvu_vt.value == DichVuVienThong.ADSL ||
        this.listbox.dichvu_vt.value == DichVuVienThong.ANTOAN_BAOMAT_TT ||
        this.listbox.dichvu_vt.value == DichVuVienThong.DICHVU_CNTT ||
        this.listbox.dichvu_vt.value == DichVuVienThong.TRUNGTAM_DULIEU ||
        this.listbox.dichvu_vt.value == DichVuVienThong.HOINGHI_TRUYENHINH ||
        this.listbox.dichvu_vt.value == DichVuVienThong.BRCD_DOITAC
      ) {
        if (this.listbox.cboGoiCuocAdsl.value != null && this.listbox.cboGoiCuocAdsl.value != '') vtocdotn_id = this.listbox.cboGoiCuocAdsl.value
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH || this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_FIBER || this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGA_IOT) {
          if (this.listbox.muccuoc.value != null && this.listbox.muccuoc.value >= 0) vmuccuoctn_id = this.listbox.muccuoc.value
        }
      } else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.MGW_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) vtocdotn_id = this.listbox.tocdokenh.valuecir
      //Convert.ToInt32(cboTocDo.EditValue);
      else if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) vtocdotn_id = this.listbox.tocdokenh.valuetsl //Convert.ToInt32(cboTocDoKenhTSL.EditValue);

      //Hiếu bổ sung thêm hàm lấy tiền khuyến mại 23.09.2010
      let khuyenmai_id = this.filterbox.khuyenmai.value
      let kt = -1
      await API.get_kiemTraThoiHanKM(this.axios, { khuyenMaiId: khuyenmai_id, ngayYc: this.NgayYeuCau ? this.NgayYeuCau : null }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          kt = response.data.data
        }
      })
      if (kt == 0) {
        let ngay_kt_km = ''
        await API.post_lay_ngaykt_km(this.axios, { km_id: khuyenmai_id }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            ngay_kt_km = response.data.data
          }
        })
        let tenkm = this.filterbox.khuyenmai.list.filter((x) => x.khuyenmai_id == this.filterbox.khuyenmai.value)[0].ten_km
        this.loading(false)
        await this.$bvModal
          .msgBoxConfirm('Khuyến mại ' + tenkm + ' đã hết thời hạn từ ngày ' + ngay_kt_km + '.\nBạn có muốn tiếp tục chọn chi tiết khuyến mại?', {
            title: 'Xác nhận hành động',
            size: 'sm',
            okTitle: 'Đồng ý',
            cancelTitle: 'Hủy'
          })
          .then(async (v) => {
            if (!v) {
              //FIXME khong ro dung lam gi, code cu gan nhu ko co tac dung
              this.kmld.dtienkmld = 0
              this.kmld.dvatkmld = 0
              this.kmld.tyle_kmld = 0
              this.kmld.tong_kmld = 0
              this.kmld.tien_datcoc = 0
              await this.HT_ThietBi()
              await this.HT_DichVuGT()
              await this.HienThiTienKhuyenMaiLapDat()
              await this.LayTongTien_HDTB()
            } else kt = 1
          })
        if (kt != 1) return
      }
      //VinhPV xem lai sua loi cho anh Long
      this.popupComponent = () => import('./Popups/popup-Dangkychitietkhuyenmai')
      this.popupComponentName = 'popup-Dangkychitietkhuyenmai'
      this.popupComponentData = {
        khuyenmai_id: khuyenmai_id,
        vchuyenmang: this.listbox.nhacc_cu.ischecked ? 1 : 0,
        _hdtb_id: this.hdtb_id,
        vdichvuvt_id: this.listbox.dichvu_vt.value,
        m_dsThueBao_DichVu: this.m_dsThueBao_DichVu,
        dsKM_HDTB: this.LowerCasePropertyList(this.dsKM_HDTB),
        vtocdotn_id: vtocdotn_id,
        vmuccuoctn_id: vmuccuoctn_id,
        dichvu_vt: this.listbox.dichvu_vt.value,
        loaihinh_tb: this.listbox.loaihinh_tb.value,
        kieu_km: 0,
        ht_kmtt: this.thamsomacdinh['HT_KMTT'] == 1,
        loainha_id: this.diachiLD.LOAINHA_ID,
      } // 0: khuyen mai, 1 tra truoc
      this.Popup('popupComponents')
    },
    LaySothang_SD() {
      this.thuebao.thangck = 0
      API.post_fn_lay_thang_sd(this.axios, { ds_para: JSON.stringify({ CHK_KHUYENMAI: this.filterbox.khuyenmai.ischecked ? 1 : 0, CHK_TRATRUOC: this.filterbox.tratruoc.ischecked ? 1 : 0, CBO_TRATRUOC: this.filterbox.tratruoc.value, CBO_KHUYENMAI: this.filterbox.khuyenmai.value }) }).then(
        (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let kq = JSON.parse(response.data.data)
            if (kq && kq['RESULT'] && kq['RESULT']['SOTHANG_SD']) this.thuebao.thangck = kq['RESULT']['SOTHANG_SD']
          }
        }
      )
    },
    async DangXayDung() {
      this.$toast.error('Chức năng đang được xây dựng và hoàn thiện!')
      let mst_ = this.thanhtoan.masothue
      if (this.thamsomacdinh['KIEMTRA_MSTMNS_KHDN'] == 1) {
          if (!mst_ && (this.dsHDKH_Sub.length == 0 || (this.dsHDKH_Sub.length > 0 && !this.dsHDKH_Sub[0]['MA_NS'])) && !this.is_nv_vnpti) {
            this.$toast.error('Bạn phải nhập mã số thuế hoặc mã ngân sách')
            return false
          }
          // if (mst_) // Thuc hien o FN_KIEMTRA_DL_KHACHHANG
          // {
          //     let kq_kt = new LapHopDongFacade2().GET_VALUE_FUNC("{?DB2}.KiemTra_MST".ReplaceSchema(), "vmst", mst_.ToString());
          //     if (kq_kt.ToString() != "OK")
          //     {
          //         Message_Box.ShowTB(kq_kt.ToString());
          //         return false;
          //     }
          // }

          if (this.dsHDKH_Sub.length > 0 && this.dsHDKH_Sub[0]['MA_NS']) {
            let mans = this.dsHDKH_Sub[0]['MA_NS'] + ''
            if (!(mans + '').match(/^[123789]\d{6}$/g)) {
              this.$toast.error('Mã ngân sách phải là số có 7 chữ số và bắt đầu bằng 1 trong các số 1/2/3/7/8/9. Vui lòng kiểm tra lại!')
              return false
            }
          }
        }
    },
    lvwThueBaoChanged(idx, item) {
      try {
        if (idx >= 0) {
          this.loading(true)
          this.hdtb_id = item.hdtb_id
          this.lvwThueBao_SelectedItem = item
          API.post_lay_ds_hopdong_tb_theo_hdtb_id(this.axios, { in_hdtb_id: item.hdtb_id })
            .then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                let ds = response.data.data
                if (ds && ds.length > 0) this.HienThiTTHopDongTB(ds)
              }
            })
            .finally(() => this.loading(false))
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async ThemHDThanhToan() {
      try {
        this.thanhtoan.matt = ''
        this.loading(true)
        await API.post_fn_kiemtra_dl_thanhtoan(this.axios, {
          ds_para: JSON.stringify({
            DICHVUVT_ID: this.listbox.dichvu_vt.value,
            LOAITB_ID: this.listbox.loaihinh_tb.value,
            BB_CHON_DD: 0,
            QUANTT_ID: this.diachiTT.QUAN_ID,
            PHUONGTT_ID: this.diachiTT.PHUONG_ID,
            PHOTT_ID: this.diachiTT.PHO_ID,
            APTT_ID: this.diachiTT.AP_ID,
            KHUTT_ID: this.diachiTT.KHU_ID,
            HDTB_ID: this.hdtb_id,
            MA_TT: this.thanhtoan.matt,
            THANHTOAN_ID: this.thanhtoan.thanhtoan_id,
            MASOTHUE: this.thanhtoan.masothue,
            TS_KT_MST: this.thamsomacdinh['KIEMTRA_MST'] && this.thamsomacdinh['KIEMTRA_MST'] == 1 ? 1 : 0,
            HDKH_ID: this.khachhang.hdkh_id,
            KHACHHANG_ID: this.khachhang.khachhang_id
          })
        }).then(async (response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] == 1) {
              await this.TaoDuLieu_HDTT(true)
              await this.TaoDuLieu_HDTT_NV(true)
              await this.TaoDuLieu_DiaChi(true, 2)
              let pdata = {
                HD_THANHTOAN: this.dsHDTT,
                DIACHI: this.dsDiaChi,
                DIACHI_HDTT: this.dsDiaChiHDTT,
                HDTT_NV: this.dsHDTT_NV,
                DS_DIACHI_BC: {
                  DIACHIBC_ID: this.diachibc_id,
                  HDTT_ID: this.hdtt_id,
                  PHOBC_ID: this.diachiBC.PHO_ID,
                  PHUONGBC_ID: this.diachiBC.PHUONG_ID,
                  QUANBC_ID: this.diachiBC.QUAN_ID,
                  SONHA_BC: this.diachiBC.SO_NHA,
                  DIACHI_BC: this.diachiBC.DIACHI,
                  TINHBC_ID: this.diachiBC.TINH_ID,
                  APBC_ID: this.diachiBC.AP_ID,
                  KHUBC_ID: this.diachiBC.KHU_ID,
                  DACDIEMBC_ID: this.diachiBC.DACDIEM_ID,
                  BLOCK: this.diachiBC.BLOCK?this.diachiBC.BLOCK:null,
                  TANG: this.diachiBC.TANG?this.diachiBC.TANG:null,
                  PHONG: this.diachiBC.PHONG?this.diachiBC.PHONG:null,
                  MOTA: this.diachiBC.BLOCK?this.diachiBC.MOTA:null,
                }
              }
              await API.post_fn_them_hopdong_thanhtoan(this.axios, { ds_para: JSON.stringify(pdata) }).then(async (response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  //new DatMoiFacade().ThemMoi_HopDongTT(dsHDTT, dsDiaChi, dsDiaChiHDTT, dsHDTT_NV);
                  let apidata = JSON.parse(response.data.data)
                  if (apidata['ERROR_CODE'] == 1) {
                    this.$toast.success(apidata['MESSAGE'])
                    //Them diachi bao cuoc
                    this.diachibc_id = 0
                    // this.CapNhat_DiaChiBC(); // co ve da xu ly o buoc insert tren
                    //
                    await this.HienThiDS_HDTT_CBO(this.khachhang.hdkh_id)
                    await API.get_ds_hopdong_tt_theo_hdkh_id(this.axios, { params: { hdkhId: this.khachhang.hdkh_id } }).then(async (response) => {
                      if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                        await this.HienThiDanhSacHDTT(response.data.data)
                      }
                    })
                  } else this.$toast.error(apidata['MESSAGE'])
                }
              })
            } else this.$toast.error(apidata['MESSAGE'])
            //"data": "{\"ERROR_CODE\":1,\"MESSAGE\":\"Thành công\",\"RESULT\":{}}"
          }
        })
        this.loading(false)
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async lvwThanhToanChanged(idx, item) {
      try {
        this.loading(true)
        if (idx >= 0 && item) {
          this.hdtt_id = item.hdtt_id
          await API.post_lay_ds_hopdong_tt_theo_hdtt_id(this.axios, { hdtt_id: this.hdtt_id }).then(async (response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              await this.HienThiTTHopDongTT(response.data.data)
            }
          })
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      } finally {
        this.loading(false)
      }
    },
    async tsbtnXoaTT_Click() {
      if (!this.hdtt_id || this.hdtt_id <= 0) return
      this.loading(false)
      this.$bvModal
        .msgBoxConfirm('Bạn thật sự muốn xóa thanh toán không ?', {
          title: 'Xác nhận hành động',
          size: 'sm',
          okTitle: 'Đồng ý',
          cancelTitle: 'Hủy'
        })
        .then(async (v) => {
          if (v) {
            try {
              this.loading(true)
              await API.post_fn_xoa_hopdong_thanhtoan(this.axios, { ds_para: JSON.stringify({ HDTT_ID: this.hdtt_id }) }).then(async (response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  let apidata = JSON.parse(response.data.data)
                  if (apidata['ERROR_CODE'] == 0) this.$toast.error(apidata['MESSAGE'])
                  else {
                    this.$toast.success(apidata['MESSAGE'])
                    await this.HienThiDS_HDTT_CBO(this.khachhang.hdkh_id)
                    await API.get_ds_hopdong_tt_theo_hdkh_id(this.axios, { params: { hdkhId: this.khachhang.hdkh_id } }).then(async (response) => {
                      if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                        await this.HienThiDanhSacHDTT(response.data.data)
                      }
                    })
                  }
                }
              })
            } catch (ex) {
              this.$toast.error('' + ex)
              if (this.debug) console.error(ex)
            } finally {
              this.loading(false)
            }
          }
        })
    },
    async btnChonSoChinh_Click() {
      if ((!this.khachhang.khachhang_id || this.khachhang.khachhang_id == 0) && (!this.khachhang.hdkh_id || this.khachhang.hdkh_id == 0)) {
        this.$toast.error('Chưa có thông tin khách hàng/hợp đồng !')
        return
      }
      /*
                  frmDSSoChinh frm = new frmDSSoChinh();
                  if (khachhang_id > 0)
                  {
                      frm.vid = khachhang_id;
                      frm.vloai = 1;
                  }
                  if (hdkh_id > 0)
                  {
                      frm.vid = hdkh_id;
                      frm.vloai = 2;
                  }
                  frm.vdichvuvt_id = DichVuVienThong.CO_DINH;
                  frm.vloaitb_id = this.listbox.loaihinh_tb.value;
                  frm.ShowDialog();
                  */
      let tieude = 'Chọn số chính Pabx'
      switch (this.listbox.dichvu_vt.value * 1) {
        case DichVuVienThong.MEGAWAN:
          tieude = 'Chọn hướng kết nối Megawan'
          break
        case DichVuVienThong.CO_DINH:
        case DichVuVienThong.IMS:
          tieude = 'Chọn số chính'
          break
        case DichVuVienThong.HOINGHI_TRUYENHINH:
          tieude = 'Chọn điểm cầu chính'
          break
      }
      let dlist = []
      //BUG: Khong thay gan vkieu, de mac dinh theo DB mau = 1
      await API.post_fn_lay_tt_load_dssochinh(this.axios, {
        ds_para: JSON.stringify({ VDICHVUVT_ID: this.listbox.dichvu_vt.value, VID: this.khachhang.hdkh_id ? this.khachhang.hdkh_id : this.khachhang.khachhang_id, VLOAI: this.khachhang.hdkh_id > 0 ? 2 : this.khachhang.khachhang_id > 0 ? 1 : 0, VLOAITB_ID: this.listbox.loaihinh_tb.value, VKIEU: 1 })
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            this.$toast.error(apidata['MESSAGE'])
            return
          } else {
            dlist = apidata['RESULT']['DS']
            if (dlist) dlist = this.LowerCasePropertyList(dlist)
            if (apidata['RESULT']['TEXT']) tieude = apidata['RESULT']['TEXT']
          }
        }
      })
      this.popupComponent = () => import('./Popups/popupChonGrid')
      this.popupComponentName = 'popupDSSoChinh'
      this.popupComponentData = {
        ds: dlist,
        cols: [
          { fieldName: 'loaihinh_tb', headerText: 'Loại hình', allowFiltering: false, allowSorting: false },
          { fieldName: 'ma_tb', headerText: 'Mã thuê bao', allowFiltering: false, allowSorting: false },
          { fieldName: 'trangthai_tb', headerText: 'Trạng thái', allowFiltering: false, allowSorting: false },
          { fieldName: 'tocdo', headerText: 'Tốc độ', allowFiltering: false, allowSorting: false },
          { fieldName: 'diachi_ld', headerText: 'Địa chỉ LĐ', allowFiltering: false, allowSorting: false },
          { fieldName: 'mucuoc_tb', headerText: 'Mức cước', allowFiltering: false, allowSorting: false },
          { fieldName: 'id_sochinh', headerText: 'ID Số chính', allowFiltering: false, allowSorting: false },
          { fieldName: 'loai', headerText: 'kieuld_id', allowFiltering: false, allowSorting: false }
        ],
        keycol: '',
        allowExit: false,
        tieude: tieude,
        tieudebang: ' '
      }
      this.Popup('popupComponents')
    },
    btnTaoMIG_Click() {
      if (!this.khachhang.hdkh_id || this.khachhang.hdkh_id == 0) {
        this.$toast.error('Chưa có thông tin về hợp đồng khách hàng!')
        return
      }

      let obj = {}
      obj.hdkh_id = this.khachhang.hdkh_id
      obj.khachhang_id = this.khachhang.khachhang_id
      obj.hdtt_id = this.hdtt_id
      obj.thanhtoan_id = this.thanhtoan.thanhtoan_id
      obj.fmig_id = this.thanhtoan.mig_id
      obj.fhdmig_id = this.thanhtoan.hdmig_id
      obj.ma_tt = this.thanhtoan.matt
      obj.ten_tt = this.thanhtoan.tentt

      this.popupComponent = () => import('./Popups/popupChonMaInGhep')
      this.popupComponentName = 'popupChonMaInGhep'
      this.popupComponentData = obj
      this.Popup('popupComponents')
    },
    async FormLoad() {
      this.loading(true)
      this.isLoadKH = false;
      this.watcherActive = false
      // this.isEditKH = false;
      API.get_lay_dk_bang(this.axios, { params: { tenBang: 'CHUQUAN' } }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.DS_CHUQUAN_THEO_QUYEN = response.data.data
        }
      })
      this.tt_nd = await this.$root.token.getThongTinNguoiDung()
      this.tt_nd.may_cn = await this.$root.token.getMachine()
      this.ctv_id = this.$root.token.getNhanVienID()
      let api1 = cacheDM.getters.getFromCache('post_lay_danhmuc_lapmoi_tt_chung_v8', 'v8')
      if (!api1)
        api1 = API.post_lay_danhmuc_lapmoi_tt_chung_v8(this.axios, {
          vchuoi:
            'TRANG_BI|LOAI_TB|CHU_QUAN|TIEN_KM|DOITUONG|DICHVU_VT|LOAIHINH_TB|LOAI_KHL|LOAI_GT|PHANLOAI_KH|LOAI_KH|NGANHANG|HINHTHUC_TT|HINHTHUC_TC|DANTOC|NGANHNGHE|QUOCTICH|HINHTHUC_TTHI|KIEU_HD|GOI_KT|DONVI_QL|KIEU_LD|NHACC_CU|CONGNGHE|HINHTHUC_CM|THOIHAN|LOAI_CSHT|DOITAC|LOAI_IP|PHANLOAI_DV'
        })
      else
        api1 = new Promise((resolve, reject) => {
          resolve(api1)
        })
      api1.then(
        // let api1 = API.post_lay_danhmuc_lapmoi_tt_chung_v8(this.axios,{'vchuoi':'TRANG_BI|LOAI_TB|CHU_QUAN|TIEN_KM|DOITUONG|DICHVU_VT|LOAIHINH_TB|LOAI_KHL|LOAI_GT|PHANLOAI_KH|LOAI_KH|NGANHANG|HINHTHUC_TT|HINHTHUC_TC|DANTOC|NGANHNGHE|QUOCTICH|HINHTHUC_TTHI|KIEU_HD|GOI_KT|DONVI_QL|KIEU_LD|NHACC_CU|CONGNGHE|HINHTHUC_CM|THOIHAN|LOAI_CSHT|DOITAC|LOAI_IP|PHANLOAI_DV'}).then(
        (response) => {
          cacheDM.dispatch('addToCache', { key: 'post_lay_danhmuc_lapmoi_tt_chung_v8', subkey: 'v8', data: response })
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            this.listbox.trangbi.list = response.data.data['trangbi']
            if (this.listbox.trangbi.list && this.listbox.trangbi.list.length > 0) {
              this.listbox.trangbi.valuetsl = this.listbox.trangbi.list[0].trangbi_id
              this.listbox.trangbi.valuecd = this.listbox.trangbi.list[0].trangbi_id
              this.listbox.trangbi.valueims = this.listbox.trangbi.list[0].trangbi_id
              this.listbox.trangbi.valueadsl = this.listbox.trangbi.list[0].trangbi_id
              this.listbox.trangbi.valuedd = this.listbox.trangbi.list[0].trangbi_id
              this.listbox.trangbi.valuegp = this.listbox.trangbi.list[0].trangbi_id
            }
            this.listbox.loai_tb.list = response.data.data['loai_tb']
            this.listbox.loai_tb.listmgwan = response.data.data['loai_tb']
            this.listbox.chu_quan.list = response.data.data['chu_quan']
            if (this.listbox.chu_quan.list && this.listbox.chu_quan.list.length > 0) {
              this.listbox.chu_quan.valueldcd = this.listbox.chu_quan.list[0].chuquan_id
              this.listbox.chu_quan.valuecd = this.listbox.chu_quan.list[0].chuquan_id
              this.listbox.chu_quan.valuewan = this.listbox.chu_quan.list[0].chuquan_id
              this.listbox.chu_quan.valueldmgwan = this.listbox.chu_quan.list[0].chuquan_id
              this.listbox.chu_quan.valueadsl = this.listbox.chu_quan.list[0].chuquan_id
              this.listbox.chu_quan.valueldadsl = this.listbox.chu_quan.list[0].chuquan_id
              this.listbox.chu_quan.valuetsl = this.listbox.chu_quan.list[0].chuquan_id
              this.listbox.chu_quan.valueims = this.listbox.chu_quan.list[0].chuquan_id
              this.listbox.chu_quan.valueldims = this.listbox.chu_quan.list[0].chuquan_id
            }
            this.listbox.tien_km.list = response.data.data['tien_km']
            this.ds_tien_khoanmuc = JSON.parse(JSON.stringify(this.listbox.tien_km.list))
            this.listbox.doituong.list = response.data.data['doituong']
            if (this.listbox.doituong.list && this.listbox.doituong.list.length > 0) this.listbox.doituong.value = this.listbox.doituong.list && this.listbox.doituong.list[0] ? this.listbox.doituong.list[0].doituong_id : 0
            this.listbox.dichvu_vt.list = response.data.data['dichvu_vt']
            this.listbox.loaihinh_tb.list = response.data.data['loaihinh_tb']
            this.listbox.loai_khl.list = response.data.data['loai_khl']
            // this.dtPhanLoaiKH = this.listbox.loai_khl.list.filter(x=>x.nhom_pl=='1');
            this.listbox.loai_gt.list = response.data.data['loai_gt']
            if (this.listbox.loai_gt.list && this.listbox.loai_gt.list.length > 0) this.listbox.loai_gt.value = this.listbox.loai_gt.list[0].loaigt_id
            this.listbox.phanloai_kh.list = response.data.data['phanloai_kh']
            this.dtPhanLoaiKH = this.listbox.phanloai_kh.list //.filter(x=>x.phanloai_kh==1) // tam bo de check
            this.listbox.loai_kh.list = response.data.data['loai_kh']
            if (!this.listbox.loai_kh.value) this.listbox.loai_kh.value = -1
            this.listbox.nganhang.list = response.data.data['nganhang']
            this.listbox.hinhthuc_tt.list = response.data.data['hinhthuc_tt']
            if (this.listbox.hinhthuc_tt.list && this.listbox.hinhthuc_tt.list.length > 0) this.listbox.hinhthuc_tt.value = this.listbox.hinhthuc_tt.list[0].httt_id
            this.listbox.hinhthuc_tc.list = response.data.data['hinhthuc_tc']
            if (this.listbox.hinhthuc_tc.list && this.listbox.hinhthuc_tc.list.length > 0) {
              this.listbox.hinhthuc_tc.value = this.listbox.hinhthuc_tc.list[0].httc_id
              this.listbox.hinhthuc_tc.valueims = 2 //Default 2 do o day filter chi co gia tri 2 hoac 3//this.listbox.hinhthuc_tc.list[0].httc_id;
            }
            this.listbox.dantoc.list = response.data.data['dantoc']
            if (this.listbox.dantoc.list && this.listbox.dantoc.list.length > 0) this.listbox.dantoc.value = this.listbox.dantoc.list[0].dantoc_id
            this.listbox.nganhnghe.list = response.data.data['nganhnghe']
            if (this.listbox.nganhnghe.list && this.listbox.nganhnghe.list.length > 0) this.listbox.nganhnghe.value = this.listbox.nganhnghe.list[0].nganhnghe_id
            this.listbox.quoctich.list = response.data.data['quoctich']
            if (this.listbox.quoctich.list && this.listbox.quoctich.list.length > 0) this.listbox.quoctich.value = this.listbox.quoctich.list[0].quoctich_id
            this.listbox.hinhthuc_tthi.list = response.data.data['hinhthuc_tthi']
            if (this.listbox.hinhthuc_tthi.list && this.listbox.hinhthuc_tthi.list.length > 0) this.listbox.hinhthuc_tthi.value = this.listbox.hinhthuc_tthi.list[0].httthi_id == 0 ? this.listbox.hinhthuc_tthi.list[1].httthi_id : this.listbox.hinhthuc_tthi.list[0].httthi_id
            this.listbox.kieu_hd.list = response.data.data['kieu_hd']
            if (this.listbox.kieu_hd.list && this.listbox.kieu_hd.list.length > 0) this.listbox.kieu_hd.value = this.listbox.kieu_hd.list[0].kieuhd_id
            this.listbox.goi_kt.list = response.data.data['goi_kt']
            this.listbox.donvi_ql.list = response.data.data['donvi_ql']
            if (this.listbox.donvi_ql.list && this.listbox.donvi_ql.list.filter((dv) => dv.loaidv_id == 3).length > 0) this.listbox.donvi_ql.value = this.listbox.donvi_ql.list.filter((dv) => dv.loaidv_id == 3)[0].donvi_id
            if (this.listbox.donvi_ql.list && this.listbox.donvi_ql.list.filter((dv) => dv.loaidv_id == 2).length > 0) this.listbox.donvi_ql.valueql = this.listbox.donvi_ql.list.filter((dv) => dv.loaidv_id == 2)[0].donvi_id
            this.listbox.kieu_ld.list = response.data.data['kieu_ld']
            this.listbox.nhacc_cu.list = response.data.data['nhacc_cu']
            this.listbox.congnghe.list = response.data.data['congnghe']
            this.defaultCongNghe(this.listbox.kieu_ld.value)
            this.listbox.hinhthuc_cm.list = response.data.data['hinhthuc_cm']
            this.listbox.thoihan.list = response.data.data['thoihan']
            if (this.listbox.thoihan.list && this.listbox.thoihan.list.length > 0) {
              this.listbox.thoihan.valuecd = this.listbox.thoihan.list[0].thoihan_id
              this.listbox.thoihan.value = this.listbox.thoihan.list[0].thoihan_id
              this.listbox.thoihan.valuetsl = this.listbox.thoihan.list[0].thoihan_id
              this.listbox.thoihan.valuewan = this.listbox.thoihan.list[0].thoihan_id
              this.listbox.thoihan.valueadsl = this.listbox.thoihan.list[0].thoihan_id
              this.listbox.thoihan.valueims = this.listbox.thoihan.list[0].thoihan_id
            }
            this.listbox.loai_csht.list = response.data.data['loai_csht']
            if (this.listbox.loai_csht.list && this.listbox.loai_csht.list.length > 0) {
              this.listbox.loai_csht.value = this.listbox.loai_csht.list[0].loai_csht_id
            }
            this.listbox.cboLoai_CSHT.list = response.data.data['loai_csht']
            if (this.listbox.cboLoai_CSHT.list && this.listbox.cboLoai_CSHT.list.length > 0) {
              this.listbox.cboLoai_CSHT.value = this.listbox.cboLoai_CSHT.list[0].loai_csht_id
            }
            this.listbox.doitac.list = response.data.data['doitac']
            if (this.listbox.doitac.list && this.listbox.doitac.list.length > 0) {
              this.listbox.doitac.valuecsht = this.listbox.doitac.list[0].doitac_id
              this.listbox.doitac.valueims = this.listbox.doitac.list[0].doitac_id
            }
            this.listbox.cboDoiTac_CSHT.list = response.data.data['doitac']
            if (this.listbox.cboDoiTac_CSHT.list && this.listbox.cboDoiTac_CSHT.list.length > 0) {
              this.listbox.cboDoiTac_CSHT.value = this.listbox.cboDoiTac_CSHT.list[0].doitac_id
            }
            this.listbox.cboLoaiIP.list = response.data.data['loaiip']
            this.listbox.cboLoaiIP.orilist = response.data.data['loaiip']
            // if(this.listbox.cboLoaiIP.list && this.listbox.cboLoaiIP.list.length>0) {
            //   this.listbox.cboLoaiIP.value = this.listbox.cboLoaiIP.list[0].loaiip_id;
            //   this.listbox.cboLoaiIP.values = [this.listbox.cboLoaiIP.list[0].loaiip_id];
            //   this.listbox.cboLoaiIP.valueitems = [this.listbox.cboLoaiIP.list[0]].map(lo=>({id:lo.loaiip_id,text:lo.loai_ip}));
            // }
            this.listbox.phanloai_dv.list = response.data.data['phanloai_dv']
          }
        }
      )
      let api2 = API.post_lay_ds_nganhnghe(this.axios, { vma: 'NGANHNGHE' }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.nganhngheloc.list = response.data.data
          if (this.listbox.nganhngheloc.list && this.listbox.nganhngheloc.list.length > 0) this.listbox.nganhngheloc.value = this.listbox.nganhngheloc.list[0].nganhnghe_id
        }
      })
      let api3 = API.post_sp_ht_chitietdv_ims(this.axios, { kieu: '1' }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.ht_chitietdv_ims.list = response.data.data
          if (this.listbox.ht_chitietdv_ims.list && this.listbox.ht_chitietdv_ims.list.length > 0) this.listbox.ht_chitietdv_ims.value = this.listbox.ht_chitietdv_ims.list[0].ctdv_id
        }
      })
      let api4 = API.post_sp_ht_phantach_tocdo(this.axios, { kieu: '1' }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.ht_phantach_tocdo.list = response.data.data
          if (this.listbox.ht_phantach_tocdo.list && this.listbox.ht_phantach_tocdo.list.length > 0) this.listbox.ht_phantach_tocdo.value = this.listbox.ht_phantach_tocdo.list[0].phantach_id
        }
      })
      let api5 = API.post_lay_thamso_macdinh(this.axios, { vma_ts: 'CHUQUAN_ID' }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.thamso_nguoidung.chuquanmd_id = response.data.data
        }
      })
      let api6 = API.post_lay_thamso_md(this.axios, { kieu_id: -1 })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            this.thamsomacdinh = response.data.data.reduce(function(result, item, index, array) {
              result[item['ma_ts']] = item['ten_ts'] //a, b, c
              return result
            }, {}) //.map(x => ({ [x['ma_ts']]:x['ten_ts'] }));
            this.TUDONG_SINH_SOAO = this.thamsomacdinh['TUDONG_SINH_SOAO'] ? true : false
            if (this.thamsomacdinh['SINH_MA_GD_THEO_DV']) this.ts_sinhma_gd_theo_donvi = true
            if (this.thamsomacdinh['PHANTAP_KH'] && this.thamsomacdinh['PHANTAP_KH'] == 1) this.PHANTAP_KH = 1
            if (this.thamsomacdinh['DONVIQL_HTTT'] && this.thamsomacdinh['DONVIQL_HTTT'] == 1) this.DONVIQL_HTTT = 1
            if (this.thamsomacdinh['CHONSO_MOI'] && this.thamsomacdinh['CHONSO_MOI'].length > 0) this.CHONSO_MOI = true
            if (this.thamsomacdinh['CHONSO_MOI_V2'] && this.thamsomacdinh['CHONSO_MOI_V2'].length > 0) this.CHONSO_MOI_V2 = true
            if (this.thamsomacdinh['KHUVUC_THEO_KETCUOI'] && this.thamsomacdinh['KHUVUC_THEO_KETCUOI'] == 1) this.KHUVUC_THEO_KETCUOI = 1
            if (this.thamsomacdinh['THEM_TT_HDKHDN'] && this.thamsomacdinh['THEM_TT_HDKHDN'] == 1) this.ts_kt_tthdkhdn = 1
            if (this.thamsomacdinh['INDEX_LOAI_KH']) this.listbox.loai_kh.value = this.thamsomacdinh['INDEX_LOAI_KH']
            this.PHAINHAP_VRF = this.thamsomacdinh['PHAINHAP_VRF'] && this.thamsomacdinh['PHAINHAP_VRF'] == 1
            if (this.thamsomacdinh['HT_LOC_CBO_TRAM']) this.ht_loc_cbo_tram = this.thamsomacdinh['HT_LOC_CBO_TRAM'] == 1
            //TODO cai tham so mac dinh nay de gan gia tri dieu khien. Thay doi logic de xu ly sau cho gon code.
          } else {
            this.$toast.error('LỖI: Không lấy được tham số mặc định của chức năng. Vui lòng F5 lại form hoặc logout / login lại.')
          }
        })
        .catch(() => {
          this.$toast.error('LỖI: Không lấy được tham số mặc định của chức năng. Vui lòng F5 lại form hoặc logout / login lại.')
        })
      //TODO HT_DS_KhuyenMai_Combobox(); Khong can goi o day vi cac tham so can thiet de tinh toan ham nay chua load o giai doan nay.
      let api7 = API.post_lay_ds_dvk_macdinh(this.axios, { vloaiid: 2, vloaitb_id: 0 }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          //day la lay tu ham LAY_DS_DVK_TT_MACDINH, trong ham nay sau khi dua du lieu ra datarow (DANGKY_DVKRow) thi goi tiep 1 ham khac: HT_DichVuKhac de hien thi ra Listbox lvDvkhac
          this.dsDK_DVK_TT = response.data.data.map((x) => ({ DVKHAC_ID: x['dvkhac_id'], TEN_DVKHAC: x['ten_dvkhac'], KIEU_YC: x['caidat_md'], LOAIID: x['loaiid'], TTTH: 0, HD_ID: this.hdtb_id, NGAY_YC: this.NgayYeuCau }))
          this.HT_DichVuKhac(this.dsDK_DVK_TT, 2)
          /*
                              for (int i = 0; i < dset.Tables[0].Rows.Count; i++)
                              {
                                  DataSet ds = bangts.TTCT_DichVuKhac(Convert.ToInt32(dset.Tables[0].Rows[i]["dvkhac_id"]));
                                  str = ds[0]["ten_dvkhac"];
                                  lvDvkhac.Items.Add(str);
                              }
                              */
          //this.thamsomacdinh = response.data.data.map(x => ({ [x['ma_ts']]:x['ten_ts'] }));
        }
      })
      let api8 = API.post_lay_ds_dl_nghiepvu(this.axios, { p_ds_para: null, p_nghiepvu: 'HT_TRANGTHAI_YC' }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.listbox.trangthai_yc.list = response.data.data
          if (this.listbox.trangthai_yc.list && this.listbox.trangthai_yc.list.length > 0) this.listbox.trangthai_yc.value = this.listbox.trangthai_yc.list[0].trangthaiyc_id
        }
      })
      let api9 = API.post_get_app_config(this.axios, { keyname: 'DONGBO_TEST' }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.DONGBO_TEST.TEST = !((response.data.data.keyvalue + '').toLowerCase() == 'false' && response.data.data.dongbo == 1)
        }
      })
      let api10 = API.get_loai_tbi_lhtb(this.axios, {}).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.dskmtt_loaitbi = response.data.data
          if (this.dskmtt_loaitbi && this.dskmtt_loaitbi.length > 0) for (var item of this.dskmtt_loaitbi) item['khoanmuctt_id'] = item['khoanmuctt_id'] ? item['khoanmuctt_id'] : null
        }
      })
      //TODO LINE 1546 - 1625
      // let api11 = API.get_fn_kiemtra_co_thuoc_vnpt_i_khong(this.axios, {})
      //   .then((response) => {
      //     if (response && response.data && response.data.data && response.data.data == 'OK' && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //       this.is_nv_vnpti = true
      //     } else this.is_nv_vnpti = false
      //   })
      //   .catch(() => {
      //     this.is_nv_vnpti = false
      //   })
      // if (tdan.GET_VALUE_FUNC("{?DB2}.fn_kiemtra_co_thuoc_vnpt_i_khong", "vnhanvien_id", tt_nd.nhanvien_id).ToString() == "OK")
      //               is_nv_vnpti = true;
      // #region Tham so khac
      let str = ''
      if (!this.Tag) {
        if (this.$route.query.tag && this.$route.query.tag.trim() != '') this.Tag = this.$route.query.tag
        else if (this.itag && this.itag.trim() != '') this.Tag = this.itag
      }
      if (this.Tag) {
        str = this.Tag
        let words = str.split('+')
        if (words.length >= 1) this.iKieu = words[0]
        if (words.length >= 2) {
          this.iKenhTN = words[1]
        }

        if (words.length >= 3) {
          this._fiberBoSung = words[2]
        }
      } else {
        this.iKieu = 0
      }
      if (this.iKieu == 1) {
        this.header.title = 'SỬA KM ĐẶT MỚI'
      } else {
        this.header.title = 'LẮP ĐẶT MỚI'
      }
      // visibleToolStripMenuAndControl(iKieu == 0);
      // hoangpkn : 06/10/2016 Không cho chọn kiểu trả trước với Mytv
      //cboKieuTra.Enabled = false; //FIXME chua xu ly
      // end hoang
      //cboTocDo_PIR.Enabled = false; //FIXME chua xu ly
      // TODO lam sau, chua xu ly!
      // if (ht_khl == 1)
      // {
      //     lblKHL.Visible = true;
      //     cboKhachHangLon.Visible = true;
      //     lblPhanLoaiKH.Visible = false;
      //     txtPhanLoaiKH.Visible = false;
      // }
      // else
      // {
      //     lblKHL.Visible = false;
      //     cboKhachHangLon.Visible = false;
      //     lblPhanLoaiKH.Visible = true;
      //     txtPhanLoaiKH.Visible = true;
      // }
      // txtMaTT.ContextMenu = new ContextMenu();

      //FIXME IMPORTANT load mac dinh thong tin ctv
      if (this.thamsomacdinh['MACDINH_CTV_NGUOIDUNG'] == 1) {
        // await API.post_lay_ds_thamso_md(this.axios, {
        //   list_of_cols: '*',
        //   order: '',
        //   schema: 'admin',
        //   table_name: 'nhanvien',
        //   where: 'nhanvien_id = ' + this.$root.token.getNhanVienID()
        // }).then((response) => {
        await API.post_sp_tt_nhanvien(this.axios, { p_type: 3, p_param: this.$root.token.getNhanVienID() }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            this.filterbox.ctv.value = response.data.data[0].ten_nv
            this.filterbox.ctv.ma_ctv = response.data.data[0].nhanvien_id//nhanvien_id //ma_nv la ma text
            this.ctv_id = this.$root.token.getNhanVienID()
            this.filterbox.ctv.ischecked = true
          }
        })

        //     CheckDataFacade checkdata = new CheckDataFacade();
        //     ctv_id = tt_nd.nhanvien_id;
        //     ma_ctv = tt_nd.ma_nv;
        //     donvi_ctv_id = tt_nd.donvi_id;
        //txtCTV.Text = checkdata.MAP_ID("ten_nv", DatabaseConstants.DB1 + ".nhanvien", "where nhanvien_id =" + ctv_id);
        //     form_load = true;
        //     chkCTV.Checked = true;//Làm thế này để ko bật form chọn ctv khi load lúc đầu
        //     form_load = false;
      }

      //TODO neu matinh == 'HNI' thi bat nut btnSite_ID
      // if (matinh == "HNI")
      //     btnSite_ID.Visible = true;
      // // #endregion

      // Form Shown event
      this.listbox.trangbi.valuecd = TRANGBI.KHACHHANG_TU_TRANGBI
      this.listbox.trangbi.valueims = TRANGBI.KHACHHANG_TU_TRANGBI
      this.listbox.trangbi.valueadsl = TRANGBI.KHACHHANG_TU_TRANGBI


      var api12 = this.LAY_DS_DVGT_MACDINH(this.listbox.loaihinh_tb.value)
      var api13 = this.LAY_DS_DVK_MACDINH_TB(this.listbox.loaihinh_tb.value)
      // TODO chua xu ly do muc dich phan nay chua ro rang
      // if (!chuanhoa_cntt && !chuanhoa_ca)
      //   cboDichVuVT_SelectedValueChanged(cboDichVuVT, null);
      this.kt_load = false
      await Promise.all([api1, api2, api3, api4, api5, api6, api7, api8, api9, api10, api12, api13])
        .then(async () => {
          if(this.thamso_nguoidung.chuquanmd_id) {
            this.listbox.chu_quan.valuecd = this.thamso_nguoidung.chuquanmd_id
            this.listbox.chu_quan.valuedlcd = this.thamso_nguoidung.chuquanmd_id
          }
          await this.HT_GIAODIEN_DONVI()
          await this.LayTienTheoKhoanMuc()
        })
        .catch(() => {})
        .then(async () => {
          await this.HT_GIAODIEN_DONVI()
          await this.LayTienTheoKhoanMuc()
        })
        .finally(() => {})
        .then(async () => {
          await delay(1000);
          this.loading(false)
          this.watcherActive = true
          // let oridata = Object.assign({}, this.$data);
          // this.originalData = oridata;
          if (this.$route.query.makh && this.$route.query.makh.trim() != '') {
            this.khachhang.makh = this.$route.query.makh //https://onebss-dev.vnptit3.vn/#/contract/installnewsubs?makh=HPG-001162767
            this.MaKHChanged()
          }
          if (this.$route.query.magd && this.$route.query.magd.trim() != '') {
            this.khachhang.magd = this.$route.query.magd //https://onebss-dev.vnptit3.vn/#/contract/installnewsubs?magd=HPG-LD%2F00736701
            this.MaGDChanged()
          }
        })
    },
    async LoadTuHopDongTuVan(phdkh_cha_id) {
      this.IS_HD_TUVAN = true
      try {
        this.buttonSet = 1
        await API.post_sp_lay_thongtin_hdkh_tuvan(this.axios, { hdkh_cha_id: phdkh_cha_id, kieu: 1 }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] == 1) {
              this.hdkh_cha_id = phdkh_cha_id
              apidata = apidata['RESULT']
              if (apidata['KHACHHANG_ID'] && apidata['KHACHHANG_ID'] > 0) {
                this.khachhang.khachhang_id = apidata['KHACHHANG_ID']
                this.khachhang.makh = apidata['MA_KH']
                let e = { target: { value: apidata['MA_KH'] } }
                this.MaKHChanged(e)
              } else {
                if (apidata['TEN_KH']) {
                  this.khachhang.tenkh = apidata['TEN_KH']
                  this.thanhtoan.tentt = apidata['TEN_KH']
                  this.thuebao.tentb = apidata['TEN_KH']
                }
                this.watcherActive = false
                if (apidata['DIACHI_KH']) {
                  this.diachiKH.DIACHI = apidata['DIACHI_KH']
                  this.diachiTT.DIACHI = apidata['DIACHI_KH']
                  this.diachiTB.DIACHI = apidata['DIACHI_KH']
                  this.diachiLD.DIACHI = apidata['DIACHI_KH']
                }
                if (apidata['TINH_ID']) {
                  this.diachiKH.TINH_ID = apidata['TINH_ID']
                  this.diachiTT.TINH_ID = apidata['TINH_ID']
                  this.diachiTB.TINH_ID = apidata['TINH_ID']
                  this.diachiLD.TINH_ID = apidata['TINH_ID']
                }
                if (apidata['QUAN_ID']) {
                  this.diachiKH.QUAN_ID = apidata['QUAN_ID']
                  this.diachiTT.QUAN_ID = apidata['QUAN_ID']
                  this.diachiTB.QUAN_ID = apidata['QUAN_ID']
                  this.diachiLD.QUAN_ID = apidata['QUAN_ID']
                }
                if (apidata['PHUONG_ID']) {
                  this.diachiKH.PHUONG_ID = apidata['PHUONG_ID']
                  this.diachiTT.PHUONG_ID = apidata['PHUONG_ID']
                  this.diachiTB.PHUONG_ID = apidata['PHUONG_ID']
                  this.diachiLD.PHUONG_ID = apidata['PHUONG_ID']
                }
                //this.watcherActive = true
                if (apidata['PHO_ID']) {
                  this.diachiKH.PHO_ID = apidata['PHO_ID']
                  this.diachiTT.PHO_ID = apidata['PHO_ID']
                  this.diachiTB.PHO_ID = apidata['PHO_ID']
                  this.diachiLD.PHO_ID = apidata['PHO_ID']
                }
                if (apidata['KHU_ID']) {
                  this.diachiKH.KHU_ID = apidata['KHU_ID']
                  this.diachiTT.KHU_ID = apidata['KHU_ID']
                  this.diachiTB.KHU_ID = apidata['KHU_ID']
                  this.diachiLD.KHU_ID = apidata['KHU_ID']
                }
                if (apidata['AP_ID']) {
                  this.diachiKH.AP_ID = apidata['AP_ID']
                  this.diachiTT.AP_ID = apidata['AP_ID']
                  this.diachiTB.AP_ID = apidata['AP_ID']
                  this.diachiLD.AP_ID = apidata['AP_ID']
                }
                if (apidata['SONHA']) {
                  this.diachiKH.SONHA = apidata['SONHA']
                  this.diachiTT.SONHA = apidata['SONHA']
                  this.diachiTB.SONHA = apidata['SONHA']
                  this.diachiLD.SONHA = apidata['SONHA']
                }
                if (apidata['BLOCK']) {
                  this.diachiKH.BLOCK = apidata['BLOCK']
                  this.diachiTT.BLOCK = apidata['BLOCK']
                  this.diachiTB.BLOCK = apidata['BLOCK']
                  this.diachiLD.BLOCK = apidata['BLOCK']
                }
                if (apidata['TANG']) {
                  this.diachiKH.TANG = apidata['TANG']
                  this.diachiTT.TANG = apidata['TANG']
                  this.diachiTB.TANG = apidata['TANG']
                  this.diachiLD.TANG = apidata['TANG']
                }
                if (apidata['PHONG']) {
                  this.diachiKH.PHONG = apidata['PHONG']
                  this.diachiTT.PHONG = apidata['PHONG']
                  this.diachiTB.PHONG = apidata['PHONG']
                  this.diachiLD.PHONG = apidata['PHONG']
                }
                if (apidata['MOTA']) {
                  this.diachiKH.MOTA = apidata['MOTA']
                  this.diachiTT.MOTA = apidata['MOTA']
                  this.diachiTB.MOTA = apidata['MOTA']
                  this.diachiLD.MOTA = apidata['MOTA']
                }
                if (apidata['VIDO']) {
                  this.diachiKH.Lat = apidata['VIDO']
                  this.diachiTT.Lat = apidata['VIDO']
                  this.diachiTB.Lat = apidata['VIDO']
                  this.diachiLD.Lat = apidata['VIDO']
                }
                if (apidata['KINHDO']) {
                  this.diachiKH.Lng = apidata['KINHDO']
                  this.diachiTT.Lng = apidata['KINHDO']
                  this.diachiTB.Lng = apidata['KINHDO']
                  this.diachiLD.Lng = apidata['KINHDO']
                }


                if (ds[0]['DIENTICH']) this.diachiLD.DIENTICH = ds[0]['DIENTICH']
                if (ds[0]['SOTANG']) this.diachiLD.SOTANG = ds[0]['SOTANG']
                if (ds[0]['SOPHONG']) this.diachiLD.SOPHONG = ds[0]['SOPHONG']
                if (ds[0]['LOAINHA_ID']) this.diachiLD.LOAINHA_ID = ds[0]['LOAINHA_ID']

                if (apidata['SO_DT']) {
                  this.khachhang.dienthoai = apidata['SO_DT']
                }
                if (apidata['LOAIGT_ID']) this.listbox.loai_gt.value = apidata['LOAIGT_ID']
                if (apidata['SO_GT']) this.khachhang.sogt = apidata['SO_GT']
                if (apidata['NGAYCAP']) this.NgayCap = moment(apidata['NGAYCAP']).format(this.dateFormat)
                if (apidata['NOICAP']) this.khachhang.noicap = apidata['NOICAP']
              }
            } else this.$toast.error(apidata['MESSAGE'])
          }
        })
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async LoadTuHopDongTuVan_v2(phdkh_cha_id, vdichvuvt_id, vloaitb_id) {
      if (vdichvuvt_id) this.listbox.dichvu_vt.value = vdichvuvt_id
      if (vloaitb_id) this.listbox.loaihinh_tb.value = vloaitb_id
      await this.LoadTuHopDongTuVan(phdkh_cha_id)
    },
    cboLoaiSoWan_SelectedValueChanged(item) {
      if (!item || item <= 0) return
      this.thuebao.hdtb_id_cha = 0
      this.thuebao.thuebao_id_cha = 0
      this.thuebao.mgwan.huongkn = ''
      this.thuebao.mgwan.vhuongkn = ''
      this.listbox.tinh_kn.value = 0
      this.listbox.tinh_kn.value = this.$root.token.getPhanVungID()
      this.diachiKN = this.$options.data.call(this).diachiKN
      this.buttons.btnHuongKNWan = item * 1 == LOAINODE_MGWAN.NODE_CHINH
    },
    async LayMaTB(themmoi) {
      this.ma_tb_ao_ht = ''
      let _loaitb_id = this.listbox.loaihinh_tb.value
      switch (this.listbox.dichvu_vt.value * 1) {
        case DichVuVienThong.CO_DINH:
          this.ma_tb_ht = this.thuebao.codinh.somay
          break
        case DichVuVienThong.DI_DONG:
          this.ma_tb_ht = this.thuebao.didong.txtSoMayDD ? this.thuebao.didong.txtSoMayDD.trim() : this.thuebao.didong.txtSoMayDD
          break
        case DichVuVienThong.MEGA_EYES:
          this.ma_tb_ht = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.trim() : this.thuebao.adsl.txtAccountADSL //this.thuebao.adsl.txtSoAoAdsl?this.thuebao.adsl.txtSoAoAdsl.trim():this.thuebao.adsl.txtSoAoAdsl;
          if (this.TUDONG_SINH_SOAO && themmoi) {
            await API.post_sinh_malt(this.axios, {
              vdichvuvt_id: DichVuVienThong.MEGA_EYES,
              vloaitb_id: _loaitb_id,
              vquan_id: this.diachiLD.QUAN_ID,
              vtentat: this.$root.token.getMaTinh()
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.ma_tb_ao_ht = response.data.data
                this.thuebao.adsl.txtSoAoAdsl = this.ma_tb_ao_ht
              }
            })
          } else this.ma_tb_ao_ht = this.thuebao.adsl.txtSoAoAdsl ? this.thuebao.adsl.txtSoAoAdsl.trim() : this.thuebao.adsl.txtSoAoAdsl
          break
        case DichVuVienThong.DICHVU_CNTT:
        case DichVuVienThong.ANTOAN_BAOMAT_TT:
        case DichVuVienThong.TRUNGTAM_DULIEU:
        case DichVuVienThong.HOINGHI_TRUYENHINH:
          for (var index = 0; index < this.gridEditors.length; ++index) {
            if (this.gridEditors[index].ID == 'MA_TB') {
              this.ma_tb_ht = this.gridEditors[index].Value
              break
            }
          }
          break
        case DichVuVienThong.ADSL:
        case DichVuVienThong.HATANG_VIENTHONG:
        case DichVuVienThong.BRCD_DOITAC:
          if ((_loaitb_id == LoaiHinhTB.INTERNET_MYTV || _loaitb_id == LoaiHinhTB.INTERNET_MYTV_B2B) && this.thamsomacdinh['MYTV_HOA'] == 1) {
            this.thuebao.adsl.txtAccountADSL = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.toUpperCase() : this.thuebao.adsl.txtAccountADSL
          }
          this.ma_tb_ht = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.trim() : this.thuebao.adsl.txtAccountADSL
          if (this.TUDONG_SINH_SOAO && themmoi) {
            await API.post_sinh_malt(this.axios, {
              vdichvuvt_id: DichVuVienThong.ADSL,
              vloaitb_id: _loaitb_id,
              vquan_id: this.diachiLD.QUAN_ID,
              vtentat: this.$root.token.getMaTinh()
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.ma_tb_ao_ht = response.data.data
                this.thuebao.adsl.txtSoAoAdsl = this.ma_tb_ao_ht
              }
            })
          } else this.ma_tb_ao_ht = this.thuebao.adsl.txtSoAoAdsl ? this.thuebao.adsl.txtSoAoAdsl.trim() : this.thuebao.adsl.txtSoAoAdsl
          if(themmoi && this.listbox.dichvu_vt.value==DichVuVienThong.ADSL) {
            // this.$toast.error("Đã loại bỏ khoảng trắng khỏi mã thuê bao / Account.");
            // this.$toast.error("Account không được phép chứa khoảng trắng")
            if((this.ma_tb_ht+'').indexOf(' ')>=0)
              throw "Mã thuê bao / Account không được chứa khoảng trắng!"
            if(!(/^[a-zA-Z0-9-_\.]+$/.test(this.ma_tb_ht+'')))
              throw "Mã thuê bao / Account không hợp lệ! Chỉ được chứa các ký tự A-Za-z0-9 và các dấu -_. "
            // this.ma_tb_ao_ht = this.ma_tb_ao_ht.replace(/\s/g, "");
            // this.thuebao.adsl.txtSoAoAdsl = this.thuebao.adsl.txtSoAoAdsl.replace(/\s/g, "");
          }
          break
        case DichVuVienThong.MEGAWAN:
        case DichVuVienThong.METRONET:
        case DichVuVienThong.MGW_DOITAC:
        case DichVuVienThong.NOIBO_DADIEM:
          this.ma_tb_ht = this.thuebao.mgwan.somay
          if (this.TUDONG_SINH_SOAO && themmoi) {
            await API.post_sinh_malt(this.axios, {
              vdichvuvt_id: this.listbox.dichvu_vt.value,
              vloaitb_id: _loaitb_id,
              vquan_id: this.diachiLD.QUAN_ID,
              vtentat: this.$root.token.getMaTinh()
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.ma_tb_ao_ht = response.data.data
                this.thuebao.mgwan.soao = response.data.data
              }
            })
          } else this.ma_tb_ao_ht = this.thuebao.mgwan.soao
          break
        case DichVuVienThong.TSL:
        case DichVuVienThong.TSL_DOITAC:
        case DichVuVienThong.NOIBO_2DIEM:
          if (!this.thuebao.tsl.txtMaTSL.Text) await this.SinhMaDVVT() //FIXME them de xu ly truong hop vi ly do nao do khong co du lieu matsl
          this.ma_tb_ht = this.thuebao.tsl.txtMaTSL.Text ? this.thuebao.tsl.txtMaTSL.Text.trim() : this.thuebao.tsl.txtMaTSL.Text
          if (this.TUDONG_SINH_SOAO && themmoi) {
            await API.post_sinh_malt(this.axios, {
              vdichvuvt_id: (this.listbox.dichvu_vt.value==DichVuVienThong.NOIBO_2DIEM?DichVuVienThong.NOIBO_2DIEM:DichVuVienThong.TSL),
              vloaitb_id: _loaitb_id,
              vquan_id: this.diachiDau.QUAN_ID,
              vtentat: this.$root.token.getMaTinh()
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.ma_tb_ao_ht = response.data.data
                this.thuebao.tsl.txtSoAoTSL_Dau = this.ma_tb_ao_ht
              }
            })

            await API.post_sinh_malt(this.axios, {
              vdichvuvt_id: (this.listbox.dichvu_vt.value==DichVuVienThong.NOIBO_2DIEM?DichVuVienThong.NOIBO_2DIEM:DichVuVienThong.TSL),
              vloaitb_id: _loaitb_id,
              vquan_id: this.diachiCuoi.QUAN_ID,
              vtentat: this.$root.token.getMaTinh()
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.ma_tb_ao_ht_cuoi = response.data.data
                this.thuebao.tsl.txtSoAoTSL_Cuoi = this.ma_tb_ao_ht_cuoi
              }
            })
          } else {
            this.ma_tb_ao_ht = this.thuebao.tsl.txtSoAoTSL_Dau ? this.thuebao.tsl.txtSoAoTSL_Dau.trim() : this.thuebao.tsl.txtSoAoTSL_Dau
            this.ma_tb_ao_ht_cuoi = this.thuebao.tsl.txtSoAoTSL_Cuoi ? this.thuebao.tsl.txtSoAoTSL_Cuoi.trim() : this.thuebao.tsl.txtSoAoTSL_Cuoi
          }
          break
        case DichVuVienThong.GPHONE:
          this.ma_tb_ht = this.thuebao.gphone.txtSoMayGP ? this.thuebao.gphone.txtSoMayGP.trim() : this.thuebao.gphone.txtSoMayGP
          break
        case DichVuVienThong.IMS:
        case DichVuVienThong.IMS_DOITAC:
          this.ma_tb_ht = this.thuebao.ims.txtMaTBIMS ? this.thuebao.ims.txtMaTBIMS.trim() : this.thuebao.ims.txtMaTBIMS
          break
        case 50:
          for (var index = 0; index < this.gridEditors.length; ++index) {
            if (this.gridEditors[index].ID == 'MA_TB') {
              this.ma_tb_ht = this.gridEditors[index].Value
              break
            }
          }
          break
      }
    },
    async SinhMaDVVT(force) {
      // if(!this.diachiTT.QUAN_ID || this.diachiTT.QUAN_ID<=0) return;
      let matbsinhtd = ''
      matbsinhtd = await API.post_fn_sinhma_dvvt(this.axios, {
        ds_para: JSON.stringify({
          THEMMOI: force || this.buttonSet == 1,
          QUANTT_ID: this.diachiTT.QUAN_ID ? this.diachiTT.QUAN_ID : 0,
          DICHVUVT_ID: this.listbox.dichvu_vt.value,
          LOAITB_ID: this.listbox.loaihinh_tb.value,
          TS_SINH_MA_TB_5300: this.thamsomacdinh['TS_SINH_MA_TB_5300'] == 1 ? 1 : 0,
          TENTAT: this.$root.token.getMaTinh()
        })
      })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let apidata = JSON.parse(response.data.data)
            if (apidata['RESULT'] && apidata['RESULT']['SINH_MA_TB']) {
              return apidata['RESULT']['SINH_MA_TB']
            } else return ''
          } else return ''
        })
        .catch(() => {
          return ''
        })

      if (!matbsinhtd || matbsinhtd.trim() == '')
        matbsinhtd = await API.post_sinh_matb(this.axios, { vquan_id: 0, vdichvuvt_id: this.listbox.dichvu_vt.value, vloaitb_id: this.listbox.loaihinh_tb.value, tinhthicong_id: 100, vtentat: this.$root.token.getMaTinh() })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return ''
          })
          .catch(() => {
            return ''
          })

      if (!matbsinhtd || matbsinhtd.trim() == '') throw 'Không sinh tự động được mã thuê bao!'

      if (((!this.thuebao.adsl.txtAccountADSL || force) && this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_ANALOG) || this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL) this.thuebao.adsl.txtAccountADSL = matbsinhtd
      switch (this.listbox.dichvu_vt.value * 1) {
        case DichVuVienThong.TSL:
        case  DichVuVienThong.NOIBO_2DIEM:
          // if ((!this.thuebao.tsl.txtMaTSL.Text || force) && matbsinhtd != -1) {
          if (matbsinhtd != -1) {
            this.thuebao.tsl.txtMaTSL.Text = matbsinhtd
            this.thuebao.tsl.txtMaTSL.ReadOnly = true
          } else this.thuebao.tsl.txtMaTSL.ReadOnly = false
          break
        case DichVuVienThong.MEGAWAN:
        case DichVuVienThong.METRONET:
        case DichVuVienThong.NOIBO_DADIEM:
          if (!this.thuebao.mgwan.somay || force) this.thuebao.mgwan.somay = matbsinhtd
          break
        case DichVuVienThong.ADSL:
          this.thuebao.adsl.txtAccountADSL_ReadOnly = false
          if (
            this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV ||
            this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B ||
            this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH ||
            this.listbox.loaihinh_tb.value == LoaiHinhTB.WIFI_MESH ||
            this.listbox.loaihinh_tb.value == LoaiHinhTB.TIVI_SAMSUNG ||
            this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGA_IOT
          ) {
            let strMatb = matbsinhtd
            if (strMatb != -1) {
              // if (!this.thuebao.adsl.txtAccountADSL || force)
              this.thuebao.adsl.txtAccountADSL = strMatb
              this.thuebao.adsl.txtAccountADSL_ReadOnly = true
            } else this.thuebao.adsl.txtAccountADSL_ReadOnly = false
          }
          break
        case DichVuVienThong.HATANG_VIENTHONG:
          this.thuebao.adsl.txtAccountADSL_ReadOnly = false
          let strMatb = matbsinhtd
          if (strMatb != -1) {
            // if (!this.thuebao.adsl.txtAccountADSL || force)
            this.thuebao.adsl.txtAccountADSL = strMatb
            this.thuebao.adsl.txtAccountADSL_ReadOnly = true
          } else this.thuebao.adsl.txtAccountADSL_ReadOnly = false
          break
        case DichVuVienThong.MEGA_EYES:
          this.thuebao.adsl.txtAccountADSL_ReadOnly = false
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INDOOR_CAM || this.listbox.loaihinh_tb.value == LoaiHinhTB.OUTDOOR_CAM) {
            let strMatb = matbsinhtd
            if (strMatb != -1) {
              // if (!this.thuebao.adsl.txtAccountADSL || force)
              this.thuebao.adsl.txtAccountADSL = strMatb
              this.thuebao.adsl.txtAccountADSL_ReadOnly = true
            } else this.thuebao.adsl.txtAccountADSL_ReadOnly = false
          }
          break
      }
    },
    async cboGoiCuocAdsl_SelectedValueChanged(val) {
      if (!val) return
      this.tocdo_id = val
      try {
        this.loading(true)
        // await API.post_tocdo_thuc_adsl_theo_tocdoid(this.axios,{ "id": this.listbox.cboGoiCuocAdsl.value }).then((response) => {
        //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
        //     this.listbox.cboTocDoThucADSL.list = response.data.data;
        //     if(this.listbox.cboTocDoThucADSL.list && this.listbox.cboTocDoThucADSL.list.length>0 && !this.listbox.cboTocDoThucADSL.value)
        //       this.listbox.cboTocDoThucADSL.value = this.listbox.cboTocDoThucADSL.list[0].TOCDO_ID;
        //   }
        // });
        this.listbox.cboTocDoThucADSL.value = this.listbox.cboGoiCuocAdsl.value
      } catch (ex) {
        this.$toast.error('' + ex.statusText)
        if (this.debug) console.error(ex)
      } finally {
        this.loading(false)
      }
      await this.LoadMucCuocTB()
      if (this.thamsomacdinh['MACDINH_VMP'] == 1) {
        this.cbvmp = true
        this.chkVMP_CheckedChanged() // Xu ly thay ham goc o day!
      } else this.cbvmp = false

      if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL && !this.kt_load && this.watcherActive) {
        await API.post_kiemtra_ma_toc_do_doi_tuong_khachhang_ut(this.axios, { vtocdo_id: this.listbox.cboGoiCuocAdsl.value }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            if (response.data.data != 'error') this.listbox.doituong.value = response.data.data * 1
          }
        })
      }

      //HungHM-04/09/2010 Bổ xung 1 tý nghiệp vụ gói cước MyTV
      if (
        [LoaiHinhTB.INTERNET_MYTV, LoaiHinhTB.INTERNET_MYTV_B2B, LoaiHinhTB.INTERNET_MYTV, LoaiHinhTB.INTERNET_SGTV, DichVuVienThong.MEGA_EYES, LoaiHinhTB.MAIL_SMD, LoaiHinhTB.Web_Hosting, LoaiHinhTB.HTVC_FIBERVNN_ANALOG, LoaiHinhTB.HTVC_FIBERVNN_DIGITAL].indexOf(
          this.listbox.loaihinh_tb.value * 1
        ) >= 0
      ) {
        this.listbox.muccuoc.isenabled = false
        this.listbox.muccuoc.value = MUCCUOC.TRON_GOI
        //TuanNA: hiểnthị tiền trả trước của MyTV -- ngày 17.12.2011
        if (this.listbox.cboThangTra.list && this.listbox.cboThangTra.list.length > 0) {
          if (this.listbox.cboKieuTra.value == 1 && (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B)) {
            this.thuebao.adsl.tientra = 0 //txtTienTra.Text = "0"
          }
        }

        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV_B2B) {
          this.HT_DS_DBCHINH_MYTV()
          this.HT_DS_HDCHINH_MYTV()
        }
      } else {
        this.listbox.muccuoc.isenabled = true
        if (this.listbox.muccuoc.list.length > 0) this.listbox.muccuoc.value = this.listbox.muccuoc.list[0].muccuoc_id
      }
      //FIXME doan nay bo qua vi load o mounted cboLoaiIP roi, thay doi co the anh huong logic load. line 25132
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH) {
        // var dt_cuoc_adsl = cboGoiCuocAdsl.Properties.DataSource as DataTable;
        if (this.listbox.cboGoiCuocAdsl.list && this.listbox.cboGoiCuocAdsl.list.length > 0 && this.listbox.cboGoiCuocAdsl.value && this.listbox.cboGoiCuocAdsl.value > 0) {
          var t = this.listbox.cboGoiCuocAdsl.list.filter((x) => x.iptinh && x.iptinh > 0 && x.tocdo_id == this.listbox.cboGoiCuocAdsl.value) //dt_cuoc_adsl.Select("IPTINH is not null and IPTINH>0 and tocdo_id=" + cboGoiCuocAdsl.EditValue);
          if (!t || t.length == 0) {
            this.listbox.cboLoaiIP.list = []
            this.listbox.cboLoaiIP.values = []
            this.listbox.cboLoaiIP.valueitems = []
            this.listbox.cboLoaiIP.value = 0
          } else {
            this.listbox.cboLoaiIP.list = [...this.listbox.cboLoaiIP.orilist]
            //Da co load loaiip vao cboLoaiIP o mounted
            // bangts.HienThi_CheckBox_Combobox(cboLoaiIP, dsDanhMuc.Tables["LOAI_IP"], "loaiip_id", "loai_ip", "chon", "1");
            // cboLoaiIP.Properties.PopupFormMinSize = new Size(cboLoaiIP.Width, 100);
          }
        } else {
          this.listbox.cboLoaiIP.list = []
          this.listbox.cboLoaiIP.values = []
          this.listbox.cboLoaiIP.valueitems = []
          this.listbox.cboLoaiIP.value = 0
        }
      } else {
        this.listbox.cboLoaiIP.list = []
        this.listbox.cboLoaiIP.values = []
        this.listbox.cboLoaiIP.valueitems = []
        this.listbox.cboLoaiIP.value = 0
      }

      //Lấy danh sách khuyến mại
      //HIeutc: 03.06.2019: Ko cần cảnh báo đâu, tạm bỏ
      if (!this.kt_load) {
        await this.LayTienTheoKhoanMuc()
        if (this.listbox.doituong.value != DUNG_THU.DOITUONG_TB) await this.HT_DS_KhuyenMai_Combobox()
      }
      await this.HT_GIAODIEN_DONVI()
      //Them chon ngay theo yeu cau cua MyTV 2023-05-08
      if (await this.Kiemtra_dungthu_mytv()) {
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
          let strmatdcps = await API.post_fn_tt_tocdo_adsl(this.axios, { type: 4, param: this.listbox.cboGoiCuocAdsl.value })
            .then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return response.data.data
              } else return ''
            })
            .catch(() => {
              return ''
            })
          if (this.trangbi_id == TRANGBI.KHONG_SUDUNG_STB || strmatdcps == 'MYTV019') this.thuebao.tgdungthu = 90
        }
      }
    },
    HT_DS_DBCHINH_MYTV() {
      let pdata = {
        vkieu: 2,
        vma_tb: this.thuebao.adsl.txtAccountADSL,
        vupper: this.thamsomacdinh['MYTV_HOA'] == 1 ? 1 : 0,
        vtocdo_id: this.listbox.cboGoiCuocAdsl.value,
        vkhachhang_id: this.khachhang.khachhang_id ? this.khachhang.khachhang_id : 0,
        vhdkh_id: this.khachhang.hdkh_id ? this.khachhang.hdkh_id : 0,
        vdiachi_ld: this.diachiLD.DIACHI
      }
      API.post_ht_ds_tb_chinh(this.axios, pdata).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          if (response.data.data && response.data.data.length == 1 && response.data.data[0].hdtb_id == 0) {
            this.listbox.cboDbChinh.list = []
            this.listbox.cboDbChinh.value = 0
          } else {
            this.listbox.cboDbChinh.list = response.data.data
            if (this.listbox.cboDbChinh.list && this.listbox.cboDbChinh.list.length > 0 && (!this.listbox.cboDbChinh.value || this.listbox.cboDbChinh.value <= 0)) this.listbox.cboDbChinh.value = this.listbox.cboDbChinh.list[0].thuebao_id ? this.listbox.cboDbChinh.list[0].thuebao_id : 0 // text lay ma_tb
          }
        }
      })
    },
    HT_DS_HDCHINH_MYTV() {
      // let pdata = {
      //   "diachi_ld": this.diachiLD.DIACHI,
      //   "hdkh_id": this.khachhang.hdkh_id?this.khachhang.hdkh_id:0,
      //   "khachhang_id": this.khachhang.khachhang_id?this.khachhang.khachhang_id:0,
      //   "kieu": 1,
      //   "ma_tb": this.thuebao.adsl.txtAccountADSL,
      //   "tocdo_id": this.listbox.cboGoiCuocAdsl.value,
      //   "upper": this.thamsomacdinh['MYTV_HOA']==1?1:0
      // }
      let pdata = {
        vkieu: 1,
        vma_tb: this.thuebao.adsl.txtAccountADSL,
        vupper: this.thamsomacdinh['MYTV_HOA'] == 1 ? 1 : 0,
        vtocdo_id: this.listbox.cboGoiCuocAdsl.value,
        vkhachhang_id: this.khachhang.khachhang_id ? this.khachhang.khachhang_id : 0,
        vhdkh_id: this.khachhang.hdkh_id ? this.khachhang.hdkh_id : 0,
        vdiachi_ld: this.diachiLD.DIACHI
      }
      API.post_ht_ds_tb_chinh(this.axios, pdata).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          if (response.data.data && response.data.data.length == 1 && response.data.data[0].hdtb_id == 0) {
            this.listbox.cboHDChinh.list = []
            this.listbox.cboHDChinh.value = 0
          } else {
            this.listbox.cboHDChinh.list = response.data.data
            if (this.listbox.cboHDChinh.list && this.listbox.cboHDChinh.list.length > 0 && (!this.listbox.cboHDChinh.value || this.listbox.cboHDChinh.value <= 0)) this.listbox.cboHDChinh.value = this.listbox.cboHDChinh.list[0].hdtb_id ? this.listbox.cboHDChinh.list[0].hdtb_id : 0 // text lay ma_tb
          }
        }
      })
    },
    btnChonSoAoAdsl_Click() {
      if (!this.diachiLD.QUAN_ID || this.diachiLD.QUAN_ID == 0 || !this.diachiLD.PHUONG_ID || this.diachiLD.PHUONG_ID == 0) {
        this.$toast.error('Bạn chưa chọn địa chỉ lắp đặt !')
        return
      }

      this.popupComponent = () => import('./Popups/popupChonSM')
      this.popupComponentName = 'frmChonSMPhuongADSL'
      this.popupComponentData = {
        _tinh_id: this.diachiLD.TINH_ID,
        _quan_id: this.diachiLD.QUAN_ID,
        _phuong_id: this.diachiLD.PHUONG_ID,
        _loaiso_id: LOAISO.AO,
        _thueso: false,
        loaitb_id: this.listbox.loaihinh_tb.value,
        dichvuvt_id: this.listbox.dichvu_vt.value,
        hdkh_id: this.khachhang.hdkh_id,
        donvi_ql_id: this.listbox.donvi_ql.value //ql (lay field don vi lap dat.)
      }
      this.Popup('popupComponents')
    },
    async btnKiemTraAccount_Click() {
      try {
        if (!this.thuebao.adsl.txtAccountADSL || this.thuebao.adsl.txtAccountADSL == '') throw 'Chưa nhập account ADSL!'
        if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL || this.listbox.dichvu_vt.value == DichVuVienThong.MEGA_EYES) {
          let loaihinh_tb = this.listbox.loaihinh_tb.value

          if (loaihinh_tb == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC || loaihinh_tb == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC) {
            //TODO cho` link form nay frmTraCuuVDC UR2.8.023!
            // frmTraCuuVDC fvdc = new frmTraCuuVDC(1, txtAccountADSL.Text.Trim());
            // fvdc.ShowDialog();
          } else {
            await API.post_kiemtra_matb(this.axios, { dichVuVtId: this.listbox.dichvu_vt.value, hdtbId: this.hdtb_id, maTb: this.thuebao.adsl.txtAccountADSL }).then((response) => {
              if (response && response.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                if (response.data.data != 0) {
                  throw 'Account ' + this.thuebao.adsl.txtAccountADSL + ' đã được cấp. Bạn hãy kiểm tra lại'
                } else this.thuebao.adsl.validadslacc = true //FIXME doan nay them vao vi khi test camera no chay qua va khong thay doi gia tri nay dan den chet chuong trinh
              }
            })
            if (loaihinh_tb == LoaiHinhTB.INTERNET_1260 || loaihinh_tb == LoaiHinhTB.INTERNET_ADSL || loaihinh_tb == LoaiHinhTB.INTERNET_FTTH || loaihinh_tb == LoaiHinhTB.WIFI_FIBER || loaihinh_tb == LoaiHinhTB.MEGA_IOT) {
              await API.post_lookupRASAccount(this.axios, { accountName: this.thuebao.adsl.txtAccountADSL }).then((response) => {
                if (response != null && response.data != null && response.data.data != null && ((response.data.error_code != null && response.data.error_code === 'BSS-00000000') || (response.data.errorCode != null && response.data.errorCode == 0))) {
                  // let parser = new DOMParser();
                  // let xmlDoc = parser.parseFromString(response.data.data,"text/xml");
                  let ele = response.data.faultString //xmlDoc.getElementsByTagName("faultstring");
                  if (ele) {
                    if (ele.indexOf('không có quyền tác động tài khoản này') >= 0) throw 'Account ' + this.thuebao.adsl.txtAccountADSL + ' đã được sử dụng tại hệ thống của tỉnh khác. Bạn hãy vui lòng chọn Account khác!'
                    else if (ele.indexOf('Tài khoản yêu cầu') >= 0) throw 'Bạn hãy vui lòng chọn Account khác!'
                  } else throw 'Account ' + this.thuebao.adsl.txtAccountADSL + ' đã tồn tại trên Visa. Bạn hãy vui lòng chọn Account khác! '
                }
                this.$toast.success('Tài khoản ' + this.thuebao.adsl.txtAccountADSL + ' chưa được sử dụng. Bạn có thể thực hiện đặt chỗ cho Account này!')
                this.thuebao.adsl.validadslacc = true
              })
            } else if (loaihinh_tb == LoaiHinhTB.INTERNET_MYTV || loaihinh_tb == LoaiHinhTB.INTERNET_MYTV_B2B) {
              if (this.thamsomacdinh['MYTV_HOA'] == 1) this.thuebao.adsl.txtAccountADSL = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.toUpperCase().trim() : this.thuebao.adsl.txtAccountADSL
              else this.thuebao.adsl.txtAccountADSL = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.toLowerCase().trim() : this.thuebao.adsl.txtAccountADSL
              await API.post_getSubscriberInfo(this.axios, { iptvaccount: this.thuebao.adsl.txtAccountADSL }).then((response) => {
                if (response != null && response.data != null && response.data.data != null && ((response.data.error_code != null && response.data.error_code === 'BSS-00000000') || (response.data.errorCode != null && response.data.errorCode == 0))) {
                  if (!response.data.data.idno) {
                  } else throw 'Account ' + this.thuebao.adsl.txtAccountADSL + ' đã được cấp. Bạn hãy kiểm tra lại'
                }
                this.$toast.success('Tài khoản ' + this.thuebao.adsl.txtAccountADSL + ' chưa được sử dụng. Bạn có thể thực hiện đặt chỗ cho Account này!')
                this.thuebao.adsl.validadslacc = true
              })
            }
          }
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
        this.thuebao.adsl.validadslacc = false
      }
    },
    txtAccountADSL_TextChanged(v) {
      this.thuebao.adsl.txtAccountADSL = v.target.value
      if (!this.thuebao.adsl.txtAccountADSL) return
      this.thuebao.adsl.txtEmailAdsl = this.thuebao.adsl.txtAccountADSL ? this.thuebao.adsl.txtAccountADSL.toLowerCase().trim() + '@vnn.vn' : this.thuebao.adsl.txtAccountADSL
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV || this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_ANALOG || this.listbox.loaihinh_tb.value == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL) {
        this.thuebao.adsl.txtEmailAdsl = ''
      }
      //nhapt thêm 26062017
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGACAMERA) {
        if (this.thuebao.adsl.txtAccountADSL && this.thuebao.adsl.txtAccountADSL.length > 0 && !this.thuebao.adsl.txtAccountADSL.match(/^[a-zA-Z0-9_-]+$/g)) {
          this.$toast.error('Thuê bao VNPT Camera chỉ chấp nhận các kí tự a -> z; A -->Z , 0 ->9 ; - hoặc _. Hãy thử lại!')
          return
        }
      }
    },
    async TaoDuLieu_HDTB_ADSL(themmoi) {
      this.dsHDTB_ADSL = []
      let rowHDTB_ADSL = {}
      let apidata = {}
      let pdata = {
        THEMMOI: themmoi,
        GOICUOCADSL_ID: this.listbox.cboGoiCuocAdsl.value,
        KIEULD_ID: this.listbox.kieu_ld.value,
        MADOICAP_ADSL: this.thuebao.adsl.txtMaDoiCap_ADSL,
        MATKHAU_MD_ADSL: this.thamsomacdinh['MACDINH_MATKHAU_ADSL'] ? this.thamsomacdinh['MACDINH_MATKHAU_ADSL'] : 'random_sql',
        TT_CUOC: this.thuebao.adsl.txtTTCuoc
      } // fix random_sql theo code cu
      await API.post_fn_lay_tt_taodl_hdtb_adsl(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            //this.$toast.error(apidata['MESSAGE']);
            throw apidata['MESSAGE']
            return
          }
          if (apidata['RESULT']) apidata = apidata['RESULT']
        }
      })
      rowHDTB_ADSL.HDTB_ID = this.hdtb_id
      rowHDTB_ADSL.EMAIL = this.thuebao.adsl.txtEmailAdsl
      if (this.thuebao.adsl.ckTuCaiADSL) rowHDTB_ADSL.KH_CD = 1
      else rowHDTB_ADSL.KH_CD = 0
      rowHDTB_ADSL.TOCDO_ID = this.listbox.cboGoiCuocAdsl.value //vgoicuocasdl; // doi voi ADSL, vgoicuocasdl = this.listbox.cboGoiCuocAdsl.value

      if (this.thuebao.adsl.chkTocDoThuc) rowHDTB_ADSL.TOCDOTHUC_ID = this.listbox.cboTocDoThucADSL.value
      else rowHDTB_ADSL.TOCDOTHUC_ID = rowHDTB_ADSL.TOCDO_ID

      if (this.KetCuoi_ID > 0) rowHDTB_ADSL.KETCUOI_ID = this.KetCuoi_ID

      rowHDTB_ADSL.MUCCUOC_ID = this.listbox.muccuoc.value
      rowHDTB_ADSL.THOIHAN_ID = this.listbox.thoihan.valueadsl

      if (this.listbox.cboLoaiTB.value && this.listbox.cboLoaiTB.value != 0) rowHDTB_ADSL.THIETBIDC_ID = this.listbox.cboLoaiTB.value
      rowHDTB_ADSL.MA_LT = this.ma_tb_ao_ht
      //HungHM - 31/08/2010 bổ xung thêm ngày đặt chỗ cho Accont ADSL, FTTH
      let loaitb_id = this.listbox.loaihinh_tb.value
      if (loaitb_id == LoaiHinhTB.INTERNET_1260 || loaitb_id == LoaiHinhTB.INTERNET_ADSL || loaitb_id == LoaiHinhTB.INTERNET_FTTH || loaitb_id == LoaiHinhTB.WIFI_FIBER || loaitb_id == LoaiHinhTB.MEGA_IOT) rowHDTB_ADSL.HANDATCHO = this.thuebao.adsl.dtpHanDatCho
      if (loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_ANALOG || loaitb_id == LoaiHinhTB.HTVC_FIBERVNN_DIGITAL || loaitb_id == LoaiHinhTB.MEGACAMERA) rowHDTB_ADSL.SLTV_HTVC = this.thuebao.adsl.txtSL_Tivi

      if (loaitb_id == LoaiHinhTB.FSECURE) rowHDTB_ADSL.SO_DT = this.thuebao.adsl.txtDienThoai_Fsecure

      if (loaitb_id == LoaiHinhTB.COSO_HATANG) {
        rowHDTB_ADSL.DOITAC_ID = this.listbox.cboDoiTac_CSHT.value
        rowHDTB_ADSL.LOAI_CSHT_ID = this.listbox.cboLoai_CSHT.value
      }

      let profiledsl_id = -1
      if (apidata['PROFILEDSL_ID']) profiledsl_id = apidata['PROFILEDSL_ID']
      if (profiledsl_id != -1) rowHDTB_ADSL.PROFILEDSL_ID = profiledsl_id
      else rowHDTB_ADSL.PROFILEDSL_ID = null

      if (this.listbox.congnghe.value > 0) rowHDTB_ADSL.CONGNGHE_ID = this.listbox.congnghe.value
      else rowHDTB_ADSL.CONGNGHE_ID = null

      if (this.listbox.doitac.ischeckedadsl) {
        rowHDTB_ADSL.DOITAC_ID = this.listbox.doitac.valueinternet
        if (this.thuebao.adsl.txtCuocDT_Internet) rowHDTB_ADSL.CUOC_DOITAC = this.thuebao.adsl.txtCuocDT_Internet
        else rowHDTB_ADSL.CUOC_DOITAC = 0
      } else {
        rowHDTB_ADSL.DOITAC_ID = null
        rowHDTB_ADSL.CUOC_DOITAC = null
      }

      rowHDTB_ADSL.VMP = this.cbvmp ? 1 : 0
      //HungHM - Bổ xung thêm mã truy nhập + mã đôi cáp
      rowHDTB_ADSL.MATB_TN = this.thuebao.adsl.txtMaTN_ADSL
      //Lamnt: Bổ sung trường serial_stb
      rowHDTB_ADSL.SERIAL_STB = this.thuebao.adsl.txtSerialSTB

      if (apidata['MADOICAP']) {
        rowHDTB_ADSL.MADOICAP = apidata['MADOICAP']
        this.thuebao.adsl.txtMaDoiCap_ADSL = apidata['MADOICAP']
      }

      rowHDTB_ADSL.TRANGBI_ID = this.listbox.trangbi.valueadsl
      rowHDTB_ADSL.CHUQUAN_ID = this.listbox.chu_quan.valueadsl
      rowHDTB_ADSL.CHUQUANLD_ID = this.listbox.chu_quan.valueldadsl
      rowHDTB_ADSL.KIEUTRA_ID = this.listbox.cboKieuTra.value
      if (rowHDTB_ADSL.KIEUTRA_ID == 1) {
        rowHDTB_ADSL.THANG_ID = this.listbox.cboThangTra.value
        rowHDTB_ADSL.NGAYTRA = this.thuebao.adsl.dtpNgayTra
      }
      if (apidata['PASS_ADSL']) rowHDTB_ADSL.PASSWORD = apidata['PASS_ADSL']
      else if (apidata['MATKHAU_MD_ADSL']) rowHDTB_ADSL.PASSWORD = apidata['MATKHAU_MD_ADSL']
      if(!rowHDTB_ADSL.PASSWORD && this.thuebao.adsl.pass_adsl) rowHDTB_ADSL.PASSWORD = this.thuebao.adsl.pass_adsl;
      if (this.listbox.doitac.ischeckedadsl) {
        rowHDTB_ADSL.USERNAME = this.thuebao.adsl.txtAccountADSL ? (this.thuebao.adsl.txtAccountADSL+'').trim() : ''
        if (this.listbox.doitac.valueinternet) {
          rowHDTB_ADSL.USERNAME =
            (this.thuebao.adsl.txtAccountADSL ? (this.thuebao.adsl.txtAccountADSL+'').trim() : '') +
            (this.listbox.doitac.list.filter((x) => x.doitac_id == this.listbox.doitac.valueinternet)[0]['username_sub'] ? this.listbox.doitac.list.filter((x) => x.doitac_id == this.listbox.doitac.valueinternet)[0]['username_sub'].trim() : '') //dsDanhMuc.Tables["DOITAC"].Select("doitac_id = " + Convert.ToInt32(cboDoiTac_Internet.EditValue)).CopyToDataTable().Rows[0]["username_sub"].ToString().Trim();
        }
      } else rowHDTB_ADSL.USERNAME = this.thuebao.adsl.txtAccountADSL ? (this.thuebao.adsl.txtAccountADSL+'').trim() : ''

      // if (!this.thuebao.adsl.txtTTCuoc) {
      //   if (apidata['SL_IP_MP']) this.thuebao.adsl.txtTTCuoc = apidata['SL_IP_MP']
      // }
      // rowHDTB_ADSL.THONGTIN_TC = this.thuebao.adsl.txtTTCuoc
      rowHDTB_ADSL.THONGTIN_TC = null;

      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_ADSL_TINH_KHAC || this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FIBER_TINH_KHAC) {
        rowHDTB_ADSL.CUOC_SD = this.thuebao.adsl.txtCSD_FIBER_TK
        rowHDTB_ADSL.CUOC_TBI = this.thuebao.adsl.txtCTB_FIBER_TK
      }
      if (!themmoi) rowHDTB_ADSL.MA_VNPT = this.ma_vnpt
      //create by kylq.hcm
      //Bổ sung cho megaIOT
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.MEGA_IOT) {
        rowHDTB_ADSL.VRF = this.thuebao.adsl.megaIOT_vrf
        rowHDTB_ADSL.HUONG_KN = this.thuebao.adsl.megaIOT_HuongKN
        rowHDTB_ADSL.IP = this.thuebao.adsl.megaIOT_LanIP
        rowHDTB_ADSL.IPV4_WAN = this.thuebao.adsl.megaIOT_WanIP
      }

      this.dsHDTB_ADSL.push(rowHDTB_ADSL)
      // if (themmoi == false)
      // {
      //     dsHDTB_ADSL.AcceptChanges();
      //     dsHDTB_ADSL.HDTB_ADSL.Rows[0].SetModified();
      // }
      //Tạo cho bảng hdtb_dv
      for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

        if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
          throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
          return;
        }
        let row = {}
        row.HDTB_ID = this.hdtb_id
        row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
        row.DONVI_ID = this.DT_CONTROLS.value[i]
        row.KIEUDV_ID = 2
        this.dsHDTBDV.push(row)
      }
      //End
    },
    TaoDuLieu_HDTB_LOAIIP() {
      try {
        this.dsHDTB_LoaiIp = []
        if (this.listbox.cboLoaiIP.values && this.listbox.cboLoaiIP.values.length > 0)
          for (let loaiip of this.listbox.cboLoaiIP.values) {
            if (!loaiip) continue
            let rowHDTB_LIP = {}
            rowHDTB_LIP.HDTB_ID = this.hdtb_id
            rowHDTB_LIP.LOAIIP_ID = loaiip //Convert.ToInt32(cboLoaiIP.Properties.Items[i].Value.ToString());
            this.dsHDTB_LoaiIp.push(rowHDTB_LIP)
          }
        else {
          if (!this.listbox.cboLoaiIP.value) return
          let rowHDTB_LIP = {}
          rowHDTB_LIP.HDTB_ID = this.hdtb_id
          rowHDTB_LIP.LOAIIP_ID = this.listbox.cboLoaiIP.value //Convert.ToInt32(cboLoaiIP.Properties.Items[i].Value.ToString());
          this.dsHDTB_LoaiIp.push(rowHDTB_LIP)
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async DatMoi_Fsecure_kem_fiber() {
      try {
        this.kieuld_fsecure_kem_fiber = 0
        await API.post_lay_tt_fs_kem_ftth_v2(this.axios, { vloaihd_id: LoaiHopDong.DAT_MOI }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            this.kieuld_fsecure_kem_fiber = response.data.data[0]['ten_ts']
          }
        })

        if (
          this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_FTTH && //lắp mới fiber
          this.kieuld_fsecure_kem_fiber != 0 // thỏa mãn điều kiện kèm fsecure
        ) {
          this.loading(false)
          this.$bvModal
            .msgBoxConfirm('Đang trong thời gian khuyến mại: Lắp mới Fiber sẽ được tặng 01 gói Fsecure miễn phí. Bạn có đồng ý nhận khuyến mại?', {
              title: 'Xác nhận hành động',
              size: 'sm',
              okTitle: 'Đồng ý',
              cancelTitle: 'Không đồng ý'
            })
            .then(async (v) => {
              if (v) {
                //Message_Box.ShowTB("Đang trong thời gian khuyến mại: Lắp mới Fiber sẽ được tặng 01 gói Fsecure miễn phí!");
                this.popupComponent = () => import('./Popups/popupTT_Fsecure_kem_ftth')
                this.popupComponentName = 'popupTT_Fsecure_kem_ftth'
                this.popupComponentData = { so_dt: this.khachhang.dienthoai }
                this.Popup('popupComponents')
              }
            })
        }
      } catch (Exception) {
        if (this.debug) console.error(Exception)
      }
    },
    async Them_MyTV_vao_goi_giadinh() {
      try {
        let pdata = { KIEULD_ID: this.listbox.kieu_ld.value, MATN_ADSL: this.thuebao.adsl.txtMaTN_ADSL, MUCCUOC_ID: this.listbox.muccuoc.value, GOICUOCADSL: this.listbox.cboGoiCuocAdsl.value, HDTB_ID: this.hdtb_id }
        await API.post_fn_lay_tt_mytv_vao_goigd(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] == -99) return
            else if (apidata['ERROR_CODE'] != 1) return //{ this.$toast.error(apidata['MESSAGE']); return; }
            if (apidata['RESULT']) apidata = apidata['RESULT']

            // js_hdtb_goi_dadv.put('GOI_ID',l_goi_id);
            // js_hdtb_goi_dadv.put('NHOMTB_ID',l_nhomtb_id);
            // js_hdtb_goi_dadv.put('CHUNHOM',0);
            // js_hdtb_goi_dadv.put('HDTB_ID',l_hdtb_id);
            // js_hdtb_goi_dadv.put('THANG_HUONG',0);
            // l_result_js.put('HDTB_GOI_DADV',js_hdtb_goi_dadv);
            if (apidata['HDTB_GOI_DADV'] && apidata['HDTB_GOI_DADV'].length > 0) {
              let ds = apidata['HDTB_GOI_DADV']
              let goi_id = ds[0]['GOI_ID']
              let nhomtb_id = ds[0]['NHOMTB_ID']
              this.loading(false)
              this.$bvModal
                .msgBoxConfirm(`Thuê bao Fiber: ${this.thuebao.adsl.txtMaTN_ADSL} đang tham gia gói gia đình. Bạn có đồng ý thêm thuê bao MyTV này vào cùng gói gia đình với Fiber không?`, {
                  title: 'Xác nhận hành động',
                  size: 'sm',
                  okTitle: 'Đồng ý',
                  cancelTitle: 'Không đồng ý'
                })
                .then(async (v) => {
                  if (v) {
                    TaoDuLieu_HDTB_GOI_DADV(goi_id, nhomtb_id)
                    await API.post_sp_insert_hdtb_goi_dadv(this.axios, { js_hdtb_goi_dadv: JSON.stringify(this.dsHDTBGOI) }).then((response) => {
                      if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                      } else this.$toast.error(`${response.data.message}: ${response.data.message_detail}`)
                    })
                  }
                })
            }
          }
        })
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    TaoDuLieu_HDTB_GOI_DADV(goi_id, nhomtb_id) {
      this.dsHDTBGOI = []
      let rowGOI = {}
      rowGOI.GOI_ID = goi_id
      rowGOI.NHOMTB_ID = nhomtb_id
      rowGOI.CHUNHOM = 0
      rowGOI.HDTB_ID = this.hdtb_id
      rowGOI.THANG_HUONG = 0
      this.dsHDTBGOI.push(rowGOI)
    },
    async TaoDuLieu_HDTB_Fsecure_kem(themmoi) {
      // #region HD_THUEBAO_DATA
      this.dsHDTB = []
      // await API.post_get_keys(this.axios, {"keyname":"HD_THUEBAO"}).then((response) => {
      //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //     rowHDTB.HDTB_ID = response.data.data; // 4039
      //     this.hdtb_id = rowHDTB.HDTB_ID;
      //   }
      // });
      // this.hdtb_id = new GetKeyFacade().GetKey("HD_THUEBAO");

      let rowHDTB = {}

      // rowHDTB.HDTB_ID = this.hdtb_id; // Da gen key o tren
      rowHDTB.HDTT_ID = this.hdtt_id
      rowHDTB.HDKH_ID = this.khachhang.hdkh_id

      rowHDTB.MA_TB = 'fse_0' + this.thuebao.adsl.txtDienThoai_Fsecure

      rowHDTB.TEN_TB = this.thuebao.tentb
      rowHDTB.DIACHI_TB = this.diachiTB.DIACHI
      rowHDTB.GHICHU = this.thuebao.ghichu
      rowHDTB.KIEULD_ID = this.kieuld_fsecure_kem_fiber
      rowHDTB.LOAITB_ID = LoaiHinhTB.FSECURE
      rowHDTB.DOITUONG_ID = this.listbox.doituong.value
      rowHDTB.DONVI_ID = this.listbox.donvi_ql.value
      rowHDTB.TTHD_ID = TrangThaiHD.MOI
      rowHDTB.DICHVUVT_ID = DichVuVienThong.ANTOAN_BAOMAT_TT

      rowHDTB.KIEU_TB = '0' //Kiểu thuê bao thường.
      rowHDTB.NGUOI_CN = this.$root.token.getNguoiDungID()
      rowHDTB.NGAY_CN = new Date().toLocaleDateString('en-GB')
      rowHDTB.MAY_CN = this.$root.token.getMaNhanVien()
      rowHDTB.IP_CN = 'xxx'
      //LONGDX: bổ sung thông tin thuê bao mạng khác chuyển sang
      rowHDTB.CHUYENMANG = this.listbox.nhacc_cu.ischecked ? 1 : 0
      if (this.listbox.nhacc_cu.ischecked) {
        if (this.listbox.nhacc_cu.value && this.listbox.nhacc_cu.value > 0) {
          rowHDTB.NHACC_CU_ID = this.listbox.nhacc_cu.value
        }
        if (this.listbox.hinhthuc_cm.value && this.listbox.hinhthuc_cm.value > 0) {
          rowHDTB.HTCM_ID = this.listbox.hinhthuc_cm.value
        }
      }
      rowHDTB.TBHD_PL = this.thuebao.tbhd_pl // Tuan them truong TBHD_PL cho thue bao --> 1 <-> In HD; 0 <-> In PL --- Ngay 24/08/2010
      //HungHM-27/06/2010: bổ xung thêm các column cho bảng HD_ThueBao
      rowHDTB.DIACHI_LD = this.diachiLD.DIACHI
      if (this.NgaySinhTB) {
        rowHDTB.NGAY_SN = this.NgaySinhTB
      }

      let STATUS_TONGDAI_CD = true
      rowHDTB.STATUS = '0'

      await API.post_fn_lay_tt_taodl_hdtb(this.axios, {
        kieu: 2,
        ds_para: JSON.stringify({ THEMMOI: themmoi, MA_TB_HT: this.ma_tb_ht, MUCUOCTB_ID: this.listbox.muccuoc_tb.value, LUONG_ID: this.luong_id, CODE: 'STATUS_TONGDAI_CD', DS_CHITIETKM_ID: null, KIEULD_ID: this.listbox.kieu_ld.value })
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let dulieuapi = JSON.parse(response.data.data)
          if (dulieuapi && dulieuapi['ERROR_CODE'] == 1) {
            if (dulieuapi['RESULT']) dulieuapi = dulieuapi['RESULT']
            if (dulieuapi['HDTB_ID']) {
              rowHDTB.HDTB_ID = dulieuapi['HDTB_ID']
              this.hdtb_id = dulieuapi['HDTB_ID']
            }
            // if(dulieuapi['MUCUOC_TB']) rowHDTB.MUCUOC_TB = dulieuapi['MUCUOC_TB'];
            if (dulieuapi['DS_CTKM_LTBI']) {
              rowHDTB.DS_CTKM_LTBI = dulieuapi['DS_CTKM_LTBI']
              this.DS_CTKM_LTBI = rowHDTB.DS_CTKM_LTBI
            } else this.DS_CTKM_LTBI = []
            if (dulieuapi['STATUS']) STATUS_TONGDAI_CD = true
          }
        }
      })

      if (STATUS_TONGDAI_CD) rowHDTB.STATUS = '0'

      //HungHM - 06/09/2010 thêm dvql đầu + cuối
      rowHDTB.DONVI_DAU_ID = this.thuebao.tsl.donvi_dau_id //this.listbox.donvi_dau.value;
      rowHDTB.DONVI_CUOI_ID = this.thuebao.tsl.donvi_cuoi_id //this.listbox.donvi_cuoi.value;

      if (this.kt_thuenganhan == true) {
        rowHDTB.TG_THUE_TU = this.TGThueTuNgay
        rowHDTB.TG_THUE_DEN = this.TGThueDenNgay
      }

      rowHDTB.QUYTRINH_ID = this.quytrinh_tn
      if (this.listbox.goi_kt.value > 0) {
        rowHDTB.GOIKT_ID = this.listbox.goi_kt.value
      }

      rowHDTB.SOTHANG_CK = 0

      this.dsHDTB.push(rowHDTB)
    },
    async TaoDuLieu_CT_TIENHD_fsecure_kem(themmoi) {
      this.dsCTTHD = []
      let rowCTTHD

      for (var i = 0; i < this.ds_tien_khoanmuc.length; i++) {
        if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_MUATHIETBI || this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI || this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_TRATRUOC_THIETBI) {
          for (var j = 0; j < dsCTM_TBI.length; j++) {
            rowCTTHD = {}
            rowCTTHD.HDTB_ID = this.hdtb_id
            if (themmoi) {
              await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  rowCTTHD.CT_TIENHD_ID = response.data.data
                }
              })
            }
            rowCTTHD.KHOANMUCTT_ID = this.ds_tien_khoanmuc[i]['khoanmuctt_id']
            let tien
            let vat
            let soluong = 1
            soluong = this.dsCTM_TBI[j]['soluong']
            tien = 0 //Convert.ToDecimal(CommonFunction.Unformat_tien(dsCTM_TBI.Tables[0].Rows[j]["tien"].ToString())) * soluong;
            vat = 0 //Convert.ToDecimal(CommonFunction.Unformat_tien(dsCTM_TBI.Tables[0].Rows[j]["vat"].ToString())) * soluong;
            rowCTTHD.TIEN = 0 //tien;
            rowCTTHD.VAT = 0 //vat;
            rowCTTHD.ID = this.dsCTM_TBI[j]['loaitbi_id']
            rowCTTHD.LOAI_ID = 3
            this.dsCTTHD.push(rowCTTHD)
          }
        } else if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DICHVU) {
          for (var j = 0; j < this.m_dsThueBao_DichVu.length; j++) {
            if (this.m_dsThueBao_DichVu[j]['dangky'] == 1 && this.m_dsThueBao_DichVu[j]['huy'] == 0) {
              rowCTTHD = {}
              rowCTTHD.HDTB_ID = this.hdtb_id
              if (themmoi) {
                await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    rowCTTHD.CT_TIENHD_ID = response.data.data
                  }
                })
              }
              rowCTTHD.KHOANMUCTT_ID = KHOANMUC_TT.KMTT_DICHVU
              let tien = 0 //Tiền dịch vụ chưa khuyến mại
              let vat = 0 //Vat dịch vụ chưa khuyến mại
              tien = 0 //Convert.ToDecimal(CommonFunction.Unformat_tien(this.m_dsThueBao_DichVu[j]["cuoc_ld"].ToString()));
              rowCTTHD.TIEN = 0 //tien;
              vat = 0 //Convert.ToDecimal(CommonFunction.Unformat_tien(this.m_dsThueBao_DichVu[j]["vat_ld"].ToString()));
              rowCTTHD.VAT = 0 //vat;
              rowCTTHD.ID = this.m_dsThueBao_DichVu[j]['dichvugt_id']
              rowCTTHD.LOAI_ID = 2
              this.dsCTTHD.push(rowCTTHD)
            }
          }
        } else {
          rowCTTHD = {}
          rowCTTHD.HDTB_ID = this.hdtb_id
          if (themmoi) {
            await API.post_get_keys(this.axios, { keyname: 'CT_TIENHD' }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                rowCTTHD.CT_TIENHD_ID = response.data.data
              }
            })
          }
          rowCTTHD.KHOANMUCTT_ID = this.ds_tien_khoanmuc[i]['khoanmuctt_id']

          if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_LAPDAT || this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_THIETBI || this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_KM_DATCOC) {
            if (this.ds_tien_khoanmuc[i]['tien'] > 0) {
              rowCTTHD.TIEN = 0 //Convert.ToDecimal(this.ds_tien_khoanmuc[i]["tien"].ToString()) * -1;
              rowCTTHD.VAT = 0 //Convert.ToDecimal(this.ds_tien_khoanmuc[i]["vat"].ToString()) * -1;
            } else {
              rowCTTHD.TIEN = 0 //Convert.ToDecimal(this.ds_tien_khoanmuc[i]["tien"].ToString());
              rowCTTHD.VAT = 0 //Convert.ToDecimal(this.ds_tien_khoanmuc[i]["vat"].ToString());
            }
          } else {
            rowCTTHD.TIEN = 0 //Convert.ToDecimal(this.ds_tien_khoanmuc[i]["tien"].ToString());
            rowCTTHD.VAT = 0 //Convert.ToDecimal(this.ds_tien_khoanmuc[i]["vat"].ToString());
          }
          rowCTTHD.ID = this.ds_tien_khoanmuc[i]['khoanmuctt_id']
          rowCTTHD.LOAI_ID = 1
          this.dsCTTHD.push(rowCTTHD)
        }
      }
    },
    TaoDuLieu_TIEN_DATCOC_Fsecure_kem(themmoi) {
      this.dsTien_DatCoc = []
      let row = {}

      row.HDTB_ID = this.hdtb_id
      row.THUEBAO_ID = 0
      row.LOAITIEN_ID = 1
      row.GIATRI = 0 // dtiendatcoc_tt + dvatdatcoc_tt + dtiendatcoc_km + dvatdatcoc_km;

      dsTien_DatCoc.push(row)
      // if (themmoi == false)
      // {
      //     dsTien_DatCoc.AcceptChanges();
      //     dsTien_DatCoc.TIEN_HDTB_TC.Rows[0].SetModified();
      // }
    },
    async TaoDuLieu_HDTB_CNTT_Fsecure_kem(_matb_tn, _madoicap) {
      await this.Init_Properties(LoaiHinhTB.FSECURE, 'HDTB_CNTT', '00000', this.ItemList)

      for (var index1 = 0; index1 < this.ItemList.length; ++index1) {
        if (this.ItemList[index1].sFieldName == 'MA_TB') this.ItemList[index1].sValue = 'fse_0' + this.thuebao.adsl.txtDienThoai_Fsecure //sodt_fsecure_kem;

        if (this.ItemList[index1].sFieldName == 'TOCDO_ID') this.ItemList[index1].sValue = FSECURE_KM_12_MONTHS.FreeFSD12M_2018 // TOCDO_ID_CFreeFSD12M;// TOCDO_ID_V2;
        if (this.ItemList[index1].sFieldName == 'MUCCUOC_ID') this.ItemList[index1].sValue = '1' //trọn gói
        if (this.ItemList[index1].sFieldName == 'SO_DT') this.ItemList[index1].sValue = this.thuebao.adsl.txtDienThoai_Fsecure //sodt_fsecure_kem;
        if (this.ItemList[index1].sFieldName == 'MATB_TN') this.ItemList[index1].sValue = _matb_tn //txtAccountADSL.Text.Trim();//matb_tn của fse là mã tb fiber
        if (this.ItemList[index1].sFieldName == 'MADOICAP') this.ItemList[index1].sValue = _madoicap //txtMaDoiCap_ADSL.Text.Trim()
        if (this.ItemList[index1].sFieldName == 'CHUQUAN_ID') this.ItemList[index1].sValue = this.listbox.chu_quan.valueadsl
      }
      let pdata = { QUYTRINH_ID: this.quytrinh_tn, HDTB_ID: this.hdtb_id, DS_HDTB_DV: this.dsHDTBDV }
      API.post_fn_lay_tt_taodl_hdtb_cntt_fs_kem(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            this.$toast.error(apidata['MESSAGE'])
            return
          }
          let dt_tmp = apidata['RESULT']['DS_HDTB_DV']
          var inloaidv_id = 0
          var indonvi_id = 0
          for (var i = 0; i < dt_tmp.length; i++) {
            inloaidv_id = dt_tmp[i]['LOAIDV_ID'] //["loaidv_dich_id"]; //trong stored da doi ten: drow.put('LOAIDV_ID',i.loaidv_dich_id);
            indonvi_id = dt_tmp[i]['DONVI_ID'] // Da xu ly trong stored!
            if (inloaidv_id != LOAI_DV.GIAODICH) {
              let dr = this.dsHDTBDV.filter((x) => x.LOAIDV_ID == inloaidv_id)

              if (dr.length > 0)
                //tìm đc trong số các đơn vị của fiber
                indonvi_id = dr[0]['DONVI_ID']
              // Doan else nay da xu ly o dng truoc lenh if, lay tu stored ra san
              // else
              // {
              // Không tìm được --> lấy đvị mặc định
              // string str_donvi = "";
              // str_donvi += "select a.donvi_id from ";
              // str_donvi += DatabaseConstants.DB1 + ".donvi a, ";
              // str_donvi += DatabaseConstants.DB1 + ".donvi_ldv b ";
              // str_donvi += " where a.donvi_id = b.donvi_id ";
              // str_donvi += "  and b.loaidv_id = " + inloaidv_id;

              // DataTable dt_donvi = bangts.GetDataSql(str_donvi);

              // indonvi_id = Convert.ToInt32(dt_donvi.Rows[0]["donvi_id"].ToString());
              // }

              let row = {}
              row.HDTB_ID = this.hdtb_id
              row.LOAIDV_ID = inloaidv_id
              row.DONVI_ID = indonvi_id
              row.KIEUDV_ID = 2
              this.dsHDTBDV_Fsecure.push(row)
            }
          }
        }
      })
    },
    async Init_Properties(vloaitb_id, table_name, opt_list, ItemList) {
      await API.post_lay_danhsach_thuoctinh_datmoi(this.axios, {
        vloaitb_id: vloaitb_id,
        vopt_list: opt_list,
        vten_bang: table_name
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let ds = response.data.data
          this.ItemList = []
          if (ds.length <= 0) return
          for (var i = 0; i < ds.length; i++) {
            // if(!this.ItemList[i]) continue;
            let row = ds[i]
            if (!this.ItemList[i]) this.ItemList[i] = {}
            this.ItemList[i].sFieldName = row['field_name']
            this.ItemList[i].sCaption = row['ten_hienthi']
            this.ItemList[i].iAtt = row['att']
            this.ItemList[i].iDataType = row['data_type']
            this.ItemList[i].sMaxValue = row['max_value']
            this.ItemList[i].sMinValue = row['min_value']
            this.ItemList[i].sValue = row['field_value']
            this.ItemList[i].nFieldLength = row['field_length'] ? 0 : row['field_length']
            this.ItemList[i].bIsNotNull = row['field_nullable'] ? false : row['field_nullable'] == '0' ? true : false
            this.ItemList[i].bIsUnique = row['field_unique'] ? false : row['field_unique'] == '0' ? false : true
            this.ItemList[i].sLookUpTableName = row['parent_table']
            this.ItemList[i].sLookUpKeyField = row['parent_keyfield']
            this.ItemList[i].sLookUpValueField = row['parent_descfield']
            this.ItemList[i].strDepandField = row['depend_field']
            this.ItemList[i].StrSql = row['lookup_sql']
            if (row['lookup_sql_response']) this.ItemList[i].SqlData = this.UpperCasePropertyList(row['lookup_sql_response'])
          }
        }
      })
    },
    async btnThongTinTC_Click() {
      // ThongTinTC()
      // this.DangXayDung();
      // return;
      try {
        if (!this.listbox.muccuoc_tb.list || this.listbox.muccuoc_tb.list.length <= 0 || !this.listbox.muccuoc_tb.value || this.listbox.muccuoc_tb.value <= 0) {
          this.$toast.error('Chưa có mức cước thuê bao. Bạn hãy kiểm tra lại!')
          return
        }
        let apidata = {}
        await API.post_fn_lay_thongtin_tc(this.axios, { ds_para: JSON.stringify({ MUCCUOCTB_ID: this.listbox.muccuoc_tb.value, DICHVUVT_ID: this.listbox.dichvu_vt.value, GOICUOC_ADSL: this.listbox.cboGoiCuocAdsl.value }) }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] != 1) {
              this.$toast.error(apidata['MESSAGE'])
              return
            }
            apidata = apidata['RESULT']
          }
        })
        // CheckDataFacade obj = new CheckDataFacade();
        // string cuoc_tb = obj.MAP_ID("cuoc_tb", DatabaseConstants.DB2 + ".muccuoc_tb", "where mucuoctb_id =" + cboMucCuocTB.SelectedValue);
        // string cuockhoan = obj.MAP_ID("cuockhoan", DatabaseConstants.DB2 + ".muccuoc_tb", "where mucuoctb_id =" + cboMucCuocTB.SelectedValue);
        // string cuoc_tg = obj.MAP_ID("cuoc_tg", DatabaseConstants.DB2 + ".muccuoc_tb", "where mucuoctb_id =" + cboMucCuocTB.SelectedValue);
        // string cuoc_ll = obj.MAP_ID("cuoc_ll", DatabaseConstants.DB2 + ".muccuoc_tb", "where mucuoctb_id =" + cboMucCuocTB.SelectedValue);
        let cuoc_tb = apidata['CUOC_TB'] ? apidata['CUOC_TB'] : 0
        let cuockhoan = apidata['CUOCKHOAN'] ? apidata['CUOCKHOAN'] : 0
        let cuoc_tg = apidata['CUOC_TG'] ? apidata['CUOC_TG'] : 0
        let cuoc_ll = apidata['CUOC_LL'] ? apidata['CUOC_LL'] : 0

        if (cuoc_tb == '-1') cuoc_tb = '0'
        if (cuockhoan == '-1') cuockhoan = '0'
        if (cuoc_tg == '-1') cuoc_tg = '0'
        if (cuoc_ll == '-1') cuoc_ll = '0'

        let dulieu = {
          cuoc_tb: cuoc_tb,
          cuoc_tg: cuoc_tg,
          cuockhoan: cuockhoan,
          cuoc_ll: cuoc_ll,
          muccuoctb_id: this.listbox.muccuoc_tb.value ? this.listbox.muccuoc_tb.value : 0,
          mienip: apidata['MIENIP'] ? apidata['MIENIP'] : null,
          loaitb_id: this.listbox.loaihinh_tb.value,
          thongtintc: this.thuebao.adsl.txtTTCuoc
        }

        this.popupComponent = () => import('./Popups/popupThongTinTC')
        this.popupComponentName = 'popupThongTinTC'
        this.popupComponentData = dulieu
        this.Popup('popupComponents')
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    chkVMP_CheckedChanged() {
      if (this.cbvmp && this.listbox.loaihinh_tb.value == LoaiHinhTB.INTERNET_MYTV) {
        API.post_kiemtra_vmp(this.axios, { id: this.listbox.cboGoiCuocAdsl.value }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            if (response.data.data.length > 0) return
          }
          this.$toast.error('VMP không được đăng ký với tốc độ này. Mời bạn chọn lại!')
          this.cbvmp = false
          return
        })
      }
    },
    async cboCongNghe_SelectedValueChanged() {
      try {
        this.loading(true)
        if (this.ccongnghe.length > 0) {
          if (!this.listbox.congnghe.value || this.listbox.congnghe.value <= 0) return
          if (this.kt_load == false) {
            // let dk = "sudung = 1"; // khong dung, da tich hop trong stored
            await API.post_sp_ht_tocdo_adsl_theo_loaitb(this.axios, { congnghe_id: this.listbox.congnghe.value ? this.listbox.congnghe.value : 0, kieuld_id: this.listbox.kieu_ld.value, loaitb_id: this.listbox.loaihinh_tb.value }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.listbox.cboGoiCuocAdsl.list = response.data.data
                this.listbox.cboTocDoThucADSL.list = response.data.data
                if (this.listbox.cboGoiCuocAdsl.list && this.listbox.cboGoiCuocAdsl.list.length > 0 && (!this.listbox.cboGoiCuocAdsl.value || !this.listbox.cboGoiCuocAdsl.list.find((x) => x.tocdo_id == this.listbox.cboGoiCuocAdsl.value)))
                  if (this.listbox.cboGoiCuocAdsl.list.find((x) => x.tocdo_id > 0)) this.listbox.cboGoiCuocAdsl.value = this.listbox.cboGoiCuocAdsl.list.find((x) => x.tocdo_id > 0).tocdo_id
                  else this.listbox.cboGoiCuocAdsl.value = this.listbox.cboGoiCuocAdsl.value ? this.listbox.cboGoiCuocAdsl.value : 0
                await this.cboGoiCuocAdsl_SelectedValueChanged(this.listbox.cboGoiCuocAdsl.value)
                // this.listbox.cboGoiCuocAdsl.values = [this.listbox.cboGoiCuocAdsl.value];
              } else {
                this.listbox.cboGoiCuocAdsl.list = []
                this.listbox.cboTocDoThucADSL.list = []
                this.listbox.cboGoiCuocAdsl.value = 0
                this.listbox.cboTocDoThucADSL.value = 0
              }
            })
          }
        }
      } catch (ex) {
        this.$toast.error('Lỗi khi chọn công nghệ: ' + ex);
        if(this.debug) console.error('Loi khi chon cong nghe??????',ex);
      } finally {
        this.loading(false)
      }
    },
    TaoDuLieu_TIEN_HDTB_TC(themmoi) {
      this.dsTien_HDTB = []
      let row = {}

      row.HDTB_ID = this.hdtb_id
      row.THUEBAO_ID = 0
      row.LOAITIEN_ID = 3
      if (this.thuebao.adsl.tientra) row.GIATRI = this.thuebao.adsl.tientra
      else row.GIATRI = 0

      this.dsTien_HDTB.push(row)
      // if (themmoi == false)
      // {
      //     dsTien_HDTB.AcceptChanges();
      //     dsTien_HDTB.TIEN_HDTB_TC.Rows[0].SetModified();
      // }
    },
    async Kiemtra_dungthu_mytv() {
      let kq = false
      await API.post_kiemtra_dungthu_mytv_moi(this.axios, {
        vdoituong_id: this.listbox.doituong.value,
        vloaitb_id: this.listbox.loaihinh_tb.value,
        vtocdo_id: this.tocdo_id
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          kq = response.data.data == 1
        }
      })
      return kq
    },
    async GiaoDien_DichVuVT(dichvuvt_id) {
      switch (
        dichvuvt_id * 1 // Bo qua cac case chi bat tat giao dien
      ) {
        case DichVuVienThong.MEGAWAN:
        case DichVuVienThong.METRONET:
        case DichVuVienThong.NOIBO_DADIEM:
          if (!this.thuebao.mgwan.somay || this.thuebao.mgwan.somay == '') this.SinhMaDVVT()
          break
        case DichVuVienThong.MEGA_EYES:
          this.listbox.muccuoc_tb.value = MUCCUOC.TRON_GOI
          break
        case DichVuVienThong.TSL:
        case DichVuVienThong.NOIBO_2DIEM:
          //txtMaHD.ReadOnly = false; //FIXME Xac dinh lai xem la o nao, can thiet phai set khong?
          //HungHM - 18/08/2010 Sinh mã TSL
          if (!this.thuebao.tsl.txtMaTSL.Text || this.thuebao.tsl.txtMaTSL.Text == '') this.SinhMaDVVT()
          break
      }
    },
    async TaoDuLieu_HDTB_TSL(themmoi) {
      let kt_tram_capport = 0
      await API.post_huonggiao_ldv(this.axios, {
        quytrinh_id: this.quytrinh_tn,
        loaidv_dich_id: LOAI_DV.TRAM_CAP_PORT
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          kt_tram_capport = 1
        }
      })

      this.dsHDTB_TSL = []
      let rowHDTB_TSL = {}
      let row = {}

      for (var i = 0; i < 2; i++) {
        rowHDTB_TSL = {}
        rowHDTB_TSL.HDTB_ID = this.hdtb_id
        rowHDTB_TSL.DAUCUOI_ID = i + 1
        rowHDTB_TSL.MA_PL = this.thuebao.tsl.txtMaHD_TTKD_TSL ? this.thuebao.tsl.txtMaHD_TTKD_TSL.trim() : ''
        rowHDTB_TSL.TOCDO_ID = this.listbox.tocdokenh.valuetsl //Convert.ToInt32(cboTocDoKenhTSL.EditValue);
        rowHDTB_TSL.LOAIKENH_ID = this.listbox.loaikenh.valuetsl //Convert.ToInt32(cboLoaiKenhTSL.SelectedValue);
        rowHDTB_TSL.THOIHAN_ID = this.listbox.thoihan.valuetsl //Convert.ToInt32(cboThoiHan_TSL.SelectedValue);
        rowHDTB_TSL.TRANGBI_ID = this.listbox.trangbi.valuetsl //Convert.ToInt32(cboTrangBi.SelectedValue);
        rowHDTB_TSL.CHUQUAN_ID = this.listbox.chu_quan.valuetsl //Convert.ToInt32(cboChuQuan_TSL.EditValue);

        if (this.KetCuoi_ID > 0) rowHDTB_TSL.KETCUOI_ID = this.KetCuoi_ID

        if (this.listbox.congnghe.value > 0) rowHDTB_TSL.CONGNGHE_ID = this.listbox.congnghe.value
        //Convert.ToInt32(cboCongNghe.SelectedValue);
        else rowHDTB_TSL.CONGNGHE_ID = null //SetCONGNGHE_IDNull();

        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.CAPQUANG_TRANG_TSL) {
          if (this.thuebao.tsl.txtSoSoiQuang) rowHDTB_TSL.SL_SOIQUANG = this.thuebao.tsl.txtSoSoiQuang
          else rowHDTB_TSL.SL_SOIQUANG = null //SetSL_SOIQUANGNull();
        } else rowHDTB_TSL.SL_SOIQUANG = null //SetSL_SOIQUANGNull();

        row = {} //dsHDTBDV.HDTB_DV.NewHDTB_DVRow();
        row.HDTB_ID = this.hdtb_id
        row.LOAIDV_ID = LOAI_DV.TRAM_VT
        row.KIEUDV_ID = i + 1

        if (this.listbox.doitactsl.chkDoiTacTSL) {
          rowHDTB_TSL.DOITAC_ID = this.listbox.doitactsl.value //Convert.ToInt32(cboDoiTacTSL.SelectedValue);
          if (this.thuebao.tsl.txtCuocTKDT_TSL) rowHDTB_TSL.CUOC_TKDT = this.thuebao.tsl.txtCuocTKDT_TSL
          //Convert.ToDecimal(Common.Utilities.CommonFunction.Unformat_tien(txtCuocTKDT_TSL.Text));
          else rowHDTB_TSL.CUOC_TKDT = 0
          if (this.thuebao.tsl.txtCuocTCDT_TSL) rowHDTB_TSL.CUOC_TCDT = this.thuebao.tsl.txtCuocTCDT_TSL
          //Convert.ToDecimal(Common.Utilities.CommonFunction.Unformat_tien(txtCuocTCDT_TSL.Text));
          else rowHDTB_TSL.CUOC_TCDT = 0

          rowHDTB_TSL.MAHD_DT = this.thuebao.tsl.txtMaHD_DT_TSL ? this.thuebao.tsl.txtMaHD_DT_TSL.trim() : this.thuebao.tsl.txtMaHD_DT_TSL //txtMaHD_DT_TSL.Text.Trim();
        }

        if (this.thuebao.cvlct) {
          rowHDTB_TSL.MA_CV = this.thuebao.congvan ? this.thuebao.congvan.trim() : ''
          rowHDTB_TSL.NGAY_CV = this.thuebao.NgayCV
        }

        rowHDTB_TSL.MA_CRM = this.thuebao.crm ? this.thuebao.crm.trim() : ''
        rowHDTB_TSL.ID_ERP = this.thuebao.erp ? this.thuebao.erp.trim() : ''
        rowHDTB_TSL.MAKENH_VTN = this.thuebao.vtn ? this.thuebao.vtn.trim() : ''

        if (this.thuebao.tsl.txtCuocHT_TSL) rowHDTB_TSL.CUOC_HT = this.thuebao.tsl.txtCuocHT_TSL
        //Convert.ToDecimal(Common.Utilities.CommonFunction.Unformat_tien(txtCuocHT_TSL.Text));
        else rowHDTB_TSL.CUOC_HT = 0

        if (this.thuebao.tsl.txtCuocTBI_TSL) rowHDTB_TSL.CUOC_TBI = this.thuebao.tsl.txtCuocTBI_TSL
        //Convert.ToDecimal(Common.Utilities.CommonFunction.Unformat_tien(txtCuocTBI_TSL.Text));
        else rowHDTB_TSL.CUOC_TBI = 0

        if (this.thuebao.tsl.txtCuocTC_TSL) rowHDTB_TSL.CUOC_TC = this.thuebao.tsl.txtCuocTC_TSL
        //Convert.ToDecimal(Common.Utilities.CommonFunction.Unformat_tien(txtCuocTC_TSL.Text));
        else rowHDTB_TSL.CUOC_TC = 0

        if (this.thuebao.tsl.txtCuocTK_TSL) rowHDTB_TSL.CUOC_TK = this.thuebao.tsl.txtCuocTK_TSL
        //Convert.ToDecimal(Common.Utilities.CommonFunction.Unformat_tien(txtCuocTK_TSL.Text));
        else rowHDTB_TSL.CUOC_TK = 0

        if (i == 0) {
          //Nếu là điểm đầu
          rowHDTB_TSL.DIACHI = this.diachiDau.DIACHI
          rowHDTB_TSL.DIACHI_ID = this.thuebao.tsl.diachidau_id
          rowHDTB_TSL.KINHDO_LD = this.diachiDau.Lng
          rowHDTB_TSL.VIDO_LD = this.diachiDau.Lat
          rowHDTB_TSL.MA_TB_SUB = this.thuebao.tsl.txtMaTSL.Text ? this.thuebao.tsl.txtMaTSL.Text.trim() + '_01' : this.thuebao.tsl.txtMaTSL.Text
          rowHDTB_TSL.MA_LT = this.ma_tb_ao_ht
          if(!this.listbox.donvi_dau.value && this.listbox.donvi_dau.value!=0) {
            throw "Chưa chọn đơn vị đầu. Vui lòng kiểm tra lại thông tin!"
          }
          row.DONVI_ID = this.listbox.donvi_dau.value //Convert.ToInt32(cboVetinhTSL_Dau.SelectedValue);
          this.dsHDTBDV.push(row)
          if (kt_tram_capport == 1) {
            row = {}
            row.HDTB_ID = this.hdtb_id
            row.LOAIDV_ID = LOAI_DV.TRAM_CAP_PORT
            row.KIEUDV_ID = i + 1
            row.DONVI_ID = this.listbox.donvi_dau.value //Convert.ToInt32(cboVetinhTSL_Dau.SelectedValue);
            this.dsHDTBDV.push(row)
          }

          rowHDTB_TSL.THIETBIDC_ID = this.listbox.loai_tb.valuedau //Convert.ToInt32(cboLoaiTBTSL_Dau.SelectedValue);
          rowHDTB_TSL.LOAICAP_ID = this.listbox.loaicap.valuedau //Convert.ToInt32(cboLoaiCap_Dau.SelectedValue);
          rowHDTB_TSL.SITE_ID = this.thuebao.tsl.txtSiteIDTSL_Dau ? this.thuebao.tsl.txtSiteIDTSL_Dau.trim() : ''
          rowHDTB_TSL.VRF = this.thuebao.tsl.txtVrf_Dau ? this.thuebao.tsl.txtVrf_Dau.trim() : ''
          //rowHDTB_TSL.SO_DT = txtSoDTDau.Text;
        } else {
          rowHDTB_TSL.DIACHI = this.diachiCuoi.DIACHI
          rowHDTB_TSL.DIACHI_ID = this.thuebao.tsl.diachicuoi_id
          rowHDTB_TSL.KINHDO_LD = this.diachiCuoi.Lng
          rowHDTB_TSL.VIDO_LD = this.diachiCuoi.Lat
          rowHDTB_TSL.MA_TB_SUB = this.thuebao.tsl.txtMaTSL.Text ? this.thuebao.tsl.txtMaTSL.Text.trim() + '_02' : this.thuebao.tsl.txtMaTSL.Text
          rowHDTB_TSL.MA_LT = this.ma_tb_ao_ht_cuoi

          if(!this.listbox.donvi_cuoi.value && this.listbox.donvi_cuoi.value!=0) {
            throw "Chưa chọn đơn vị cuối. Vui lòng kiểm tra lại thông tin!"
          }
          row.DONVI_ID = this.listbox.donvi_cuoi.value //Convert.ToInt32(cboVetinhTSL_Cuoi.SelectedValue);
          this.dsHDTBDV.push(row)
          if (kt_tram_capport == 1) {
            row = {}
            row.HDTB_ID = this.hdtb_id
            row.LOAIDV_ID = LOAI_DV.TRAM_CAP_PORT
            row.KIEUDV_ID = i + 1
            row.DONVI_ID = this.listbox.donvi_cuoi.value //Convert.ToInt32(cboVetinhTSL_Cuoi.SelectedValue);
            this.dsHDTBDV.push(row)
          }

          rowHDTB_TSL.THIETBIDC_ID = this.listbox.loai_tb.valuecuoi //Convert.ToInt32(cboLoaiTBTSL_Cuoi.SelectedValue);
          rowHDTB_TSL.LOAICAP_ID = this.listbox.loaicap.valuecuoi //Convert.ToInt32(cboLoaiCap_Cuoi.SelectedValue);
          rowHDTB_TSL.SITE_ID = this.thuebao.tsl.txtSiteIDTSL_Cuoi ? this.thuebao.tsl.txtSiteIDTSL_Cuoi.trim() : ''
          rowHDTB_TSL.VRF = this.thuebao.tsl.txtVrf_Cuoi ? this.thuebao.tsl.txtVrf_Cuoi.trim() : ''
          //rowHDTB_TSL.SO_DT = txtSoDTCuoi.Text;
        }
        if (!themmoi) rowHDTB_TSL.MA_VNPT = this.ma_vnpt

        this.dsHDTB_TSL.push(rowHDTB_TSL)
      }

      // if (themmoi == false)
      // {
      //     dsHDTB_TSL.AcceptChanges();
      //     dsHDTB_TSL.HDTB_TSL.Rows[0].SetModified();
      //     dsHDTB_TSL.HDTB_TSL.Rows[1].SetModified();
      // }

      //Tạo cho bảng hdtb_dv
      // //Với Truyền số liệu thì tự thêm các dòng # trạm viễn thông
      for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {
        if (this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0 != LOAI_DV.TRAM_VT) {

          if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
            throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
            return;
          }
          let row = {}
          row.HDTB_ID = this.hdtb_id
          row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
          row.DONVI_ID = this.DT_CONTROLS.value[i]
          row.KIEUDV_ID = 2
          this.dsHDTBDV.push(row)
        }
      }
      //End
    },
    btnSoAoTSL_Click() {
      try {
        if (this.listbox.dichvu_vt.value != DichVuVienThong.CO_DINH) {
          if (this.diachiDau.QUAN_ID == 0 || this.diachiDau.PHUONG_ID == 0) {
            this.$toast.error('Bạn chưa chọn địa chỉ điểm đầu !')
            // txtDiaChiDau.Focus();
            return
          }

          this.popupComponent = () => import('./Popups/popupChonSM')
          this.popupComponentName = 'popupChonSMTSLDau'
          this.popupComponentData = {
            _tinh_id: this.diachiDau.TINH_ID,
            _quan_id: this.diachiDau.QUAN_ID,
            _phuong_id: this.diachiDau.PHUONG_ID,
            _loaiso_id: LOAISO.AO,
            _thueso: false,
            loaitb_id: this.listbox.loaihinh_tb.value,
            dichvuvt_id: this.listbox.dichvu_vt.value,
            hdkh_id: this.khachhang.hdkh_id,
            donvi_ql_id: this.thuebao.tsl.donvi_dau_id //this.listbox.donvi_ql.value//ql (lay field don vi lap dat.)
          }
          this.Popup('popupComponents')
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    btnSoAoTSL_Cuoi_Click() {
      try {
        if (this.listbox.dichvu_vt.value != DichVuVienThong.CO_DINH) {
          if (this.diachiCuoi.QUAN_ID == 0 || this.diachiCuoi.PHUONG_ID == 0) {
            this.$toast.error('Bạn chưa chọn địa chỉ điểm cuối !')
            // txtDiaChiDau.Focus();
            return
          }

          this.popupComponent = () => import('./Popups/popupChonSM')
          this.popupComponentName = 'popupChonSMTSLCuoi'
          this.popupComponentData = {
            _tinh_id: this.diachiCuoi.TINH_ID,
            _quan_id: this.diachiCuoi.QUAN_ID,
            _phuong_id: this.diachiCuoi.PHUONG_ID,
            _loaiso_id: LOAISO.AO,
            _thueso: false,
            loaitb_id: this.listbox.loaihinh_tb.value,
            dichvuvt_id: this.listbox.dichvu_vt.value,
            hdkh_id: this.khachhang.hdkh_id,
            donvi_ql_id: this.thuebao.tsl.donvi_cuoi_id //this.listbox.donvi_cuoi.value,//this.listbox.donvi_ql.value//ql (lay field don vi lap dat.)
          }
          this.Popup('popupComponents')
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async SINH_MATB_DICHVU_DOITAC() {
      let pdata = {
        vchuquan_id: 85,
        vdichvuvt_id: this.listbox.dichvu_vt.value,
        vloaitb_id: this.listbox.loaihinh_tb.value
      }
      switch (pdata.vdichvuvt_id * 1) {
        case DichVuVienThong.BRCD_DOITAC:
          pdata.vchuquan_id = this.listbox.chu_quan.valueadsl
          break
        case DichVuVienThong.IMS_DOITAC:
          pdata.vchuquan_id = this.listbox.chu_quan.valueims
          break
        case DichVuVienThong.MGW_DOITAC:
          pdata.vchuquan_id = this.listbox.chu_quan.valuewan
          break
        case DichVuVienThong.TSL_DOITAC:
          pdata.vchuquan_id = this.listbox.chu_quan.valuetsl
          break
      }
      await API.post_sinh_matb_doitac(this.axios, pdata).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          if (response.data.data != '' && response.data.data != -1)
            switch (pdata.vdichvuvt_id * 1) {
              case DichVuVienThong.BRCD_DOITAC:
                this.thuebao.adsl.txtAccountADSL = response.data.data
                break
              case DichVuVienThong.IMS_DOITAC:
                this.thuebao.ims.txtMaTBIMS = response.data.data
                break
              case DichVuVienThong.MGW_DOITAC:
                this.thuebao.mgwan.somay = response.data.data
                break
              case DichVuVienThong.TSL_DOITAC:
                this.thuebao.tsl.txtMaTSL.Text = response.data.data
                break
            }
        }
      })
    },
    btnGphone_Click() {
      if (!this.diachiLD.QUAN_ID || this.diachiLD.QUAN_ID == 0 || !this.diachiLD.PHUONG_ID || this.diachiLD.PHUONG_ID == 0) {
        this.$toast.error('Bạn chưa chọn địa chỉ lắp đặt !')
        return
      }
      this.popupComponent = () => import('./Popups/popupChonSM')
      this.popupComponentName = 'popupChonSoMayGphone'
      this.popupComponentData = {
        _tinh_id: this.diachiLD.TINH_ID,
        _quan_id: this.diachiLD.QUAN_ID,
        _phuong_id: this.diachiLD.PHUONG_ID,
        _loaiso_id: LOAISO.THUONG,
        _thueso: false,
        loaitb_id: this.listbox.loaihinh_tb.value,
        dichvuvt_id: this.listbox.dichvu_vt.value,
        hdkh_id: this.khachhang.hdkh_id,
        donvi_ql_id: this.listbox.donvi_ql.value //ql (lay field don vi lap dat.)
      }
      this.Popup('popupComponents')
    },
    async TaoDuLieu_HDTB_GP() {
      this.dsHDTB_GP = []
      let rowHDTB_GP = {}

      rowHDTB_GP.HDTB_ID = this.hdtb_id
      rowHDTB_GP.SIMCARD = this.thuebao.gphone.txtSoSimGphone
      rowHDTB_GP.MC_TBGP_ID = this.thuebao.gphone.checkVSVX ? 1 : 0 // checkbox an

      if (this.listbox.congnghe.value > 0) rowHDTB_GP.CONGNGHE_ID = this.listbox.congnghe.value
      else rowHDTB_GP.CONGNGHE_ID = null

      rowHDTB_GP.TRANGBI_ID = this.listbox.trangbi.valuegp
      rowHDTB_GP.CHUQUAN_ID = this.listbox.chu_quan.valuegp
      this.dsHDTB_GP.push(rowHDTB_GP)
      // if (themmoi == false)
      // {
      //     dsHDTB_GP.AcceptChanges();
      //     dsHDTB_GP.HDTB_GP.Rows[0].SetModified();
      // }

      //Tạo cho bảng hdtb_dv
      for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

        if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
          throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
          return;
        }
        let row = {}
        row.HDTB_ID = this.hdtb_id
        row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
        row.DONVI_ID = this.DT_CONTROLS.value[i]
        row.KIEUDV_ID = 2
        this.dsHDTBDV.push(row)
      }
      //End
    },
    async cboTrangBiGphone_SelectedValueChanged() {
      if (!this.listbox.trangbi.list || this.listbox.trangbi.list.length <= 0 || !this.listbox.trangbi.valuetsl || this.listbox.trangbi.valuetsl <= 0) return
      this.trangbi_id = this.listbox.trangbi.valuetsl
      if (!this.kt_load) {
        this.HT_DS_KhuyenMai_Combobox()
        this.LayTienTheoKhoanMuc()
      }
    },
    btnChonSoIMS_Click() {
      if (!this.diachiLD.QUAN_ID || this.diachiLD.QUAN_ID == 0 || !this.diachiLD.PHUONG_ID || this.diachiLD.PHUONG_ID == 0) {
        this.$toast.error('Bạn chưa chọn địa chỉ lắp đặt !')
        return
      }
      this.popupComponent = () => import('./Popups/popupChonSM')
      this.popupComponentName = 'popupChonSoMayIMS'
      this.popupComponentData = {
        _tinh_id: this.diachiLD.TINH_ID,
        _quan_id: this.diachiLD.QUAN_ID,
        _phuong_id: this.diachiLD.PHUONG_ID,
        _loaiso_id: LOAISO.THUONG,
        _thueso: false,
        loaitb_id: this.listbox.loaihinh_tb.value,
        dichvuvt_id: this.listbox.dichvu_vt.value,
        hdkh_id: this.khachhang.hdkh_id,
        donvi_ql_id: this.listbox.donvi_ql.value //ql (lay field don vi lap dat.)
      }
      this.Popup('popupComponents')
    },
    async TaoDuLieu_HDTB_IMS(themmoi) {
      this.dsHDTB_IMS = []
      let rowHDTB_IMS = {}
      rowHDTB_IMS.HDTB_ID = this.hdtb_id
      let pdata = { KIEULD_ID: this.listbox.kieu_ld.value, MADOICAP_IMS: this.thuebao.ims.txtMaDoiCap_IMS ? this.thuebao.ims.txtMaDoiCap_IMS : 0, THEMMOI: themmoi?1:0 }
      let apidata = {}
      await API.post_fn_lay_tt_taodl_hdtb_ims(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            this.$toast.error(apidata['MESSAGE'])
            throw apidata['MESSAGE'];
            return
          }
          apidata = apidata['RESULT']
        }
      })
      if (apidata['MADOICAP']) this.thuebao.ims.txtMaDoiCap_IMS = apidata['MADOICAP']
      rowHDTB_IMS.MADOICAP = this.thuebao.ims.txtMaDoiCap_IMS
      rowHDTB_IMS.THOIHAN_ID = this.listbox.thoihan.valueims

      if (this.listbox.congnghe.value > 0) rowHDTB_IMS.CONGNGHE_ID = this.listbox.congnghe.value
      else rowHDTB_IMS.CONGNGHE_ID = null

      if (this.thuebao.ims.chkDoiTac_IMS) {
        rowHDTB_IMS.DOITAC_ID = this.listbox.doitac.valueims
        if (this.thuebao.ims.txtCuocDT_IMS) rowHDTB_IMS.CUOC_DOITAC = this.thuebao.ims.txtCuocDT_IMS
        else rowHDTB_IMS.CUOC_DOITAC = 0
      } else {
        rowHDTB_IMS.DOITAC_ID = null
        rowHDTB_IMS.CUOC_DOITAC = null
      }

      rowHDTB_IMS.MATB_TN = this.thuebao.ims.txtMaTN_IMS
      rowHDTB_IMS.TRANGBI_ID = this.listbox.trangbi.valueims

      // BangThamSo bts = new BangThamSo();
      // DataTable _dt = bts.getDataFromSQL("select dauso_ims from " + DatabaseConstants.DB2 + ".tinh where tentat = '" + DatabaseConstants.DB2.Substring(4) + "'", "tinh").Tables[0];
      rowHDTB_IMS.USERNAME = '84' + (apidata['DAUSO_IMS'] ? apidata['DAUSO_IMS'] : '') + this.ma_tb_ht.toLowerCase()
      if (themmoi == true) {
        //Chốt all tỉnh mật khẩu sinh theo dạng độ dài 10 ký tự
        this.thuebao.ims.pass_ims = ''
        this.thuebao.ims.pass_ims = this.GetRandomText(10)
      }
      rowHDTB_IMS.PASSWORD = this.thuebao.ims.pass_ims

      rowHDTB_IMS.CHUQUAN_ID = this.listbox.chu_quan.valueims
      rowHDTB_IMS.CHUQUANLD_ID = this.listbox.chu_quan.valueldims
      rowHDTB_IMS.TINHKHAC = apidata['TINHKHACH']
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IMS_SIPTRUNKING) {
        rowHDTB_IMS.SL_CUOCGOI = this.thuebao.ims.txtCuocGoiDT
        rowHDTB_IMS.CTDV_ID = this.listbox.ht_chitietdv_ims.value //Convert.ToInt32(cboChiTietDV.SelectedValue);
        if (this.listbox.ht_chitietdv_ims.value == ChiTietDV_IMS.internet) rowHDTB_IMS.IP = this.thuebao.ims.txtIp_IMS ? this.thuebao.ims.txtIp_IMS.trim() : null

        if (this.thuebao.ims.cbkTrunk) rowHDTB_IMS.TRUNKID = this.thuebao.ims.cboTrunk
        rowHDTB_IMS.HTTC_ID = this.listbox.hinhthuc_tc.valueims
      } else {
        rowHDTB_IMS.SL_CUOCGOI = null
        rowHDTB_IMS.CTDV_ID = null
        rowHDTB_IMS.IP = null
      }
      if (!themmoi) rowHDTB_IMS.MA_VNPT = this.ma_vnpt

      this.dsHDTB_IMS.push(rowHDTB_IMS)

      // if (themmoi == false)
      // {
      //     dsHDTB_IMS.AcceptChanges();
      //     dsHDTB_IMS.HDTB_IMS.Rows[0].SetModified();
      // }

      //Tạo cho bảng hdtb_dv
      for (var i = 0; i < this.DT_CONTROLS.list.length; i++) {

        if(!this.DT_CONTROLS.value[i] || !this.DT_DV(i) || !this.DT_DV(i).find(x=>x.id==this.DT_CONTROLS.value[i])) {
          throw `Chưa có thông tin ${this.DT_CONTROLS.list[i].TEN_LOAIDV}. Vui lòng chọn hoặc báo với quản trị viên nếu không có dữ liệu để chọn!`;
          return;
        }
        let row = {}
        row.HDTB_ID = this.hdtb_id
        row.LOAIDV_ID = this.DT_CONTROLS.list[i].LOAIDV_DICH_ID ? this.DT_CONTROLS.list[i].LOAIDV_DICH_ID : 0
        row.DONVI_ID = this.DT_CONTROLS.value[i]
        row.KIEUDV_ID = 2
        this.dsHDTBDV.push(row)
      }
      //End
    },

    generateUUID() {
      // Public Domain/MIT
      let d = new Date().getTime() //Timestamp
      let d2 = (typeof performance !== 'undefined' && performance.now && performance.now() * 1000) || 0 //Time in microseconds since page-load or 0 if unsupported
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        let r = Math.random() * 16 //random number between 0 and 16
        if (d > 0) {
          //Use timestamp until depleted
          r = (d + r) % 16 | 0
          d = Math.floor(d / 16)
        } else {
          //Use microseconds since page-load if supported
          r = (d2 + r) % 16 | 0
          d2 = Math.floor(d2 / 16)
        }
        return (c === 'x' ? r : (r & 0x3) | 0x8).toString(16)
      })
    },
    GetRandomText(length) {
      let uniqueID = this.generateUUID()
      let randString = ''
      var j = 0
      for (var i = 0; i < uniqueID.length && j < length; i++) {
        let l_ch = uniqueID[i]
        if ((l_ch >= 'A' && l_ch <= 'Z') || (l_ch >= 'a' && l_ch <= 'z') || (l_ch >= '0' && l_ch <= '9')) {
          randString += l_ch
          j++
        }
      }
      return randString
    },
    btnMaTN_IMS_Click() {
      let dulieu = {}
      let kieu = this.kieu_ld_kieu
      switch (kieu * 1) {
        case 2:
          if (this.khachhang.khachhang_id && this.khachhang.khachhang_id > 0) {
            dulieu.khachhang_id = this.khachhang.khachhang_id
            dulieu.kieuld_id = this.listbox.kieu_ld.value
            dulieu.loaitb_id = this.listbox.loaihinh_tb.value
            dulieu.dichvuvt_id = this.listbox.dichvu_vt.value
            this.popupComponentData = dulieu
            this.popupComponent = () => import('./Popups/popupDSTBCungDoiCap')
            this.popupComponentName = 'popupDSTBCungDoiCapIMS'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp trên đường có sẵn !')
            return
          }
          break
        case 1:
          if (this.khachhang.hdkh_id && this.khachhang.hdkh_id > 0) {
            dulieu.hdkh_id = this.khachhang.hdkh_id
            dulieu.vkhachhang_id = this.khachhang.khachhang_id
            dulieu.vkieuld_id = this.listbox.kieu_ld.value
            dulieu.loaitb_id = this.listbox.loaihinh_tb.value
            this.popupComponentData = dulieu
            this.popupComponent = () => import('./Popups/popupDSTBLapKem')
            this.popupComponentName = 'popupDSTBLapKemIMS'
          } else {
            this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp kèm !')
            return
          }
          break
        case 4:
          dulieu.loaitb_id = this.listbox.loaihinh_tb.value
          dulieu.kieuld_id = this.listbox.kieu_ld.value
          this.popupComponentData = dulieu
          this.popupComponent = () => import('./Popups/popupDSTBCungDoiCap_KH_Khac')
          this.popupComponentName = 'popupDSTBCungDoiCap_KH_KhacIMS'
          break
      }
      this.Popup('popupComponents')
    },
    async TaoDuLieu_HDTB_DD(themmoi) {
      this.dsHDTB_DD = []
      let rowHDTB_DD = {}

      rowHDTB_DD.HDTB_ID = this.hdtb_id
      rowHDTB_DD.SIMCARD = this.thuebao.didong.txtSimDD
      rowHDTB_DD.TIEN_DTK = this.thuebao.didong.txtTienDuTK
      rowHDTB_DD.GOICUOC_ID = this.thuebao.didong.cboGoiCuocDD.value //HungHM - Them column GOICUOC_ID

      rowHDTB_DD.SOMAY_NTK = this.thuebao.didong.txtSoMayDD //HungHM - Them column SOMAY_NTK
      rowHDTB_DD.TRANGBI_ID = this.listbox.trangbi.valuedd

      rowHDTB_DD.GHICHU = this.thuebao.ghichu //txtGhiChuTB.Text;

      this.dsHDTB_DD.push(rowHDTB_DD)
      // if (themmoi == false)
      // {
      //     dsHDTB_DD.AcceptChanges();
      //     dsHDTB_DD.HDTB_DD.Rows[0].SetModified();
      // }
    },
    async Insert_HDLD_VinaPhone() {
      let kt_dulieu_vina = 0 // FIXME de tam, day la bien global
      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      // var taohdkh = false;
      // var _dshdkh = JSON.parse(JSON.stringify(this.dsHDKH));
      // var dsHDKH = JSON.parse(JSON.stringify(this.dsHDKH));
      // if(!this.dsHDKH || this.dsHDKH.length<=0) {
      //   taohdkh = true;
      //   await this.TaoDuLieu_HDKH(false);
      //   dsHDKH =
      // }
      let defNull = 'Phải chọn loại thuê bao di động trả sau'
      if (!this.listbox.dichvu_vt.value || this.listbox.dichvu_vt.value != DichVuVienThong.DI_DONG) return defNull
      if (!this.listbox.loaihinh_tb.value || this.listbox.loaihinh_tb.value != LoaiHinhTB.DIDONGTRASAU) return defNull
      let pdata = {
        KIEULD_ID: this.listbox.kieu_ld.value,
        QUANTT_ID: this.diachiTT.QUAN_ID,
        PHUONGTT_ID: this.diachiTT.PHUONG_ID,
        PHOTT_ID: this.diachiTT.PHO_ID,
        QUANLD_ID: this.diachiLD.QUAN_ID,
        PHUONGLD_ID: this.diachiLD.PHUONG_ID,
        DONVI_TT_ID: this.dsHDTT[0]['donvi_id'.toUpperCase()],
        GOICUOC_ID: this.dsHDTB_DD[0]['goicuoc_id'.toUpperCase()],
        HTTT_ID: this.dsHDTT[0]['httt_id'.toUpperCase()],
        LOAIGT_ID: this.dsHDKH[0]['loaigt_id'.toUpperCase()],
        QUOCTICH_ID: this.listbox.quoctich.value,
        MA_NVTV: this.thanhtoan.manvtc,
        MA_TT: this.dsHDTT[0]['ma_tt'.toUpperCase()],
        QUANKH_ID: this.diachiKH.QUAN_ID,
        PHUONGKH_ID: this.diachiKH.PHUONG_ID,
        PHOKH_ID: this.diachiKH.PHO_ID,
        TNC2_ID: this.dsHDKH[0]['tnc2_id'.toUpperCase()] ? this.dsHDKH[0]['tnc2_id'.toUpperCase()] : 1,
        NGANHANG_ID: this.dsHDTT[0]['nganhang_id'.toUpperCase()],
        CTV_ID: this.ctv_id,
        LOAIKH_ID: this.dsHDKH[0]['loaikh_id'.toUpperCase()]
      }
      let apidata = {}
      await API.post_fn_lay_tt_hdld_vinaphone(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            defNull = apidata['MESSAGE']
            kt_dulieu_vina = 1
            return
          }
          apidata = apidata['RESULT']
        }
      })
      if (kt_dulieu_vina == 1) return defNull
      // CheckDataFacade checkdata = new CheckDataFacade();
      // VINAService vina = new VINAService();
      if (!this.tt_nd.user_neo || this.tt_nd.user_neo == -1) {
        kt_dulieu_vina = 1
        return 'Thông tin người dùng chưa đồng bộ với dữ liệu VinaPhone. Bạn không thể tiếp tục cập nhật dữ liệu.'
      }

      if (this.listbox.kieu_ld.value && this.listbox.kieu_ld.value == KieuLapDat.DM_DIDONG_CHUYEN_TINH) {
        //#region Hòa mạng chuyển tỉnh
        try {
          var inputObj = {}
          inputObj.userid = this.tt_nd.user_neo
          inputObj.dia_chi_bc = this.diachiBC.DIACHI

          inputObj.quanct_id = apidata['QUANCT_ID']
          inputObj.phuongct_id = apidata['PHUONGCT_ID']
          inputObj.phoct_id = apidata['PHOCT_ID']
          inputObj.quanld = apidata['QUANLD_ID']
          inputObj.phuonglapdat_id = apidata['PHUONGLD_ID']
          inputObj.phold = apidata['PHOLD_ID']

          inputObj.dia_chi_ct = this.dsHDTT[0]['diachi_tt'.toUpperCase()]
          inputObj.so_nha_ct = this.diachiTT.SONHA //CommonFunction.ChuanHoa_XML(sonhatt);

          inputObj.quantt_id = inputObj.quanct_id
          inputObj.phuongtt_id = inputObj.phuongct_id
          inputObj.phott_id = inputObj.phoct_id
          inputObj.dia_chi_tt = inputObj.dia_chi_ct
          inputObj.sonha_tt = inputObj.so_nha_ct

          inputObj.mst = this.dsHDTT[0]['mst'.toUpperCase()]
          inputObj.noi_cap = this.dsHDKH[0]['noicap'.toUpperCase()]
          inputObj.inchitiet = '0'
          inputObj.nv_hd = ''
          inputObj.ghi_chu = ''
          inputObj.email_bc = this.thuebao.didong.txtEmailDD
          inputObj.email_hd = this.thuebao.didong.txtEmailDD

          inputObj.loai_dc_bao_cuoc = '0'
          inputObj.kieu_bao_cuoc = '0'
          inputObj.ma_bc = apidata['MA_BC']
          // vuth update 0912 fix ma_bc va nganhang
          inputObj.ngan_hang = '0'
          inputObj.so_tb = '84' + this.dsHDTB[0]['ma_tb'.toUpperCase()]
          inputObj.ma_t = ''
          inputObj.sonha_ld = this.diachiLD.SONHA
          inputObj.nguoi_gt = ''
          inputObj.dia_chi_hd = ''
          inputObj.ma_tinh = this.tt_nd.tentat_ccbs // vuth update 0912
          inputObj.taikhoan = ''

          inputObj.so_giay_to = this.dsHDKH[0]['so_gt'.toUpperCase()]
          if (this.thuebao.didong.cboDTVinaPhone.list.length > 0) {
            inputObj.doi_tuong_su_dung = this.thuebao.didong.cboDTVinaPhone.value
          }
          if (!inputObj.doi_tuong_su_dung) inputObj.doi_tuong_su_dung = '1'
          inputObj.loai_tb = apidata['LOAI_TB']

          inputObj.ten_tt = this.dsHDTT[0]['ten_tt'.toUpperCase()]
          inputObj.dienthoai_ld = this.khachhang.dienthoai

          inputObj.diadiem_tt_id = apidata['DIADIEM_TT_ID']

          inputObj.ten_tb = this.dsHDTB[0]['ten_tb'.toUpperCase()]
          inputObj.chuyenkhoan_id = '0' // vuth update 0912
          inputObj.in_hd_id = '0'

          inputObj.loaigt_id = apidata['LOAIGT_ID']

          inputObj.ngay_cap = this.dsHDKH[0]['ngaycap'.toUpperCase()] && this.dsHDKH[0]['ngaycap'.toUpperCase()].indexOf(' ') > 0 ? this.dsHDKH[0]['ngaycap'.toUpperCase()].split(' ')[0] : this.dsHDKH[0]['ngaycap'.toUpperCase()]

          inputObj.so_sim = this.dsHDTB_DD[0]['simcard'.toUpperCase()]

          inputObj.ngay_sinh = this.dsHDTB[0]['ngay_sn'.toUpperCase()] && this.dsHDTB[0]['ngay_sn'.toUpperCase()].indexOf(' ') > 0 ? this.dsHDTB[0]['ngay_sn'.toUpperCase()].split(' ')[0] : this.dsHDTB[0]['ngay_sn'.toUpperCase()]
          inputObj.doituong_id = inputObj.doi_tuong_su_dung
          inputObj.quoc_tich = apidata['QUOC_TICH'] // vuth update 0912
          inputObj.ma_nv = apidata['MANV_VNP'] //23072020
          inputObj.makh = this.khachhang.makh;
          let rs = {};
          await API.post_ts_laphd_chuyentinh_new_thuebao_cts(this.axios, inputObj).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              rs = response.data.data
              if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;
              //rs.IssSuccessed = true
            }
            rs.Message = rs.Message ? rs.Message : response.data.message
          })
          if (!rs.IssSuccessed) return 'Lỗi xảy ra trong quá trình thêm mới hợp đồng hòa mạng chuyển tỉnh lên Vinaphone.' + rs.Message
        } catch (ex) {
          return 'Lỗi xảy ra trong quá trình thêm mới hợp đồng hòa mạng chuyển tỉnh lên Vinaphone.' + ex
        }
        //this.$toast.success(`Tạo mới hợp đồng hòa mạng chuyển tỉnh ${this.dsHDKH[0]['ma_gd'.toUpperCase()]} trên VinaPhone thành công!`) // Bo thong bao HDLD - 20230906 - chi HuyenTTL de xuat bo
        //#endregion
      } else {
        // #region Hòa mạng mới
        try {
          let thangcamket = this.thuebao.thangck
          if (!thangcamket) {
            return 'Số tháng cam kết không được để trống'
          }
          if (thangcamket != 12 && thangcamket != 24) return 'Số tháng cam kết phải là 12 hoặc 24 tháng'

          var inputObj = {}
          let matt_neo = apidata['MA_TT_NEO']
          if (matt_neo == '-1') matt_neo = this.dsHDTT[0]['ma_tt'.toUpperCase()]

          inputObj.userid = this.tt_nd.user_neo
          inputObj.ma_hd = this.dsHDKH[0]['ma_gd'.toUpperCase()]
          inputObj.ma_kh = matt_neo
          inputObj.ma_cq = ''
          inputObj.coquan = this.dsHDKH[0]['ten_kh'.toUpperCase()]
          inputObj.nguoi_dai_dien = this.dsHDKH[0]['nguoi_dd'.toUpperCase()]
          inputObj.chuc_danh = this.dsHDKH[0]['chucdanh_dd'.toUpperCase()]
          inputObj.dienthoai_lh = this.dsHDKH[0]['so_dt'.toUpperCase()]

          inputObj.quan_id = apidata['QUAN_ID']

          inputObj.phuong_id = apidata['PHUONG_ID']

          inputObj.pho_id = apidata['PHO_ID']
          inputObj.so_nha = this.diachiKH.SONHA
          inputObj.dia_chi_ct = this.dsHDKH[0]['diachi_kh'.toUpperCase()]

          inputObj.dia_chi_tt = this.dsHDTT[0]['diachi_tt'.toUpperCase()]
          inputObj.quan_tt = apidata['QUANTT_ID']
          inputObj.phuongtt_id = apidata['PHUONGTT_ID']
          inputObj.phott_id = apidata['PHOTT_ID']
          inputObj.so_nha_tt = this.diachiTT.SONHA

          inputObj.so_giay_to = this.dsHDKH[0]['so_gt'.toUpperCase()]
          inputObj.ngay_cap_giay_to = this.dsHDKH[0]['ngaycap'.toUpperCase()] && this.dsHDKH[0]['ngaycap'.toUpperCase()].indexOf(' ') > 0 ? this.dsHDKH[0]['ngaycap'.toUpperCase()].split(' ')[0] : this.dsHDKH[0]['ngaycap'.toUpperCase()]
          inputObj.noi_cap_giay_to = this.dsHDKH[0]['noicap'.toUpperCase()]
          inputObj.loaigt_id = apidata['LOAIGT_ID']

          inputObj.ngay_sinh = this.dsHDKH[0]['ngay_sn'.toUpperCase()] && this.dsHDKH[0]['ngay_sn'.toUpperCase()].indexOf(' ') > 0 ? this.dsHDKH[0]['ngay_sn'.toUpperCase()].split(' ')[0] : this.dsHDKH[0]['ngay_sn'.toUpperCase()]
          if (this.dsHDKH[0]['gioitinh'.toUpperCase()])
            // vuth update 23/12
            inputObj.gender = this.dsHDKH[0]['gioitinh'.toUpperCase()] == '0' ? '0' : '1'
          if (!this.dsHDKH[0]['matb_dd'.toUpperCase()]) inputObj.sodaidien = this.dsHDKH[0]['ma_tb'.toUpperCase()]
          else inputObj.sodaidien = this.dsHDKH[0]['matb_dd'.toUpperCase()]

          inputObj.loai_kh = apidata['LOAI_KH']

          inputObj.khach_hang_lon = apidata['KHLON_ID_NEO']
          if (inputObj.khach_hang_lon == -1) inputObj.khach_hang_lon = 1 // loai kh lon ko can vuth update 1405
          inputObj.nganhnghe = apidata['NGANHNGHE']
          inputObj.uutien = '0'

          inputObj.dangky_db_0_1 = '0'
          for (let dvk of this.dsDK_DVKHAC)
            if ([1, 7].indexOf(dvk['dvkhac_id'] * 1) >= 0) {
              inputObj.dangky_db_0_1 = '1'
              break
            }

          inputObj.dangky_tv_0_1 = '0'

          inputObj.dia_diem_tt = apidata['DIADIEM_TT_ID']

          inputObj.ma_bc = apidata['MA_BC']

          inputObj.ten_tt = this.dsHDTT[0]['ten_tt'.toUpperCase()]

          inputObj.ms_thue = this.dsHDTT[0]['mst'.toUpperCase()]
          //inputObj.ngan_hang_id = "";
          //04/05/2020 fix giup Vu-HTH
          if (this.dsHDTT[0]['nganhang_id'.toUpperCase()] && apidata['NGAN_HANG_ID']) inputObj.ngan_hang_id = apidata['NGAN_HANG_ID']
          inputObj.tai_khoan = this.dsHDTT[0]['stk'.toUpperCase()]
          inputObj.ngay_lap_hd = this.dsHDKH[0]['ngay_yc'.toUpperCase()]
          inputObj.ghichu = this.dsHDTT[0]['ghichu'.toUpperCase()]

          inputObj.userid = this.tt_nd.user_neo

          //Lấy id đơn vị quản lý map với CCBS. Ưu tiên lấy id ttkd, nếu ko có thì lấy id của đơn vị ql địa chỉ tt
          inputObj.donvi_ql_id = apidata['DONVI_QL_ID']
          if (inputObj.donvi_ql_id == '-1') {
            inputObj.donvi_ql_id = ''
          }

          //Nhân viên thu cước
          inputObj.ma_nv = apidata['MA_NV']
          if (inputObj.ma_nv == '-1') return 'chưa có dữ liệu manv_vnp trong bảng nhanvien_vnp ứng với ma_nv = ' + this.thanhtoan.manvtc
          //23072020
          else {
            //Nếu là HCM thì mã nv thu cước VNP cộng thêm H
            //if (tt_nd.tentat.ToUpper() == "HCM")
            if (this.tt_nd.tentat_ccbs == 'HCM') {
              // Khong co tentat, chi co ccbs va vasc
              inputObj.ma_nv += 'H'
            }
          }
          inputObj.email = this.thuebao.didong.txtEmailDD

          inputObj.khachang_rui_ro_0_1 = '0'
          inputObj.so_giay_to1 = ''
          inputObj.ngay_cap1 = ''
          inputObj.noi_cap1 = ''
          inputObj.loai_giay_to1 = '1'
          inputObj.chuyen_khoan_id = ''
          inputObj.ky_ten = ''
          let ma_hrm_ctv = ''
          if (this.ctv_id > 0) {
            ma_hrm_ctv = apidata['MA_HRM_CTV']
          }
          inputObj.nguoi_gioi_thieu = ma_hrm_ctv

          inputObj.ma_tuyen = '' //Mã tuyến có thể để trống
          inputObj.thong_tin_tuyen = ''
          inputObj.ma_qhns = ''
          inputObj.ma_tinh = this.tt_nd.tentat_ccbs

          let rs = {} //new CCBSFacade().TS_LAPHD_HOAMANGMOI_LAPHD(inputObj);
          await API.post_ts_laphd_hoamangmoi_laphd(this.axios, inputObj).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              rs = response.data.data
              if((rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) && response.data.message=='Success') rs.IssSuccessed = true;
              //rs.IssSuccessed = response.data.message == 'Success' && rs.result
              // rs.Message = response.data.message
            }
            rs.Message = response.data.message
          })
          //#region log goi api ccbs
          let log_action = 'frmDatMoi.TS_LAPHD_HOAMANGMOI_LAPHD'
          let log_param = `ma_hd_neo=${inputObj.ma_hd}; ma_kh = ${inputObj.ma_kh};user_neo=${inputObj.userid}`
          let log_note = `giá trị trả về từ api: result.IsSucceed=${rs.IssSuccessed}; result.Message=${rs.Message}`
          try {
            await API.post_log_action(this.axios, {
              vphanvung_id: this.$root.token.getPhanVungID(),
              vuser_name: this.$root.token.getUserName(),
              vcomputer_name: await this.$root.token.getIP(),
              vaction_name: log_action,
              vkey_parameter: log_param,
              vserver_name: await this.$root.token.getMachine(),
              vnote: log_note,
              PROCEDURE_NAME: 'ADMIN.QUANTRI_HETHONG.Log_Action'
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              }
            })
            //  DataAccess.LogActions.LogAction(log_action, log_param, log_note);
          } catch (ex) {
            this.$toast.error('Ghi log lên server that bai, log len local log/logfile: ' + log_action + ' ' + log_param + ' ' + log_note)
          }
          //#endregion
          if (!rs.IssSuccessed) return 'Lỗi xảy ra trong quá trình thêm mới hợp đồng di động lên Vinaphone.' + rs.Message
        } catch (ex) {
          return 'Lỗi xảy ra trong quá trình thêm mới hợp đồng di động lên Vinaphone.' + ex
        }
        //this.$toast.success(`Tạo mới hợp đồng hòa mạng ${this.dsHDKH[0]['ma_gd'.toUpperCase()]} trên VinaPhone thành công!`) // Bo thong bao HDLD - 20230906 - chi HuyenTTL de xuat bo
        //#endregion
      }

      return 'OK'
    },
    async Insert_TBLD_VinaPhone() {
      let defNull = ''
      let apidata = {}
      let pdata = {
        KIEULD_ID: this.listbox.kieu_ld.value,
        QUANTT_ID: this.diachiTT.QUAN_ID,
        PHUONGTT_ID: this.diachiTT.PHUONG_ID,
        PHOTT_ID: this.diachiTT.PHO_ID,
        QUANTB_ID: this.diachiTB.QUAN_ID,
        PHUONGTB_ID: this.diachiTB.PHUONG_ID,
        PHOTB_ID: this.diachiTB.PHO_ID,
        QUANLD_ID: this.diachiLD.QUAN_ID,
        PHUONGLD_ID: this.diachiLD.PHUONG_ID,
        DONVI_TT_ID: this.dsHDTT[0]['donvi_id'.toUpperCase()],
        GOICUOC_ID: this.dsHDTB_DD[0]['goicuoc_id'.toUpperCase()],
        HTTT_ID: this.dsHDTT[0]['httt_id'.toUpperCase()],
        LOAIGT_ID: this.dsHDKH[0]['loaigt_id'.toUpperCase()],
        QUOCTICH_ID: this.listbox.quoctich.value,
        MA_NVTV: this.thanhtoan.manvtc,
        MA_TT: this.dsHDTT[0]['ma_tt'.toUpperCase()],
        QUANKH_ID: this.diachiKH.QUAN_ID,
        PHUONGKH_ID: this.diachiKH.PHUONG_ID,
        PHOKH_ID: this.diachiKH.PHO_ID,
        TNC2_ID: this.dsHDKH[0]['tnc2_id'.toUpperCase()] ? this.dsHDKH[0]['tnc2_id'.toUpperCase()] : 1,
        NGANHANG_ID: this.dsHDTT[0]['nganhang_id'.toUpperCase()],
        CTV_ID: this.ctv_id,
        LOAIKH_ID: this.dsHDKH[0]['loaikh_id'.toUpperCase()]
      }
      await API.post_fn_lay_tt_ins_tbld_vnp(this.axios, {
        ds_para: JSON.stringify(pdata)
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code == 'BSS-00000000' && response.data.data != 1) {
          apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            defNull = apidata['MESSAGE']
            return
          }
          apidata = apidata['RESULT']
        }
      })
      if (defNull && defNull != '') return defNull
      let thangcamket = this.thuebao.thangck
      if (!thangcamket) {
        return 'Số tháng cam kết không được để trống'
      }
      if (thangcamket != 12 && thangcamket != 24) return 'Số tháng cam kết phải là 12 hoặc 24 tháng'

      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      let status = false
      try {
        var inputObj = {}

        if (!this.tt_nd.user_neo) return 'Thông tin người dùng chưa đồng bộ với dữ liệu VinaPhone. Bạn không thể tiếp tục cập nhật dữ liệu.'

        //Lấy id đơn vị quản lý map với CCBS. Ưu tiên lấy id ttkd, nếu ko có thì lấy id của đơn vị ql địa chỉ tt
        inputObj.donv_ql_id = apidata['DONVI_QL_ID']
        if (inputObj.donv_ql_id == '-1') inputObj.donv_ql_id = ''

        inputObj.so_nha = this.diachiTB.SONHA
        inputObj.thutu_in = '1'
        inputObj.so_sim = this.dsHDTB_DD[0]['simcard'.toUpperCase()]
        inputObj.so_tb = '84' + this.dsHDTB[0]['ma_tb'.toUpperCase()]

        inputObj.ma_bc = apidata['MA_BC']

        inputObj.donvitc_id = inputObj.donv_ql_id

        inputObj.tra_cuu_trong_db_0_1 = '1'
        inputObj.giapdanh = '1'
        inputObj.dangky_db_0_1 = '0'

        for (var i = 0; i < this.dsDK_DVKHAC.length; i++) {
          if (this.dsDK_DVKHAC[i]['dvkhac_id'] == 1 || this.dsDK_DVKHAC[i]['dvkhac_id'] == 7) {
            inputObj.dangky_db_0_1 = '1'
            break
          }
        }

        inputObj.ten_tb = this.dsHDTB[0]['ten_tb'.toUpperCase()]
        inputObj.thuebao_id = ''
        inputObj.ma_hd = this.dsHDKH.length > 0 ? this.dsHDKH[0]['ma_gd'.toUpperCase()] : this.khachhang.magd ? this.khachhang.magd.trim() : this.khachhang.magd
        inputObj.dia_chi = this.dsHDTB[0]['diachi_tb'.toUpperCase()]
        inputObj.loaitb_id = apidata['LOAITB_ID']
        if (this.thuebao.didong.cboDTVinaPhone.list.length > 0) inputObj.doituong_id = this.thuebao.didong.cboDTVinaPhone.value
        if (!inputObj.doituong_id) inputObj.doituong_id = '1'

        for (let dr of this.ds_tien_khoanmuc) {
          if (dr['khoanmuctt_id'] == KHOANMUC_TT.KMTT_HOAMANG_DD_TRASAU) {
            inputObj.cuoc_ld = dr['tien']
            inputObj.vat_ld = dr['vat']
            break
          }
        }
        let dtTienCCBS = await this.LayTienSoDepDDTraSau('84' + (this.thuebao.didong.txtSoMayDD ? this.thuebao.didong.txtSoMayDD.trim() : this.thuebao.didong.txtSoMayDD))
        inputObj.cuoc_dv = dtTienCCBS[0]['tiendv'] //"0";
        inputObj.vat_dv = dtTienCCBS[0]['tiendvvat'] //(Convert.ToDecimal(inputObj.cuoc_dv) * (decimal)0.1).ToString();

        inputObj.cuoc_ld = dtTienCCBS[0]['giatien']
        inputObj.vat_ld = dtTienCCBS[0]['vat']

        inputObj.loaidb_id = '0'
        inputObj.inchitiet = '0'

        for (var i = 0; i < this.dsDK_DVKHAC.length; i++) {
          if (this.dsDK_DVKHAC[i]['dvkhac_id'] == 2 || this.dsDK_DVKHAC[i]['dvkhac_id'] == 3 || this.dsDK_DVKHAC[i]['dvkhac_id'] == 5) {
            inputObj.inchitiet = '1'
            break
          }
        }
        inputObj.chungloai_id = ''
        inputObj.tienmay = '0'
        inputObj.vat_may = '0'
        inputObj.ghichu = this.dsHDTB[0]['ghichu'.toUpperCase()]

        inputObj.quan_id = apidata['QUAN_ID']
        inputObj.phuong_id = apidata['PHUONG_ID']
        inputObj.pho_id = apidata['PHO_ID']

        inputObj.kieu_ld_id = apidata['KIEULD_ID']
        inputObj.loai_kh = apidata['LOAIKH_ID_NEO']

        inputObj.donvild_id = ''

        if (this.dsKM_HDTB.length > 0) inputObj.khuyenmai_id = this.dsKM_HDTB[0]['khuyenmai_id_neo'.toUpperCase()]
        inputObj.tien_km = '0'
        inputObj.loai_dc_bao_cuoc = '0'
        inputObj.kieu_bao_cuoc = '0'
        inputObj.ma_bao_cuoc = '0'
        inputObj.ngay_sinh = this.dsHDTB[0]['ngay_sn'.toUpperCase()] && this.dsHDTB[0]['ngay_sn'.toUpperCase()].indexOf(' ') > 0 ? this.dsHDTB[0]['ngay_sn'.toUpperCase()].split(' ')[0] : this.dsHDTB[0]['ngay_sn'.toUpperCase()]
        inputObj.kh_doanhnghiep_0_1 = ''

        inputObj.thangcamket = this.thuebao.thangck
        if (!inputObj.thangcamket) return 'Số tháng cam kết không được để trống'
        if (inputObj.thangcamket != 12 && inputObj.thangcamket != 24) return 'Số tháng cam kết phải là 12 hoặc 24 tháng'

        inputObj.ma_tinh = this.tt_nd.tentat_ccbs
        //#region vuth update 0912
        if (this.tt_nd.tentat_ccbs == 'HCM')
          // Khong co tentat, chi co ccbs va vasc
          inputObj.tach_ma = '1'
        else inputObj.tach_ma = '0'
        //#endregion
        inputObj.userid = this.tt_nd.user_neo
        //Edit 20230820 - ThangDM1 - Them theo yeu cau cua CCBS
        inputObj.so_giay_to = this.khachhang.sogt;
        inputObj.loai_giay_to = this.listbox.loai_gt.list.find(x=>x.loaigt_id==this.listbox.loai_gt.value) && this.listbox.loai_gt.list.find(x=>x.loaigt_id==this.listbox.loai_gt.value).loaigt_id_neo?this.listbox.loai_gt.list.find(x=>x.loaigt_id==this.listbox.loai_gt.value).loaigt_id_neo:this.listbox.loai_gt.value;
        inputObj.noi_cap = this.khachhang.noicap;
        inputObj.ngay_cap = this.NgayCap && this.NgayCap.indexOf(' ')>0?this.NgayCap.substring(0,this.NgayCap.indexOf(' ')).trim():this.NgayCap;
        //Edit 20230820 - ThangDM1 - Them theo yeu cau cua CCBS - END
        //inputObj.cuoc_ld = "0"; //vuth update 1505
        //inputObj.vat_ld = "0";
        /////////////////////start tuanla đẹp trai thêm cho MNP/////////////////////
        if (this.listbox.nhacc_cu.ischecked && this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG && this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRASAU) {
          var inputObj_mnp = {}
          inputObj_mnp.bill_limit = inputObj.bill_limit
          inputObj_mnp.chungloai_id = inputObj.chungloai_id
          inputObj_mnp.congvan = inputObj.congvan
          inputObj_mnp.cuoc_dv = inputObj.cuoc_dv
          inputObj_mnp.cuoc_ld = '0'
          inputObj_mnp.dangky_db_0_1 = inputObj.dangky_db_0_1
          inputObj_mnp.dia_chi = inputObj.dia_chi
          inputObj_mnp.dia_chi_thuongtru = inputObj.dia_chi_thuongtru
          inputObj_mnp.doi_tuong_su_dung = inputObj.doi_tuong_su_dung
          inputObj_mnp.doituong_id = inputObj.doituong_id
          inputObj_mnp.donv_ql_id = inputObj.donv_ql_id
          inputObj_mnp.donvild_id = inputObj.donvild_id
          inputObj_mnp.donvitc_id = inputObj.donvitc_id
          inputObj_mnp.dslk = inputObj.dslk
          inputObj_mnp.dssllk = inputObj.dssllk
          inputObj_mnp.dstenlk = inputObj.dstenlk
          inputObj_mnp.email = inputObj.email
          inputObj_mnp.ghichu = inputObj.ghichu
          inputObj_mnp.giapdanh = inputObj.giapdanh
          inputObj_mnp.imei = inputObj.imei
          inputObj_mnp.inchitiet = inputObj.inchitiet
          inputObj_mnp.kh_doanhnghiep_0_1 = inputObj.kh_doanhnghiep_0_1
          inputObj_mnp.khuyenmai_id = inputObj.khuyenmai_id
          inputObj_mnp.kieu_bao_cuoc = inputObj.kieu_bao_cuoc
          inputObj_mnp.kieu_ld_id = inputObj.kieu_ld_id
          inputObj_mnp.loai_dc_bao_cuoc = inputObj.loai_dc_bao_cuoc
          inputObj_mnp.loai_giay_to = inputObj.loai_giay_to
          inputObj_mnp.loai_goi = inputObj.loai_goi
          inputObj_mnp.loai_goi_dk = inputObj.loai_goi_dk
          inputObj_mnp.loai_kh = inputObj.loai_kh
          inputObj_mnp.loaidb_id = inputObj.loaidb_id
          inputObj_mnp.loaitb_id = inputObj.loaitb_id
          inputObj_mnp.ma_bao_cuoc = inputObj.ma_bao_cuoc
          inputObj_mnp.ma_bc = inputObj.ma_bc
          inputObj_mnp.ma_hd = inputObj.ma_hd
          inputObj_mnp.ma_tinh = inputObj.ma_tinh
          inputObj_mnp.month_live = inputObj.month_live
          inputObj_mnp.ngay_cap = inputObj.ngay_cap
          inputObj_mnp.ngay_sinh = inputObj.ngay_sinh
          inputObj_mnp.nhom_mb_vnn = inputObj.nhom_mb_vnn
          inputObj_mnp.noi_cap = inputObj.noi_cap
          inputObj_mnp.pho_id = inputObj.pho_id
          inputObj_mnp.phuong_id = inputObj.phuong_id
          inputObj_mnp.quan_id = inputObj.quan_id
          inputObj_mnp.quoc_tich = inputObj.quoc_tich
          inputObj_mnp.serial = inputObj.serial
          inputObj_mnp.so_giay_to = inputObj.so_giay_to
          inputObj_mnp.so_nha = inputObj.so_nha
          inputObj_mnp.so_sim = inputObj.so_sim
          inputObj_mnp.so_tb = inputObj.so_tb
          inputObj_mnp.tbnhantk = inputObj.tbnhantk
          inputObj_mnp.ten_tb = inputObj.ten_tb
          inputObj_mnp.thangcamket = inputObj.thangcamket
          inputObj_mnp.thuebao_id = inputObj.thuebao_id
          inputObj_mnp.thutu_in = inputObj.thutu_in
          inputObj_mnp.tien_km = inputObj.tien_km
          inputObj_mnp.tienmay = inputObj.tienmay
          inputObj_mnp.tra_cuu_trong_db_0_1 = inputObj.tra_cuu_trong_db_0_1
          inputObj_mnp.upload = inputObj.upload
          inputObj_mnp.userid = inputObj.userid
          inputObj_mnp.vat_dv = inputObj.vat_dv
          inputObj_mnp.vat_ld = '0'
          inputObj_mnp.vat_may = inputObj.vat_may
          inputObj_mnp.tach_ma = inputObj.tach_ma
          let rs = {} //new CCBSFacade().ts_laphd_hoamangmoi_themtb_mnp(inputObj_mnp);
          await API.post_ts_laphd_hoamangmoi_themtb_mnp(this.axios, inputObj_mnp).then((response) => {
            if (response && response.data) {
              //rs = response.data.data;
              if (response.data.message == 'Thuê bao đang được lập hợp đồng hòa mạng mới') {
                this.$toast.error('Thuê bao đã tồn tại trên ccbs! Thuê bao đang được lập hợp đồng hòa mạng mới')
                return
              }
              //rs.IssSuccessed = response.data.error_code == 'BSS-00000000'
              if((rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) && response.data.error_code == 'BSS-00000000') rs.IssSuccessed = true;
              rs.Message = response.data.message;
            }
          })
          if (!rs.IssSuccessed) return rs.Message//response.data.message //rs.Message;
        } else {
          let rs = {} //new CCBSFacade().TS_LAPHD_HOAMANGMOI_THEMTHUEBAO(inputObj);
          //FIXME api nay chua co, dang trao doi voi Ngoc
          await API.ts_laphd_hoamangmoi_themthuebao(this.axios, inputObj).then((response) => {
            if (response && response.data) {
              //rs = response.data.data;
              rs.Message = response.data.message
              if((rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) && response.data.error_code == 'BSS-00000000') rs.IssSuccessed = true;
              if (response.data.message == 'Thuê bao đang được lập hợp đồng hòa mạng mới') {
                this.$toast.error('Thuê bao đã tồn tại trên ccbs! Thuê bao đang được lập hợp đồng hòa mạng mới')
                return rs.Message
              }
              //rs.IssSuccessed = response.data.error_code == 'BSS-00000000'
            }
          })
          // #region log api trả về từ ccbs
          let log_action = 'frmDatMoi.TS_LAPHD_HOAMANGMOI_THEMTHUEBAO '
          let log_param = `ma_hd_neo=${inputObj.ma_hd};so_tb=${inputObj.so_tb};user_neo=${inputObj.userid}`
          let log_note = `giá trị trả về từ api: result.IsSucceed=${rs.IssSuccessed}; result.Message=${rs.Message}`
          try {
            await API.post_log_action(this.axios, {
              vphanvung_id: this.$root.token.getPhanVungID(),
              vuser_name: this.$root.token.getUserName(),
              vcomputer_name: await this.$root.token.getIP(),
              vaction_name: log_action,
              vkey_parameter: log_param,
              vserver_name: await this.$root.token.getMachine(),
              vnote: log_note,
              PROCEDURE_NAME: 'ADMIN.QUANTRI_HETHONG.Log_Action'
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              }
            })
            // DataAccess.LogActions.LogAction(log_action, log_param, log_note);
          } catch (ex) {
            this.$toast.error('Ghi log lên server that bai, log len local log/logfile: ' + log_action + ' ' + log_param + ' ' + log_note)
          }
          // #endregion

          if (!rs.IssSuccessed) return rs.Message
        }
        ////////////////////end tuanla thêm MNP/////////////////////
      } catch (ex) {
        //FIXME 2 cai nay tam thoi chua dung den, comment lai
        // status = false;
        // strError_VinaPhone = ex;
        return 'Tạo hợp đồng CCBS thất bại: ' + ex // Khải nhờ Hoàng thêm dòng này 10/11/2020
      }
      this.$toast.success(`Thêm thuê bao ${this.dsHDTB[0]['ma_tb'.toUpperCase()]} trên VinaPhone thành công!`)
      return 'OK'
    },
    async LayTienSoDepDDTraSau(somay) {
      try {
        let dtTienCcbs = [] //new CCBSFacade().ts_laphd_hoamangmoi_layds_cuocld(tt_nd.tentat_ccbs, "1", somay, tt_nd.USER_NEO);
        await API.post_ts_laphd_hoamangmoi_layds_cuocld(this.axios, {
          ma_tinh: this.tt_nd.tentat_ccbs,
          kieuld_id: '1',
          so_tb: somay,
          userid: this.tt_nd.user_neo
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            dtTienCcbs = response.data.data
            dtTienCcbs = this.LowerCasePropertyList(dtTienCcbs)
          }
        })
        if (dtTienCcbs == null || dtTienCcbs.length == 0 || !dtTienCcbs[0].hasOwnProperty('tiendv') || !dtTienCcbs[0].hasOwnProperty('tiendvvat')) {
          throw 'Có lỗi lấy tiến số đẹp từ ccbs: ts_laphd_hoamangmoi_layds_cuocld'
        }
        return dtTienCcbs
      } catch (ex) {
        this.$toast.error('Có lỗi lấy tiến số đẹp từ ccbs: ts_laphd_hoamangmoi_layds_cuocld')
        throw ex
      }
    },
    async Delete_HDLD_VinaPhone(ma_gd) {
      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      try {
        if (!this.tt_nd.user_neo) return 'Thông tin người dùng chưa đồng bộ với dữ liệu VinaPhone. Bạn không thể tiếp tục cập nhật dữ liệu.'

        let rs = {} //new CCBSFacade().TS_LAPHD_HOAMANGMOI_XOA(this.tt_nd.tentat_ccbs.toUpperCase(), ma_gd, this.tt_nd.user_neo, "");
        await API.post_ts_laphd_hoamangmoi_xoa(this.axios, {
          ma_tinh: this.tt_nd.tentat_ccbs,
          ma_hd: ma_gd,
          rowid: '',
          userid: this.tt_nd.user_neo
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let dtTienCcbs = response.data.data
            if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;
          }
          rs.Message = response.data.message;
        })
        if (!rs.IssSuccessed) return 'Có lỗi xảy ra trong quá trình xóa hợp đồng thuê bao di động trên VinaPhone.\n' + rs.Message
      } catch (ex) {
        return ex + ''
      }
      this.$toast.success(`Xóa hợp đồng ${ma_gd} trên VinaPhone thành công!`)
      return 'OK'
    },
    async Update_HDLD_VinaPhone() {
      let kt_dulieu_vina = 0 // FIXME de tam, day la bien global
      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      let defNull = 'Phải chọn loại thuê bao di động trả sau'
      if (!this.listbox.dichvu_vt.value || this.listbox.dichvu_vt.value != DichVuVienThong.DI_DONG) return defNull
      if (!this.listbox.loaihinh_tb.value || this.listbox.loaihinh_tb.value != LoaiHinhTB.DIDONGTRASAU) return defNull

      let pdata = {
        MA_TT: this.dsHDTT[0]['ma_tt'.toUpperCase()],
        QUANKH_ID: this.diachiKH.QUAN_ID,
        PHUONGKH_ID: this.diachiKH.PHUONG_ID,
        PHOKH_ID: this.diachiKH.PHO_ID,
        DONVI_TT_ID: this.dsHDTT[0]['donvi_id'.toUpperCase()],
        QUANTT_ID: this.diachiTT.QUAN_ID,
        PHUONGTT_ID: this.diachiTT.PHUONG_ID,
        PHOTT_ID: this.diachiTT.PHO_ID,
        LOAIKH_ID: this.dsHDKH[0]['loaikh_id'.toUpperCase()],
        TNC2_ID: this.dsHDKH[0]['tnc2_id'.toUpperCase()] ? this.dsHDKH[0]['tnc2_id'.toUpperCase()] : 1,
        LOAIGT_ID: this.dsHDKH[0]['loaigt_id'.toUpperCase()],
        HTTT_ID: this.dsHDTT[0]['httt_id'.toUpperCase()],
        NGANHANG_ID: this.dsHDTT[0]['nganhang_id'.toUpperCase()]
      }
      let apidata = {}
      await API.post_fn_lay_tt_update_hdld_vnp(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            defNull = apidata['MESSAGE']
            kt_dulieu_vina = 1
            // return
          }
          apidata = apidata['RESULT']
        }
      })
      if (kt_dulieu_vina == 1) return defNull

      try {
        if (!(this.listbox.dichvu_vt.value == DichVuVienThong.DI_DONG && this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRASAU)) {
          return 'Thuê bao không phải là di động trả sau. Không được phép đồng bộ lên CCBS.'
        }

        var inputObj = {}

        inputObj.ma_tinh = this.tt_nd.tentat_ccbs
        inputObj.userid = this.tt_nd.user_neo
        inputObj.ma_hd = this.dsHDKH[0]['ma_gd'.toUpperCase()]
        // vuth update 1405
        inputObj.ma_kh = apidata['MA_KH']
        inputObj.ma_cq = ''

        inputObj.chuc_danh = this.dsHDKH[0]['chucdanh_dd'.toUpperCase()]
        inputObj.nguoi_dai_dien = this.dsHDKH[0]['nguoi_dd'.toUpperCase()]
        inputObj.sonha_tt = this.diachiTT.SONHA
        inputObj.may_cn = await this.$root.token.getMachine()
        inputObj.uutien_id = '0'
        inputObj.mst = this.dsHDTT[0]['mst'.toUpperCase()]
        inputObj.tai_khoan = this.dsHDTT[0]['stk'.toUpperCase()]
        inputObj.dichvuvt_id = '2'
        inputObj.phai = this.dsHDKH[0]['gioitinh'.toUpperCase()] == '0' ? '0' : '1'
        inputObj.ghi_chu = this.dsHDTT[0]['ghichu'.toUpperCase()]

        inputObj.quan_id = apidata['QUAN_ID']

        //Lấy id đơn vị quản lý map với CCBS. Ưu tiên lấy id ttkd, nếu ko có thì lấy id của đơn vị ql địa chỉ tt
        inputObj.donviql_id = apidata['DONVI_QL_ID']
        if (inputObj.donviql_id == '-1') inputObj.donviql_id = ''

        inputObj.tttuyen = this.thanhtoan.matuyen

        inputObj.quantt_id = apidata['QUANTT_ID']
        inputObj.sonha_tt = this.diachiTT.SONHA

        inputObj.so_gt_1 = ''

        inputObj.phott_id = apidata['PHOTT_ID']

        inputObj.noicap_gt = this.dsHDKH[0]['noicap'.toUpperCase()]

        if (!this.dsHDTT[0]['matb_dd'.toUpperCase()]) inputObj.so_daidien = this.dsHDTB[0]['ma_tb'.toUpperCase()]
        else inputObj.so_daidien = this.dsHDTT[0]['matb_dd'.toUpperCase()]

        inputObj.so_gt = this.dsHDKH[0]['so_gt'.toUpperCase()]
        inputObj.ma_t = ''

        inputObj.coquan = this.dsHDKH[0]['ten_kh'.toUpperCase()]
        inputObj.nguoi_dai_dien = this.dsHDKH[0]['nguoi_dd'.toUpperCase()]
        inputObj.dienthoai_ld = this.dsHDKH[0]['so_dt'.toUpperCase()]
        inputObj.quan_id = apidata['QUAN_ID'] // dang thieu o DB, da nho bo sung.
        inputObj.phuong_id = apidata['PHUONG_ID']
        inputObj.pho_id = apidata['PHO_ID'] // dang bi sai ten o DB la PHOTT_ID
        inputObj.so_nha = this.diachiKH.SONHA
        inputObj.diachi_ct = this.dsHDKH[0]['diachi_kh'.toUpperCase()]
        inputObj.so_gt = this.dsHDKH[0]['so_gt'.toUpperCase()]

        inputObj.ngaycap_gt = this.dsHDKH[0]['ngaycap'.toUpperCase()] && (this.dsHDKH[0]['ngaycap'.toUpperCase()] + '').indexOf(' ') > 0 ? this.dsHDKH[0]['ngaycap'.toUpperCase()].split(' ')[0] : this.dsHDKH[0]['ngaycap'.toUpperCase()]
        inputObj.noicap_gt = this.dsHDKH[0]['noicap'.toUpperCase()]
        inputObj.loaigt_id = apidata['LOAIGT_ID']
        inputObj.ngay_sinh = this.dsHDKH[0]['ngay_sn'.toUpperCase()] && this.dsHDKH[0]['ngay_sn'.toUpperCase()].indexOf(' ') > 0 ? this.dsHDKH[0]['ngay_sn'.toUpperCase()].split(' ')[0] : this.dsHDKH[0]['ngay_sn'.toUpperCase()]
        inputObj.dichvuvt_id = '2'
        inputObj.kieu_ld = ''
        if (!this.dsHDTT[0]['matb_dd'.toUpperCase()]) inputObj.so_daidien = this.dsHDTB[0]['ma_tb'.toUpperCase()]
        else inputObj.so_daidien = this.dsHDTT[0]['matb_dd'.toUpperCase()]
        inputObj.loaikh_id = apidata['LOAIKH_ID']
        inputObj.khlon_id = this.dsHDKH[0]['khlon_id'.toUpperCase()]
        inputObj.nganhnghe_id = apidata['NGANHNGHE']
        inputObj.uutien_id = '0'
        inputObj.dangky_db = '0'

        for (var i = 0; i < this.dsDK_DVKHAC.length; i++) {
          if (this.dsDK_DVKHAC[0]['dvkhac_id'.toUpperCase()] == 1 || this.dsDK_DVKHAC[0]['dvkhac_id'.toUpperCase()] == 7) {
            inputObj.dangky_db = '1'
            break
          }
        }
        inputObj.dangky_tv = '0'
        inputObj.diadiemtt_id = apidata['DIADIEM_TT_ID']

        inputObj.ma_bc = apidata['MA_BC']

        inputObj.ten_tt = this.dsHDTT[0]['ten_tt'.toUpperCase()]

        inputObj.diachi_tt = this.dsHDTT[0]['diachi_tt'.toUpperCase()]
        inputObj.quantt_id = apidata['QUANTT_ID']
        inputObj.phuongtt_id = apidata['PHUONGTT_ID']
        inputObj.phott_id = apidata['PHOTT_ID']
        inputObj.sonha_tt = this.diachiTT.SONHA
        inputObj.mst = this.dsHDTT[0]['mst'.toUpperCase()]
        inputObj.nganhang_id = ''
        if (this.dsHDTT[0]['nganhang_id'.toUpperCase()])
          // vuth update 1405
          inputObj.nganhang_id = apidata['NGAN_HANG_ID']
        inputObj.tai_khoan = this.dsHDTT[0]['stk'.toUpperCase()]
        inputObj.ngay_laphd = this.dsHDKH[0]['ngay_yc'.toUpperCase()]
        inputObj.ghi_chu = this.dsHDTT[0]['ghichu'.toUpperCase()]
        inputObj.nguoi_cn = this.$root.token.getNguoiDungID()
        inputObj.may_cn = await this.$root.token.getMachine()

        let rs = {} //new CCBSFacade().TS_LAPHD_HOAMANGMOI_CAPNHAT(inputObj);
        await API.post_ts_laphd_hoamangmoi_capnhat(this.axios, inputObj).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            rs = response.data.data
            if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;

          }
          rs.Message = response.data.message
        })
        if (!rs.IssSuccessed) return 'Có lỗi xảy ra trong quá trình kết nối với Sercvice VinaPhone!\n' + rs.Message
      } catch (ex) {
        return 'Có lỗi xảy ra trong quá trình kết nối với Sercvice VinaPhone!\n' + ex
      }
      // this.$toast.success(`Cập nhật hợp đồng hòa mạng mới ${this.dsHDKH[0]['ma_gd'.toUpperCase()]} lên VinaPhone thành công!`)  // Bo thong bao HDLD - 20230906 - chi HuyenTTL de xuat bo
      return 'OK'
    },
    async Update_TBLD_VinaPhone() {
      let defNull = ''
      let apidata = {}

      let pdata = {
        DONVI_TT_ID: this.dsHDTT[0]['donvi_id'.toUpperCase()],
        GOICUOC_ID: this.dsHDTB_DD[0]['goicuoc_id'.toUpperCase()],
        QUANTB_ID: this.diachiTB.QUAN_ID,
        PHUONGTB_ID: this.diachiTB.PHUONG_ID,
        PHOTB_ID: this.diachiTB.PHO_ID,
        KIEULD_ID: this.listbox.kieu_ld.value,
        LOAIKH_ID: this.dsHDKH[0]['loaikh_id'.toUpperCase()],
        HDKH_ID: this.khachhang.hdkh_id,
        QUOCTICH_ID: this.listbox.quoctich.value
      }
      API.post_fn_lay_tt_update_tbld_vnp(this.axios, {
        ds_para: JSON.stringify(pdata)
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code == 'BSS-00000000' && response.data.data != 1) {
          apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            defNull = apidata['MESSAGE']
            return
          }
          apidata = apidata['RESULT']
        }
      })
      if (defNull && defNull != '') return defNull

      let thangcamket = this.thuebao.thangck
      if (!thangcamket) return 'Số tháng cam kết không được để trống'
      if (thangcamket != 12 && thangcamket != 24) return 'Số tháng cam kết phải là 12 hoặc 24 tháng'

      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      let status = false
      try {
        var inputObj = {}

        if (!this.tt_nd.user_neo) return 'Thông tin người dùng chưa đồng bộ với dữ liệu VinaPhone. Bạn không thể tiếp tục cập nhật dữ liệu.'

        inputObj.ma_tinh = this.tt_nd.tentat_ccbs
        inputObj.userid = this.tt_nd.user_neo
        inputObj.ma_hd = this.dsHDKH[0]['ma_gd'.toUpperCase()]

        //Lấy id đơn vị quản lý map với CCBS. Ưu tiên lấy id ttkd, nếu ko có thì lấy id của đơn vị ql địa chỉ tt
        inputObj.donv_ql_id = apidata['DONVI_QL_ID']
        if (inputObj.donv_ql_id == '-1') inputObj.donv_ql_id = ''

        inputObj.so_nha = this.diachiTB.SONHA
        inputObj.thutu_in = '1'
        inputObj.so_sim = this.dsHDTB_DD[0]['simcard'.toUpperCase()]
        inputObj.so_tb = '84' + this.dsHDTB[0]['ma_tb'.toUpperCase()]

        inputObj.ma_bc = apidata['MA_BC']

        inputObj.tra_cuu_trong_db_0_1 = '1'
        let PICUOCNH_ID = '0'
        inputObj.khuyenmai_id = '0'
        inputObj.dangky_db_0_1 = '0'
        for (var i = 0; i < this.dsDK_DVKHAC.length; i++) {
          if (this.dsDK_DVKHAC[0]['dvkhac_id'.toUpperCase()] == 1 || this.dsDK_DVKHAC[0]['dvkhac_id'.toUpperCase()] == 7) {
            inputObj.dangky_db_0_1 = '1'
            break
          }
        }
        inputObj.ten_tb = this.dsHDTB[0]['ten_tb'.toUpperCase()]
        inputObj.tramvt = '1'

        let rsTb = '' //new CCBSFacade().LAY_THUEBAO_ID_NEO(tt_nd.tentat_ccbs, inputObj.ma_hd, inputObj.so_tb);
        rsTb = await API.post_ts_laphd_hoamangmoi_lay_ds_thuebao(this.axios, {
          ma_tinh: this.tt_nd.tentat_ccbs,
          ma_hd: inputObj.ma_hd
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code == 'BSS-00000000' && response.data.data != 1) {
            let ds = response.data.data
            for (var item of ds) if (item['MA_TB'] == inputObj.so_tb) return item['THUEBAO_ID']
            return ''
          }
        })
        //if (!rsTb.IsLong())
        if (!rsTb) {
          // FIXME cho nay can kiem tra kieu du lieu = long, nhung chua biet data CCBS tra ve nhu the nao???
          return rsTb
        } else {
          inputObj.thuebao_id = rsTb
        }

        inputObj.dia_chi = this.dsHDTB[0]['diachi_tb'.toUpperCase()]
        inputObj.loaitb_id = apidata['LOAITB_ID']

        inputObj.doituong_id = ''
        // bien doituong_vinaphone thay o code cu co khai bao private nhung ko dung, bo qua
        // if (doituong_vinaphone)
        //     inputObj.doituong_id = doituong_vinaphone;
        // else
        // {
        if (this.thuebao.didong.cboDTVinaPhone.length > 0) {
          inputObj.doituong_id = this.thuebao.didong.cboDTVinaPhone.value
        }
        // }
        if (!inputObj.doituong_id) inputObj.doituong_id = '1'

        for (let dr of this.ds_tien_khoanmuc) {
          if (dr['khoanmuctt_id'] == KHOANMUC_TT.KMTT_HOAMANG_DD_TRASAU) {
            inputObj.cuoc_ld = dr['tien']
            inputObj.vat_ld = dr['vat']
            break
          }
        }
        // vuth update 23/12 them cuoc_ld, vat_ld
        if (!inputObj.cuoc_ld) inputObj.cuoc_ld = '0'
        if (!inputObj.vat_ld) inputObj.vat_ld = '0'
        inputObj.cuoc_dv = '0'
        inputObj.vat_dv = inputObj.cuoc_dv * 0.1 //==10%*tiendv

        inputObj.inchitiet = '0' //
        for (var i = 0; i < this.dsDK_DVKHAC.length; i++) {
          if (this.dsDK_DVKHAC[0]['dvkhac_id'.toUpperCase()] == 2 || this.dsDK_DVKHAC[0]['dvkhac_id'.toUpperCase()] == 3 || this.dsDK_DVKHAC[0]['dvkhac_id'.toUpperCase()] == 5) {
            inputObj.inchitiet = '1'
            break
          }
        }
        inputObj.chungloai_id = '0'
        inputObj.tienmay = '0'
        inputObj.vat_may = '0'
        inputObj.ghichu = this.dsHDTB[0]['ghichu'.toUpperCase()]

        inputObj.quan_id = apidata['QUAN_ID']
        inputObj.phuong_id = apidata['PHUONG_ID']
        inputObj.pho_id = apidata['PHO_ID']

        inputObj.kieu_ld_id = apidata['KIEULD_ID']
        inputObj.dsdichvu = ''
        inputObj.loai_kh = apidata['LOAIKH_ID']
        inputObj.donvild_id = '' // vuth update 0912

        inputObj.khuyenmai_id = ''
        if (this.dsKM_HDTB && this.dsKM_HDTB.length > 0) inputObj.khuyenmai_id = this.dsKM_HDTB[0]['khuyenmai_id_neo'.toUpperCase()]
        inputObj.tien_km = '0'
        inputObj.loai_dc_bao_cuoc = '0'
        inputObj.kieu_bao_cuoc = '0'
        inputObj.ma_bao_cuoc = '0'
        inputObj.matb_cu = ''
        //#region vuth update 0912
        inputObj.ThangCamKet = this.thuebao.thangck
        inputObj.KH_DoanhNghiep = ''
        inputObj.quoctich = apidata['QUOC_TICH']
        //#endregion
        let rs = {} //new CCBSFacade().TS_LAPHD_HOAMANGMOI_CAPNHATTHUEBAO(inputObj);
        await API.post_ts_laphd_hoamangmoi_capnhatthuebao(this.axios, inputObj).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            rs = response.data.data
            if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;
            //rs.IssSuccessed = true
          }
          rs.Message = response.data.message;
        })
        if (!rs.IssSuccessed) return 'Lỗi xảy ra khi cập nhật thuê bao lên Vinaphone.' + rs.Message
      } catch (ex) {
        //Comment 2 thong tin nay lai vi chua thay can dung den!
        // status = false;
        // strError_VinaPhone = ex.Message;
        return 'Lỗi xảy ra khi cập nhật thuê bao lên Vinaphone.' + ex
      }
      this.$toast.success(`Cập nhật thuê bao ${this.ma_tb} lên VinaPhone thành công!`)
      return 'OK'
    },
    async Update_HD_ChuyenTinh_Vinaphone() {
      let kt_dulieu_vina = 0
      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      let defNull = 'Phải chọn loại thuê bao di động trả sau'
      if (!this.listbox.dichvu_vt.value || this.listbox.dichvu_vt.value != DichVuVienThong.DI_DONG) return defNull
      if (!this.listbox.loaihinh_tb.value || this.listbox.loaihinh_tb.value != LoaiHinhTB.DIDONGTRASAU) return defNull
      let pdata = {
        QUANTT_ID: this.diachiTT.QUAN_ID,
        PHUONGTT_ID: this.diachiTT.PHUONG_ID,
        PHOTT_ID: this.diachiTT.PHO_ID,
        QUANLD_ID: this.diachiLD.QUAN_ID,
        PHUONGLD_ID: this.diachiLD.PHUONG_ID,
        DONVI_TT_ID: this.dsHDTT[0]['DONVI_ID'],
        NGANHANG_ID: this.dsHDTT[0]['NGANHANG_ID'],
        GOICUOC_ID: this.dsHDTB_DD[0]['GOICUOC_ID'],
        HTTT_ID: this.dsHDTT[0]['HTTT_ID'],
        LOAIGT_ID: this.dsHDKH[0]['LOAIGT_ID'],
        QUOCTICH_ID: this.listbox.quoctich.value,
        MA_NVTC: this.thanhtoan.manvtc,
        //GOICUOC_ID: 1
      }
      let apidata = {}
      await API.post_fn_lay_tt_update_hd_chuyentinh_vnp(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            defNull = apidata['MESSAGE']
            kt_dulieu_vina = 1
            return
          }
          apidata = apidata['RESULT']
        }
      })
      try {
        let thuebao_id_neo = ''
        let dt = [] //new CCBSFacade().ts_laphd_chuyentinh_laytt_tb("1", tt_nd.tentat_ccbs, "84" + CommonFunction.ChuanHoa_XML(dsHDTB.Tables[0].Rows[0]["ma_tb"].ToString()));
        await API.post_ts_laphd_chuyentinh_laytt_tb(this.axios, {
          tracuu_hd: '1',
          ma_tinh: this.tt_nd.tentat_ccbs,
          so_tb: '84' + this.dsHDTB[0]['MA_TB']
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            dt = response.data.data
          }
        })
        if (dt != null && dt.length > 0 && dt[0]['TRANG_THAI'] && dt[0]['THUEBAO_ID']) {
          if (dt[0]['TRANG_THAI'] != '1') {
            return 'Hợp đồng chuyển tỉnh trên vinaphone trạng thái <> 1 , không thể xóa'
          }
          thuebao_id_neo = dt[0]['THUEBAO_ID']
        } else {
          return 'Có lỗi trong khi lấy thông tin thuê bao từ vinaphone ts_laphd_chuyentinh_laytt_tb '
        }
        var inputObj = {}
        inputObj.thuebao_id = thuebao_id_neo
        inputObj.userid = this.tt_nd.user_neo
        inputObj.dia_chi_bc = this.diachiBC.DIACHI

        inputObj.quanct_id = apidata['QUANCT_ID']
        inputObj.phuongct_id = apidata['PHUONGCT_ID']
        inputObj.phoct_id = apidata['PHOCT_ID']

        inputObj.quanld = apidata['QUANLD_ID']
        inputObj.phuongld = apidata['PHUONGLD_ID']
        inputObj.phold = apidata['PHOLD_ID']

        inputObj.diachi_ct = this.dsHDTT[0]['diachi_tt'.toUpperCase()]
        inputObj.sonhact_id = this.diachiCT.SONHA

        inputObj.quantt_id = inputObj.quanct_id
        inputObj.phuongtt_id = inputObj.phuongct_id
        inputObj.phott_id = inputObj.phoct_id
        inputObj.dia_chi_tt = inputObj.diachi_ct
        inputObj.so_nha_tt = inputObj.sonhact_id

        inputObj.mst = this.dsHDTT[0]['mst'.toUpperCase()]
        inputObj.noi_cap = this.dsHDKH[0]['noicap'.toUpperCase()]
        inputObj.inchitiet = '0'
        inputObj.nv_hd = ''
        inputObj.ghi_chu = ''
        inputObj.email_bc = this.thuebao.didong.txtEmailDD
        inputObj.email_hd = this.thuebao.didong.txtEmailDD

        inputObj.loai_dc_bao_cuoc = '0'
        inputObj.kieu_bao_cuoc = '0'
        inputObj.ma_bc = apidata['MA_BC']
        // vuth update tra sau 27/11/2019 fix ma_bc va nganhang
        //inputObj.ngan_hang_id = "0";
        //04/05/2020 fix giup Vu-HTH
        if (this.dsHDTT[0]['nganhang_id'.toUpperCase()]) inputObj.ngan_hang_id = apidata['NGANHANG_ID']
        else inputObj.ngan_hang_id = 0;
        inputObj.so_tb = '84' + this.dsHDTB[0]['ma_tb'.toUpperCase()]
        inputObj.ma_t = ''
        inputObj.sonhald = this.diachiLD.SONHA
        inputObj.nguoi_gt = ''
        inputObj.dia_chi_hd = ''
        inputObj.ma_tinh = this.tt_nd.tentat_ccbs // vuth update tra sau 27/11/2019
        inputObj.taikhoan = ''

        inputObj.so_giay_to = this.dsHDKH[0]['so_gt'.toUpperCase()]
        if (this.thuebao.didong.cboDTVinaPhone.list.length > 0) {
          inputObj.doi_tuong_su_dung = this.thuebao.didong.cboDTVinaPhone.value
        }
        if (!inputObj.doi_tuong_su_dung) inputObj.doi_tuong_su_dung = '1'
        inputObj.loaitb_id = apidata['LOAITB_ID']

        inputObj.ten_tt = this.dsHDTT[0]['ten_tt'.toUpperCase()]
        inputObj.dienthoai_ld = this.khachhang.dienthoai //txtTelKH.Text;

        inputObj.diadiem_tt_id = apidata['DIADIEM_TT_ID']

        inputObj.ten_tb = this.dsHDTB[0]['ten_tb'.toUpperCase()]
        inputObj.chuyenkhoan_id = '0' // vuth update 28/11/2019
        inputObj.inhd_id = '0'

        inputObj.loaigt_id = apidata['LOAIGT_ID']
        var ngaycap = this.dsHDKH[0]['ngaycap'.toUpperCase()];
        if(ngaycap && ngaycap.indexOf(' ')) ngaycap = ngaycap.substring(0,ngaycap.indexOf(' ')).trim();
        inputObj.ngay_cap = ngaycap

        inputObj.so_sim = this.dsHDTB_DD[0]['simcard'.toUpperCase()]

        var ngay_sn = this.dsHDKH[0]['ngay_sn'.toUpperCase()];
        if(ngay_sn && ngay_sn.indexOf(' ')) ngay_sn = ngay_sn.substring(0,ngay_sn.indexOf(' ')).trim();
        inputObj.ngay_sinh = ngay_sn
        inputObj.doi_tuong_id = inputObj.doi_tuong_su_dung
        inputObj.quoc_tich = apidata['QUOC_TICH'] // vuth update 21.11
        inputObj.ma_nv = apidata['MANV_VNP']
        let rs = {} //new CCBSFacade().TS_LAPHD_CHUYENTINH_EDIT_THUEBAO_CTS(inputObj);
        await API.post_ts_laphd_chuyentinh_edit_thuebao_cts(this.axios, inputObj).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            rs = response.data.data
            if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;
            // rs.IssSuccessed = true
          }
          rs.Message = response.data.message;
        })
        if (!rs.IssSuccessed) return 'Lỗi xảy ra trong quá trình thêm mới hợp đồng hòa mạng chuyển tỉnh lên Vinaphone.' + rs.Message
      } catch (ex) {
        return 'Lỗi xảy ra trong quá trình cập nhật hợp đồng hòa mạng chuyển tỉnh lên Vinaphone.' + ex
      }
      this.$toast.success(`Cập nhật hợp đồng hòa mạng chuyển tỉnh ${'84' + this.dsHDTB[0]['ma_tb'.toUpperCase()]} trên VinaPhone thành công!`)

      return 'OK'
    },
    async LoadThongTin_DV_CNTT(vloaitb_id) {
      try {
        let ItemList = await this.Init_Properties(vloaitb_id, 'HDTB_CNTT', '00000')
        // let ItemList = await API.post_lay_danhsach_thuoctinh_datmoi(this.axios, { "ds_para": JSON.stringify(pdata) }).then((response) => {
        //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
        //     return response.data.data;
        //   }
        //   else return [];
        // });
        this.gridEditors = []
        for (var index1 = 0; index1 < ItemList.length; ++index1) {
          if (!ItemList[index1]) continue
          if (ItemList[index1].iAtt == 0) {
            let repositoryItemTextEdit = { Type: 'TextEdit' }
            repositoryItemTextEdit.Tag = ItemList[index1].sFieldName
            repositoryItemTextEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            repositoryItemTextEdit.DataType = ItemList[index1].iDataType
            repositoryItemTextEdit.MaxValue = ItemList[index1].sMaxValue
            repositoryItemTextEdit.MinValue = ItemList[index1].sMinValue
            repositoryItemTextEdit.EditValueChanged = this.repositoryItemTextEdit_EditValueChanged
            repositoryItemTextEdit.EditValueChanging += this.repositoryItemTextEdit_EditValueChanging
            repositoryItemTextEdit.Leave += this.repositoryItemTextEdit_Leave

            if (CAConstanst.isCADev) {
              if (this.listbox.loaihinh_tb.value == 116) {
                if (ItemList[index1].sFieldName == 'SO_THANG') {
                  repositoryItemTextEdit.ReadOnly = true
                }
              }

              let default_serial_value = ItemList[index1].sValue
              if (ItemList[index1].sFieldName != 'SERIAL') {
                default_serial_value = ItemList[index1].sValue
              } else {
                default_serial_value = this.generateUUID()
              }
              repositoryItemTextEdit.Value = default_serial_value
            } else {
              repositoryItemTextEdit.Value = ItemList[index1].sValue
            }
            repositoryItemTextEdit.Name = ItemList[index1].sCaption
            repositoryItemTextEdit.Group = 'Tham số báo cáo'
            repositoryItemTextEdit.ID = ItemList[index1].sFieldName
            // repositoryItemTextEdit.RepositoryItem = repositoryItemTextEdit
            this.gridEditors.push(repositoryItemTextEdit)
          }
          if (ItemList[index1].iAtt == 1) {
            let repositoryItemCalcEdit = { Type: 'CalcEdit' }
            repositoryItemCalcEdit.MaxValue = ItemList[index1].sMaxValue
            repositoryItemCalcEdit.MinValue = ItemList[index1].sMinValue
            repositoryItemCalcEdit.Tag = ItemList[index1].sFieldName
            repositoryItemCalcEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            repositoryItemCalcEdit.Name = ItemList[index1].sCaption
            repositoryItemCalcEdit.Group = 'Tham số báo cáo'
            repositoryItemCalcEdit.ID = ItemList[index1].sFieldName
            repositoryItemCalcEdit.Value = ItemList[index1].sValue
            // repositoryItemCalcEdit.RepositoryItem = repositoryItemCalcEdit
            this.gridEditors.push(repositoryItemCalcEdit)
            //this.gridEditors.Add((RepositoryItem)this.repositoryItemCalcEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
          }
          if (ItemList[index1].iAtt == 2) {
            ItemList[index1].sValue = moment(new Date()).format('DD/MM/YYYY')
            let repositoryItemDateEdit = { Type: 'DateEdit' }
            repositoryItemDateEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            repositoryItemDateEdit.Tag = ItemList[index1].sFieldName
            ItemList[index1].sValue = moment(new Date()).format('DD/MM/YYYY')
            // repositoryItemDateEdit.DisplayFormat.FormatString = "DD/MM/YYYY";
            // repositoryItemDateEdit.EditFormat.FormatString = "DD/MM/YYYY";
            repositoryItemDateEdit.FormatString = 'DD/MM/YYYY'
            repositoryItemDateEdit.EditMask = 'DD/MM/YYYY'
            // repositoryItemDateEdit.Mask.UseMaskAsDisplayFormat = true;
            repositoryItemDateEdit.EditValueChanged = this.repositoryItemDateEdit_EditValueChanged
            repositoryItemDateEdit.Name = ItemList[index1].sCaption
            repositoryItemDateEdit.Group = 'Tham số báo cáo'
            repositoryItemDateEdit.ID = ItemList[index1].sFieldName
            repositoryItemDateEdit.Value = moment(new Date()).format('DD/MM/YYYY')
            // repositoryItemDateEdit.RepositoryItem = repositoryItemDateEdit
            this.gridEditors.push(repositoryItemDateEdit)
            // this.gridEditors.Add((RepositoryItem)repositoryItemDateEdit, ItemList[index1].sCaption, DateTime.Now, "Tham số báo cáo", ItemList[index1].sFieldName);
          }

          if (ItemList[index1].iAtt == 9) {
            ItemList[index1].sValue = moment(new Date()).format('DD/MM/YYYY HH:mm:ss')
            let repositoryItemDateEdit = { Type: 'DateEdit' }
            repositoryItemDateEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            repositoryItemDateEdit.Tag = ItemList[index1].sFieldName
            ItemList[index1].sValue = moment(new Date()).format('DD/MM/YYYY HH:mm:ss')
            // repositoryItemDateEdit.DisplayFormat.FormatString = "DD/MM/YYYY HH:mm:ss";
            // repositoryItemDateEdit.EditFormat.FormatString = "DD/MM/YYYY HH:mm:ss";
            repositoryItemDateEdit.FormatString = 'DD/MM/YYYY HH:mm:ss'
            repositoryItemDateEdit.EditMask = 'DD/MM/YYYY HH:mm:ss'
            // repositoryItemDateEdit.Mask.UseMaskAsDisplayFormat = true;
            repositoryItemDateEdit.EditValueChanged = this.repositoryItemDateEdit_EditValueChanged
            repositoryItemDateEdit.Name = ItemList[index1].sCaption
            repositoryItemDateEdit.Group = 'Tham số báo cáo'
            repositoryItemDateEdit.ID = ItemList[index1].sFieldName
            repositoryItemDateEdit.Value = moment(new Date()).format('DD/MM/YYYY')
            // repositoryItemDateEdit.RepositoryItem = repositoryItemDateEdit
            this.gridEditors.push(repositoryItemDateEdit)
            // this.gridEditors.Add((RepositoryItem)repositoryItemDateEdit, ItemList[index1].sCaption, DateTime.Now, "Tham số báo cáo", ItemList[index1].sFieldName);
          }

          // let str1;
          // let dataSet;
          if (ItemList[index1].iAtt == 4) {
            let repositoryItemLookUpEdit = { Type: 'LookUpEdit' }
            repositoryItemLookUpEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            // repositoryItemLookUpEdit.View.OptionsView.ShowAutoFilterRow = true;
            repositoryItemLookUpEdit.Tag = ItemList[index1].sFieldName
            // str1 = "";
            let SQL = ItemList[index1].StrSql
            if (SQL && SQL != '' && SQL.indexOf('{') < 0) {
              // dataSet = new DataSet();
              let data = ItemList[index1].SqlData
              if (!data || data.length <= 0) this.$toast.error('Không lấy được dữ liệu cho ' + repositoryItemLookUpEdit.Tag)
              // let data = await API.post_sp_huonggiao_runsql(this.axios, { "command": SQL }).then((response) => {
              //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //     return response.data.data.data_json;
              //   }
              //   else return [];
              // }).catch(err=> { throw err.data.message+': '+err.data.message_detail; }); //this.bangts.GetSQL(SQL, "");
              repositoryItemLookUpEdit.ValueMember = ItemList[index1].sLookUpKeyField
              repositoryItemLookUpEdit.DisplayMember = ItemList[index1].sLookUpValueField
              if (this.DS_CHUQUAN_THEO_QUYEN != null && this.DS_CHUQUAN_THEO_QUYEN != '' && ItemList[index1].sLookUpKeyField.toUpperCase() == 'CHUQUAN_ID') {
                repositoryItemLookUpEdit.DataSource = data.filter((x) => this.DS_CHUQUAN_THEO_QUYEN.indexOf(x.CHUQUAN_ID) >= 0) //(object)data.Tables[0].Select("CHUQUAN_ID in " + this.DS_CHUQUAN_THEO_QUYEN).CopyToDataTable();
              }
              // #region cuongpq them load lai cbo huyen ivan
              else if (ItemList[index1].sLookUpKeyField && ItemList[index1].sLookUpKeyField.toUpperCase() == 'CAPDO_ID' && this.listbox.loaihinh_tb.value == LoaiHinhTB.IVAN) {
                let tinh_ivan = await API.post_getivan_tinh(this.axios, { tinh_id: this.diachiTB.TINH_ID }).then((response) => {
                  //.post_sp_huonggiao_runsql(this.axios, { "command": this.ReplaceSQL(`select tinh_ivan_id from ${DatabaseConstants.DB2}.tinh where tinh_id = ${this.diachiTB.TINH_ID}`) }).then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    return response.data.data //.data_json;
                  } else return []
                }) //bangts.getDataFromSQL(ReplaceSQL("select tinh_ivan_id from {?DB2}.tinh where tinh_id = " + tinhtb_id), "tinh_ivan").Tables[0];
                if (tinh_ivan.length > 0) {
                  if (tinh_ivan[0].tinh_ivan_id != null) {
                    let vtinh_ivan = tinh_ivan[0].tinh_ivan_id
                    repositoryItemLookUpEdit.DataSource = data.filter((x) => x.MAP_ID == vtinh_ivan) //(object)data.Tables[0].Select("MAP_ID = " + vtinh_ivan).CopyToDataTable();
                  } //else throw 'Địa chỉ thuê bao tỉnh chưa có trên danh mục dịch vụ IVAN. Liên hệ admin để được hỗ trợ' //this.$toast.error("Địa chỉ thuê bao tỉnh chưa có trên danh mục dịch vụ IVAN. Liên hệ admin để được hỗ trợ");
                } else
                {this.$toast.error('Hãy chọn địa chỉ thuê bao') //this.$toast.error("Hãy chọn địa chỉ thuê bao");
                 repositoryItemLookUpEdit.DataSource = data;
              }
              }
              // #endregion
              else repositoryItemLookUpEdit.DataSource = data
              // repositoryItemLookUpEdit.View.OptionsView.ShowColumnHeaders = false;
              //if (repositoryItemLookUpEdit.View.Columns.Count > 1)
              // if(Object.keys(data).length > 1) //Doan nay khong can vi combobox da hoat dong dung nhu the nay roi!!!
              // {
              //     for (var ic = 0; ic < Object.keys(data).length; ic++)
              //     {
              //         repositoryItemLookUpEdit.View.Columns[ic].Visible = false;
              //     }
              //     repositoryItemLookUpEdit.View.Columns[1].Visible = true;
              // }
              repositoryItemLookUpEdit.NullText = ''
            } else {
              SQL = await this.ReturnSqlStr(ItemList, index1)
              // dataSet = new DataSet();
              // DataSet data = this.bangts.GetSQL(SQL, "");
              let data = ItemList[index1].SqlData
              if (!data || data.length <= 0) this.$toast.error('Không lấy được dữ liệu cho ' + repositoryItemLookUpEdit.Tag)
              // let data = await API.post_sp_huonggiao_runsql(this.axios, { "command": SQL }).then((response) => {
              //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //     return response.data.data.data_json;
              //   }
              //   else return [];
              // }).catch(err=> { throw err.data.message+': '+err.data.message_detail; });;
              repositoryItemLookUpEdit.ValueMember = ItemList[index1].sLookUpKeyField
              repositoryItemLookUpEdit.DisplayMember = ItemList[index1].sLookUpValueField
              if (this.DS_CHUQUAN_THEO_QUYEN != null && this.DS_CHUQUAN_THEO_QUYEN != '' && ItemList[index1].sLookUpKeyField.toUpperCase() == 'CHUQUAN_ID') {
                repositoryItemLookUpEdit.DataSource = data.filter((x) => this.DS_CHUQUAN_THEO_QUYEN.indexOf(x.CHUQUAN_ID) >= 0) //(object)data.Tables[0].Select("CHUQUAN_ID in " + this.DS_CHUQUAN_THEO_QUYEN).CopyToDataTable();
              } else repositoryItemLookUpEdit.DataSource = data //(object)data.Tables[0];
              // repositoryItemLookUpEdit.View.OptionsView.ShowColumnHeaders = false;
              // if (Object.keys(data).length > 1)
              // {
              //     for (var ic = 0; ic < Object.keys(data).length; ic++)
              //     {
              //         repositoryItemLookUpEdit.View.Columns[ic].Visible = false;
              //     }
              //     repositoryItemLookUpEdit.View.Columns[1].Visible = true;
              // }

              repositoryItemLookUpEdit.NullText = ''
            }
            repositoryItemLookUpEdit.EditValueChanged = this.repositoryItemLookUpEdit_EditValueChanged
            repositoryItemLookUpEdit.Leave = this.repositoryItemLookUpEdit_leave
            repositoryItemLookUpEdit.EditValueChanging = this.repositoryItemLookUpEdit_EditValueChanging
            //  this.gridEditors.Add((RepositoryItem)repositoryItemLookUpEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
            repositoryItemLookUpEdit.Name = ItemList[index1].sCaption
            repositoryItemLookUpEdit.Group = 'Tham số báo cáo'
            repositoryItemLookUpEdit.ID = ItemList[index1].sFieldName
            repositoryItemLookUpEdit.Value = ItemList[index1].sValue
            if (!repositoryItemLookUpEdit.Value && repositoryItemLookUpEdit.DataSource && repositoryItemLookUpEdit.DataSource.length > 0) repositoryItemLookUpEdit.Value = repositoryItemLookUpEdit.DataSource[0][repositoryItemLookUpEdit.ValueMember]
            if (repositoryItemLookUpEdit.DataSource && repositoryItemLookUpEdit.DataSource.length > 0) {
              repositoryItemLookUpEdit.DataSource = repositoryItemLookUpEdit.DataSource.map((x) => ({ text: x[ItemList[index1].sLookUpValueField], id: x[ItemList[index1].sLookUpKeyField] }))
            }
            // repositoryItemLookUpEdit.RepositoryItem = repositoryItemLookUpEdit
            this.gridEditors.push(repositoryItemLookUpEdit)
            // await this.repositoryItemLookUpEdit_EditValueChanged(repositoryItemLookUpEdit)
          }
          if (ItemList[index1].iAtt == 5) {
            //Button Edit
            let repositoryItemButtonEdit = { Type: 'ButtonEdit' }
            repositoryItemButtonEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            repositoryItemButtonEdit.Tag = ItemList[index1].sFieldName
            if (ItemList[index1].sFieldName == 'MATB_TN') {
              repositoryItemButtonEdit.ReadOnly = true
            }

            // repositoryItemButtonEdit.ButtonClick -= new DevExpress.XtraEditors.Controls.ButtonPressedEventHandler(this.repositoryItemButtonEdit_ButtonClick);
            repositoryItemButtonEdit.ButtonClick = this.repositoryItemButtonEdit_ButtonClick
            repositoryItemButtonEdit.Name = ItemList[index1].sCaption
            repositoryItemButtonEdit.Group = 'Tham số báo cáo'
            repositoryItemButtonEdit.ID = ItemList[index1].sFieldName
            repositoryItemButtonEdit.Value = ItemList[index1].sValue
            // repositoryItemButtonEdit.RepositoryItem = repositoryItemButtonEdit
            this.gridEditors.push(repositoryItemButtonEdit)
            // this.gridEditors.Add((RepositoryItem)repositoryItemButtonEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
          }
          if (ItemList[index1].iAtt == 7) {
            let repositoryItemCheckEdit = { Type: 'CheckEdit' }
            repositoryItemCheckEdit.Tag = ItemList[index1].sFieldName
            repositoryItemCheckEdit.ReadOnly = ItemList[index1].sReadOnly == 1
            repositoryItemCheckEdit.ValueChecked = 1
            repositoryItemCheckEdit.ValueUnchecked = 0
            repositoryItemCheckEdit.Name = ItemList[index1].sCaption
            repositoryItemCheckEdit.Group = 'Tham số báo cáo'
            repositoryItemCheckEdit.ID = ItemList[index1].sFieldName
            repositoryItemCheckEdit.Value = ItemList[index1].sValue
            // repositoryItemCheckEdit.RepositoryItem = repositoryItemCheckEdit
            this.gridEditors.push(repositoryItemCheckEdit)
            // this.gridEditors.Add((RepositoryItem)this.repositoryItemCheckEdit, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
          }
          if (ItemList[index1].iAtt == 10) {
            //InitialItemCheckedRepository();// Thay bang doan code ben duoi
            let repositoryItemCheckedComboBoxEdit1 = { Type: 'CheckedComboBoxEdit1' }
            repositoryItemCheckedComboBoxEdit1.AutoHeight = false
            repositoryItemCheckedComboBoxEdit1.Name = 'repositoryItemCheckedComboBoxEdit1'

            repositoryItemCheckedComboBoxEdit1.ReadOnly = ItemList[index1].sReadOnly == 1
            let SQL_CheckListBox = ItemList[index1].StrSql
            let data = ItemList[index1].SqlData
            // let data = await API.post_sp_huonggiao_runsql(this.axios, { "command": SQL_CheckListBox }).then((response) => {
            //     if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            //       return response.data.data.data_json;
            //     }
            //     else return [];
            //   });//this.objCheckData.GET_DATA_SQL(SQL_CheckListBox, "");
            repositoryItemCheckedComboBoxEdit1.ValueMember = ItemList[index1].sLookUpKeyField
            repositoryItemCheckedComboBoxEdit1.DisplayMember = ItemList[index1].sLookUpValueField
            repositoryItemCheckedComboBoxEdit1.DataSource = data

            repositoryItemCheckedComboBoxEdit1.Name = ItemList[index1].sCaption
            repositoryItemCheckedComboBoxEdit1.Group = 'Tham số báo cáo'
            repositoryItemCheckedComboBoxEdit1.ID = ItemList[index1].sFieldName
            repositoryItemCheckedComboBoxEdit1.Value = ItemList[index1].sValue ? ItemList[index1].sValue.split(',') : ItemList[index1].sValue
            // repositoryItemCheckedComboBoxEdit1.RepositoryItem = repositoryItemCheckedComboBoxEdit1
            this.gridEditors.push(repositoryItemCheckedComboBoxEdit1)

            // this.gridEditors.Add((RepositoryItem)repositoryItemCheckedComboBoxEdit1, ItemList[index1].sCaption, (object)ItemList[index1].sValue, "Tham số báo cáo", ItemList[index1].sFieldName);
          }
        }
        // let source_hotline = "";
        // for (var i = ItemList.length - 1; i >= 0; i--) {
        //   if (ItemList[i].sFieldName == "DONVIKG_ID") {
        //     source_hotline = this.gridEditors[i].Value;
        //   }
        // }
        //region cuongpq them code an thuoc tinh cntt
        for (let i = 0; i < this.gridEditors.length; i++) {
          if (this.gridEditors[i].Type == 'LookUpEdit') {
            await this.repositoryItemLookUpEdit_EditValueChanged(this.gridEditors[i])
          }
          if (!(this.ItemList[i].sFieldName == "DUNGTHU"
            || this.ItemList[i].sFieldName == "THIETBI"
            || this.ItemList[i].sFieldName == "MA_DV"
            || this.ItemList[i].sFieldName == "DINHTUYEN")) {
          } else if (this.listbox.kieu_ld.value == 14052 || this.listbox.kieu_ld.value == 14051 )/*đối tượng 1, 2*/ {
            this.gridEditors[i].show = false;
            // this.ItemList[i].hidden = true;
          }

          if (this.ItemList[i].sFieldName == "CHUQUAN_ID" && this.is_nv_vnpti) {
            this.gridEditors[i].Value = 81
            this.ItemList[i].sValue = 81
          }

        }     //end region
        //
        // this.grcMacdinh.DataSource = this.gridEditors;

        await this.grvMacdinh_RowCellStyle();
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async grvMacdinh_RowCellStyle() {
      for (let i = 0; i < this.gridEditors.length; i++) {
        this.gridEditors[i].isDisabled = false;
        let field_name = this.ItemList[i].sFieldName;

        if (field_name == "NGAY_KT" || field_name == "SO_THANG" || (field_name == "NGAY_DUYTRI_KT" && this.listbox.loaihinh_tb.value == LoaiHinhTB.VEDU_LIB)) {
          for(var j = 0; j < this.gridEditors.length; j++)
            if(this.ItemList[j].sFieldName == "THOIHAN_ID" && this.gridEditors[j].Value == 2)
              this.gridEditors[i].isDisabled = true;
        }
        if(this.listbox.loaihinh_tb.value == 161)
          if (field_name == "SERIAL" || field_name == "DONGIA")
            for(var j = 0; j < this.gridEditors.length; j++)
              if(this.ItemList[j].sFieldName == "DAILY" && this.gridEditors[j].Value == 0){
                this.gridEditors[i].isDisabled = true;
                if (field_name == "SERIAL") {
                  this.gridEditors[i].Value = "N";
                  this.ItemList[i].sValue = "N";
                }
                else for(var k = 0; k < this.gridEditors.length; k++)
                  if (this.ItemList[k].sFieldName == "SERIAL") {
                    this.gridEditors[i].Value = "N";
                    this.ItemList[i].sValue = "N";
                  }
              }
              else if (this.ItemList[j].sFieldName == "SERIAL" && this.gridEditors[j].Value == "N" && field_name == "DONGIA")
                this.gridEditors[i].isDisabled = true;
        //#region Báo hiệu quốc tế
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.BaoHieuQuocTe){
          if (field_name == "POS_ID" || field_name == "CAPDO_ID" || field_name == "MA_PHU" || field_name == "LINH_KIEN" || field_name == "MIEN_ID")
            for(var j = 0; j < this.gridEditors.length; j++)
              if(this.ItemList[j].sFieldName == "LOAICTS_ID" && (this.gridEditors[j].Value == 823 || this.gridEditors[j].Value == 824))
                this.gridEditors[i].isDisabled = true;
          if(field_name == "HT_SINHKHOA_ID" || field_name == "UPS" || field_name == "SL_MAYLE")
            for(var j = 0; j < this.gridEditors.length; j++)
                if(this.ItemList[j].sFieldName == "LOAICTS_ID" && (this.gridEditors[j].Value == 825 || this.gridEditors[j].Value == 826))
                  this.gridEditors[i].isDisabled = true;
        }
        //#Cuongpq thêm hàm xử lý với gói cước trọn gói
        if (field_name == "SO_THANG" || field_name == "NGAY_KT") {
          var tocdo_id = "";
          var phanloai_id = "";
          for(var j = 0; j < this.gridEditors.length; j++)
          {
              if (this.ItemList[j].sFieldName == "TOCDO_ID")
              {
                  tocdo_id = this.ItemList[j].sValue;
              }
              else if (this.ItemList[j].sFieldName == "PHANLOAI_ID")
              {
                  phanloai_id = this.ItemList[j].sValue;
              }
          }
          var kt_chan = await this.axios.get(`/web-hopdong/lapdatmoi/fn_kiemtra_goicuoc_trongoi?vloaitb_id=${this.listbox.loaihinh_tb.value}&vtocdo_id=${tocdo_id?tocdo_id:0}&vphanloai_id=${phanloai_id?phanloai_id:0}`)
          //tdan.GET_VALUE_FUNC("{?DB2}.fn_kiemtra_goicuoc_trongoi", "vloaitb_id", cboLoaihinhTB.SelectedValue.ToString(), "vtocdo_id", tocdo_id, "vphanloai_id", phanloai_id).ToString();
          if (kt_chan && kt_chan.data && (kt_chan.data == "OK" || kt_chan.data.data=="OK"))
          {
            this.gridEditors[i].isDisabled = true;
              for (var j = 0; j < this.gridEditors.length; j++)
              {
                  if (this.ItemList[j].sFieldName == "SO_THANG")
                  {
                      this.ItemList[j].sValue = "1200";
                      this.gridEditors[j].Value = "1200";
                  }
                  if (this.ItemList[j].sFieldName == "NGAY_KT")
                  {
                      this.ItemList[j].sValue = moment().add(1200, 'M').format('DD/MM/YYYY');
                      this.gridEditors[j].Value = moment().add(1200, 'M').format('DD/MM/YYYY');
                  }
              }
          }
        }
        // #region Edu content
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.EduContent)
        {
            for (var j = 0; j < this.gridEditors.length; j++)
            {

                if (this.ItemList[j].sFieldName == "PHANLOAI_ID" && (this.ItemList[j].sValue == "174" || this.ItemList[j].sValue == "176"))
                {
                    var gettocdo_id = 0;
                    gettocdo_id = this.ItemList.find(x=>x.sFieldName == "TOCDO_ID")?this.ItemList.find(x=>x.sFieldName == "TOCDO_ID").sValue:0; //int.Parse(ItemList.Where(x => x.sFieldName == "TOCDO_ID").First().sValue);
                    if ((field_name == "CAPDO_ID" || field_name == "LOAICTS_ID") && gettocdo_id != 32100) // gạch trường khối và môn học đi, Riêng gói [TRIAL] vnEdu Content Exam (Kèm LMS) thì mở ra
                      this.gridEditors[i].isDisabled = true;
                }
                if (this.ItemList[j].sFieldName == "PHANLOAI_ID" && this.ItemList[j].sValue == "175")
                {

                  var gettocdo_id = 0;
                  gettocdo_id = this.ItemList.find(x=>x.sFieldName == "TOCDO_ID")?this.ItemList.find(x=>x.sFieldName == "TOCDO_ID").sValue:0; //int.Parse(ItemList.Where(x => x.sFieldName == "TOCDO_ID").First().sValue);
                  if (field_name == "CAPDO_ID" && (gettocdo_id == 32102 || gettocdo_id == 32103))
                    this.gridEditors[i].isDisabled = true;

                }
            }
        }
        if ((field_name == "NGAY_KT" || field_name == "SO_THANG" || field_name == "NGAY_BD") && this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING)
        {
          for(var j = 0; j < this.gridEditors.length; j++)
            if(this.ItemList[j].sFieldName == "PHANLOAI_ID" && this.gridEditors[j].Value == 43) {
              this.gridEditors[i].isDisabled = true;
              break;
            }
        }
        if ((field_name == "THOIGIAN_BD" || field_name == "THOIGIAN_KT") && this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING)
        {
          for(var j = 0; j < this.gridEditors.length; j++)
            if(this.ItemList[j].sFieldName == "PHANLOAI_ID" && this.gridEditors[j].Value == 42) {
              this.gridEditors[i].isDisabled = true;
              break;
            }
        }
        if ((field_name == "SL_MALING") && this.listbox.loaihinh_tb.value == LoaiHinhTB.ECABINET)
        {
          for(var j = 0; j < this.gridEditors.length; j++)
            if(this.ItemList[j].sFieldName == "PHANLOAI_ID" && this.gridEditors[j].Value == 83) {
              this.gridEditors[i].isDisabled = true;
              break;
            }
        }

        if ((field_name == "SOLUONG") && this.listbox.loaihinh_tb.value == LoaiHinhTB.ECABINET)
        {
          for(var j = 0; j < this.gridEditors.length; j++)
            if(this.ItemList[j].sFieldName == "PHANLOAI_ID" && (this.gridEditors[j].Value == 85 || this.gridEditors[j].Value == 130)) {
              this.gridEditors[i].isDisabled = true;
              break;
            }
        }

        if ((field_name == "NGAY_BD" || field_name == "NGAY_KT") && this.listbox.loaihinh_tb.value == LoaiHinhTB.ECABINET)
        {
          for(var j = 0; j < this.gridEditors.length; j++)
            if(this.ItemList[j].sFieldName == "PHANLOAI_ID" && this.gridEditors[j].Value == 85) {
              this.gridEditors[i].isDisabled = true;
              break;
            }
        }


        if ((field_name == "THOIGIAN_BD" || field_name == "THOIGIAN_KT") && this.listbox.loaihinh_tb.value == LoaiHinhTB.ECABINET)
        {
          for(var j = 0; j < this.gridEditors.length; j++)
            if(this.ItemList[j].sFieldName == "PHANLOAI_ID" && this.gridEditors[j].Value == 130) {
              this.gridEditors[i].isDisabled = true;
              break;
            }
        }

        if ((field_name == "MOC_LOCAL") && this.listbox.loaihinh_tb.value == LoaiHinhTB.THUPHAT_HINH_QT)
        {
          for(var j = 0; j < this.gridEditors.length; j++)
            if(this.ItemList[j].sFieldName == "TOCDO_ID" && this.gridEditors[j].Value == 45264) {
              this.gridEditors[i].isDisabled = true;
              break;
            }
        }
        if ((field_name == "SL_CCU" ||
            field_name == "SL_MAYLE" ||
            field_name == "SL_VB_TB" ||
            field_name == "SOLUONG" ||
            field_name == "MOC_LOCAL" ||
            field_name == "TONGSO_ND" ||
            field_name == "MOC_HOME" ||
            field_name == "DINHTUYEN") && this.listbox.loaihinh_tb.value == LoaiHinhTB.THUE_BANGTAN_VETINH)
        {
          for(var j = 0; j < this.gridEditors.length; j++)
            if(this.ItemList[j].sFieldName == "TOCDO_ID" && this.gridEditors[j].Value == 16194) {
              this.gridEditors[i].isDisabled = true;
              break;
            }
        }
        if ((field_name == "GPKD") && this.listbox.loaihinh_tb.value == LoaiHinhTB.THUE_BANGTAN_VETINH)
        {
          for(var j = 0; j < this.gridEditors.length; j++)
            if(this.ItemList[j].sFieldName == "TOCDO_ID" && this.gridEditors[j].Value == 16195) {
              this.gridEditors[i].isDisabled = true;
              break;
            }
        }
      }
    },
    //BUG tu doan nay tro xuong, ItemList dang dung bien global, can xem & khai bao lai!!!
    async repositoryItemTextEdit_EditValueChanged(repositoryItemTextEdit) {
      //region cuongpq thêm code  sms  brandname
      let ItemList = this.ItemList
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.Voice_Brandname && this.listbox.kieu_ld.value == 793 && repositoryItemTextEdit.Tag == 'MA_PL' && repositoryItemTextEdit.Value) {
        let columns = ['MA_PL', 'NGAY_KY_HD', 'MA_CHUAN', 'LOAICTS_ID', 'CHUQUAN_ID', 'MST', 'PHANLOAI_ID', 'DONVIKG_ID', 'TOCDO_ID', 'TEN_CH', 'SO_DT', 'EMAIL', 'DOMAIN', 'USERNAME']
        let vma_pl = repositoryItemTextEdit.Value
        let dt = await this.axios.get(`/web-hopdong/vbn/lay_thongtin_hopdong_cu?vma_pl=${vma_pl}`)

        if (dt && dt.data && dt.data.data && dt.data.data.length > 0) {
          for (var i = ItemList.length - 1; i >= 0; i--) {
            if (columns.includes(ItemList[i].sFieldName)) {
              ItemList[i].sValue = dt.data.data[0][ItemList[i].sFieldName.toLowerCase()]
              this.gridEditors[i].Value = dt.data.data[0][ItemList[i].sFieldName.toLowerCase()]
              //sothang = Convert.ToInt32(textValue);
            }
          }
        }
        else {
          this.$toast.error('Không tồn tại hợp đồng hoặc hợp đồng đã bị hủy. Hãy kiểm tra lại.')
        }
      }
      else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.SCC && repositoryItemTextEdit.Tag == 'MA_TB' && repositoryItemTextEdit.Value )
      {
        let so_tb = repositoryItemTextEdit.Value
        let dauso = "";
        for (var i = ItemList.length - 1; i >= 0; i--) {
          if (ItemList[i].sFieldName == "DONVIKG_ID") {
            dauso = this.gridEditors[i].Value;
          }
        }
        if(dauso == '323' /*di động*/)
        {
          let response_kt_scc = await this.axios.post('/ccbs/executor/ts_tracuu_tb_services', { so_tb });
          if (response_kt_scc.data.data && response_kt_scc.data.data.ResultCode.toString() != "0") {
            this.$toast.error('Số thuê bao không thuộc loại hình SCC. Hãy kiểm tra lại');
            repositoryItemTextEdit.Value = "";
            return;
          }
        }
      }
      else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.Voice_Brandname && repositoryItemTextEdit.Tag == 'MA_CHUAN' && repositoryItemTextEdit.Value) {
        let so_tb = repositoryItemTextEdit.Value
        let source_hotline = "";
        for (var i = ItemList.length - 1; i >= 0; i--) {
          if (ItemList[i].sFieldName == "DONVIKG_ID") {
            source_hotline = this.gridEditors[i].Value;
          }
        }

        if (source_hotline == "") this.$toast.error('Chưa nhập Source hotline.');
        if (source_hotline == "12" /*meg*/) {
          let response_kt_meg = await this.axios.post('/ccbs/executor/meg_laytt_tb', { so_tb });
          if (response_kt_meg.data.data.length == 0) {
            this.$toast.error('Số thuê bao chủ nhóm không phải là số chính (số hotline) của dịch vụ MEG, đề nghị kiểm tra lại');
            repositoryItemTextEdit.Value = "";
            return;
          }
          let kt_meg = response_kt_meg.data.data;
        }
        else if (source_hotline == "11" /*VCC*/) {
          let response_kt_vcc = await this.axios.post('/ccbs/executor/ts_vcc_lay_tttb', { so_tb });
          if (response_kt_vcc.data.data.length == 0) {
            this.$toast.error('Số thuê bao chủ nhóm không phải là số chính (số hotline) của dịch vụ VCC, đề nghị kiểm tra lại');
            repositoryItemTextEdit.Value = "";
            return;
          }
          let kt_meg = response_kt_vcc.data.data;
        }
         let response_kt_trasau = await this.axios.post('/ccbs/tracuu/app_tracuu_tt_thuebao', { so_tb });
          if (response_kt_trasau.data.data.length == 0 || response_kt_trasau.data.data.tra_sau == 0) {
            this.$toast.error('Số thuê bao là trả trước không thể lắp được dịch vụ');
            repositoryItemTextEdit.Value = "";
            return;
          }
        // else if (source_hotline == "14"  || source_hotline == "15" || source_hotline == "16"/*Voice Brandname*/) {
        //   let response_kt_vbr = await this.axios.post('/ccbs/tracuu/ts_tracuu_laytt_tb', { so_tb });
        //   if (!response_kt_vbr.data.data || response_kt_vbr.data.data.length == 0) {
        //     this.$toast.error('Số thuê bao không tồn tại trên CCBS . Hãy kiểm tra lại.');
        //     repositoryItemTextEdit.Value = "";
        //     return;
        //   }
        //   if ((response_kt_vbr.data.data[0].LOAI_TB != 'Post-STK_VBR2' &&  source_hotline == 14 ) ||
        //       (response_kt_vbr.data.data[0].LOAI_TB != 'Post-STK_VBR3' && response_kt_vbr.data.data[0].LOAI_TB != 'Post-STK'
        //       && (source_hotline == 15 || source_hotline == 16)))
        //   {
        //     this.$toast.error('Số thuê bao chưa thuộc loại hình Post-STK trên CCBS . Hãy kiểm tra lại.');
        //     repositoryItemTextEdit.Value = "";
        //     return;
        //   }
        // }
      }
      //thêm code  load thông tin hiện hữu sms brandname
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.BRANDNAME && this.listbox.kieu_ld.value == 13224 && repositoryItemTextEdit.Tag == 'LABEL_ID' && repositoryItemTextEdit.Value) {
        let label_id = repositoryItemTextEdit.Value
        let phanloai_id = -1
        for (var i = ItemList.length - 1; i >= 0; i--) {
          if (ItemList[i].sFieldName == 'PHANLOAI_ID') {
            phanloai_id = this.gridEditors[i].Value
            //sothang = Convert.ToInt32(textValue);
          }
        }
        var vphanvung_id = Number(this.$root.token.getPhanVungID())
        let response = await this.axios.post(`/tichhop/brandname/load_thongtin_brandname`, { vphanvung_id, vlabel_id: label_id + '', vphanloai_id: phanloai_id + '' })
        if (response.data.data && response.data.data.status == 200) {
          let columns_brn = ['LABEL_ID', 'AGENT_ID', 'CONTRACT_ID', 'LINHVUC_ID', 'LINHVUC_VMS_ID', 'LINHVUC_VTL_ID', 'LINHVUC_GTEL_ID', 'LINHVUC_VNM_ID', 'LINHVUC_ITEL_ID', 'LINHVUC_MOBICAST_ID']
          var label_data = response.data.data.data.items[0]
          for (var i = ItemList.length - 1; i >= 0; i--) {
            if (columns_brn.includes(ItemList[i].sFieldName)) {
              ItemList[i].sValue = label_data[ItemList[i].sFieldName.toLowerCase()]
              this.gridEditors[i].Value = label_data[ItemList[i].sFieldName.toLowerCase()]
            } else if (ItemList[i].sFieldName == 'THUONGHIEU') {
              ItemList[i].sValue = label_data['label']
              this.gridEditors[i].Value = label_data['label']
            } else if (ItemList[i].sFieldName == 'NGAY_BD') {
              ItemList[i].sValue = label_data['created_date']
              this.gridEditors[i].Value = label_data['created_date']
            } else if (ItemList[i].sFieldName == 'MST') {
              ItemList[i].sValue = label_data['tax_code']
              this.gridEditors[i].Value = label_data['tax_code']
            } else if (ItemList[i].sFieldName == 'ADSER_ID') {
              ItemList[i].sValue = '0'
              this.gridEditors[i].Value = '0'
            }
          }
        } else {
          this.$toast.error(response.data.data.message)
          return
        }
      }

      //  if (tEditor.Properties.Tag.ToString() == "MA_PL" && cboKieuLD.SelectedValue.ToString() == "793"/*thêm mới brandname*/
      //     && Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.Voice_Brandname && tEditor.Text != "") {
      //             DataTable dt = tdan.GET_DATA_PROC("{?DB2}.toantrinh_vbn.lay_thongtin_hopdong_cu", "vma_pl", tEditor.Text);
      //     if (dt.Rows.Count == 0) return;
      //     let kq = Message_Box.Show("Bạn có muốn sử dụng thông tin hợp đồng cũ", "Thông báo");
      //     if (!kq) return;
      //     string[] columns = new string[] {
      //       "MA_PL", "NGAY_KY_HD", "MA_CHUAN", "LOAICTS_ID", "CHUQUAN_ID",
      //       "MST", "PHANLOAI_ID", "DONVIKG_ID", "TOCDO_ID", "TEN_CH", "SO_DT", "EMAIL", "DOMAIN",
      //       "USERNAME"
      //     };
      //     for (int i = 0; i < ItemList.Length; i++)
      //     {
      //       foreach(string fieldname in columns)
      //       {
      //         if (ItemList[i].sFieldName == fieldname) {
      //           ItemList[i].sValue = dt.Rows[0][fieldname].ToString();
      //           gridEditors[i].Value = dt.Rows[0][fieldname];
      //         }
      //       }
      //     }
      //     grcMacdinh.RefreshDataSource();
      //     grcMacdinh.EndUpdate();
      //   }

      //end region
      // FIXME Can xem lai cho tham so nay xem nen truyen o code khoi tao doi tuong hay tu form ????
      //RepositoryItemTextEdit repositoryItemTextEdit = !(sender is TextEdit) ? sender as RepositoryItemTextEdit : (sender as TextEdit).Properties;

      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.ELEARNING) {
        if (repositoryItemTextEdit.Tag == 'SOLUONG') {
          let textValue = repositoryItemTextEdit.Value
          for (var i = ItemList.length - 1; i >= 0; i--) {
            if (ItemList[i].sFieldName == 'SOLUONG') {
              ItemList[i].sValue = textValue
              //sothang = Convert.ToInt32(textValue);
              break
            }
          }
        }

        if (repositoryItemTextEdit.Tag == 'DOMAIN') {
          let textValue = repositoryItemTextEdit.Value
          for (var i = ItemList.length - 1; i >= 0; i--) {
            if (ItemList[i].sFieldName == 'DOMAIN') {
              ItemList[i].sValue = textValue
              //sothang = Convert.ToInt32(textValue);
              break
            }
          }
        }

        if (repositoryItemTextEdit.Tag == 'MA_PHU') {
          let textValue = repositoryItemTextEdit.Value
          for (var i = ItemList.length - 1; i >= 0; i--) {
            if (ItemList[i].sFieldName == 'MA_PHU') {
              ItemList[i].sValue = textValue
              //sothang = Convert.ToInt32(textValue);
              break
            }
          }
        }
      }

      if (repositoryItemTextEdit.Tag == 'SO_THANG') {
        let b_ngay_bd = false
        let b_ngay_kt = false
        let sothang = 0
        let ngay_bd = new Date() //tt_nd.ngay_cn;
        let ngay_kt = new Date() //tt_nd.ngay_cn;

        let textValue = repositoryItemTextEdit.Value
        sothang = textValue * 1
        if (!textValue || textValue == '' || isNaN(textValue)) return
        // Da chay o duoi > khong can chay lai o day!!!
        // for (var i = ItemList.length - 1; i >= 0; i--)
        // {
        //     if (ItemList[i].sFieldName == "SO_THANG")
        //     {
        //         ItemList[i].sValue = textValue;
        //         sothang = textValue;
        //         break;
        //     }
        // }
        for (var i = 0; i < ItemList.length; i++) {
          if (ItemList[i].sFieldName == 'SO_THANG') {
            ItemList[i].sValue = textValue
            sothang = textValue * 1
          }
          if (ItemList[i].sFieldName == 'NGAY_BD') {
            b_ngay_bd = true
            ItemList[i].sValue = this.gridEditors[i].Value
            ngay_bd = this.gridEditors[i].Value
            try {
              ngay_bd = moment(ngay_bd, ngay_bd.length > 10 ? 'DD/MM/YYYY HH:mm:ss' : 'DD/MM/YYYY').toDate()
            } catch (ex) {}
          }
          if (ItemList[i].sFieldName == 'NGAY_KT') {
            b_ngay_kt = true
            ItemList[i].sValue = this.gridEditors[i].Value
            ngay_kt = this.gridEditors[i].Value
            if (ngay_kt && (ngay_kt + '').indexOf('/') > 0)
              try {
                ngay_kt = moment(ngay_kt, ngay_kt.length > 10 ? 'DD/MM/YYYY HH:mm:ss' : 'DD/MM/YYYY').toDate()
              } catch (ex) {}
            if (ngay_kt)
              try {
                ngay_kt = moment(ngay_kt).toDate()
              } catch (ex) {}
          }
          if (ItemList[i].sFieldName == 'THOIGIAN_BD') {
            b_ngay_bd = true
            ItemList[i].sValue = this.gridEditors[i].Value
            ngay_bd = this.gridEditors[i].Value
            try {
              ngay_bd = moment(ngay_bd, ngay_bd.length > 10 ? 'DD/MM/YYYY HH:mm:ss' : 'DD/MM/YYYY').toDate()
            } catch (ex) {}
          }
          if (ItemList[i].sFieldName == 'THOIGIAN_KT') {
            b_ngay_kt = true
            ItemList[i].sValue = this.gridEditors[i].Value
            ngay_kt = this.gridEditors[i].Value

            if (ngay_kt && (ngay_kt + '').indexOf('/') > 0)
              try {
                ngay_kt = moment(ngay_kt, ngay_kt.length > 10 ? 'DD/MM/YYYY HH:mm:ss' : 'DD/MM/YYYY').toDate()
              } catch (ex) {}
            if (ngay_kt)
              try {
                ngay_kt = moment(ngay_kt).toDate()
              } catch (ex) {}
          }
          if (b_ngay_bd == true && b_ngay_kt == true) break
        }
        //moment(new Date()).format("DD/MM/YYYY")
        if (b_ngay_bd == true && b_ngay_kt == true) {
          ngay_kt = new Date(ngay_bd)
          ngay_kt = ngay_kt.setMonth(ngay_kt.getMonth() + sothang * 1) //ngay_bd.AddMonths(sothang);
          ngay_kt = new Date(ngay_kt)
          //ngay_kt = moment(ngay_bd).add(sothang*1,'M').toDate();
          for (var index_1 = 0; index_1 < ItemList.length; ++index_1) {
            if (ItemList[index_1].sFieldName == 'NGAY_KT') {
              try {
                ItemList[index_1].sValue = moment(ngay_kt).format('DD/MM/YYYY')
              } catch (ex) {
                ItemList[index_1].sValue = ngay_kt
              }
              this.gridEditors[index_1].Value = ItemList[index_1].sValue //moment(ngay_kt).format("DD/MM/YYYY");
            }

            if (ItemList[index_1].sFieldName == 'THOIGIAN_KT') {
              try {
                ItemList[index_1].sValue = moment(ngay_kt).format('DD/MM/YYYY HH:mm:ss')
              } catch (ex) {
                ItemList[index_1].sValue = ngay_kt
              }
              this.gridEditors[index_1].Value = ItemList[index_1].sValue //moment(ngay_kt).format("DD/MM/YYYY HH:mm:ss");
            }
          }
        }
      }

      if (repositoryItemTextEdit.Tag == 'TONGSO_ND') {
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IOFFICE) {
          let textValue = repositoryItemTextEdit.Value

          if (!textValue || textValue == '' || isNaN(textValue)) return

          this._sl_cha = textValue
          this.HT_ThietBi()
          this._sl_cha = -1
        }
      }
      if (repositoryItemTextEdit.Tag == 'SL_MAILING') {
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MEETING || this.listbox.loaihinh_tb.value == LoaiHinhTB.HNTH_NGN) {
          let textValue = repositoryItemTextEdit.Value

          if (textValue == '' || isNaN(textValue)) return

          this._sl_cha = textValue
          this.HT_ThietBi()
          this._sl_cha = -1
        }
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MCAP) {
          let textValue = repositoryItemTextEdit.Value

          if (textValue == '' || isNaN(textValue)) return
          let sothang_mcap = 0
          for (let k = 0; k < this.gridEditors.length; k++) {
            if (ItemList[k].sFieldName == 'SO_THANG') {
              sothang_mcap = this.gridEditors[k].Value == '' ? 0 : this.gridEditors[k].Value
            }
          }
          if (sothang_mcap == 0) {
            sothang_mcap = 12
          }
          let tyle_thoigian = sothang_mcap / 12

          this._sl_cha = textValue * tyle_thoigian
          this.HT_ThietBi()
          this._sl_cha = -1
        }
      }

      if (repositoryItemTextEdit.Tag == 'SO_THANG') {
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_MCAP) {
          let textValue = repositoryItemTextEdit.Value

          if (!textValue || textValue == '' || isNaN(textValue)) return
          let soluong_mcap = 0
          for (let k = 0; k < this.gridEditors.length; k++) {
            if (ItemList[k].sFieldName == 'SL_MAILING') {
              soluong_mcap = !this.gridEditors[k].Value || this.gridEditors[k].Value == '' ? 0 : this.gridEditors[k].Value
            }
          }
          if (soluong_mcap == 0) {
            soluong_mcap = 1
          }

          let so_thang_mcap = 0
          if (textValue % 12 != 0) {
            so_thang_mcap = 12
          } else {
            so_thang_mcap = textValue
          }
          this._sl_cha = (so_thang_mcap / 12) * soluong_mcap
          this.HT_ThietBi()
          this._sl_cha = -1
        }
      }
    },
    repositoryItemTextEdit_EditValueChanging(repoTextEdit) {
      // TextEdit repoTextEdit = (sender as TextEdit);
      let textValue = repoTextEdit.Value //repoTextEdit.EditValue.ToString();
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.ELEARNING) {
        let phanloai_dv = ''
        for (var item of this.ItemList) {
          if (item.sFieldName == 'PHANLOAI_ID') {
            phanloai_dv = item.sValue
            break
          }
        }
        if (phanloai_dv == '97') {
          if (repoTextEdit.Tag == 'TONGSO_ND') {
            if (repoTextEdit.Value != '0') {
              this.$toast.error('Bạn không cần nhập số lượng giáo viên cho gói doanh nghiệp')
              repoTextEdit.Cancel = true //FIXME can tim cach cancel thay doi
              repoTextEdit.Value = 0 //FIXME fix tam cho van de o dong tren, thay vi cancel thay doi thi cho ve gia tri dung mac dinh.
            }
          }
          if (repoTextEdit.Tag == 'SOLUONG') {
            if (repoTextEdit.NewValue != '0') {
              this.$toast.error('Bạn không cần nhập số lượng giáo viên cho gói doanh nghiệp')
              repoTextEdit.Cancel = true //FIXME can tim cach cancel thay doi
              repoTextEdit.Value = 0 //FIXME fix tam cho van de o dong tren, thay vi cancel thay doi thi cho ve gia tri dung mac dinh.
            }
          }
        }
      }
    },
    repositoryItemTextEdit_Leave() {
      //Cho nay kha nang khong can vi binding 2 chieu nen data update san roi. Neu van can thi bo comment dong duoi, check lai xem co this.$ hay this.gr....$
      //this.grvMacdinh.$forceUpdate();
    },
    repositoryItemDateEdit_EditValueChanged(repositoryItemDateEdit) {
      try {
        //DateEdit repositoryItemDateEdit = (sender as DateEdit);
        // this.tlstpTop.Focus();
        // this.grvMacdinh.Focus();
        // RepositoryItemDateEdit repositoryItemDateEdit = !(sender is DateEdit) ? sender as RepositoryItemDateEdit : (sender as DateEdit).Properties;
        let ItemList = this.ItemList
        if (repositoryItemDateEdit.Tag == 'NGAY_BD') {
          let b_ngay_bd = false
          let b_ngay_kt = false
          let b_sothang = false
          let d_ngay_bd = new Date() //tt_nd.ngay_cn;
          let d_ngay_kt = new Date() //tt_nd.ngay_cn;
          let sothang = 0
          //int thanghuong_dc = Convert.ToInt32(dsDC_HDTB.Tables[0].Rows[0]["thang_huongdc"].ToString());

          for (var i = 0; i < ItemList.length; i++) {
            if (ItemList[i].sValue && ItemList[i].sValue != '' && ItemList[i].sFieldName == 'SO_THANG') {
              b_sothang = true
              sothang = this.gridEditors[i].Value
            }
            if (ItemList[i].sFieldName == 'NGAY_BD' && this.gridEditors[i].Value != null) {
              b_ngay_bd = true
              ItemList[i].sValue = this.gridEditors[i].Value
              d_ngay_bd = this.gridEditors[i].Value
              try {
                d_ngay_bd = moment(d_ngay_bd, d_ngay_bd.length > 10 ? 'DD/MM/YYYY HH:mm:ss' : 'DD/MM/YYYY').toDate()
              } catch (ex) {}
            }
            if (ItemList[i].sFieldName == 'NGAY_KT') b_ngay_kt = true

            if (b_ngay_bd == true && b_ngay_kt == true && b_sothang == true) break
          }
          if (b_ngay_bd == true && b_ngay_kt == true && b_sothang == true) {
            d_ngay_kt = new Date(d_ngay_bd)
            d_ngay_kt = new Date(d_ngay_kt.setMonth(d_ngay_kt.getMonth() + sothang * 1)) //d_ngay_bd.AddMonths(sothang);
            for (var index_1 = 0; index_1 < ItemList.length; ++index_1) {
              if (ItemList[index_1].sFieldName == 'NGAY_KT') {
                // ItemList[index_1].sValue = d_ngay_kt.ToString("dd/MM/yyyy");
                try {
                  ItemList[index_1].sValue = moment(d_ngay_kt).format('DD/MM/YYYY')
                } catch (ex) {
                  ItemList[index_1].sValue = d_ngay_kt
                }
                this.gridEditors[index_1].Value = moment(d_ngay_kt).format('DD/MM/YYYY')
              }
              if (ItemList[index_1].sFieldName == 'NGAY_DUYTRI' && this.listbox.loaihinh_tb.value == LoaiHinhTB.VEDU_LIB) {
                // ItemList[index_1].sValue = d_ngay_kt.ToString("dd/MM/yyyy");
                try {
                  ItemList[index_1].sValue = moment(d_ngay_kt).format('DD/MM/YYYY')
                } catch (ex) {
                  ItemList[index_1].sValue = d_ngay_kt
                }
                d_ngay_kt = new Date(d_ngay_bd)
                this.gridEditors[index_1].Value = moment(new Date(d_ngay_kt.setMonth(d_ngay_kt.getMonth() + 12))).format('DD/MM/YYYY') //d_ngay_bd.AddMonths(12);
              }
            }
          }
          // grcMacdinh.RefreshDataSource();
          //Cho nay kha nang khong can vi binding 2 chieu nen data update san roi. Neu van can thi bo comment dong duoi, check lai xem co this.$ hay this.gr....$
          //this.grvMacdinh.$forceUpdate();
        }
      } catch (ex) {
        this.$toast.error('Có lỗi: ' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async repositoryItemLookUpEdit_EditValueChanged(repositoryItemLookUpEdit) {
      if (!(await this.repositoryItemLookUpEdit_EditValueChanging(repositoryItemLookUpEdit))) return
      //Neu la linhvuc_id thi reset lai thong tin dich vu gia tang dang ky (Neu co) Do DVGT phu thuoc linh vuc
      try {
        let ItemList = this.ItemList
        // RepositoryItemGridLookUpEdit repositoryItemLookUpEdit = !(sender is GridLookUpEdit) ? sender as RepositoryItemGridLookUpEdit : (sender as GridLookUpEdit).Properties;
        this.PhanLoai_ID = ',' + repositoryItemLookUpEdit.Value + ',' //PhanLoai_ID = "," + ((GridLookUpEdit)sender).EditValue.ToString() + ",";
        //if (repositoryItemLookUpEdit.ValueMember == "LINHVUC_ID")
        if (repositoryItemLookUpEdit.ID == 'LINHVUC_ID') {
          //FIXME can test ky lai cho nay, ValueMember co kha nang ~ ID, neu khong phai tim cach khac xu ly!!!
          this.LAY_DS_DVGT_MACDINH(this.listbox.loaihinh_tb.value)
        }
        if (repositoryItemLookUpEdit.ID == 'THOIHAN_ID') {
          //FIXME can test ky lai cho nay, ValueMember co kha nang ~ ID, neu khong phai tim cach khac xu ly!!!
          let thoihan = repositoryItemLookUpEdit.Value //((GridLookUpEdit)sender).EditValue.ToString();
          if (thoihan == '2') {
            for (var ii = 0; ii < this.ItemList.length; ii++) {
              if (!this.gridEditors[ii] || !this.ItemList[ii]) continue
              if (this.ItemList[ii].sFieldName == 'SO_THANG' && (!this.ItemList[ii].sValue || this.ItemList[ii].sValue <= 0)) {
                this.ItemList[ii].sValue = '1200'
                this.gridEditors[ii].Value = 1200
              }
              if (this.ItemList[ii].sFieldName == 'NGAY_KT' && !this.ItemList[ii].sValue) {
                let ngaycn = new Date()
                ngaycn = new Date(ngaycn.setMonth(ngaycn.getMonth() + 1200))
                this.ItemList[ii].sValue = moment(ngaycn).format('DD/MM/YYYY')
                this.gridEditors[ii].Value = moment(ngaycn).format('DD/MM/YYYY')
              }
            }
          } else {
            for (var ii = 0; ii < this.ItemList.length; ii++) {
              if (this.ItemList[ii].sFieldName == 'SO_THANG' && (!this.ItemList[ii].sValue || this.ItemList[ii].sValue <= 0)) {
                this.ItemList[ii].sValue = '0'
                this.gridEditors[ii].Value = 0
              }
              if (this.ItemList[ii].sFieldName == 'NGAY_KT' && !this.ItemList[ii].sValue) {
                let ngaycn = new Date()
                this.ItemList[ii].sValue = moment(ngaycn).format('DD/MM/YYYY')
                this.gridEditors[ii].Value = moment(ngaycn).format('DD/MM/YYYY')
                // this.ItemList[ii].sValue = tt_nd.ngay_cn.ToString("dd/MM/yyyy");
                // this.gridEditors[ii].Value = tt_nd.ngay_cn;
              }
            }
          }
        }
        if (repositoryItemLookUpEdit.ID == 'PHANLOAI_ID' || (repositoryItemLookUpEdit.ID == 'LOAICTS_ID' && this.listbox.loaihinh_tb.value == LoaiHinhTB.SMART_CA)) {
          ////FIXME can test ky lai cho nay, ValueMember co kha nang ~ ID, neu khong phai tim cach khac xu ly!!!
          //Nếu dịch vụ là 5002 thì lấy lại thông tin combo box tốc độ
          for (var i = 0; i < ItemList.length; i++) {
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.BRANDNAME && repositoryItemLookUpEdit.Value && repositoryItemLookUpEdit.Value != '0')
              if (ItemList[i].sFieldName.indexOf('LINHVUC_') == 0 && ItemList[i].sFieldName.indexOf('_ID') == ItemList[i].sFieldName.length - 3)
                if (ItemList[i].SqlData && ItemList[i].SqlData.length > 0) {
                  let newds = ItemList[i].SqlData.filter((x) => x.PHANLOAI_ID == repositoryItemLookUpEdit.Value)
                  if (newds && newds.length > 0) {
                    newds.unshift({ LINHVUC_ID: 0, LABEL_TYPE_NAME: '', PHANLOAI_ID: 0 })
                    this.gridEditors[i].DataSource = newds.map((x) => ({ text: x[ItemList[i].sLookUpValueField], id: x[ItemList[i].sLookUpKeyField] }))
                    if (!this.gridEditors[i].DataSource.find((x) => x.id == this.gridEditors[i].Value)) {
                      this.gridEditors[i].Value = this.gridEditors[i].DataSource[0].id
                      ItemList[i].sValue = this.gridEditors[i].DataSource[0].id
                      ItemList[i].Value = this.gridEditors[i].DataSource[0].id
                    }
                  } else {
                    this.gridEditors[i].DataSource = [{ text: 'Không áp dụng', id: 0 }]
                    this.gridEditors[i].Value = 0
                    ItemList[i].sValue = 0
                    ItemList[i].Value = 0
                  }
                }
            if (ItemList[i].sFieldName == 'PHANLOAI_ID' || ItemList[i].sFieldName == 'LOAICTS_ID') {
              ItemList[i].sValue = repositoryItemLookUpEdit.Value
            }
            if (ItemList[i].strDepandField == 'DAILY' || (ItemList[i].sFieldName == 'LINHVUC_ID' && this.listbox.loaihinh_tb.value != LoaiHinhTB.BRANDNAME)) {
              let SQL = await this.ReturnSqlStr(ItemList, i)
              let data = ItemList[i].SqlData
              if (this.gridEditors[i]) this.gridEditors[i].DataSource = data.map((x) => ({ text: x[ItemList[i].sLookUpValueField], id: x[ItemList[i].sLookUpKeyField] }))
              // await API.post_sp_huonggiao_runsql(this.axios, { "command": SQL }).then((response) => {
              //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //     return response.data.data.data_json;
              //   }
              //   else return [];
              // });//this.bangts.GetSQL(SQL, "");
              //((RepositoryItemGridLookUpEdit)gridEditors[i].RepositoryItem).DataSource = (object)data.Tables[0];
              // break;
            }
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.ELEARNING) {
              let phanloai_id_elearning = repositoryItemLookUpEdit.Value //((GridLookUpEdit)sender).EditValue.ToString();
              if (phanloai_id_elearning == '97') {
                // gói doanh nghiệp
                for (var ii = 0; ii < ItemList.length; ii++) {
                  if (ItemList[ii].sFieldName == 'TONGSO_ND') {
                    ItemList[ii].sValue = '0'
                    this.gridEditors[ii].Value = '0'
                  }
                  if (ItemList[ii].sFieldName == 'SOLUONG') {
                    ItemList[ii].sValue = '0'
                    this.gridEditors[ii].Value = '0'
                  }
                }
              }
            }
          }
        }
        if (repositoryItemLookUpEdit.ID == 'TOCDO_ID') {
          //FIXME can test ky lai cho nay, ValueMember co kha nang ~ ID, neu khong phai tim cach khac xu ly!!!
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.TTDL_HDDT) {
            // VNPT Invoice
            var invoiceTocdo_id = repositoryItemLookUpEdit.Value
            API.get_tocdo_adsl(this.axios, {})
              .then((response) => {
                //.post_sp_huonggiao_runsql(this.axios, { "command": `select ${DatabaseConstants.DB2}.TUDONG_TINHSOTHANG_SD_THEO_GOICUOC(${this.listbox.loaihinh_tb.value}) kq from dual` }).then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  let datalist = response.data.data //.data_json;
                  if (!datalist) datalist = []
                  let currentData = datalist.find((x) => x.tocdo_id == invoiceTocdo_id)
                  for (var i = 0; i < ItemList.length; i++)
                    if (ItemList[i].sFieldName == 'SL_MAILING') {
                      if (currentData && currentData.ca_key_length && currentData.ca_key_length > 0) {
                        ItemList[i].sValue = currentData.ca_key_length + ''
                        ItemList[i].Value = currentData.ca_key_length
                        this.gridEditors[i].Value = currentData.ca_key_length
                      } else {
                        ItemList[i].sValue = ''
                        ItemList[i].Value = ''
                        this.gridEditors[i].Value = ''
                      }
                    }
                }
              })
              .catch(() => {})
          }
          let vtocdo_id = 0
          let vmuccuoc_id = 0
          for (var i = 0; i < ItemList.length; i++) {
            if (ItemList[i].sFieldName == 'TOCDO_ID') {
              ItemList[i].sValue = repositoryItemLookUpEdit.Value //((GridLookUpEdit)sender).EditValue.ToString();
              vtocdo_id = ItemList[i].sValue

              this.tocdo_id = vtocdo_id
              this.listbox.cboGoiCuocAdsl.value = vtocdo_id
              await this.HT_GIAODIEN_DONVI();
              await this.HT_DS_KhuyenMai_Combobox()
              try {
                let checkTD = await API.post_tudong_tinhsothang_sd_theo_goicuoc(this.axios, { vloaitb_id: this.listbox.loaihinh_tb.value }).then((response) => {
                  //.post_sp_huonggiao_runsql(this.axios, { "command": `select ${DatabaseConstants.DB2}.TUDONG_TINHSOTHANG_SD_THEO_GOICUOC(${this.listbox.loaihinh_tb.value}) kq from dual` }).then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    return response.data.data //.data_json;
                  } else return []
                })
                // if (tdan.GET_VALUE_FUNC("{?DB2}.TUDONG_TINHSOTHANG_SD_THEO_GOICUOC", "vloaitb_id", this.listbox.loaihinh_tb.value).ToString() == "ok")
                // if (checkTD && checkTD.length>0 && checkTD[0].kq && checkTD[0].kq == "ok")
                //if (checkTD && checkTD.length>0 && checkTD[0].kq && checkTD[0].kq == "ok")
                if (checkTD && checkTD == 'ok') {
                  let dt_tocdo_goicuoc = await API.post_dt_tocdo_goicuoc(this.axios, { id: vtocdo_id }).then((response) => {
                    //.post_sp_huonggiao_runsql(this.axios, { "command": `Select sothang_sd, rc_id from ${DatabaseConstants.DB2}.tocdo_adsl where tocdo_id = ${vtocdo_id}` }).then((response) => {
                    if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                      return response.data.data //.data_json;
                    } else return []
                  }) //objCheckData.GET_DATA_SQL(@"Select sothang_sd, rc_id from {?DB2}.tocdo_adsl where tocdo_id = :tocdo_id", "tocdo_id", vtocdo_id);
                  let so_thang_sd = dt_tocdo_goicuoc[0]['sothang_sd']
                  var index_so_thang = -1
                  var index_ngay_bd = -1
                  var index_ngay_kt = -1
                  for (var index_1 = 0; index_1 < ItemList.length; ++index_1) {
                    if (ItemList[index_1].sFieldName == 'SO_THANG') {
                      index_so_thang = index_1
                    }
                    if (ItemList[index_1].sFieldName == 'NGAY_BD') {
                      index_ngay_bd = index_1
                    }
                    if (ItemList[index_1].sFieldName == 'NGAY_KT') {
                      index_ngay_kt = index_1
                    }
                  }
                  try {
                    if (!(index_so_thang == -1 || index_ngay_bd == -1 || index_ngay_kt == -1)) {
                      if (this.gridEditors[index_so_thang]) this.gridEditors[index_so_thang].Value = so_thang_sd
                      ItemList[index_so_thang].sValue = so_thang_sd
                      if (!ItemList[index_ngay_bd].sValue && this.gridEditors[index_ngay_bd] && this.gridEditors[index_ngay_bd].Value) ItemList[index_ngay_bd].sValue = this.gridEditors[index_ngay_bd].Value
                      let tmpdate = moment(ItemList[index_ngay_bd].sValue, 'DD/MM/YYYY').toDate()
                      tmpdate = new Date(tmpdate.setMonth(tmpdate.getMonth() + so_thang_sd))
                      let ngay_kt_orm = moment(tmpdate).format('DD/MM/YYYY') //(DateTime.ParseExact(ItemList[index_ngay_bd].sValue, "dd/MM/yyyy", CultureInfo.InvariantCulture).AddMonths(Convert.ToInt32(so_thang_sd))).ToString("dd/MM/yyyy");
                      if (this.gridEditors[index_ngay_kt]) this.gridEditors[index_ngay_kt].Value = ngay_kt_orm
                      ItemList[index_ngay_kt].sValue = ngay_kt_orm
                    }
                  } catch (ex) {
                    if (this.debug) console.error('DEBUG', ex)
                  }
                }
                let kq_kt_tt_tocdo = await API.post_tudong_tinhthuoctinh_tocdo_adsl(this.axios, { id: this.listbox.loaihinh_tb.value, id1: vtocdo_id }).then((response) => {
                  //.post_sp_huonggiao_runsql(this.axios, { "command": `select ${DatabaseConstants.DB2}.TUDONG_TINHTHUOCTINH_TOCDO_ADSL(${this.listbox.loaihinh_tb.value,vtocdo_id}) kq from dual` }).then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000' && response.data.data.data_json && response.data.data.data_json.kq) {
                    return response.data.data.kq ? response.data.data.kq : -1 //.data_json.kq;
                  } else return -1
                }) //tdan.GET_VALUE_FUNC("{?DB2}.TUDONG_TINHTHUOCTINH_TOCDO_ADSL", "vloaitb_id", this.listbox.loaihinh_tb.value, "vtocdo_id", vtocdo_id).ToString();
                if (kq_kt_tt_tocdo != '-1') {
                  // DataTable dt_tocdo_goicuoc = objCheckData.GET_DATA_SQL(@"Select sothang_sd, rc_id from {?DB2}.tocdo_adsl where tocdo_id = :tocdo_id", "tocdo_id", vtocdo_id);
                  let thuoctinh = kq_kt_tt_tocdo.split(';')[0]
                  let giatri = kq_kt_tt_tocdo.split(';')[1]
                  var index_thuoctinh = -1
                  for (var index_1 = 0; index_1 < ItemList.length; ++index_1) {
                    if (ItemList[index_1].sFieldName == thuoctinh) {
                      if (kq_kt_tt_tocdo.split(';')[2] == '1') {
                        this.gridEditors[index_1].Value = giatri
                      } else {
                        this.gridEditors[index_1].Value = giatri
                      }
                      ItemList[index_1].sValue = giatri
                    }
                  }
                }

                checkTD = await API.post_kiemtra_dichvu_tudong_thuoctinh_goicuoc(this.axios, { vloaitb_id: this.listbox.loaihinh_tb.value }).then((response) => {
                  //.post_sp_huonggiao_runsql(this.axios, { "command": `select ${DatabaseConstants.DB2}.KIEMTRA_DICHVU_TUDONG_THUOCTINH_GOICUOC(${this.listbox.loaihinh_tb.value}) kq from dual` }).then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    return response.data.data //.data_json;
                  } else return []
                })
                //if (tdan.GET_VALUE_FUNC("{?DB2}.KIEMTRA_DICHVU_TUDONG_THUOCTINH_GOICUOC", "vloaitb_id", this.listbox.loaihinh_tb.value).ToString() == "ok")
                if (checkTD && checkTD == 'ok') {
                  let dt_tskt_goicuoc = await API.post_lay_thongso_kt_goicuoc(this.axios, { vtocdo_id: this.tocdo_id }).then((response) => {
                    if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                      return this.UpperCasePropertyList(response.data.data)
                    } else return []
                  }) //tdan.GET_DATA_PROC("{?DB2}.LAY_THONGSO_KT_GOICUOC", "vtocdo_id", tocdo_id);
                  if (dt_tskt_goicuoc && dt_tskt_goicuoc.length > 0) {
                    for (let r of dt_tskt_goicuoc) {
                      for (var i_ts = 0; i_ts < ItemList.length; i_ts++) {
                        if (ItemList[i_ts].sFieldName == r['FIELD_NAME']) {
                          if (r['DATA_TYPE'] == '0') {
                            ItemList[i_ts].sValue = r['FIELD_VALUE']
                            this.gridEditors[i_ts].Value = r['FIELD_VALUE']
                          }

                          if (r['DATA_TYPE'] == '1') {
                            ItemList[i_ts].sValue = r['FIELD_VALUE']
                            this.gridEditors[i_ts].Value = r['FIELD_VALUE']
                            if (r['FIELD_NAME'] == 'SO_THANG') {
                              let vt_ngaybd = -1,
                                vt_ngaykt = -1
                              for (var i_gr = 0; i_gr < ItemList.length; i_gr++) {
                                if (ItemList[i_gr].sFieldName == 'NGAY_BD') {
                                  vt_ngaybd = i_gr
                                }
                                if (ItemList[i_gr].sFieldName == 'NGAY_KT') {
                                  vt_ngaykt = i_gr
                                  //break;
                                }
                              }
                              if (vt_ngaybd != -1 || vt_ngaykt != -1) {
                                let tmpdate = moment(ItemList[vt_ngaybd].sValue, 'DD/MM/YYYY').toDate()
                                tmpdate = new Date(tmpdate.setMonth(tmpdate.getMonth() + r['FIELD_VALUE'] * 1))
                                let ngay_kt = moment(tmpdate).format('DD/MM/YYYY')
                                // DateTime ngay_kt = DateTime.ParseExact(ItemList[vt_ngaybd].sValue, "dd/MM/yyyy", CultureInfo.InvariantCulture).AddMonths(Convert.ToInt32(r["FIELD_VALUE"].ToString()));
                                ItemList[vt_ngaykt].sValue = ngay_kt
                                this.gridEditors[vt_ngaykt].Value = ngay_kt
                              }
                            }
                          }

                          if (r['DATA_TYPE'] == 2) {
                            if (r['FIELD_VALUE'].indexOf('NOW') >= 0) {
                              let gt_ngay = r['FIELD_VALUE'].split('+')
                              if (gt_ngay.length == 1) {
                                ItemList[i_ts].sValue = moment(new Date()).format('DD/MM/YYYY') //tt_nd.ngay_cn.ToString("dd/MM/yyyy");
                                this.gridEditors[i_ts].Value = new Date() //tt_nd.ngay_cn;
                              } else {
                                let add = gt_ngay[1] * 1
                                let gt_ngay_gc = moment()
                                  .add(1, gt_ngay[2] ? gt_ngay[2] : 'D')
                                  .toDate()
                                // if (gt_ngay[2] == "Y")
                                // {
                                //     gt_ngay_gc = moment().add(1, 'Y');//tt_nd.ngay_cn.AddYears(add);
                                // }
                                // else if (gt_ngay[2] == "M")
                                // {
                                //     gt_ngay_gc = tt_nd.ngay_cn.AddMonths(add);
                                // }
                                // else
                                // {
                                //     gt_ngay_gc = tt_nd.ngay_cn.AddDays(add);
                                // }
                                ItemList[i_ts].sValue = moment(gt_ngay_gc).format('DD/MM/YYYY')
                                this.gridEditors[i_ts].Value = gt_ngay_gc
                              }
                            } else {
                              ItemList[i_ts].sValue = r['FIELD_VALUE']
                              this.gridEditors[i_ts].Value = moment(r['FIELD_VALUE'], 'DD/MM/YYYY').toDate() //DateTime.ParseExact(r["FIELD_VALUE"].ToString(), "dd/MM/yyyy", CultureInfo.InvariantCulture);
                            }
                          }
                        }
                      }
                    }
                  }
                }
                this.listbox.cboGoiCuocAdsl.value = vtocdo_id
                //FIXME 2 dong nay chi de thong bao gia tri combobox da thay doi, tam bo qua
                // if (this.listbox.cboGoiCuocAdsl.value == 0)
                //     cboGoiCuocAdsl.Properties.GetKeyValue(0);
                repositoryItemLookUpEdit.Value = vtocdo_id
                this.HT_GIAODIEN_DONVI();
                this.HT_DS_KhuyenMai_Combobox()
              } catch (ex) {
                if (this.debug) console.error(ex)
                // Message_Box.Show(ex.Message);
              }
            }
            if (ItemList[i].sFieldName == 'MUCCUOC_ID') {
              vmuccuoc_id = ItemList[i].sValue
              this.muccuoc_id = vmuccuoc_id
              try {
                this.listbox.muccuoc.value = vmuccuoc_id ? vmuccuoc_id : 0 //cboMucCuoc.SelectedValue = vmuccuoc_id;
                // if (this.listbox.muccuoc.list.filter((x) => x.muccuoc_id == this.listbox.muccuoc.value).length <= 0) this.listbox.muccuoc.value = this.listbox.muccuoc.list.length > 0 ? this.listbox.muccuoc.list[0].muccuoc_id : 0 //cboMucCuoc.SelectedIndex = 0;
              } catch (ex) {
                if (this.debug) console.error(ex)
              }
            }
            if (ItemList[i].sFieldName == 'HEDIEUHANH_ID') {
              let SQL = this.ReturnSqlStr(ItemList, i)
              let data = ItemList[i].SqlData
              if (this.gridEditors[i]) {
                if (data && data.length > 0) {
                  data = data.map((x) => ({ text: x[this.gridEditors[i].DisplayMember], id: x[this.gridEditors[i].ValueMember] }))
                }
                this.gridEditors[i].DataSource = data
              }
              // await API.post_sp_huonggiao_runsql(this.axios, { "command": SQL }).then((response) => {
              //   if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              //     return response.data.data.data_json;
              //   }
              //   else return [];
              // });
              // DataSet data = this.bangts.GetSQL(SQL, "");
              // ((RepositoryItemGridLookUpEdit)gridEditors[i].RepositoryItem).DataSource = (object)data.Tables[0];
              // break
            }
          }
          let pdata = {
            vapld_id: this.diachiLD.AP_ID ? this.diachiLD.AP_ID : 0,
            vdoituong_id: this.listbox.doituong.value ? this.listbox.doituong.value : this.listbox.doituong.list && this.listbox.doituong.list[0] ? this.listbox.doituong.list[0].doituong_id : 0,
            vkhuld_id: this.diachiLD.KHU_ID ? this.diachiLD.KHU_ID : 0,
            vloaitb_id: this.listbox.loaihinh_tb.value,
            vmuccuoc_id: vmuccuoc_id,
            vngay: this.NgayYeuCau.indexOf(' ') > 0 ? this.NgayYeuCau.substring(0, this.NgayYeuCau.indexOf(' ')) : this.NgayYeuCau,
            vphold_id: this.diachiLD.PHO_ID ? this.diachiLD.PHO_ID : 0,
            vphuongld_id: this.diachiLD.PHUONG_ID ? this.diachiLD.PHUONG_ID : 0,
            vtocdo_id: vtocdo_id,
            vloainha_id: this.diachiLD.LOAINHA_ID,
          }
          let api = cache.getters.getFromCache('post_lay_ds_mucuoc_tb', pdata)

          if (!api) api = API.post_lay_ds_mucuoc_tb(this.axios, pdata)
          else
            api = new Promise((resolve, reject) => {
              resolve(api)
            })

          let ds = await api.then((response) => {
            //API.post_lay_ds_mucuoc_tb(this.axios, pdata).then((response) => {
            cache.dispatch('addToCache', { key: 'post_lay_ds_mucuoc_tb', subkey: pdata, data: response })
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          }) //tcdanhba.LAY_DS_MUCUOC_TB(khuld_id, apld_id, phold_id, phuongld_id, this.listbox.loaihinh_tb.value, this.listbox.doituong.value, vtocdo_id, vmuccuoc_id, dtpNgayYeuCau.Value.ToString("dd/MM/yyyy"));
          if (ds.length > 0) {
            this.listbox.muccuoc_tb.list = ds
            if (!this.listbox.muccuoc_tb.value || !this.listbox.muccuoc_tb.list.find((x) => (x.muccuoctb_id ? x.muccuoctb_id : x.mucuoctb_id) == this.listbox.muccuoc_tb.value)) this.listbox.muccuoc_tb.value = ds[0].mucuoctb_id
            // cboMucCuocTB.ValueMember = "mucuoctb_id";
            // cboMucCuocTB.DisplayMember = "tenmuccuoc";
          } else this.listbox.muccuoc_tb.list = []
          this.LayTienTheoKhoanMuc()
          this.LAY_DS_DVGT_MACDINH(this.listbox.loaihinh_tb.value)
          this.grvMacdinh_RowCellStyle();
        }
        if (repositoryItemLookUpEdit.ID == 'MUCCUOC_ID') {
          // FIXME thay ValueMember = ID, can test lai
          let vtocdo_id = 0
          let vmuccuoc_id = 0
          for (var i = 0; i < ItemList.length; i++) {
            if (ItemList[i].sFieldName == 'MUCCUOC_ID') {
              ItemList[i].sValue = repositoryItemLookUpEdit.Value //((GridLookUpEdit)sender).EditValue.ToString();
              vmuccuoc_id = ItemList[i].sValue * 1
              this.muccuoc_id = vmuccuoc_id
              try {
                this.listbox.muccuoc.value = vmuccuoc_id //cboMucCuoc.SelectedValue = vmuccuoc_id;
                if (this.listbox.muccuoc.list.filter((x) => x.muccuoc_id == this.listbox.muccuoc.value).length <= 0) this.listbox.muccuoc.value = this.listbox.muccuoc.list.length > 0 ? this.listbox.muccuoc.list[0].muccuoc_id : 0 //cboMucCuoc.SelectedIndex = 0;
              } catch (ex) {}
            }
            if (ItemList[i].sFieldName == 'TOCDO_ID') {
              vtocdo_id = ItemList[i].sValue * 1
              this.tocdo_id = vtocdo_id
              try {
                this.listbox.cboGoiCuocAdsl.value = vtocdo_id
                await this.HT_GIAODIEN_DONVI();
                // if (this.listbox.cboGoiCuocAdsl.value == 0) //Bo qua doan nay vi chi co chuc nang raise event thay doi gia tri
                //     cboGoiCuocAdsl.Properties.GetKeyValue(0);
              } catch (ex) {}
            }
          }

          let pdata = {
            vapld_id: this.diachiLD.AP_ID ? this.diachiLD.AP_ID : 0,
            vdoituong_id: this.listbox.doituong.value ? this.listbox.doituong.value : this.listbox.doituong.list && this.listbox.doituong.list[0] ? this.listbox.doituong.list[0].doituong_id : 0,
            vkhuld_id: this.diachiLD.KHU_ID ? this.diachiLD.KHU_ID : 0,
            vloaitb_id: this.listbox.loaihinh_tb.value,
            vmuccuoc_id: vmuccuoc_id,
            vngay: this.NgayYeuCau.indexOf(' ') > 0 ? this.NgayYeuCau.substring(0, this.NgayYeuCau.indexOf(' ')) : this.NgayYeuCau,
            vphold_id: this.diachiLD.PHO_ID ? this.diachiLD.PHO_ID : 0,
            vphuongld_id: this.diachiLD.PHUONG_ID ? this.diachiLD.PHUONG_ID : 0,
            vtocdo_id: vtocdo_id,
            vloainha_id: this.diachiLD.LOAINHA_ID,
          }
          let api = cache.getters.getFromCache('post_lay_ds_mucuoc_tb', pdata)

          if (!api) api = API.post_lay_ds_mucuoc_tb(this.axios, pdata)
          else
            api = new Promise((resolve, reject) => {
              resolve(api)
            })

          let ds = await api.then((response) => {
            //API.post_lay_ds_mucuoc_tb(this.axios, pdata).then((response) => {
            cache.dispatch('addToCache', { key: 'post_lay_ds_mucuoc_tb', subkey: pdata, data: response })
            // let ds = await API.post_lay_ds_mucuoc_tb(this.axios, pdata).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          // let ds = tcdanhba.LAY_DS_MUCUOC_TB(khuld_id, apld_id, phold_id, phuongld_id, this.listbox.loaihinh_tb.value, this.listbox.doituong.value, vtocdo_id, vmuccuoc_id, dtpNgayYeuCau.Value.ToString("dd/MM/yyyy"));
          if (ds.length > 0) {
            this.listbox.muccuoc_tb.list = ds
            if (!this.listbox.muccuoc_tb.value || !this.listbox.muccuoc_tb.list.find((mc) => (mc.muccuoctb_id ? mc.muccuoctb_id : mc.mucuoctb_id) == this.listbox.muccuoc_tb.value)) this.listbox.muccuoc_tb.value = ds[0].mucuoctb_id
            // cboMucCuocTB.ValueMember = "mucuoctb_id";
            // cboMucCuocTB.DisplayMember = "tenmuccuoc";
          } else this.listbox.muccuoc_tb.list = [] //cboMucCuocTB.DataSource = null;
        }
      } catch (ex) {
        this.$toast.error('Có lỗi: ' + ex)
        if (this.debug) console.error(ex)
      }
    },
    repositoryItemLookUpEdit_leave() {
      //Cho nay kha nang khong can vi binding 2 chieu nen data update san roi. Neu van can thi bo comment dong duoi, check lai xem co this.$ hay this.gr....$
      //this.grvMacdinh.$forceUpdate();
    },
    async repositoryItemLookUpEdit_EditValueChanging(repositoryItemLookUpEdit) {
      let ItemList = this.ItemList
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.CA) {
        // RepositoryItemGridLookUpEdit repositoryItemLookUpEdit = !(sender is GridLookUpEdit) ? sender as RepositoryItemGridLookUpEdit : (sender as GridLookUpEdit).Properties;
        //FIXME comment tạm lại vì dữ liệu phân loại khách hàng thiếu field loại
        // if (repositoryItemLookUpEdit.ID == "LOAICTS_ID")
        // {
        //     if (this.vkieukh_id_ == 0)
        //     {
        //         if (repositoryItemLookUpEdit.Value != 1)
        //         {
        //             repositoryItemLookUpEdit.Cancel = false;
        //             this.$toast.error("Bạn chỉ được chọn loại khách hàng cá nhân!");
        //             return false;
        //         }
        //     }
        //     else
        //     {
        //         if (repositoryItemLookUpEdit.Value == 1)
        //         {
        //             repositoryItemLookUpEdit.Cancel = true;
        //             this.$toast.error("Bạn chỉ được chọn loại khách hàng doanh nghiệp hoặc cá nhân thuộc tổ chức/doanh nghiệp!");
        //             return false;
        //         }
        //     }
        // }

        if (repositoryItemLookUpEdit.ID == 'TOCDO_ID') {
          let vtocdo_id = repositoryItemLookUpEdit.Value
          let dt_tocdo_goicuoc = await API.post_dt_tocdo_goicuoc(this.axios, { id: vtocdo_id }).then((response) => {
            //.post_sp_huonggiao_runsql(this.axios, { "command": `Select sothang_sd, rc_id from ${DatabaseConstants.DB2}.tocdo_adsl where tocdo_id = ${vtocdo_id}` }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data //.data_json;
            } else return []
          }) //objCheckData.GET_DATA_SQL(@"Select sothang_sd, rc_id from {?DB2}.tocdo_adsl where tocdo_id = :tocdo_id", "tocdo_id", vtocdo_id);

          let rc_id = dt_tocdo_goicuoc[0]['rc_id'] * 1
          let vloaicts_id = 0
          for (var index_1 = 0; index_1 < ItemList.length; index_1++) {
            if (ItemList[index_1].sFieldName == 'LOAICTS_ID') {
              if (!this.gridEditors[index_1].Value) {
                vloaicts_id = 0
              } else {
                vloaicts_id = this.gridEditors[index_1].Value * 1
              }
              break
            }
          }
          let kt_chon_goicuoc_ca = await API.post_kt_chon_goicuoc_ca(this.axios, { id: rc_id, id1: vloaicts_id }).then((response) => {
            //.post_sp_huonggiao_runsql(this.axios, { "command": `Select ${DatabaseConstants.DB2}.KT_CHON_GOICUOC_CA(${rc_id},${vloaicts_id}) kq from dual` }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data //.data_json;
            } else return response.data.message_detail
          }) //tdan.GET_VALUE_FUNC("{?DB2}.KT_CHON_GOICUOC_CA", "vrc_id", rc_id, "vloaicts_id", vloaicts_id).ToString();
          if (!kt_chon_goicuoc_ca || kt_chon_goicuoc_ca != 'ok') {
            repositoryItemLookUpEdit.Cancel = true //FIXME can xem cach cancel phan xu ly nay!
            this.$toast.error(kt_chon_goicuoc_ca)
            // return false; // FIXME Ham check nay dang loi nen comment tam lai de chay, sua xong bo comment sau.
          }
        }
      }
      return true
    },
    async repositoryItemButtonEdit_ButtonClick(repositoryItemButtonEdit) {
      try {
        let ItemList = this.ItemList
        // BO SUNG 2022-11-02 THANGDM1
        // #region Báo hiệu quốc tế
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.BaoHieuQuocTe || this.listbox.loaihinh_tb.value == LoaiHinhTB.THOAIQT)
        {
            if (repositoryItemButtonEdit.Tag == "THIETBI")
            {
                var ma_pos = "";
                try
                {
                  ma_pos = await API.post_fn_tt_hdtb_cntt(this.axios, {type: 4, param: this.hdtb_id}).then(response=>{
                    if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                      return response.data.data //.data_json;
                    }
                  });
                  // string sql = "select ma_pos from " + DatabaseConstants.DB2 + ".hdtb_cntt where hdtb_id = " + hdtb_id + "";
                  // ma_pos = tdan.GET_VALUE_SQL(sql).ToString();
                  if (!ma_pos)
                  {
                    ma_pos = "";
                      this.$toast.error("Không có thông tin loại cước. Hãy kiểm tra lại thông tin loại cước");
                  }
                }
                catch(ex)
                {
                  if(this.debug) console.error(ex);
                  this.$toast.error("Lỗi lấy thông tin loại cước. Hãy kiểm tra lại thông tin loại cước");
                }
                var loaicuoc = ma_pos.split(',');
                var point = 0;
                for (var i = 0; i < loaicuoc.length; i++)
                {
                  if(!loaicuoc[i] || loaicuoc[i].trim()=="") continue;
                    if ((loaicuoc[i] == 841 || loaicuoc[i] == 844) && this.hdtb_id && this.ma_tb)
                    {
                      this.popupComponent = () => import('./Popups/popupTronGoiBaoHieuQT')
                      this.popupComponentName = 'popupTronGoiBaoHieuQT'

                    }
                    if ((loaicuoc[i] == 842 || loaicuoc[i] == 845) && this.hdtb_id && this.ma_tb)
                    {
                      this.popupComponent = () => import('./Popups/popupGoiSanLuong')
                      this.popupComponentName = 'popupGoiSanLuong'
                    }
                    if ((loaicuoc[i] == 843 || loaicuoc[i] == 846) && this.hdtb_id && this.ma_tb)
                    {
                      this.popupComponent = () => import('./Popups/popupLuyTienSanLuong')
                      this.popupComponentName = 'popupLuyTienSanLuong'
                    }
                    this.popupComponentData = {
                      hdtb_id: this.hdtb_id,
                      ma_tb: this.ma_tb,
                      luong_id: this.luong_id,
                      loaicuoc: loaicuoc[i]
                    }

                    this.Popup('popupComponents')
                    this.popupRetVal = null
                    await waitUntil(()=>this.popupRetVal!=null)
                    if(this.popupRetVal==true) point++;

                    if (point == loaicuoc.length)
                    {
                        for (var j = 0; j < this.ItemList.length; j++)
                        {
                            if (this.ItemList[j].sFieldName == "THIETBI")
                            {
                                this.gridEditors[j].Value = this.tt_nd.ma_nd + " Đã cập nhật";
                                this.ItemList[j].sValue = this.tt_nd.ma_nd + " Đã cập nhật";
                            }
                        }
                    }

                }
            }
        }
        // #endregion
        // #region VNedu Content
        // if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.EduContent)
        // {
        //     string id_truong = "";
        //     string ten_truong = "";
        //     try
        //     {
        //         id_truong = ItemList.ToList().Find(x => x.sFieldName == "MA_PHU").sValue;
        //         ten_truong = ItemList.ToList().Find(x => x.sFieldName == "THUONGHIEU").sValue;
        //     }
        //     catch
        //     {
        //     }

        //     if (repositoryItemButtonEdit.Properties.Tag.ToString() == "ROUTER" && id_truong != "" && ten_truong != "")
        //     {
        //         string kq_check = tdan.GET_VALUE_FUNC("{?DB2}.FN_CHECK_DK_DV_VNEDU_CONTENT", "vloaitb_id", 323, "vtocdo_id", tocdo_id, "vid_truong", id_truong, "vtentruong", ten_truong).ToString();
        //         if (kq_check != "OK")
        //         {
        //             Message_Box.ShowTB(kq_check.ToString());
        //             return;
        //         }
        //         else
        //         {
        //             for (int i = 0; i < ItemList.Length; i++)
        //             {
        //                 if (ItemList[i].sFieldName == "ROUTER")
        //                 {
        //                     gridEditors[i].Value = "Đủ điều kiện";
        //                     ItemList[i].sValue = "Đủ điều kiện";
        //                     grvMacdinh.RefreshData();
        //                 }
        //             }
        //         }
        //     }
        // }
        // #endregion
        // if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.VNPT_HKD)
        // {
        //     frmDiaChiCNTT fdccntt = new frmDiaChiCNTT();
        //     fdccntt.loaitb_id = LoaiHinhTB.VNPT_HKD;
        //     for (int i = 0; i < ItemList.Length; i++)
        //     {
        //         if (ItemList[i].sFieldName == "DIACHI_DT")
        //         {
        //             fdccntt.diachi_text = gridEditors[i].Value.ToString();
        //         }
        //         if (ItemList[i].sFieldName == "MUCDICH_IDS")
        //         {
        //             fdccntt.diachi_phuong = gridEditors[i].Value.ToString();
        //         }
        //     }
        //     fdccntt.ShowDialog();
        //     for (int i = 0; i < ItemList.Length; i++)
        //     {
        //         if (ItemList[i].sFieldName == "DIACHI_DT")
        //         {
        //             gridEditors[i].Value = fdccntt.diachi_text;
        //             ItemList[i].sValue = fdccntt.diachi_text;
        //         }
        //         if (ItemList[i].sFieldName == "MUCDICH_IDS")
        //         {
        //             gridEditors[i].Value = fdccntt.diachi_phuong;
        //             ItemList[i].sValue = fdccntt.diachi_phuong;
        //         }
        //     }
        // }
        // if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.VNPT_IQMS)
        // {
        //     frmDiaChiCNTT fdccntt = new frmDiaChiCNTT();
        //     fdccntt.loaitb_id = LoaiHinhTB.VNPT_IQMS;
        //     for (int i = 0; i < ItemList.Length; i++)
        //     {
        //         if (ItemList[i].sFieldName == "DIACHI_DT")
        //         {
        //             fdccntt.diachi_text = gridEditors[i].Value.ToString();
        //         }
        //         if (ItemList[i].sFieldName == "MUCDICH_IDS")
        //         {
        //             fdccntt.diachi_phuong = gridEditors[i].Value.ToString();
        //         }
        //     }
        //     fdccntt.ShowDialog();
        //     for (int i = 0; i < ItemList.Length; i++)
        //     {
        //         if (ItemList[i].sFieldName == "DIACHI_DT")
        //         {
        //             gridEditors[i].Value = fdccntt.diachi_text;
        //             ItemList[i].sValue = fdccntt.diachi_text;
        //         }
        //         if (ItemList[i].sFieldName == "MUCDICH_IDS")
        //         {
        //             gridEditors[i].Value = fdccntt.diachi_phuong;
        //             ItemList[i].sValue = fdccntt.diachi_phuong;
        //         }
        //     }
        // }

        // if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.SMART_CA)
        // {
        //     if (repositoryItemButtonEdit.Properties.Tag.ToString() == "MA_PHU")
        //     {
        //         frmChonViNganSach f = new frmChonViNganSach();
        //         f.vma_kh = txtMaKH.Text;
        //         f.ShowDialog();
        //         for (int i = 0; i < ItemList.Length; i++)
        //         {
        //             if (ItemList[i].sFieldName == "MA_PHU")
        //             {
        //                 ItemList[i].sValue = f.out_mavi;
        //                 gridEditors[i].Value = f.out_mavi;
        //                 break;
        //             }

        //         }
        //     }
        // }
        // END BO SUNG 2022-11-02 THANGDM1
        // ButtonEdit repositoryItemButtonEdit = (sender as ButtonEdit);
        // if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_SMCC) // bo do khong co chuc nang gi
        // {

        // }
        let kt_api = await API.post_loaihinh_tb_edu_api(this.axios, { id: this.listbox.loaihinh_tb.value }).then((response) => {
          //.post_sp_huonggiao_runsql(this.axios, { "command": `Select ${DatabaseConstants.DB2}.LOAHINH_TB_EDU_API(${this.listbox.loaihinh_tb.value}) kq from dual` }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data[0] && response.data.data[0].kq ? response.data.data[0].kq : 'no' //.data_json.kq;
          } else return 'no'
        }) //tdan.GET_VALUE_FUNC("{?DB2}.LOAHINH_TB_EDU_API", "vloaitb_id", this.listbox.loaihinh_tb.value).ToString();
        if (kt_api == 'ok') {
          if (repositoryItemButtonEdit.Tag == 'SL_MAILING') {
            for (var i = 0; i < ItemList.length; i++) {
              if (ItemList[i].sFieldName == 'SL_MAILING') {
                if (this.listbox.loaihinh_tb.value == LoaiHinhTB.TTDL_HDDT) {
                  this.popupComponentData = { dsHDTB_CT: this.dsHDTB_CT, soluong: this.gridEditors[i].Value || this.gridEditors[i].Value == '' ? 0 : this.gridEditors[i].Value }
                  this.popupComponent = () => import('./Popups/popupChonMauHDDT')
                  this.popupComponentName = 'popupChonMauHDDT'
                  this.Popup('popupComponents')
                  break
                }
              }
            }
          }
          if (repositoryItemButtonEdit.Tag == 'MA_PHU') {
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.Voice_Brandname) {
              this.popup.DSThanhVien = true;
              if (this.buttonSet != 1)
                this.$refs.frmNhapDSThanhVien.hdtb_id = this.hdtb_id
              else
                this.$toast.error('Chưa ghi lại hợp đồng. Hãy ghi lại hợp đồng trước');
              this.$refs.frmNhapDSThanhVien._ds_hdtbct = this.dsHDTB_CT;
              this.$refs.frmNhapDSThanhVien.ShowDialog()

              // this.popupComponentData = {"hdtb_id":this.hdtb_id, _ds_hdtbct: this.dsHDTB_CT};
              // this.popupComponentData.Text = "Nhập danh sách số hiển thị";
              // this.popupComponent = ()=>import('@/modules/contract/setup/ChangeContractOwner/popup/frmNhapDSThanhVien.vue');
              // this.popupComponentName = "frmNhapDSThanhVien";
              // this.Popup('popupComponents');
            } else
              for (var i = 0; i < ItemList.length; i++) {
                if (ItemList[i].sFieldName == 'MA_PHU') {
                  if (ItemList[i].sLookupApi != '') {
                    this.popupComponentData = {
                      loaihinh_tb: this.listbox.loaihinh_tb.value,
                      field_name: ItemList[i].sFieldName,
                      api_url: ItemList[i].sLookupApi,
                      method: ItemList[i].sAPIMethod,
                      hienthi_bang: ItemList[i].sAPIHienThiBang,
                      giatri_trave: ItemList[i].sAPIValueMember,
                      ItemList: ItemList,
                      idx: i
                    }
                    if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_SLL) {
                      this.popupComponentData.Text = 'Lấy thông tin ID trường'
                    }
                    this.popupComponent = () => import('./Popups/popupLayDuLieuTuAPI')
                    this.popupComponentName = 'popupLayDuLieuTuAPI'
                    this.Popup('popupComponents')
                  }
                  break
                }
              }
          }

          if (repositoryItemButtonEdit.Tag == 'SOLUONG') {
            for (var i = 0; i < ItemList.length; i++) {
              if (ItemList[i].sFieldName == 'SOLUONG') {
                try {
                  var id_truong = ItemList.filter((x) => x.sFieldName == 'MA_PHU')[0].sValue
                  let tocdo_id = ItemList.filter((x) => x.sFieldName == 'TOCDO_ID')[0].sValue
                  this.popupComponentData = { id_truong: id_truong, dsHDTB_CT: this.dsHDTB_CT, tocdo_id: tocdo_id }
                  this.popupComponent = () => import('./Popups/popupDangKySoLienLac')
                  this.popupComponentName = 'popupDangKySoLienLac'
                  this.Popup('popupComponents')
                } catch (ex) {
                  this.toast.error('' + ex)
                  if (this.debug) console.error(ex)
                }
              }
            }
          }
        }

        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNEDU_SMARTID) {
          if (repositoryItemButtonEdit.Tag == 'SL_MAILING') {
            for (var i = 0; i < ItemList.length; i++) {
              if (ItemList[i].sFieldName == 'SL_MAILING') {
                this.popupComponentData = { loaitb_id: this.listbox.loaihinh_tb.value, append_name: 'SL_MAILING', saveList: this.dsHDTB_CT, ItemList: ItemList }
                this.popupComponent = () => import('./Popups/popupChiTietHDTB')
                this.popupComponentName = 'popupChiTietHDTB'
                this.Popup('popupComponents')
              }
            }
          }
        }
        if (repositoryItemButtonEdit.Tag == 'MATB_TN') {
          let kieu = this.kieu_ld_kieu
          let dulieu = {}
          switch (kieu * 1) {
            case 2:
              if (this.khachhang.khachhang_id && this.khachhang.khachhang_id > 0) {
                dulieu.khachhang_id = this.khachhang.khachhang_id
                dulieu.kieuld_id = this.listbox.kieu_ld.value
                dulieu.loaitb_id = this.listbox.loaihinh_tb.value
                dulieu.dichvuvt_id = this.listbox.dichvu_vt.value
                this.popupComponentData = dulieu
                this.popupComponent = () => import('./Popups/popupDSTBCungDoiCap')
                this.popupComponentName = 'popupDSTBCungDoiCapCNTT'
                this.popupRetVal = null
                this.Popup('popupComponents')
                let xlykq = setInterval(() => {
                  if (this.popupRetVal) {
                    clearInterval(xlykq)
                    for (var i = 0; i < ItemList.length; i++) {
                      if (ItemList[i].sFieldName == 'MATB_TN') {
                        ItemList[i].sValue = this.popupRetVal.MA_TB
                        this.gridEditors[i].Value = this.popupRetVal.MA_TB
                        repositoryItemButtonEdit.Text = this.popupRetVal.MA_TB
                      }
                      if (ItemList[i].sFieldName == 'MADOICAP') {
                        ItemList[i].sValue = this.popupRetVal.MADOICAP
                        this.gridEditors[i].Value = this.popupRetVal.MADOICAP
                      }
                    }
                    // grcMacdinh.RefreshDataSource();
                  }
                }, 1000)
                // while(this.popupRetVal==null) {
                //   //KHong lam gi, cho popup hoan thanh!
                // }
                // if (this.popupRetVal)
                // {
                //     for (var i = 0; i < ItemList.length; i++)
                //     {
                //         if (ItemList[i].sFieldName == "MATB_TN")
                //         {
                //             ItemList[i].sValue = this.popupRetVal.ma_tn;
                //             this.gridEditors[i].Value = this.popupRetVal.ma_tn;
                //             repositoryItemButtonEdit.Text = this.popupRetVal.ma_tn;
                //         }
                //         if (ItemList[i].sFieldName == "MADOICAP")
                //         {
                //             ItemList[i].sValue = this.popupRetVal.ma_doicap;
                //             this.gridEditors[i].Value = this.popupRetVal.ma_doicap;
                //         }
                //     }
                //     // grcMacdinh.RefreshDataSource();
                // }
              } else {
                this.$toast.error('Chưa có thông tin thuê bao để lấy danh sách mã truy nhập lắp trên đường có sẵn !')
                return
              }
              break
            case 1:
            case 3:
              if (this.khachhang.hdkh_id && this.khachhang.hdkh_id > 0) {
                dulieu.hdkh_id = this.khachhang.hdkh_id
                dulieu.vkhachhang_id = this.khachhang.khachhang_id
                dulieu.vkieuld_id = this.listbox.kieu_ld.value
                dulieu.loaitb_id = this.listbox.loaihinh_tb.value
                this.popupComponentData = dulieu
                this.popupComponent = () => import('./Popups/popupDSTBLapKem')
                this.popupComponentName = 'popupDSTBLapKemCNTT'
                this.popupRetVal = null
                this.Popup('popupComponents')
                let xlykq = setInterval(() => {
                  if (this.popupRetVal) {
                    clearInterval(xlykq)
                    if (this.popupRetVal.MA_TB)
                      for (var i = 0; i < ItemList.length; i++) {
                        if (ItemList[i].sFieldName == 'MATB_TN') {
                          ItemList[i].sValue = this.popupRetVal.MA_TB
                          this.gridEditors[i].Value = this.popupRetVal.MA_TB
                          repositoryItemButtonEdit.Text = this.popupRetVal.MA_TB
                        }
                        if (ItemList[i].sFieldName == 'MADOICAP') {
                          ItemList[i].sValue = this.popupRetVal.MADOICAP
                          this.gridEditors[i].Value = this.popupRetVal.MADOICAP
                        }
                      }
                    else if (kieu * 1 == 3) {
                      for (var i = 0; i < ItemList.length; i++) {
                        if (ItemList[i].sFieldName == 'MATB_TN') {
                          ItemList[i].sValue = ''
                          this.gridEditors[i].Value = ''
                          repositoryItemButtonEdit.Text = ''
                        }
                        if (ItemList[i].sFieldName == 'MADOICAP') {
                          ItemList[i].sValue = '0'
                          this.gridEditors[i].Value = '0'
                        }
                      }
                      // grcMacdinh.RefreshDataSource();
                    }
                    // grcMacdinh.RefreshDataSource();
                  }
                }, 1000)
              } else {
                this.$toast.error('Chưa có thông tin thuê  bao để lấy danh sách mã truy nhập lắp kèm !')
                return
              }
              break
          }
        }

        if (repositoryItemButtonEdit.Tag == 'THONGTIN_CT' && this.listbox.loaihinh_tb.value == LoaiHinhTB.IT_CARE) {
          this.popupComponentData = { vloaitb_id: this.listbox.loaihinh_tb.value, vhdtb_id: this.hdtb_id, vappend_name: repositoryItemButtonEdit.Tag }
          this.popupComponent = () => import('./Popups/popupHDTB_CNTT_SUB')
          this.popupComponentName = 'popupHDTB_CNTT_SUB'
          this.Popup('popupComponents')
        }
        if (repositoryItemButtonEdit.Tag == 'DONGIA' || repositoryItemButtonEdit.Tag == 'DINHMUC_SMS' || repositoryItemButtonEdit.Tag == 'DOITAC' || repositoryItemButtonEdit.Tag == 'DINHMUC_LL' || repositoryItemButtonEdit.Tag == 'DINHTUYEN') {
          if (this.hdtb_id != 0) {
            // && loaihinh_tb == this.listbox.loaihinh_tb.value) // dieu kien 2 nay luon dung, khong xu ly
            if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_SMCC) {
              if (repositoryItemButtonEdit.Tag == 'DOITAC') {
                this.popupComponentData = { loaitb_id: this.listbox.loaihinh_tb.value, append_name: 'DOITAC', saveList: this.dsHDTB_CT, ItemList: ItemList }
                this.popupComponent = () => import('./Popups/popupChiTietHDTB')
                this.popupComponentName = 'popupChiTietHDTB' // Chung code xu ly voi ham phia tren do do khong can code doan nay.
                this.Popup('popupComponents')
              }
            } else {
              this.popupRetVal = null
              this.popupComponentData = { vloaitb_id: this.listbox.loaihinh_tb.value, vhdtb_id: this.hdtb_id, vappend_name: repositoryItemButtonEdit.Tag }
              this.popupComponent = () => import('./Popups/popupHDTB_CNTT_SUB')
              this.popupComponentName = 'popupHDTB_CNTT_SUB'
              this.Popup('popupComponents')
              let xlykq = setInterval(() => {
                if (this.popupRetVal) {
                  clearInterval(xlykq)
                  if ((this.listbox.loaihinh_tb.value == LoaiHinhTB.TD_1800 || this.listbox.loaihinh_tb.value == LoaiHinhTB.TD_1900) && this.thamsomacdinh['TRIENKHAI_1800_1900'] == 1) {
                    let tien_ld = this.popupRetVal.tien_ld
                    for (var item of this.ds_tien_khoanmuc) {
                      if (item['khoanmuctt_id'] == 142) {
                        //Cước Cài Đặt Đầu Số 1800 - 1900
                        if (tien_ld != '-1') {
                          item['tien'] = tien_ld
                          item['vat'] = tien_ld * 0.1
                          //HienThiTienKhuyenMaiLapDat(dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt);
                          this.HienThiTienKhuyenMaiLapDat()
                          this.LayTongTien_HDTB()
                        }
                      }
                    }
                  }
                }
              }, 1000)
              // while(this.popupRetVal==null) {
              //   //KHong lam gi, cho popup hoan thanh!
              // }
              // if(this.popupRetVal)
              //   if ((this.listbox.loaihinh_tb.value == LoaiHinhTB.TD_1800
              //       || this.listbox.loaihinh_tb.value == LoaiHinhTB.TD_1900) && this.thamsomacdinh['TRIENKHAI_1800_1900'] == 1)
              //   {
              //       let tien_ld = this.popupRetVal.tien_ld;
              //       for (var item of this.ds_tien_khoanmuc)
              //       {
              //           if (item["khoanmuctt_id"] == 142) //Cước Cài Đặt Đầu Số 1800 - 1900
              //           {
              //               if (tien_ld != "-1")
              //               {
              //                   item["tien"] = tien_ld;
              //                   item["vat"] = tien_ld * 0.1;
              //                   //HienThiTienKhuyenMaiLapDat(dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt);
              //                   this.HienThiTienKhuyenMaiLapDat();
              //                   this.LayTongTien_HDTB();
              //               }
              //           }
              //       }
              //   }
            }
          }
        }
        if (repositoryItemButtonEdit.Tag == 'CT_DIEMCAU') {
          if (this.hdtb_id != 0) {
            this.popupComponentData = { vhdtb_id: this.hdtb_id, vhdkh_id: this.khachhang.hdkh_id, ma_gd: this.khachhang.magd, vloaitb_id: this.listbox.loaihinh_tb.value }
            this.popupComponent = () => import('./Popups/popupDanhSach_DiemCau')
            this.popupComponentName = 'popupDanhSach_DiemCau'
            this.Popup('popupComponents')
            //khong thay xu ly sau khi dong popup -> chua lam gi!
          }
        }

        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.TD_1800 || this.listbox.loaihinh_tb.value == LoaiHinhTB.TD_1900 ||  this.listbox.loaihinh_tb.value == 369 ||  this.listbox.loaihinh_tb.value == 2117 || this.listbox.loaihinh_tb.value == 359 /*thoại quốc tế*/) {
          if (repositoryItemButtonEdit.Tag == 'MA_TB') {
            var vsomay = ''
            for (var i = 0; i < ItemList.length; i++) {
              if (ItemList[i].sFieldName == 'MA_TB') {
                vsomay = ItemList[i].sValue
              }
            }

            this.popupComponentData = {
              vloaitb_id: Number(this.listbox.loaihinh_tb.value),
              vdichvuvt_id: Number(this.listbox.dichvu_vt.value),
              vsomay: vsomay
            }
            this.popupComponent = () => import('@/modules/contract/setup/InstallNewSubs/Popups/popupChonSo_CNTT')
            this.popupComponentName = 'popupChonSo_CNTT'
            this.popupComponentHeader = ''
            this.Popup('popupComponents')
          }
        }

        if (this.listbox.loaihinh_tb.value == 376) {
          if(repositoryItemButtonEdit.Tag == 'THONGTIN_CT') {
              this.popupComponentData = { vloaitb_id: this.listbox.loaihinh_tb.value, vhdtb_id: this.hdtb_id, vappend_name: repositoryItemButtonEdit.Tag }
              this.popupComponent = () => import('./Popups/frmNhanCanhBaoHeThong')
              this.popupComponentName = 'frmNhanCanhBaoHeThong'
          }
          if(repositoryItemButtonEdit.Tag == 'THONGTIN_XT') {
              this.popupComponentData = { vloaitb_id: this.listbox.loaihinh_tb.value, vhdtb_id: this.hdtb_id, vappend_name: repositoryItemButtonEdit.Tag }
              this.popupComponent = () => import('./Popups/frmSoThueBaoM2M')
              this.popupComponentName = 'frmSoThueBaoM2M'
          }
          this.Popup('popupComponents')
          let xlykq = setInterval(() => {
            // if (this.popupRetVal) {
            //   clearInterval(xlykq)

            // }
          }, 1000)
        }

      } catch (ex) {
        this.$toast.error('Có lỗi: ' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async Init_Properties(vloaitb_id, table_name, opt_list) {
      return await API.post_lay_danhsach_thuoctinh_datmoi(this.axios, {
        vloaitb_id: vloaitb_id,
        vopt_list: opt_list,
        vten_bang: table_name
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let ds = response.data.data
          this.ItemList = []
          for (let row of ds) {
            var item = {}
            item.sFieldName = row['field_name']
            item.sCaption = row['ten_hienthi']
            item.iAtt = row['att']
            item.iDataType = row['data_type']
            item.sMaxValue = row['max_value']
            item.sMinValue = row['min_value']
            item.sLookupApi = row['lookup_api'] ? row['lookup_api'] : ''
            item.sAPIDisplayMember = row['api_display_member'] ? row['api_display_member'] : ''
            item.sAPIValueMember = row['api_value_member'] ? row['api_value_member'] : ''
            item.sAPIHienThiBang = row['api_hienthi_bang'] ? row['api_hienthi_bang'] : ''
            item.sAPIMethod = row['api_method'] ? row['api_method'] : ''
            item.sReadOnly = row['read_only']
            item.sValue = row['field_value']
            item.nFieldLength = row['field_length'] ? row['field_length'] : 0
            item.bIsNotNull = row['field_nullable'] && row['field_nullable'] == 0 ? true : false
            item.bIsUnique = row['field_unique'] && row['field_unique'] == 0 ? true : false
            item.sLookUpTableName = row['parent_table']
            item.sLookUpKeyField = row['parent_keyfield']
            item.sLookUpValueField = row['parent_descfield']
            item.strDepandField = row['depend_field']
            item.StrSql = row['lookup_sql']
            if (row['lookup_sql_response']) item.SqlData = this.UpperCasePropertyList(row['lookup_sql_response'])
            this.ItemList.push(item)
          }
          return this.ItemList //response.data.data;
        } else return []
      })
    },
    ReplaceSQL(sql) {
      sql = sql.replace('{?DB4}', DatabaseConstants.DB4)
      sql = sql.replace('{?DB3}', DatabaseConstants.DB3)
      sql = sql.replace('{?DB2}', DatabaseConstants.DB2)
      sql = sql.replace('{?DB1}', DatabaseConstants.DB1)
      sql = sql.replace('\n', ' ')
      sql = sql.replace('\r', ' ')
      sql = sql.replace('\t', ' ')

      return sql
    },
    async ReturnSqlStr(ListItem, index) {
      let s = ''
      switch (ListItem[index].sLookUpTableName) {
        case 'PHANLOAI_DV':
          s = 'select ' + ListItem[index].sLookUpKeyField + ',' + ListItem[index].sLookUpValueField + ' from ' + DatabaseConstants.DB2 + '.' + ListItem[index].sLookUpTableName + ' WHERE LOAITB_ID = ' + this.listbox.loaihinh_tb.value + ' ORDER BY ' + ListItem[index].sLookUpKeyField
          break
        case 'TOCDO_ADSL':
          s = 'Select TOCDO_ID, THUONGHIEU FROM ' + DatabaseConstants.DB2 + '.' + ListItem[index].sLookUpTableName
          s += ' WHERE SUDUNG = 1 and LOAITB_ID = ' + this.listbox.loaihinh_tb.value
          if (this.listbox.loaihinh_tb.value == LoaiHinhTB.Web_Hosting || this.listbox.loaihinh_tb.value == LoaiHinhTB.CA || this.listbox.loaihinh_tb.value == LoaiHinhTB.CA_IVAN || this.listbox.loaihinh_tb.value == LoaiHinhTB.IVAN || this.listbox.loaihinh_tb.value == LoaiHinhTB.IOFFICE)
            for (let type of ListItem) if (type.sFieldName == 'DAILY') s += ' and kieu_mega in (2,' + type.sValue + ')'
          let pdata = { loaitb_id: this.listbox.loaihinh_tb.value }
          let checkTD = await API.post_dvcntt_tocdo_adsl(this.axios, pdata).then((response) => {
            //.post_sp_huonggiao_runsql(this.axios, { "command": `select ${DatabaseConstants.DB2}.TOCDO_LOADTHEO_PHANLOAI(${this.listbox.loaihinh_tb.value}) kq from dual` }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data //.data_json;
            } else return []
          })
          if (checkTD && checkTD.length > 0 && checkTD[0].kq && checkTD[0].kq == 'ok')
            for (let type of ListItem)
              if (type.sFieldName == 'PHANLOAI_ID' || (type.sFieldName == 'LOAICTS_ID' && this.listbox.loaihinh_tb.value == LoaiHinhTB.SMART_CA)) {
                pdata.kieu_mega = !type.sValue || type.sValue == '' ? -10 : type.sValue
                s += ' and kieu_mega = ' + (!type.sValue || type.sValue == '' ? -10 : type.sValue)
              }
          s += ' ORDER BY TOCDO_ID'
          let checkData = await API.post_lay_tt_tocdo_adsl(this.axios, pdata).then((response) => {
            //.post_sp_huonggiao_runsql(this.axios, { "command": `select ${DatabaseConstants.DB2}.TOCDO_LOADTHEO_PHANLOAI(${this.listbox.loaihinh_tb.value}) kq from dual` }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data //.data_json;
            } else return []
          })
          if (checkData && checkData.length > 0) {
            ListItem[index].SqlData = this.UpperCasePropertyList(checkData)
            if (!ListItem[index].sValue || ListItem[index].sValue == '' || !ListItem[index].SqlData.find((x) => x[ListItem[index].sLookUpKeyField] == ListItem[index].sValue)) ListItem[index].sValue = ListItem[index].SqlData[0][ListItem[index].sLookUpKeyField]
            if (this.gridEditors[index]) {
              let valuechanged = this.gridEditors[index].Value != ListItem[index].sValue
              this.gridEditors[index].Value = ListItem[index].sValue //ListItem[index].SqlData[0][ListItem[index].sLookUpKeyField]; // Chỗ này có lẽ sau xử lý theo datasource thì hay hơn, nhưng tạm thời chưa lỗi thì cứ để vậy đã
              if (valuechanged && this.gridEditors[index].EditValueChanged) this.gridEditors[index].EditValueChanged(this.gridEditors[index])
            }
          }
          // console.log(ListItem[index].SqlData);
          break
        case 'HE_DIEU_HANH':
          for (let type of ListItem) {
            if (type.sFieldName == 'TOCDO_ID') {
              if (!type.sValue || type.sValue == '') {
                s = 'select ' + ListItem[index].sLookUpKeyField + ',' + ListItem[index].sLookUpValueField + ' from ' + DatabaseConstants.DB2 + '.' + ListItem[index].sLookUpTableName + ' ORDER BY ' + ListItem[index].sLookUpKeyField
              } else {
                s = 'select a.hedieuhanh_id, a.he_dieu_hanh  '
                s += ' from ' + DatabaseConstants.DB2 + '.he_dieu_hanh a, ' + DatabaseConstants.DB2 + '.hdh_tocdo b '
                s += ' where a.hedieuhanh_id = b.hedieuhanh_id '
                s += ' and b.tocdo_id = ' + type.sValue
                s += ' order by a.hedieuhanh_id '
              }
            }
          }
          break
        case 'ABC':
          s = 'Select vungpv_id, tenvung_pv FROM ' + DatabaseConstants.DB5 + ".vungphucvu WHERE trangthai='1' order by tenvung_pv"
          break
        case 'DUNGLUONG':
          s = 'Select DUNGLUONG AS MA_SO,DUNGLUONG AS TEN from ' + DatabaseConstants.DB5 + '.DUNGLUONG order by to_number(ten)'
          break
        case 'TUYEN_CAP':
          s = 'Select tuyencap_id, tuyen_cap from ' + DatabaseConstants.DB5 + '.' + ListItem[index].sLookUpTableName
          break
        case 'TUYEN_CB':
          s = 'Select tuyencb_id, tuyen_cb from ' + DatabaseConstants.DB5 + '.' + ListItem[index].sLookUpTableName
          break
        case 'TUYEN_COT':
          s = 'Select tuyencot_id, tuyen_cot from ' + DatabaseConstants.DB5 + '.' + ListItem[index].sLookUpTableName
          break
        case '{?CSS}.LINHVUC':
          s = 'Select linhvuc_id, linhvuc from ' + DatabaseConstants.DB2 + ".LINHVUC where phanloai_sms is null or phanloai_sms like '%" + this.PhanLoai_ID + "%'" //PhanLoai_ID
          break
        default:
          s = 'select ' + ListItem[index].sLookUpKeyField + ',' + ListItem[index].sLookUpValueField + ' from ' + ListItem[index].sLookUpTableName
          break
      }
      s = s.replace('{?ADMIN}', DatabaseConstants.DB1)
      s = s.replace('{?CSS}', DatabaseConstants.DB2)
      return s
    },
    async LAY_DS_DVGT_MACDINH() {
      var i_tocdo_id = 0
      let linhvuc_id = 0
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.BRANDNAME) {
        //SMS Brandname
        if (this.gridEditors == null) return
        // grvMacdinh.CloseEditor();
        for (var index = 0; index < this.gridEditors.length; ++index) {
          if (this.gridEditors[index].ID == 'LINHVUC_ID')
            if (this.gridEditors[index].Value && this.gridEditors[index].Value != '') {
              linhvuc_id = this.gridEditors[index].Value * 1
              break
            }
        }
        // m_dsThueBao_DichVu = tchopdong.LAY_DS_THUEBAO_DICHVU_LINHVUC_V2(hdtb_id, 0, this.listbox.loaihinh_tb.value, linhvuc_id, 1);
      } else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VN_EDU || this.listbox.loaihinh_tb.value == LoaiHinhTB.VCC) {
        if (this.gridEditors == null) return
        // grvMacdinh.CloseEditor();
        for (var index = 0; index < this.gridEditors.length; ++index) {
          if (this.gridEditors[index].ID == 'TOCDO_ID')
            if (this.gridEditors[index].Value && this.gridEditors[index].Value != '') {
              i_tocdo_id = this.gridEditors[index].Value * 1
              this.tocdo_id = i_tocdo_id
              break
            }
        }
        // m_dsThueBao_DichVu = tchopdong.LAY_DS_THUEBAO_DICHVU_TOCDO(hdtb_id, 0, this.listbox.loaihinh_tb.value, i_tocdo_id, 1);
      } else {
        //m_dsThueBao_DichVu = tchopdong.LAY_DS_THUEBAO_DICHVU(hdtb_id, 0, loaitb_id, 1);
        // m_dsThueBao_DichVu = tchopdong.LAY_DS_THUEBAO_DICHVU(0, 0, loaitb_id, 1);
      }
      this.m_dsThueBao_DichVu = await API.post_fn_lay_ds_dvgt_macdinh(this.axios, { ds_para: JSON.stringify({ LOAITB_ID: this.listbox.loaihinh_tb.value, HDTB_ID: this.hdtb_id, LINHVUC_ID: linhvuc_id, I_TOCDO_ID: i_tocdo_id }) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] == 1) return apidata['RESULT']['DS_TB_DICHVU']
          else {
            this.$toast.error(apidata['MESSAGE'])
            return []
          }
        } else return []
      })
      this.HT_DichVuGT()
    },
    async LAY_DS_DVK_MACDINH_TB() {
      API.post_lay_ds_dvk_macdinh(this.axios, { vloaiid: 1, vloaitb_id: this.listbox.loaihinh_tb.value }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          this.dsDK_DVK_TB = []
          let ds = response.data.data
          for (var i = 0; i < ds.length; i++) {
            let row = {}
            row.DVKHAC_ID = ds[i]['dvkhac_id'] * 1
            row.KIEU_YC = ds[i]['caidat_md'] * 1
            row.TTTH = TrangThaiCaiDat.MOI
            row.HD_ID = this.hdtb_id
            row.NGAY_YC = this.NgayYeuCau
            row.LOAIID = ds[i]['loaiid'] * 1
            this.dsDK_DVK_TB.push(row)
          }
          this.HT_DichVuKhac(this.dsDK_DVK_TB, 1)
        }
      })
    },
    async Delete_HD_ChuyenTinh_VinaPhone(so_tb) {
      if (!TRANGTHAI_DONGBO.OPEN_SYNC_VINA) return 'OK'
      let status = false
      try {
        if (!this.tt_nd.user_neo) {
          return 'Thông tin người dùng chưa đồng bộ với dữ liệu VinaPhone. Bạn không thể tiếp tục cập nhật dữ liệu.'
        }

        let thuebao_id_neo = ''
        let dt = []
        await API.post_ts_laphd_chuyentinh_laytt_tb(this.axios, {
          tracuu_hd: '1',
          ma_tinh: this.tt_nd.tentat_ccbs,
          so_tb: so_tb
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            dt = response.data.data
          }
        }) //new CCBSFacade().ts_laphd_chuyentinh_laytt_tb("1", tt_nd.tentat_ccbs, so_tb);
        if (dt != null && dt.length > 0 && Object.keys(dt[0]).indexOf('TRANG_THAI') >= 0 && Object.keys(dt[0]).indexOf('THUEBAO_ID') >= 0) {
          thuebao_id_neo = dt[0]['THUEBAO_ID']
        } else {
          return 'Có lỗi trong khi lấy thông tin thuê bao từ vinaphone ts_laphd_chuyentinh_laytt_tb '
        }

        let rs = []
        await API.post_ts_laphd_chuyentinh_del_thuebao_cts(this.axios, {
          ma_tinh: this.tt_nd.tentat_ccbs,
          thuebao_id: thuebao_id_neo,
          userip: await this.$root.token.getIP(),
          userid: this.tt_nd.user_neo
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            rs = response.data.data
            if(rs.IssSuccessed == 'undefined' || rs.IssSuccessed==null) rs.IssSuccessed = true;
            //rs.IssSuccessed = true
          }
          rs.Message = response.data.message;
        }) //new CCBSFacade().ts_laphd_chuyentinh_del_thuebao_cts(tt_nd.tentat_ccbs, thuebao_id_neo, tt_nd.ip, tt_nd.USER_NEO);
        if (!rs.IssSuccessed) return 'Lỗi xảy ra khi xóa thuê bao lên Vinaphone.' + rs.Message
      } catch (ex) {
        // status = false;
        // strError_VinaPhone = ex.Message;
        return 'Lỗi xảy ra khi cập nhật thuê bao lên Vinaphone.' + ex
      }
      this.$toast.success('Thành công', `Xóa hợp đồng chuyển tỉnh của thuê bao ${so_tb} trên VinaPhone thành công!`)
      return 'OK'
    },
    async btnHoSo_Click() {
      this.popup.popupInBienBan = true
      this.popupInBienBan_Param.hdkh_id = this.khachhang.hdkh_id
      this.popupInBienBan_Param.ma_gd = this.khachhang.magd
      this.popupInBienBan_Param.ngay_yc = this.NgayYeuCau
      this.popupInBienBan_Param.ngay_lhd = this.NgayLapHD
      this.$refs.popupInBienBan.showModal()
    },
    async LoadTuHopDongB2A() {
      // if(this.$route.query.phieucskh_id && this.$route.query.phieucskh_id.trim()!='') this.VPHIEUCSKH_ID = this.$route.query.phieucskh_id;
      // if(this.$route.query.phieucskhdv_id && this.$route.query.phieucskhdv_id.trim()!='') this.phieucskhdv_id = this.$route.query.phieucskhdv_id;
      let VPHIEUCSKH_ID = this.VPHIEUCSKH_ID
      let VPHIEUCSKHDV_ID = this.phieucskhdv_id
      try {
        this.buttonSet = 1
        // Lấy thông tin từ B2A
        let d = await API.post_fn_lay_tt_tu_hd_b2a(this.axios, {
          ds_para: JSON.stringify({ PHIEUCSKH_ID: VPHIEUCSKH_ID })
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let apidata = response.data.data
            if (apidata['ERROR_CODE'] != 1) {
              this.$toast.error(apidata['MESSAGE'])
              return {}
            } else return apidata['RESULT']
          }
        }) //bangts.GetDataSql("select * from " + DatabaseConstants.DB2 + ".phieu_cskh where phieucskh_id =" + phieucskh_id);
        if (d.KHACHHANG_ID && d.KHACHHANG_ID != 0 && d.KHACHHANG_ID != '' && d.KHACHHANG_ID != -1) {
          this.khachhang.khachhang_id = d.KHACHHANG_ID
          this.khachhang.makh = d.MA_KH
          this.MaKHChanged()
        } else {
          if (d.TEN_KH) {
            this.khachhang.tenkh = d.TEN_KH
            this.tenKHChanged()
          }
          if (d.DIENTHOAI) this.khachhang.dienthoai = d.DIENTHOAI
          let diachi = {} // this.getDiaChiKH({'diachimoi':d.DIACHI_KH});
          if (d.DIACHI_KH) diachi.diachimoi = d.DIACHI_KH
          else diachi.diachimoi = ''
          if (d.TINH_ID) diachi.tinh_id = d.TINH_ID
          else diachi.tinh_id = 0
          if (d.QUAN_ID) diachi.quan_id = d.QUAN_ID
          else diachi.quan_id = 0
          if (d.PHUONG_ID) diachi.phuong_id = d.PHUONG_ID
          else diachi.phuong_id = 0
          if (d.PHO_ID) diachi.pho_id = d.PHO_ID
          else diachi.pho_id = 0
          if (d.KHU_ID) diachi.khu_id = d.KHU_ID
          else diachi.khu_id = 0
          if (d.AP_ID) diachi.ap_id = d.AP_ID
          else diachi.ap_id = 0
          if (d.SONHA) diachi.so_nha = d.SONHA
          else diachi.so_nha = ''
          if (d.BLOCK) diachi.block = d.BLOCK
          if (d.TANG) diachi.tang = d.TANG
          if (d.PHONG) diachi.sophong = d.PHONG
          if (d.MOTA) diachi.motathem = d.MOTA
          if (d.VIDO) diachi.lat = d.VIDO
          else diachi.lat = 0
          if (d.KINHDO) diachi.lng = d.KINHDO
          else diachi.lng = 0
          if (diachi.tinh_id > 0 && diachi.quan_id > 0) this.getDiaChiKH(diachi)
          // Load thông tin theo số giấy tờ
          if (d.LOAIGT_ID) this.listbox.loai_gt.value = d.LOAIGT_ID
          if (d.SO_GT) this.khachhang.sogt = d.SO_GT
          if (d.NGAYCAP) this.NgayCap = moment(d.NGAYCAP).format('DD/MM/YYYY')
          if (d.NOICAP) this.khachhang.noicap = d.NOICAP
        }
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async tsbtnSuaKM_Click() {
      if (this.hdtb_id == 0) {
        this.$toast.error('Bạn phải lấy thông tin hợp đồng trước khi sửa khuyến mại!')
        return
      }

      if (this.hc_hdtb_id != 0 && this.hc_hdtb_id != this.hdtb_id) {
        this.$toast.error('Không đúng thuê bao cần hiệu chỉnh. Bạn hãy kiểm tra lại!')
        return
      }

      if (!(await this.KIEMTRA_SUAKM())) return

      // //tien tra gop luu 1 lan thoi
      let blKiemTraTraGop = false
      // //longdx: bo sung thong tin hdtb_id vao bang khuyenmai, dat coc
      //FIXME doan nay co ve sai vi prop phan lon la lowercase!!!
      for (let row of this.dsDC_HDTB) {
        row.HDTB_ID = this.hdtb_id
        row.TIEN_TG = this.TongTien_TG(row.CHITIETKM_ID)
        if (row.TIEN_TG > 0) blKiemTraTraGop = true
      }
      for (let row of this.dsKM_HDTB) {
        row.HDTB_ID = this.hdtb_id
        if (!blKiemTraTraGop) row.TIEN_TG = this.TongTien_TG(row.CHITIETKM_ID)
      }
      try {
        //nếu tiền thay đổi thì phải update tiền
        let update_tien = false
        let vphieutt_id = -1
        if (!this.kiemtra_khoanmuc_tien()) {
          this.loading(false)
          let cfr = await this.$bvModal
            .msgBoxConfirm('Tiền hợp đồng đã thay đổi, bạn có muốn tiếp tục cập nhật?', {
              title: 'Xác nhận hành động',
              size: 'sm',
              okTitle: 'Đồng ý',
              cancelTitle: 'Hủy'
            })
            .then(async (v) => {
              return v
            })

          if (!cfr) {
            return
          }
          let ds = await API.post_lay_ds_phieu_chuatt(this.axios, {
            vhdtb_id: this.hdtb_id
          }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            }
          }) //new TCHopDongFacade().lay_ds_phieu_chuatt(hdtb_id);
          if (ds && ds.length > 0) {
            if (ds.length == 0) {
              this.$toast.error('Hợp đồng đã thoái trả, không thể sửa tiền!')
              return
            }
            if (ds[0]['trangthai'] == 1) {
              this.loading(false)
              cfr = await this.$bvModal
                .msgBoxConfirm('Phiếu thanh toán đã thu tiền sẽ chuyển thành trạng thái chưa thu tiền và hủy hóa đơn cũ, bạn có muốn sửa?', {
                  title: 'Xác nhận hành động',
                  size: 'sm',
                  okTitle: 'Đồng ý',
                  cancelTitle: 'Hủy'
                })
                .then(async (v) => {
                  return v
                })
              if (!cfr) return
            }
            vphieutt_id = ds[0]['phieutt_id'] ? ds[0]['phieutt_id'] : -1
          } else {
            this.$toast.error('Không thể lấy thông tin phiếu thanh toán, xin thử lại sau!')
            return
          }
          update_tien = true
          await this.TaoDuLieu_CT_TIENHD(true)
        }
        if (this.thamsomacdinh['KIEMTRA_KHOP_TIEN_DATCOC'] == 1) {
          let tien_tratruoc = 0
          let tien_datcoc = 0
          for (var i = 0; i < this.ds_tien_khoanmuc.length; i++) {
            if (this.ds_tien_khoanmuc[i]['khoanmuctt_id'] == KHOANMUC_TT.KMTT_DATCOC) {
              tien_tratruoc = this.ds_tien_khoanmuc[i]['tien'] * 1 + this.ds_tien_khoanmuc[i]['vat'] * 1
            }
          }

          for (let dc1 = 0; dc1 < this.dsKM_HDTB.length; dc1++) {
            tien_datcoc += this.dsKM_HDTB[dc1]['datcoc_csd'] * 1
          }

          for (let dc2 = 0; dc2 < this.dsDC_HDTB.length; dc2++) {
            tien_datcoc += this.dsDC_HDTB[dc2]['datcoc_csd'] * 1
          }

          if (tien_tratruoc != tien_datcoc) {
            this.$toast.error('Tiền đặt cọc và tiền khoản mục không khớp. Liên hệ admin để kiểm tra lại! ')
            return
          }
        }
        let ds_tb_hddt_1 = null
        let ds_tb_hddt_2 = null
        let sErr = ''
        await API.post_fn_sua_tt_khuyenmai(this.axios, {
          ds_para: JSON.stringify({
            HC_HDTB_ID: this.hc_hdtb_id,
            HC_TDTT_HDTB_ID: this.hc_tdtt_hdtb_id,
            NGUOIDUNG_ID: this.$root.token.getNguoiDungID(),
            MAY_CN: await this.$root.token.getMachine(),
            NGUOI_CN: this.$root.token.getUserName(),
            HDKH_ID: this.khachhang.hdkh_id,
            HDTB_ID: this.hdtb_id,
            JS_KHUYENMAI_HDTB: this.dsKM_HDTB && this.dsKM_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsKM_HDTB) : this.dsKM_HDTB,
            JS_DATCOC_HDTB: this.dsDC_HDTB && this.dsDC_HDTB.length > 0 ? this.UpperCasePropertyList(this.dsDC_HDTB) : this.dsDC_HDTB,
            JS_CT_TIENHD: this.dsCTTHD,
            PHIEUTT_ID: vphieutt_id,
            SUA_TIEN: update_tien ? 1 : 0,
            MA_ND: this.$root.token.getMaNhanVien()
          })
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] != 1) {
              sErr = apidata['MESSAGE'] //this.$toast.error(apidata['MESSAGE']);
            }
            apidata = apidata['RESULT']

            if (apidata && apidata['DS_HDDT_OLD']) ds_tb_hddt_1 = apidata['DS_HDDT_OLD']
            if (apidata && apidata['DS_HDDT_NEW']) ds_tb_hddt_2 = apidata['DS_HDDT_NEW']
          }
        })
        let shddt = await this.phathanh_hddt_dieuchinh_td(ds_tb_hddt_1 ? ds_tb_hddt_1 : [], ds_tb_hddt_2 ? ds_tb_hddt_2 : [])
        if (shddt != 'OK') {
          throw (shddt)
        } else if (!sErr) {
          this.$toast.success('Cập nhật thành công')

          if (this.hc_hdtb_id != 0 && this.hc_tdtt_hdtb_id != 0) {
            API.post_sp_capnhat_tdtt_hd_thuebao(this.axios, {
              hdtb_id: this.hc_hdtb_id,
              kq_th: 1,
              ma_nd: this.$root.token.getMaNhanVien(),
              may_cn: await this.$root.token.getMachine(),
              nd_thuchien: 'Thực hiện xong',
              tthc_id: 6
            }).then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.$emit('form-close', null)
              } else this.$toast.error(response.data.message + response.data.message_detail)
            })
            return
          }

          this.MaGDChanged() //txtMaGD_KeyPress(txtMaGD, new KeyPressEventArgs(Convert.ToChar(Keys.Enter)));
        } else {
          throw ('Lỗi: ' + sErr)
        }
        if (this.hc_hdtb_id != 0 && this.hc_tdtt_hdtb_id != 0) {
          API.post_sp_capnhat_tdtt_hd_thuebao(this.axios, {
            hdtb_id: this.hc_hdtb_id,
            kq_th: 1,
            ma_nd: this.$root.token.getMaNhanVien(),
            may_cn: await this.$root.token.getMachine(),
            nd_thuchien: 'Thực hiện xong',
            tthc_id: 6
          }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              this.$emit('form-close', null)
            } else this.$toast.error(response.data.message + response.data.message_detail)
          })
        }
      } catch (ex) {
        this.$toast.error('Cập nhật thất bại!' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async KIEMTRA_SUAKM() {
      try {
        // tdan = {};
        let tt_stb = -1
        let km_stb = -1
        let list_ctkm_id = '-1'
        try {
          if (this.filterbox.tratruoc.ischecked)
            //chkTraTruoc.Checked)
            tt_stb = this.filterbox.tratruoc.value ? this.filterbox.tratruoc.value : -1
        } catch (ex) {
          tt_stb = -1
        }

        try {
          if (this.filterbox.khuyenmai.ischecked)
            //chkKhuyenMai.Checked)
            km_stb = this.filterbox.khuyenmai.value ? this.filterbox.khuyenmai.value : -1
        } catch (ex) {
          km_stb = -1
        }
        if ((this.dsDC_HDTB && this.dsDC_HDTB.length > 0) || (this.dsKM_HDTB && this.dsKM_HDTB.length > 0))
          //(dsDC_HDTB.KHUYENMAI_HDTB.Rows.Count > 0 || dsKM_HDTB.KHUYENMAI_HDTB.Rows.Count > 0)
          list_ctkm_id = []

        // let xdoc = new XmlDocument();
        // let ds = xdoc.CreateElement("ds");
        // xdoc.AppendChild(ds);

        for (let row of this.dsDC_HDTB) {
          list_ctkm_id.push({ CHITIETKM_ID: row.chitietkm_id })
          // let vt = xdoc.CreateElement("vt");
          // ds.AppendChild(vt);

          // let a = xdoc.CreateAttribute("ctkm_id");
          // a.Value = row.CHITIETKM_ID.ToString();
          // vt.Attributes.Append(a);
        }
        for (let row of this.dsKM_HDTB) {
          list_ctkm_id.push({ CHITIETKM_ID: row.chitietkm_id })
          // let vt = xdoc.CreateElement("vt");
          // ds.AppendChild(vt);

          // let a = xdoc.CreateAttribute("ctkm_id");
          // a.Value = row.CHITIETKM_ID.ToString();
          // vt.Attributes.Append(a);
        }
        let temp = ''
        if (list_ctkm_id != -1 && list_ctkm_id.length > 0) temp = JSON.stringify(list_ctkm_id)
        let kq = await API.post_kiemtra_thaydoi_km(this.axios, {
          list_ctkm: temp,
          vhdtb_id: this.hdtb_id,
          vkhuyenmai_id_new: km_stb,
          vma_nd: this.tt_nd.ma_nd,
          vtt_km_id_new: tt_stb
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          }
        }) //tdan.GET_VALUE_FUNC("{?DB2}.kiemtra_thaydoi_km", "vhdtb_id", hdtb_id, "vkhuyenmai_id_new", km_stb, "vtt_km_id_new", tt_stb, "list_ctkm", temp, "vma_nd", tt_nd.ma_nd);
        if (!kq) {
          this.$toast.error('Không lấy được thông tin trả ra')
          return false
        }
        if (kq != 1) {
          this.$toast.error(kq)
          return false
        }
        return true
      } catch (ex) {
        this.$toast.error('Có lỗi hàm kiểm sửa khuyến mại ' + ex)
        return false
      }
    },
    kiemtra_khoanmuc_tien() {
      let drs_cu = this.ds_tien_khoanmuc_bd.filter((x) => x.tien != 0 && x.vat != 0) //.Tables[0].Select("tien<>0 and vat<>0");
      let drs_moi = this.ds_tien_khoanmuc.filter((x) => x.tien != 0 && x.vat != 0) //.Tables[0].Select("tien<>0 and vat<>0");
      //kiểm tra số bản ghi có tiền có = nhau không
      if (drs_cu.length != drs_moi.length) {
        return false
      }
      let vtien_bd, vvat_bd, vtien_moi, vvat_moi
      //Kiểm tra các khoản mục của 2 bên có khớp nhau không
      let kt = false
      //Duyệt toàn bộ bảng mới
      //Kiểm tra các khoản mục của bảng mới có tồn tại bên bảng cũ không?
      for (let drmoi of drs_moi) {
        kt = false
        for (let drcu of drs_cu) {
          vtien_bd = 0
          vvat_bd = 0
          vtien_moi = 0
          vvat_moi = 0
          if (drmoi['khoanmuctt_id'] == drcu['khoanmuctt_id']) {
            vtien_moi = drmoi['tien'] ? drmoi['tien'] * 1 : 0
            vvat_moi = drmoi['vat'] ? drmoi['vat'] * 1 : 0
            vtien_bd = drcu['tien'] ? drcu['tien'] * 1 : 0
            vvat_bd = drcu['vat'] ? drcu['vat'] * 1 : 0

            if (vtien_bd == vtien_moi && vvat_bd == vvat_moi) {
              kt = true
              break
            }
          }
        }
        //không tìm thấy khoản mục tương ứng trong bảng cũ trùng với khoản mục đang xét trong bảng mới
        if (kt == false) return false
      }
      //Kiểm tra ngược lại
      //Kiểm tra các khoản mục của bảng cũ có tồn tại bên bảng mới không?
      for (let drcu of drs_cu) {
        kt = false
        for (let drmoi of drs_moi) {
          vtien_bd = 0
          vvat_bd = 0
          vtien_moi = 0
          vvat_moi = 0
          if (drmoi['khoanmuctt_id'] == drcu['khoanmuctt_id']) {
            vtien_moi = drmoi['tien'] ? drmoi['tien'] * 1 : 0
            vvat_moi = drmoi['vat'] ? drmoi['vat'] * 1 : 0
            vtien_bd = drcu['tien'] ? drcu['tien'] * 1 : 0
            vvat_bd = drcu['vat'] ? drcu['vat'] * 1 : 0

            if (vtien_bd == vtien_moi && vvat_bd == vvat_moi) {
              kt = true
              break
            }
          }
        }
        //không tìm thấy khoản mục tương ứng trong bảng mới trùng với khoản mục đang xét trong bảng cũ
        if (kt == false) return false
      }
      return kt
    },
    async phathanh_hddt_dieuchinh_td(dt_khoanmuc_cu, dt_khoanmuc_moi) {
      let sKq = ''
      let sql = ''
      let dtProduct = JSON.parse(JSON.stringify(dt_khoanmuc_cu))
      //so sánh khoản mục cũ và mới
      //PRODNAME, TONGTIEN,PRODPRICE,TIEN,VAT,AMOUNT
      var i1, i2 //row bảng cũ, bảng mới trùng nhau
      let bl1 = false //kiểm tra có row trùng nhau không
      let tongtien_cu = 0,
        tongtien_moi = 0
      let dtCu = JSON.parse(JSON.stringify(dt_khoanmuc_cu))
      let dtMoi = JSON.parse(JSON.stringify(dt_khoanmuc_moi))
      for (var i = 0; i < dt_khoanmuc_cu.length; i++) {
        bl1 = false
        let tongtien, prodprice, tien, vat, amount
        tongtien_cu += dt_khoanmuc_cu[i]['TONGTIEN'] * 1
        for (var j = 0; j < dt_khoanmuc_moi.length; j++) {
          if (dt_khoanmuc_cu[i]['PRODNAME'] == dt_khoanmuc_moi[j]['PRODNAME']) {
            //Cũ mới đều có, so sánh tiền
            tongtien = dt_khoanmuc_moi[j]['TONGTIEN'] * 1 - dt_khoanmuc_cu[i]['TONGTIEN'] * 1
            prodprice = dt_khoanmuc_moi[j]['PRODPRICE'] * 1 - dt_khoanmuc_cu[i]['PRODPRICE'] * 1
            tien = dt_khoanmuc_moi[j]['TIEN'] * 1 - dt_khoanmuc_cu[i]['TIEN'] * 1
            vat = dt_khoanmuc_moi[j]['VAT'] * 1 - dt_khoanmuc_cu[i]['VAT'] * 1
            amount = dt_khoanmuc_moi[j]['AMOUNT'] * 1 - dt_khoanmuc_cu[i]['AMOUNT'] * 1
            if (tongtien != 0) {
              let dr = dtCu[i]
              if (tongtien < 0) {
                dr['PRODNAME'] = 'Giảm doanh thu ' + dr['PRODNAME']
              } else {
                dr['PRODNAME'] = 'Tăng doanh thu ' + dr['PRODNAME']
              }
              //sửa lại tiền
              dr['TONGTIEN'] = tongtien
              dr['PRODPRICE'] = prodprice
              dr['TIEN'] = tien
              dr['VAT'] = vat
              dr['AMOUNT'] = amount
              dtProduct.push(dr)
            }
            bl1 = true
            break
          }
        }
        if (!bl1) {
          //Cũ có mới không có, điều chỉnh tăng hoặc giảm tùy theo tiền âm hay dương
          let dr = dtCu[i]

          tongtien = dtCu[i]['TONGTIEN'] * 1
          prodprice = dtCu[i]['PRODPRICE'] * 1
          tien = dtCu[i]['TIEN'] * 1
          vat = dtCu[i]['VAT'] * 1
          amount = dtCu[i]['AMOUNT'] * 1
          if (tongtien < 0)
            //Nếu cũ âm, mới ko có, ĐC tăng
            dr['PRODNAME'] = 'Tăng doanh thu ' + dr['PRODNAME']
          else dr['PRODNAME'] = 'Giảm doanh thu ' + dr['PRODNAME']
          dr['TONGTIEN'] = -tongtien
          dr['PRODPRICE'] = -prodprice
          dr['TIEN'] = -tien
          dr['VAT'] = -vat
          dr['AMOUNT'] = -amount
          dtProduct.push(dr)
        }
      }
      for (var i = 0; i < dt_khoanmuc_moi.length; i++) {
        bl1 = false
        let tongtien, prodprice, tien, vat, amount
        tongtien_moi += dt_khoanmuc_moi[i]['TONGTIEN'] * 1
        for (var j = 0; j < dt_khoanmuc_cu.length; j++) {
          if (dt_khoanmuc_cu[j]['PRODNAME'] == dt_khoanmuc_moi[i]['PRODNAME']) {
            bl1 = true
            break
          }
        }
        if (!bl1) {
          //Mới có cũ không có, điều chỉnh tăng giảm tùy thuộc dấu của khoản mục
          let dr = dtMoi[i]
          tongtien = dtMoi[i]['tongtien'] * 1
          if (tongtien < 0)
            //Cũ ko có, mới âm -> DC giảm
            dr['PRODNAME'] = 'Giảm doanh thu ' + dr['PRODNAME']
          dtProduct.push(dr)
        }
      }
      if (dtProduct.length > 0) {
        let ds = []
        let msg = ''
        await API.post_fn_lay_tt_capnhat_hddt_dc(this.axios, { ds_para: JSON.stringify({ HDKH_ID: this.khachhang.hdkh_id, TONGTIEN_CU: tongtien_cu, TONGTIEN_MOI: tongtien_moi }) }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let apidata = JSON.parse(response.data.data)
            if (apidata['ERROR_CODE'] != 1) {
              this.$toast.error(apidata['MESSAGE'])
            }
            apidata = apidata['RESULT']

            if (apidata['SKQ']) sKq = apidata['SKQ']
            if (apidata['DS_HDDT']) ds = apidata['DS_HDDT']
          }
        }) //new HDTB_DATCOC_Facade().lay_tt_hddt_dc(hdkh_id);
        let dtThongTin = ds
        if (sKq == 'OK') return sKq

        let vthaotac = 2
        let vkieu = 2
        if (tongtien_cu == tongtien_moi) {
          return 'OK'
        } else if (tongtien_cu < tongtien_moi) {
          vkieu = 1
        }
        let vifkey = dtThongTin[0]['hddt_fkey']
        if (!vifkey) {
          sKq = 'OK'
          return sKq
        }

        let vdc_tt = 1 //1: Điều chỉnh, 2 thay thế

        if (!sKq && msg == 'View Frm chọn điều chỉnh or thay thế') {
          //         #region view form chọn Điều chỉnh or Thay thế
          vdc_tt = 2
          this.loading(false)
          await this.$bvModal
            .msgBoxConfirm(`Bạn muốn thay thế hay điều chỉnh hóa đơn?`, {
              title: 'Xác nhận hành động',
              size: 'sm',
              okTitle: 'Điều chỉnh',
              cancelTitle: 'Thay thế'
            })
            .then((v) => {
              if (v) vdc_tt = 1
              else vdc_tt = 2
            })
          //         using (Form frm = new Form())
          //         {
          //             frm.Width = 350;
          //             frm.Height = 150;
          //             frm.StartPosition = FormStartPosition.CenterScreen;
          //             frm.ShowIcon = false;
          //             frm.MinimizeBox = false;
          //             frm.MaximizeBox = false;
          //             frm.ShowInTaskbar = false;
          //             let lbl = new Label()
          //             {
          //                 Text = "Bạn muốn thay thế hay điều chỉnh hóa đơn?",
          //                 Font = new Font(Font.Name, 12),
          //                 Dock = DockStyle.Top,
          //                 AutoSize = true
          //             };
          //             let chkDieuChinh = new RadioButton()
          //             {
          //                 Text = "Điều chỉnh",
          //                 Dock = DockStyle.Top,
          //                 Font = new Font(Font.Name, 12),
          //                 Checked = false,
          //                 Padding = new Padding(20, 0, 0, 0)
          //             };
          //             let chkThayThe = new RadioButton()
          //             {
          //                 Text = "Thay thế",
          //                 Dock = DockStyle.Top,
          //                 Checked = true,
          //                 Font = new Font(Font.Name, 12),
          //                 Padding = new Padding(20, 0, 0, 0)
          //             };
          //             let btnOk = new Button()
          //             {
          //                 Text = "Chọn",
          //                 Size = new Size(80, 30),
          //                 Location = new Point(135, 80)
          //             };
          //             btnOk.Click += BtnOkOnClick;
          //             frm.Controls.Add(lbl);
          //             frm.Controls.Add(chkDieuChinh);
          //             frm.Controls.Add(chkThayThe);
          //             frm.Controls.Add(btnOk);
          //             frm.FormBorderStyle = FormBorderStyle.FixedDialog;
          //             frm.FormClosing += new FormClosingEventHandler(frm_FormClosing);
          //             chkDieuChinh.BringToFront();
          //             chkThayThe.BringToFront();
          //             chkThayThe.Checked = true;
          //             frm.Padding = new Padding(10, 0, 10, 0);
          //             frm.Shown += FrmOnShown;
          //             if (frm.ShowDialog() != DialogResult.OK)
          //             {
          //                 vdc_tt = 2;
          //             }
          //             try
          //             {
          //                 if (chkDieuChinh.Checked)
          //                 {
          //                     vdc_tt = 1;
          //                 }
          //                 else
          //                 {
          //                     vdc_tt = 2;
          //                 }
          //             }
          //             catch (Exception ex)
          //             {
          //                 new LogError().GetError(new log4net.Core.LoggingEvent(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType, log.Logger.Repository, log.Logger.Name, log4net.Core.Level.Info, ex.Message, ex), true);
          //                 this.Cursor = Cursors.Default;
          //             }
          //         }
          //         #endregion
        }
        let vphieutt_id = dtThongTin[0]['phieutt_id'] * 1
        let vhdkh_id = dtThongTin[0]['hdkh_id'] * 1
        let vma_gd = dtThongTin[0]['ma_gd']
        let vten_kh = dtThongTin[0]['ten_kh']
        let vdiachi_kh = dtThongTin[0]['diachi_kh']
        let vmst = dtThongTin[0]['mst']
        let vten_nh = dtThongTin[0]['ten_nh']
        let vstk = dtThongTin[0]['stk']
        let vemail = dtThongTin[0]['email']
        let vfax = dtThongTin[0]['so_fax']
        let vsodt = dtThongTin[0]['so_dt']
        let vndd = dtThongTin[0]['nguoi_dd']
        let vloai_kh = dtThongTin[0]['loai_kh']
        let vhttt = dtThongTin[0]['httt']
        //Xuất hóa đơn điều chỉnh giảm hoặc thay thế
        if (vdc_tt == 1) {
          //Điều chỉnh
          vthaotac = 2
        } //thay thế
        else {
          vthaotac = 3
          dtProduct = dt_khoanmuc_moi
        }
        //TODO chua lam, cho API
        // cl_hoadon_dientu hddt = new cl_hoadon_dientu();
        // sKq = hddt.dongbo_hddt_tudong(vthaotac, vkieu, vifkey, vphieutt_id, hdkh_id, vma_gd, vten_kh, vdiachi_kh, vmst, vten_nh, vstk, vemail, vfax, vsodt, vndd, vloai_kh, vhttt, dtProduct);
        sKq = 'OK' // Gan tam trong luc cho API.
        if (sKq != 'OK') {
          if (vdc_tt == 1) sKq = 'Phát hành hóa đơn điều chỉnh thất bại!' + sKq
          else sKq = 'Phát hành hóa đơn thay thế thất bại!' + sKq
        }
      } else {
        sKq = 'OK'
        return sKq
      }
      sKq = 'OK'
      return sKq
    },
    btnChonSoDD_Click() {
      this.popupComponent = () => import('./Popups/popupChonSoKH')
      this.popupComponentName = 'frmChonSMPhuongDiDong'
      this.popupComponentData = {
        vkieuform: this.listbox.loaihinh_tb.value == LoaiHinhTB.DIDONGTRATRUOC ? 0 : 1
      }
      this.Popup('popupComponents')
      // let frm = new frmChonSoKH();
      // frm.vkieuform = cboLoaihinhTB.SelectedValue.ToString() == LoaiHinhTB.DIDONGTRATRUOC + "" ? 0 : 1;
      // frm.ShowDialog();
      // if (frm.xacnhan)
      // {
      //     txtSoMayDD.Text = frm.so_tb_chon;
      //     txtSimDD.Text = frm.so_sim_chon;
      //     txtSoMayNTK.Text = txtSoMayDD.Text;
      //     cboGoiCuocDD.SelectedValue = frm.goicuoc_id_chon;
      //     CHON_KIEULD_THEO_TB("84" + txtSoMayDD.Text);
      //     CHON_LOAITB_TS_THEO_TB("84" + txtSoMayDD.Text); // vuth update 0912
      //     if (frm.vkieuform == 0) cboGoiCuocDD.Enabled = false; // vuth update fix 1109
      // }
    },
    async CHON_KIEULD_THEO_TB(so_tb) {
      // //Nếu đang chọn loại tb là di động trả sau thì kiểm tra và lấy ra kiểu lắp đặt tương ứng với số máy nhập vào.
      if (this.listbox.loaihinh_tb.value != LoaiHinhTB.DIDONGTRASAU) {
        return
      }
      // let service = new CCBSFacade();
      // //Lấy số sim
      try {
        this.thuebao.didong.txtSimDD = await API.post_ts_laphd_hoamangmoi_laytt_sosim(this.axios, { so_tb: so_tb })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data.result ? response.data.data.result : response.data.data
            } else return ''
          })
          .catch((e) => {
            return ''
          }) //service.TS_LAPHD_HOAMANGMOI_LAYTT_SOSIM(tt_nd.tentat, so_tb);
        if (!this.thuebao.didong.cboGoiCuocDD.value && this.thuebao.didong.cboGoiCuocDD.list && this.thuebao.didong.cboGoiCuocDD.list.length > 0) this.thuebao.didong.cboGoiCuocDD.value = this.thuebao.didong.cboGoiCuocDD.list[0].goicuoc_id
      } catch (ex) {
        this.thuebao.didong.txtSimDD = ''
      }

      try {
        var IsChuyenTinh = this.listbox.kieu_ld.value && this.listbox.kieu_ld.value == KieuLapDat.DM_DIDONG_CHUYEN_TINH
        if (!IsChuyenTinh) return

        //Nếu đang chọn kiểu lđ hòa mạng chuyển tỉnh thì tra cứu thêm thông tin của số máy trên CCBS để đảm
        //Nếu
        let dtThongTin = await API.post_ts_tracuu_laytt_tb(this.axios, { so_tb: so_tb })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          .catch((e) => {
            return []
          }) //service.ts_tracuu_laytt_tb(so_tb, tt_nd.USER_NEO, tt_nd.ip, tt_nd.tentat_ccbs, dichvuvt_id == DichVuVienThong.GPHONE ? "0" : "1");
        if (dtThongTin && dtThongTin.length > 0) {
          //Nếu đang chọn kiểu lđ hòa mạng chuyển tỉnh mà số nhập vào là số trả trước thì return.
          if (IsChuyenTinh && dtThongTin[0]['TRA_SAU'] == '0') {
            this.listbox.kieu_ld.value = null
            return
          }

          let dtThongTinTBCu = await API.get_ts_tracuu_laytt_tb_ts(this.axios, { params: { sotb: so_tb } })
            .then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                return this.UpperCasePropertyList(response.data.data);
              } else return []
            })
            .catch((e) => {
              return []
            }) //service.ts_tracuu_laytt_tb_ts(so_tb, dtThongTin.Rows[0]["MA_TINH"].ToString()); // vuth update 0912
          this.thuebao.didong.txtTenTBDD_Cu = ''
          this.thuebao.didong.txtNgaySinhDD_Cu = ''
          this.thuebao.didong.txtSoGTDD_Cu = ''
          this.thuebao.didong.txtNgayCapGTDD_Cu = ''
          this.thuebao.didong.txtDiaChiDD_Cu = ''
          this.thuebao.didong.txtHoKhauDD_Cu = ''
          if (dtThongTinTBCu && dtThongTinTBCu.length > 0) {
            this.thuebao.didong.txtTenTBDD_Cu = dtThongTinTBCu[0]['TEN_TB'] ? dtThongTinTBCu[0]['TEN_TB'] : ''
            this.thuebao.didong.txtNgaySinhDD_Cu = dtThongTinTBCu[0]['NGAY_SINH'] ? dtThongTinTBCu[0]['NGAY_SINH'] : ''
            this.thuebao.didong.txtSoGTDD_Cu = dtThongTinTBCu[0]['SO_GT'] ? dtThongTinTBCu[0]['SO_GT'] : ''
            this.thuebao.didong.txtNgayCapGTDD_Cu = dtThongTinTBCu[0]['NGAYCAP_GT'] ? dtThongTinTBCu[0]['NGAYCAP_GT'] : ''
            this.thuebao.didong.txtDiaChiDD_Cu = dtThongTinTBCu[0]['DIACHI'] ? dtThongTinTBCu[0]['DIACHI'] : ''
            this.thuebao.didong.txtHoKhauDD_Cu = dtThongTinTBCu[0]['DIACHI_THUONGTRU'] ? dtThongTinTBCu[0]['DIACHI_THUONGTRU'] : ''
          }
        } else {
          //Tra cứu không thấy thông tin thuê bao thì return.
          if (IsChuyenTinh) {
            //cboKieuLD.SelectedIndex = -1; // vuth update 0912
            //Message_Box.ShowWarning("Số thuê bao không chính xác");
            return
          }
        }
      } catch (ex) {
        this.listbox.kieu_ld.value = null
      }
    },
    async CHON_LOAITB_TS_THEO_TB(so_tb) {
      // //Nếu đang chọn loại tb là di động trả sau thì kiểm tra và lấy ra loaitb neo co the lap hd tương ứng với số máy nhập vào.
      if (this.listbox.loaihinh_tb.value != LoaiHinhTB.DIDONGTRASAU) {
        return
      }

      let dt = await API.post_ts_laphd_hoamangmoi_layds_loaitb(this.axios, { so_tb: so_tb })
        .then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return []
        })
        .catch((e) => {
          return []
        })

      if (dt && dt.length > 0 && dt[0].hasOwnProperty('TENLOAI') && dt[0].hasOwnProperty('LOAITB_ID')) {
        let ds_goicuoc_id_neo = [0]
        for (let gc of dt) ds_goicuoc_id_neo.push(gc.LOAITB_ID)
        let dt_goicuoc = await API.post_sp_tt_goicuoc_dd(this.axios, { type: 4, param: ds_goicuoc_id_neo.join(',') })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          .catch(() => {
            return []
          })
        this.thuebao.didong.cboGoiCuocDD.list = dt_goicuoc
        if (this.thuebao.didong.cboGoiCuocDD.list && this.thuebao.didong.cboGoiCuocDD.list.length > 0 && (!this.thuebao.didong.cboGoiCuocDD.value || !this.thuebao.didong.cboGoiCuocDD.list.find((x) => x.goicuoc_id == this.thuebao.didong.cboGoiCuocDD.value)))
          this.thuebao.didong.cboGoiCuocDD.value = this.thuebao.didong.cboGoiCuocDD.list[0].goicuoc_id
      }
    },
    TAO_DULIEU_HDTB_SUB(themmoi) {
      if (this.listbox.loaihinh_tb.value != LoaiHinhTB.Voice_Brandname) {
        this.popup.dialogHDTB_SUB_V2 = true
        if (this.$refs.dialogHDTB_SUB_V2._data.state.isUpdated && this.$refs.dialogHDTB_SUB_V2._data.state.hdtb_sub && this.$refs.dialogHDTB_SUB_V2._data.state.hdtb_sub.SO_GT && themmoi) {
          this.dsHDTB_SUB = [this.$refs.dialogHDTB_SUB_V2._data.state.hdtb_sub]
        }
        this.$refs.dialogHDTB_SUB_V2._data.state.isUpdated = false
      }
      if (this.dsHDTB_SUB.length == 1 && themmoi) {
        let temp = [...this.dsHDTB_SUB]
        this.dsHDTB_SUB = []
        let row = {}
        row.HDTB_ID = this.hdtb_id
        row.SO_GT = temp[0]['SO_GT']
        try {
          row.LOAIGT_ID = temp[0]['LOAIGT_ID'] * 1
        } catch (ex) {
          //row.LOAIGT_ID = null;
        }
        row.CHUCDANH = temp[0]['CHUCDANH']
        try {
          row.NGAYHETHAN_GT = temp[0]['NGAYHETHAN_GT']
        } catch (ex) {
          //row.NGAYHETHAN_GT = null;
        }
        row.CHUCDANH = temp[0]['CHUCDANH']
        try {
          row.NGAYHETHAN_GT = temp[0]['NGAYHETHAN_GT']
        } catch (ex) {
          //row.NGAYHETHAN_GT = null;
        }
        row.NGUOI_KY_HOSO = temp[0]['NGUOI_KY_HOSO']
        try {
          row.NGAYCAP = temp[0]['NGAYCAP']
        } catch (ex) {}
        row.NOICAP = temp[0]['NOICAP']
        row.EMAIL = temp[0]['EMAIL']
        row.SO_DT = temp[0]['SO_DT']
        try {
          row.NGAYSINH = temp[0]['NGAYSINH']
        } catch (ex) {}
        row.GIOITINH = temp[0]['GIOITINH']
        try {
          row.MST_KHTN = temp[0]['MST_KHTN']
        } catch (ex) {}
        this.dsHDTB_SUB.push(row)
      } else if (this.listbox.loaihinh_tb.value == 358 || this.listbox.loaihinh_tb.value == 132 /*ivan*/) {
      } else {
        this.dsHDTB_SUB = []
        if (this.listbox.doituong.value == 387 && this.thuebao.txtMSTThueBao) {
          let row = {}
          row.HDTB_ID = this.hdtb_id
          row.MST_KHTN = this.thuebao.txtMSTThueBao
          this.dsHDTB_SUB.push(row)
        }
        // else { //Case nay gay loi mat du lieu, bo! ThangDM1 2022-12-21
        //   this.dsHDTB_SUB.push({HDTB_ID:this.hdtb_id});
        // }
      }
    },
    DoNothing() {
      console.log('empty event!')
    },
    btnHenLD_Click() {
      this.popup.thongTinHenKhachHangModal = true
      this.$refs.thongTinHenKhachHangModal.showModal()
    },
    async cboTocDoKenhTSL_EditValueChanged() {
      if (!this.listbox.tocdokenh.valuetsl) return
      if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.TSL_DOITAC || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
        this.tocdo_id = this.listbox.tocdokenh.valuetsl * 1
        //Lấy danh sách khuyến mại
        if (!this.kt_load) {
          this.loading(true)
          await this.HienThi_CTK_CTC()
          await this.LayTienTheoKhoanMuc()
          await this.HT_DS_KhuyenMai_Combobox()
          await this.HT_GIAODIEN_DONVI()
          this.loading(false)
        }
      }
    },
    async cboTocDo_EditValueChanged() {
      if (!this.listbox.tocdokenh.valuecir) return
      this.tocdo_id = 0
      if (!this.kt_load) {
        if ([DichVuVienThong.MEGAWAN, DichVuVienThong.METRONET, DichVuVienThong.MGW_DOITAC, DichVuVienThong.NOIBO_DADIEM].indexOf(this.listbox.dichvu_vt.value * 1) >= 0) {
          this.tocdo_id = this.listbox.tocdokenh.valuecir
          await this.LayTienTheoKhoanMuc()
        }
        if ([DichVuVienThong.MEGAWAN, DichVuVienThong.TSL, DichVuVienThong.METRONET, DichVuVienThong.NOIBO_DADIEM, DichVuVienThong.NOIBO_2DIEM].indexOf(this.listbox.dichvu_vt.value * 1) >= 0) {
          await this.HienThi_CTK_CTC()
        }
        await this.HT_DS_KhuyenMai_Combobox()
        await this.HT_GIAODIEN_DONVI()
        await this.LoadMucCuocTB()
      }
    },
    async HienThi_CTK_CTC() {
      var int_loaitb_id = 0
      var int_tocdo_id = 0
      var int_doituong_id = 0
      var int_loaikenh_id = 0
      int_loaitb_id = this.listbox.loaihinh_tb.value * 1
      int_doituong_id = this.listbox.doituong.value * 1
      if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
        if (this.listbox.tocdokenh.valuetsl) int_tocdo_id = this.listbox.tocdokenh.valuetsl * 1
        else return

        int_loaikenh_id = this.listbox.loaikenh.valuetsl * 1
      }
      if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
        if (this.listbox.tocdokenh.valuecir) int_tocdo_id = this.listbox.tocdokenh.valuecir * 1
        //Convert.ToInt32(cboTocDo.EditValue);
        else return
        int_loaikenh_id = this.listbox.loaikenh.value * 1
      }

      let ds_ctk_ctc = []
      ds_ctk_ctc = await API.post_sp_lay_cuoctk_cuoctc(this.axios, {
        vloaitb_id: int_loaitb_id,
        vtocdo_id: int_tocdo_id,
        vdoituong_id: int_doituong_id,
        vloaikenh_id: int_loaikenh_id,
        vkieu: 1
      }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          return response.data.data
        }
      }) // ds_ctk_ctc = bangts.Lay_CUOCTK_CUOCTC(int_loaitb_id, int_tocdo_id, int_doituong_id, int_loaikenh_id, 1);
      if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
        if (ds_ctk_ctc && ds_ctk_ctc.length > 0 && ds_ctk_ctc[0]['cuoc_tk']) {
          this.thuebao.mgwan.cuoctk = ds_ctk_ctc[0]['cuoc_tk'] ? ds_ctk_ctc[0]['cuoc_tk'] * 1 : 0
          this.thuebao.mgwan.cuoctc = ds_ctk_ctc[0]['cuoc_tc'] ? ds_ctk_ctc[0]['cuoc_tc'] * 1 : 0
        } else {
          this.thuebao.mgwan.cuoctk = 0
          this.thuebao.mgwan.cuoctc = 0
        }
      }
      if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) {
        if (ds_ctk_ctc && ds_ctk_ctc.length > 0 && ds_ctk_ctc[0]['cuoc_tk']) {
          this.thuebao.tsl.txtCuocTK_TSL = ds_ctk_ctc[0]['cuoc_tk'] ? ds_ctk_ctc[0]['cuoc_tk'] * 1 : 0
          this.thuebao.tsl.txtCuocTC_TSL = ds_ctk_ctc[0]['cuoc_tc'] ? ds_ctk_ctc[0]['cuoc_tc'] * 1 : 0
        } else {
          this.thuebao.tsl.txtCuocTK_TSL = 0
          this.thuebao.tsl.txtCuocTC_TSL = 0
        }
      }
    },

    async HienThi_CTK_NIX_ISP(vloai) {
      if (this.kt_load) return
      var int_loaitb_id = 0
      var int_tocdo_id = 0
      var int_doituong_id = 0
      var int_loaikenh_id = 0
      int_loaitb_id = this.listbox.loaihinh_tb.value * 1
      int_doituong_id = this.listbox.doituong.value * 1
      int_loaikenh_id = this.listbox.loaikenh.value * 1
      let ds_ctk_ctc = []

      if (vloai == 2) {
        if (this.listbox.tocdokenh.valuenix) int_tocdo_id = this.listbox.tocdokenh.valuenix * 1
        ds_ctk_ctc = await API.post_sp_lay_cuoctk_cuoctc(this.axios, {
          vloaitb_id: int_loaitb_id,
          vtocdo_id: int_tocdo_id,
          vdoituong_id: int_doituong_id,
          vloaikenh_id: int_loaikenh_id,
          vkieu: 2
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          }
        }) //bangts.Lay_CUOCTK_CUOCTC(int_loaitb_id, int_tocdo_id, int_doituong_id, int_loaikenh_id, 2);
        if (ds_ctk_ctc && ds_ctk_ctc.length > 0 && ds_ctk_ctc[0]['cuoc_tk']) this.thuebao.mgwan.cuocnix = ds_ctk_ctc[0]['cuoc_tk'] ? ds_ctk_ctc[0]['cuoc_tk'] * 1 : 0
        else this.thuebao.mgwan.cuocnix = 0
      }
      if (vloai == 3) {
        if (this.listbox.tocdokenh.valueisp) int_tocdo_id = this.listbox.tocdokenh.valueisp * 1
        ds_ctk_ctc = await API.post_sp_lay_cuoctk_cuoctc(this.axios, {
          vloaitb_id: int_loaitb_id,
          vtocdo_id: int_tocdo_id,
          vdoituong_id: int_doituong_id,
          vloaikenh_id: int_loaikenh_id,
          vkieu: 3
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          }
        }) //bangts.Lay_CUOCTK_CUOCTC(int_loaitb_id, int_tocdo_id, int_doituong_id, int_loaikenh_id, 3);
        if (ds_ctk_ctc && ds_ctk_ctc.length > 0 && ds_ctk_ctc[0]['cuoc_tk']) this.thuebao.mgwan.cuocisp = ds_ctk_ctc[0]['cuoc_tk'] ? ds_ctk_ctc[0]['cuoc_tk'] * 1 : 0
        else this.thuebao.mgwan.cuocisp = 0
      }
    },
    async cboLoaiKenh_SelectedValueChanged() {
      if (!this.kt_load) {
        this.loading(true)
        if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
          await this.HienThi_CTK_CTC()
          this.HienThi_CTK_NIX_ISP(2)
          this.HienThi_CTK_NIX_ISP(3)
        }
        if (this.listbox.dichvu_vt.value == DichVuVienThong.TSL || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_2DIEM) await this.HienThi_CTK_CTC()
        await this.HT_GIAODIEN_DONVI()
        this.loading(false)
      }
    },

    async HienThiTT_HopDong_ChuaHT(dt) {
      try {
        //DataSet ds = tcdanhba.LAY_DB_THEO_MATB(ma_tb);
        if (dt.length > 0) {
          this.khachhang.hdkh_id = dt[0]['hdkh_id']
          this.dsHDKH_Sub = []

          if (dt[0]['nhanvien_id']) {
            this.thanhtoan.nhanvientc_id = dt[0]['nhanvien_id']
            // this.thanhtoan.manvtc = objCheckData.MAP_ID("ma_nv", DatabaseConstants.DB1 + ".nhanvien", "where nhanvien_id =" + nhanvientc_id.ToString());
          } else {
            this.thanhtoan.nhanvientc_id = 0
            this.thanhtoan.manvtc = ''
          }

          if (dt[0]['tuyenthu_id']) {
            this.thanhtoan.tuyenthu_id = dt[0]['tuyenthu_id']
            // this.thanhtoan.matuyen = objCheckData.MAP_ID("ma_tuyen", DatabaseConstants.DB2 + ".tuyenthu", "where tuyenthu_id =" + tuyenthu_id.ToString());
          } else {
            this.thanhtoan.tuyenthu_id = 0
            this.thanhtoan.matuyen = ''
          }

          let vetinh_id = ''
          let hdttid_temp = ''
          let hdtbid_t = ''
          let apidata = {}
          let dthdkh_sub = await API.post_fn_lay_tt_hopdong_chuaht(this.axios, { ds_para: JSON.stringify({ HDKH_ID: this.khachhang.hdkh_id, NHANVIEN_ID: this.thanhtoan.nhanvientc_id, TUYENTHU_ID: this.thanhtoan.tuyenthu_id, BANCHEO: 1 }) })
            .then((response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                apidata = JSON.parse(response.data.data)
                if (apidata['ERROR_CODE'] != 1) {
                  this.$toast.error(apidata['MESSAGE'])
                  return []
                }
                apidata = apidata['RESULT']
                if (apidata['MA_NV']) this.thanhtoan.manvtc = apidata['MA_NV']
                if (apidata['MA_TUYEN']) this.thanhtoan.matuyen = apidata['MA_TUYEN']
                if (apidata['NVTC_ID']) this.thanhtoan.nhanvientc_id = apidata['NVTC_ID']
                if (apidata['TUYENTHU_ID']) this.thanhtoan.tuyenthu_id = apidata['TUYENTHU_ID']
                if (apidata['VETINH_ID']) vetinh_id = apidata['VETINH_ID']
                if (apidata['HDTT_ID']) hdttid_temp = apidata['HDTT_ID']
                if (apidata['HDTB_ID']) hdtbid_t = apidata['HDTB_ID']

                return apidata['HDKH_SUB']
              } else return []
            })
            .catch(() => {
              return []
            }) //bangts.Laythongtin_table(Common.CommonConstants.DatabaseConstants.DB2 + ".hdkh_sub", "hdkh_id = " + hdkh_id.ToString(), "*", "").Tables[0];
          if (dthdkh_sub && dthdkh_sub.length > 0) {
            this.TAO_DULIEU_HDKH_SUB(dthdkh_sub, this.khachhang.hdkh_id)
          }
          //Tuan them bien TBHD_PL = 0 --> khach hang đặt mới la khach hang cu -- Ngay 24/08/2010
          this.thuebao.tbhd_pl = 0 //In Phu Luc
          //Thông tin khách hàng
          this.NgayYeuCau = moment(new Date()).format('DD/MM/YYYY HH:mm:ss') //tt_nd.ngay_cn;
          if (dt[0]['ngaylap_hd']) {
            this.NgayLapHD = dt[0]['ngaylap_hd']
          }
          this.khachhang.makh = dt[0]['ma_kh']
          this.khachhang.mahd = dt[0]['ma_hd']
          if (dt[0]['khachhang_id']) this.khachhang.khachhang_id = dt[0]['khachhang_id']
          this.khachhang.tenkh = this.ChuanHoaTen(dt[0]['ten_kh'])
          this.diachiKH.DIACHI = this.ChuanHoaTen(dt[0]['diachi_kh'])
          if (dt[0]['loaikh_id']) {
            this.listbox.loai_kh.value = dt[0]['loaikh_id']
            this.loaikhChanged(this.listbox.loai_kh.list.find((x) => x.loaikh_id == this.listbox.loai_kh.value))
          }
          if (dt[0]['diachi_ndd']) this.diachiNDD.DIACHI = this.ChuanHoaTen(dt[0]['diachi_kh'])
          else this.diachiNDD.DIACHI = this.ChuanHoaTen(dt[0]['diachi_ndd'])
          if (this.listbox.loai_kh.value == Loai_KH.CANHAN_HOGIADINH && dt[0]['nguoi_dd']) this.khachhang.nguoidd = this.khachhang.tenkh
          else this.khachhang.nguoidd = this.ChuanHoaTen(dt[0]['nguoi_dd'])

          if (dt[0]['nganhnghe_id']) {
            this.listbox.nganhngheloc.value = dt[0]['nganhnghe_id']
            this.nganhnghe_id = dt[0]['nganhnghe_id']
          }

          //TuấnNA thêm code hiển thị thông tin id tiểu ngành c1,c2,c3 -- Ngày 03/12/2010
          if (dt[0]['tnc1_id']) this.TNC1_ID = dt[0]['tnc1_id']
          if (dt[0]['tnc2_id']) this.TNC2_ID = dt[0]['tnc2_id']
          if (dt[0]['tnc3_id']) this.TNC3_ID = dt[0]['tnc3_id']
          //
          if (apidata['DS_DIACHI_HDKH']) this.HienThiTTDiaChi(apidata['DS_DIACHI_HDKH'], 1)
          this.khachhang.dienthoai = dt[0]['so_dt']
          this.khachhang.fax = dt[0]['so_fax']

          if (dt[0]['ngay_sn']) {
            this.NgaySinh = dt[0]['ngay_sn']
            if (!this.NgaySinhTB) this.NgaySinhTB = this.NgaySinh
          } else this.NgaySinh = ''
          this.khachhang.sogt = dt[0]['so_gt']
          if (dt[0]['ngaycap']) this.NgayCap = dt[0]['ngaycap']
          else this.NgayCap = ''

          //Hiếu bổ sung 1 số thông tin thiếu 27.09.2010
          if (dt[0]['ngayhethan_gt']) this.NgayHH = dt[0]['ngayhethan_gt']
          else this.NgayHH = ''

          this.diachiHK.DIACHI = this.ChuanHoaTen(dt[0]['hokhau'])
          this.khachhang.noicap = this.ChuanHoaTen(dt[0]['noicap_hk'])
          if (dt[0]['ngaycap']) this.NgayCapHK = dt[0]['ngaycap']
          else this.NgayCapHK = ''

          this.khachhang.masothue = dt[0]['mst']
          this.listbox.nganhang.sotaikhoankh = dt[0]['stk']
          if (dt[0]['nganhang_id']) this.listbox.nganhang.ischeckedkh = true
          else this.listbox.nganhang.ischeckedkh = false
          this.khachhang.dactrung = dt[0]['dactrung']
          this.khachhang.ghichu = dt[0]['ghichu']
          if (dt[0]['loaigt_id']) this.listbox.loai_gt.value = dt[0]['loaigt_id']
          this.khachhang.noicap = this.ChuanHoaTen(dt[0]['noicap'])
          this.listbox.loai_khl.value = dt[0]['khlon_id']
          //HungHm-07/07/2010: Bổ xung thêm các trường mới từ bảng DB_ThanhToan

          this.diachiCT.DIACHI = this.ChuanHoaTen(dt[0]['diachi_ct'])
          //end edit
          this.nganhang.DV_QHNS = dt[0]['DV_QHNS']
          this.nganhang.MACHUONG = dt[0]['MACHUONG']
          this.nganhang.MN_KT = dt[0]['MN_KT']
          this.nganhang.MA_NDKT = dt[0]['MA_NDKT']
          this.nganhang.MN_NSNN = dt[0]['MN_NSNN']

          this.thanhtoan.tentt = this.ChuanHoaTen(dt[0]['ten_tt'])
          this.diachiTT.DIACHI = this.ChuanHoaTen(dt[0]['diachi_tt'])
          //địa chỉ báo cước
          this.diachiBC.DIACHI = this.ChuanHoaTen(dt[0]['diachi_bc'])
          //let hdttid_temp = Convert.ToInt64(tchopdong.LAY_DS_HOPDONG_TT_THEO_HDKH_ID(hdkh_id).Tables[0].Rows[0]["hdtt_id"].ToString()); //chuyen len tren!!!

          if (apidata['DS_DIACHI_HDTT']) this.HienThiTTDiaChi(apidata['DS_DIACHI_HDTT'], 2)
          //
          if (!dt[0]['diachi_ct']) this.diachiCT.DIACHI = this.ChuanHoaTen(dt[0]['diachi_tt'])
          else this.diachiCT.DIACHI = this.ChuanHoaTen(dt[0]['diachi_ct'])

          this.thanhtoan.masothue = dt[0]['mst_tt']
          this.listbox.nganhang.sotaikhoan = dt[0]['stk_tt']
          this.thanhtoan.chutk = dt[0]['chu_tk_tt']
          if (dt[0]['nganhang_id_tt']) this.listbox.nganhang.value = dt[0]['nganhang_id_tt']
          this.listbox.hinhthuc_tthi.value = dt[0]['httt_id']
          if (dt[0]['donvi_id']) this.listbox.donvi_ql.valueql = dt[0]['donvi_id'] //cboDonViQL.SelectedValue = dt[0]["donvi_id"];

          this.thanhtoan.matb_dd = dt[0]['matb_dd']

          //HIếu bổ sung thêm một số thông tin 1.10.2010
          this.thuebao.tentb = this.ChuanHoaTen(dt[0]['ten_tb'])
          this.diachiTB.DIACHI = this.ChuanHoaTen(dt[0]['diachi_tb'])

          // long hdtbid_t = Convert.ToInt64(tchopdong.LAY_DS_HOPDONG_TB_THEO_HDKH_ID_BC(hdkh_id).Tables[0].Rows[0]["hdtb_id"]); // lay ra khong dung -> bo
          if (apidata['DS_DIACHI_HDTB']) this.HienThiTTDiaChi(apidata['DS_DIACHI_HDTB'], 3) //truoc ham nay dang comment, mo lai vi thay co du lieu

          if (dt[0]['donviql_id']) this.listbox.donvi_ql.value = dt[0]['donviql_id']

          //
          this.listbox.doituong.value = dt[0]['doituong_id']

          if (!this.listbox.doituong.value) {
            this.listbox.doituong.value = this.listbox.doituong.list && this.listbox.doituong.list[0] ? this.listbox.doituong.list[0].doituong_id : 0
          }
          //Lấy ds mức cước thuê bao
          //Index trạm thi công theo phường
          // Chuyen phan khai bao ve tinh len tren
          // string vetinh_id = "";
          // vetinh_id = objCheckData.MAP_ID("donvi_id", DatabaseConstants.DB2 + ".donvi_px",
          //             "where phuong_id =" + phuongld_id + " and decode(" + phold_id + ",0, 0, pho_id) = " + phold_id + " and loaidv_id = " + LOAI_DV.TRAM_VT);
          if (this.listbox.dichvu_vt.value == DichVuVienThong.CO_DINH) {
            if (vetinh_id != '-1') this.buttons.btnChonSM = true
            else this.buttons.btnChonSM = false
          } else if (this.listbox.dichvu_vt.value == DichVuVienThong.IMS) {
            if (vetinh_id != '-1') this.buttons.btnChonSoIMS = true
            else this.buttons.btnChonSoIMS = false
          } else if (this.listbox.dichvu_vt.value == DichVuVienThong.ADSL) {
          } else if (this.listbox.dichvu_vt.value == DichVuVienThong.MEGAWAN || this.listbox.dichvu_vt.value == DichVuVienThong.METRONET || this.listbox.dichvu_vt.value == DichVuVienThong.NOIBO_DADIEM) {
          }
          this.Lay_DS_MucCuoc_TB(0, 0, 0, 0, this.listbox.loaihinh_tb.value, this.listbox.doituong.value, this.NgayYeuCau)
          //
          if (dt[0]['diachi_ld']) this.diachiLD.DIACHI = this.ChuanHoaTen(dt[0]['diachi_tb'])
          else this.diachiLD.DIACHI = this.ChuanHoaTen(dt[0]['diachi_ld'])

          if (dt[0]['ngay_sn']) this.NgaySinhTB = dt[0]['ngay_sn']
          else this.NgaySinhTB = this.NgaySinh ? this.NgaySinh : ''
          // chkLapDatBS.Checked = true;// khong biet o dau!
          this.HienThiDS_HDTT_CBO(this.khachhang.hdkh_id)
          this.HienThiTTHopDongTT(apidata['DS_HD'])
          this.HienThiDanhSacHDTT(apidata['DS_HD'])

          //SendKeys.Send("{TAB}");
        } else {
          //Tuan them bien TBHD_PL = 1 --> khach hang đặt mới la khach hang Moi -- Ngay 24/08/2010
          this.thuebao.tbhd_pl = 1 // In HD
          // chkLapDatBS.Checked = false;
          // SendKeys.Send("{TAB}");
        }
      } catch (exp) {
        if (this.debug) console.error(exp)
        //new LogError().GetError(new log4net.Core.LoggingEvent(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType, log.Logger.Repository, log.Logger.Name, log4net.Core.Level.Info, exp.Message, exp), true);
      }
    },
    btnOpenfrmDangKyGoiDaDVLM() {
      this.popup.frmDangKyGoiDaDVLM = true
      this.$refs.frmDangKyGoiDaDVLM.showDialog(this.khachhang.magd, this.diachiLD.LOAINHA_ID)
    },
    async KiemTraDL_KhachHang() {
      //TODO chua hoan thanh
      let pdata = {
        MA_KH: this.khachhang.makh ? this.khachhang.makh : null,
        KHACHHANG_ID: this.khachhang.khachhang_id,
        LOAIGT_ID: this.listbox.loai_gt.value,
        NGAY_SN: this.NgaySinh && this.NgaySinh.indexOf(' ') ? this.NgaySinh.substring(0, this.NgaySinh.indexOf(' ')) : this.NgaySinh,
        MA_GD: this.khachhang.magd ? this.khachhang.magd : null,
        KIEUKH_ID: this.vkieukh_id_,
        MA_STKH: this.khachhang.masothue,
        KHOI: this.dsHDKH_Sub && this.dsHDKH_Sub.length > 0 && this.dsHDKH_Sub[0]['KHOI_ID'] ? this.dsHDKH_Sub[0]['KHOI_ID'] : null,
        LOAIKH_ID: this.listbox.loai_kh.value,
        TS_MSTMNS_KH: 1,
        MST: this.khachhang.masothue,
        SO_HD: this.dsHDKH_Sub && this.dsHDKH_Sub.length > 0 && this.dsHDKH_Sub[0]['SO_HD_KHDN'] ? this.dsHDKH_Sub[0]['SO_HD_KHDN'] : null
      }
      let kq = await API.post_fn_kiemtra_dl_khachhang(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
        if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
          let apidata = JSON.parse(response.data.data)
          if (apidata['ERROR_CODE'] != 1) {
            this.$toast.error(apidata['MESSAGE'])
            return false
          } else return true
        }
      })
      if (!kq) return false
      if (!this.listbox.loai_kh.value || this.listbox.loai_kh.value == -1) {
        this.$toast.error('Bạn hãy chọn loại khách hàng trước')
        return false
      }
      let lgt = this.listbox.loai_gt.list.find((x) => x.loaigt_id == this.listbox.loai_gt.value)
      if (!lgt || lgt.length <= 0) {
        this.$toast.error('Chưa chọn loại giấy tờ hoặc loại giấy tờ được chọn không áp dụng cho nhóm khách hàng hiện tại. Vui lòng chọn lại loại giấy tờ!')
        return false
      }
      if (this.vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) {
        if (lgt['loai_kh'] && lgt['loai_kh'] != 0 && lgt['loai_kh'] != 2) {
          this.$toast.error('Loại giấy tờ: ' + lgt['loai_gt'] + ' Không áp dụng cho nhóm khách hàng là: Doanh nghiệp.\n Hãy chọn lại: Loại giấy tờ hoặc Loại khách hàng')
          return false
        }
      } else {
        if (lgt['loai_kh'] && lgt['loai_kh'] != 0 && lgt['loai_kh'] != 1) {
          this.$toast.error('Loại giấy tờ: ' + lgt['loai_gt'] + ' Không áp dụng cho nhóm khách hàng là: Cá nhân.\n Hãy chọn lại: Loại giấy tờ hoặc Loại khách hàng')
          return false
        }
      }
      // if (txtSoGT.Text == "")
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowWarning("Hãy nhập số giấy tờ !");
      //     txtSoGT.Focus();
      //     return false;
      // }
      if (this.vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) {
        //Khách hàng doanh nghiệp
        if (this.listbox.loaihinh_tb.value != LoaiHinhTB.BaoHieuQuocTe && this.listbox.loaihinh_tb.value != LoaiHinhTB.THOAIQT) {
          if (this.dsHDKH_Sub.length == 0 || (this.dsHDKH_Sub.length > 0 && !this.dsHDKH_Sub[0]['KHOI_ID'])) {
            this.$toast.error('Bạn phải chọn khối trong thông tin khách hàng bổ sung')
            return false
          }
        }

        // if (dsHDKH_Sub.Tables[0].Rows.Count > 0 && dsHDKH_Sub.Tables[0].Rows[0]["KHOI_ID"].ToString() != "")
        // {
        //     string vkhoi = dsHDKH_Sub.Tables[0].Rows[0]["KHOI_ID"].ToString();

        //     let kq = new LapHopDongFacade2().GET_VALUE_FUNC("{?DB2}.kiemtra_khoi_loaikh", "vkhoi_id", vkhoi, "vloaikh_id", cboLoaiKH.EditValue);
        //     if (kq.ToString() != "OK")
        //     {
        //         Message_Box.ShowTB("Có lỗi khi kiểm tra: " + kq.ToString());
        //         return false;
        //     }
        // }

        if (this.listbox.loai_gt.value == LoaiGiayTo.MA_NGANSACH) {
          if (!(this.khachhang.sogt + '').match(/^[123789]\d{6}$/g)) {
            this.$toast.error('Mã ngân sách phải là số có 7 chữ số và bắt đầu bằng 1 trong các số 1/2/3/7/8/9. Vui lòng kiểm tra lại!')
            return false
          }
        }
        let mst_ = this.thanhtoan.masothue
        // string mst_ = "";
        // if (ts_kt_mst_kh == 1)
        // {
        //     mst_ = txtMaSTKH2.Text.Trim();
        // }
        // else
        // {
        //     mst_ = txtMaSTKH.Text.Trim();
        // }
        if (this.thamsomacdinh['KIEMTRA_MSTMNS_KHDN'] == 1) {
          if (!mst_ && (this.dsHDKH_Sub.length == 0 || (this.dsHDKH_Sub.length > 0 && !this.dsHDKH_Sub[0]['MA_NS'])) && !this.is_nv_vnpti) {
            this.$toast.error('Bạn phải nhập mã số thuế hoặc mã ngân sách')
            return false
          }
          // if (mst_) // Thuc hien o FN_KIEMTRA_DL_KHACHHANG
          // {
          //     let kq_kt = new LapHopDongFacade2().GET_VALUE_FUNC("{?DB2}.KiemTra_MST".ReplaceSchema(), "vmst", mst_.ToString());
          //     if (kq_kt.ToString() != "OK")
          //     {
          //         Message_Box.ShowTB(kq_kt.ToString());
          //         return false;
          //     }
          // }

          if (this.dsHDKH_Sub.length > 0 && this.dsHDKH_Sub[0]['MA_NS']) {
            let mans = this.dsHDKH_Sub[0]['MA_NS'] + ''
            if (!(mans + '').match(/^[123789]\d{6}$/g)) {
              this.$toast.error('Mã ngân sách phải là số có 7 chữ số và bắt đầu bằng 1 trong các số 1/2/3/7/8/9. Vui lòng kiểm tra lại!')
              return false
            }
          }
        }

        // string vso_hd = "";
        // if (dsHDKH_Sub.Tables[0].Rows.Count > 0)
        //     vso_hd = dsHDKH_Sub.Tables[0].Rows[0]["SO_HD_KHDN"].ToString();

        // let vkq = new LapHopDongFacade2().GET_VALUE_FUNC("{?DB2}.kiemtra_so_hd_khdn", "vso_hd", vso_hd);
        // if (vkq.ToString() != "OK")
        // {
        //     Message_Box.ShowTB(vkq.ToString());
        //     return false;
        // }
      }
      if (this.thamsomacdinh['KHONGBATBUOC_CTV'] != 1 || this.filterbox.ctv.ischecked) {
        if (!this.filterbox.ctv.ischecked || !this.filterbox.ctv.value || !this.ctv_id || this.ctv_id == 0) {
          this.$toast.error('Bạn chưa chọn nhân viên phát triển / cộng tác viên!')
          // txtCTV.Focus();
          return false
        }

        if (!this.listbox.hinhthuc_tthi.value || this.listbox.hinhthuc_tthi.value <= 0) {
          // if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
          this.$toast.error('Hãy chọn hình thức tiếp thị')
          // cboHinhThucTThi.Focus();
          return false
        }
      }
      if (this.thamsomacdinh['BATBUOC_GIOITHIEU_LAPMOI'] == 1 || this.filterbox.nguoigt.ischecked) {
        if (!this.filterbox.nguoigt.ischecked || !this.filterbox.nguoigt.value || !this.filterbox.nguoigt.nguoigt_id || this.filterbox.nguoigt.nguoigt_id == 0) {
          this.$toast.error('Bạn chưa chọn người giới thiệu hợp đồng/phụ lục')
          // txtNguoiGT.Focus();
          return false
        }
      }
      return true
    },
    async KiemTraDL_ThanhToan() {
      if (this.khachhang.khachhang_id && this.khachhang.khachhang_id != 0 && (!this.thanhtoan.matt || (this.thanhtoan.matt + '').trim() == '')) {
        if (!(this.thamsomacdinh['BATBUOC_GHEP_MATT'] == 1)) {
          let cfr = await this.$bvModal
            .msgBoxConfirm('Bạn thật sự muốn sinh mã thanh toán mới không ?', {
              title: 'Thông báo',
              size: 'sm',
              okTitle: 'Đồng ý',
              cancelTitle: 'Hủy'
            })
            .then((v) => {
              return v
            })
          if (!cfr) return
        } else {
          this.$toast.error('Bạn phải ghép mã thanh toán')
          return
        }
      }
      //TODO chua lam

      // if (txtTenTT.Text == "")
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowTB("Hãy nhập tên thanh toán !");
      //     txtTenTT.Focus();
      //     return false;
      // }

      // if (txtTenTT.Text.Trim().Length > 500)
      // {
      //     Message_Box.ShowWarning("Tên thanh toán không được lớn hơn 500 ký tự");
      //     txtTenTT.Focus();
      //     return false;
      // }
      // // anhnt: 22/05/2020 bỏ kiem tra ghi chu
      // //if (txtGhiChuTT.Text.Length > 240)
      // //{
      // //    Message_Box.ShowWarning("Ghi chú thanh toán không được lớn hơn 240 ký tự");
      // //    txtGhiChuTT.Focus();
      // //    return false;
      // //}

      if (this.thanhtoan.matt && this.thanhtoan.thanhtoan_id && this.thanhtoan.thanhtoan_id != 0) {
        if (this.listbox.madaidien.list && this.listbox.madaidien.list.length > 0) {
          if (!this.listbox.madaidien.value || this.listbox.madaidien.value <= 0) {
            // if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
            this.$toast.error('Hãy chọn mã đại diện !')
            // cboMaDD.Focus();
            return false
          }
        }
      }
      //Kiểm tra đăng ký dv khác (NOTE: trước là else, nhưng chuyển ra đây vì if else dùng chung, kiểm tra từ form thay vì DB)
      {
        // #region Kiểm tra dịch vụ khác
        if (this.thamsomacdinh['KIEMTRA_LIENHE_THANHTOAN'] == 1) {
          //if (KIEMTRA_LIENHE_THANHTOAN == 1)
          //DV khác đang sử dụng
          // DataTable dtDVK_SD = tcdanhba.LAY_DS_SUDUNG_DVK(thanhtoan_id, 2).Tables[0];
          let dtDVK_SD = []
          if (this.thanhtoan.matt && this.thanhtoan.thanhtoan_id && this.thanhtoan.thanhtoan_id != 0)
            dtDVK_SD = await API.get_lay_ds_sudung_dvk(this.axios, { params: { dbId: this.thanhtoan.thanhtoan_id, loaiId: 2 } })
              .then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                  return response.data.data
                } else return []
              })
              .catch(() => {
                return []
              })
          let sd_lh_tt = 0
          let sd_dvk_13 = 0
          let sd_dvk_14 = 0

          for (var i = 0; i < dtDVK_SD.length; i++) {
            if (dtDVK_SD[i]['dvKhacId'] == 13) {
              sd_lh_tt = 1
              sd_dvk_13 = 1
            }
            if (dtDVK_SD[i]['dvKhacId'] == 14) {
              sd_lh_tt = 1
              sd_dvk_14 = 1
            }
          }

          let dky_lh_tt = 0
          let dk_dvk_13 = 0 //Nhận giấy báo cước qua SMS
          let dk_dvk_14 = 0 //Nhận giấy báo cước qua Email
          //response.data.data.map(x=>({'DVKHAC_ID':x['dvkhac_id'],'TEN_DVKHAC':x['ten_dvkhac'],'KIEU_YC':x['caidat_md'],'LOAIID':x['loaiid'],'TTTH':0, 'HD_ID':this.hdtb_id,'NGAY_YC':this.NgayYeuCau}));
          for (var i = 0; i < this.dsDK_DVK_TT.length; i++) {
            if ((this.dsDK_DVK_TT[i]['dvkhac_id'] == 13 || this.dsDK_DVK_TT[i]['dvkhac_id'] == 14) && this.dsDK_DVK_TT[i]['kieu_yc'] == 1) {
              dky_lh_tt = 1
              break
            }
          }
          if (sd_lh_tt == 0 && dky_lh_tt == 0) {
            //chưa sử dụng và ko đăng ký mới dv khác 13, 14
            this.$toast.error('Phải đăng ký dịch vụ "Nhận giấy báo cước qua SMS" hoặc "Nhận giấy báo cước qua Email"')
            return false
          } else {
            for (var i = 0; i < this.dsDK_DVK_TT.length; i++) {
              if (this.dsDK_DVK_TT[i]['dvkhac_id'] == 13 && this.dsDK_DVK_TT[i]['kieu_yc'] == 1) {
                dk_dvk_13 = 1
              }

              if (this.dsDK_DVK_TT[i]['dvkhac_id'] == 14 && this.dsDK_DVK_TT[i]['kieu_yc'] == 1) {
                dk_dvk_14 = 1
              }
            }
            if ((sd_dvk_13 == 1 || dk_dvk_13 == 1) && (!this.thanhtoan.sodienthoai || this.thanhtoan.sodienthoai.trim() == '')) {
              this.$toast.error('SĐT thanh toán không thể để trống khi dùng dịch vụ "Nhận giấy báo cước qua SMS"!')
              // txtDienThoaiTT.Focus();
              return false
            }
            if ((sd_dvk_14 == 1 || dk_dvk_14 == 1) && (!this.thanhtoan.email || this.thanhtoan.email.trim() == '')) {
              this.$toast.error('Email thanh toán không thể để trống khi dùng dịch vụ "Nhận giấy báo cước qua Email"!')
              // txtEmailTT.Focus();
              return false
            }
          }
        }
        // #endregion
      }

      if (this.thanhtoan.email && !/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(this.thanhtoan.email)) {
        this.$toast.error('Email thanh toán không đúng định dạng')
        // txtEmailTT.Focus();
        return false
      }

      if (!this.diachiTT.DIACHI || this.diachiTT.DIACHI.trim() == '' || this.diachiTT.QUAN_ID <= 0 || this.diachiTT.PHUONG_ID <= 0) {
        // if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
        this.$toast.error('Hãy nhập địa chỉ thanh toán !')
        // txtDiaChiTT.Focus();
        return false
      }

      // // bỏ chọn đặc điểm dd tra truoc vuth update 14/12 -- code cua a Khaỉ hpg
      // if (this.listbox.dichvu_vt.value != DichVuVienThong.DI_DONG && Convert.ToInt32(cboLoaihinhTB.SelectedValue) != LoaiHinhTB.DIDONGTRATRUOC)
      // {
      //     if (batbuoc_chon_dacdiem == 1 && (quantt_id != 0 || phuongtt_id != 0) &&
      //         (phott_id != 0 || aptt_id != 0 || khutt_id != 0))
      //     {
      //         string strKtraDD = "select 1 from " + DatabaseConstants.DB2
      //             + ".dacdiem_dd where phuong_id=" + phuongtt_id + " and pho_id=" + phott_id + " and dacdiem_id<>0";
      //         DataSet dsDD = bangts.GetSQL(strKtraDD, "");
      //         if (dsDD != null && dsDD.Tables[0].Rows.Count > 0)
      //         {
      //             if (dacdiemtt_id == 0)
      //             {
      //                 string strbc = "Select * ";
      //                 strbc += " From " + DatabaseConstants.DB2 + ".hd_bancheo";
      //                 strbc += " Where hdtb_thicong = " + hdtb_id;
      //                 DataSet dsbc = bangts.GetSQL(strbc, "");
      //                 if (dsbc.Tables[0].Rows.Count == 0)
      //                 {
      //                     Message_Box.ShowTB("Địa chỉ thanh toán này có đặc điểm. Yêu cầu chọn đặc điểm!");
      //                     txtDiaChiTT.Focus();
      //                     return false;
      //                 }
      //             }
      //         }
      //     }
      // }

      if (!this.diachiTT.DIACHI || this.diachiTT.DIACHI == '' || this.diachiTT.QUAN_ID == 0 || this.diachiTT.PHUONG_ID == 0) {
        // if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
        this.$toast.error('Hãy nhập địa chỉ thanh toán !')
        // txtDiaChiTT.Focus();
        return false
      }

      if (!this.diachiCT.DIACHI || this.diachiCT.DIACHI.trim() == '') {
        // if (tabctlThongTin.SelectedIndex == 1)
        //     tabctlThongTin.SelectedIndex = 0;
        this.$toast.error('Hãy nhập địa chỉ chứng từ !')
        // txtDiaChiCT.Focus();
        return false
      }

      // if (Convert.ToInt32(cboHTTT.EditValue) == HinhThucThanhToan.UYNHIEM_THU
      //     || Convert.ToInt32(cboHTTT.EditValue) == HinhThucThanhToan.UYNHIEM_CHI)
      // {
      //     if (khongnhap_stk_uynhiemthu == 0)
      //     {
      //         if (txtSTK_TT.Text == "")
      //         {
      //             if (tabctlThongTin.SelectedIndex == 1)
      //                 tabctlThongTin.SelectedIndex = 0;
      //             Message_Box.ShowTB("Hãy nhập Tài khoản  !");
      //             txtSTK_TT.Focus();
      //             return false;
      //         }
      //         if (txtChu_TK.Text == "")
      //         {
      //             if (tabctlThongTin.SelectedIndex == 1)
      //                 tabctlThongTin.SelectedIndex = 0;
      //             Message_Box.ShowTB("Hãy nhập Chủ tài khoản  !");
      //             txtChu_TK.Focus();
      //             return false;
      //         }
      //     }

      //     if (Convert.ToInt32(cboHTTT.EditValue) == HinhThucThanhToan.UYNHIEM_THU && UNT_BATBUOC_THONGTIN_TK == 1)
      //     {
      //         if (txtSTK_TT.Text == "")
      //         {
      //             if (tabctlThongTin.SelectedIndex == 1)
      //                 tabctlThongTin.SelectedIndex = 0;
      //             Message_Box.ShowTB("Hãy nhập Tài khoản với hình thức thanh toán Ủy nhiệm thu!");
      //             txtSTK_TT.Focus();
      //             return false;
      //         }
      //         if (txtChu_TK.Text == "")
      //         {
      //             if (tabctlThongTin.SelectedIndex == 1)
      //                 tabctlThongTin.SelectedIndex = 0;
      //             Message_Box.ShowTB("Hãy nhập Chủ tài khoản với hình thức thanh toán Ủy nhiệm thu!");
      //             txtChu_TK.Focus();
      //             return false;
      //         }
      //     }
      //     //HCM: Ủy nhiệm thu, chi không cần mã số thuế
      //     //if (txtMST_TT.Text == "")
      //     //{
      //     //    if (tabctlThongTin.SelectedIndex == 1)
      //     //        tabctlThongTin.SelectedIndex = 0;
      //     //    Message_Box.ShowTB("Hãy nhập Mã số thuế  !");
      //     //    txtMST_TT.Focus();
      //     //    return false;
      //     //}
      // }

      // if (!KiemTra_SDT(txtDienThoaiTT, "THANHTOAN"))
      //     return false;

      // //Hà Nội: Doanh nghiệp không thể lập hợp đồng thu tại địa chỉ lắp đặt
      // if (DN_KHONG_THU_TAI_DIACHILD >= 0)
      //     if (cboLoaiKH.EditValue != null && cboLoaiKH.Properties.View.FocusedRowHandle >= 0)
      //     {
      //         if (Convert.ToInt32(cboLoaiKH.Properties.View.GetDataRow(cboLoaiKH.Properties.View.FocusedRowHandle)["LOAI"]) == KIEU_KH.DOANH_NGHIEP)
      //         {
      //             if (Convert.ToInt32(cboHTTT.EditValue) == HinhThucThanhToan.THU_TAI_NHA)
      //             {
      //                 Message_Box.ShowTB("Khách hàng doanh nghiệp không thể thu tại địa chỉ thanh toán");
      //                 cboHTTT.Focus();
      //                 return false;
      //             }
      //         }
      //     }

      if (!this.listbox.donvi_ql.list || this.listbox.donvi_ql.list.length <= 0) {
        // if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
        this.$toast.error('Địa chỉ thanh toán này chưa được thiết lập đơn vị quản lý !')
        // btnDiaChiTT.Focus();
        return false
      } else {
        if (!this.listbox.donvi_ql.valueql || this.listbox.donvi_ql.valueql == 0) {
          // if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
          this.$toast.error('Địa chỉ thanh toán này chưa được thiết lập đơn vị quản lý !')
          // btnDiaChiTT.Focus();
          return false
        }
      }
      if (!this.thanhtoan.manvtc) {
        // if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
        this.$toast.error('Hãy nhập mã nhân viên thu cước !')
        // txtMaNVTC.Focus();
        return false
      }
      if (!this.thanhtoan.tuyenthu_id || this.thanhtoan.tuyenthu_id == 0) {
        // if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
        this.$toast.error('Không tìm thấy thông tin tuyến thu')
        // txtMaNVTC.Focus();
        return false
      }
      // if (tracuuchung.KIEMTRA_MATT(txtMaTT.Text, thanhtoan_id))
      // {
      //     if (tabctlThongTin.SelectedIndex == 1) tabctlThongTin.SelectedIndex = 0;
      //     Message_Box.ShowTB("Kiểm tra lại mã thanh toán !");
      //     txtMaTT.Focus();
      //     return false;
      // }

      // //Hieutc: 11.10.2011: Kiểm tra mã thanh toán đã theo đúng chuẩn chưa
      // if (txtMaTT.Text.Trim() != "")
      // {
      //     if (laphd.Kiemtra_makh_mtt(txtMaTT.Text.Trim(), 2, LoaiHopDong.DAT_MOI) == 0)
      //     {
      //         Message_Box.ShowWarning("Mã thanh toán không đúng chuẩn quy định của Viễn thông tỉnh.\nBạn hãy kiểm tra lại!");
      //         txtMaTT.Focus();
      //         return false;
      //     }
      // }
      // //KhaiVK: 12/06/2018: Kiểm tra mã số thuế theo chuẩn
      // string maSoThue = "";
      // if (ts_kt_mst_kh == 1)
      //     maSoThue = txtMST_TT2.Text.Trim();
      // else
      //     maSoThue = txtMST_TT.Text.Trim();
      // if (maSoThue != string.Empty && ts_kt_mst == 1)
      // {
      //     string ketQua = CommonUtilities.KiemTraDinhDangMaSoThue(maSoThue);
      //     if (ketQua != "OK")
      //     {
      //         Message_Box.ShowWarning(ketQua);
      //         if (ts_kt_mst_kh == 1)
      //             txtMST_TT2.Focus();
      //         else
      //             txtMST_TT.Focus();
      //         return false;
      //     }
      //     else
      //     {
      //         DataSet ds_maKH = new DataSet();
      //         ds_maKH = tcdanhba.LAY_DS_MAKH_THEO_MST(maSoThue, hdkh_id, khachhang_id);
      //         if (ds_maKH.Tables[0].Rows.Count == 1)
      //         {
      //             Message_Box.ShowTB("Mã số thuế " + maSoThue + " đang được sử dụng bởi mã khách hàng: " +
      //                             ds_maKH.Tables[0].Rows[0]["ma_kh"].ToString() + ".");
      //             if (ts_kt_mst_kh == 1)
      //                 txtMST_TT2.Focus();
      //             else
      //                 txtMST_TT.Focus();
      //             return false;
      //         }
      //         else if (ds_maKH.Tables[0].Rows.Count > 1)
      //         {
      //             string str = "";
      //             for (int i = 0; i < ds_maKH.Tables[0].Rows.Count; i++)
      //             {
      //                 str = str + ds_maKH.Tables[0].Rows[i]["ma_kh"].ToString() + ",";
      //             }
      //             Message_Box.ShowTB("Mã số thuế " + maSoThue + " đang được sử dụng bởi các mã khách hàng: " +
      //                             str.Substring(0, str.Length - 1) + ".");
      //             if (ts_kt_mst_kh == 1)
      //                 txtMST_TT2.Focus();
      //             else
      //                 txtMST_TT.Focus();
      //             return false;
      //         }
      //     }
      // }
      // if (ts_kt_mst_kh == 1)
      // {
      //     if (vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) //Khách hàng doanh nghiệp
      //     {
      //         //Kiem tra MST thanh toan phai bằng MST KH
      //         if (txtMaSTKH2.Text.Trim() != txtMST_TT2.Text.Trim())
      //         {
      //             Message_Box.ShowTB("MST thanh toán và MST khách hàng phải giống nhau");
      //             return false;
      //         }
      //     }
      // }

      if (this.thamsomacdinh['DOANHNGHIEP_BATBUOC_EMAIL'] == 1 && this.vkieukh_id_ == KIEU_KH.DOANH_NGHIEP) {
        if (!this.thanhtoan.email || this.thanhtoan.email.trim() == '') {
          this.$toast.error('Khách hàng là doanh nghiệp phải nhập Email thanh toán!')
          return false
        }
      }

      // //Kiểm tra số điện thoại thanh toán (HNI)
      // if (DatabaseConstants.DB2 == "CSS_HNI")
      // {
      //     if (txtDienThoaiTT.Text.Trim() == "")
      //     {
      //         Message_Box.ShowTB("Chưa nhập số điện thoại thanh toán");
      //         txtDienThoaiTT.Focus();
      //         return false;
      //     }
      // }
      // if (this.listbox.loaihinh_tb.value == LoaiHinhTB.HDDT_MTT)
      // {
      //     let mst = "";
      //     // let tocdo_id = 0;
      //     for (var index_ = 0; index_ < this.gridEditors.length; ++index_)
      //     {
      //         if (this.gridEditors[index_].ID == "MST" && this.gridEditors[index_].Value != "")
      //         {
      //             mst = this.gridEditors[index_].Value +'';
      //             break;
      //         }
      //     }
      //     let tocdo_id_mtt = 0;
      //     for (var index_ = 0; index_ < this.gridEditors.length; ++index_)
      //     {
      //         if (this.gridEditors[index_].ID == "TOCDO_ID" && this.gridEditors[index_].Value != "")
      //         {
      //             tocdo_id_mtt = this.gridEditors[index_].Value?this.gridEditors[index_].Value*1:0;
      //             break;
      //         }
      //     }
      //     // Gỡ tạm theo yêu cầu của Phạm Cường 2023-03-20 THANGDM1
      //     if (1==2 && mst != "" && tocdo_id_mtt != 0)
      //     {
      //       ///tichhop/hddt/LayThongTinKHHDDT?taxcode=8788708894-001
      //       // HDDTServices _hddt2 = new HDDTServices();
      //         let kq = await API.get_LayThongTinKHHDDT(this.axios,{params:{taxcode:mst}}).then((response) => {
      //             if(response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
      //               if(response.data.data.taxcode && response.data.data.taxcode==mst) return "ok";
      //             }
      //           });//_hddt2.KiemTraTrangThaiHeThong(mst);
      //         if (kq && kq == "ok")
      //         {
      //             if (tocdo_id_mtt != 44113)
      //             {
      //                 this.$toast.error("Khách hàng có mst: " + mst + " đã khởi tạo hệ thống thật trên hệ thống HDDT. Để đăng ký thêm máy tính tiền hãy chọn gói cước \"Khai báo gói khởi tạo trên HDDT MTT (0 Hóa đơn)\"");
      //                 return false;
      //             }
      //         }
      //         else
      //         {
      //             if (tocdo_id_mtt == 44113)
      //             {
      //                 this.$toast.error("Khách hàng có mst: " + mst + " chưa khởi tạo hệ thống thật trên hệ thống HDDT. Để đăng ký thêm máy tính tiền hãy chọn gói cước khác \"Khai báo gói khởi tạo trên HDDT MTT (0 Hóa đơn)\"");
      //                 return false;
      //             }
      //         }
      //     }
      // }
      return true
    },
    tsbtnToaNha_Click() {
      this.popup.popupToaNha = true
      let popup = this.$refs.popupToaNha
      popup.txtMaTB = this.ma_tb ? this.ma_tb : this.ma_tb_ht
      popup.tag = this.khachhang.magd
      popup.Ma_GD = this.khachhang.magd
      this.$nextTick(() => {
        popup.show()
      })
    },
    async LoadGoiCuocADSL() {
      if (
        [DichVuVienThong.ADSL, DichVuVienThong.BRCD_DOITAC, DichVuVienThong.DICHVU_CNTT, DichVuVienThong.TRUNGTAM_DULIEU, DichVuVienThong.HOINGHI_TRUYENHINH, DichVuVienThong.ANTOAN_BAOMAT_TT, DichVuVienThong.HATANG_VIENTHONG, DichVuVienThong.MEGA_EYES].indexOf(this.listbox.dichvu_vt.value * 1) >= 0
      ) {
        let dk = 'sudung = 1'
        // this.cboGoiCuocAdsl.EditValueChanged -= new System.EventHandler(this.cboGoiCuocAdsl_EditValueChanged);
        if (this.listbox.loaihinh_tb.value == LoaiHinhTB.FSECURE) {
          // bangts.HT_Tocdo_Fsecure_GRID(cboGoiCuocAdsl, this.listbox.loaihinh_tb.value, dk);
          this.loading(true)
          try {
            await API.post_sp_ht_tocdo_fsecure(this.axios, { loaitb_id: this.listbox.loaihinh_tb.value }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.listbox.cboGoiCuocAdsl.list = response.data.data
                this.listbox.cboTocDoThucADSL.list = response.data.data
                if (this.listbox.cboGoiCuocAdsl.list && this.listbox.cboGoiCuocAdsl.list.length > 0 && (!this.listbox.cboGoiCuocAdsl.value || !this.listbox.cboGoiCuocAdsl.list.find((x) => x.tocdo_id == this.listbox.cboGoiCuocAdsl.value))) {
                  if (this.listbox.cboGoiCuocAdsl.list.find((x) => x.tocdo_id > 0)) this.listbox.cboGoiCuocAdsl.value = this.listbox.cboGoiCuocAdsl.list.find((x) => x.tocdo_id > 0).tocdo_id
                  else this.listbox.cboGoiCuocAdsl.value = this.listbox.cboGoiCuocAdsl.value ? this.listbox.cboGoiCuocAdsl.value : 0
                  if (this.listbox.cboGoiCuocAdsl.value) await this.cboGoiCuocAdsl_SelectedValueChanged(this.listbox.cboGoiCuocAdsl.value)
                }
              }
            })
          } catch (ex) {
            this.$toast.error('' + ex)
            if (this.debug) console.error(ex)
          } finally {
            this.loading(false)
          }
        } //nhapt sua theo y/c C.Phuong 04012017
        else {
          this.loading(true)
          try {
            await API.post_sp_ht_tocdo_adsl_theo_loaitb(this.axios, { congnghe_id: this.listbox.congnghe.value ? this.listbox.congnghe.value : 0, kieuld_id: this.listbox.kieu_ld.value, loaitb_id: this.listbox.loaihinh_tb.value }).then(async (response) => {
              if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                this.listbox.cboGoiCuocAdsl.list = response.data.data
                this.listbox.cboTocDoThucADSL.list = response.data.data
                if (this.listbox.cboGoiCuocAdsl.list && this.listbox.cboGoiCuocAdsl.list.length > 0 && (!this.listbox.cboGoiCuocAdsl.value || !this.listbox.cboGoiCuocAdsl.list.find((x) => x.tocdo_id == this.listbox.cboGoiCuocAdsl.value))) {
                  if (this.listbox.cboGoiCuocAdsl.list.find((x) => x.tocdo_id > 0)) this.listbox.cboGoiCuocAdsl.value = this.listbox.cboGoiCuocAdsl.list.find((x) => x.tocdo_id > 0).tocdo_id
                  else this.listbox.cboGoiCuocAdsl.value = this.listbox.cboGoiCuocAdsl.value ? this.listbox.cboGoiCuocAdsl.value : 0
                  if (this.listbox.cboGoiCuocAdsl.value) await this.cboGoiCuocAdsl_SelectedValueChanged(this.listbox.cboGoiCuocAdsl.value)
                }
                // this.listbox.cboGoiCuocAdsl.values = [this.listbox.cboGoiCuocAdsl.value];
              }
            })
          } catch (ex) {
            this.$toast.error('' + ex)
            if (this.debug) console.error(ex)
          } finally {
            this.loading(false)
          }
        }
        // this.cboGoiCuocAdsl.EditValueChanged += new System.EventHandler(this.cboGoiCuocAdsl_EditValueChanged);
        // cboGoiCuocAdsl_SelectedValueChanged(cboGoiCuocAdsl, null);
      }
    },
    async cboTraTruoc_SelectedValueChanged() {
      if (this.m_dsTienCTKM) this.m_dsTienCTKM = this.m_dsTienCTKM.filter((x) => x.kieu != 1)
      this.dsDC_HDTB = []
      this.kmld.dtienkmdc = 0
      this.kmld.dvatkmdc = 0
      this.kmld.tyle_kmld_tt = 0
      this.kmld.dtiendatcoc_tt = 0
      this.kmld.dvatdatcoc_tt = 0
      await this.HT_ThietBi()
      await this.HT_DichVuGT()
      await this.HienThiTienKhuyenMaiLapDat() //dtienkmld, dvatkmld, dtiendatcoc_km, dtienkmdc, dvatkmdc, dtiendatcoc_tt);
      await this.LayTongTien_HDTB()
    },
    async cboKhuyenMai_SelectedValueChanged() {
      this.dsKM_HDTB = []
      this.kmld.dtienkmld = 0
      this.kmld.dvatkmld = 0
      this.kmld.tyle_kmld = 0
      this.kmld.dtiendatcoc_km
      this.kmld.tong_kmld = 0
      this.kmld.tien_datcoc = 0
      await this.HT_ThietBi()
      await this.HT_DichVuGT()
      await this.HienThiTienKhuyenMaiLapDat()
      await this.LayTongTien_HDTB()
    },
    async LAY_DS_TBI_MACDINH() {
      //TODO chua lam
      // let ds = tchopdong.LAY_DS_TBI_MACDINH(loaitb_id);
      // this.dsCTM_TBI = [];
      // for (var i = 0; i < ds.length; i++)
      // {
      //     let row = {};
      //     row.LOAITBI_ID = Convert.ToInt32(ds.Tables[0].Rows[i]["LOAITBI_ID"]);
      //     row.HDTB_ID = hdtb_id;
      //     row.SOLUONG = 1;
      //     //Hiếu bổ sung thêm tiền, vat, tien_km, vat_km ngày  17/09/2010
      //     row.TIEN = Convert.ToDecimal(ds.Tables[0].Rows[i]["tien"]);
      //     row.VAT = Convert.ToDecimal(ds.Tables[0].Rows[i]["vat"]);
      //     row.TIEN_KM = Convert.ToDecimal(ds.Tables[0].Rows[i]["tien_km"]);
      //     row.VAT_KM = Convert.ToDecimal(ds.Tables[0].Rows[i]["vat_km"]);
      //     row.TIEN_THUE = 0;
      //     row.TONG_THUE = 0;
      //     row.TONG_TIEN = 0;
      //     //
      //     this.dsCTM_TBI.push(row);
      // }
      this.HT_ThietBi()
    },
    async tsbtnThanhToan_Click() {
      try {
        // try
        // {
        //     string check_before = tdan.GET_VALUE_FUNC("{?DB2}.KIEMTRA_TRUOCTHANHTOAN_DATMOI", "vhdtb_id", hdtb_id).ToString();
        //     if (check_before != "ok")
        //     {
        //         Message_Box.ShowError(check_before);
        //         return;
        //     }
        // }
        // catch { }

        // #region Hoan nv Kiểm tra các gói cộng thêm khi đăng ký dịch vụ Elearning
        // if (Convert.ToInt32(cboLoaihinhTB.SelectedValue.ToString()) == 208)
        // {
        //     //Kiểm tra xem các thuê bao cũ đang quản lý đã thanh lý chưa
        //     string kq_thanhly = tdan.GET_VALUE_FUNC("{?DB2}.FN_KIEMTRA_THUEBAO_CHAMDUTSUDUNG_ELEARNING", "hdtb_id", hdtb_id).ToString();
        //     if (kq_thanhly != "OK")
        //     {
        //         Message_Box.ShowTB(kq_thanhly.ToString());
        //         return;
        //     }
        //     //Kiểm tra xem họ nhập đứng số lượng của dịch vụ cộng thêm chưa
        //     let kq = tdan.GET_VALUE_FUNC("{?DB2}.FN_KIEMTRA_MUATHEM_DVGT_THAYDOIDV_ELEARNING", "vhdtb_id", hdtb_id);
        //     if (kq.ToString().Trim() != "OK")
        //     {
        //         Message_Box.ShowTB(kq.ToString());
        //         return;
        //     }
        //     // Kiểm tra xem khách các gói Doang nghiệp đại học thì phải mua dịch vụ cộng thêm
        //     let kq_kiemtra_mua_dvct = tdan.GET_VALUE_FUNC("{?DB2}.FN_KIEMTRA_BATBUOC_MUA_DVCONGTHEM_ELEARNING", "vhdtb_id", hdtb_id);
        //     if (kq_kiemtra_mua_dvct == "NOK")
        //     {
        //         Message_Box.Show("Phân loại Elearning Doanh nghiệp, Elearning Bản đại học bắt buộc phải mua dịch vụ cộng thêm (Mua user)");
        //         return;
        //     }
        // }
        // #endregion

        if (!this.khachhang.hdkh_id || this.khachhang.hdkh_id <= 0) {
          this.$toast.error('Hãy ghi lại hợp đồng trước khi thanh toán!')
          return
        }
        let kq = await API.post_fn_kiemtra_truoc_thanhtoan(this.axios, { ds_para: JSON.stringify({ HDKH_ID: this.khachhang.hdkh_id, TS_HEN_LD: this.thamsomacdinh['TS_HEN_LD'] == 1 ? 1 : 0 }) })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              let dulieuapi = JSON.parse(response.data.data)
              if (dulieuapi['ERROR_CODE'] == 1) return true
              this.$toast.error(dulieuapi['MESSAGE'])
              return false
            } else return false
          })
          .catch(() => {
            return false
          })
        //THEM phan tu van ngay 20230619
        try {
          if (kq) {
            var tuvan = await API.get_kiemtra_tuvan_mytv(this.axios, { params: { hdkh_id: this.khachhang.hdkh_id, loai: 1 } })
              .then((response) => {
                if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') return response.data.data == 1
                else return false
              })
              .catch(() => {
                return false
              })
            if (tuvan) {
              if (
                (await this.$confirm('Khách hàng chưa sử dụng MyTV / WiFi Mesh / Camera, đề nghị Anh/Chị tư vấn mời khách hàng sử dụng dịch vụ MyTV / WiFi Mesh / Camera', 'Thông báo', {
                  confirmButtonText: 'Có',
                  cancelButtonText: 'Không'
                }).then(async () => {
                  this.frmTuVanMyTVCom = frmTuVanMyTV
                  await this.frmTuVanMyTVCom().then((x) => {})

                  this.$nextTick(() => {
                    let data = {
                      khachhang_id: this.khachhang.khachhang_id,
                      loai: 1
                    }

                    this.$refs.dialogfrmTuVanMyTV.openDialog(data)
                  })
                  return 'Yes'
                })) != 'Yes'
              )
                this.ChuyenTrang('Payment', { magd: this.khachhang.magd + '' })
            } else {
              this.ChuyenTrang('Payment', { magd: this.khachhang.magd + '' })
            }
          }
        } catch (ex) {
          this.$toast.error('Có lỗi khi xử lý tư vấn! Tiếp tục quy trình thanh toán')
          if (this.debug) console.error(ex)
          this.ChuyenTrang('Payment', { magd: this.khachhang.magd + '' })
        }
        //HET phan tu van
        // if (!KiemtraDiDong_GioiTinh())
        // { // vuth update fix 1209
        //     Message_Box.Show("Với thuê bao di động, bạn phải chọn giới tính khách hàng là Nam hoặc Nữ !!!");
        //     return;
        // }
        // if (new ThanhToanHDFacade().KIEMTRA_THANHTOAN_DATMOI_LH(hdkh_id) == "0")
        // {
        //     Message_Box.ShowWarning("Hợp đồng chưa có thông tin liên hệ, bạn phải bổ sung thông tin liên hệ trước khi thanh toán !");
        //     return;
        // }
        // if (ts_hen_ld == 1)
        // {
        //     bool kt_henld = true;
        //     //kt_henld = bangts.KIEMTRA_HEN_HDKH(hdkh_id);
        //     kt_henld = new TCHopDongFacade2().kiemtra_hen_ld(hdkh_id);
        //     if (kt_henld == false)
        //     {
        //         Message_Box.ShowWarning("Tồn tại hợp đồng thuê bao chưa hẹn lắp đặt. Bạn phải hẹn lắp đặt trước khi thanh toán !");
        //         return;
        //     }
        // }
        // //Kiểm tra thanh toán CNTT: Sms Brand Name, 1800, 1900
        // bool kt_sms_brand = new TCHopDongFacade2().kiemtra_dinhmuc_sms(hdkh_id);
        // if (kt_sms_brand == false)
        // {
        //     Message_Box.ShowWarning("Tồn tại hợp đồng thuê bao CNTT/GTGT chưa nhập thông tin SUB.\n Bạn hãy kiểm tra lại trước khi thanh toán !");
        //     return;
        // }

        // DataSet ds = thamso_md.LAY_DS_THAMSO_MD_MATS("KIEMTRA_GOI");
        // if (ds.Tables[0].Rows.Count > 0)
        // {
        //     if (ds.Tables[0].Rows[0]["ten_ts"].ToString().Trim() == "1")
        //     {
        //         DataTable _dtDK_Goi = bangts.GetDataSql("select " + DatabaseConstants.DB2 + ".KiemTra_DK_GOIDADV_V2(" + hdkh_id.ToString() + ")  from dual");
        //         if (_dtDK_Goi.Rows[0][0].ToString() != "1")
        //         {
        //             Message_Box.ShowTB(_dtDK_Goi.Rows[0][0].ToString());
        //             return;
        //         }
        //     }
        // }
        // if (kq) this.ChuyenTrang('Payment', { magd: this.khachhang.magd + '' })
        // if (form_thanhtoan_v2)
        // {
        //     frmThanhToanHD_V2 f1 = new frmThanhToanHD_V2(txtMaGD.Text);
        //     f1.MdiParent = this.MdiParent;
        //     f1.Show();
        //     f1.HienThiTTHopDongKH();
        // }
        // else
        // {
        //     frmThanhToanHD f = new frmThanhToanHD(txtMaGD.Text);
        //     f.MdiParent = this.MdiParent;
        //     f.Show();
        //     f.HienThiTTHopDongKH();
        // }
      } catch (ex) {
        this.$toast.error('' + ex.ToString())
      }
    },

    tsbtnThanhToanHT_Click() {
      // Tiep tuc toi trang thanh toan sau khi tu van xong.
      if (this.frmTuVanMyTVCom && this.$refs.dialogfrmTuVanMyTV) this.$refs.dialogfrmTuVanMyTV.hideDialog()
      this.ChuyenTrang('Payment', { magd: this.khachhang.magd + '' })
    },

    async btnThongTinTBSub_Click() {
      if (!this.listbox.loaihinh_tb.value || this.listbox.loaihinh_tb.value == 0) {
        this.$toast.warning('Bạn chưa chọn loại hình TB')
        return
      }
      // if(this.listbox.loaihinh_tb.value==LoaiHinhTB.CA || this.listbox.loaihinh_tb.value==LoaiHinhTB.SMART_CA) {
      //   this.popupComponent = ()=>import('./Popups/popupInforAdd');
      //   this.popupComponentName = "popupInforAdd";
      //   this.popupComponentData = {_hdkh_id:this.khachhang.hdkh_id,_nhapmoi:this.buttonSet==1,_vma_kh:this.khachhang.makh,_vkieukh_id:this.vkieukh_id_,_ts_kt_tthdkhdn:this.ts_kt_tthdkhdn, loaikh:this.listbox.loai_kh.value}
      //   this.Popup('popupComponents');
      // }
      // else
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IVAN) {
        //frmHDTB_SUB_V3_Load
        let dt_load = await API.post_lay_tt_thuebao_bosung(this.axios, { vhdtb_id: this.hdtb_id })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          .catch(() => {
            return []
          })
        if (dt_load && dt_load.length > 0) {
          dt_load = this.UpperCasePropertyList(dt_load)
          this.khachhang.txtNguoiKyHoSo = dt_load[0]['NGUOI_KY_HOSO']
          this.khachhang.txtChucDanh = dt_load[0]['CHUCDANH']
        } else {
          this.khachhang.txtNguoiKyHoSo = ''
          this.khachhang.txtChucDanh = ''
        }

        if (this.dsHDTB_SUB && this.dsHDTB_SUB.length > 0) {
          if (this.dsHDTB_SUB[0]['NGUOI_KY_HOSO']) this.khachhang.txtNguoiKyHoSo = this.dsHDTB_SUB[0]['NGUOI_KY_HOSO']
          if (this.dsHDTB_SUB[0]['CHUCDANH']) this.khachhang.txtChucDanh = this.dsHDTB_SUB[0]['CHUCDANH']
        }
        this.popup.frmHDTB_SUB_V3 = true
        this.Popup('frmHDTB_SUB_V3')
        // frmHDTB_SUB_V3 frm = new frmHDTB_SUB_V3((int)hdtb_id, Convert.ToInt32(cboLoaihinhTB.SelectedValue),
        //     Convert.ToInt32(cboKieuLD.SelectedValue), this.dsHDTB_SUB, false, false);
        // frm.ShowDialog();
        // dsHDTB_SUB = frm.ds_hdtb_sub;
        // THANGDM1 Doan nay tu lap moi goi vao isReadonly luôn false -> khong code gi them!
        // if (!isReadonly)
        //   {
        //       txtNguoiDaiDien.Enabled = true;
        //       txtChucDanh.Enabled = true;
        //   }
        //   else
        //   {
        //       string khoaform = tdan.GET_VALUE_FUNC("{?DB2}.IVAN_KHOA_FORM_THONGTIN_BOSUNG", "vkieuld_id", _kieuld_id).ToString();
        //       foreach (string item in khoaform.Split(','))
        //       {
        //           try
        //           {
        //               ((BaseEdit)this.layoutControl3.Controls[item]).Properties.ReadOnly = true;
        //           }
        //           catch { }
        //       }
        //   }
      } else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.Voice_Brandname) {
        //frmHDTB_SUB_V4_Load
        let dt_load = await API.post_lay_tt_thuebao_bosung(this.axios, { vhdtb_id: this.hdtb_id })
          .then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          .catch(() => {
            return []
          })
        if (dt_load && dt_load.length > 0) {
          dt_load = this.UpperCasePropertyList(dt_load)
          this.khachhang.txtNguoiKyHoSo = dt_load[0]['NGUOI_KY_HOSO']
          this.khachhang.dtpNgaySinh = dt_load[0]['NGAYSINH']
          this.khachhang.cboGioiTinh = dt_load[0]['GIOITINH']
          this.khachhang.txtSoGT = dt_load[0]['SO_GT']
          this.khachhang.dtpNgayCap = dt_load[0]['NGAYCAP']
          this.khachhang.txtSoGT = dt_load[0]['SO_GT']
          this.khachhang.txtNoiCap = dt_load[0]['NOICAP']
          this.khachhang.txtEmail = dt_load[0]['EMAIL']
          this.khachhang.txtSoDT = dt_load[0]['SO_DT']
        } else {
          this.khachhang.txtNguoiKyHoSo = ''
          this.khachhang.dtpNgaySinh = null
          this.khachhang.cboGioiTinh = ''
          this.khachhang.txtSoGT = ''
          this.khachhang.dtpNgayCap = null
          this.khachhang.txtSoGT = ''
          this.khachhang.txtNoiCap = ''
          this.khachhang.txtEmail = ''
          this.khachhang.txtSoDT = ''
        }

        if (this.dsHDTB_SUB && this.dsHDTB_SUB.length > 0) {
          if (this.dsHDTB_SUB[0]['NGUOI_KY_HOSO']) this.khachhang.txtNguoiKyHoSo = this.dsHDTB_SUB[0]['NGUOI_KY_HOSO']
          if (this.dsHDTB_SUB[0]['NGAYSINH']) this.khachhang.dtpNgaySinh = this.dsHDTB_SUB[0]['NGAYSINH']
          if (this.dsHDTB_SUB[0]['GIOITINH']) this.khachhang.cboGioiTinh = this.dsHDTB_SUB[0]['GIOITINH']
          if (this.dsHDTB_SUB[0]['SO_GT']) this.khachhang.txtSoGT = this.dsHDTB_SUB[0]['SO_GT']
          if (this.dsHDTB_SUB[0]['NGAYCAP']) this.khachhang.dtpNgayCap = this.dsHDTB_SUB[0]['NGAYCAP']
          if (this.dsHDTB_SUB[0]['SO_GT']) this.khachhang.txtSoGT = this.dsHDTB_SUB[0]['SO_GT']
          if (this.dsHDTB_SUB[0]['NOICAP']) this.khachhang.txtNoiCap = this.dsHDTB_SUB[0]['NOICAP']
          if (this.dsHDTB_SUB[0]['EMAIL']) this.khachhang.txtEmail = this.dsHDTB_SUB[0]['EMAIL']
          if (this.dsHDTB_SUB[0]['SO_DT']) this.khachhang.txtSoDT = this.dsHDTB_SUB[0]['SO_DT']
        }
        this.popup.frmHDTB_SUB_V4 = true
        this.Popup('frmHDTB_SUB_V4')
        // frmHDTB_SUB_V4 frm = new frmHDTB_SUB_V4((int)hdtb_id, Convert.ToInt32(cboLoaihinhTB.SelectedValue),
        //     Convert.ToInt32(cboKieuLD.SelectedValue), this.dsHDTB_SUB, false, false);
        // frm.ShowDialog();
        // dsHDTB_SUB = frm.ds_hdtb_sub;
      }
      else if (this.listbox.loaihinh_tb.value == LoaiHinhTB.VNPT_COLOCATION)
      {
          if (!this.hdtb_id || this.listbox.kieu_ld.value != 13279) // cai tao ha tang IDC
          {
              this.$toast.error("Bạn cần ghi lại hợp đồng trước khi chọn các thuê bao cải tạo hạ tầng");
              return;
          }

          this.popupComponent = ()=>import('./Popups/popupDangKyCaiTaoHaTangIDC');
          this.popupComponentName = "popupDangKyCaiTaoHaTangIDC";
          this.popupComponentData = {hdtb_id:this.hdtb_id}
          this.Popup('popupComponents');
          // frmDangKyCaiTaoHaTangIDC f = new frmDangKyCaiTaoHaTangIDC();
          // f.hdtb_id = hdtb_id;
          // f.ShowDialog();
      }
      else {
        this.popup.dialogHDTB_SUB_V2 = true
        if (this.$refs.dialogHDTB_SUB_V2._data.state.hdtb_sub && this.$refs.dialogHDTB_SUB_V2._data.state.hdtb_sub.SO_GT && (!this.dsHDTB_SUB || this.dsHDTB_SUB.length <= 0)) {
          this.dsHDTB_SUB = [this.$refs.dialogHDTB_SUB_V2._data.state.hdtb_sub]
        }
        if (!this.hdtb_id || this.hdtb_id <= 0 || this.buttonSet == 1) {
          this.$refs.dialogHDTB_SUB_V2.openDialog({ type: 2, hdtb_sub: this.dsHDTB_SUB && this.dsHDTB_SUB.length > 0 ? this.dsHDTB_SUB[0] : {}, kieuld_id: this.listbox.kieu_ld.value, loaitb_id: this.listbox.loaihinh_tb.value, isReadonly: false }) // truyen 2 moi binding duoc du lieu????
          this.$refs.dialogHDTB_SUB_V2._data.state.isRAUpdate = this.dsHDTB_SUB && this.dsHDTB_SUB.length > 0 && this.dsHDTB_SUB[0]['HDTB_ID'] && this.dsHDTB_SUB[0]['HDTB_ID'] != 0 && this.buttonSet != 1 // false;
          this.$refs.dialogHDTB_SUB_V2._data.state.isUpdated = false
        } else {
          this.$refs.dialogHDTB_SUB_V2.openDialog({ type: 3, hdtb_id: this.hdtb_id, isReadonly: false })
          this.$refs.dialogHDTB_SUB_V2._data.state.isUpdated = false
          this.$refs.dialogHDTB_SUB_V2._data.state.hdtb_sub = this.dsHDTB_SUB[0]
        }
      }
      // console.log(this.$refs.dialogHDTB_SUB_V2);
      // else if (Convert.ToInt32(cboLoaihinhTB.SelectedValue) == LoaiHinhTB.VNPT_SLL)
      // {
      //     if (hdtb_id == 0) // cai tao ha tang IDC
      //     {
      //         Message_Box.Show("Bạn cần ghi lại hợp đồng trước giới hạn SMS");
      //         return;
      //     }
      //     frmGioiHanSMS_SLL f = new frmGioiHanSMS_SLL();
      //     f.hdtb_id = hdtb_id;
      //     f.ShowDialog();
      // }
      // else
      // {
      //     if (hdtb_id == 0 || Convert.ToInt32(cboKieuLD.SelectedValue.ToString()) != 13279) // cai tao ha tang IDC
      //     {
      //         Message_Box.Show("Bạn cần ghi lại hợp đồng trước khi chọn các thuê bao cải tạo hạ tầng");
      //         return;
      //     }
      //     frmDangKyCaiTaoHaTangIDC f = new frmDangKyCaiTaoHaTangIDC();
      //     f.hdtb_id = hdtb_id;
      //     f.ShowDialog();
      // }
      // if (this.listbox.loaihinh_tb.value == LoaiHinhTB.IVAN)
      // {
      //     let data = {
      //       hdtb_id: this.hdtb_id,
      //       loaitb_id: this.listbox.loahinh_tb.value,
      //       kieuld_id: this.listbox.kieu_ld.value,
      //       readOnly: false,
      //       isUpdate: true,
      //       ds_hdtb_sub: []
      //     }
      //     this.$refs.dialogHDTB_SUB_V3.openDialog(data);
      //     return;
      // }
      // else
      // {
      //   this.$refs.dialogHDTB_SUB_V2.openDialog({type: 3, hdtb_id: this.state.hdtb_id, isReadonly: false});
      //     // if (await this.PHAILAM(this.state.luong_id, "RA_GUIYC"))
      //     // {
      //     //     this.$refs.dialogHDTB_SUB_V2.openDialog({type: 3, hdtb_id: this.state.hdtb_id, isReadonly: false});
      //     // }
      //     // else
      //     // {
      //     //     this.$refs.dialogHDTB_SUB_V2.openDialog({type: 3, hdtb_id: this.state.hdtb_id, isReadonly: true});
      //     // }
      // }
    },
    // async PHAILAM(luong_id, code) {
    //   if(!this.state.luong_thaotac) {
    //     await CompleteProfileAPI.lay_luong_thaotac(this.axios, {luong_id: luong_id,}).then((res) => {
    //         this.state.luong_thaotac = res.data.data;
    //     });
    //   }

    //   if(!this.state.luong_thaotac){
    //     this.state.luong_thaotac = [];
    //     console.warn("PHAILAM luong_thaotac is empty!");
    //   }

    //   return this.state.luong_thaotac.findIndex(
    //       (item) => item.enable == 1 && item.code == code
    //     ) >= 0;
    // },

    //show modal import CA
    tsbtnImportCA_Click() {
      this.popup.modalImportCA = true
      this.$refs.modalImportCA.showModal()
      // this.$refs['modalImportCA'].show()
    },
    btnUser_Click() {
      if (!this.khachhang.hdkh_id) {
        this.$toast.error('Chưa có thông tin khách hàng!')
        return
      }
      this.popup.ThongTinUser = true
      this.$refs['ThongTinUser'].showModal = true
    },

    ThuebaoToaNha_OnClick() {
      this.popup.Thuebao_ToaNha = true
      this.isShowThueBaoToaNha = true
      this.$refs.Thuebao_ToaNha.show()
    },
    async XemTruocThongTinCAToken_Click() {
      let msg = this.XemTruocThongTinCAToken()
      if (msg && msg.length > 0) alert(msg)
    },
    async XemTruocThongTinCAToken() {
      try {
        let vloaitb_id = this.listbox.loaihinh_tb.value * 1
        if (vloaitb_id != LoaiHinhTB.CA && vloaitb_id != LoaiHinhTB.IVAN && vloaitb_id != LoaiHinhTB.SMART_CA) {
          this.$toast.error('Chức năng chỉ giành cho thuê bao CA/SmartCA và IVAN')
          return ''
        }
        if (this.hdtb_id == 0) {
          this.$toast.error('Chưa có thuê bao nào được chọn')
          return ''
        }
        if (vloaitb_id == LoaiHinhTB.CA || vloaitb_id == LoaiHinhTB.SMART_CA) {
          // frmCustomMSGBox fc = new frmCustomMSGBox(0, 1, "Xem kết quả CMS", "Cập nhật số giấy tờ", "Bạn có muốn kiểm tra số giấy tờ?", "Bạn có muốn kiểm tra số giấy tờ?");
          // fc.ShowDialog();
          // if (fc.kq == 1)
          // {
          //     frmKiemTraSoGiayToCA f = new frmKiemTraSoGiayToCA(); //src/modules/contract/complete_profile/CompleteProfileITVAS/popups/popupKiemTraSoGiayToCA/KiemTraSoGiayToCA.vue
          //     f.ma_gd = txtMaGD.Text;
          //     f.ShowDialog();
          // }
          let dt_lgt = await API.get_lay_dulieu_tao_thucthe_ca(this.axios, { params: { hdtb_id: this.hdtb_id } }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          if (!dt_lgt || dt_lgt.length <= 0) {
            this.$toast.error('Không có thông tin thuê bao để hiển thị')
            return ''
          }
          var item = this.UpperCasePropertyList(dt_lgt)[0]
          let thongke_giayto = await API.get_kiemtra_giayto_ca_smartca(this.axios, { params: { vhdkh_id: this.khachhang.hdkh_id } }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return ''
          })
          if (!thongke_giayto) thongke_giayto = ''
          if (this.vkieukh_id_ == 1)
            return ```
                    Tên chủ thể: ${item['TEN_TB']}
                    UID định danh: ${item['MA_GT_CA']}:${item['SO_GT']}
                    Email liên hệ: ${item['EMAIL']}
                    Giấy tờ đăng ký: ${item['SO_GT']}
                    Đơn vị: ${this.khachhang.tenkh}
                    Chức danh: ${item['CHUCDANH']}
                    Địa chỉ: ${item['DIACHI_TB']}
                    Số tháng sử dụng: ${item['SO_THANG']}
                    Mục đích: ${item['MUCDICHS']}
                    Subject_dn: ${item['SUBJECT_DN']}
                    Giấy tờ: ${thongke_giayto}
                  ```
          else
            return ```
                    Tên chủ thể: ${item['TEN_TB']}
                    UID định danh: ${item['MA_GT_CA']}:${item['SO_GT']}
                    Email liên hệ: ${item['EMAIL']}
                    Giấy tờ đăng ký: ${item['SO_GT']}
                    Địa chỉ: ${item['DIACHI_TB']}
                    Số tháng sử dụng: ${item['SO_THANG']}
                    Mục đích: ${item['MUCDICHS']}
                    Subject_dn: ${item['SUBJECT_DN']}
                    Giấy tờ: ${thongke_giayto}
                  ```
        } else {
          let dt = await API.post_lay_dulieu_cho_api(this.axios, { vhdtb_id: this.hdtb_id }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return []
          })
          if (!dt || dt.length <= 0) {
            this.$toast.error('Không đủ dữ liệu. Hãy kiểm tra lại Thông tin thuê bao.')
            return ''
            //return "Không đủ dữ liệu. Hãy kiểm tra lại Thông tin thuê bao.";
          }
          var item = this.LowerCasePropertyList(dt)[0]
          //     string ma_huyen = objCheckData.GET_DATA_SQL("select ten_capdo from {?DB2}.capdo_dv where map_id_2 = '" + dt.Rows[0]["ma_huyen"].ToString() + "'").Rows[0][0].ToString();
          let ma_huyen = await API.post_thongtin_tratruoc_dn(this.axios, 'FN_TT_CAPDO_DV'.toLowerCase(), { type: 1, param: item['ma_huyen'] }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return ''
          })
          if (!ma_huyen) ma_huyen = ''

          let ma_khoi_don_vi = await API.post_thongtin_tratruoc_dn(this.axios, 'FN_TT_LOAI_CTS'.toLowerCase(), { type: 1, param: item['ma_khoi_don_vi'] }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return ''
          })
          if (!ma_khoi_don_vi) ma_khoi_don_vi = ''

          let ma_loai_goi_dich_vu = await API.post_thongtin_tratruoc_dn(this.axios, 'FN_TT_PHANLOAI_DV'.toLowerCase(), { type: 1, param: item['ma_loai_goi_dich_vu'] }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return ''
          })
          if (!ma_loai_goi_dich_vu) ma_loai_goi_dich_vu = ''

          let ma_goi_dich_vu = await API.post_thongtin_tratruoc_dn(this.axios, 'FN_TT_TOCDO_ADSL'.toLowerCase(), { type: 9, param: item['ma_goi_dich_vu'] }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return ''
          })
          if (!ma_goi_dich_vu) ma_goi_dich_vu = ''

          let ma_loai_hinh_kinh_doanh = await API.post_thongtin_tratruoc_dn(this.axios, 'fn_tt_nganhnghe'.toLowerCase(), { type: 2, param: item['ma_loai_hinh_kinh_doanh'] }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return ''
          })
          if (!ma_loai_hinh_kinh_doanh) ma_loai_hinh_kinh_doanh = ''
          //     string ma_khoi_don_vi = objCheckData.GET_DATA_SQL("select loai_cts from {?DB2}.loai_cts where map_id = '" + dt.Rows[0]["ma_khoi_don_vi"].ToString() + "'").Rows[0][0].ToString();
          //     string ma_loai_hinh_kinh_doanh = objCheckData.GET_DATA_SQL("select(select tennganhnghe from {?DB2}.nganhnghe where nganhnghe_id = {?DB2}.fn_map_nganhnghe_bhxh('" + dt.Rows[0]["ma_loai_hinh_kinh_doanh"].ToString() + "', 0)) from dual").Rows[0][0].ToString();
          //     string ma_loai_goi_dich_vu = objCheckData.GET_DATA_SQL("select phanloai from {?DB2}.phanloai_dv where map_id = '" + dt.Rows[0]["ma_loai_goi_dich_vu"].ToString() + "'").Rows[0][0].ToString();
          //     string ma_goi_dich_vu = objCheckData.GET_DATA_SQL("select thuonghieu from {?DB2}.tocdo_adsl where ma_td = '" + dt.Rows[0]["ma_goi_dich_vu"].ToString() + "'").Rows[0][0].ToString();
          //string ten_dang_nhap_am_backend = frmDangNhapIVAN.TenDangNhapIVAN;
          return ```
                AM đăng ký : ${item['dhsxkd_am_ho_ten']}
                Mã khách hàng : ${item['dhsxkd_ma_khach_hang']}
                Mã thuê bao : ${item['dhsxkd_ma_thue_bao']}
                Tên khách hàng : ${item['ten_khach_hang']}
                Mã số thuế : ${item['ma_don_vi']}
                Mã BHXH/Mã đơn vị : ${item['dia_chi']}
                Địa chỉ : ${item['dia_chi']}
                Mã tỉnh : ${item['dhsxkd_ma_tinh']}
                Quận/huyện : ${ma_huyen}
                Số di động : ${item['sdt_di_dong']}
                Số cố định : ${item['sdt_co_dinh']}
                Họ tên người ký tờ khai : ${item['ho_ten_nguoi_ky_to_khai']}
                Chức danh người ký tờ khai : ${item['chuc_danh_nguoi_ky_to_khai']}
                Khối đơn vị : ${ma_khoi_don_vi}
                Loại hình kinh doanh : ${ma_loai_hinh_kinh_doanh}
                Loại gói : ${ma_loai_goi_dich_vu}
                Gói cước : ${ma_goi_dich_vu}
                Ngày bắt đầu sử dụng : ${item['ngay_bat_dau_su_dung']}
                Ngày kêt thúc sử dụng : ${item['ngay_ket_thuc_su_dung']}
                Số tháng khuyến mại : ${item['so_thang_khuyen_mai']}
                Ngày ký hợp đồng : ${item['ngay_ky_hop_dong']}
                Người ký hợp đồng : ${item['nguoi_ky_hop_dong']}
                Số hợp đồng : ${item['so_hop_dong']}
                Tên đăng nhập tài khoản cha : ${item['ten_dang_nhap_tai_khoan_cha']}
                Tên đăng nhập AM (hệ thống BHXH) : ${item['ten_dang_nhap_am_backend']}
              ```
          //     DataTable dt = objCheckData.GET_DATA_PROC("{?DB2}.lay_dulieu_cho_api", "vhdtb_id", hdtb_id);
          //     if (dt.Rows.Count <= 0)
          //     {
          //         Message_Box.ShowError("Không đủ dữ liệu. Hãy kiểm tra lại Thông tin thuê bao.");
          //         return "Không đủ dữ liệu. Hãy kiểm tra lại Thông tin thuê bao.";
          //     }
          //     string dhsxkd_ma_khach_hang = dt.Rows[0]["dhsxkd_ma_khach_hang"].ToString();
          //     string dhsxkd_ma_thue_bao = dt.Rows[0]["dhsxkd_ma_thue_bao"].ToString();
          //     string dhsxkd_ma_tinh = dt.Rows[0]["dhsxkd_ma_tinh"].ToString();
          //     string dhsxkd_am_ma = dt.Rows[0]["dhsxkd_am_ma"].ToString();
          //     string ten_am = dt.Rows[0]["dhsxkd_am_ho_ten"].ToString() + " - " + dt.Rows[0]["dhsxkd_am_sdt"].ToString() + " - " + dt.Rows[0]["dhsxkd_am_phong_ban"].ToString();
          //     string ten_khach_hang = dt.Rows[0]["ten_khach_hang"].ToString();
          //     string ma_so_thue = dt.Rows[0]["ma_so_thue"].ToString();
          //     string ma_don_vi = dt.Rows[0]["ma_don_vi"].ToString();
          //     string email = dt.Rows[0]["email"].ToString();
          //     string dia_chi = dt.Rows[0]["dia_chi"].ToString();
          //     string ma_tinh = dt.Rows[0]["ma_tinh"].ToString();
          //     string ma_huyen = objCheckData.GET_DATA_SQL("select ten_capdo from {?DB2}.capdo_dv where map_id_2 = '" + dt.Rows[0]["ma_huyen"].ToString() + "'").Rows[0][0].ToString();
          //     string sdt_di_dong = dt.Rows[0]["sdt_di_dong"].ToString();
          //     string sdt_co_dinh = dt.Rows[0]["sdt_co_dinh"].ToString();
          //     string ho_ten_nguoi_ky_to_khai = dt.Rows[0]["ho_ten_nguoi_ky_to_khai"].ToString();
          //     string chuc_danh_nguoi_ky_to_khai = dt.Rows[0]["chuc_danh_nguoi_ky_to_khai"].ToString();
          //     string ma_khoi_don_vi = objCheckData.GET_DATA_SQL("select loai_cts from {?DB2}.loai_cts where map_id = '" + dt.Rows[0]["ma_khoi_don_vi"].ToString() + "'").Rows[0][0].ToString();
          //     string ma_loai_hinh_kinh_doanh = objCheckData.GET_DATA_SQL("select(select tennganhnghe from {?DB2}.nganhnghe where nganhnghe_id = {?DB2}.fn_map_nganhnghe_bhxh('" + dt.Rows[0]["ma_loai_hinh_kinh_doanh"].ToString() + "', 0)) from dual").Rows[0][0].ToString();
          //     string ma_loai_goi_dich_vu = objCheckData.GET_DATA_SQL("select phanloai from {?DB2}.phanloai_dv where map_id = '" + dt.Rows[0]["ma_loai_goi_dich_vu"].ToString() + "'").Rows[0][0].ToString();
          //     string ma_goi_dich_vu = objCheckData.GET_DATA_SQL("select thuonghieu from {?DB2}.tocdo_adsl where ma_td = '" + dt.Rows[0]["ma_goi_dich_vu"].ToString() + "'").Rows[0][0].ToString();
          //     string ngay_bat_dau_su_dung = dt.Rows[0]["ngay_bat_dau_su_dung"].ToString();
          //     string ngay_ket_thuc_su_dung = dt.Rows[0]["ngay_ket_thuc_su_dung"].ToString();
          //     string so_thang_khuyen_mai = dt.Rows[0]["so_thang_khuyen_mai"].ToString();
          //     string ngay_ky_hop_dong = dt.Rows[0]["ngay_ky_hop_dong"].ToString();
          //     string nguoi_ky_hop_dong = dt.Rows[0]["nguoi_ky_hop_dong"].ToString();
          //     string so_hop_dong = dt.Rows[0]["so_hop_dong"].ToString();
          //     string ten_dang_nhap_tai_khoan_cha = dt.Rows[0]["ten_dang_nhap_tai_khoan_cha"].ToString();
          //     //string ten_dang_nhap_am_backend = dt.Rows[0]["ten_dang_nhap_am_backend"].ToString();

          //     return string.Format(@"
          //         AM đăng ký : {0}
          //         Mã khách hàng : {1}
          //         Mã thuê bao : {2}
          //         Tên khách hàng : {3}
          //         Mã số thuế : {4}
          //         Mã BHXH/Mã đơn vị : {5}
          //         Địa chỉ : {6}
          //         Mã tỉnh : {7}
          //         Quận/huyện : {8}
          //         Số di động : {9}
          //         Số cố định : {10}
          //         Họ tên người ký tờ khai : {11}
          //         Chức danh người ký tờ khai : {12}
          //         Khối đơn vị : {13}
          //         Loại hình kinh doanh : {14}
          //         Loại gói : {15}
          //         Gói cước : {16}
          //         Ngày bắt đầu sử dụng : {17}
          //         Ngày kêt thúc sử dụng : {18}
          //         Số tháng khuyến mại : {19}
          //         Ngày ký hợp đồng : {20}
          //         Người ký hợp đồng : {21}
          //         Số hợp đồng : {22}
          //         Tên đăng nhập tài khoản cha : {23}
          //         Tên đăng nhập AM (hệ thống BHXH) : {24}
          //     ", ten_am, dhsxkd_ma_khach_hang, dhsxkd_ma_thue_bao, ten_khach_hang, ma_so_thue, ma_don_vi, dia_chi, dhsxkd_ma_tinh, ma_huyen, sdt_di_dong, sdt_co_dinh, ho_ten_nguoi_ky_to_khai,
          //           chuc_danh_nguoi_ky_to_khai, ma_khoi_don_vi, ma_loai_hinh_kinh_doanh, ma_loai_goi_dich_vu, ma_goi_dich_vu, ngay_bat_dau_su_dung, ngay_ket_thuc_su_dung, so_thang_khuyen_mai, ngay_ky_hop_dong,
          //           nguoi_ky_hop_dong, so_hop_dong, ten_dang_nhap_tai_khoan_cha, frmDangNhapIVAN.TenDangNhapIVAN);
        }
      } catch (ex) {
        this.$toast.error('Có lỗi xảy ra. Liên hệ admin để kiểm tra lại dữ liệu')
        //return "Có lỗi xảy ra. Liên hệ admin để kiểm tra lại dữ liệu";
        return '' //Loi thi khong tra ve gi
      }
    },
    async KiemTraMST() {
      if (this.khachhang.masothue && this.khachhang.masothue.trim() != '') {
        if (this.thamsomacdinh['CHAN_TRUNG_SGT'] && this.thamsomacdinh['CHAN_TRUNG_SGT'] == 1) {
          let checkMST = await API.post_kiemtra_khachhang_theo_mst(this.axios, {
            vmasothue: this.khachhang.masothue,
            vhdkh_id: this.khachhang.hdkh_id,
            vloaihd_id: LoaiHopDong.DAT_MOI,
            vma_kh: this.khachhang.makh
          }).then((response) => {
            if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
              return response.data.data
            } else return ''
          })
          if (checkMST && checkMST != 1) {
            this.$toast.error(checkMST)
            this.khachhang.masothue = ''
            return
          }
        }
        this.Laythongtin_kh_tiemnang(this.khachhang.masothue);
      }
    },
    async KiemTraMSTTB() {
      if (this.thuebao.txtMSTThueBao && (this.thuebao.txtMSTThueBao+'').trim() != '') {
          await this.Laythongtin_kh_tiemnang(this.thuebao.txtMSTThueBao);
        }
    },
    async Laythongtin_kh_tiemnang(mst) {
      //https://cntt.vnpt.vn/browse/VNPSR-10681
      //Với KHDN, lấy ra thông tin khách hàng trên hệ thống KHDN để auto điền vào form
      try
      {
          //Nếu là KHDN thì mới xử lý
          if (!mst || (mst+'').trim()=="") return;
          //Nếu là KH doanh nghiệp thì sẽ lấy thông tin từ hệ thống KHDN
          if (this.vkieukh_id_ != KIEU_KH.DOANH_NGHIEP) return; //Khách hàng doanh nghiệp
          // var client = new RestClient();
          await API.post_search_khtn(this.axios,{mst:mst}).then(async (response) => {
            if (response && response.data && response.data.data && response.data.errorCode*1 === 0) {
              var rss = JSON.parse(response.data.data);
              if(rss && rss['result'] && rss.result.length>0) {
                let cfr = await this.$bvModal
                  .msgBoxConfirm(`Tìm thấy thông tin khách hàng từ hệ thống KHDN, bạn có muốn sử dụng các thông tin này ?`, {
                    title: 'Thông báo',
                    size: 'sm',
                    okTitle: 'Đồng ý',
                    cancelTitle: 'Hủy'
                })
                .then((v) => {
                  return v
                })
                if(cfr) {
                  this.khachhang.tenkh = rss["result"][0]["FULL_NAME"];
                  this.diachiKH.DIACHI = rss["result"][0]["ADDR"];
                  this.khachhang.nguoidd = rss["result"][0]["DD_NAME"];
                  this.khachhang.dienthoai = rss["result"][0]["PHONE"];
                }
              }
            } else if (response.data.faultString) this.$toast.error(response.data.faultString);
          })
      }
      catch (ex)
      {
          this.$toast.error("Không lấy được thông tin từ hệ thống Khách hàng tiềm năng !");
          if(this.debug) console.error(ex);
      }
    },
    async KiemTraSoGT() {
      // khachhang.sogt
      if (this.khachhang.sogt && this.khachhang.sogt.trim() != '') {
        // CUONGNM thêm .:\-\/   theo yêu cầu https://cntt.vnpt.vn/browse/IT360-223618
        if (!/^[a-zA-Z0-9.:\-\/]*$/.test(this.khachhang.sogt)) {
          //&& !Char.IsControl(e.KeyChar))
          this.$toast.error('Số giấy tờ không hợp lệ.Số giấy tờ gồm các ký tự từ 0->9a->z . : - /. Hãy kiểm tra lại')
          return
        }
        let ds_maKH = await API.post_lay_ds_makh_theo_sogt(this.axios, {
          vso_gt: this.khachhang.sogt,
          vhdkh_id: this.khachhang.hdkh_id,
          vloaihd_id: LoaiHopDong.DAT_MOI,
          so_gt: this.khachhang.sogt,
          hdkh_id: this.khachhang.hdkh_id
        }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            return response.data.data
          } else return []
        }) // tcdanhba.LAY_DS_MAKH_THEO_SOGT(txtSoGT.Text, hdkh_id, LoaiHopDong.DAT_MOI);
        if (ds_maKH && ds_maKH.length == 1) {
          if (this.khachhang.makh != ds_maKH[0]['ma_kh']) {
            if (this.thamsomacdinh['CHAN_TRUNG_SGT'] && this.thamsomacdinh['CHAN_TRUNG_SGT'] == 1) {
              this.$toast.error(`Số giấy tờ ${this.khachhang.sogt} đang được sử dụng bởi các mã khách hàng: ${ds_maKH[0]['ma_kh']} (${ds_maKH[0]['ma_gd']})`)
              this.khachhang.sogt = ''
              return false
            }
            let cfr = await this.$bvModal
              .msgBoxConfirm(`Số giấy tờ ${this.khachhang.sogt} đang được sử dụng bởi các mã khách hàng: ${ds_maKH[0]['ma_kh']} (${ds_maKH[0]['ma_gd']})\nBạn có muốn sử dụng thông tin khách hàng cũ không?`, {
                title: 'Thông báo',
                size: 'sm',
                okTitle: 'Đồng ý',
                cancelTitle: 'Hủy'
              })
              .then((v) => {
                return v
              })
            if (cfr) {
              //Lấy thông tin cũ của khách hàng khi chưa lập hợp đồng - Hieutc 21.10.2010
              if (this.khachhang.hdkh_id == 0) {
                this.khachhang.makh = ds_maKH[0]['ma_kh'] + ''

                await API.post_lay_db_theo_matb(this.axios, { ma_tb: this.khachhang.makh, donvi_dl_id: 0, dichvuvt_id: 0 }).then((response) => {
                  if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                    //this.listbox.danhba.list=response.data.data;
                    this.HienThiTT_DanhBa(response.data.data)
                  }
                }) // HienThiTT_DanhBa(tcdanhba.LAY_DB_THEO_MATB(txtMaKH.Text, 0, 0));
              } else {
                this.$toast.error('Hợp đồng/phụ lục đã được lập, bạn không được sử dụng số giấy tờ của khách hàng khác!')
                //return;
              }
            } else {
              //Message_Box.ShowWarning("Số giấy tờ " + txtSoGT.Text + " đang được sử dụng bởi mã khách hàng: " + ds_maKH.Tables[0].Rows[0]["ma_kh"].ToString() + ". Bạn không được sử dụng số giấy tờ của khách hàng khác!");
              //txtSoGT.Focus();
              //txtSoGT.SelectAll();
              //return;
            }
          }
        } else if (ds_maKH.length > 1) {
          let str = []
          for (var i = 0; i < ds_maKH.length; i++) {
            str.push(`${ds_maKH[i]['ma_kh']} (${ds_maKH[i]['ma_gd']})`)
          }
          if (this.thamsomacdinh['CHAN_TRUNG_SGT'] && this.thamsomacdinh['CHAN_TRUNG_SGT'] == 1) {
            this.$toast.error('Số giấy tờ ' + this.khachhang.sogt + ' đang được sử dụng bởi các mã khách hàng: ' + str.join(',') + '.')
            this.khachhang.sogt = ''
            return false
          }
          else this.$toast.error('Số giấy tờ ' + this.khachhang.sogt + ' đang được sử dụng bởi các mã khách hàng: ' + str.join(',') + '.') // Đề nghị bạn ký lại hợp đồng gốc trước khi lập phụ lục.
        }
      }
    },
    ThuebaoToaNha_OnClose() {
      this.isShowThueBaoToaNha = false
      // this.popup.Thuebao_ToaNha = false;
      // call api using axios vuejs
    },
    ResetThueBao() {
      let olddata = {}
      Object.assign(olddata, this.$options.data.call(this))
      this.thuebao.codinh.somay = olddata.thuebao.codinh.somay
      this.thuebaocd.matn = olddata.thuebaocd.matn
      this.thuebao.codinh.sochinh = olddata.thuebao.codinh.sochinh
      this.thuebaocd.cuocdoitac = olddata.thuebaocd.cuocdoitac
      this.thuebao.didong.txtSoMayDD = olddata.thuebao.didong.txtSoMayDD
      this.thuebao.didong.txtSimDD = olddata.thuebao.didong.txtSimDD
      this.thuebao.didong.txtSoMayNTK = olddata.thuebao.didong.txtSoMayNTK
      this.thuebao.didong.txtTienDuTK = olddata.thuebao.didong.txtTienDuTK
      this.thuebao.gphone.txtSoMayGP = olddata.thuebao.gphone.txtSoMayGP
      this.thuebao.gphone.txtSoSimGphone = olddata.thuebao.gphone.txtSoSimGphone
      this.thuebao.adsl.txtAccountADSL = olddata.thuebao.adsl.txtAccountADSL
      this.thuebao.adsl.txtSoAoAdsl = olddata.thuebao.adsl.txtSoAoAdsl
      this.thuebao.adsl.txtMaTN_ADSL = olddata.thuebao.adsl.txtMaTN_ADSL
      this.listbox.cboGoiCuocAdsl.value = 0
      this.thuebao.adsl.txtCuocDT_Internet = olddata.thuebao.adsl.txtCuocDT_Internet
      this.thuebao.adsl.txtEmailAdsl = olddata.thuebao.adsl.txtEmailAdsl
      this.thuebao.adsl.txtDienThoai_Fsecure = olddata.thuebao.adsl.txtDienThoai_Fsecure
      this.thuebao.adsl.txtSL_Tivi = olddata.thuebao.adsl.txtSL_Tivi
      this.thuebao.adsl.txtCSD_FIBER_TK = olddata.thuebao.adsl.txtCSD_FIBER_TK
      this.thuebao.adsl.txtCTB_FIBER_TK = olddata.thuebao.adsl.txtCTB_FIBER_TK
      this.thuebao.adsl.txtSerialSTB = olddata.thuebao.adsl.txtSerialSTB
      this.thuebao.adsl.tientra = olddata.thuebao.adsl.tientra
      this.thuebao.adsl.txtMaTB_KN = olddata.thuebao.adsl.txtMaTB_KN
      this.thuebao.adsl.megaIOT_vrf = olddata.thuebao.adsl.megaIOT_vrf
      this.thuebao.adsl.megaIOT_LanIP = olddata.thuebao.adsl.megaIOT_LanIP
      this.thuebao.adsl.megaIOT_WanIP = olddata.thuebao.adsl.megaIOT_WanIP
      this.thuebao.adsl.megaIOT_HuongKN = olddata.thuebao.adsl.megaIOT_HuongKN
      this.thuebao.ims.txtMaTBIMS = olddata.thuebao.ims.txtMaTBIMS
      this.thuebao.ims.txtMaTN_IMS = olddata.thuebao.ims.txtMaTN_IMS
      this.thuebao.ims.txtIp_IMS = olddata.thuebao.ims.txtIp_IMS
      this.thuebao.ims.cboTrunk.value = 0
      this.thuebao.mgwan.somay = olddata.thuebao.mgwan.somay
      this.thuebao.mgwan.soao = olddata.thuebao.mgwan.soao
      this.thuebao.mgwan.matn = olddata.thuebao.mgwan.matn
      this.thuebao.mgwan.siteid = olddata.thuebao.mgwan.siteid
      this.thuebao.mgwan.mahdttkd = olddata.thuebao.mgwan.mahdttkd
      this.thuebao.mgwan.huongkn = olddata.thuebao.mgwan.huongkn
      this.thuebao.mgwan.vrfvfi = olddata.thuebao.mgwan.vrfvfi
      this.thuebao.mgwan.cuocnix = olddata.thuebao.mgwan.cuocnix
      this.thuebao.mgwan.soluongip = olddata.thuebao.mgwan.soluongip
      this.thuebao.mgwan.cuocisp = olddata.thuebao.mgwan.cuocisp
      this.thuebao.mgwan.cuocip = olddata.thuebao.mgwan.cuocip
      this.thuebao.mgwan.cuoctc_dt = olddata.thuebao.mgwan.cuoctc_dt
      this.thuebao.mgwan.cuoctc = olddata.thuebao.mgwan.cuoctc
      this.thuebao.mgwan.hopdong_dt = olddata.thuebao.mgwan.hopdong_dt
      this.thuebao.mgwan.cuoctk_dt = olddata.thuebao.mgwan.cuoctk_dt
      this.thuebao.mgwan.cuoctk = olddata.thuebao.mgwan.cuoctk
      this.thuebao.mgwan.cuoctbi = olddata.thuebao.mgwan.cuoctbi
      this.thuebao.mgwan.cuocht = olddata.thuebao.mgwan.cuocht
      this.thuebao.mgwan.lanip = olddata.thuebao.mgwan.lanip
      this.thuebao.mgwan.wanip = olddata.thuebao.mgwan.wanip
      this.thuebao.mgwan.madoicap = olddata.thuebao.mgwan.madoicap
      this.listbox.doitacwan.value = olddata.listbox.doitacwan.value
      this.listbox.doitacwan.isenabled = olddata.listbox.doitacwan.isenabled
      this.listbox.tocdokenh.ischeckedisp = olddata.listbox.tocdokenh.ischeckedisp
      this.listbox.tocdokenh.valueisp = olddata.listbox.tocdokenh.valueisp
      this.listbox.tocdokenh.ischeckednix = olddata.listbox.tocdokenh.ischeckednix
      this.listbox.tocdokenh.valuenix = olddata.listbox.tocdokenh.valuenix
      this.listbox.tocdokenh.ischeckednix = olddata.listbox.tocdokenh.ischeckednix
      this.listbox.tocdokenh.valuenix = olddata.listbox.tocdokenh.valuenix
      this.listbox.loai_tb.valuemgwan = olddata.listbox.loai_tb.valuemgwan
      this.listbox.loaicap.value = olddata.listbox.loaicap.value
      this.listbox.tocdokenh.valuepir = olddata.listbox.tocdokenh.valuepir
      this.listbox.tocdokenh.ischeckedpir = olddata.listbox.tocdokenh.ischeckedpir
      this.listbox.tocdokenh.valuecir = olddata.listbox.tocdokenh.valuecir
      this.thuebao.tsl.txtMaTSL.Text = olddata.thuebao.tsl.txtMaTSL.Text
      this.thuebao.tsl.txtMaHD_TTKD_TSL = olddata.thuebao.tsl.txtMaHD_TTKD_TSL
      this.thuebao.tsl.txtCuocTC_TSL = olddata.thuebao.tsl.txtCuocTC_TSL
      this.thuebao.tsl.txtCuocTK_TSL = olddata.thuebao.tsl.txtCuocTK_TSL
      this.thuebao.tsl.txtCuocTKDT_TSL = olddata.thuebao.tsl.txtCuocTKDT_TSL
      this.thuebao.tsl.txtCuocTBI_TSL = olddata.thuebao.tsl.txtCuocTBI_TSL
      this.thuebao.tsl.txtMaHD_DT_TSL = olddata.thuebao.tsl.txtMaHD_DT_TSL
      this.thuebao.tsl.txtCuocTCDT_TSL = olddata.thuebao.tsl.txtCuocTCDT_TSL
      this.thuebao.tsl.txtCuocHT_TSL = olddata.thuebao.tsl.txtCuocHT_TSL
      this.thuebao.tsl.txtSoAoTSL_Dau = olddata.thuebao.tsl.txtSoAoTSL_Dau
      this.thuebao.tsl.txtSoAoTSL_Cuoi = olddata.thuebao.tsl.txtSoAoTSL_Cuoi
      this.thuebao.tsl.txtSiteIDTSL_Dau = olddata.thuebao.tsl.txtSiteIDTSL_Dau
      this.thuebao.tsl.txtSiteIDTSL_Cuoi = olddata.thuebao.tsl.txtSiteIDTSL_Cuoi
      this.thuebao.tsl.txtVrf_Dau = olddata.thuebao.tsl.txtVrf_Dau
      this.thuebao.tsl.txtVrf_Cuoi = olddata.thuebao.tsl.txtVrf_Cuoi
      this.thuebao.tsl.txtSoSoiQuang = olddata.thuebao.tsl.txtSoSoiQuang

      // Bo sung do loi phat sinh
      this.dsCTM_TBI = []
      this.lvMuaThietbi.list = []
      this.lvDvkhac.list = []
      this.dsDK_DVK_TB = []
      this.dsDC_HDTB = []
      this.dsKM_HDTB = []
      this.ds_tien_khoanmuc = JSON.parse(JSON.stringify(this.listbox.tien_km.list))
      this.dtienld = 0
      this.dvatld = 0
      this.tocdo_id = 0
      this.listbox.cboTocDoThucADSL.value = 0
      this.nhap_tocdo_thuc_adsl = 0
      this.thuebao.tsl.txtMaTSL.ReadOnly = false

      this.kt_thuenganhan = false

      this.filterbox.tratruoc.list = [];
      this.filterbox.tratruoc.value = 0;
      this.filterbox.tratruoc.ischecked = false;

      this.filterbox.khuyenmai.list = [];
      this.filterbox.khuyenmai.value = 0;
      this.filterbox.khuyenmai.ischecked = false;

      this.LayTienTheoKhoanMuc()
      // if(this.watcherActive) this.sinhma = true;
    },
    async txtSoMayDD_Leave() {
      if (this.thuebao.didong.txtSoMayDD && this.thuebao.didong.txtSoMayDD.length > 8 && this.thuebao.didong.txtSoMayDD.length < 20) {
        this.CHON_KIEULD_THEO_TB('84' + this.thuebao.didong.txtSoMayDD)
        this.CHON_LOAITB_TS_THEO_TB('84' + this.thuebao.didong.txtSoMayDD) // vuth update 0912
      }
    },
    clickOpenKenhIOT() {
      this.popup.chonMegaWanIOTModal = true
      this.$refs.chonMegaWanIOTModal.showModal(this.khachhang.khachhang_id, this.khachhang.hdkh_id, this.thuebao.adsl.megaIOT_WanIP, this.thuebao.adsl.megaIOT_LanIP, this.thuebao.adsl.megaIOT_vrf, this.thuebao.adsl.megaIOT_HuongKN)
    },
    acceptChonMegaWanIOT(data) {
      this.thuebao.adsl.megaIOT_vrf = data.vrf
      this.thuebao.adsl.megaIOT_LanIP = data.lan_ip
      this.thuebao.adsl.megaIOT_WanIP = data.wan_ip
      this.thuebao.adsl.megaIOT_HuongKN = data.ma_tb
      this.thuebao.adsl.txtMaTB_KN = this.thuebao.adsl.megaIOT_HuongKN
      // this.popup.chonMegaWanIOTModal = false;
    },
    async kiemtra_ip_megaiot(data) {
      try {
        this.loading(true)
        let response = await this.axios.post('/web-hopdong/megawaniot/kiemtra_ip_megaiot', data)
        this.loading(false)
        if (response && response.data && response.data.error_code && response.data.error_code == 'BSS-00000000' && response.data.data) {
          return response.data.data
        } else {
          if (response && response.data && response.data.message) {
            return response.data.message
          } else {
            return 'Xảy ra lỗi khi kiểm tra vrf'
          }
        }
      } catch (e) {
        this.loading(false)
        if (e.data && e.data.message) {
          return e.data.message
        } else if (e.response && e.response.data && e.response.data.message) {
          return e.response.data.message
        } else {
          return 'Xảy ra lỗi khi kiểm tra vrf'
        }
      }
    },
    async ReloadTramThiCong() {
      try {
        let newval = this.diachiLD
        if (!newval.QUAN_ID || !newval.PHUONG_ID) return
        let pdata = { KETCUOI_ID: this.KetCuoi_ID, TINHKHAC: this.thuebao.tinhkhac, KIEULD_ID: this.listbox.kieu_ld.value, PHUONG_ID: newval.PHUONG_ID, PHO_ID: newval.PHO_ID, AP_ID: newval.AP_ID, KHU_ID: newval.KHU_ID, DACDIEM_ID: newval.DACDIEM_ID, KHUVUC_THEO_KETCUOI: this.KHUVUC_THEO_KETCUOI }
        if(this.$root.token.getPhanVungID()!=97)
        await API.post_fn_lay_tt_th_diachi_ld(this.axios, { ds_para: JSON.stringify(pdata) }).then((response) => {
          if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
            let apidata = JSON.parse(response.data.data)
            if (apidata['RESULT'] && apidata['RESULT']['DS_DVI'])
              if (apidata['RESULT']['DS_DVI'].length == 1) this.XuLyDonViLD(apidata['RESULT']['DS_DVI'])
              else if (apidata['RESULT']['DS_DVI'].length > 1) this.XuLyDonViLD([apidata['RESULT']['DS_DVI'][0]])
          }
        })
      } catch (ex) {
        if (this.debug) console.error(ex)
      }
    },
    cboTocDo_Closed(e) {
    },
    // modalDlgOpen(a,b,c) {
    //   console.info('Open',a,b,c);
    // },
    // modalDlgClose(a,b,c) {
    //   console.info('Open',a,b,c);
    // },
    tsbtnEmail_Click() {
      if (this.khachhang.hdkh_id != 0) {
        this.$bvModal.show('ThongTinEmail')
      }
    },
    btnTraTruoc_click: function() {
      try {
        // this.popupComponent.data.isPopup = true;
        this.popupComponentData = {
          isPopup: true,
          hdkh_id: this.khachhang.hdkh_id,
          khachhang_id: this.khachhang.khachhang_id,
          dichvu_vt: this.listbox.dichvu_vt.value,
          loaitb_id: this.listbox.loaihinh_tb.value,
          // kieuld_id: this.listbox.kieu_ld.value,
          ma_tb: this.ma_tb ? this.ma_tb : this.khachhang.makh
        }
        this.popupComponent = () => import('@/modules/contract/setup/PrepaidDeposite/index.js')
        this.popupComponentName = 'popupDK_TraTruoc'
        this.Popup('popupComponents')
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    btnTraTruocV2_click: function() {
      try {
        // this.popupComponent.data.isPopup = true;
        this.popupComponentData = {
          isPopup: true,
          tag: '1',
          hdkh_id: this.khachhang.hdkh_id,
          khachhang_id: this.khachhang.khachhang_id,
          dichvu_vt: this.listbox.dichvu_vt.value,
          loaitb_id: this.listbox.loaihinh_tb.value,
          // kieuld_id: this.listbox.kieu_ld.value,
          ma_gd: this.khachhang.magd
        }
        this.popupComponent = () => import('@/modules/contract/setup/PrepaidDepositeV2/index.js')
        this.popupComponentName = 'popupDK_TraTruoc'
        this.Popup('popupComponents')
      } catch (ex) {
        this.$toast.error('' + ex)
        if (this.debug) console.error(ex)
      }
    },
    async Test() {
      console.log("Start test!");
      this.watcherActive = false;
      while(true) {
        await waitUntil(()=>this.watcherActive);
        console.log("Inside while");
        break;
      }
      console.log("End test!");
    },
    Done() {
      console.log("Done test...");
      this.watcherActive = true;
      console.log("Done!");
    },
    dgvTienCK_actionComplete(args) {
      if(args.requestType=="save" || args.requestType=="delete") {
        this.thuebao.codinh.dgvTienCK.list = args.rows?args.rows.map(item=>item.data):[];
      }
    },
    dgvTienCKGP_actionComplete(args) {
      if(args.requestType=="save" || args.requestType=="delete") {
        this.thuebao.codinh.dgvTienCKGP.list = args.rows?args.rows.map(item=>item.data):[];
      }
    },
    dgvTienCKIMS_actionComplete(args) {
      if(args.requestType=="save" || args.requestType=="delete") {
        this.thuebao.codinh.dgvTienCKIMS.list = args.rows?args.rows.map(item=>item.data):[];
      }
    },
    round(num) {
        if(this.is_nv_vnpti==1)
            return +(Math.round(num + "e+2")  + "e-2");
        else return Math.round(num);
    },
    async CheckGhiLaiDichVubaoHieuQuocTe() {
      if (this.listbox.loaihinh_tb.value == LoaiHinhTB.BaoHieuQuocTe && this.$root.token.getPhanVungID()==100)// this.tt_nd.tinh_id == 100)
      {
          for (var i = 0; i < this.gridEditors.length; i++)
          {
              if (this.gridEditors[i].ID == "MA_POS" && this.hdtb_id > 0)
              {
                  var ma_pos = await API.post_fn_tt_hdtb_cntt(this.axios, {type: 4, param: this.hdtb_id}).then(response=>{
                    if (response && response.data && response.data.data && response.data.error_code && response.data.error_code === 'BSS-00000000') {
                      return response.data.data //.data_json;
                    }
                  });// = tdan.GET_VALUE_SQL("select ma_pos from " + DatabaseConstants.DB2 + ".hdtb_cntt where hdtb_id= " + hdtb_id + "").ToString();
                  var values = this.gridEditors[i].Value;
                  if (ma_pos != values)//(ma_pos && ma_pos > 0 && ma_pos != values)
                  {
                    await API.get_sp_del_hdtb_cntt_sub(this.axios, {params: {hdtb_id: this.hdtb_id}});
                      //tdan.EXECUTE_SQL("delete from " + DatabaseConstants.DB2 + ".hdtb_cntt_sub where hdtb_id = " + hdtb_id + " and loaihinh_tb = " + 2114.ToString() + "");
                  }
              }
          }

          for (var j = 0; j < this.ItemList.length; j++)
          {
              if (this.ItemList[j].sFieldName == "THIETBI")
              {
                  this.gridEditors[j].Value = null;
                  this.ItemList[j].sValue = null;
                  break;
              }
          }
      }
    },
  }
}
</script>
