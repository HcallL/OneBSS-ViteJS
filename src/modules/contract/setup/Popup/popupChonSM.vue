<template>
<div class="modal-content popup-box">
                <div class="popup-header">
                    <div class="title"><span class="icon one-notepad"></span> Đăng ký dịch vụ gia tăng</div>
                    <div class="close -ap icon-close" data-dismiss="modal">
                    </div>
                </div>
                <div class="list-actions-top">
                    <ul class="list">
                        <li>
                            <a href="#">
                                <span class="icon nc-icon-glyph ui-1_check-circle-08"></span>Chấp nhận
                            </a>
                        </li>
                        
                    </ul>
                </div>
                <div class="popup-body">
                    <div class="box-form">
                        <div class="table-content">
                            <table class="table-result table-gachle table-filter ">
                                <thead class="center">
                                    <tr>
                                        <th class="w20"></th>
                                        <th>
                                            STT
                                        </th>
                                        <th>
                                            Mã dịch vụ
                                        </th>
                                        <th>
                                            Tên dịch vụ
                                        </th>
                                        <th>
                                            Đăng ký
                                        </th>
                                        <th>
                                            Cước lắp đặt
                                        </th>
                                        <th>
                                            Vat lắp đặt
                                        </th>
                                        <th>
                                            Tổng tiền
                                        </th>
                                        <th>
                                            Phí duy trì
                                        </th>
                                        <th>
                                            Vat duy trì
                                        </th>
                                        <th>
                                            Nội dung/Số lượng
                                        </th>
                                        <th>
                                            Số lượng...
                                        </th>
                                        <th>
                                            Block
                                        </th>
                                        <th>
                                            Giá Block
                                        </th>
                                        <th>
                                            Vat Block
                                        </th>
                                        <th>
                                            Ghi chú
                                        </th>
                                    </tr>
                                    <tr>
                                        <th class="w20"></th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="check-action">
                                                <input type="checkbox" disabled="" class="check">
                                                <span class="name"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="input-icon-right">
                                                <input type="text" class="form-control">
                                                <span class="icon nc-icon-outline ui-1_zoom"></span>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="highlight">
                                        <td class="w20 center">
                                            <span class="fa fa-play text-main"></span>
                                        </td>
                                        <td class="selected highlight1"></td>
                                        <td></td>
                                        <td></td>
                                        <td class="w20 center">
                                            <div class="check-action">
                                                <input type="checkbox" class="check">
                                                <span class="name"></span>
                                            </div>
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td class="w20 center">
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="w20 center">
                                            <div class="check-action">
                                                <input type="checkbox" class="check">
                                                <span class="name"></span>
                                            </div>
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td class="w20 center">
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="w20 center">
                                            <div class="check-action">
                                                <input type="checkbox" class="check">
                                                <span class="name"></span>
                                            </div>
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td class="w20 center">
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="w20 center">
                                            <div class="check-action">
                                                <input type="checkbox" class="check">
                                                <span class="name"></span>
                                            </div>
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td class="w20 center">
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="w20 center">
                                            <div class="check-action">
                                                <input type="checkbox" class="check">
                                                <span class="name"></span>
                                            </div>
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td class="w20 center">
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="w20 center">
                                            <div class="check-action">
                                                <input type="checkbox" class="check">
                                                <span class="name"></span>
                                            </div>
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td class="w20 center">
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="w20 center">
                                            <div class="check-action">
                                                <input type="checkbox" class="check">
                                                <span class="name"></span>
                                            </div>
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    <tr class="tfoot">
                                        <td class="w20 center">
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td>
                                            <input type="text" class="form-control tright text fw6" value="0">
                                        </td>
                                        <td class="w20 center">
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td>
                                            <input type="text" class="form-control tright text fw6" value="0">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control tright text fw6" value="0">
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td>
                                            <input type="text" class="form-control tright text fw6" value="0">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control tright text fw6" value="0">
                                        </td>
                                        <td></td>
                                    </tr>
                                   
                                </tbody>
                            </table>
                        </div>
                        <div class="tc-pagination">
                            <a href="#" class="btn  one-arrow-left-forward"></a>
                            <a href="#" class="btn fa fa-angle-double-left"></a>
                            <a href="#" class="btn fa fa-angle-left"></a>
                            <span class="text">Bản ghi</span>
                            <div class="dropdown inline">
                                <div class="fw6 input-number" data-toggle="dropdown">
                                    <span class="text-main">10</span>/1033
                                </div>
                                <div class="dropdown-menu">
                                    <a href="#" class="dropdown-item">10</a>
                                    <a href="#" class="dropdown-item">20</a>
                                </div>
                            </div>
                            <a href="#" class="btn fa fa-angle-right"></a>
                            <a href="#" class="btn fa fa-angle-double-right"></a>
                            <a href="#" class="btn one-arrow-right-forward"></a>
                        </div>
                    </div>
                    
                </div>
            </div>






</template>
<style scoped>
    input.disabled, select.disabled, .disabled input, .disabled select, .disabled /deep/ .select2-selection { background-color: #EEE; color:lightgray;}
</style>
<script>
export default {
    name: 'popupChonSM',
    props: [ 'dulieu' ],
    watch: {
        'nhomso.ischecked': {
            handler(newval) {
                if(newval && this.nhomso.list && this.nhomso.list.length>0)
                    this.nhomso.value = this.nhomso.list[0].NHOMSO_ID;
                else this.nhomso.value = -1;
            },
            deep:true
        },
        'kieuso.ischecked': {
            handler(newval) {
                var ns = this.nhomso.value;
                var list = this.kieuso.list.filter(x=>x.NHOMSO_ID==ns);
                if(newval && list && list.length>0)
                    this.kieuso.value = list[0].KIEUSO_ID;
                else this.kieuso.value = 0;
            },
            deep:true
        },
        'vetinh.ischecked': {
            handler(newval) {
                if(newval && this.vetinh.list && this.vetinh.list.length>0)
                    this.vetinh.value = this.vetinh.list[0].donvi_id;
                else this.vetinh.value = 0;
            },
            deep:true
        },
    },
    data() {
        return {
            diachi: {
                diachi_id: null,
                tinh_id:null ,
                quan_id: null,
                phuong_id: null,
                pho_id: null,
                ap_id: null,
                khu_id:null,
                dac_diem_id: null,
                so_nha: "",
                daydiachi: "",
                diachimoi: "",
            },
            dsTinh: [],
            dsQuan: [],
            dsPhuong: [],
            tentinh: "",
            tenquan: "",
            tenphuong: "",
            loaiso: { list: [], value: 0 },
            nhomso: { list: [], value: -1, ischecked:false, },
            kieuso: { list: [], value: 0, ischecked:false, },
            vetinh: { list: [], value: 0, ischecked:false, },
            somay: { list: [], value: "", idx: 0, },
            thueso: false,
            loaitb_id: 0,
            donvi_ql_id: 0,
            dichvuvt_id: 0,
            hdkh_id: 0,
            ds_dauso: [],
            dauso: "",
            tongdai_id: 0,
            timkiem: "",
            tsbtnIn: false,
        }
    },
    async mounted() {
        this.loading(true);
        //Load default data
        {
            this.diachi.quan_id = this.dulieu._quan_id?this.dulieu._quan_id:0;
            this.diachi.phuong_id = this.dulieu._phuong_id?this.dulieu._phuong_id:0;
            this.loaiso.value = this.dulieu._loaiso_id?this.dulieu._loaiso_id:0;
            this.thueso = this.dulieu._thueso;
            this.loaitb_id = this.dulieu.loaitb_id;
            this.donvi_ql_id = this.dulieu.donvi_ql_id;
            this.dichvuvt_id = this.dulieu.dichvuvt_id;
            this.hdkh_id = this.dulieu.hdkh_id;
        }

        var load1 = this.getQuan();
        var load2 = this.getPhuong();
        var load3 = this.$root.context.get("/web-quantri/danhmuc-chung/CSS_LOAI_SO");
        var load4 = this.$root.context.get("/web-quantri/danhmuc-chung/CSS_NHOM_SO");
        var load5 = this.$root.context.get("/web-quantri/danhmuc-chung/CSS_KIEU_SO");
        var load6 = this.getVeTinh();
        //if(loaiso && loaiso.data) this.loaiso.list = loaiso.data;
        Promise.all([load1,load2,load3,load4,load5,load6]).then(([data1,data2,data3,data4,data5,data6])=>{
            if(data3 && data3.data) this.loaiso.list = data3.data;
            if(data4 && data4.data) this.nhomso.list = data4.data;
            if(data5 && data5.data) this.kieuso.list = data5.data;
        }).finally(()=>{
            this.loading(false);
        });
    },
    computed: {
        filteredSoMay: function() {
            var newlist = this.somay.list.filter(x=>x.somay.indexOf(this.timkiem)>=0);
            if(newlist && newlist.length>0) this.dsSoMayChanged(0,newlist[0]);
            return newlist?newlist:[];
        }
    },
    methods: {
        closeForm() {
            this.$emit('form-close',this.somay.value);
        },
        getDauSo: async function() {
            var dsDauSo = await this.$root.context.post("/web-hopdong/lapdatmoi/lay_ds_dauso_theo_quan_dvvt_v3",{ "vdichvuvt_id": this.dichvuvt_id, "vdonvi_ql_id": this.donvi_ql_id, "vloaiso_id": this.loaiso.value, "vloaitb_id": this.loaitb_id, "vnhomso_id": this.nhomso.value, "vphuong_id": this.diachi.phuong_id, "vquan_id": this.diachi.quan_id, "vvetinh_id": this.vetinh.value }); //loaitb = 0 do bien mac dinh
            if(dsDauSo && dsDauSo.data) {
                this.ds_dauso = dsDauSo.data;
                if(this.ds_dauso && this.ds_dauso.length>0) {
                    this.dsDauSoChanged(0,this.ds_dauso[0]);
                }
            }
        },
        getVeTinh: async function() {
            var vetinh = await this.$root.context.post("/web-hopdong/lapdatmoi/sp_lay_lay_ds_vetinh_prefix",{ "dichvuvt_id": this.dichvuvt_id, "donvi_ql_id": this.donvi_ql_id, "loaiso_id": this.loaiso.value, "loaitb_id": this.loaitb_id, "phuong_id": this.diachi.phuong_id, "quan_id": this.diachi.quan_id }); //loaitb = 0 do bien mac dinh
            if(vetinh && vetinh.data) this.vetinh.list = vetinh.data;
        },
        getQuan: async function () {
            try {
                this.$root.showLoading(true);
                var rs = await this.$root.context.get("/web-cabman/bando_tuyencot/lay_ds_quan_huyen/" + this.$root.token.getPhanVungID());
                this.dsQuan = rs.data;
                if(this.diachi.quan_id!=null)
                    this.tenquan = this.dsQuan.filter((x) => x.QUAN_ID == this.diachi.quan_id)[0].TEN_QUAN;
            } catch (error) {
            } finally {
                this.$root.showLoading(false);
            }
        },
        getPhuong: async function () {
            try {
                this.$root.showLoading(true);
                var rs = await this.$root.context.get("/web-cabman/bando_tuyencot/lay_ds_phuong_xa/" + this.diachi.quan_id);
                this.dsPhuong = rs.data;
                if(this.diachi.phuong_id!=null)
                    this.tenphuong = this.dsPhuong.filter(x => x.PHUONG_ID == this.diachi.phuong_id)[0].TEN_PHUONG;
            } catch (error) {
                console.log(error)
            } finally {
                this.$root.showLoading(false);
            }
        },
        onChangeTinh: async function () {
            await this.getQuan();
            this.tentinh = this.dsTinh.filter(
                (x) => x.TINH_ID == this.diachi.tinh_id
            )[0].TENTINH;
        },
        onChangeQuan: async function () {
            await this.getPhuong();
            this.tenquan = this.dsQuan.filter(
            (x) => x.QUAN_ID == this.diachi.quan_id
            )[0].TEN_QUAN;
        },
        onChangePhuong: async function () {
            // await this.getPhoApKhu();
            this.tenphuong = this.dsPhuong.filter(
            x => x.PHUONG_ID == this.diachi.phuong_id)[0].TEN_PHUONG;
        },
        chapnhan: function () {
            // if (
            //     this.isStrictMode &&
            //     ((!this.isPho && !this.isAp && !this.isKhu) ||
            //     (this.isPho && this.tenpho == "") ||
            //     (this.isAp && this.tenap == "") ||
            //     (this.isKhu && this.tenkhu == ""))
            // ) {
            //     this.$toast.warning("Hãy chọn Phố / Ấp / Khu");
            //     return;
            // }
            this.$emit("form-close", this.somay.value);
            this.$bvModal.hide(this.modalId);
        },
        async dsDauSoChanged(idx,item) {
            if(!this.ds_dauso || this.ds_dauso.length<=0) {
                this.somay.value = "";
                this.somay.list = [];
            } else {
                console.log(item);
                this.tongdai_id = item.tongdai_id;
                //TODO continue line 589, dang thieu API 256_010
                this.dauso = item.prefix;
                var rs = await this.$root.context.post("/web-quantri/dauso/layds_dai_so_ims", {
                    "dichvu_vienthong_id": this.dichvuvt_id,
                    "kieuso_id": this.kieuso.value,
                    "loaiso_id": this.loaiso.value,
                    "nhomso_id": this.nhomso.value,
                    "prefix": this.dauso,
                    "so_batdau": item.tuso,
                    "so_ketthuc": item.denso
                });
                if(rs.data && rs.data.length>0) {
                    this.somay.list = rs.data;
                    if(this.somay.list && this.somay.list.length>0) this.dsSoMayChanged(0,this.somay.list[0]);
                }
                else 
                {
                    if(rs.error=="200") this.$toast.warning("Không có thông tin số máy!");
                    else this.$toast.error("Có lỗi: "+rs.message);
                    this.somay.list = [];
                }
                this.tsbtnIn = true;
            }
        },
        async dsSoMayChanged(idx,item) {
            if(item) this.somay.value = item.somay;
        },
        async btnGiuSoClicked() {
            var ketqua = await this.$root.context.post("/web-hopdong/lapdatmoi/sp_capnhat_giuso",{
                "dichvuvt_id": this.dichvuvt_id,
                "js_somay": "string",//TODO array somay duoc chon
                "nguoidung_id": this.$root.token.getNguoiDungID()
            });
            if(ketqua && ketqua.status == "success")
                this.$toast.success(ketqua.message);
            else this.$toast.error(ketqua.message);
        },
        async TimKiemEnter() {
            if(this.timkiem.length <= 5) {
                this.$toast.error("Số máy phải lớn hơn 5 ký tự !");
                return;
            }
            var ktra = false;
            var kw = this.timkiem;
            var dauso = this.ds_dauso.filter(x=>kw.substring(0,6).indexOf(x.prefix)==0);
            if(dauso && dauso.length>0) {
                this.dauso = dauso[0].prefix;
                //TODO Chon row cua dau so
                var listsm = this.somay.list.filter(x=>x.somay==kw.trim());
                if(listsm && listsm.length>0) {
                    //TODO chon row cua somay
                    this.somay.value = this.timkiem.trim();
                    ktra = true;
                }
            }
            if(!ktra) {
                this.$toast.error("Số máy : '" + this.timkiem.trim() + "' không có trong kho số hoặc đã được cấp !");
                return;
            }
            this.tsbtnIn = true;
        },
    }
}
</script>